<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    		<meta name="keywords" content="User:Aarchiba/SVG sanitizer" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikipedia (English)" />
		<link rel="copyright" href="../../../COPYING.html" />
    <title>User:Aarchiba/SVG sanitizer - Wikipedia, the free encyclopedia</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../skins/htmldump/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/md5.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/utf8.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/lookup.js"></script>
    <script type="text/javascript" src="../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../raw/MediaWiki%7ECommon.css";
@import "../../../raw/MediaWiki%7EMonobook.css";
@import "../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="ns-2">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">User:Aarchiba/SVG sanitizer</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Wikipedia, the free encyclopedia</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../a/a/r/User%7EAarchiba_0a61.html" title="User:Aarchiba">User:Aarchiba</a></span></div>
	    	    	    <!-- start content -->
	    <p>Apparently Wikipedia does not host SVG files for fear that they will contain trojans. It is certainly true that SVG can contain JavaScript. If SVG viewers run this JavaScript in a trusted environment, then it might indeed be a security hole. If that's a problem, then the simplest solution is to just rip it right out. Here's a script to remove all &lt;script&gt; tags and their contents. (Other tags are not executed, according to <a href="http://www.w3.org/TR/SVG/script.html" class="external text" title="http://www.w3.org/TR/SVG/script.html" rel="nofollow">the SVG standard</a> (as far as I can tell)) and so can remain.</p>
<p>This program reads its standard input, parses it as XML, removes any script tags and anything beneath them in the DOM tree, as well as any event attributes, and then writes an equivalent XML file to its standard output. This code does not validate against the DTD, but badly-formed XML simply causes the program to throw an exception and exit, producing no output. The XML is written in whatever character encoding is specified by the XML itself; this could easily be changed to force UTF-8. It returns a nonzero exit status if any scripts were detected.</p>
<p>It handles tags from other namespaces by verifying that they asre from one of a short list of namespaces; currently the only namespace from which tags are reliably removed or modified is the original SVG namespace.</p>
<p>This script successfully processes essentially all the non-broken files in the openclipart 0.11 release.</p>
<pre>
import sys
import xml.dom
import xml.dom.minidom
import re

# Sanitize SVG by removing any script calls of any sort.
# Returns a non-zero exit value if any changes were made.
#
# WARNING:
# * Does not validate the SVG against a DTD (or schema or whatever)
# * Pieces of non-SVG XML are mostly not sanitized, but must come from a short list of namespaces.
# * Reformats even documents that need no changes (but leaves the XML semantically identical).
#


class Namespace:
        def __init__(self, name):
                self.name = name


# SVG itself
svg = Namespace("http://www.w3.org/2000/svg")
# This is the complete list of event attributes from http://www.w3.org/TR/SVG/interact.html#SVGEvents
svg.event_attributes = [
        "onfocusin",
        "onfocusout",
        "onactivate",
        "onclick",
        "onmousedown",
        "onmouseup",
        "onmouseover",
        "onmousemove",
        "onmouseout",
        "onload",
        "onunload",
        "onabort",
        "onerror",
        "onresize",
        "onscroll",
        "onzoom",
        "onbegin",
        "onend",
        "onrepeat",
        ]

# From http://www.w3.org/TR/SVG/script.html
svg.script_attributes = [
        "contentScriptType",
        ]
svg.script_tags = [
        "script",
        ]

svg.evil_attributes = svg.script_attributes + svg.event_attributes
svg.evil_tags = svg.script_tags



svgns = [
        "http://www.w3.org/2000/svg",
        ]
adobens = [
        "http://ns.adobe.com/Extensibility/1.0/",
        "http://ns.adobe.com/Flows/1.0/",
        "http://ns.adobe.com/AdobeIllustrator/10.0/",
        "http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/",
        ]
metans = [
        "http://web.resource.org/cc/",
        "http://purl.org/dc/elements/1.1/",
        "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
        "http://www.w3.org/2000/xmlns/",
        "http://www.w3.org/XML/1998/namespace",
        "http://www.w3.org/1999/xlink",
        ]
inkns = [
        "http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd",
        "http://inkscape.sourceforge.net/DTD/sodipodi-0.dtd",
        "http://www.inkscape.org/namespaces/inkscape",
        ]
msns = [
        "http://schemas.microsoft.com/visio/2003/SVGExtensions/",
        ]



acceptable_namespaces = [None] + svgns + adobens + metans + inkns + msns

namespaces = {}
for a in acceptable_namespaces:
        namespaces[a] = None

# Some namespaces get sanitized as if they were SVG
special_namespaces = { None:svg }
for ns in svgns + adobens + inkns + msns:
        special_namespaces[ns] = svg




def message(s):
        sys.stderr.write(s)
        sys.stderr.write("\n")
        sys.stderr.flush()




def element_is_acceptable(node):
        global adobe_extensions
        global ink_extensions
        if node.namespaceURI in adobens: adobe_extensions = True
        if node.namespaceURI in inkns: ink_extensions = True
        if node.namespaceURI not in namespaces:
                message("Namespace '%s'not found; element '%s' unacceptable." % (node.namespaceURI,node))
                return False
        if node.namespaceURI in special_namespaces:
                if node.localName in special_namespaces[node.namespaceURI].evil_tags:
                        message("Element '%s' unacceptable." % node)
                        return False
        return True

def attribute_is_acceptable(node, attribute):
        nsURI = attribute.namespaceURI or node.namespaceURI
        if nsURI in adobens: adobe_extensions = True
        if nsURI in inkns: ink_extensions = True
        if not nsURI in namespaces:
                message("Namespace '%s'not found; attribute '%s' unacceptable." % (attribute.namespaceURI or node.namespaceURI,node))
                return False
        if nsURI in special_namespaces and attribute.localName in special_namespaces[nsURI].evil_attributes:
                message("Attribute '%s' unacceptable." % attribute)
                return False
        return True




# Begin cleansing
changes = False

doc = xml.dom.minidom.parse(sys.stdin)

# Accept all versions of SVG
if doc.doctype:
        if doc.doctype.name&lt;&gt;"svg" or not re.match(r"-//W3C//DTD SVG [0-9.]+//.*",doc.doctype.publicId):
                raise ValueError, 'Document does not appear to be SVG; doctype is "%s"' % doc.doctype.publicId
else:
        # No doctype definition; accept as SVG anyway
        if not doc.documentElement.namespaceURI in [None,svg.name] or doc.documentElement.localName&lt;&gt;"svg":
                raise ValueError, 'Document does not appear to be SVG; no doctype and root tag is "%s" in namespace "%s".' % (doc.documentElement, doc.documentElement.namespaceURI)

# Generic DOM function
def walk_tree(node):
        yield node
        for n in node.childNodes:
                for t in walk_tree(n):
                        yield t


adobe_extensions = False
ink_extensions = False


for node in walk_tree(doc):
        # Eradicate anything from other namespaces
        if not element_is_acceptable(node):
                changes=True
                node.parentNode.removeChild(node)

        # Eradicate evil attributes
        if node.attributes is not None:
                for attr in map(lambda x: node.attributes.item(x), range(node.attributes.length)):
                        if not attribute_is_acceptable(node,attr):
                                node.removeAttributeNode(attr)
                                changes = True

#if adobe_extensions: message("File contains Adobe extensions to SVG.")
#if ink_extensions: message("File contains Inkscape/Sodipodi extensions to SVG.")
sys.stdout.write(doc.toxml("utf-8"))

print #newline at end of file

if changes:
        sys.exit(1)
else:
        sys.exit(0)
</pre>
<p>All this software requires is a working installation of python 2.3.</p>

<div class="printfooter">
Retrieved from "<a href="http://en.wikipedia.org../../../a/a/r/User%7EAarchiba_SVG_sanitizer_a50a.html">http://en.wikipedia.org../../../a/a/r/User%7EAarchiba_SVG_sanitizer_a50a.html</a>"</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-user"
	       class="selected"	       ><a href="../../../a/a/r/User%7EAarchiba_SVG_sanitizer_a50a.html">User page</a></li><li id="ca-talk"
	       	       ><a href="../../../a/a/r/User_talk%7EAarchiba_SVG_sanitizer_f0ac.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://en.wikipedia.org/wiki/User:Aarchiba/SVG_sanitizer">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../images/wiki-en.png);"
	    href="../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-Main-page"><a href="../../../index.html">Main page</a></li>
	     	      <li id="n-Contents"><a href="../../../c/o/n/Wikipedia%7EContents_3181.html">Contents</a></li>
	     	      <li id="n-Featured-content"><a href="../../../f/e/a/Wikipedia%7EFeatured_content_24ba.html">Featured content</a></li>
	     	      <li id="n-currentevents"><a href="../../../c/u/r/Portal%7ECurrent_events_bb60.html">Current events</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-interaction'>
	  <h5>interaction</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-About-Wikipedia"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html">About Wikipedia</a></li>
	     	      <li id="n-portal"><a href="../../../c/o/m/Wikipedia%7ECommunity_Portal_6a3c.html">Community portal</a></li>
	     	      <li id="n-contact"><a href="../../../c/o/n/Wikipedia%7EContact_us_afd6.html">Contact us</a></li>
	     	      <li id="n-sitesupport"><a href="http://wikimediafoundation.org/wiki/Fundraising">Make a donation</a></li>
	     	      <li id="n-help"><a href="../../../c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="http://wikimediafoundation.org/"><img src="../../../images/wikimedia-button.png" border="0" alt="Wikimedia Foundation"/></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 04:56, 23 March 2005 by Wikipedia user <a href="../../../a/a/r/User%7EAarchiba_0a61.html" title="User:Aarchiba">Aarchiba</a>. Based on work by Wikipedia user(s) <a href="../../../b/r/i/User%7EBrion_VIBBER_bae4.html" title="User:Brion VIBBER">Brion VIBBER</a>.</li>	  <li id="f-copyright">All text is available under the terms of the <a class='internal' href="../../../t/e/x/Wikipedia%7EText_of_the_GNU_Free_Documentation_License_702a.html" title="Wikipedia:Text of the GNU Free Documentation License">GNU Free Documentation License</a>. (See <b><a class='internal' href="../../../c/o/p/Wikipedia%7ECopyrights_92c4.html" title="Wikipedia:Copyrights">Copyrights</a></b> for details.) <br /> Wikipedia&reg; is a registered trademark of the <a href="http://www.wikimediafoundation.org">Wikimedia Foundation, Inc</a>., a US-registered <a class='internal' href="../../../5/0/1/501%28c%29.html#501.28c.29.283.29" title="501(c)(3)">501(c)(3)</a> <a href="http://wikimediafoundation.org/wiki/Deductibility_of_donations">tax-deductible</a> <a class='internal' href="../../../n/o/n/Non-profit_organization.html" title="Non-profit organization">nonprofit</a> <a href="../../../c/h/a/Charitable_organization.html" title="Charitable organization">charity</a>.<br /></li>	  <li id="f-about"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html" title="Wikipedia:About">About Wikipedia</a></li>	  <li id="f-disclaimer"><a href="../../../g/e/n/Wikipedia%7EGeneral_disclaimer_3e44.html" title="Wikipedia:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
