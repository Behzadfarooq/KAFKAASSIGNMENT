<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    		<meta name="keywords" content="User:AndyZ/peerreviewer.js,Bypass your cache" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikipedia (English)" />
		<link rel="copyright" href="../../../COPYING.html" />
    <title>User:AndyZ/peerreviewer.js - Wikipedia, the free encyclopedia</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../skins/htmldump/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/md5.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/utf8.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/lookup.js"></script>
    <script type="text/javascript" src="../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../raw/MediaWiki%7ECommon.css";
@import "../../../raw/MediaWiki%7EMonobook.css";
@import "../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="ns-2">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">User:AndyZ/peerreviewer.js</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Wikipedia, the free encyclopedia</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../a/n/d/User%7EAndyZ_5810.html" title="User:AndyZ">User:AndyZ</a></span></div>
	    	    <div class="usermessage">You have <a href="../../../1/2/7/User_talk%7E127.0.0.1.html" title="User talk:127.0.0.1">new messages</a> (<a href="../../../1/2/7/User_talk%7E127.0.0.1.html" title="User talk:127.0.0.1">last change</a>).</div>	    <!-- start content -->
	    <p><span id="clearyourcache"><b>Note:</b> After saving, you have to <a href="../../../b/y/p/Wikipedia%7EBypass_your_cache_1dae.html" title="Wikipedia:Bypass your cache">bypass your browser's cache</a> to see the changes. <b>Firefox/Mozilla/Safari:</b> hold down <i>Shift</i> while clicking <i>Reload</i> (or press <i>Ctrl-Shift-R</i>), <b>Internet Explorer:</b> press <i>Ctrl-F5</i>, <b>Opera/Konqueror:</b> press <i>F5</i>. 
</span>
</p><pre>//[[User talk:AndyZ/peerreviewer.js]] &lt;pre&gt; 
 // ******************************************* //
 // See [[User:AndyZ/peerreviewer]] for details //
 // Quick installation -                        //
 // Add to your monobook.js:                    //
 // {{subst:js|User:AndyZ/peerreviewer.js}}     //
 // ******************************************* //
 // Written by AndyZ, 2006                      //
 // ******************************************* //
 //Semi-automatic javascript peer reviewer 
 // note that this is NOT a [[WP:BOT]] 
 // though it may be considered a [[WP:SBOTS|semi-bot]]
// *-*-*-*-*-* start code *-*-*-*-*-*
// addlink script: [[User:Omegatron/monobook.js/addlink.js]]
document.write('&lt;script type=&quot;text/javascript&quot; src=&quot;' 
             + 'http://en.wikipedia.org/w/index.php?title=User:Omegatron/monobook.js/addlink.js' 
             + '&amp;action=raw&amp;ctype=text/javascript&amp;dontcountme=s&quot;&gt;&lt;/s'+'cript&gt;');

    // *-*-*-*-*-*-*-*-*-*- //
    // configurable options //
    // details on talk page //
    // *-*-*-*-*-*-*-*-*-*- //
	// input_PR is the source id for the input
	// output_PR is the output id for the output
	
var input_PR, output_PR;
if(!input_PR) input_PR = &quot;wpTextbox1&quot;;
if(!output_PR) output_PR = &quot;theResponse&quot;;	
	
	//configurable options, see talk page for details
var allSpaces_PR, defaultView_PR, select_PR, popup_PR, sendTo_PR, toolbarLink_PR, toolbar_PR, directRef_PR, cat_PR, alpha_PR, userSandbox_PR, initMsg_PR, endMsg_PR, noXHR_PR, maintain_PR, maintain2_PR, spellcheck_PR, showHeading_PR, showInstaview_PR, instaview_PR, width_PR, imgCheck_PR, context_PR, simple_PR;             
if(!allSpaces_PR) allSpaces_PR = false; // if true, &quot;peer review&quot; link will appear on all article pages		  
if(!defaultView_PR) defaultView_PR = 0; // options: 0 - normal, in prose;  1 - template form;  2 - with references;  (for now)                          
if(!select_PR) select_PR = false; // selects text 				
if(!popup_PR) popup_PR = false; // feature not available yet				
if(!sendTo_PR) sendTo_PR = false; // if true, removes send to tab
if(!toolbarLink_PR) toolbarLink_PR = false; // accepted values = &quot;personal&quot;, &quot;cactions&quot;, &quot;navigation&quot;, &quot;tb&quot;			
if(!toolbar_PR) toolbar_PR = &quot;personal&quot;;
if(!directRef_PR) directRef_PR = false;
if(!cat_PR) cat_PR = false;
if(!alpha_PR) alpha_PR = false;
if(!userSandbox_PR) userSandbox_PR = &quot;User:&quot; + wgUserName + &quot;/sandbox&quot;
if(!initMsg_PR) initMsg_PR = &quot;The following suggestions were generated by a semi-automatic [[User:AndyZ/peerreviewer|javascript program]], and might not be applicable for the article in question.&quot;
if(!endMsg_PR) endMsg_PR = &quot;\nYou may wish to browse through [[User:AndyZ/Suggestions]] for further ideas. Thanks, ~~&quot;+&quot;~~\n\n\n&quot;;			
if(!noXHR_PR) noXHR_PR = false; // allow [[ajax]] ([[XMLHTTPrequest]]) or not			
if(!maintain_PR) maintain_PR = false; //for maintainers of [[WP:PR/A]] and its subpages		
if(!maintain2_PR) maintain2_PR = false; //for maintainers of [[WP:PR/A]] and its subpages	
 if(maintain2_PR) select_PR = true;
 if(maintain2_PR) showHeading_PR = true;
if(!spellcheck_PR) spellcheck_PR = false; //spell checker, takes long time though
if(!showHeading_PR) showHeading_PR = false;
if(!showInstaview_PR) showInstaview_PR = false;	
if(instaview_PR == undefined) instaview_PR = true; //instaview button!! released under BSD license by Pilaf
if(imgCheck_PR == undefined) imgCheck_PR = false;
if(context_PR == undefined) context_PR = false;
if(!width_PR) width_PR = 1200;
var width4_PR = width_PR + 4;
width_PR = width_PR.toString(); width4_PR = width4_PR.toString();
if(!simple_PR) simple_PR = false;
	//colors, style
var restoreText_PR, restoreStyle_PR, topBarColor_PR, botBarColor_PR;
if(!restoreText_PR) restoreText_PR = &quot;[restore]&quot;; // text for restoration button			
if(!restoreStyle_PR) restoreStyle_PR = &quot;background:yellow; position:absolute; margin-left:5px; margin-top:120px;&quot;;	  
if(!topBarColor_PR) topBarColor_PR = &quot;red&quot;; // color of top bar of suggestions			  
if(!botBarColor_PR) botBarColor_PR = &quot;#cccccc&quot;; // color of bottom bar of suggestions
    // *-*-*-*-*-* end configurable options *-*-*-*-*-*

if(wgNamespaceNumber == 0 || wgNamespaceNumber == 4 || allSpaces_PR){		//only if namespace is main (or wp)
					//the actual output location of the suggestions
    //!!! needs cleanup for readability
					
	//feedbackid = &quot;theFeedback&quot;;
	//drag_PR = 'onmousedown=&quot;StartDrag(document.getElementById('+feedbackid+'))&quot; onmouseup=&quot;CancelDrag()&quot; onmouseout=&quot;CancelDrag()&quot;'
	
	var instaview_button_txt;
	if(instaview_PR)
		instaview_button_txt = '&lt;input type=&quot;button&quot; value=&quot;Instaview&quot; name=&quot;instaview_button&quot; id=&quot;instaview_button&quot; style=&quot;width:150&quot; onclick=&quot;instaPreview();&quot; onMouseOver=&quot;window.status=\'Preview the suggestions using Live Preview ((C)2006 Pilaf, BSD) without having to copy+paste and using diff. button\'; return true;&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;' 	
	else
		instaview_button_txt = &quot;&quot;;
					
					//add new button for &lt;span onclick=&quot;addToPage()&quot;&gt;move to&lt;/span&gt; soon
document.write('&lt;div id=&quot;theFeedback&quot; style=&quot;position:absolute; width:'+width_PR+'px; margin-top:150px; margin-left:40px; border:2px solid #000000; background:55ff55; visibility:hidden; z-index:20;&quot;&gt;' + 
    '&lt;div id=&quot;topBar&quot; style=&quot;background:'+topBarColor_PR+'; text-align:right; width:'+width4_PR+'px&quot;&gt;' + 
    '&lt;span onclick=&quot;popreview();&quot; onMouseOver=&quot;window.status=\'Shows current suggestions in new window, so that they do not interfere with editing\'&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;new window&lt;/span&gt; | ' +
    '&lt;span onclick=&quot;hide_PR()&quot; onMouseOver=&quot;window.status=\'Hides suggestions so you can continue editing\'&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;close&lt;/span&gt;' + 
    '&lt;/div&gt;' + 
    '&lt;form name=&quot;theForm&quot;&gt;&lt;textarea style=&quot;width:'+width_PR+'px&quot; rows=&quot;20&quot; name=&quot;theResponse&quot; id=&quot;theResponse&quot;&gt;'+initMsg_PR+'&lt;/textarea&gt;' +
    '&lt;div style=&quot;background:'+botBarColor_PR+'; width:' + width4_PR + 'px&quot;&gt;'+instaview_button_txt +
    ' &lt;input type=&quot;button&quot; value=&quot;Readonly&quot; name=&quot;switch_readonly&quot; onclick=&quot;determineReadonly()&quot;&gt; |' + 
    ' &lt;input type=&quot;button&quot; value=&quot;Autoformat article per MoS&quot; name=&quot;MOSformatting&quot; onclick=&quot;MOS_format();&quot; onMouseOver=&quot;window.status=\'Combo of scripts (thx Bobblewik, Gimmetrow) that fix certain MoS issues in article. Be sure to carefully check diff\'&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;' +
	' &lt;a href=&quot;http://en.wikipedia.org/wiki/User talk:AndyZ/peerreviewer.js&quot; target=&quot;_blank&quot; onMouseOver=&quot;window.status=\'All feedback is appreciated\'&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;Questions/comments/errors?&lt;/a&gt;&lt;br&gt;' + 
	'&lt;/div&gt;&lt;div id=&quot;InstaViewResponse&quot; style=&quot;background:white; visibility:hidden&quot;&gt;&lt;/div&gt;'
	+'&lt;/form&gt;&lt;/div&gt;'
	+'&lt;div id=&quot;restore&quot; style=&quot;z-index:19; visibility:hidden;'+restoreStyle_PR+'&quot; onclick=&quot;show_PR()&quot; onMouseOver=&quot;window.status=\'Show suggestions\'&quot; onMouseOut=&quot;window.status=\'\'&quot;&gt;'+restoreText_PR+'&lt;/div&gt;')	
}

if(simple_PR) JSpeerreview_callingFunction = &quot;JSpeerreview_simple();&quot;
else JSpeerreview_callingFunction = &quot;JSpeerreview();&quot;;

if(toolbar_PR == &quot;personal&quot; || toolbar_PR == &quot;navigation&quot; || toolbar_PR == &quot;cactions&quot; || toolbar_PR == &quot;tb&quot;){
    if((wgNamespaceNumber == 0 || wgNamespaceNumber == 4 || allSpaces_PR) &amp;&amp; !toolbarLink_PR){
    //adds peer review link to top bar (with your user + talk pgs, prefs., watchlist, etc.)
    addOnloadHook(function () {
        if(document.forms.editform) {
            addLink('p-'+toolbar_PR, 'javascript:' + JSpeerreview_callingFunction, 'peer review', 'ca-peerreviewer', 'Semi-automatic peer reviewer by javascript', '', '');
        }
    });	
    }

    if((wgNamespaceNumber == 0 || allSpaces_PR) &amp;&amp; toolbarLink_PR){
    addOnloadHook(function () {
        addLink('p-'+toolbar_PR, 'javascript:toJSpeerreview()', 'peer review', 'ca-peerreviewer', 'Semi-automatic peer reviewer by javascript', '', '');
    });	
    }
}

templateData_PR = new Array(
    [&quot;lead&quot;,&quot;*Please expand the lead to conform with guidelines at [[Wikipedia:Lead]]. The article should have an appropriate number of paragraphs as is shown on [[WP:LEAD]], and should adequately summarize the article.&quot;],
    [&quot;leadlong&quot;,&quot;*The lead of this article may be too long, or may contain too many paragraphs. Please follow guidelines at [[WP:LEAD]]; be aware that the lead should adequately summarize the article.&quot;],
    [&quot;leaddetail&quot;,&quot;*The lead is for summarizing the rest of the article, and should not introduce new topics not discussed in the rest of the article, as per [[WP:LEAD]]. Please ensure that the lead adequately summarizes the article.&quot;],
    [&quot;infobox&quot;,&quot;*There may be an applicable [[WP:INFOBOX|infobox]] for this article. For example, see [[Template:Infobox Biography]], [[Template:Infobox School]], or [[Template:Infobox City]].&quot;],
    [&quot;contxt&quot;,&quot;*Per [[Wikipedia:Only make links that are relevant to the context|Wikipedia:Context]] and [[Wikipedia:Manual of Style (dates and numbers)|Wikipedia:Manual of Style (dates)]], months and days of the week generally should not be linked. Years, decades, and centuries can be linked if they provide [[WP:CONTEXT|context]] for the article.&quot;],
    [&quot;linkdate&quot;,&quot;*Per [[Wikipedia:Only make links that are relevant to the context|Wikipedia:Context]] and [[Wikipedia:Build the web]], years with full dates should be linked; for example, link [[January 15]], [[2006]].&quot;],
    [&quot;dateth&quot;,&quot;*As per [[Wikipedia:Manual of Style (dates and numbers)|Wikipedia:Manual of Style (dates)]], dates shouldn't use &lt;sup&gt;th&lt;/sup&gt;; for example, instead of using ''[[January 30|January 30&lt;sup&gt;th&lt;/sup&gt;]] was a great day'', use ''[[January 30]] was a great day''.&quot;], 
    [&quot;nbsp&quot;,&quot;*Per [[Wikipedia:Manual of Style (dates and numbers)#Units of measurement|Wikipedia:Manual of Style (numbers)]], there should be a non-breaking space - &lt;code&gt;&amp;amp;nbsp;&lt;/code&gt; between a number and the unit of measurement. For example, instead of ''{{{1|18mm}}}'', use ''{{{2|18&amp;nbsp;mm}}}'', which when you are editing the page, should look like: &lt;tt&gt;{{{3|18&amp;amp;nbsp;mm}}}&lt;/tt&gt;.&quot;], 
    [&quot;spellnum&quot;,&quot;*Per [[Wikipedia:Manual of Style (dates and numbers)#Units of measurement|Wikipedia:Manual of Style (numbers)]], please spell out source units of measurements in text; for example, ''the Moon is 380,000 kilometres (240,000 mi) from Earth''.&quot;], 
    [&quot;abbrev&quot;,&quot;*Per [[Wikipedia:Manual of Style (dates and numbers)#Units of measurement|Wikipedia:Manual of Style (numbers)]], when doing conversions, please use standard abbreviations: for example, miles -&gt; mi, kilometers squared -&gt; km&lt;sup&gt;2&lt;/sup&gt;, and pounds -&gt; lb.&quot;], 
    [&quot;headingthe&quot;,&quot;*Per [[Wikipedia:Manual of Style (headings)]], headings generally do not start with articles ('the', 'a(n)'). For example, if there was a section called ''&lt;nowiki&gt;==The Biography==&lt;/nowiki&gt;'', it should be changed to ''&lt;nowiki&gt;==Biography==&lt;/nowiki&gt;''.&quot;], 
    [&quot;headingre&quot;,&quot;*Per [[Wikipedia:Manual of Style (headings)]], headings generally should not repeat the title of the article. For example, if the article was [[Ferdinand Magellan]], instead of using the heading ''&lt;nowiki&gt;==Magellan's journey==&lt;/nowiki&gt;'', use ''&lt;nowiki&gt;==Journey==&lt;/nowiki&gt;''.&quot;], 
    [&quot;headinglink&quot;,&quot;*As per [[Wikipedia:Manual of Style (headings)]], please do not [[WP:LINK|link]] words in headings.&quot;], 
    [&quot;headingcap&quot;,&quot;*Per [[Wikipedia:Manual of Style (headings)]], avoid capitalizing words in section headings unless they are [[proper noun]]s or the first word of the heading.&quot;],
    [&quot;gtl&quot;,&quot;*Please reorder/rename the last few sections to follow guidelines at [[Wikipedia:Guide to layout]].&quot;], 
    [&quot;overlink&quot;,&quot;*Consider removing links that add little to the article or that have been repeated in close proximity to other links to the same article, as per [[Wikipedia:Manual of Style (links)]] and [[WP:CONTEXT]].&quot;], 
    [&quot;underlink&quot;,&quot;*Consider adding more [[WP:LINK|links]] to the article; per [[Wikipedia:Manual of Style (links)]] and [[Wikipedia:Build the web]], create links to relevant articles.&quot;], 
    [&quot;footspace&quot;,&quot;*As done in [[WP:FOOTNOTE]], footnotes usually are located right after a punctuation mark (as recommended by the [[The Chicago Manual of Style|CMS]], but not mandatory), such that there is no space in between. For example, ''the sun is larger than the moon [2].'' is usually written as ''the sun is larger than the moon.[2]''&quot;], 
    [&quot;alpha&quot;,&quot;*Please alphabetize the [[WP:IL|interlanguage links]].&quot;], 
//    [&quot;alpha|[[WP:CAT|categories]]&quot;,&quot;*Please alphabetize the [[WP:CAT|categories]].&quot;],
//    [&quot;alpha|[[WP:CAT|categories]] and [[WP:IL|interlanguage links]]&quot;,&quot;*Please alphabetize the [[WP:CAT|categories]] and [[WP:IL|interlanguage links]].&quot;],
    [&quot;ref&quot;,&quot;*The article will need references. See [[WP:CITE]] and [[WP:V]] for more information.&quot;], 
    [&quot;foot&quot;,&quot;*This article needs [[WP:FOOTNOTE|footnotes]], preferably in the [http://meta.wikimedia.org/wiki/Cite/Cite.php cite.php] format recommended by [[WP:WIAFA]]. Simply, enclose inline citations, with [[WP:CITE]] or [[WP:CITE/ES]] information, with &lt;nowiki&gt;&lt;ref&gt;THE FOOTNOTE&lt;/ref&gt;&lt;/nowiki&gt;. At the bottom of the article, in a section named “References” or “Footnotes”, add &lt;code&gt;&lt;nowiki&gt;&lt;div class=\&quot;references-small\&quot;&gt;&lt;references/&gt;&lt;/div&gt;&lt;/nowiki&gt;&lt;/code&gt;.&quot;], 
    [&quot;noimg&quot;,&quot;*This article has no [[WP:IMAGE|images]]. Please see if there are any [[WP:IT|free use]] images that fall under the [[Wikipedia:Image use policy]] and fit under one of the [[Wikipedia:Image copyright tags]] that can be uploaded. To upload images on Wikipedia, go to [[Special:Upload]]; to upload non-[[WP:FU|fair use]] images on the [[Wikimedia Commons]], go to [[commons:special:upload]].&quot;], 
    [&quot;leadimg&quot;,&quot;*See if possible if there is a [[WP:IT|free use]] image that can go on the top right corner of this article.&quot;], 
    [&quot;caption&quot;,&quot;*Per [[Wikipedia:What is a featured article?]], [[WP:IMAGE|Images]] should have concise captions.&quot;], 
    [&quot;toc&quot;,&quot;*Per [[WP:WIAFA]], this article's table of contents (ToC) may be too long- consider shrinking it down by merging short sections or using a proper system of daughter pages as per [[Wikipedia:Summary style]].&quot;], 
    [&quot;expand&quot;,&quot;*This article is a bit too short, and therefore may not be as comprehensive as [[WP:WIAFA]] critera 1(b) is looking for. Please see if anything can be expanded upon.&quot;], 
    [&quot;SS&quot;,&quot;*This article may need to undergo [[WP:SS|summary style]], where a series of appropriate subpages are used. For example, if the article is [[United States]], than an appropriate subpage would be [[History of the United States]], such that a summary of the subpage exists on the mother article, while the subpage goes into more detail.&quot;], 
    [&quot;copyedit&quot;,&quot;*Please ensure that the article has gone through a thorough copyediting so that it exemplifies some of [[WP:WIAFA|Wikipedia's best work]]. See also [[User:Tony1/How to satisfy Criterion 1a]].&quot;], 
    [&quot;list&quot;,&quot;*This article may be a bit list-weighty; in other words, some of the lists should be converted to prose (paragraph form).&quot;], 
    [&quot;trivia&quot;,&quot;*Generally, trivia sections are looked down upon; please either remove the trivia section or incorporate any important facts into the rest of the article.&quot;],
    [&quot;persondata&quot;,&quot;*If this article is about a person, please add &lt;code&gt;&lt;nowiki&gt;{{persondata|PLEASE SEE [[WP:PDATA]]!}}&lt;/nowiki&gt;&lt;/code&gt; along with the required parameters to the article - see [[Wikipedia:Persondata]] for more information.&quot;],
    [&quot;how&quot;,&quot;*Please avoid including instruction manuals, tutorials, etc. or other 'how-to's per [[WP:NOT#Wikipedia is not an indiscriminate collection of information|WP:NOT]].&quot;],
    [&quot;ig&quot;,&quot;*Avoid including [[WP:IG|galleries]] in articles, as per [[Wikipedia:Galleries#Policy|Wikipedia:Galleries]]. Common solutions to this problem include moving the gallery to a separate page, like [[Gallery of &quot;+wgTitle+&quot;]].&quot;],
    [&quot;fact&quot;,&quot;*Please provide citations for all of the &lt;code&gt;&lt;nowiki&gt;{{fact}}&lt;/nowiki&gt;&lt;/code&gt;s.&quot;]
);

for(i=0;i&lt;templateData_PR.length;i++)
	templateData_PR[i][1] += &quot;&lt;sup&gt;[[User:AndyZ/G#&quot; + templateData_PR[i][0] + &quot;|[?]]]&lt;/sup&gt;&quot;;	//appending footnotes	

// *-*-*-*-*-* non-configurable global variable declarations *-*-*-*-*-*
var temp_mem, foot_mem;
var imgFU = false, imgFUstr = &quot;&quot;;
var imgNT = false, imgNTstr = &quot;&quot;;
var PRtemplateData, tempPRdata; // !!!
var outputText_PR = initMsg_PR;	//actual output text
var spellcheck_output = &quot;&quot;;

function JSpeerreview(){
    //wpTxt is the variable for the text of a document, input_PR is the id
if(document.getElementById(input_PR))
    wpTxt = document.getElementById(input_PR).value;
else{
    alert(&quot;Error: Could not locate text\n&quot; + input_PR); return;
}

if(!document.getElementById(output_PR)){
    alert(&quot;Error: Unable to access output location\n&quot; + output_PR); return;	
}

//current date variables
    var current_date = new Date(), cur_month = current_date.getMonth(), cur_year = current_date.getFullYear();
    var y_abbrev = cur_year.toString().substring(2,4);
    var m_abbrev = new Array(&quot;J&quot;,&quot;F&quot;,&quot;M&quot;,&quot;A&quot;,&quot;MY&quot;,&quot;JN&quot;,&quot;JL&quot;,&quot;AU&quot;,&quot;S&quot;,&quot;O&quot;,&quot;N&quot;,&quot;D&quot;);
    var m_full = new Array(&quot;January&quot;,&quot;February&quot;,&quot;March&quot;,&quot;April&quot;,&quot;May&quot;,&quot;June&quot;,&quot;July&quot;,&quot;August&quot;,&quot;September&quot;,&quot;October&quot;,&quot;November&quot;,&quot;December&quot;);

// --------------------	
//&lt;nowiki&gt; Messages on WP:PR 
// --------------------	
if(wgTitle.indexOf(&quot;Peer review&quot;) != -1 &amp;&amp; wgTitle.indexOf(&quot;/Automated&quot;) == -1
 &amp;&amp; wgNamespaceNumber == 4 		//WP namespace
 &amp;&amp; document.editform.wpTextbox1.value.indexOf(&quot;User:AndyZ/peerreviewer&quot;) == -1){
document.editform.wpTextbox1.value += &quot;\n*Please see [[User:AndyZ/peerreviewer|automated]] peer review suggestions [[Wikipedia:Peer review/Automated/&quot;+m_full[cur_month]+&quot; &quot;+cur_year+&quot;#&quot;+ wgTitle.split(&quot;Peer review/&quot;)[1] +&quot;|here]]. Thanks, ~~~~&quot;

// Add a tag to the summary box - ''stolen'' from [[User:Bobblewik]] 
    var txt = document.editform.wpSummary;
    var summary = &quot;Automated peer review at [[WP:PRA/&quot;+m_abbrev[cur_month]+y_abbrev+&quot;#&quot;+wgTitle.split(&quot;Peer review/&quot;)[1]+&quot;]]&quot;;
	if (txt.value.indexOf(summary) == -1) {
		if (txt.value.match(/[^\*\/\s][^\/\s]?\s*$/)) {
			txt.value += &quot; | &quot;;
		}
		txt.value += summary;
	}

return;
} // &lt;/nowiki&gt;    
// |%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%| //
// |%|%|%|%|%| START  OUTPUT |%|%|%|%|%| //
// |%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%|%| //

document.getElementById(output_PR).value = JSpeerreview_body(document.getElementById(input_PR).value,document.getElementById(output_PR).value);

//----------* replacing template format with actual words
temp_mem = document.getElementById(output_PR).value;
if(defaultView_PR == 0)
    replaceTemp();
document.getElementById('instaview_button').style.width = 150;
document.theForm.switch_readonly.style.width = 150;
//----------* 

//show feedback
document.getElementById(&quot;theFeedback&quot;).style.visibility = &quot;visible&quot;;

if(select_PR)				//selects suggestions, for easy copy+pasting
	document.getElementById(output_PR).select();

// %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
}// ending brace for function %%
// %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function JSpeerreview_simple(){
	output_PR = &quot;wpTextbox1&quot;;
    document.getElementById('wpTextbox1').value = JSpeerreview_body(document.getElementById('wpTextbox1').value,&quot;&quot;);
    replaceTemp();
}
function JSpeerreview_body(inputText_PR,outputText_PR){

if(outputText_PR.indexOf(&quot;~~&quot;+&quot;~~&quot;)!=-1){
    var existingPR = confirm(&quot;There are already suggestions here.\nContinuing will cause the old suggestions to be overwritten.\nDo you wish to proceed?&quot;);	
    if(!existingPR) return;
    else{
        outputText_PR = initMsg_PR;		//reset global variables
        imgFU = false; imgFUstr = &quot;&quot;; imgNT = false; imgNTstr = &quot;&quot;;
    }
}

if(outputText_PR == &quot;&quot;) outputText_PR = initMsg_PR;

if(showHeading_PR) //heading on output (at top)
    outputText_PR = &quot;===[[&quot;+wgTitle+&quot;]]===\n&quot;+outputText_PR;

//----------* [[WP:LEAD|lead]] - determine number of paragraphs
inputText_PR_lead = inputText_PR.substring(0,inputText_PR.indexOf(&quot;==&quot;))

if(/^([A-Z]|'{3})/gm.test(inputText_PR_lead))
	NumPara = inputText_PR_lead.match(/^([A-Z]|'{3})/gm).length;
else NumPara=1;

if(NumPara == 1)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/lead}}&quot;;
if(NumPara == 2 &amp;&amp; inputText_PR.length&gt;=30000)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/lead}}&quot;;
if(NumPara == 3 &amp;&amp; inputText_PR.length&lt;=15000)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/leadlong}}&quot;;
if(NumPara == 4 &amp;&amp; inputText_PR.length&lt;=30000)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/leadlong}}&quot;;
if(NumPara &gt;= 5){
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/leadlong}}&quot;;
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/leaddetail}}&quot;;
}

//----------* Links compared to # of words (see [[WP:MOS-L]])
words = inputText_PR.split(&quot; &quot;).length; links = inputText_PR.split(&quot;[[&quot;).length;
if(.03 * words &gt;= links) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/underlink}}&quot;;
if(.10 * words &lt;= links) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/overlink}}&quot;;

//----------* WP:CONTEXT / WP:MOSDATE
//looks for linked years, days of weeks, or months
if(/[^,\]]\s\[\[\d{4}\]\]/.test(inputText_PR)
 || /\[\[((Mon|Tues|Wednes|Thurs|Fri|Satur|Sun)day|January|February|March|April|May|June|July|August|September|October|November|December)\]\]/.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/contxt}}&quot;

//----------* [[WP:MOS#Time]] !!!
/*
var mostime = new Array([&quot;recently&quot;, /recently/gi], [&quot;soon&quot;, /\ssoon\s/g]);	check_mostime = true; mostimestring = &quot;&quot;;	
for(i=0;i&lt;mostime.length;i++){
    if(mostime[i][1].test(inputText_PR)){
        check_mostime = false; mostimestring += &quot;|&quot; + mostime[i][0];		//add parameters
    }
}
if(!check_mostime) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/time&quot;+mostimestring+&quot;}}&quot;;
*/

//----------* Images (in article/lead)
if(!/\[\[image:/gi.test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/noimg}}&quot;;
if(!/image:/gi.test(inputText_PR.substring(0,500))
|| !/\.(jpg|png|svg|gif)\W/gi.test(inputText_PR.substring(0,500))) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/leadimg}}&quot;;

//----------* Images without captions
if(/\|(\d{2,3}px|none|left|center|right|thumb|thumbnail|frame|\.(jpg|gif|png|svg))\]\]/i
    .test(inputText_PR.replace(/\n\s*\|.+/gi,&quot;&quot;))) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/caption}}&quot;;
	
//----------* Discourage galleries, per [[WP:IG]]
if(/&lt;\/?gallery&gt;/i.test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/ig}}&quot;;

//----------* Discourage &lt;table&gt; syntax -&gt; {| [[Help:Table]] |}
if(/&lt;\/table&gt;/.test(inputText_PR)) outputText_PR+=&quot;\n*Please convert tables from [[HTML]] syntax to [[Help:Table]] wiki-markup.&quot;; 

//----------* Image licensing: cannot check licensing of WikiMedia Commons images
var imgCode = /\[\[image:(.+?)(\||\])/gi
var imgList = new Array();
if(imgCode.test(inputText_PR) &amp;&amp; !noXHR_PR &amp;&amp; imgCheck_PR){
	imgList = inputText_PR.match(imgCode);
	for(i=0;i&lt;imgList.length;i++) {
		imgList[i] = imgList[i].replace(/\[\[image:(.+?)(\||\])/gi,&quot;Image:$1&quot;);
		wpajax.download({url:'http://en.wikipedia.org/w/index.php?title='+imgList[i]+'&amp;action=raw',
	    		onSuccess: checkImgLicense, onFailure: wikiImg, message: &quot;raw,&quot; + imgList[i] });
	}
}
		//output for image licensing prolems
if(imgNT) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/imgtag&quot;+imgNTstr+&quot;}} &lt;!--Listed images do not have licensing information--&gt;&quot;;
if(imgFU) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/imgfu&quot;+imgFUstr+&quot;}} &lt;!--List images are fair use without rationale--&gt;&quot;;

//----------* Searches for infobox
if(!/\{\{.*(taxo|geo|info)box/gi.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/infobox}} (Note that there might not be an applicable infobox; remember that these suggestions are not generated manually)&quot;;

//----------* Searches for [[Template:Persondata]]
if((/\[\[Category\:\d{1,}\s(BC\s)?(birth|death)s/gi.test(inputText_PR) 	               //category:xxxx births/deaths
 || /\{\{Infobox(\_|\s)(biography|philosopher|Military\sPerson)/gi.test(inputText_PR)) //person infobox
 &amp;&amp; !/\{\{persondata/gi.test(inputText_PR)) 	                	                   //persondata metadata template
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/persondata}}&quot;;

// -------------------- --------------------
// [[WP:MOSNUM]] and [[WP:MOSDATE]]:
// -------------------- --------------------
//----------* checks for &amp; nbsp;
list_unitnbsp = /((\d+)\s?((kilo|hecta|deca|deci|centi|milli|micro|nano)?(meter|metre|liter|litre|gram)s?|(k|d|c|m|n|µ)(g|l|m)|inch(es)?|f(oo|ee)?t|y(ar)?ds?|mi(les?)?|lbs?|pounds?|tons?|ounces?|ozs?|pints?|quarts?|gallons?|in&lt;sup&gt;2&lt;\/sup&gt;|squared inches|ft&lt;sup&gt;2&lt;\/sup&gt;|squared feet|m&lt;sup&gt;2&lt;\/sup&gt;|squared meter|km&lt;sup&gt;2&lt;\/sup&gt;|squared kilo|cm&lt;sup&gt;2&lt;\/sup&gt;|squared centi|mi&lt;sup&gt;2&lt;\/sup&gt;|squared mile|in&lt;sup&gt;3&lt;\/sup&gt;|cubic inch|ft&lt;sup&gt;3&lt;\/sup&gt;|cubic feet|m&lt;sup&gt;3&lt;\/sup&gt;|cubic meter|km&lt;sup&gt;3&lt;\/sup&gt;|cubic kilo|cm&lt;sup&gt;3&lt;\/sup&gt;|cubic centi|mi&lt;sup&gt;3&lt;\/sup&gt;|cubic mile))\W/gi;
if(list_unitnbsp.test(inputText_PR)){
	temp_unitnbsp = inputText_PR.match(list_unitnbsp);	
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/nbsp|&quot;+RegExp.$1+&quot;|&quot;+RegExp.$2+&quot;&amp;nbsp;&quot;+RegExp.$3+&quot;|&quot;+RegExp.$2+&quot;&amp;amp;nbsp;&quot;+RegExp.$3+&quot;}}&quot;;
}

//----------* Checks for usage of standard abbreviations in parentheses (for conversions)
if(/((kilo|hecta|deca|deci|centi|milli|micro|nano)?(meter|metre|liter|litre|gram)s?|inch(es)?|f(oo|ee)t|yards?|miles?)\)/gi
    .test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/abbrev}}&quot;;

//----------* Checks that units are spelled out in text
var list_SN_PR = /([\d\.]+\s(kms?|mi|yds?|fts?|in\.|cms?|dms?|nms?|oz|lbs?|kgs?|mgs?|dag|dg|ng|(in|ft|yd|mi|m|km|cm|mm|dm|nm)&lt;sup&gt;[23]&lt;\/sup&gt;|ha|hl|dl|cl|ml)\s)/gi;
if(list_SN_PR.test(inputText_PR)){
    temp_SN = inputText_PR.match(list_SN_PR);
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/spellnum}} &quot; + &quot;Specifically, an example is &quot; + RegExp.$1.substring(0,RegExp.$1.length-1) + &quot;.&quot;;
}

//----------* Checks for usage of standard abbreviations in parentheses (without 's') (for conversions) !!!
if(/(\s|nbsp;)((k|d|c|m|n|µ)(g|l|m)|ft|yd|mi|lb|oz)s(\W)/gi.test(inputText_PR))
    outputText_PR+=&quot;\n*When writing standard abbreviations, the abbreviations should not have a 's' to demark plurality (for example, change kms to km and lbs to lb).&quot;;

//----------* Does not work; may fix soon - looks for conversions
//original logic: follow pattern: /(\d* )(\s|&amp;nbsp;)?(UNIT)[^\}\s][^\(]//i
/* !!! ex
area2 = /\d(\s|)((in|ft|mi|(|k|c|m)m)&lt;sup&gt;2&lt;\/sup&gt;|squared (inches|feet|meter|(|kilo|centi|milli)(meter|metre)|mile))[^\}\s][^\(]/gi
vol2 = /\d(\s|)((in|ft|mi|(|m|c|k)m)&lt;sup&gt;3&lt;\/sup&gt;|cubic (inch|feet|meter|(|kilo|centi|milli)(metre|meter)))[^\}\s][^\(]/gi
if(area2.test(inputText_PR) || vol2.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/convert}}&quot;;*/

//----------* Unlinked dates
if(/\s(january|february|march|april|may|june|july|august|september|october|november|december)\s(\d\d?\D)/gi
    .test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/linkdate}}&quot;;

//----------* Dateth
var dateth = new Array(2); var check_th = false;
dateth[0] = /(\[\[)?(january|february|march|april|may|june|july|august|september|october|november|december)\s\d\d?(\]\])?(&lt;sup&gt;)?(th|st|nd|rd)/gi
dateth[1] = /\d\d?(&lt;sup&gt;)?(th|st|nd|rd)(&lt;\/sup&gt;)?\s(of\s)?(january|february|march|april|may|june|july|august|september|october|november|december)/gi
		
for(i=0;i&lt;dateth.length;i++){if(dateth[i].test(inputText_PR)) check_th = true;}
if(check_th) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/dateth}}&quot;;

// -------------------- --------------------
// checks for correct MOS heading styles ([[WP:MSH]])
// -------------------- --------------------
//----------* Articles (&quot;the&quot;, &quot;a&quot;, &quot;an&quot;) at beginning of heading
if(inputText_PR.indexOf(&quot;==The &quot;) != -1 || inputText_PR.indexOf(&quot;== The &quot;) != -1 || inputText_PR.indexOf(&quot;==the &quot;) != -1 || inputText_PR.indexOf(&quot;== the &quot;) != -1 || 
   inputText_PR.indexOf(&quot;== A &quot;) != -1 || inputText_PR.indexOf(&quot;==A &quot;) != -1 || inputText_PR.indexOf(&quot;==a &quot;) != -1 || inputText_PR.indexOf(&quot;==a &quot;) != -1 || 
   inputText_PR.indexOf(&quot;==An &quot;) != -1 || inputText_PR.indexOf(&quot;== An &quot;) != -1 || inputText_PR.indexOf(&quot;==an &quot;) != -1 || inputText_PR.indexOf(&quot;== an &quot;) != -1)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/headingthe}}&quot;;

//----------* Link in headings
if(/==.{0,}\[\[.{1,}\]\].{0,}==/gi.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/headinglink}}&quot;;

//----------* Title repeated in headings
var regex_headre = new RegExp(&quot;==.{0,}&quot; + wgTitle.replace(/\s\(.*\)/,&quot;&quot;) + &quot;.{0,}==&quot;,&quot;gi&quot;)
if(regex_headre.test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/headingre}}&quot;;
	
//----------* Special characters in headings
if(/==.*([^\[]\[[^\[]|[^\]]\][^\]]|&amp;|\+|\{|\}).*==/gi.test(inputText_PR))
    outputText_PR+=&quot;\n*Per [[Wikipedia:Manual of Style (headings)]], avoid using special characters (ex: &amp;+{}[]) in headings.&quot;;

//----------* Capitalization for common headings
if(/==\s?(See\sAlso|External\sLinks?|Works?\sCited|Further\sReadings?|History\sOf\s.{2,}|.{2,}\sAnd\s.{2,})\s?==/g
    .test(inputText_PR))
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/headingcap}}&quot;;

//----------* How to, Trivia section
if(/==\s?(how[\s\-]to\s.*)\s?==/gi.test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/how}}&quot;;
if(/==\s?(trivia|other\sfact|miscellaneous|interesting\s)/gi.test(inputText_PR)) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/trivia}}&quot;;

//----------* Order of last sections (WP:LAYOUT) (see also - references - external links)
var refsection_s = new Array(&quot;==Reference&quot;,&quot;==Source&quot;,&quot;==Footnote&quot;,&quot;==Cit&quot;,&quot;==Note&quot;,&quot;== Reference&quot;,&quot;== Source&quot;,&quot;== Footnote&quot;,&quot;== Cit&quot;,&quot;== Note&quot;), 
    extlink_s = new Array(&quot;==External link&quot;,&quot;==External Link&quot;,&quot;== External Link&quot;,&quot;== External link&quot;),
    seealso_s = new Array(&quot;==See also&quot;,&quot;== See also&quot;,&quot;==See Also&quot;,&quot;== See Also&quot;),
    refsection = 0, extlink = 0, seealso = 0, check_gtl = true;
     //find sections
for(i=0;i&lt;seealso_s.length;i++){if(inputText_PR.indexOf(seealso_s[i])!=-1)       seealso = inputText_PR.indexOf(seealso_s[i]);}
for(i=0;i&lt;refsection_s.length;i++){if(inputText_PR.indexOf(refsection_s[i])!=-1) refsection = inputText_PR.indexOf(refsection_s[i]);}
for(i=0;i&lt;extlink_s.length;i++){if(inputText_PR.indexOf(extlink_s[i])!=-1)       extlink = inputText_PR.indexOf(extlink_s[i]);}
if(seealso &amp;&amp; refsection &amp;&amp; (refsection &lt; seealso)) check_gtl = false;
if(seealso &amp;&amp; extlink &amp;&amp; (extlink &lt; seealso)) check_gtl = false;
if(refsection &amp;&amp; extlink &amp;&amp; (extlink &lt; refsection)) check_gtl = false;

if(!check_gtl) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/gtl}}&quot;

//----------* &quot;List of...&quot;					//not in use due to inaccuracy
/*if(/==\s?list/gi.test(inputText_PR))
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/list}}&quot;;*/

//----------* Checks if categories are in alphabetical order !!!
self_alphabetic = [
    'aa','af','ak','als','am','ang','ab','ar','an','roa-rup','frp','as','ast','gn',
    'av','ay','az','bm','bn','zh-min-nan','map-bms','ba','be','bh','bi','bar','bo',
    'bs','br','bg','bxr','ca','cv','ceb','cs','ch','cbk-zam','ny','sn','tum','cho',
    'co','za','cy','da','pdc','de','dv','arc','nv','dz','mh','et','el','eml','en',
    'es','eo','eu','ee','fa','fo','fr','fy','ff','fur','ga','gv','gd','gl','ki',
    'glk','gu','got','zh-classical','xal','ko','ha','haw','hy','hi','ho','hsb','hr',
    'io','ig','ilo','bpy','id','ia','ie','iu','ik','os','xh','zu','is','it','he',
    'jv','kl','kn','kr','ka','ks','csb','kk','kw','rw','ky','rn','sw','kv','kg',
    'ht','kj','ku','lad','lbe','lo','la','lv','lb','lt','lij','li','ln','jbo','lg',
    'lmo','hu','mk','mg','ml','mt','mi','mr','mzn','ms','cdo','mo','mn','mus','my',
    'nah','na','fj','nl','nds-nl','cr','ne','new','ja','nap','ce','pih','no','nn',
    'nrm','nov','oc','or','om','ng','hz','ug','pa','pi','pam','pag','pap','ps','km',
    'pms','nds','pl','pt','ty','ksh','ro','rmy','rm','qu','ru','war','se','sm','sa',
    'sg','sc','sco','st','tn','sq','ru-sib','scn','si','simple','sd','ss','sk','cu',
    'sl','so','sr','sh','su','fi','sv','tl','ta','roa-tara','tt','te','tet','th',
    'vi','ti','tg','tpi','to','chr','chy','ve','tr','tk','tw','udm','bug','uk','ur',
    'uz','vec','vo','fiu-vro','wa','vls','wo','wuu','ts','ii','yi','yo','zh-yue',
    'diq','zea','bat-smg','zh','zh-tw','zh-cn']

/*cat1 = /\[\[Category:.{1,}\]\]/gi
alphed = true; check_il = true;				 //first for [[WP:CAT]]s, [[WP:IL]]s
if(cat1.test(inputText_PR)){
	theCats = inputText_PR.match(cat1)				 //array to hold categories
	for(i=0;i&lt;theCats.length;i++)
		theCats[i]=theCats[i].toLowerCase(); //moves categories to lower case
	
	//compares all cats to see if in alphabetical order
	for(i=0;i&lt;theCats.length-1;i++){	     //compares all of the categories
		if(!(theCats[i+1]&gt;theCats[i]))
			alphed = false					 //if any categories out of order
	}										 //set variable to false
}
else{										
outputText_PR+=&quot;\n*This article does not have any [[WP:CAT|categories]]. Please categorize it with relevant &lt;code&gt;&lt;nowiki&gt;[[Category:Categories]]&lt;/nowiki&gt;&lt;/code&gt;.&quot;	 //if no categories
}
					
list_il = /\[\[(aa|af|ak|als|am|ang|ab|ar|an|roa\-rup|frp|as|ast|gn|av|ay|az|bm|bn|zh\-min\-nan|map\-bms|ba|be|bh|bi|bar|bo|bs|br|bg|bxr|ca|cv|ceb|cs|ch|cbk\-zam|ny|sn|tum|cho|co|za|cy|da|pdc|de|dv|arc|nv|dz|mh|et|el|eml|en|es|eo|eu|ee|fa|fo|fr|fy|ff|fur|ga|gv|gd|gl|ki|glk|gu|got|zh\-classical|xal|ko|ha|haw|hy|hi|ho|hsb|hr|io|ig|ilo|bpy|id|ia|ie|iu|ik|os|xh|zu|is|it|he|jv|kl|kn|kr|ka|ks|csb|kk|kw|rw|ky|rn|sw|kv|kg|ht|kj|ku|lad|lbe|lo|la|lv|lb|lt|lij|li|ln|jbo|lg|lmo|hu|mk|mg|ml|mt|mi|mr|mzn|ms|cdo|mo|mn|mus|my|nah|na|fj|nl|nds\-nl|cr|ne|new|ja|nap|ce|pih|no|nn|nrm|nov|oc|or|om|ng|hz|ug|pa|pi|pam|pag|pap|ps|km|pms|nds|pl|pt|ty|ksh|ro|rmy|rm|qu|ru|war|se|sm|sa|sg|sc|sco|st|tn|sq|ru\-sib|scn|si|simple|sd|ss|sk|cu|sl|so|sr|sh|su|fi|sv|tl|ta|roa\-tara|tt|te|tet|th|vi|ti|tg|tpi|to|chr|chy|ve|tr|tk|tw|udm|bug|uk|ur|uz|vec|vo|fiu\-vro|wa|vls|wo|wuu|ts|ii|yi|yo|zh\-yue|diq|zea|bat\-smg|zh|zh\-tw|zh\-cn):/gi		//interlanguage links 

if(list_il.test(inputText_PR)){
	theIL = inputText_PR.match(list_il)				 //array to hold ILs
	for(i=0;i&lt;theIL.length-1;i++){
		if(theIL[i+1] &lt;= theIL[i])			 //compares all categories
			check_il = false					
	}
}

if(!alphed &amp;&amp; alphed2 &amp;&amp; cat_PR)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/alpha|[[WP:CAT|categories]]}}&quot;
if(!alphed2 &amp;&amp; alphed &amp;&amp; alpha_PR)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/alpha}}&quot;
if(!alphed &amp;&amp; !alphed2 &amp;&amp; !cat_PR &amp;&amp; alpha_PR)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/alpha}}&quot;
if(!alphed &amp;&amp; !alphed2 &amp;&amp; cat_PR &amp;&amp; !alpha_PR)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/alpha|[[WP:CAT|categories]]&quot;+&quot; and [[WP:IL|interlanguage links]]&quot;+&quot;}}&quot;
if(!alphed &amp;&amp; !alphed2 &amp;&amp; cat_PR &amp;&amp; alpha_PR)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/alpha|[[WP:CAT|categories]] and [[WP:IL|interlanguage links]]}}&quot;*/

//----------* Summary style -ToC and entire article-
if(/\n==/g.test(inputText_PR)) theSections = inputText_PR.match(/\n==/g).length;
else theSections = 0;
    
if(theSections &lt;= 5 || inputText_PR.length &lt;= 7500)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/expand}}&quot;;
if(theSections &gt;= 24)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/toc}}&quot;;

if(!/\{\{main/gi.test(inputText_PR)){ if(inputText_PR.length &gt;= 50000)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/SS}}&quot;;}
else if(inputText_PR.match(/\{\{main/gi).length &lt;= 2 &amp;&amp; inputText_PR.length &gt;= 50000)
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/SS}}&quot;;

//----------* Section-stub template
if(/\{\{(sect(ion)?(\-|\s)?stub|stub(\-|\s)?section)\}\}/i.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/sectexpand}}&quot;;
//	
var inputText_PR_noquotes = inputText_PR.replace(/&quot;(.+?)&quot;/gi,&quot;&quot;).replace(/\[\[.{4,50}?\|/gi,&quot;&quot;)
//----------* Weasel words
var ww = new Array(&quot;some people sa&quot;,&quot;it has been&quot;,&quot;many people have&quot;,&quot;many scientists believe&quot;,&quot;allege&quot;,&quot;many people sa&quot;,&quot;many people believe&quot;,&quot;arguably&quot;,&quot;it is claimed&quot;,&quot;correctly&quot;,&quot;apparently&quot;,&quot;people considered&quot;,&quot;many considered&quot;,&quot;is considered&quot;,&quot;are considered&quot;); var ww2 = new Array();
isww = false; awtstring = &quot;&quot;; inputText_PRawt = inputText_PR_noquotes; wwref = 500;
for(i=0;i&lt;ww.length;i++) ww2[i] = new RegExp(ww[i],&quot;gi&quot;)

for(i=0;i&lt;ww.length;i++){
	while(ww2[i].test(inputText_PRawt)){
		inputText_PRawt = inputText_PRawt.substring(inputText_PRawt.indexOf(ww[i])+1,inputText_PRawt.length);
		if(!(/(&lt;ref|\{\{ref|\{\{fn|\{\{harv)/gi.test(inputText_PRawt.substring(0,wwref)))){
			isww = true;
			if(awtstring.indexOf(ww[i]) == -1) awtstring=awtstring+&quot;|''&quot;+ww[i]+&quot;''&quot;
		}
	}
}

if(isww)
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/awt&quot;+awtstring+&quot;}} &lt;!--This javascript cannot determine if a citation is provided; if all weasel terms are covered by citations, please strike this--&gt;&quot;

//----------* American/British English spellings (ize/ise, ization/isation, or/our, er/re, etc)
// ?!!!
var check_amer = 0, check_brit = 0, ab_ex = &quot;&quot;;

AmSpell = new Array(&quot;flavor&quot;,&quot;honor&quot;,&quot;armor&quot;,&quot;behavior&quot;,&quot;harbor&quot;,&quot;neighbor&quot;,&quot;favorite&quot;,&quot;aluminum&quot;,&quot;mustache&quot;,&quot;tidbit&quot;,&quot;meter&quot;,&quot;fiber&quot;,&quot;saber&quot;,&quot;defense&quot;,&quot;offense&quot;,&quot;pretense&quot;,&quot;organize&quot;,&quot;recognize&quot;,&quot;realize&quot;,&quot;colonize&quot;,&quot;criticize&quot;,&quot;categorize&quot;,&quot;ization&quot;,&quot;analyze&quot;,&quot;catalyze&quot;,&quot;hydrolyze&quot;,&quot;paralyze&quot;,&quot;anemia&quot;,&quot;anesthesia&quot;,&quot;cesium&quot;,&quot;diarrhea&quot;,&quot;gynecology&quot;,&quot;hemophilia&quot;,&quot;leukemia&quot;,&quot;esophagus&quot;,&quot;estrogen&quot;,&quot;orthopedic&quot;,&quot;pediatric&quot;,&quot;counterattack&quot;,&quot;counselor&quot;,&quot;equaling&quot;,&quot;modeling&quot;,&quot;quarreled&quot;,&quot;signaling&quot;,&quot;traveled&quot;,&quot;enrollment&quot;,&quot;fulfillment&quot;,&quot;installment&quot;,&quot;skillful&quot;,&quot; aging&quot;,&quot;routing&quot;,&quot;anymore&quot;,&quot;paycheck&quot;,&quot;cozy&quot;,&quot; gray&quot;,&quot;jewelry&quot;,&quot;curb&quot;,&quot;licorice&quot;,&quot;mold&quot;,&quot;molt&quot;,&quot;pajamas&quot;,&quot;program &quot;,&quot;skeptic&quot;,&quot;sulfur&quot;);
BrSpell = new Array(&quot;flavour&quot;,&quot;honour&quot;,&quot;armour&quot;,&quot;behaviour&quot;,&quot;harbour&quot;,&quot;neighbour&quot;,&quot;favourite&quot;,&quot;aluminium&quot;,&quot;moustache&quot;,&quot;titbit&quot;,&quot;metre&quot;,&quot;fibre&quot;,&quot;sabre&quot;,&quot;defence&quot;,&quot;offence&quot;,&quot;pretence&quot;,&quot;organise&quot;,&quot;recognise&quot;,&quot;realise&quot;,&quot;colonise&quot;,&quot;criticise&quot;,&quot;categorise&quot;,&quot;isation&quot;,&quot;analyse&quot;,&quot;catalyse&quot;,&quot;hydrolyse&quot;,&quot;paralyse&quot;,&quot;anaemia&quot;,&quot;anaesthesia&quot;,&quot;caesium&quot;,&quot;diarrhoea&quot;,&quot;gynaecology&quot;,&quot;haemophilia&quot;,&quot;leukaemia&quot;,&quot;oesophagus&quot;,&quot;oestrogen&quot;,&quot;orthopaedic&quot;,&quot;paediatric&quot;,&quot;counter-attack&quot;,&quot;counsellor&quot;,&quot;equalling&quot;,&quot;modelling&quot;,&quot;quarrelled&quot;,&quot;signalling&quot;,&quot;travelled&quot;,&quot;enrolment&quot;,&quot;fulfilment&quot;,&quot;instalment&quot;,&quot;skilful&quot;,&quot; ageing&quot;,&quot;routeing&quot;,&quot;any more&quot;,&quot;pay cheque&quot;,&quot;cosy&quot;,&quot; grey&quot;,&quot;jewellery&quot;,&quot;kerb&quot;,&quot;liquorice&quot;,&quot;mould&quot;,&quot;moult&quot;,&quot;pyjamas&quot;,&quot;programme&quot;,&quot;sceptic&quot;,&quot;sulphur&quot;);

for(i=0;i&lt;AmSpell.length;i++){
	if(inputText_PR_noquotes.indexOf(AmSpell[i]) != -1 &amp;&amp; wgTitle.indexOf(AmSpell[i]) == -1){
		check_amer++;
		ab_ex += &quot;''&quot; + AmSpell[i] + &quot;'' (A) (British: ''&quot; + BrSpell[i] + &quot;''), &quot;; 	
	}
	if(inputText_PR_noquotes.indexOf(BrSpell[i]) != -1 &amp;&amp; wgTitle.indexOf(BrSpell[i]) == -1){
		check_brit++;
		ab_ex += &quot;''&quot; + BrSpell[i] + &quot;'' (B) (American: ''&quot; + AmSpell[i] + &quot;''), &quot;;	
	}
}

if(check_amer &gt;= 2 &amp;&amp; check_brit &gt;= 2) outputText_PR+=&quot;\n*Please make the spelling of English words consistent with either [[American and British English spelling differences|American or British spelling]], depending upon the subject of the article. Examples include: &quot; + ab_ex.substring(0,ab_ex.length-2) + &quot;.&quot;;

//----------* Spellcheck - load [[Wikipedia:Lists of common misspellings/For machines]]
if(!noXHR_PR &amp;&amp; spellcheck_PR &amp;&amp; wgTitle.indexOf(&quot;Peer review&quot;) == -1){
	wpajax.download({url:'http://en.wikipedia.org/w/index.php?title=Wikipedia:Lists_of_common_misspellings/For_machines&amp;action=raw',
			onSuccess: spellCheckReview, OnFailure: spellCheckReview_fail, message: 'Wikipedia:Lists of common misspellings/For machines'});
    outputText_PR += spellcheck_output;
}

//----------* Common redundancies - based on [[User:Tony1/How_to_satisfy_Criterion_1a#Redundancy]]
// !!! more if possible, also general cleanup
redun_PR = new Array(0,0,0,0,0)
redun_regex = /(also|in\saddition|additionally|moreover|furthermore)/gi
if(redun_regex.test(inputText_PR_noquotes)){
	theaddnum = inputText_PR_noquotes.match(redun_regex)
	if((theaddnum.length&gt;=8)&amp;&amp;(theaddnum.length &gt;= inputText_PR.length/1800)) redun_PR[0] = 1;
}

redun_regex = /(some\s|a\svariety\sof|a\snumber\sof|a\smajority\sof|several|a\sfew|\smany|\sany\s|\sall\s)/gi
if(redun_regex.test(inputText_PR_noquotes)){
	thevsnum = inputText_PR_noquotes.match(redun_regex)
	if((thevsnum.length&gt;=8)&amp;&amp;(thevsnum.length &gt;= inputText_PR.length/1800)) redun_PR[1] = 1;
}

redun_regex = /(over\sthe\syears|currently|\snow\s|from\stime\sto\stime)/gi
if(redun_regex.test(inputText_PR_noquotes)){
	thetempnum = inputText_PR_noquotes.match(redun_regex)
	if(thetempnum.length&gt;=6 &amp;&amp; thetempnum.length &gt;= inputText_PR.length/2300) redun_PR[2] = 1;
}

redun_regex = /(in\sthe\syear|in\sthe\syear\sof)\s(\[\[|)(\d\d\d\d)/gi
if(redun_regex.test(inputText_PR_noquotes)){inputText_PR_noquotes.match(redun_regex); exyear = RegExp.$3; redun_PR[3] = 1;}	

redun_regex = /(thereupon|thereupon|notwithstanding|in\sorder\s(to|for))/gi
if(redun_regex.test(inputText_PR_noquotes)){
	if(inputText_PR_noquotes.match(redun_regex).length &gt; 2) redun_PR[4] = 1;	
}

if(redun_PR[0] || redun_PR[1] || redun_PR[2] || redun_PR[3]){
	outputText_PR+=&quot;\n*Watch for [[User:Tony1/How_to_satisfy_Criterion_2a#Redundancy|redundancies]] that make the article too wordy instead of being crisp and concise. (You may wish to try Tony1's [[User:Tony1/How to satisfy Criterion 1a: redundancy exercises|redundancy exercises]].)&quot;;	
	
	if(redun_PR[0])
		outputText_PR+=&quot;\n**While additive terms like “also”, “in addition”, “additionally”, “moreover”, and “furthermore” may sometimes be useful, overusing them when they aren't necessary can instead detract from the brilliancy of the article. This article has &quot;+theaddnum.length+&quot; additive terms, a bit too much.&quot;;
	if(redun_PR[1])
		outputText_PR+=&quot;\n**Vague terms of size often are unnecessary and redundant -  “some”, “a variety/number/majority of”, “several”, “a few”, “many”, “any”, and “all”. For example, “&lt;font color='red'&gt;&lt;s&gt;All&lt;/s&gt;&lt;/font&gt; pigs are pink, so we thought of &lt;font color='red'&gt;&lt;s&gt;a number of&lt;/s&gt;&lt;/font&gt; ways to turn them green.”&quot;;
	if(redun_PR[2])
		outputText_PR+=&quot;\n**Temporal terms like “over the years”, “currently”, “now”, and “from time to time” often are too vague to be useful, but occasionally may be helpful. “I am &lt;font color='red'&gt;&lt;s&gt;now&lt;/s&gt;&lt;/font&gt; using a semi-bot to generate your peer review.”&quot;;
	if(redun_PR[3])
		outputText_PR+=&quot;\n**“In &lt;font color='red'&gt;&lt;s&gt;the year [of]&lt;/s&gt;&lt;/font&gt; &quot;+exyear+&quot;”&quot;;
	if(redun_PR[4])
		outputText_PR+=&quot;\n**Avoid misplaced formality: “in order to/for” (-&gt; to/for), “thereupon”, “notwithstanding”, [[User:Tony1/How to satisfy Criterion 1a#Saying good-bye to misplaced formality|etc]].&quot;;
}

//----------* Contractions
if(/((is|are|was|were|have|has|had|wo|would|do|does|did|ca|could|should|might|must)n't|(would|should|could|might|must)'ve)/gi
    .test(inputText_PR_noquotes)){
	list_contraction = inputText_PR_noquotes.match(/((is|are|was|were|have|has|had|wo|would|do|does|did|ca|could|should|might|must)n't|(would|should|could|might|must)'ve)/gi).join(&quot;, &quot;);
    outputText_PR+=&quot;\n*Avoid using contractions like (outside of quotations): ''&quot; + list_contraction + &quot;''.&quot;;
}

//----------* Footnotes
var check_ref = 0;
if (/&lt;ref/g.test(inputText_PR)) check_ref=1;
else if (/\{\{(ref|fn|harv)/gi.test(inputText_PR)) check_ref=2;

if (!check_ref)						// no footnotes
	outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/foot}}&quot;
else if (check_ref==2)				//a method outside of the cite.php
	outputText_PR+=&quot;\n*You may wish to convert your form of references to the cite.php footnote system that [[WP:WIAFA]] 1(c) highly recommends.&quot;


//----------* Footnote spacing following a period
var list_sref = new Array(/(&lt;\/ref&gt;|\{\{(fn|ref)(\|.+)?\}\})\s?\./, /\.\s(&lt;ref&gt;|{\{(ref|fn))/, /&lt;\/ref&gt;(\s|\n)&lt;ref/), check_sref = false;
for(i=0;i&lt;list_sref.length;i++){
	if(list_sref[i].test(inputText_PR)){check_sref=true; break;}
}

if(check_sref) outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/footspace}}&quot;

//----------* Reference section
if(!/==\s?(reference|source|cit|works cit|footnote|note)/gi.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/ref}}&quot;

//----------* [citation needed]	
if(/\{\{(fact|citation\sneeded|cn)\}\}/gi.test(inputText_PR))
    outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/fact}}&quot;;

//----------* Copyediting reminder (default):
outputText_PR+=&quot;\n{{subst:User:AndyZ/PR/copyedit}}&quot;

//----------* closing + signature
outputText_PR+=endMsg_PR;

return outputText_PR;
} // %%%%%%%%% END REVIEW %%%%%%%%%%
// %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
// image licensing check functions:
// --------------------
// XMLHTTPrequest function by [[User:Zocky]], on [[WP:US]]
wpajax={
    download:function(bundle) {
// mandatory: bundle.url || optional: bundle.onSuccess (xmlhttprequest, bundle), bundle.onFailure (xmlhttprequest, bundle), bundle.otherStuff OK too, passed to onSuccess and onFailure
        var x = window.XMLHttpRequest ? new XMLHttpRequest() : window.ActiveXObject ? new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;) : false;
        if (x) {
            x.onreadystatechange=function() {
                x.readyState==4 &amp;&amp; wpajax.downloadComplete(x,bundle);
            };
            x.open(&quot;GET&quot;,bundle.url,true);
            x.send(null);
        }
        return x;
    },
      downloadComplete:function(x,bundle) {
            x.status==200 &amp;&amp; (bundle.onSuccess &amp;&amp; bundle.onSuccess(x,bundle) || true)
            || ( bundle.onFailure &amp;&amp; bundle.onFailure(x,bundle) || checkpage(x,bundle));
      }
};

function wikiImg(xmlreq,data){}	//empty function
function checkImgLicense(xmlreq, data) {
	 var imgTxt = xmlreq.responseText;
	 imgData = data.message.split(&quot;,&quot;);
	 if(imgData.length &gt; 2){
	       for(i=2;i&lt;imgData.length;i++) imgData[1] += imgData[i];
	 }
	 if(imgData[0] == &quot;raw&quot;){
		   imgNTtemplates = /\{\{(nolicense|nosource|no\ssource|no\slicense|nld|nsd|untagged)/gi
		 
	       if(imgTxt.indexOf(&quot;{{&quot;) == -1 || imgNTtemplates.test(imgTxt)){
	            imgNT = true; imgNTstr += &quot;|&quot; + imgData[1];
       	   }
	       
	       templFU = /\{\{.{0,}(Music sample|Speech|Sheet music|Albumcover|Boardgamecover|Book cover|Comiccover|DVDcover|Gamecover|Softwarecover|Magazinecover|Time|Newspapercover|Video tape cover|Logo|Computer hardware logo|Disneylogo|PreK12\-logo|Restaurant|Radiologo|Schoolboard\-logo|Scoutlogo|Sports\-logo|Hqfl logo|Olympics\-logo|Tv\-logo|Tv\-program\-logo|Univ\-logo|Symbol|Seal|Icon|Game\-icon|Wayfinding|Stamp|USPSstamp|Money|Promotional|DisneyAttractionPoster|Eventposter|Sportsposter|Movie poster|Political poster|Film\-screenshot|Machinima\-screenshot|Musicpromo\-screenshot|Tv\-screenshot|Video\-screenshot|Game\-screenshot|Cvg\-titlescreen|screen|photo|sign|cover|artwork|Digimonimage|DisneyCharacter|Pokeimage|Yugiohimage|Comicpanel|comicscene|Public Library images|Otto Perry image|Robert Richardson image|Parody|Smithsonian|Standard test|Fair use in|Fairusein\d|no\srationale|nrd|Replaceable\sfair\suse|refu|orfud|or\-fu\-re)/gi
		   FUrat = /(rationale|fair\suse)/gi
		   
		   if(templFU.test(imgTxt) &amp;&amp; !FUrat.test(imgTxt)){
				imgFU = true; imgFUstr += &quot;|&quot; + imgData[1];
		   }
 	 }
 	 else if(imgData[0] == &quot;htm&quot;){
	 	 if(imgTxt.indexOf(&quot;Template:&quot;) == -1){
		 	alert(imgData[1] + &quot;\n&quot; + &quot;\nNo licensing information (HTML check)&quot;);	 
	 	 }
 	 }
}

function checkpage(xmlreq, data){
	if(xmlreq.statusText != &quot;Not Found&quot;)
		alert(xmlreq.statusText + &quot;\n&quot; + data.url);	
}
// --------------------
// END img license checking
// --------------------
// START spellcheck, based on [[Wikipedia:Lists of common misspellings/For machines]]
// --------------------
function spellCheckReview(xmlreq, data){
	spellcheck_output = &quot;&quot;;
	var spell_string = &quot;&quot;;
	list_wordpairs = xmlreq.responseText.substring(0,xmlreq.responseText.lastIndexOf(&quot;zebra&quot;)+5)	// remove category
	list_wordpairs = list_wordpairs.split(&quot;\n&quot;);			// find all pairs of mispellings + actual words
	var misspelled_words = new Array(); var spellchecked_words = new Array();
	for(i=0;i&lt;list_wordpairs.length;i++){
		list_wordpairs[i] = list_wordpairs[i].substring(1,list_wordpairs[i].length);
																// remove spaces
		try{
			temp_spellarray = list_wordpairs[i].split(&quot;-&gt;&quot;);
			misspelled_words[i] = temp_spellarray[0];
			spellchecked_words[i] = temp_spellarray[1];
		}
		catch(e){
			misspelled_words[i] = list_wordpairs[i].substring(0,list_wordpairs[i].indexOf(&quot;-&gt;&quot;));
			spellchecked_words[i] = list_wordpairs[i].substring(list_wordpairs[i].indexOf(&quot;-&gt;&quot;)+2,list_wordpairs[i].length);
		}
		
		if(document.getElementById(input_PR).value.indexOf(&quot; &quot; + misspelled_words[i] + &quot; &quot;) != -1){
			spell_string += &quot;''&quot; + misspelled_words[i] + &quot;'' (&quot; + spellchecked_words[i] + &quot;)&quot; + &quot;,&quot;;
		}
	}
												
	if(spell_string.length &gt; 2)		//if mispelled_list exists																		
		spellcheck_output+=&quot;\n*Please check through the article for possible misspellings (see [[WP:SPELL]]). Examples of possible misspellings include: &quot; + spell_string.substring(0,spell_string.length-1) + &quot;.&quot;;
}

function spellCheckReview_fail(xmlreq,data){
	alert(&quot;Error: Unable to start spellcheck&quot;);
}
// --------------------
// END spellcheck
// --------------------
// START output configuring (template &lt;-&gt; prose, readonly, instaview, etc.)
// --------------------	
function replaceTemp(){// ----------* replace templates with actual contents (use ajax?)
	for(i = 0; i &lt; templateData_PR.length; i++){		//templates are listed above with global variables
		document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(new RegExp(&quot;{{sub&quot;+&quot;st:User:AndyZ/PR/&quot;+templateData_PR[i][0]+&quot;}}&quot;,&quot;g&quot;),templateData_PR[i][1]);
	}

    if(/\{\{subst:User:AndyZ\/PR\/.*\}\}/i.test(document.getElementById(output_PR).value))
        replaceTemplatesWithParams();	//continue by replacing templates w/ parameters
}

function replaceTemplatesWithParams(){
 output_txt = document.getElementById(output_PR).value;
 list_utemps = output_txt.match(/\{\{subst:User:AndyZ\/PR\/(.*)\}\}/gi);
 var list_params = new Array();
 for(i=0;i&lt;list_utemps.length;i++){
    list_utemps[i] = list_utemps[i].substring(22,list_utemps[i].length-2);
    list_params = list_utemps[i].split(&quot;|&quot;);
    if(list_params.length == 1) continue;
    uTN_PR = list_params[0];
	
    list_paramsStr = &quot;&quot;;
    for(j=1;j&lt;list_params.length;j++){
        if(j==list_params.length-1) list_paramsStr += list_params[j];
        else list_paramsStr += list_params[j] + &quot;,,&quot;;	
    }
		
        //if statements
    if(uTN_PR == &quot;time&quot;)
        document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(/\{\{subst:User:AndyZ\/PR\/time.*\}\}/gi,&quot;*Per [[WP:MOS#Time|WP:MOS]], avoid using words/phrases that indicate time periods relative to the current day. For example, ''&quot; + list_paramsStr.replace(/\,\,/g,&quot;'', ''&quot;) + &quot;'' might be terms that should be replaced with specific dates/times.&lt;sup&gt;[[User:AndyZ/G#time|[?]]]&lt;/sup&gt;&quot;);
    if(uTN_PR == &quot;awt&quot;)
        document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(/\{\{subst:User:AndyZ\/PR\/awt.*\}\}/gi,&quot;*There are a few occurrences of [[weasel word]]s in this article- please observe [[WP:AWT]]. Certain phrases should specify exactly who supports, considers, believes, etc., such a view.\n**&quot; + list_paramsStr.replace(/\,\,/g,&quot;\n**&quot;) + &quot;\n**might be weasel words, and should be provided with proper [[WP:FOOTNOTE|citations]] (if they already do, or are not weasel terms, please &lt;strike&gt;strike&lt;/strike&gt; this comment).&lt;sup&gt;[[User:AndyZ/G#awt|[?]]]&lt;/sup&gt;&quot;);
    if(uTN_PR == &quot;nbsp&quot;)
        document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(/\{\{subst:User:AndyZ\/PR\/nbsp.*\}\}/gi,&quot;*Per [[Wikipedia:Manual of Style (dates and numbers)#Units of measurement|Wikipedia:Manual of Style (numbers)]], there should be a non-breaking space - &lt;code&gt;&amp;amp;nbsp;&lt;/code&gt; between a number and the unit of measurement. For example, instead of ''&quot;+list_params[1]+&quot;'', use ''&quot;+list_params[2]+&quot;'', which when you are editing the page, should look like: &lt;tt&gt;&quot;+list_params[3]+&quot;&lt;/tt&gt;.&lt;sup&gt;[[User:AndyZ/G#nbsp|[?]]]&lt;/sup&gt;&quot;);
	/*if(uTN_PR == &quot;imgfu&quot;)
		document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(/\{\{subst:User:AndyZ\/PR\/imgfu.*\}\}/gi,&quot;*Images with [[fair use]] tags need [[WP:FU|fair use rationales]] - please see [[WP:FUC]]. Specifically, [[:&quot; + list_paramsStr.replace(/\,\,/gi,&quot;]], [[:&quot;) + &quot;]] need(s) proper fair use rationales.&quot;);
	if(uTN_PR == &quot;imgtag&quot;)
		document.getElementById(output_PR).value = document.getElementById(output_PR).value.replace(/\{\{subst:User:AndyZ\/PR\/imgtag.*\}\}/gi,&quot;*Images need proper [[WP:IMAGE|image]] [[WP:IT|copyright tags]] and source information. Specifically, [[:&quot; + list_paramsStr.replace(/\,\,/gi,&quot;]], [[:&quot;) + &quot;]] need(s) proper image copyright tags.&quot;);
	*/
 }	
}

function determineReadonly(){		//readonly, to prevent accidental editing of the text
	if(document.getElementById(output_PR).readOnly) {
		document.getElementById(output_PR).readOnly = false; 	
		document.theForm.switch_readonly.value = &quot;Readonly&quot;;		//button properties 
		document.theForm.switch_readonly.style.width = 150;
	}
	else {
		document.getElementById(output_PR).readOnly = true; 
		document.theForm.switch_readonly.value = &quot;Edit-able&quot;;		//button properties 
		document.theForm.switch_readonly.style.width = 150;
	}
}

function popreview(){
	PRresult = &quot;&lt;script&gt;wgUserName = '&quot; + wgUserName + &quot;';&lt;/s&quot; + &quot;cript&gt;&lt;script type='text/javascript' src='http://en.wikipedia.org/w/index.php?title=User:AndyZ/peerreviewer.js&amp;action=raw&amp;ctype=text/javascript&amp;dontcountme=s'&gt;&lt;/s&quot; + &quot;cript&gt;Return to &lt;a href='http://en.wikipedia.org/wiki/&quot; + wgPageName + &quot;'&gt;&quot; + wgTitle + &quot;&lt;/a&gt; (&lt;a href='http://en.wikipedia.org/w/index.php?title=&quot;+wgPageName+&quot;&amp;action=edit'&gt;edit&lt;/a&gt; | &lt;a href='http://en.wikipedia.org/w/index.php?title=&quot;+wgPageName+&quot;&amp;action=history'&gt;history&lt;/a&gt;) &lt;br&gt;&lt;br&gt;&lt;form name='theForm'&gt; &lt;input type='button' value='Readonly' name='switch_readonly' onclick='determineReadonly()' style='width:150'&gt;&lt;br&gt;&lt;textarea id='theResponse' name='theResponse' cols='120' rows='50'&gt;&quot; + document.getElementById(output_PR).value + &quot;&lt;/textarea&gt;&lt;/form&gt;&quot;;
	var newPage_PR = window.open(&quot;http://en.wikipedia.org/&quot;,&quot;winName&quot;);
	newPage_PR.document.write(PRresult);
	newPage_PR.document.close();
}

// --------------------	
// show and hide results 
// --------------------	
function hide_PR(){var d=document;
	d.getElementById(&quot;theFeedback&quot;).style.visibility = &quot;hidden&quot;;
	d.getElementById(&quot;restore&quot;).style.visibility = &quot;visible&quot;;
}
function show_PR(){var d=document;
	d.getElementById(&quot;theFeedback&quot;).style.visibility = &quot;visible&quot;;
	d.getElementById(&quot;restore&quot;).style.visibility = &quot;hidden&quot;;
}

function toJSpeerreview(){
	if(document.title.indexOf(&quot;Editing &quot;) == 0) JSpeerreview();
	else window.open('http://en.wikipedia.org/w/index.php?title='+wgPageName+'&amp;action=edit&amp;fakeaction=displayPR','Edit');	
}

// STARTFILE: autopr.js
function pr()
{
  var pagename = document.editform.action.substring(pagename.indexOf('title=') + 6,pagename.lastIndexOf('&amp;action=submit'));

  window.open('http://en.wikipedia.org/w/index.php?title=Talk:' + unescape(pagename) + '&amp;action=edit&amp;fakeaction=prtemp','Talk', 'status,toolbar,location,menubar,directories,resizeable,scrollbars');          
  window.open('/w/index.php?title=Wikipedia:Peer_review/' + unescape(pagename) + '&amp;action=edit&amp;fakeaction=prsub&amp;faketarget=' + unescape(pagename),'PRnom', 'status,toolbar,location,menubar,directories,resizeable,scrollbars');
  window.open('/w/index.php?title=Wikipedia:Peer_review&amp;action=edit&amp;fakeaction=prlist&amp;faketarget=' + unescape(pagename), 'PRlisting', 'status,toolbar,location,menubar,directories,resizeable,scrollbars');
}

function autopr()
{
  if (document.title.indexOf('Editing ') == 0)
    {
      var theaction = '';
      var target = '';
      if (location.search)
        {
          var l = location.search.substring(1).split('&amp;');
          for (var i = 0; i &lt; l.length; ++i)
            {
              var eq = l[i].indexOf('=');
              var name = l[i].substring(0, eq);
              if (name == 'fakeaction')
                theaction = l[i].substring(eq + 1);
              else if (name == 'faketarget')
                target = unescape(l[i].substring(eq + 1)).replace(/_/g, ' ');
            }
        }
      if (theaction == 'prlist')
        {
          req = document.editform.wpTextbox1.value.indexOf(&quot;{{Wikipedia:Peer review/&quot;);
          document.editform.wpTextbox1.value = document.editform.wpTextbox1.value.substring(0,req) + '{{Wikipedia:Peer review/' + target + '}}\n' + document.editform.wpTextbox1.value.substring(req,document.editform.wpTextbox1.value.length);
          document.editform.wpSummary.value = '[[Wikipedia:Peer review/' + target + ']]';
        }
      else if (theaction == 'prsub'){
          if (document.editform.wpTextbox1.value.length &gt; 0)
              window.alert(&quot;There's an old peer review at the default location already.\n\n&quot; +
                           'Please either move it out of the way (and update existing links to it), or file the PR by hand in another location (such as [[Wikipedia:Peer review/' + wgTitle.split(&quot;/&quot;)[1] + ' 2]]).');
          else
            document.editform.wpTextbox1.value += '===[[' + target + ']]===\n' +
              '&lt;!--Reason for nomination.--&gt; ~~' + '~~';
      }
      else if (theaction == 'prtemp'){
          if (document.editform.wpTextbox1.value.indexOf('{{peerreview}}') != -1)     
              window.alert(&quot;There has already been a peer review.&quot;);
          else{
              document.editform.wpTextbox1.value = '{{peerreview}}\n\n' + document.editform.wpTextbox1.value;
              document.editform.wpSummary.value = 'peer reviewing - [[Wikipedia:Peer review/' + target + ']]';
            }
        }
      else if (theaction == 'displayPR')
	    	    JSpeerreview();
      else
        pr();
    }
}

if(sendTo_PR){
	addOnloadHook(function () {
	    if(document.forms.editform) addLink('p-cactions', 'javascript:autopr()', 'send to WP:PR', 'ca-peerreview', 'Submits article for peer review', '', '');
	});
}

if(document.location.href.indexOf(&quot;fakeaction&quot;) != -1) addOnloadHook(autopr);

// ENDFILE autopr.js &lt;/pre&gt;
// &lt;pre&gt;STARTFILE maintainPRA.js
var mem;
if(wgUserName == &quot;AZPR&quot; || maintain_PR){
	if(wgTitle.indexOf(&quot;Peer review/&quot;) != -1 &amp;&amp; wgTitle.indexOf(&quot;Automated&quot;) == -1 &amp;&amp; wgNamespaceNumber == 4 &amp;&amp; document.title.indexOf(&quot;Editing &quot;) == 0){
		addOnloadHook(function () {
		    mem = document.getElementById(&quot;wpTextbox1&quot;).value;
		    JSpeerreview();
		    if(mem != document.getElementById(&quot;wpTextbox1&quot;).value) document.getElementById('wpSave').click();
		});
	}

	if(wgPageName.indexOf(&quot;Wikipedia:Peer_review/Automated/&quot;) != -1 &amp;&amp; document.title.indexOf(&quot;Editing &quot;) == 0){
		addOnloadHook(function () {
		    document.getElementById('wpSummary').value += &quot;new automated PR requests&quot;;
		});
	}
	
	if((document.location.href.indexOf(&quot;action=edit&quot;)!=-1) &amp;&amp; (wgNamespaceNumber == 0)){
		addOnloadHook(JSpeerreview);
	}
	
	if(wgNamespaceNumber == 4 &amp;&amp; wgTitle.indexOf(&quot;Peer review/Automated/&quot;) != -1 &amp;&amp; /\d{4}/.test(wgTitle) &amp;&amp; document.editform){
		if(document.getElementById(&quot;wpTextbox1&quot;).value == &quot;&quot;){
			document.getElementById(&quot;wpTextbox1&quot;).value = &quot;{&quot;+&quot;{Wikipedia:Peer review/Automated/header}}\n==Requests==\n{&quot;+&quot;{Wikipedia:Peer review/Automated/foot}}&quot;;
			document.getElementById('wpSummary').value += &quot;Starting new subpage for automated peer reviews&quot;;
			document.getElementById('wpSave').click();
		}
	}
	
	if(wgNamespaceNumber == 5 &amp;&amp; wgTitle.indexOf(&quot;Peer review/Automated/&quot;) != -1 &amp;&amp; /\d{4}/.test(wgTitle) &amp;&amp; document.editform){
		if(document.getElementById(&quot;wpTextbox1&quot;).value == &quot;&quot;){
			document.getElementById(&quot;wpTextbox1&quot;).value = &quot;#redirect [[Wikipedia talk:Peer review/Automated]]&quot;;
			document.getElementById('wpSummary').value += &quot;Redirect to [[Wikipedia talk:Peer review/Automated]]&quot;;
			document.getElementById('wpSave').click();
		}
	}
}

if(maintain2_PR){
	if(wgTitle.indexOf(&quot;Peer review/&quot;) != -1 &amp;&amp; wgTitle.indexOf(&quot;Automated&quot;) == -1 &amp;&amp; wgNamespaceNumber == 4){
		addOnloadHook(function () {
		    mem = document.getElementById(&quot;wpTextbox1&quot;).value;
		    JSpeerreview();
		    if(mem != document.getElementById(&quot;wpTextbox1&quot;).value) document.getElementById('wpSave').click();
		});
	}

	if(wgPageName.indexOf(&quot;Wikipedia:Peer_review/Automated/&quot;) != -1 &amp;&amp; document.title.indexOf(&quot;Editing &quot;) == 0){
		addOnloadHook(function () {
		    document.getElementById('wpSummary').value += &quot;new automated PR requests&quot;;
		});
	}
	
	if(wgNamespaceNumber == 4 &amp;&amp; wgTitle.indexOf(&quot;Peer review/Automated/&quot;) != -1 &amp;&amp; /\d{4}/.test(wgTitle) &amp;&amp; document.editform){
		if(document.getElementById(&quot;wpTextbox1&quot;).value == &quot;&quot;){
			document.getElementById(&quot;wpTextbox1&quot;).value = &quot;{&quot;+&quot;{Wikipedia:Peer review/Automated/header}}\n==Requests==\n{&quot;+&quot;{Wikipedia:Peer review/Automated/foot}}&quot;;
			document.getElementById('wpSummary').value += &quot;Starting new subpage for automated peer reviews&quot;;
			document.getElementById('wpSave').click();
		}
	}
}
// ENDFILE maintainPRA.js

// ************************* ///_///_/// 
// END PEER REVIEWING SCRIPT //|_)/|_)//
// ************************* //|///| \//
function instaPreview(){
	if(document.getElementById('InstaViewResponse').style.visibility == &quot;hidden&quot;){
		InstaViewPR.dump(output_PR, 'InstaViewResponse');
		document.getElementById('instaview_button').style.width = 150;
		document.getElementById('instaview_button').value = &quot;Hide instaview&quot;;
		document.getElementById('InstaViewResponse').style.visibility = &quot;visible&quot;;
		document.getElementById('InstaViewResponse').style.background = &quot;white&quot;;
		document.getElementById('InstaViewResponse').style.border = &quot;2px solid orange&quot;;
		document.getElementById('theFeedback').style.width = width4_PR+&quot;px&quot;
	}
	else{
		document.getElementById('instaview_button').style.width = 150;
		document.getElementById('instaview_button').value = &quot;Instaview&quot;;
		document.getElementById('InstaViewResponse').innerHTML = &quot;&quot;;
		document.getElementById('InstaViewResponse').style.visibility = &quot;hidden&quot;;
	}
}
if(showInstaview_PR){
	addOnloadHook(function(){
	  if (document.getElementById('editpage-copywarn')) {
	    var oldPreview = document.getElementById('wpPreview');
	    var newPreview = document.createElement('input');
	    newPreview.setAttribute('type', 'button');
	    newPreview.setAttribute('style', 'font-style: italic');
	    newPreview.setAttribute('value', 'InstaView');
	    newPreview.setAttribute('onclick', &quot;InstaViewPR.dump('wpTextbox1', 'InstaViewDump')&quot;);
	    oldPreview.parentNode.insertBefore(newPreview, oldPreview);
	    oldPreview.parentNode.innerHTML += '&lt;div style=&quot;margin: 5px 0 5px 0; padding: 5px; border: 2px solid orange;&quot; id=&quot;InstaViewDump&quot;&gt;&lt;/div&gt;';
	    oldPreview.value = 'Classic Preview';
	    }
	});
}

// STARTFILE: livepreview.js

/*
 * InstaView - a Mediawiki to HTML converter in JavaScript
 * Version 0.6.1
 * Copyright (C) Pedro Fayolle 2005-2006
 * http://en.wikipedia.org/wiki/User:Pilaf
 * Distributed under the BSD license
 *----------* For full comments/documentation, see [[User:Pilaf/instaview.js]]
*/

var InstaViewPR = {}

// options
InstaViewPR.conf =
{
	user: {},
	wiki: {
		lang: 'en',
		interwiki: 'ab|aa|af|ak|sq|als|am|ang|ar|an|arc|hy|roa-rup|as|ast|av|ay|az|bm|ba|eu|be|bn|bh|bi|bs|br|bg|my|ca|ch|ce|chr|chy|ny|zh|zh-tw|zh-cn|cho|cv|kw|co|cr|hr|cs|da|dv|nl|dz|en|eo|et|ee|fo|fj|fi|fr|fy|ff|gl|ka|de|got|el|kl|gn|gu|ht|ha|haw|he|hz|hi|ho|hu|is|io|ig|id|ia|ie|iu|ik|ga|it|ja|jv|kn|kr|csb|ks|kk|km|ki|rw|rn|tlh|kv|kg|ko|kj|ku|ky|lo|la|lv|li|ln|lt|jbo|nds|lg|lb|mk|mg|ms|ml|mt|gv|mi|minnan|mr|mh|zh-min-nan|mo|mn|mus|nah|na|nv|ne|se|no|nn|oc|or|om|pi|fa|pl|pt|pa|ps|qu|ro|rm|ru|sm|sg|sa|sc|gd|sr|sh|st|tn|sn|scn|simple|sd|si|sk|sl|so|st|es|su|sw|ss|sv|tl|ty|tg|ta|tt|te|th|bo|ti|tpi|to|tokipona|ts|tum|tr|tk|tw|uk|ur|ug|uz|ve|vi|vo|wa|cy|wo|xh|ii|yi|yo|za|zu',
		default_thumb_width: 180
	},
	paths: {
		articles: '/wiki/',
		math: '/math/',
		images: '',
		images_fallback: 'http://upload.wikimedia.org/wikipedia/commons/',
		magnify_icon: 'skins/common/images/magnify-clip.png'
	},
	locale: {
		user: 'User',
		image: 'Image',
		category: 'Category',
		months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
	}
}

// options with default values or backreferences
with (InstaViewPR.conf) {
	user.name = user.name || wgUserName || 'Wikipedian'
	user.signature = '[['+locale.user+':'+user.name+'|'+user.name+']]'
	paths.images = 'http://upload.wikimedia.org/wikipedia/' + wiki.lang + '/'
}

// define constants
InstaViewPR.BLOCK_IMAGE = new RegExp('^\\[\\['+InstaViewPR.conf.locale.image+':.*?\\|.*?(?:frame|thumbnail|thumb|none|right|left|center)', 'i');

InstaViewPR.dump = function(from, to)
{
	if (typeof from == 'string') from = document.getElementById(from)
	if (typeof to == 'string') to = document.getElementById(to)
	to.innerHTML = this.convert(from.value)
}

InstaViewPR.convert = function(wiki)
{
	var 	ll = (typeof wiki == 'string')? wiki.replace(/\r/g,'').split(/\n/): wiki, // lines of wikicode
		o='',	// output
		p=0,	// para flag
		$r	// result of passing a regexp to $()
	
	// some shorthands
	function remain() { return ll.length }
	function sh() { return ll.shift() }
	function ps(s) { o+=s } // push
	
	function f()
	{
		var i=1,a=arguments,f=a[0],o='',c,p
		for (;i&lt;a.length; i++) if ((p=f.indexOf('?'))+1) {
			// allow character escaping
			i -= c=f.charAt(p+1)=='?'?1:0
			o += f.substring(0,p)+(c?'?':a[i])
			f=f.substr(p+1+c)
		} else break;
		return o+f
	}
	
	function html_entities(s) { return s.replace(/&amp;/g,&quot;&amp;amp;&quot;).replace(/&lt;/g,&quot;&amp;lt;&quot;).replace(/&gt;/g,&quot;&amp;gt;&quot;) }
	
	function max(a,b) { return (a&gt;b)?a:b }
	function min(a,b) { return (a&lt;b)?a:b }

	function str_imatch(a, b)
	{
		for (var i=0, l=min(a.length, b.length); i&lt;l; i++) if (a.charAt(i)!=b.charAt(i)) break
		return i
	}

	function $(c) { return (typeof c == 'string') ? (ll[0].substr(0,c.length)==c) : ($r = ll[0].match(c)) }
	
	function $$(c) { return ll[0]==c } // compare current line against a string
	function _(p) { return ll[0].charAt(p) } // return char at pos p
	
	function endl(s) { ps(s); sh() }
	
	function parse_list()
	{
		var prev='';
		
		while (remain() &amp;&amp; $(/^([*#:;]+)(.*)$/)) {
			
			var l_match = $r;
			sh();
			var ipos = str_imatch(prev, l_match[1]);

			for (var i=prev.length-1; i &gt;= ipos; i--) {
				
				var pi = prev.charAt(i)
				
				if (pi=='*') ps('&lt;/ul&gt;')
				else if (pi=='#') ps('&lt;/ol&gt;')
				// close a dl only if the new item is not a dl item (:, ; or empty)
				else switch (l_match[1].charAt(i)) { case'':case'*':case'#': ps('&lt;/dl&gt;') }
			}

			for (var i=ipos; i&lt;l_match[1].length; i++) {
				
				var li = l_match[1].charAt(i)
				
				if (li=='*') ps('&lt;ul&gt;')
				else if (li=='#') ps('&lt;ol&gt;')
				// open a new dl only if the prev item is not a dl item (:, ; or empty)
				else switch(prev.charAt(i)) { case'':case'*':case'#': ps('&lt;dl&gt;') }
			}
			
			switch (l_match[1].charAt(l_match[1].length-1)) {
			
				case '*': case '#':
					ps('&lt;li&gt;' + parse_inline_nowiki(l_match[2])); break
					
				case ';':
					ps('&lt;dt&gt;')
					
					var dt_match
					
					// handle ;dt :dd format
					if (dt_match = l_match[2].match(/(.*?) (:.*?)$/)) {
						
						ps(parse_inline_nowiki(dt_match[1]))
						ll.unshift(dt_match[2])
						
					} else ps(parse_inline_nowiki(l_match[2]))
					
					break
					
				case ':':
					ps('&lt;dd&gt;' + parse_inline_nowiki(l_match[2]))
			}
			
			prev=l_match[1]
		}

		for (var i=prev.length-1; i&gt;=0; i--)
			ps(f('&lt;/?&gt;', (prev.charAt(i)=='*')? 'ul': ((prev.charAt(i)=='#')? 'ol': 'dl')))
	}
	
	function parse_table()
	{
		endl(f('&lt;table?&gt;', $(/^\{\|( .*)$/)? $r[1]: ''))
		
		for (;remain();) if ($('|')) switch (_(1)) {
			case '}': endl('&lt;/table&gt;'); return
			case '-': endl(f('&lt;tr ?&gt;', $(/\|-*(.*)/)[1])); break
			default: parse_table_data()
		}
		else if ($('!')) parse_table_data()
		else sh()
	}
	
	function parse_table_data()
	{
		var td_line, match_i
		var td_match = sh().match(/^(\|\+|\||!)((?:([^[|]*?)\|(?!\|))?(.*))$/)
		if (td_match[1] == '|+') ps('&lt;caption');
		else ps('&lt;t' + ((td_match[1]=='|')?'d':'h'))
		if (typeof td_match[3] != 'undefined') {
			ps(' ' + td_match[3])
			match_i = 4
		} else match_i = 2
		
		ps('&gt;')
		
		if (td_match[1] != '|+') {
			td_line = td_match[match_i].split((td_match[1] == '|')? '||': /(?:\|\||!!)/)
			
			ps(parse_inline_nowiki(td_line.shift()))
			
			while (td_line.length) ll.unshift(td_match[1] + td_line.pop())
			
		} else ps(td_match[match_i])
		
		var tc = 0, td = []
		
		for (;remain(); td.push(sh()))
		if ($('|')) {
			if (!tc) break // we're at the outer-most level (no nested tables), skip to td parse
			else if (_(1)=='}') tc--
		}
		else if (!tc &amp;&amp; $('!')) break
		else if ($('{|')) tc++
		
		if (td.length) ps(InstaViewPR.convert(td))
	}
	
	function parse_pre()
	{
		ps('&lt;pre&gt;')
		do endl(parse_inline_nowiki(ll[0].substring(1)) + &quot;\n&quot;); while (remain() &amp;&amp; $(' '))
		ps('&lt;/pre&gt;')
	}
	
	function parse_block_image()
	{
		ps(parse_image(sh()))
	}

	function parse_image(str)
	{
		var tag = str.substring(InstaViewPR.conf.locale.image.length + 3, str.length - 2);
		
		var width;
		var attr = [], filename, caption = '';
		var thumb=0, frame=0, center=0;
		var align='';
		
		if (tag.match(/\|/)) {
			// manage nested links
			var nesting = 0;
			var last_attr;
			for (var i = tag.length-1; i &gt; 0; i--) {
				if (tag.charAt(i) == '|' &amp;&amp; !nesting) {
					last_attr = tag.substr(i+1);
					tag = tag.substring(0, i);
					break;
				} else switch (tag.substr(i-1, 2)) {
					case ']]':
						nesting++;
						i--;
						break;
					case '[[':
						nesting--;
						i--;
				}
			}
			
			attr = tag.split(/\s*\|\s*/);
			attr.push(last_attr);
			filename = attr.shift();
			
			var w_match;
			
			for (;attr.length; attr.shift())
			if (w_match = attr[0].match(/^(\d*)px$/)) width = w_match[1]
			else switch(attr[0]) {
				case 'thumb':
				case 'thumbnail':
					thumb=true;
				case 'frame':
					frame=true;
					break;
				case 'none':
				case 'right':
				case 'left':
					center=false;
					align=attr[0];
					break;
				case 'center':
					center=true;
					align='none';
					break;
				default:
					if (attr.length == 1) caption = attr[0];
			}
			
		} else filename = tag;
		
		
		var o='';
		if (frame) {
			if (align=='') align = 'right';
			o += f(&quot;&lt;div class='thumb t?'&gt;&quot;, align);
			
			if (thumb) {
				if (!width) width = InstaViewPR.conf.wiki.default_thumb_width;
				
				o += f(&quot;&lt;div style='width:?px;'&gt;?&quot;, 2+width*1, make_image(filename, caption, width)) +
					f(&quot;&lt;div class='thumbcaption'&gt;&lt;div class='magnify' style='float:right'&gt;&lt;a href='?' class='internal' title='Enlarge'&gt;&lt;img src='?'&gt;&lt;/a&gt;&lt;/div&gt;?&lt;/div&gt;&quot;,
						InstaViewPR.conf.paths.articles + InstaViewPR.conf.locale.image + ':' + filename,
						InstaViewPR.conf.paths.magnify_icon,
						parse_inline_nowiki(caption)
					)
			} else {
				o += '&lt;div&gt;' + make_image(filename, caption) + f(&quot;&lt;div class='thumbcaption'&gt;?&lt;/div&gt;&quot;, parse_inline_nowiki(caption))
			}
			
			o += '&lt;/div&gt;&lt;/div&gt;';
			
		} else if (align != '') {
			o += f(&quot;&lt;div class='float?'&gt;&lt;span&gt;?&lt;/span&gt;&lt;/div&gt;&quot;, align, make_image(filename, caption, width));
		} else {
			return make_image(filename, caption, width);
		}
		
		return center? f(&quot;&lt;div class='center'&gt;?&lt;/div&gt;&quot;, o): o;
	}
	
	function parse_inline_nowiki(str)
	{
		var start, lastend=0
		var substart=0, nestlev=0, open, close, subloop;
		var html='';
		
		while (-1 != (start = str.indexOf('&lt;nowiki&gt;', substart))) {
			html += parse_inline_wiki(str.substring(lastend, start));
			start += 8;
			substart = start;
			subloop = true;
			do {
				open = str.indexOf('&lt;nowiki&gt;', substart);
				close = str.indexOf('&lt;/nowiki&gt;', substart);
				if (close&lt;=open || open==-1) {
					if (close==-1) {
						return html + html_entities(str.substr(start));
					}
					substart = close+9;
					if (nestlev) {
						nestlev--;
					} else {
						lastend = substart;
						html += html_entities(str.substring(start, lastend-9));
						subloop = false;
					}
				} else {
					substart = open+8;
					nestlev++;
				}
			} while (subloop)
		}
		
		return html + parse_inline_wiki(str.substr(lastend));
	}
	
	function make_image(filename, caption, width)
	{
		// uppercase first letter in file name
		filename = filename.charAt(0).toUpperCase() + filename.substr(1);
		// replace spaces with underscores
		filename = filename.replace(/ /g, '_');
		
		caption = strip_inline_wiki(caption);
		
		var md5 = hex_md5(filename);
		
		var source = md5.charAt(0) + '/' + md5.substr(0,2) + '/' + filename;
		
		if (width) width = &quot;width='&quot; + width + &quot;px'&quot;;
		
		var img = f(&quot;&lt;img onerror=\&quot;this.onerror=null;this.src='?'\&quot; src='?' ? ?&gt;&quot;, InstaViewPR.conf.paths.images_fallback + source, InstaViewPR.conf.paths.images + source, (caption!='')? &quot;alt='&quot; + caption + &quot;'&quot; : '', width);
		
		return f(&quot;&lt;a class='image' ? href='?'&gt;?&lt;/a&gt;&quot;, (caption!='')? &quot;title='&quot; + caption + &quot;'&quot; : '', InstaViewPR.conf.paths.articles + InstaViewPR.conf.locale.image + ':' + filename, img);
	}
	
	function parse_inline_images(str)
	{
		var start, substart=0, nestlev=0;
		var loop, close, open, wiki, html;
		
		while (-1 != (start=str.indexOf('[[', substart))) {
			if(str.substr(start+2).match(RegExp('^' + InstaViewPR.conf.locale.image + ':','i'))) {
				loop=true;
				substart=start;
				do {
					substart+=2;
					close=str.indexOf(']]',substart);
					open=str.indexOf('[[',substart);
					if (close&lt;=open||open==-1) {
						if (close==-1) return str;
						substart=close;
						if (nestlev) {
							nestlev--;
						} else {
							wiki=str.substring(start,close+2);
							html=parse_image(wiki);
							str=str.replace(wiki,html);
							substart=start+html.length;
							loop=false;
						}
					} else {
						substart=open;
						nestlev++;
					}
				} while (loop)
				
			} else break;
		}
		
		return str;
	}

	function parse_inline_formatting(str)
	{
		var em,st,i,li,o='';
		while ((i=str.indexOf(&quot;''&quot;,li))+1) {
			o += str.substring(li,i);
			li=i+2;
			if (str.charAt(i+2)==&quot;'&quot;) {
				li++;
				st=!st;
				o+=st?'&lt;strong&gt;':'&lt;/strong&gt;';
			} else {
				em=!em;
				o+=em?'&lt;em&gt;':'&lt;/em&gt;';
			}
		}
		return o+str.substr(li);
	}
	
	function parse_inline_wiki(str)
	{
		var aux_match;
		
		str = parse_inline_images(str);
		str = parse_inline_formatting(str);

		while (aux_match = str.match(/&lt;(?:)math&gt;(.*?)&lt;\/math&gt;/i)) {
			var math_md5 = hex_md5(aux_match[1]);
			str = str.replace(aux_match[0], f(&quot;&lt;img src='?.png'&gt;&quot;, InstaViewPR.conf.paths.math+math_md5));
		}
		
		var date = new Date;
		var minutes = date.getUTCMinutes();
		if (minutes &lt; 10) minutes = '0' + minutes;
		var date = f(&quot;?:?, ? ? ? (UTC)&quot;, date.getUTCHours(), minutes, date.getUTCDate(), InstaViewPR.conf.locale.months[date.getUTCMonth()], date.getUTCFullYear());

		return str.
			// signatures
			replace(/~{5}(?!~)/g, date).
			replace(/~{4}(?!~)/g, InstaViewPR.conf.user.name+' '+date).
			replace(/~{3}(?!~)/g, InstaViewPR.conf.user.name).
			
			// [[:Category:...]], [[:Image:...]], etc...
			replace(RegExp('\\[\\[:((?:'+InstaViewPR.conf.locale.category+'|'+InstaViewPR.conf.locale.image+'|'+InstaViewPR.conf.wiki.interwiki+'):.*?)\\]\\]','gi'), &quot;&lt;a href='&quot;+InstaViewPR.conf.paths.articles+&quot;$1'&gt;$1&lt;/a&gt;&quot;).
			replace(RegExp('\\[\\[(?:'+InstaViewPR.conf.locale.category+'|'+InstaViewPR.conf.wiki.interwiki+'):.*?\\]\\]','gi'),'').
			
			// [[/Relative links]]
			replace(/\[\[(\/[^|]*?)\]\]/g, f(&quot;&lt;a href='?$1'&gt;$1&lt;/a&gt;&quot;, location)).
			
			// [[/Replaced|Relative links]]
			replace(/\[\[(\/.*?)\|(.+?)\]\]/g, f(&quot;&lt;a href='?$1'&gt;$2&lt;/a&gt;&quot;, location)).
			
			// [[Common links]]
			replace(/\[\[([^|]*?)\]\](\w*)/g, f(&quot;&lt;a href='?$1'&gt;$1$2&lt;/a&gt;&quot;, InstaViewPR.conf.paths.articles)).
			
			// [[Replaced|Links]]
			replace(/\[\[(.*?)\|([^\]]+?)\]\](\w*)/g, f(&quot;&lt;a href='?$1'&gt;$2$3&lt;/a&gt;&quot;, InstaViewPR.conf.paths.articles)).
			
			// [[Stripped:Namespace|Namespace]]
			replace(/\[\[([^\]]*?:)?(.*?)( *\(.*?\))?\|\]\]/g, f(&quot;&lt;a href='?$1$2$3'&gt;$2&lt;/a&gt;&quot;, InstaViewPR.conf.paths.articles)).
			
			// External links
			replace(/\[(https?|news|ftp|mailto|gopher|irc):(\/*)([^\]]*?) (.*?)\]/g, &quot;&lt;a href='$1:$2$3'&gt;$4&lt;/a&gt;&quot;).
			replace(/\[http:\/\/(.*?)\]/g, &quot;&lt;a href='http://$1'&gt;[#]&lt;/a&gt;&quot;).
			replace(/\[(news|ftp|mailto|gopher|irc):(\/*)(.*?)\]/g, &quot;&lt;a href='$1:$2$3'&gt;$1:$2$3&lt;/a&gt;&quot;).
			replace(/(^| )(https?|news|ftp|mailto|gopher|irc):(\/*)([^ $]*)/g, &quot;$1&lt;a href='$2:$3$4'&gt;$2:$3$4&lt;/a&gt;&quot;).
			
			replace('__NOTOC__','').
			replace('__NOEDITSECTION__','');
	}
	
	function strip_inline_wiki(str)
	{
		return str
			.replace(/\[\[[^\]]*\|(.*?)\]\]/g,'$1')
			.replace(/\[\[(.*?)\]\]/g,'$1')
			.replace(/''(.*?)''/g,'$1');
	}

	for (;remain();) if ($(/^(={1,6})(.*)\1(.*)$/)) {
		p=0
		endl(f('&lt;h?&gt;?&lt;/h?&gt;?', $r[1].length, parse_inline_nowiki($r[2]), $r[1].length, $r[3]))
		
	} else if ($(/^[*#:;]/)) {
		p=0
		parse_list()
		
	} else if ($(' ')) {
		p=0
		parse_pre()
		
	} else if ($('{|')) {
		p=0
		parse_table()
		
	} else if ($(/^----+$/)) {
		p=0
		endl('&lt;hr&gt;')
		
	} else if ($(InstaViewPR.BLOCK_IMAGE)) {
		p=0
		parse_block_image()
		
	} else {
		
		// handle paragraphs
		if ($$('')) {
			if (p = (remain()&gt;1 &amp;&amp; ll[1]==(''))) endl('&lt;p&gt;&lt;br&gt;')
		} else {
			if(!p) {
				ps('&lt;p&gt;')
				p=1
			}
			ps(parse_inline_nowiki(ll[0]) + ' ')
		}
		
		sh();
	}
	
	return o
}


/*
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2-alpha Copyright (C) Paul Johnston 1999 - 2005
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

var hexcase = 0;
var b64pad  = &quot;&quot;;

function hex_md5(s)    { return rstr2hex(rstr_md5(str2rstr_utf8(s))); }
function b64_md5(s)    { return rstr2b64(rstr_md5(str2rstr_utf8(s))); }
function any_md5(s, e) { return rstr2any(rstr_md5(str2rstr_utf8(s)), e); }
function hex_hmac_md5(k, d)
  { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function b64_hmac_md5(k, d)
  { return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function any_hmac_md5(k, d, e)
  { return rstr2any(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d)), e); }

function rstr_md5(s)
{
  return binl2rstr(binl_md5(rstr2binl(s), s.length * 8));
}

function rstr_hmac_md5(key, data)
{
  var bkey = rstr2binl(key);
  if(bkey.length &gt; 16) bkey = binl_md5(bkey, key.length * 8);

  var ipad = Array(16), opad = Array(16);
  for(var i = 0; i &lt; 16; i++)
  {
    ipad[i] = bkey[i] ^ 0x36363636;
    opad[i] = bkey[i] ^ 0x5C5C5C5C;
  }

  var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
  return binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
}

function rstr2hex(input)
{
  var hex_tab = hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;
  var output = &quot;&quot;;
  var x;
  for(var i = 0; i &lt; input.length; i++)
  {
    x = input.charCodeAt(i);
    output += hex_tab.charAt((x &gt;&gt;&gt; 4) &amp; 0x0F)
           +  hex_tab.charAt( x        &amp; 0x0F);
  }
  return output;
}

function rstr2b64(input)
{
  var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;
  var output = &quot;&quot;;
  var len = input.length;
  for(var i = 0; i &lt; len; i += 3)
  {
    var triplet = (input.charCodeAt(i) &lt;&lt; 16)
                | (i + 1 &lt; len ? input.charCodeAt(i+1) &lt;&lt; 8 : 0)
                | (i + 2 &lt; len ? input.charCodeAt(i+2)      : 0);
    for(var j = 0; j &lt; 4; j++)
    {
      if(i * 8 + j * 6 &gt; input.length * 8) output += b64pad;
      else output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-j)) &amp; 0x3F);
    }
  }
  return output;
}

function rstr2any(input, encoding)
{
  var divisor = encoding.length;
  var remainders = Array();
  var i, q, x, quotient;

  var dividend = Array(input.length / 2);
  for(i = 0; i &lt; dividend.length; i++)
  {
    dividend[i] = (input.charCodeAt(i * 2) &lt;&lt; 8) | input.charCodeAt(i * 2 + 1);
  }

  while(dividend.length &gt; 0)
  {
    quotient = Array();
    x = 0;
    for(i = 0; i &lt; dividend.length; i++)
    {
      x = (x &lt;&lt; 16) + dividend[i];
      q = Math.floor(x / divisor);
      x -= q * divisor;
      if(quotient.length &gt; 0 || q &gt; 0)
        quotient[quotient.length] = q;
    }
    remainders[remainders.length] = x;
    dividend = quotient;
  }

  var output = &quot;&quot;;
  for(i = remainders.length - 1; i &gt;= 0; i--)
    output += encoding.charAt(remainders[i]);

  return output;
}

function str2rstr_utf8(input)
{
  var output = &quot;&quot;;
  var i = -1;
  var x, y;

  while(++i &lt; input.length)
  {
    x = input.charCodeAt(i);
    y = i + 1 &lt; input.length ? input.charCodeAt(i + 1) : 0;
    if(0xD800 &lt;= x &amp;&amp; x &lt;= 0xDBFF &amp;&amp; 0xDC00 &lt;= y &amp;&amp; y &lt;= 0xDFFF)
    {
      x = 0x10000 + ((x &amp; 0x03FF) &lt;&lt; 10) + (y &amp; 0x03FF);
      i++;
    }

    if(x &lt;= 0x7F)
      output += String.fromCharCode(x);
    else if(x &lt;= 0x7FF)
      output += String.fromCharCode(0xC0 | ((x &gt;&gt;&gt; 6 ) &amp; 0x1F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0xFFFF)
      output += String.fromCharCode(0xE0 | ((x &gt;&gt;&gt; 12) &amp; 0x0F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0x1FFFFF)
      output += String.fromCharCode(0xF0 | ((x &gt;&gt;&gt; 18) &amp; 0x07),
                                    0x80 | ((x &gt;&gt;&gt; 12) &amp; 0x3F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
  }
  return output;
}

function str2rstr_utf16le(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode( input.charCodeAt(i)        &amp; 0xFF,
                                  (input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF);
  return output;
}

function str2rstr_utf16be(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode((input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF,
                                   input.charCodeAt(i)        &amp; 0xFF);
  return output;
}

function rstr2binl(input)
{
  var output = Array(input.length &gt;&gt; 2);
  for(var i = 0; i &lt; output.length; i++)
    output[i] = 0;
  for(var i = 0; i &lt; input.length * 8; i += 8)
    output[i&gt;&gt;5] |= (input.charCodeAt(i / 8) &amp; 0xFF) &lt;&lt; (i%32);
  return output;
}

function binl2rstr(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length * 32; i += 8)
    output += String.fromCharCode((input[i&gt;&gt;5] &gt;&gt;&gt; (i % 32)) &amp; 0xFF);
  return output;
}

function binl_md5(x, len)
{
  x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((len) % 32);
  x[(((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14] = len;

  var a =  1732584193;
  var b = -271733879;
  var c = -1732584194;
  var d =  271733878;

  for(var i = 0; i &lt; x.length; i += 16)
  {
    var olda = a;
    var oldb = b;
    var oldc = c;
    var oldd = d;
    a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
    d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
    c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
    b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
    a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
    d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
    c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
    b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
    a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
    d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
    c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
    b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
    a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
    d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
    c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
    b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);
    a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
    d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
    c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
    b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
    a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
    d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
    c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
    b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
    a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
    d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
    c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
    b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
    a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
    d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
    c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
    b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);
    a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
    d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
    c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
    b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
    a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
    d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
    c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
    b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
    a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
    d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
    c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
    b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
    a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
    d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
    c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
    b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);
    a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
    d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
    c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
    b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
    a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
    d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
    c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
    b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
    a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
    d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
    c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
    b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
    a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
    d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
    c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
    b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);

    a = safe_add(a, olda);
    b = safe_add(b, oldb);
    c = safe_add(c, oldc);
    d = safe_add(d, oldd);
  }
  return Array(a, b, c, d);
}

function md5_cmn(q, a, b, x, s, t){
  return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b);
}
function md5_ff(a, b, c, d, x, s, t){
  return md5_cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);
}
function md5_gg(a, b, c, d, x, s, t){
  return md5_cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);
}
function md5_hh(a, b, c, d, x, s, t){
  return md5_cmn(b ^ c ^ d, a, b, x, s, t);
}
function md5_ii(a, b, c, d, x, s, t){
  return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function safe_add(x, y)
{
  var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
  var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
  return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
}

function bit_rol(num, cnt)
{
  return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));
}

// &lt;/nowiki&gt;
// ENDFILE: livepreview.js

// &lt;pre&gt; STARTFILE: mos.js
function MOS_format(){
    var qt = String.fromCharCode(34), closetag = &quot;(([^&lt;]|&lt;[^/]|&lt;/[^r]|&lt;/r[^e]|&lt;/re[^f]|&lt;/ref[^&gt;])*?)&lt;/ref&gt;&quot;, facttags = &quot;({{[ ]*fact[ ]*}}|{{[ ]*citequote[ ]*}}|{{[ ]*citation needed[ ]*}}|{{[ ]*cn[ ]*}}|{{[ ]*verification needed[ ]*}}|{{[ ]*verify source[ ]*}}|{{[ ]*GR[ ]*[\|][ ]*[^ ]+[ ]*}}|{{[ ]*[c]?r[e]?f[ ]*[\|][^}]*}}|{{[ ]*ref[ _]label[ ]*[\|][^}]*}})&quot;;
    var txt = document.editform.wpTextbox1;
    
    // *-*-*-*-*-*-*-*-*-*-*- // specifically: unitformatter.js, units_nbsp.js, and dates.js 
    // scripts from Bobblewik //
    // *-*-*-*-*-*-*-*-*-*-*- // 
    if(context_PR){
	    txt.value = txt.value
	    // century without AD,BC etc
	    .replace(/\[\[(\d{1,2}(?:st|nd|rd|th))[ \-]century\]\]/gi, '$1 century')
	    .replace(/\[\[\d{1,2}(?:st|nd|rd|th)[ \-]century\|(\d{1,2}(?:st|nd|rd|th))\]\]/gi, '$1')
	    .replace(/\[\[\d{1,2}(?:st|nd|rd|th)[ \-]century\|(\d{1,2}(?:st|nd|rd|th))[ \-]century\]\]/gi, '$1 century')
	    .replace(/\[\[\d{1,2}(?:st|nd|rd|th)[ \-]century\|(\d{1,2}(?:st|nd|rd|th))[ \-]centuries\]\]/gi, '$1 centuries')
	    // century with AD,BC etc
	    .replace(/\[\[(\d{1,2}(?:st|nd|rd|th))[ \-]century\s(AD|BC|CE|BCE)\]\]/gi, '$1 century $2')
	    .replace(/\[\[\d{1,2}(?:st|nd|rd|th)[ \-]century\|(\d{1,2}(?:st|nd|rd|th))[ \-]century\s(AD|BC|CE|BCE)\]\]/gi, '$1 century $2')
	    .replace(/\[\[\d{1,2}(?:st|nd|rd|th)[ \-]century\|(\d{1,2}(?:st|nd|rd|th))[ \-]centuries\s(AD|BC|CE|BCE)\]\]/gi, '$1 centuries $2')
	        //year:text on left, text on right
	    .replace(/([\w\(\)=:.'\*\|\&amp;]\s?,?\-?\s?)\[\[(\d{1,4})\]\](\s?,?\-?\s?[\w\(\)=:.'\*\|\&amp;])/gi, '$1$2$3')
	        //year:avoid links on left, text on right
	    .replace(/([^\]]{4})\[\[(\d{1,4})\]\](\s?,?\-?\s?[\w\(\)=:.'\*\|\&amp;])/gi, '$1$2$3')
	        //year pair: avoid links on left, text on right
	    .replace(/([^\]]{4})\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\](\s?,?\-?\s?[\w\(\)=:.'\*\|\&amp;])/gi, '$1$2$3$4$5')
	        //year:avoid links on both sides    
	    .replace(/([^\]]{4})\[\[(\d{1,4})\]\]([^\[]{4})/gi, '$1$2$3')
	    .replace(/([^\]]{4})\[\[(\d{1,4})\]\](\s?,?\-?\s?\[\[(?:[^jfmasond\d]|.[^aepuco\d\s]|..[^jfmasondbrylgptvc \s\-]))/gi, '$1$2$3')
	    //year: examine characters in link on left for date, avoid links on right
	    .replace(/((?:[^yhletramub\s]..|[^rcianlse\d\s].|[^yhletr\d])\]\]\s?,?\-?\s?)\[\[(\d{1,4})\]\]([^\[]{4})/gi, '$1$2$3')
	    .replace(/([\w\(\)=:.'\*\|\&amp;]\s?,?\-?\s?|\n)\[\[(\d{1,4})\]\]([^\[]{4}|\n)/gi, '$1$2$3')
	    .replace(/([\w\(\)=:.'\*\|\&amp;]\s?,?\-?\s?|\n)\[\[(\d{1,4})\]\]([^\[]{4}|\n)/gi, '$1$2$3');
	}
    
    txt.value = txt.value
    .replace(/(\d(?:st|nd|rd|th))[ \-]Century/gi, '$1 century')

    // piped decades and years
    .replace(/\[\[(\d{1,4}\'?s)\]\]/gi, '$1')
    .replace(/\[\[(\d{1,4}s? (?:AD|BC|CE|BCE))\]\]/gi, '$1')
    .replace(/\[\[\d{1,4}s? (?:AD|BC|CE|BCE)\|(\d{1,4})\]\]/gi, '$1')
    .replace(/\[\[\d{1,4}s? (?:AD|BC|CE|BCE)\|(\d{1,4}s? (?:AD|BC|CE|BCE))\]\]/gi, '$1')
    .replace(/\[\[\d{1,4}s?\|(\d{1,4}s? (?:AD|BC|CE|BCE))\]\]/gi, '$1')
    .replace(/\[\[\d{1,4}s?\|(\d{1,2}s?)\]\]/gi, '$1')

    // months
    .replace(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\]\]/gi, '$1')
    .replace(/\[\[January\|(Jan)\]\]/gi, '$1')
    .replace(/\[\[February\|(Feb)\]\]/gi, '$1')
    .replace(/\[\[March\|(Mar)\]\]/gi, '$1')
    .replace(/\[\[April\|(Apr)\]\]/gi, '$1')
    .replace(/\[\[May\|(May)\]\]/gi, '$1')
    .replace(/\[\[June\|(Jun)\]\]/gi, '$1')
    .replace(/\[\[July\|(Jul)\]\]/gi, '$1')
    .replace(/\[\[August\|(Aug)\]\]/gi, '$1')
    .replace(/\[\[September\|(Sep)\]\]/gi, '$1')
    .replace(/\[\[October\|(Oct)\]\]/gi, '$1')
    .replace(/\[\[November\|(Nov)\]\]/gi, '$1')
    .replace(/\[\[December\|(Dec)\]\]/gi, '$1')

    //month+year
    .replace(/\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d{3,4})\]\]/gi, '$1')
    //Month+day_number &quot;March 7th&quot; -&gt; &quot;March 7&quot;
    .replace(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December) (\d?\d)(?:th|st|nd|rd)\]\]/gi, '\[\[$1 $2\]\]')
    .replace(/\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](?:th|st|nd|rd)/gi, '\[\[$1\]\]')
    .replace(/\[\[(\d?\d)(?:th|st|nd|rd) (January|February|March|April|May|June|July|August|September|October|November|December)\]\]/gi, '\[\[$1 $2\]\]')
    //Month+day_number piped into number. Preferences do not work. They don't work in sequence because digits in the two dates must be adjacent
    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\s?\-?\s?)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with ndash or mdash instead of hyphen
    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\s?&amp;[nm]dash\s?)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with slash instead of hyphen
    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\/)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')

    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\s?\-?\s?)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with ndash instead of hyphen
    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\s?&amp;[nm]dash\s?)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with slash instead of hyphen
    .replace(/([^\[]{4})\[\[((?:January|February|March|April|May|June|July|August|September|October|November|December) \d?\d)\]\](\/)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')

    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\s?\-?\s?)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with ndash instead of hyphen
    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\s?&amp;[nm]dash\s?)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with slash instead of hyphen
    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\/)\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1$2$3$4')

    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\s?\-?\s?)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with ndash instead of hyphen
    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\s?&amp;[nm]dash\s?)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')
    //same again but with slash instead of hyphen
    .replace(/([^\[]{4})\[\[(\d?\d) (?:January|February|March|April|May|June|July|August|September|October|November|December)\]\](\/)\[\[(\d{1,2})\]\]/gi, '$1$2$3$4')

    .replace(/\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2})\]\]/gi, '$1')
    .replace(/\[\[\d{1,2} (?:January|February|March|April|May|June|July|August|September|October|November|December)\|(\d{1,2})\]\]/gi, '$1')

    .replace(/\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|((?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{1,2})\]\]/gi, '$1')

    // solitary day_numbers
    .replace(/\[\[(?:January|February|March|April|May|June|July|August|September|October|November|December) \d{1,2}\|(\d{1,2}(?:th|st|nd|rd))\]\]/gi, '$1')
    .replace(/\[\[\d{1,2} (?:January|February|March|April|May|June|July|August|September|October|November|December)\|(\d{1,2}(?:th|st|nd|rd))\]\]/gi, '$1')
    .replace(/\[\[(\d{1,2}(?:st|nd|rd|th))\]\]/gi, '$1')

    // days of the week in full. Optional plurals
    .replace(/\[\[(Mondays?|Tuesdays?|Wednesdays?|Thursdays?|Fridays?|Saturdays?|Sundays?)\]\]/gi, '$1')
    // days of the week abbreviated. Leave out 'Sun' as potentially valid link to the Sun. Leave out 'SAT' in upper case as potential link to 'Scholastic achievement/aptitude test'.
    .replace(/\[\[(Mon|Tue|Tues|Wed|Thu|Thur|Thurs|Fri)\]\]/gi, '$1')
    .replace(/\[\[(Sat)\]\]/g, '$1')
    .replace(/\[\[Mondays?\|(Mondays?)\]\]/gi, '$1')
    .replace(/\[\[Tuesdays?\|(Tuesdays?)\]\]/gi, '$1')
    .replace(/\[\[Wednesdays?\|(Wednesdays?)\]\]/gi, '$1')
    .replace(/\[\[Thursdays?\|(Thursdays?)\]\]/gi, '$1')
    .replace(/\[\[Fridays?\|(Fridays?)\]\]/gi, '$1')
    .replace(/\[\[Saturdays?\|(Saturdays?)\]\]/gi, '$1')
    .replace(/\[\[Sundays?\|(Sundays?)\]\]/gi, '$1')

    //4 digit years piped into 2
    .replace(/\[\[\d{1,4}\|(\d{1,2})\]\]/gi, '$1')

    //year pair: examine characters in link on left for date, examine characters in link on right for date
    .replace(/((?:[^yhletramub\s]..|[^rcianlse\d\s].|[^yhletr\d])\]\]\s?,?\-?\s?)\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\](\s?,?\-?\s?\[\[(?:[^jfmasond\d]|.[^aepuco\d\s]|..[^jfmasondbrylgptvc\s\-]))/gi, '$1$2$3$4$5')
    //year pair: examine characters in link on left for date, avoid links on right
    .replace(/((?:[^yhletramub\s]..|[^rcianlse\d\s].|[^yhletr\d])\]\]\s?,?\-?\s?)\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\]([^\[]{4})/gi, '$1$2$3$4$5')
    //year pair: check for line-ends, text on left, avoid links on right
    .replace(/([\w\(\)=:.'\*\|\&amp;]\s?,?\-?\s?)\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\]([^\[]{4}|\n)/gi, '$1$2$3$4$5')
    //year pair: avoid links on left, examine characters in link on right for date
    .replace(/([^\]]{4})\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\](\s?,?\-?\s?\[\[(?:[^jfmasond\d]|.[^aepuco\d\s]|..[^jfmasondbrylgptvc \s\-]))/gi, '$1$2$3$4$5')
    //year pair: avoid links on left, text on right
    .replace(/([\w\(\)=:.'\*\|\&amp;]\s?,?\-?\s?)\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\](\s?,?\-?\s?[\w\(\)=:.'\*\|\&amp;])/gi, '$1$2$3$4$5')
    //year:avoid links on left, hyphen but no digits (to avoid ISO date) in link on right. Currently suspended because it isn't fully tested.
    //year pair: avoid links on both sides
    .replace(/([^\]]{4})\[\[(\d{1,4})\]\](.?.?.?.?.?.?)\[\[(\d{1,4})\]\]([^\[]{4})/gi, '$1$2$3$4$5')
    //'present'
    .replace(/\[\[Present \(time\)\|(Present)\]\]/gi, '$1')
    //Eliminate 'surprise links' also known as 'easter egg links'
    .replace(/\[\[\d{1,4}s?\sin\s[^\|]{1,30}\|(\d{1,4}s?)\]\]/gi, '$1')
    // Convert degree symbols into ° symbol, ensure preceding space
    .replace(/&amp;deg;/g, '°')
    .replace(/º/g, '°')
    // Celsius spelling errors
    .replace(/celsius/gi, 'Celsius')
    .replace(/celcius/gi, 'Celsius')
    //Fix common naming error (be careful with this one)
    .replace(/centigrade/gi, 'Celsius')
    //Celsius
    //.replace(/\[\[(celsius)\]\]/gi, '$1')
    //.replace(/\[\[celsius\|([^\]]{1,30})\]\]/gi, '$1')
    //Fahrenheit
    //.replace(/\[\[(Fahrenheit)\]\]/gi, '$1')
    //.replace(/\[\[Fahrenheit\|([^\]]{1,30})\]\]/gi, '$1')
    //Celsius or Fahrenheit
    .replace(/°\s([CF])/g, '°$1')
    .replace(/°\s?(celsius)/gi, '°C')
    .replace(/(\d)\s?(°[CF])/g, '$1 $2')
    .replace(/deg[^\(]([CF])/gi, '°$1')
    .replace(/deg\s([CF])/gi, '°$1')
    .replace(/deg\.?\s?([CF])/gi, '°$1')
    .replace(/degrees?\s([CF])(\W)/gi, '°$1$2')
    .replace(/(\d)\s?°&amp;nbsp;([CF])/g, '$1 °$2')
    // Convert &amp;sup to superscript
    .replace(/&amp;sup2;/g, '²')
    .replace(/&amp;sup3;/g, '³')
    // Convert micro symbol to actual micro symbol, make sure it's spaced
    .replace(/(\d)\s?(&amp;mu;|µ|&amp;micro;)(g|s|m|A|K|mol|cd|rad|sr|Hz|N|J|W|Pa|lm|lx|C|V|O|F|Wb|T|H|S|Bq|Gy|Sv|kat|M)(\W)/g, '$1 µ$3$4')
    //metre
    //.replace(/\[\[(metres?)\]\]/gi, '$1')
    //.replace(/\[\[(meters?)\]\]/gi, '$1')
    //.replace(/\[\[metres?\|([^\]]{1,30})\]\]/gi, '$1')
    //space before 'm' only when lower case
    .replace(/(\d)\s?m(\W)/g, '$1 m$2')
    .replace(/(\d)\-m(\W)/g, '$1 m$2')
    .replace(/(\d)\s?sq\.?\s?m(\W)/gi, '$1 m²$2')
    .replace(/(\d)\-?sq\-?m(\W)/gi, '$1 m²$2')
    .replace(/m²\.\)/gi, 'm²)')
    // millimetre
    //.replace(/\[\[(mm)\]\]/gi, '$1')
    //.replace(/\[\[(millimetres?)\]\]/gi, '$1')
    //.replace(/\[\[(millimeters?)\]\]/gi, '$1')
    //.replace(/\[\[millimetres?\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[millimeters?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?mm(\W)/g, '$1 mm$2')
    .replace(/(\d)\-mm(\W)/g, '$1 mm$2')
    // centimetre
    //.replace(/\[\[(cm)\]\]/gi, '$1')
    //.replace(/\[\[(centimetres?)\]\]/gi, '$1')
    //.replace(/\[\[(centimeters?)\]\]/gi, '$1')
    //.replace(/\[\[centimetres?\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[centimeters?\|([^\]]{1,30})\]\]/gi, '$1')
    // kilometre
    //.replace(/\[\[(km)\]\]/gi, '$1')
    //.replace(/\[\[(kilometres?)\]\]/gi, '$1')
    //.replace(/\[\[(kilometers?)\]\]/gi, '$1')
    //.replace(/\[\[kilometres?\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[kilometers?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?kms?(\W)/gi, '$1 km$2')
    .replace(/(\d)\-kms?(\W)/gi, '$1 km$2')
    .replace(/(\d)&amp;nbsp;kms?(\W)/gi, '$1&amp;nbsp;km$2')
    //square kilometre
    //.replace(/\[\[square kilometres?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?sq\.?\s?kms?/gi, '$1 km²')
    .replace(/sq\.?\s?kms?/gi, 'km²')
    // kilometre per hour
    .replace(/km\/hr(\W)/gi, 'km/h$1')
    .replace(/kph(\W)/gi, 'km/h$1')
    .replace(/kmph(\W)/gi, 'km/h$1')
    .replace(/(\d)\s?kmh/gi, '$1 km/h')
    .replace(/km\/h/gi, 'km/h')
    .replace(/(\d)\s?km\/h/gi, '$1 km/h')
    .replace(/(\d)\-km\/h/gi, '$1 km/h')
    .replace(/(\d)&amp;nbsp;km\/h/gi, '$1&amp;nbsp;km/h')
    // cubic centimetre
    .replace(/(\d)\s?cm(\W)/gi, '$1 cm$2')
    .replace(/(\d)\s?cc(\W)/gi, '$1 cc$2')
    .replace(/(\d)\-cc(\W)/gi, '$1 cc$2')
    // millilitre
    .replace(/(\d)\s?ml(\W)/g, '$1 ml$2')
    .replace(/(\d)\-ml(\W)/g, '$1 ml$2')
    // second
    .replace(/\[\[(s)\]\]/gi, '$1')
    .replace(/\[\[(seconds?)\]\]/gi, '$1')
    .replace(/\[\[seconds?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/\/sec(\W)/gi, '/s$1')
    .replace(/\/sec\)/gi, '/s)$1')
    .replace(/(\d)\s?ft\/second/gi, '$1 ft/s')
    .replace(/(\d)\s?m\/second/gi, '$1 m/s')
    .replace(/(\d)\s?km\/sec(\W)/gi, '$1 km/s$2')
    .replace(/frames\/s(\W)/gi, 'frame/s$1')
    //minute
    .replace(/\[\[(min)\]\]/gi, '$1')
    .replace(/\[\[(minutes?)\]\]/gi, '$1')
    .replace(/\[\[minutes?\|([^\]]{1,30})\]\]/gi, '$1')
    // hour
    .replace(/\[\[(h)\]\]/gi, '$1')
    .replace(/\[\[(hours?)\]\]/gi, '$1')
    .replace(/\[\[hours?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/\/hr(\W)/gi, '/h$1')
    //day
    .replace(/\[\[(d)\]\]/gi, '$1')
    .replace(/\[\[(days?)\]\]/gi, '$1')
    .replace(/\[\[days?\|([^\]]{1,30})\]\]/gi, '$1')
    // kilogram
    .replace(/(kilogram)me/gi, '$1')
    .replace(/(\W)(gram)mes?(\W)/gi, '$1$2$3')
    //.replace(/\[\[(grams?)\]\]/gi, '$1')
    //.replace(/\[\[grams?\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[(kg)\]\]/gi, '$1')
    //.replace(/\[\[(kilograms?)\]\]/gi, '$1')
    //.replace(/\[\[kilograms?\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?kg(\W)/gi, '$1 kg$2')
    .replace(/(\d)\-kg(\W)/gi, '$1 kg$2')
    // newton metre
    //.replace(/(\W)N[-.·•\/]m(\W)/gi, '$1N·m$2')
    // kilowatt
    .replace(/(\d)\s?kW(\W)/gi, '$1 kW$2')
    .replace(/(\d)\-kW(\W)/gi, '$1 kW$2')
    // Hertz
    .replace(/(\d)\s?(G|M|k)?hz/gi, '$1 $2Hz')
    .replace(/(\d)\-(G|M|k)?hz/gi, '$1 $2Hz')
    .replace(/khz/gi, 'kHz')
    // ohm
    .replace(/(\d)\s?(Y|Z|E|P|T|G|M|k|K|h|da|d|c|m|µ|µ|µ|n|p|f|a|z|y)?\s?(&amp;Omega|ohm|Ohm)s?(\W)/g, '$1 $2O$4')
    // pound weight
    //.replace(/(\d)\s?(\[\[lbs?\]\])/gi, '$1 lb')
    //.replace(/\[\[\pound\s\(mass\)\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?lbs?/gi, '$1 lb')
    .replace(/(\d\+?)\s?lbs?/gi, '$1 lb')
    .replace(/(\d)&amp;nbsp;lbs?/gi, '$1&amp;nbsp;lb')
    .replace(/(\d)\slb.\)/gi, '$1 lb)')
    //inch
    //.replace(/\[\[(inch)\]\]/gi, '$1')
    //.replace(/\[\[(inches)\]\]/gi, '$1')
    //.replace(/\[\[inch\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[inches\|([^\]]{1,30})\]\]/gi, '$1')
    //foot
    //.replace(/\[\[foot\s\(unit\sof\slength\)\|([^\]]{1,30})\]\]/gi, '$1')
    .replace(/(\d)\s?ft(\W)/gi, '$1 ft$2')
    .replace(/(\d)\-ft(\W)/gi, '$1 ft$2')
    .replace(/(\W)ft\.\)/gi, '$1ft)')
    // square foot
    .replace(/sq\.?\s?ft(\W)/gi, 'sq ft$1')
    // foot and inch
    //.replace(/([^°h]{1,4})(\d{1,4})\s?['’]\s?(\d{1,3})\s?[&quot;”]([^NESW])/g, '$1$2 ft $3 in$4')
    .replace(/(ength[.]{1,3})(\d{1,4})\s?['’]\s?(\d{1,3})\s?[&quot;”]/gi, '$1$2 ft $3 in')
    .replace(/(idth[.]{1,3})(\d{1,4})\s?['’]\s?(\d{1,3})\s?[&quot;”]/gi, '$1$2 ft $3 in')
    .replace(/([\(\|:]\s?\d{1,4})\s?['’]\s?(\d{1,3})\s?[&quot;”]([^NESW])/g, '$1 ft $2 in$3')
    .replace(/(\d)\s?ft\s?(\d{1,3})\s?in/gi, '$1 ft $2 in')
    // yard
    .replace(/(\d)\s?yds(\W)/gi, '$1 yd$2')
    .replace(/(\d)&amp;nbsp;yds(\W)/gi, '$1&amp;nbsp;yd$2')
    .replace(/sq\.?\s?yds?/gi, 'sq yd')
    .replace(/yd\.\)/gi, 'yd)')
    // mile and mile per hour
    //.replace(/\[\[miles?\|([^\]]{1,30})\]\]/gi, '$1')
    //.replace(/\[\[(miles?)\]\]/gi, '$1')
    .replace(/m\.p\.h\.(\W)/g, 'mph$1')
    .replace(/(\W)mph(\W)/gi, '$1mph$2')
    .replace(/(\d)\s?mph/gi, '$1 mph')
    .replace(/(\d)\-mph/gi, '$1 mph')
    // square mile
    .replace(/sq\.?\s?mi/gi, 'sq mi')
    // foot pound
    .replace(/ftlbs?(\W)/gi, 'ft·lbf$1')
    .replace(/ft[ -.·•\/]lb(\W)/gi, 'ft·lbf$1')
    .replace(/ft[ -.·•\/]lbs/gi, 'ft·lbf')
    .replace(/ft[ -.·•\/]lbf/gi, 'ft·lbf')
    .replace(/ft[ -.·•\/]lbff/gi, 'ft·lbf')
    // Give digital value a percent symbol '%' instead of word
    .replace(/(\d)\s?per ?cent([^aei])/gi, '$1%$2')
    .replace(/(\d)\-per ?cent([^aei])/gi, '$1%$2')
    // knot
    .replace(/(\d)\s?kts(\W)/gi, '$1 knots$2')
    .replace(/(\d)\s?knt(\W)/gi, '$1 knots$2')
    // horsepower
    .replace(/(\d)\s?hp(\W)/gi, '$1 hp$2')
    .replace(/(\d)\s?bhp/gi, '$1 bhp')
    .replace(/(\d)\s?shp/gi, '$1 shp')
    // rpm
    .replace(/(\d)\s?rpm/gi, '$1 rpm')
    .replace(/(\d)\-rpm/gi, '$1 rpm')
    // decibel
    .replace(/(\d)\s?(dB)\b/g, '$1 $2')
    // bits per second
    .replace(/([KkMmGg])(bps|bits?\/s|b\/s)/g, '$1bit/s')
    .replace(/(\d)\s?(bps)/gi, '$1 bit/s')
    .replace(/(\d)&amp;nbsp;bps/gi, '$1&amp;nbsp;bit/s')
    .replace(/bits?\/sec(\W)/gi, 'bit/s$1')
    // bytes per second
    .replace(/([KkMmGg])(Bps|bytes?\/s)/g, ' $1B/s')
    .replace(/bytes?\/s(\W)/gi, 'B/s$1')
    // capitalization of prefix with bits and bytes
    .replace(/K(bit|B)\/s/g, 'k$1/s')
    .replace(/m(bit|B)\/s/g, 'M$1/s')
    .replace(/g(bit|B)\/s/g, 'G$1/s')
    // space with bits and bytes
    .replace(/(\d)\s?(k|M|G)(bit|B)/g, '$1 $2$3')
    // Common error with bits and bytes
    .replace(/mibi(bit|byte)/g, 'mebi$1')
    //Remove 'Easter egg' diversions (linking unit name to orders of magnitude articles)
    .replace(/\[\[1\s?_?E\s?\-?\d{1,2}\s?..?\|([^\]]{1,50})\]\]/gi, '$1')
    .replace(/\[\[Orders\sof\smagnitude\s\([^\)]{1,30}\)\|([^\]]{1,50})\]\]/gi, '$1')
     // Convert degree symbols into ° symbol, ensure preceding space
    .replace(/&amp;deg;/g, '°')
    .replace(/º/g, '°')
    .replace(/°\s?([CF])/g, '°$1')
    .replace(/°\s?(celsius)/gi, '°C')
    .replace(/(\d)\s?(°[CF])/g, '$1&amp;nbsp;$2')
    //Fix spelling errors
    .replace(/celsius/gi, 'Celsius')
    .replace(/celcius/gi, 'Celsius')
    //Fix common naming error (be careful with this one)
    .replace(/centigrade/gi, 'Celsius')
    // Convert &amp;sup into superscript ² symbol
    .replace(/&amp;sup2;/g, '²')
    .replace(/&amp;sup3;/g, '³')
    // Convert the word ohm(s) or the html entity into the actual O symbol (Omega, not the actual ohm symbol &amp;#8486) and make sure it is spaced
    .replace(/(\d)\s?(Y|Z|E|P|T|G|M|k|K|h|da|d|c|m|µ|µ|µ|n|p|f|a|z|y)?\s?(&amp;Omega|ohm|Ohm)s?([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;$2O$4')
    // Convert various micro symbols into the actual micro symbol, make sure it's spaced
    .replace(/(\d)\s?(&amp;mu;|µ|&amp;micro;)(g|s|m|A|K|mol|cd|rad|sr|Hz|N|J|W|Pa|lm|lx|C|V|O|F|Wb|T|H|S|Bq|Gy|Sv|kat|M)([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;µ$3$4')
    // Convert capital K to lowercase k in units
    .replace(/(\d)\s?K(g|s|m|A|K|mol|cd|rad|sr|Hz|N|J|W|Pa|lm|lx|C|V|O|F|Wb|T|H|S|Bq|Gy|Sv|kat|M)([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;k$2$3')
    .replace(/(\d)\-K(g|s|m|A|K|mol|cd|rad|sr|Hz|N|J|W|Pa|lm|lx|C|V|O|F|Wb|T|H|S|Bq|Gy|Sv|kat|M)([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;k$2$3')
    .replace(/(\d)&amp;nbsp;K(g|s|m|A|K|mol|cd|rad|sr|Hz|N|J|W|Pa|lm|lx|C|V|O|F|Wb|T|H|S|Bq|Gy|Sv|kat|M)([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;k$2$3')
    // Hertz
    .replace(/(\d)\s?(Y|Z|E|P|T|G|M|k|K|h|da|d|c|m|µ|µ|µ|n|p|f|a|z|y)?hz/gi, '$1&amp;nbsp;$2Hz')
    .replace(/(\d)\-(Y|Z|E|P|T|G|M|k|K|h|da|d|c|m|µ|µ|µ|n|p|f|a|z|y)?hz/gi, '$1&amp;nbsp;$2Hz')
    // Fix kilometres
    .replace(/(\d)\s?kms?([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;km$2')
    .replace(/(\d)\-kms?([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;km$2')
    .replace(/(\d)&amp;nbsp;kms?([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;km$2')
    .replace(/(\d)\s?sq\.?\s?kms?/gi, '$1&amp;nbsp;km²')
    .replace(/sq\.?\s?kms?/gi, 'km²')
    .replace(/(\d)\s?sq\.?\s?m([^i])/gi, '$1&amp;nbsp;m²$2')
    .replace(/m²\.\)/gi, 'm²)')
    // Standardise kilometres per hour
    .replace(/km\/hr/gi, 'km/h')
    .replace(/kph/gi, 'km/h')
    .replace(/kmph/gi, 'km/h')
    .replace(/(\d)\s?kmh/gi, '$1&amp;nbsp;km/h')
    .replace(/km\/h/gi, 'km/h')
    .replace(/(\d)\s?km\/h/gi, '$1&amp;nbsp;km/h')
    .replace(/(\d)\-km\/h/gi, '$1&amp;nbsp;km/h')
    .replace(/(\d)&amp;nbsp;km\/h/gi, '$1&amp;nbsp;km/h')
    // Standardise 'per second'
    .replace(/(\d)\s?ft\/second/gi, '$1&amp;nbsp;ft/s')
    .replace(/(\d)\s?ft\/sec/gi, '$1&amp;nbsp;ft/s')
    .replace(/(\d)\s?m\/second/gi, '$1&amp;nbsp;m/s')
    .replace(/(\d)\s?m\/sec/gi, '$1&amp;nbsp;m/s')
    .replace(/(\d)\s?km\/sec/gi, '$1&amp;nbsp;km/s')
    // Space before horsepower symbol
    .replace(/(\d)\s?hp/gi, '$1&amp;nbsp;hp')
    .replace(/(\d)\s?bhp/gi, '$1&amp;nbsp;bhp')
    .replace(/(\d)\s?shp/gi, '$1&amp;nbsp;shp')
    // miles per hour
    .replace(/m\.p\.h\./gi, 'mph')
    .replace(/mph([\s,.:\)\(\\/)])/gi, 'mph$1')
    .replace(/(\d)\s?mph/gi, '$1&amp;nbsp;mph')
    .replace(/(\d)\-mph/gi, '$1&amp;nbsp;mph')
    // Standardise symbol for pounds
    .replace(/(\d)\s?lbs?/gi, '$1&amp;nbsp;lb')
    .replace(/(\d\+?)\s?lbs?/gi, '$1&amp;nbsp;lb')
    .replace(/(\d)&amp;nbsp;lbs?/gi, '$1&amp;nbsp;lb')
    .replace(/(\d)\s?(\[\[lbs\]\])/gi, '$1&amp;nbsp;\[\[Pound (mass)|lb\]\]')
    // Standardise symbol for newton metres
    //.replace(/(N•m)/gi, 'N·m')
    // Standardise symbol for kilowatts
    .replace(/(\d)\s?kW([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;kW$2')
    .replace(/(\d)\-kW([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;kW$2')
    // Standardise symbol for foot pounds
    .replace(/ft[ -.·•\/]lb[fs]/gi, 'ft·lbf')
    .replace(/ft[ -.·•\/]lbf/gi, 'ft·lbf')
    .replace(/ft[ -.·•\/]lbff/gi, 'ft·lbf')
    .replace(/ft[ -.·•\/]lb\s/gi, 'ft·lbf ')
    //the next two suspended until solution is found for wing loading (i.e. pounds per square foot)
    //.replace(/lb[fs][ -.•\/]ft/gi, 'ft·lbf')
    //.replace(/lb[ -.•\/]ft/gi, 'ft·lbf')
    // Symbols for feet and inches
    .replace(/([^°][^°]\s)(\d{1,4})\s?['’]\s?(\d{1,2})\s?[&quot;”][^NESW]/g, '$1$2&amp;nbsp;ft $3&amp;nbsp;in')
    .replace(/([\(\|]\d{1,4})\s?['’]\s?(\d{1,2})\s?[&quot;”][^NESW]/g, '$1&amp;nbsp;ft $2&amp;nbsp;in')
    .replace(/(\d)\s?ft\s(\d)\s?in/gi, '$1&amp;nbsp;ft $2&amp;nbsp;in')
    .replace(/(\d)\s?feet/gi, '$1&amp;nbsp;feet')
    .replace(/(\d)\s?foot/gi, '$1&amp;nbsp;foot')
    .replace(/(\d)\s?knots/gi, '$1&amp;nbsp;knots')
    .replace(/(\d)\s?nmi/gi, '$1&amp;nbsp;nmi')
    .replace(/(\d)\s?nm/gi, '$1&amp;nbsp;nm')
    //Symbols for square feet
    .replace(/sq\.?\s?ft?/gi, 'sq ft')
    .replace(/ft\.\)/gi, 'ft)')
    // Give digital value a percent symbol '%' instead of word
    .replace(/(\d)\s?per ?cent([^aei])/gi, '$1%$2')
    .replace(/(\d)\-per ?cent([^aei])/gi, '$1%$2')
    // Add a space before dB
    .replace(/(\d)\s?(dB)\b/g, '$1&amp;nbsp;$2')
    // Add a space before several units that were missed before
    //.replace(/(\d)\s?(G|M|k|K|h|da|d|c|m|µ|n)?(g|m|Hz|N|W|Pa|V|O|F|)([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;$2$3$4')
    // bps or b/s or bits/s --&gt; bit/s
    .replace(/([KkMmGg])(bps|bits?\/s|b\/s)/g, '$1bit/s')
    .replace(/(\d)\s?(bps)/gi, '$1&amp;nbsp;bit/s')
    // Bps or byte/s or bytes/s --&gt; B/s
    .replace(/([KkMmGg])(Bps|bytes?\/s)/g, ' $1B/s')
    // Make capitalization correct
    .replace(/K(bit|B)\/s/g, 'k$1/s')
    .replace(/m(bit|B)\/s/g, 'M$1/s')
    .replace(/g(bit|B)\/s/g, 'G$1/s')
    // Ensure space is used
    .replace(/(\d)\s?(k|M|G)(bit|B)/g, '$1&amp;nbsp;$2$3')
    // Space before units
    .replace(/(\d)\s?cc([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;cc$2')
    .replace(/(\d)\-cc([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;cc$2')
    .replace(/(\d)\s?ft([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;ft$2')
    .replace(/(\d)\-ft([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;ft$2')
    .replace(/(\d)\s?rpm/gi, '$1&amp;nbsp;rpm')
    .replace(/(\d)\-rpm/gi, '$1&amp;nbsp;rpm')
    .replace(/(\d)\s?kg([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;kg$2')
    .replace(/(\d)\-kg([\s,.:\)\(\\/)])/gi, '$1&amp;nbsp;kg$2')
    //space before 'm' only when lower case
    .replace(/(\d)\s?m([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;m$2')
    .replace(/(\d)\-m([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;m$2')
    //.replace(/(\d)\s?ml([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;ml$2')
    //.replace(/(\d)\-ml([\s,.:\)\(\\/)])/g, '$1&amp;nbsp;ml$2')
    .replace(/(\d)\s?m(\W)/g, '$1&amp;nbsp;m$2')
    .replace(/(\d)\s?m(\w?\W)/g, '$1&amp;nbsp;m$2');
    
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*- // 
   // Written by myself (AndyZ), from no specific script //
   // random formatting issues from MoS                  //
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*- //   
   var cur_d = new Date(), cur_m = (cur_d.getMonth() + 1).toString(); if(cur_m.length == 1) cur_m = '0' + cur_m; //month
                            var cur_t = (cur_d.getDate()).toString(); if(cur_t.length == 1) cur_t = '0' + cur_t; //date
   var cur_accessdate = '|accessdate=' + cur_d.getFullYear() + '-' + cur_m + '-' + cur_t;
   
   txt.value = txt.value
   //MOSNUM more nbsp stuff
    .replace(/(\d)\s?(|kilo|hecto|deca|deci|centi|milli|micro|nano)(meter|metre|liter|litre|gram|byte)(s?\W])/gi, '$1&amp;nbsp;$2$3$4')
    .replace(/(\d)\s?(k|d|c|m|µ|µ|µ)(g|l|m)s?(\W)/gi, '$1&amp;nbsp;$2$3$4')
    .replace(/(\d)\s?(inche?|foot|feet|yard|mile|acre|pound|ounce|ton|gallon|quart|pint|cup|angstrom)(s?\W)/gi, '$1&amp;nbsp;$2$3')
    .replace(/(\d)\s?(lb|ft|yd|mi|oz)s?(\W)/gi, '$1&amp;nbsp;$2$3')
    
   //MOSNUM, first ones are currency fixes
    .replace(/\$US(\d)/gi, '[[United States dollar|US$]]$1')
    .replace(/(\W)EU€/gi, '$1€')
   //add leading zero to decimals
    .replace(/\s(\-?)\.(\d+)\s/g, ' $10.$2 ') 
   //times fixing
    .replace(/\s(\d\d?)\s?(a|p)m\s/gi, ' $1 $2.m. ')
    .replace(/\s(\d\d?)[\.:](\d\d)\s?(a|p)m\s/gi, ' $1:$2 $3.m. ')
    .replace(/\s12\snoon(\W)/g, ' noon$1')

   //MOSDATE remove th in dates followed by -th, others
    .replace(/([^\[])(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d\d?)th/gi, '$1[[$2 $3]]')
    .replace(/\[\[(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d\d?)\]\](&lt;sup&gt;)?th(&lt;\/sup&gt;)?/gi, '[[$1 $2]]') 
    .replace(/(\D\d\d?)(&lt;sup&gt;)?th(&lt;\/sup&gt;)?\s(January|February|March|April|May|June|July|August|September|October|November|December)/gi, '$1 $4')
    .replace(/\s(\d{4})'s(\W)/gi, ' $1s$2')
    .replace(/the\s(January|February|March|April|May|June|July|August|September|October|November|December)\sof\s(\d{4})/gi, '$1 $2')
    .replace(/(January|February|March|April|May|June|July|August|September|October|November|December)\sof\s(\d{4})/gi, '$1 $2')
    .replace(/the\s(\d\d?)th\sof\s(January|February|March|April|May|June|July|August|September|October|November|December)/gi, '$2 $1')
    .replace(/(\d\dth\s)Century/g, '$1century')
    
   //MSH to fix captalization issues in headings
    .replace(/\n(={2,3})(\s?)See\sAlso\s?={2,3}/g, '\n$1$2See also$2$1')
   	.replace(/\n(={2,3})(\s?)Further\sReading\s?={2,3}/g, '\n$1$2Further reading$2$1') 
   	.replace(/\n(={2,3})(\s?)Works\sCited\s?={2,3}/g, '\n$1$2Works cited$2$1')
    .replace(/\n(={2,3})(\s?)External\slink(s?)\s?={2,3}/g, '\n$1$2External link$3$2$1')
    .replace(/\n(={2,3})(\s?)Foot\s[Nn]otes\s?={2,3}/g, '\n$1$2Footnotes$2$1')
   //miscellaneous in headings (remove special characters)
    .replace(/\n(={2,4})(.*)\s&amp;\s(.*)={2,4}/g , '\n$1$2 and $3$1')
 
   //dashes
    .replace(/&amp;#x2012;/g, '-')
    .replace(/&amp;#(x201[45]|151|8212);/g, '&amp;mdash;')  
    .replace(/&amp;#(150|8211|x2013);/g, &quot;&amp;ndash;&quot;)
    
   //ellipses
    .replace(/\s(&amp;hellip;|…)\s/g, '&amp;nbsp;$1 ')
    .replace(/\s\.\s\.\s\.\s/g, '&amp;nbsp;.&amp;nbsp;.&amp;nbsp;. ')
    .replace(/\s\.\.\.\s/g, '&amp;nbsp;... ')

   //contractions (be careful!)
    .replace(/(could|did|do|does|had|has|have|is|might|must|should|was|were|would)n't/gi, '$1 not')
    .replace(/can't/gi, 'cannot').replace(/won't/gi, 'will not')
    .replace(/(could|might|must|should|would)'ve/gi, '$1 have')
    .replace(/(\WI|you|he|she|it|we|they|that|who|what|where|when|why|how)'ll/gi, '$1 will')  
    .replace(/(\WI|you|he|she|it|we|they|that|who|what|where|when|why|how)'d/gi, '$1 had')
  
   //expand [[WP:PDATA]], auto-fill in name blank
    .replace(/\{\{persondata\}\}/gi, '{{Persondata\n|NAME='+wgTitle.replace(/\s\(.*\)/,'').substring(wgTitle.replace(/\s\(.*\)/,'').lastIndexOf(' '),wgTitle.replace(/\s\(.*\)/,'').length) + ', ' + wgTitle.replace(/\s\(.*\)/,'').substring(0,wgTitle.replace(/\s\(.*\)/,'').lastIndexOf(' '))+'\n|ALTERNATIVE NAMES=\n|SHORT DESCRIPTION=\n|DATE OF BIRTH=\n|PLACE OF BIRTH=\n|DATE OF DEATH=\n|PLACE OF DEATH=\n}}') 
   
   //spacing, XHTML
    .replace(/&lt;([bh])r\s*\/?\s*&gt;/gi, '&lt;$1r /&gt;') 
    .replace(/&lt;(\/?)TABLE/g, '&lt;$1table')
    .replace(/&lt;(\/?)DIV/g, '&lt;$1div')
    .replace(/&lt;(\/?)SPAN/g, '&lt;$1span')

   //Template:Cite web
    //TODO: !1! DD Month instead of Month DD, !2! accessed instead of retrieved
    //take care of news
    /*convert &lt;nowiki&gt;&lt;ref&gt;s&lt;/nowiki&gt; in style:
     &lt;ref( name=)?&gt;[?url.pdf]?&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url.pdf title]&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url title (YYYY)].?&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url title]&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url]&lt;/ref&gt; (w/o brackets)
     &lt;ref( name=)?&gt;url&lt;/ref&gt; (w/o brackets)
     &lt;ref( name=)?&gt;[url title].? Retrieved on? YYYY-MM-DD.?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. [?url]?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. [url title]&lt;/ref&gt;
     &lt;ref( name=)?&gt;FIRST LAST. [?url]?&lt;/ref&gt;
     &lt;ref( name=)?&gt;FIRST LAST. [url title]&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url title] (?YYYY)?.?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST (YYYY). [url title].?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. [url title].? (?YYYY)?.?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. [url title]. retrieved on? YYYY-MM-DD.?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST (YYYY). [url title]. retrieved on? YYYY-MM-DD.?&lt;/ref&gt;        !2!
     &lt;ref( name=)?&gt;LAST, FIRST. [url title]. retrieved on? Month DD, YYYY.?&lt;/ref&gt;       !1! !2!
     &lt;ref( name=)?&gt;LAST, FIRST (YYYY). [url title]. retrieved Month DD, YYYY.?&lt;/ref&gt;    !1! !2!
     &lt;ref( name=)?&gt;LAST, FIRST (YYYY). [url title]. retrieved on Month DD, YYYY.?&lt;/ref&gt; !1! !2!
     &lt;ref( name=)?&gt;LAST, FIRST MIDDLE. [url title].?&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST MIDDLE (YYYY). [url title].?&lt;/ref&gt;
     &lt;ref( name=)?&gt;&lt;url&gt;&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. &lt;url&gt;&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. &quot;~~&quot;. &lt;url&gt;&lt;/ref&gt;
     &lt;ref( name=)?&gt;LAST, FIRST. &quot;~~&quot;. [url]&lt;/ref&gt;
     &lt;ref( name=)?&gt;[url title] (YYYY). retrieved on Month DD, YYYY.&lt;/ref&gt;
     &lt;sup&gt;[url]&lt;/sup&gt;
  to Cite web format, respectively*/
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[?(http:\/\/[^\s]+?\.pdf)\]?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=INSERT TITLE|format=PDF'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[([^\s]+?\.pdf)\s([^\]]+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3|format=PDF'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[([^\[\]]+?)\s([^\]]+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[(.+?)\s([^\]]+?)\s\(\[{0,2}(\d{4})\]{0,2}\)\]\.?\s\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3|year=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[([^\s]+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=INSERT TITLE'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(http:\/\/[^\s]+?)\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=INSERT TITLE'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(\d{4}\-\d{1,2}\-\d{1,2})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3|accessdate=$6}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s\[?([^\s]+?)\]?\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=INSERT TITLE|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s\[([^\s]+?)\s([^\]]+?)\]\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=$5|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\s(\w+)\.\s\[?([^\s]+?)\]?\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=INSERT TITLE|last=$3|first=$2'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\s(\w+)\.\s\[?(http:\/\/.+?)\s(.+?)\]?\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=$5|last=$3|first=$2'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[(.+?)\s([^\]]+?)\]\.?\s\(?\[{0,2}(\d{4})\]{0,2}\)?\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3|year=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\s\(\[{0,2}(\d{4})\]{0,2}\)\.\s\[([^\s]+?)\s([^\]]+?)\]\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|year=$4'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s\[([^\s]+?)\s([^\]]+?)\]\.?\s\(?\[{0,2}(\d{4})\]{0,2}\)?\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|year=$4'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(\d{4}\-\d{1,2}\-\d{1,2})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=$5|last=$2|first=$3|accessdate=$8}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\s\(\[{0,2}(\d{4})\]{0,2}\)\.\s\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(\d{4}\-\d{1,2}\-\d{1,2})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|accessdate=$9|year=$4}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s\[([^\s]+?)\s([^\]]+?)\][\.\,]?\sretrieved\s(on\s)?\[{0,2}(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d{1,2})\]{0,2}\,?\s\[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=$5|last=$2|first=$3|accessmonthday=[[$7 $8]]|accessyear=[[$9]]}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\s\((\d{4})\)\.\s\[([^\s]+?)\s([^\]]+?)\][\.\,]?\sretrieved\s\[{0,2}(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d{1,2})\]{0,2}\,?\s\[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|accessmonthday=[[$7 $8]]|accessyear=[[$9]]|year=$4}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\s\((\d{4})\)\.\s\[([^\s]+?)\s([^\]]+?)\][\.\,]?\sretrieved\son\s\[{0,2}(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d{1,2})\]{0,2}\,?\s\[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|accessmonthday=[[$7 $8]]|accessyear=[[$9]]|year=$4}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+\.?\s\w+)\.\s\[([^\s]+?)\s([^\]]+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=$5|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+\.?\s\w+)\s\(\[{0,2}(\d{4})\]{0,2}\)\.\s\[([^\s]+?)\s([^\]]+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$6|last=$2|first=$3|year=$4'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*&lt;(http:\/\/.+?)&gt;\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=INSERT TITLE'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s&lt;(http:\/\/.+?)&gt;\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$4|title=INSERT TITLE|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s&quot;(.+?)&quot;\.?\s&lt;(http:\/\/.+?)&gt;\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$4|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*(\w+)\,\s(\w+)\.\s&quot;(.+?)&quot;\.?\s\[(http:\/\/.+?)\]\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$5|title=$4|last=$2|first=$3'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;sup&gt;\[(http:\/\/.+?)\]&lt;\/sup&gt;/gi, '&lt;ref&gt;{{cite web|url=$1|title=INSERT TITLE'+cur_accessdate+'}}&lt;/ref&gt;')
   .replace(/&lt;ref(\sname=.+?)?&gt;\s*\[([^\s]+?)\s([^\]]+?)\]\s\(\[{0,2}(\d{4})\]{0,2}\)[\.\,]\sretrieved\s(on\s)?\[{0,2}(January|February|March|April|May|June|July|August|September|October|November|December)\s(\d{1,2})\]{0,2}\,\s\[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi, '&lt;ref$1&gt;{{cite web|url=$2|title=$3|accessmonthday=$6 $7|accessyear=$8|year=$4}}&lt;/ref&gt;')
   
   //replace &quot;|url=~~|title=INSERT TITLE&quot; with url doubled
   .replace(/\|url=(http:\/\/)(.+?)\|title=INSERT\sTITLE/g, '|url=$1$2|title=$2&lt;'+'!'+'--INSERT TITLE--'+'&gt;')
   
   //miscellaneous, minor, obvious, or not explicitly stated in style guidelines
   //replace w/ main article template, minor 
    .replace(/\{\{main\s?article\|/gi, '{{main|')  
    .replace(/\[\[User:AndyZ\/peerreviewer\.js([\]\|])/gi, '[[User:AndyZ/peerreviewer$1');
   
   //continue replacing more complex versions to Template:Cite web
    //array for converting: &lt;nowiki&gt;&lt;refs&gt;&lt;/nowiki&gt; in style: &lt;ref( name=)?&gt;[url title].? Retrieved on? [[?month DD]]?, [[?YYYY]]?.?&lt;/ref&gt; to Cite web format
    var cw_retrieval = new Array(
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Jan(uary|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Feb(ruary|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Mar(ch|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Apr(il|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(May(\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Jun(e|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Jul(y|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Aug(ust|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Sept?(ember|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Oct(ober|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Nov(ember|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi,
    /&lt;ref(\sname=.+?)?&gt;\[([^\s]+?)\s([^\]]+?)\][\.\,]?\s(retrieved|accessed|reached)\s(on\s)?\[{0,2}(Dec(ember|\.)?)\s(\d{1,2})\]{0,2}, \[{0,2}(\d{4})\]{0,2}\.?\s*&lt;\/ref&gt;/gi);
    
    for(i=0;i&lt;12;i++) txt.value = txt.value.replace(cw_retrieval[i],'&lt;ref$1&gt;{{cite web|url=$2|title=$3|accessmonthday=$6 $8|accessyear=$9}}&lt;/ref&gt;');
    
   // spell checker, based on [[WP:SPELL]]: (requires ajax) !!!
    if(!noXHR_PR){}
     
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-* // 
   // from [[Wikipedia:WikiProject User scripts/Scripts/Formatter]] //
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-* // 
    txt.value = txt.value               //whitespace
    .replace(/\t/g, &quot; &quot;)
    .replace(/^ ? ? \n/gm, &quot;\n&quot;)
    .replace(/(\n\n)\n+/g, &quot;$1&quot;)
    .replace(/== ? ?\n\n==/g, &quot;==\n==&quot;)
    .replace(/\n\n(\* ?\[?http)/g, &quot;\n$1&quot;)
    .replace(/^ ? ? \n/gm, &quot;\n&quot;)
    .replace(/\n\n\*/g, &quot;\n*&quot;)
    .replace(/[ \t][ \t]+/g, &quot; &quot;)
    .replace(/([=\n]\n)\n+/g, &quot;$1&quot;)
    .replace(/ \n/g, &quot;\n&quot;)              //ending sections 
    .replace(/(== ?)(external links:?|outside links|web ?links:?|exterior links:?)( ?==)/gi, &quot;$1External links$3&quot;)
    .replace(/(== ?)(external link:?|web ?link:?|exterior link:?)( ?==)/gi, &quot;$1External link$3&quot;)
    .replace(/(== ?)(reference:?)(s? ?==)/gi, &quot;$1Reference$3&quot;)
    .replace(/(== ?)(source:?)(s? ?==)/gi, &quot;$1Source$3&quot;)
    .replace(/(== ?)(further readings?:?)( ?==)/gi, &quot;$1Further reading$3&quot;)
    .replace(/\[\[ ?[Cc]ategory ?: ?/g, &quot;[[Category:&quot;)  //categories 
   //repair bad internal links
    .replace(/([^\[]|^)\[?\[([^\]]*?)\]\]?([^\]]|$)/gm, &quot;$1[[$2]]$3&quot;)
    .replace(/\[\[ ?([^\]]*?) ?\]\]/g, &quot;[[$1]]&quot;)
    .replace(/\[\[([^\]]*?)( |_)#([^\]]*?)\]\]/g, &quot;[[$1#$3]]&quot;)
   //repair bad external links
    .replace(/\[?\[http:\/\/([^\]]*?)\]\]?/gi, &quot;[http://$1]&quot;)
    .replace(/\[http:\/\/([^\]]*?)\|([^\]]*?)\]/gi, &quot;[http://$1 $2]&quot;)
    .replace(/\[\[([^\]\|]+)\|([^\]\|]+)\]\]([A-Za-z\'][A-Za-z]*)([\.\,\;\:\&quot;\!\?\s\n])/g, &quot;[[$1|$2$3]]$4&quot;);
    
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*- // for full documentation, see
   // FROM User:Gimmetrow/replace.js //  User:Gimmetrow/fixRefs.js
   // *-*-*-*-*-*-*-*-*-*-*-*-*-*-*- // 
    txt.value = txt.value
    .replace(new RegExp(&quot;[\n\r\f\t ]+?&quot;+facttags, &quot;gi&quot;), &quot;$1&quot;)
    .replace(new RegExp(&quot;[\n\r\f\t ]+?&lt;ref([ &gt;])&quot;, &quot;gi&quot;), &quot;&lt;ref$1&quot;)
    .replace(new RegExp(&quot;&lt;ref ([^&gt;]*[^&gt; ])[ ]*&gt;&quot;, &quot;gi&quot;), &quot;&lt;ref $1&gt;&quot;)
    .replace(new RegExp(&quot;(&lt;/ref&gt;|&lt;ref[^&gt;]*?/&gt;)&lt;sup&gt;[ ]*[,;-]?[ ]*&lt;/sup&gt;&lt;ref&quot;, &quot;gi&quot;), &quot;$1&lt;ref&quot;);
    for (var j=0; j&lt;10; j++){
      txt.value = txt.value.replace(new RegExp(&quot;([^\.,;:!\?&quot;+qt+&quot;'’])([&quot; + qt + &quot;'’]*)&quot;+facttags+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$4$3&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&quot;+facttags+&quot;[ ]*([,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$4$3&quot;)
      .replace(new RegExp(&quot;([\.,;:])([&quot; + qt + &quot;'’]*)&quot;+facttags+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$2$4$3&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&quot;+facttags+&quot;[ ]*([\.])&quot;, &quot;gi&quot;), &quot;$1$2$3&quot;)
      .replace(new RegExp(&quot;([^\.,;:!\?&quot;+qt+&quot;'’])([&quot; + qt + &quot;'’]*)&lt;ref&gt;&quot;+closetag+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$5&lt;ref&gt;$3&lt;/ref&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref&gt;&quot;+closetag+&quot;[ ]*([,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$5&lt;ref&gt;$3&lt;/ref&gt;&quot;)
      .replace(new RegExp(&quot;([\.,;:])([&quot; + qt + &quot;'’]*)&lt;ref&gt;&quot;+closetag+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$2$5&lt;ref&gt;$3&lt;/ref&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref&gt;&quot;+closetag+&quot;[ ]*([\.])&quot;, &quot;gi&quot;), &quot;$1$2&lt;ref&gt;$3&lt;/ref&gt;&quot;)
      .replace(new RegExp(&quot;([^\.,;:!\?&quot;+qt+&quot;'’])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?[^/])&gt;&quot;+closetag+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$6&lt;ref$3&gt;$4&lt;\/ref&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?[^/])&gt;&quot;+closetag+&quot;[ ]*([,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$6&lt;ref$3&gt;$4&lt;\/ref&gt;&quot;)
      .replace(new RegExp(&quot;([\.,;:])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?[^/])&gt;&quot;+closetag+&quot;[ ]*([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$2$6&lt;ref$3&gt;$4&lt;\/ref&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?[^/])&gt;&quot;+closetag+&quot;[ ]*([\.])&quot;, &quot;gi&quot;), &quot;$1$2&lt;ref$3&gt;$4&lt;\/ref&gt;&quot;)
      .replace(new RegExp(&quot;([^\.,;:!\?&quot;+qt+&quot;'’])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?)/&gt; *?([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$4&lt;ref$3/&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?)/&gt;[ ]*?([,;:!\?])&quot;, &quot;gi&quot;), &quot;$1$2$4&lt;ref$3/&gt;&quot;)
      .replace(new RegExp(&quot;([\.,;:])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?)/&gt;[ ]*?([\.,;:!\?])&quot;, &quot;gi&quot;), &quot;$2$4&lt;ref$3/&gt;&quot;)
      .replace(new RegExp(&quot;([!\?])([&quot; + qt + &quot;'’]*)&lt;ref([^&gt;]*?)/&gt;[ ]*?([\.])&quot;, &quot;gi&quot;), &quot;$1$2&lt;ref$3/&gt;&quot;);
    }
   
    var summary_txt = document.editform.wpSummary, summary = &quot;[[User:AndyZ/peerreviewer|JS]]: fixing [[WP:MOS|MoS]] and other miscellaneous style problems&quot;;
	if (summary_txt.value.indexOf(summary) == -1) {
		if (summary_txt.value.match(/[^\*\/\s][^\/\s]?\s*$/))
			summary_txt.value += &quot; | &quot;;
		summary_txt.value += summary;
	}
	
	document.getElementById('wpDiff').click();	//click &quot;View changes&quot; button
}
//&lt;/pre&gt; ENDFILE: mos.js

// *-*-*-*-*-*-*-*-*-*-*-*-*- //
// Comments and closing notes //
// *-*-*-*-*-*-*-*-*-*-*-*-*- //
// TO DO list                 //
// *-*-*-*-*-*-*-*-*-*-*-*-*- //

/* &lt;pre&gt; List of things to do:
 // Determine the usage of commas with dates                    --
 // Determine if conversions are included                       --
 //- not necessary to check - Determine if extraneous bolding is used
 //- not able to do (w/ JS): Determine if quotes have sources (due to huge amounts of &quot;&quot;s)
 //  Prove that images have proper image copyright tags
 //  Show that all fair use images have proper fair use rationales
 //- not able to do (w/ JS): Determine if sections or paragraphs are too short, outside of {{sect-stub}} or {{sectionexpand}}, etc. 
 //- not able to do (w/ JS): Determine if a list is used
 //- not able to do (w/ JS): Determine if words in headings are capitalized
 // Find common [[User:Tony1/How to satisfy Criterion 2a|redunancies]]
 //   &lt;s&gt;*&quot;in order to/for&quot; -&gt; to/for&lt;/s&gt;
 // Check w/ U:SUGG to see if any other things are missing
 // Help out with [[WP:FL]], maybe even [[WP:FPO]]?
 // simple links for easy copy+paste into sandboxes, talk pages, or [[WP:PR/A]] --
 //- not important - improving look 
 // embedding solutions beneath text, possibly (using innerHTML, etc., property) --
 // more configurable options that will be helpful to users
Second priority issues:
 // Add to/cleanup list of units (for units, conversions, and standard abbreviations)
 // Add to/subtract from list of weasel words
 // More infoboxes
*/
    /////////////////////////////////////////////////
    // Note:
    //  I am quite aware 
    //  that the layout and documentation
    //  of my coding is pretty terrible;
    //  feel free to edit this page
    //  and help clean it up
    // (for non-admins, leave note on talk page)
    // -------------- -------------- -------------- 
    // Please be aware that changes
    // may affect many users
    //  AS OF LAST COUNT: 182 users use this script
    /////////////////////////////////////////////////
//&lt;/pre&gt; [[Category:Wikipedia scripts|AndyZ/peerreviewer.js]]
//cut out code can be found at [[User:AndyZ/peerreviewer.js/comment]]
</pre><div class="printfooter">
Retrieved from "<a href="http://en.wikipedia.org../../../a/n/d/User%7EAndyZ_peerreviewer.js_782c.html">http://en.wikipedia.org../../../a/n/d/User%7EAndyZ_peerreviewer.js_782c.html</a>"</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-user"
	       class="selected"	       ><a href="../../../a/n/d/User%7EAndyZ_peerreviewer.js_782c.html">User page</a></li><li id="ca-talk"
	       	       ><a href="../../../a/n/d/User_talk%7EAndyZ_peerreviewer.js_a807.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://en.wikipedia.org/wiki/User:AndyZ/peerreviewer.js">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../images/wiki-en.png);"
	    href="../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-Main-page"><a href="../../../index.html">Main page</a></li>
	     	      <li id="n-Contents"><a href="../../../c/o/n/Wikipedia%7EContents_3181.html">Contents</a></li>
	     	      <li id="n-Featured-content"><a href="../../../f/e/a/Wikipedia%7EFeatured_content_24ba.html">Featured content</a></li>
	     	      <li id="n-currentevents"><a href="../../../c/u/r/Portal%7ECurrent_events_bb60.html">Current events</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-interaction'>
	  <h5>interaction</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-About-Wikipedia"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html">About Wikipedia</a></li>
	     	      <li id="n-portal"><a href="../../../c/o/m/Wikipedia%7ECommunity_Portal_6a3c.html">Community portal</a></li>
	     	      <li id="n-contact"><a href="../../../c/o/n/Wikipedia%7EContact_us_afd6.html">Contact us</a></li>
	     	      <li id="n-sitesupport"><a href="http://wikimediafoundation.org/wiki/Fundraising">Make a donation</a></li>
	     	      <li id="n-help"><a href="../../../c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="http://wikimediafoundation.org/"><img src="../../../images/wikimedia-button.png" border="0" alt="Wikimedia Foundation"/></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 23:25, 26 February 2007 by Wikipedia user <a href="../../../a/n/d/User%7EAndyZ_5810.html" title="User:AndyZ">AndyZ</a>. Based on work by Wikipedia user(s) <a href="../../../p/i/o/User%7EPiotrus_27db.html" title="User:Piotrus">Piotrus</a> and <a href="../../../j/o/k/User%7EJoke137_8677.html" title="User:Joke137">Joke137</a>.</li>	  <li id="f-copyright">All text is available under the terms of the <a class='internal' href="../../../t/e/x/Wikipedia%7EText_of_the_GNU_Free_Documentation_License_702a.html" title="Wikipedia:Text of the GNU Free Documentation License">GNU Free Documentation License</a>. (See <b><a class='internal' href="../../../c/o/p/Wikipedia%7ECopyrights_92c4.html" title="Wikipedia:Copyrights">Copyrights</a></b> for details.) <br /> Wikipedia&reg; is a registered trademark of the <a href="http://www.wikimediafoundation.org">Wikimedia Foundation, Inc</a>., a US-registered <a class='internal' href="../../../5/0/1/501%28c%29.html#501.28c.29.283.29" title="501(c)(3)">501(c)(3)</a> <a href="http://wikimediafoundation.org/wiki/Deductibility_of_donations">tax-deductible</a> <a class='internal' href="../../../n/o/n/Non-profit_organization.html" title="Non-profit organization">nonprofit</a> <a href="../../../c/h/a/Charitable_organization.html" title="Charitable organization">charity</a>.<br /></li>	  <li id="f-about"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html" title="Wikipedia:About">About Wikipedia</a></li>	  <li id="f-disclaimer"><a href="../../../g/e/n/Wikipedia%7EGeneral_disclaimer_3e44.html" title="Wikipedia:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
