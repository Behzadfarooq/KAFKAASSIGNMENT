<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    		<meta name="keywords" content="User:Adrian/combined.js,Bypass your cache" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikipedia (English)" />
		<link rel="copyright" href="../../../COPYING.html" />
    <title>User:Adrian/combined.js - Wikipedia, the free encyclopedia</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../skins/htmldump/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/md5.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/utf8.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/lookup.js"></script>
    <script type="text/javascript" src="../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../raw/MediaWiki%7ECommon.css";
@import "../../../raw/MediaWiki%7EMonobook.css";
@import "../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="ns-2">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">User:Adrian/combined.js</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Wikipedia, the free encyclopedia</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../a/d/r/User%7EAdrian_9077.html" title="User:Adrian">User:Adrian</a></span></div>
	    	    	    <!-- start content -->
	    <p><span id="clearyourcache"><b>Note:</b> After saving, you have to <a href="../../../b/y/p/Wikipedia%7EBypass_your_cache_1dae.html" title="Wikipedia:Bypass your cache">bypass your browser's cache</a> to see the changes. <b>Firefox/Mozilla/Safari:</b> hold down <i>Shift</i> while clicking <i>Reload</i> (or press <i>Ctrl-Shift-R</i>), <b>Internet Explorer:</b> press <i>Ctrl-F5</i>, <b>Opera/Konqueror:</b> press <i>F5</i>. 
</span>
</p><pre>/****************************************************************************
 * Built from the following scripts:
 *    module.js
 *    datetime.js
 *    msg.js
 *    util.js
 *    download.js
 *    wikiwidget.js
 *    wikins.js
 *    wikipage.js
 *    wikipageXfd.js
 *    wikiedit.js
 *    wikistate.js
 *    autoreplace.js
 *    wikiparse.js
 *    diff.js
 *    kookie.js
 *    md5.js
 *    token.js
 *    shortcuts.js
 *    diffsince.js
 *    wikiwatch.js
 *    autoedit.js
 *    nav_custom.js
 *    iframedl.js
 *    wikiimg.js
 *    drag.js
 *    overlib/overlib.js
 *    instaview.js
 *    instaviewtiny.js
 *    notes.js
 *    linkedit.js
 *    sig.js
 *    rollback.js
 *    autotag.js
 *    copyvio.js
 *    edittop.js
 *    watchlist.js
 *    watchbutton.js
 *    autofocus.js
 *    directredirect.js
 *    locz.js
 *    datez.js
 *    coorz.js
 *    imdbz.js
 *    alexafy.js
 *    userscript.js
 *    autosummary.js
 *    smartsubmit.js
 *    newmessages.js
 *    tabdiff.js
 *    tabsince.js
 *    purge.js
 *    editcount.js
 *    nav_logs.js
 *    nav_afd.js
 *    hideown.js
 *    google.js
 *    debugnote.js
 *    querysave.js
 *    extedit.js
 *    autoafd.js
 *    afd_vote.js
 *    xfdclose.js
 *    obsolete/autowarn.js
 *    redirector.js
 *    popups.js
 *    picturepopups.js
 *    instapreview.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN module.js
 ****************************************************************************/

// $Id: module.js 1179 2006-02-23 22:10:31Z quarl $

// module.js - dependency tracking

// quarl 2006-02-07 initial version

var $module = new Object();

// can be a URL prefix or a [[User:Wikipedia prefix]]
$module.options = {
    // auto_load: &quot;http://wikipedia.quarl.org/scripts/&quot;
    auto_load: null
};

var Module = $module.Module = function(name) {
    if (!(this instanceof $module.Module)) {
        return new $module.Module(name, params);
    }

    if (typeof(name) != 'string') {
        alert(&quot;$module.Module: need name (error 7e05c98d-b55c-4e1f-a48a-170d7bcb63a8)&quot;);
        return void(0);
    }

    this.module = { name: name };
    $module.provide(this.module.name, this);
    return this;
}

$module.Module.prototype.depend = function() {
    var l;
    for (var i = 0; i &lt; arguments.length; ++i) {
        if (!(l=$module.depend1(arguments[i], this))) return null;
    }
    return l;
}

$module.Module.prototype.inherit = function(parent) {
    // allow string name of parent, because the module might not yet be loaded
    // at this point
    var parent0 = parent;
    if (typeof(parent) == 'string') {
        parent = window[parent];
    }
    if (!parent) {
        alert($module.msgpfx(child) + &quot;Can't inherit from &quot; + parent0);
        return;
    }
    for (var v in parent) {
        if (v == 'module') continue;
        if (typeof(this[v]) == 'undefined') child[v] = parent[v];
    }
}

$module.Module.prototype.alert = function(msg) {
    window.alert(this.module.name + ': ' + msg);
}

// requires msg.js
$module.Module.prototype.error = function(msg) {
    return $msg.error('(' + this.module.name + ') ' + msg);
}

// requires msg.js
$module.Module.prototype.warning = function(msg) {
    return msg.warning('(' + this.module.name + ') ' + msg);
}

// requires msg.js
$module.Module.prototype.debug = function(msg) {
    return $msg.debug('(' + this.module.name + ') ' + msg);
}

$module.modules = {};

$module.provide = function(s, t) {
    $module.modules[s] = (t || 1);
}

$module.msgpfx = function(t) {
    return (t &amp;&amp; t.module &amp;&amp; t.module.name) ? (&quot;$module (&quot; + t.module.name + &quot;): &quot;) : &quot;$module: &quot;;
}

$module.depend = function() {
    var l;
    for (var i = 0; i &lt; arguments.length; ++i) {
        if (!(l=$module.depend1(arguments[i], null))) return null;
    }
    return l;
}

$module.depend1 = function(s, t) {
    var m = $module.modules[s];
    if (!m) {
        if ($module.options.auto_load) {
            $module.loadScript($module._makeScriptUrl(s));

            m = $module.modules[s];
            if (!m) {
                alert($module.msgpfx(t) + &quot;Error loading module '&quot;+s+&quot;'&quot;);
                return false;
            }
        } else {
            if (!$module.options.auto_load &amp;&amp; s.match(/[.]css$/)) {
                // XXX TODO: check document.styleSheets
                return;
            }
            alert($module.msgpfx(t) + &quot;Error, depends on '&quot;+s+&quot;', but not yet loaded (error 05ceb474-86ec-49ac-833f-89a5d77130bc)&quot;);
        }
    }
    return m;
}

$module.loadScript = function(s) {
    if (s.match(/[.]js$/)) {
        document.write('&lt;scr'+'ipt type=&quot;text/javascript&quot; src=&quot;' +s+ '&lt;/scr'+'ipt&gt;');
    } else if (s.match(/[.]css$/)) {
        document.write('&lt;sty'+'le type=&quot;text/css&quot;&gt;' + s + '&quot;;&lt;/st'+'yle&gt;');
        // TODO: use document.styleSheets; test with .href
        $module.modules[s] = 1;
    } else {
        alert(&quot;$module.loadScript: unknown type (error 32326eb9-095b-4f21-ba23-1bda4d6091fe)&quot;);
    }
}

$module._makeScriptUrl = function(t, ns) {
    ns = ns || $module.options.auto_load;
    if (ns.match(/^(http|ftp):/)) {
        return ns + '/' + t;
    } else if (ns.match(/^\[\[(.*)\]\]$/)) {
        var page = RegExp.$1 + '/' + t;
        if (ns.match(/[.]js$/)) {
            return ('/w/index.php?title=' + page +
                    '&amp;action=raw&amp;ctype=text/javascript&amp;dontcountme=s');
        } else if (ns.match(/[.]css$/)) {
            return ('/w/index.php?title=' + page +
                    '&amp;action=raw&amp;ctype=text/css&amp;dontcountme=s');
        } else {
            return ('/w/index.php?title=' + page);
        }
    } else {
        alert(&quot;Unknown value for ns (error 01b7cf1a-f746-4c93-8992-b0542a2f54c3)&quot;);
        return null;
    }
}

/****************************************************************************
 * END module.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN datetime.js
 ****************************************************************************/

// $Id: datetime.js 1236 2006-02-24 11:35:23Z quarl $

// datetime.js - date/time utility functions

var $datetime = new Module('datetime.js');

// return N days ago (default today)
$datetime.previousDay = function(days) {
    days = days || 0;
    var d = new Date();
    d.setDate(d.getDate() - days); // automatically wraps as necessary
    return d;
}

$datetime.L2 = function(x) {
    if (x &lt; 0) return &quot;&quot;+x;
    if (x &lt; 10) return &quot;0&quot;+x;
    return &quot;&quot;+x;
}

$datetime.L3 = function(x) {
    if (x &lt; 0) return &quot;&quot;+x;
    if (x &lt; 10) return &quot;00&quot;+x;
    if (x &lt; 100) return &quot;0&quot;+x;
    return &quot;&quot;+x;
}

$datetime.datestampUTCISO = function(d) {
    d = d || new Date();
    return (&quot;&quot; +
            d.getUTCFullYear() + '-' +
            $datetime.L2(d.getUTCMonth()+1) + '-' +
            $datetime.L2(d.getUTCDate()));
}

$datetime.timestampUTCISO = function(d) {
    d = d || new Date();
    return ($datetime.L2(d.getUTCHours()) + ':' +
            $datetime.L2(d.getUTCMinutes()));
}

$datetime.logtimestamp = function(d) {
    d = d || new Date();

    return ($datetime.L2(d.getHours()) + ':' +
            $datetime.L2(d.getMinutes()) + ':' +
            $datetime.L2(d.getSeconds()) + '.' +
            $datetime.L3(d.getTime() % 100));
}

$datetime.monthnames = [
    &quot;January&quot;, &quot;February&quot;, &quot;March&quot;, &quot;April&quot;, &quot;May&quot;, &quot;June&quot;,
    &quot;July&quot;, &quot;August&quot;, &quot;September&quot;, &quot;October&quot;, &quot;November&quot;, &quot;December&quot; ];

$datetime.datestampYYYYMonthD = function(d) {
    d = d || new Date();
    return (&quot;&quot; +
            d.getUTCFullYear() + ' ' +
            $datetime.monthnames[d.getUTCMonth()] + ' ' +
            d.getUTCDate());
}

$datetime.datestampMonthYYYY = function(d) {
    d = d || new Date();
    return (&quot;&quot; +
            $datetime.monthnames[d.getUTCMonth()] + ' ' +
            d.getUTCFullYear());
}

// from Lupin's popups
$datetime.formatAge = function(age) {
    var addunit = function(num,str) {
        return '' + num + ' ' + str + ((num!=1) ? 's' : '') ;
    }

    // coerce into a number
    age = 0 + age;
    var a = age;

    var seclen   = 1000;
    var minlen   = 60*seclen;
    var hourlen  = 60*minlen;
    var daylen   = 24*hourlen;
    var weeklen  = 7*daylen;

    var numweeks = (a-a%weeklen)/weeklen; a = a-numweeks*weeklen; var sweeks = addunit(numweeks, 'week');
    var numdays  = (a-a%daylen)/daylen;   a = a-numdays*daylen;   var sdays  = addunit(numdays,  'day');
    var numhours = (a-a%hourlen)/hourlen; a = a-numhours*hourlen; var shours = addunit(numhours, 'hour');
    var nummins  = (a-a%minlen)/minlen;   a = a-nummins*minlen;   var smins  = addunit(nummins,  'minute');
    var numsecs  = (a-a%seclen)/seclen;   a = a-numsecs*seclen;   var ssecs  = addunit(numsecs,  'second');

    if (age &gt; 4*weeklen) { return sweeks; }
    if (age &gt; weeklen)   { return sweeks + ' ' + sdays; }
    if (age &gt; daylen)    { return sdays  + ' ' + shours; }
    if (age &gt; 6*hourlen) { return shours; }
    if (age &gt; hourlen)   { return shours + ' ' + smins; }
    if (age &gt; 10*minlen) { return smins; }
    if (age &gt; minlen)    { return smins  + ' ' + ssecs; }
    return ssecs;
}

/****************************************************************************
 * END datetime.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN msg.js
 ****************************************************************************/

// $Id: msg.js 1188 2006-02-23 22:23:09Z quarl $

// error, warning, debug functions

// quarl 2006-02-20 initial version

var $msg = new Module('msg.js');
$msg.depend('msg.css');
$msg.depend('datetime.js');

$msg.options = {
    debuglogsize: 500
};

$msg.error = function(msg) {
    alert(msg);
    // dummy try/catch to automatically interrupt if running under debugger
    // (kind of like a built-in breakpoint)
    try { throw 0; } catch(e) {};
    return void(0);
}

$msg.warning = function(msg) {
    alert(msg);
    return void(0);
}

$msg.debuglog = [];
$msg.debug = function(msg) {
    msg = '[' + $datetime.logtimestamp() + '] ' + msg;

    $msg.debuglog.push(msg);

    // if it's way over budget, delete until we're at budget
    if ($msg.debuglog.length &gt; $msg.options.debuglogsize * 1.5) {
        $msg.debuglog.splice(0, $msg.debuglog.length-$msg.options.debuglogsize);
    }
}

$msg.debug(&quot;-- Initializing Wikipedia Power Toolkit --&quot;);

/****************************************************************************
 * END msg.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN util.js
 ****************************************************************************/

// $Id: util.js 1224 2006-02-24 10:40:00Z quarl $

// util.js - miscellaneous utility functions for Wikipedia user scripts

// quarl 2006-01-09 initial version

// NON-NAMESPACED FUNCTION NAMES ARE DEPRECATED

var $util = new Module('util.js');
$util.depend('msg.js');

/////////////////////////////////////////////////////////////
// MISCELLANEOUS FUNCTIONS

// $util.defineClass = function(constructor, functions) {
//     var c = constructor;
//     c.prototype = functions;
//     return c;
// }

$util.merge = function(o, params) {
    if (!params) return o;
    for (var p in params) {
        o[p] = params[p];
    }
    return o;
}

$util.copyArray = function(a, i) {
    var r = [];
    i = i || 0;
    for (; i &lt; a.length; i++) {
        r.push(a[i]);
    }
    return r;
}

$util.assocArray = function(x) {
    for (var i in x) {
        x[ x[i] ] = 1;
    }
    return x;
}

// flatten an array
$util.flatten = function(list, start) {
    var ret=[];
    if (typeof start == 'undefined') start=0;
    for (var i=start; i&lt;list.length; ++i) {
        if (typeof list[i] == typeof []) {
            return ret.concat($util.flatten(list[i])).concat($util.flatten(list, i+1));
        }
        else ret.push(list[i]);
    }
    return ret;
};

$util.bindThis = function(this_, method) {
    return function() { return method.apply(this_, arguments); };
}

$util.callHooks = function(callbacks) {
    var args = $util.copyArray(arguments, 1);
    for (var i in callbacks) {
        var callback = callbacks[i];
        callback.apply(callback, args);
    }
}

$util.hookEventObj = function(obj, hookName, hookFunct) {
    if (!obj) return;

    if (obj.addEventListener)
        obj.addEventListener(hookName, hookFunct, false);
    else if (obj.attachEvent)
        obj.attachEvent(&quot;on&quot; + hookName, hookFunct);
}

// wikibits.js:addOnloadHook does almost exactly what we want.  Its primary
// feature is it runs at the end of loading rather than after loading, so the
// user does not see the page before running the hooks.
//
// The disadvantage is its buggy behavior if any of the hooks thrown an
// exception: the entire list of hooks is re-run, producing poor results like
// multiple tabs.

$util._onloadFunctions = [];

$util._runOnloadHooks = function() {
    if ($util._onloadFunctions == null) return;
    // Using a while loop in this manner ensures that if we queue up more
    // hooks during _runOnloadHooks, they get queued at the end, and also if
    // we raise an exception for some reason, we don't re-run the entire list.
    while ($util._onloadFunctions.length) {
        try {
            $util._onloadFunctions[0] ();
        } catch(e) {
            var s = $util._onloadFunctions[0].toString();
            $util.error(&quot;_runOnloadHooks: Error in onload hook '&quot;+$util.strAbbrev(s,297)+&quot;': &quot; + e);
        }
        $util._onloadFunctions.shift();
    }
    $util._onloadFunctions = null;
}

// This is more robust than wikibits.js's addOnloadHook.  That version uses an
// array of fuctions; if there is an error, the hook functions sometimes get
// re-run.
$util.addOnloadHook = function(f) {
    if (!f) {
        alert(&quot;$util.addOnloadHook: no function given! (error 0a0fb885-97fb-4089-b7c5-90f0be7d5abc)&quot;);
        return;
    }

    if ($util._onloadFunctions == null) {
        // we've already finished _runOnloadHooks, so just run f now.
        // TODO: any advantage to doing setTimeout(f, 0) here?
        f();
    } else {
        $util._onloadFunctions.push(f);
        // $util.hookEventObj(window, &quot;load&quot;, f);
    }

    // setTimeout is NOT a good alternative to addEventListener.  The reason
    // is that timeout functions are called too soon: since the &lt;script&gt; tag
    // is before the main body content, we don't yet see that content at time
    // of setTimeout.

    // setTimeout(f, 0);
};

// use wikibits.js's onload hook system to invoke ours.
addOnloadHook($util._runOnloadHooks);

$util.addOnunloadHook = function(f) {
    $util.hookEventObj(window, 'unload', f);
}

// conditional func eval
$util.funkyval = function(x) {
    if (typeof(x) == 'function') {
        x = x();
    }
    return x;
}

/////////////////////////////////////////////////////////////
// STRING UTILITY FUNCTIONS

$util.trimSpaces = function(s) {
    if (!s) return s;
    s = s.replace(/^\s+/,'');
    s = s.replace(/\s+$/,'');
    return s;
}

$util.trimLines = function(s) {
    return s.replace(/^\n+/, '').replace(/\n+$/, '');
}

$util.removeAnchor = function(s) {
    return s.replace(/(?:#|%23).*/, '');
}

$util.reverseString = function(s) {
    var ret = '';
    for (var i = s.length-1; i &gt;= 0; --i) {
        ret += s[i];
    }
    return ret;
}

$util.strAbbrev = function(s, n) {
    if (!s) return s;
    if (s.length &lt;= n) return s;
    return s.substr(0, n-3) + '...';
}

$util.wordCount = function(t) {
    return t.split(/\s+/).length;
}

$util.stringQuoteEscape = function(str) {
    if (!str) return str;
    return &quot;'&quot; + str.replace(/\'/g, '\\\'').replace(/\%27/g, '\\\'') + &quot;'&quot;;
}

$util.reEscape = function(str) {
    return str.replace(RegExp('([-.()\\+?*^${}\\[\\]])', 'g'), '\\$1');
};

// wiki article name escaping
$util.wpaEscape = function(s) {
    // encodeURIComponent is better than 'escape' for unicode chars;
    // it also escapes '+'.
    // Don't escape ':'
    return encodeURIComponent(s.replace(/ /g,'_')).replace(/%3A/g,':').replace(/%2F/g,'/');
}

$util.wpaDecode = function(s) {
    return decodeURIComponent(s).replace(/_/g,' ');
}

// from Scriptaculous
$util.escapeHTML = function() {
    var div = document.createElement('div');
    var text = document.createTextNode(this);
    div.appendChild(text);
    return div.innerHTML;
};

// from Scriptaculous
$util.unescapeHTML = function() {
    var div = document.createElement('div');
    div.innerHTML = this.stripTags();
    return div.childNodes[0] ? div.childNodes[0].nodeValue : '';
};

$util.urlGetPath = function(s) {
    return s.replace(/^http:\/\/[^\/]+/, '');
}

// from Lupin's popups:
// String.prototype.parenSplit should do what ECMAscript says
// String.prototype.split does, interspersing paren matches between
// the split elements

if (String('abc'.split(/(b)/))!='a,b,c') {
    // broken String.split, e.g. konq, IE
    String.prototype.parenSplit=function (re) {
        var m=re.exec(this);
        if (!m) return [this];
        // without the following loop, we have
        // 'ab'.parenSplit(/a|(b)/) != 'ab'.split(/a|(b)/)
        for(var i=0; i&lt;m.length; ++i) {
            if (typeof m[i]=='undefined') m[i]='';
        }
        return [this.substring(0,m.index)]
        .concat(m.slice(1))
        .concat(this.substring(m.index+m[0].length).parenSplit(re));
    };
} else {
    String.prototype.parenSplit=function (re) {return this.split(re);};
}

// e.g. $util.printf(&quot;%s, my name is %s&quot;, &quot;Hello&quot;, &quot;Quarl&quot;)
//                =&gt; &quot;Hello, my name is Quarl&quot;
$util.printf = function(fmt) {
    var r = '';
    var s = fmt.split('%s');
    for (var i = 1; i &lt; s.length; ++i) {
        r += s[i-1];
        r += (i &lt; arguments.length) ? arguments[i] : '%s';
    }
    r += s[s.length-1];
    return r;
};

// e.g. $util.printf(&quot;$1, my name is $2&quot;, &quot;Hello&quot;, &quot;Quarl&quot;)
//                =&gt; &quot;Hello, my name is Quarl&quot;
$util.pprintf = function(fmt) {
    // start at last argument in case we have more than 9 arguments
    for (var i = arguments.length; i &gt;= 1; --i) {
        fmt = fmt.replace(new RegExp('\\$' + i,'g'), arguments[i]);
    }
    return fmt;
};

$util.capitalizeFirstChar = function(s) {
    if (!s) return s;
    return s[0].toUpperCase() + s.substr(1);
};

$util.describeCharCount = function(s) {
    if (s == null) return '(null)';
    return &quot;[&quot; + s.length + &quot; chars]&quot;;
}

// replaces all occurrences of RE with REPL, returning {str:str, count:count}
$util.reReplaceAll = function(str, re, repl)
{
    re = new RegExp(re);
    var m;
    var result = '';
    var count = 0;
    while ( (m=str.match(re)) ) {
        str = RegExp.rightContext;
        result += RegExp.leftContext;
        result += m[0].replace(re, repl);
        ++count;
    }
    result += str;
    return { str: result, count: count };
};

////////////////////////////////////////////////////////////
// DOM UTILITY FUNCTIONS
$util.getElementsByClass = function(searchClass, node, tag) {
    var classElements = [];
    if (node == null)
        node = document;
    if (tag == null)
        tag = '*';
    var els = node.getElementsByTagName(tag);
    var elsLen = els.length;
    var pattern = new RegExp(&quot;(^|\\s)&quot;+searchClass+&quot;(\\s|$)&quot;);
    for (var i = 0; i &lt; elsLen; i++) {
        if (pattern.test(els[i].className) ) {
            classElements.push(els[i]);
        }
    }
    return classElements;
}

$util.findDescendantById = function(node, id) {
    if (node.id == id) { return node; }
    for (var i = node.firstChild; i != null; i=i.nextSibling) {
        var c = $util.findDescendantById(i,id);
        if (c != null)
            return c;
    }
    return null;
}

$util.isDescendent = function(node, ancestorNode, cachePropertyName) {
    if (typeof node[cachePropertyName] != 'undefined') {
        return node[cachePropertyName];
    }

    if (node == ancestorNode) {
        return node[cachePropertyName] = true;
    }

    if (!node.parentNode) {
        return node[cachePropertyName] = false;
    }

    return node[cachePropertyName] = $util.isDescendent(
        node.parentNode, ancestorNode, cachePropertyName);
};


$util.addClass = function(node, cls) {
    node.className += ' '+cls;
}

$util.removeClass = function(node, cls) {
    node.className = node.className.replace(
        new RegExp(&quot;(^|\\s)&quot;+cls+&quot;(\\s|$)&quot;,'g'), ' ');
}

$util.addNodeBefore = function(node, newnode) {
    node.parentNode.insertBefore(newnode, node);
    return newnode;
}

$util.addNodeAfter = function(node, newnode) {
    if (node.nextSibling) {
        node.parentNode.insertBefore(newnode, node.nextSibling);
    } else {
        node.parentNode.appendChild(newnode);
    }
    return newnode;
}

// return nodes in [node_start, node_end)
$util.getNodesInRange = function(node_start, node_end) {
    var nodes = [];
    while (node_start != node_end) {
        nodes.push(node_start);
        node_start = node_start.nextSibling;
        if (!node_start) return null; // didn't reach node_end!
    }
    return nodes;
}

$util.removeNodesInRange = function(node_start, node_end) {
    if (!node_end) {
        alert(&quot;## removeNodesInRange: node_end==null&quot;);
        return null;
    }
    if (!$util.getNodesInRange(node_start, node_end)) {
        alert(&quot;## removeNodesInRange: range does not terminate&quot;);
        return null;
    }
    var parent = node_start.parentNode;
    var count = 0;
    while (node_start != node_end) {
        ++count;
        var n = node_start.nextSibling; // save before it gets clobbered
        parent.removeChild(node_start);
        node_start = n;
        if (!node_start) return null;
    }
    return count;
}

$util.createHref = function(href, title, inner) {
    var a = document.createElement('a');
    a.href = href;
    a.title = title;
    a.innerHTML = inner;
    return a;
}

$util.findHref = function(href) {
    href = $util.wpaEscape($util.wpaDecode(href));
    var links=document.links;
    for(i=0;i&lt;links.length;++i) {
        // unescape and reescape to ensure canonical escaping
        if ($util.wpaEscape($util.wpaDecode(links[i].href)) == href) return links[i];
    }
    return null;
}

// insert a new node as parent of node
$util.insertNode = function(node, newNode) {
    if (!node) return null;

    node.parentNode.replaceChild(newNode, node);
    newNode.appendChild(node);
    return newNode;
}

$util.appendChildren = function(node, newNodes) {
    for (var i in newNodes) {
        node.appendChild(newNodes[i]);
    }
}

// add a span around a node if there isn't one.
$util.ensureSpan = function(node) {
    if (node.parentNode.nodeName == 'SPAN') {
        return node.parentNode;
    }
    return $util.insertNode(node, document.createElement('span'));
}

////////////////////////////////////////////////////////////
// STYLESHEET FUNCTIONS
$util.addStylesheetRule = function(tag, style) {
    var ss = document.styleSheets[0];
    if (ss.insertRule) {
        ss.insertRule(tag + '{' + style + '}', ss.cssRules.length);
    } else if (ss.addRule) {
        ss.addRule(tag, style);
    }
}

////////////////////////////////////////////////////////////
// AJAX FUNCTIONS

// cross-platform
$util.HTTPClient = function() {
    var http;
    if(window.XMLHttpRequest) {
        http = new XMLHttpRequest();
    } else if (window.ActiveXObject) {
        try {
            http = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
        } catch (e) {
            try {
                http = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
            } catch (E) {
                http = false;
            }
        }
    }
    return http;
}

$util.asyncDownloadXML = function(url, callback, props) {
    var req = $util.HTTPClient();
    if (!req) return null;
    // add optional arguments
    if (props) {
        for (var k in props) {
            req[k] = props[k];
        }
    }

    var args = $util.copyArray(arguments, 2);

    req.open(&quot;GET&quot;, url, true);
    // TODO: another way to parse XML is to create a div and then set its
    // innerHTML to the responseText -- this may be more reliable than
    // overrideMimeType.
    req.overrideMimeType('text/xml');
    // using onload instead of onreadystatechange allows multiple asynchronous requests
    // TODO: since we now have access to 'req' as a variable, we could change back.
    // Is there any advantage to using onreadystatechange?
    req.onload = function(event) {
        var req = event.target;
        args[0] = req;
        if (req.readyState == 4) callback.apply(event, args);
    };
    req.send(null);
    return req;
}

// doesn't try to parse as XML
$util.asyncDownloadText = function(url, callback, props) {
    var req = $util.HTTPClient();
    if (!req) return null;
    // add optional arguments
    if (props) {
        for (var k in props) {
            req[k] = props[k];
        }
    }

    var args = $util.copyArray(arguments, 2);

    req.open(&quot;GET&quot;, url, true);
    req.overrideMimeType('text/plain');
    req.onload = function(event) {
        var req = event.target;
        args[0] = req;
        if (req.readyState == 4) callback.apply(event, args);
    };
    req.send(null);
    return req;
}

$util.buildParams = function(paramArray) {
    var params = '';
    for (k in paramArray) {
        v = paramArray[k];
        // if v is a Boolean then the form was a checkbox.
        // unchecked checkboxes should not add any input fields.
        if (v == false) continue;
        if (v == true) v = 'on';
        params += '&amp;' + k + '=' + encodeURIComponent(v);
    }
    params = params.replace(/^&amp;/,'');
    return params;
}

$util.addFormHiddenParams = function(newform, d) {
    for (var k in d) {
        v = d[k];
        // if v is a Boolean then the form was a checkbox.
        // unchecked checkboxes should not add any input fields.
        if (v == false) continue;
        if (v == true) v = 'on';
        var t = document.createElement('input');
        t.type = 'hidden';
        t.name = k;
        t.value = d[k];
        newform.appendChild(t);
    }
    return newform;
}

$util.asyncPostXML = function(url, parameters, callback, props) {
    var req = $util.HTTPClient();
    if (!req) return null;
    if (typeof parameters != 'string') parameters = $util.buildParams(parameters);
    // add optional arguments
    if (props) {
        for (var k in props) {
            req[k] = props[k];
        }
    }

    var args = $util.copyArray(arguments, 2);

    req.open(&quot;POST&quot;, url, true);
    req.overrideMimeType('text/xml');
    req.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;);
    req.setRequestHeader(&quot;Content-length&quot;, parameters.length);
    req.setRequestHeader(&quot;Connection&quot;, &quot;close&quot;);
    req.onload = function(event) {
        var req = event.target;
        args[0] = req;
        if (req.readyState == 4) callback.apply(event, args);
    };
    req.send(parameters);
    return req;
}

// Temporarily replace the content of statusNode with a non-clicakble, bolded string
// that shows we're doing something.  statusNode should be the node that completely wraps
// an &lt;a&gt; element that was just clicked (e.g. a &lt;span&gt;)
$util.buttonShowStatus = function(statusNode, statusText) {
    if (!statusNode) return;

    if (!statusText) {
        // use &lt;a&gt; tag to keep padding/margin/color/etc.
        statusText = '&lt;a&gt;&lt;b&gt;'+statusNode.textContent+'...&lt;/b&gt;&lt;/a&gt;';
    }

    // Note: saving innerHTML doesn't work if we've messed with the document
    // tree.

    // statusNode.savedContent = statusNode.innerHTML;
    // statusNode.innerHTML = statusText;

    // save content (but don't clobber it if we're called again before buttonRestoreStatus)
    if (!statusNode.savedContent) {
        statusNode.savedContent = $util.copyArray(statusNode.childNodes);
    }
    statusNode.innerHTML = statusText;
}

$util.buttonRestoreStatus = function(statusNode, tempStatusText) {
    if (tempStatusText) {
        // temporarily show a string indicating success, and after a while, reset.
        $util.buttonShowStatus(statusNode, tempStatusText);
        setTimeout(function() { $util.buttonRestoreStatus(statusNode); }, 10000);
        return;
    }

    if (statusNode &amp;&amp; statusNode.savedContent) {
        // statusNode.innerHTML = statusNode.savedContent;
        statusNode.innerHTML = '';
        $util.appendChildren(statusNode, statusNode.savedContent);
    }
}

////////////////////////////////////////////////////////////
// UI FUNCTIONS

$util.eventLeftButtonP = function(e) {
    if (typeof(e.which) != 'undefined') return e.which == 1;    // Mozilla
    if (typeof(e.button) != 'undefined') return (e.button | 1); // IE
    return null;
}

/****************************************************************************
 * END util.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN download.js
 ****************************************************************************/

// $Id: download.js 1142 2006-02-23 09:25:47Z quarl $

var $download = new Module('download.js');
$download.depend('util.js');

$download._completed = {};
$download._inProgress = {};

// calls callback({ url: url, data: data, lastModified: lastModified})
// on error, data==null
$download.downloadUrl = function(url, callback)
{
    if ($download._completed[url]) {
        $download.debug(&quot;downloadUrl (cached) &quot; + url);
        callback($download._completed[url]);
        return;
    } else if ($download._inProgress[url]) {
        $download.debug(&quot;downloadUrl (already in progress) &quot; + url);
        $download._inProgress[url].callbacks.push(callback);
        return;
    } else {
        $download.debug(&quot;downloadUrl (initiating async) &quot; + url);
        var dl = $download._inProgress[url] = { url: url, callbacks: [callback] };
        var cb = function(req) {
            if (typeof window.$download == 'undefined') return; // unloaded

            if (req.status == 200) {
                $download.debug(&quot;downloadUrl: successful download of &quot; + url);
                dl.data = req.responseText;
                var lm = req.getResponseHeader('Last-Modified');
                dl.lastModified = lm &amp;&amp; new Date(lm);
            } else {
                $download.debug(&quot;downloadUrl: failed to download &quot; + url);
                dl.data = null;
                dl.lastModified = null;
            }
            callbacks = dl.callbacks;
            delete dl.callbacks;
            delete dl.req;
            delete $download._inProgress[url];
            $download._completed[url] = dl;
            $util.callHooks(callbacks, dl);
        };

        dl.req = $util.asyncDownloadText(url, cb);
    }
}

$download.abortAllDownloads = function() {
    for (var url in $download._inProgress)
    {
        var dl = $download._inProgress[url];
        dl.req.abort();
    }
    $download._inProgress = {};
};

$util.addOnunloadHook($download.abortAllDownloads);

/****************************************************************************
 * END download.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikiwidget.js
 ****************************************************************************/

// $Id: wikiwidget.js 1193 2006-02-24 07:21:46Z quarl $

// originally based on
// http://en.wikipedia.org/wiki/Wikipedia:WikiProject_User_scripts/Scripts/Add_LI_link

var $wikiwidget = new Module('wikiwidget.js');
$wikiwidget.depend('wikiwidget.css');
$wikiwidget.depend('util.js');

$wikiwidget.getPortlet0 = function(n) {
    return document.getElementById(n).getElementsByTagName('ul')[0];
}

// this is monobook-specific
$wikiwidget.portlet_names = {
    'Personal':'p-personal',
    'Actions': 'p-cactions',
    'Navigation': 'p-navigation',
    'Toolbox': 'p-tb'
    // 'Search': 'p-search'
};

$wikiwidget._load = function() {
    $wikiwidget.portlets = {};
    for (var n in $wikiwidget.portlet_names) {
        $wikiwidget.portlets[n] = $wikiwidget.getPortlet0($wikiwidget.portlet_names[n]);
    }
}

$wikiwidget.getPortlet = function(n) {
    if (!$wikiwidget.portlets) {
        alert(&quot;## $wikiwidget.getPortlet: not yet initialized?! (error 0b8ab92b-8f67-425b-b1eb-2485aa8265af)&quot;);
        return null;
    }
    return $wikiwidget.portlets[n];
}

// add a node at a location.  If it's a regular node, then append to location
// as parent.  If it's {after:node}, then insert after node.
$wikiwidget._fancyAdd = function(location, newNode) {
    if (typeof(location) == 'function') {
        location = location();
    }
    if (location['portlet']) {
        var portlet = $wikiwidget.getPortlet(location['portlet']);
        portlet.appendChild(newNode);
    } else if (location['after']) {
        var after = location['after'];
        if (typeof(after) == 'string') {
            after = document.getElementById(after);
        }
        if (!after) {
            alert(&quot;$wikiwidget: couldn't get location to add after (error 6e8df341-9ee6-4ada-9d44-42a8e600d87c)&quot;);
            return;
        }
        if (after.nextSibling) {
            after.parentNode.insertBefore(newNode, after.nextSibling);
        } else {
            after.parentNode.appendChild(newNode);
        }
    } else if (location &amp;&amp; location.appendChild) {
        location.appendChild(newNode);
    } else {
        alert(&quot;$wikiwidget: must specify location to add (error bb4c83cf-8ab6-4cc3-a2c0-f9fc53f66dbb)&quot;);
    }
}

var WikiWidget = $wikiwidget.WikiWidget = function(params) {
    $util.merge(this, params);
    this.add = $util.bindThis(this, this.add_);
}

$wikiwidget.WikiWidget.prototype.add_ = function(location) {
    $wikiwidget.debug(&quot;WikiWidget.add(): id='&quot;+this.id+&quot;', entry='&quot;+this.entry+&quot;', name='&quot;+this.name+&quot;', url='&quot;+this.url+&quot;', title='&quot;+this.title+&quot;'&quot;);
    location = location || this.default_location;
    var li = this.li = document.createElement('li');
    if (this.id) li.id = this.id;

    if (typeof(this.entry) == 'string') {
        li.innerHTML = this.entry;
    } else if (this.entry) {
        li.appendChild(this.entry);
    } else if (this.name) {
        var na = document.createElement('a');
        if (this.url) {
            na.href = this.url;
        }
        if (this.onclick) {
            na.onclick = this.onclick;
            if (!na.href) {
                na.href = &quot;javascript:void 0&quot;;
            }
        }
        na.appendChild(document.createTextNode(this.name));
        li.appendChild(na);
    } else {
        $wikiwidget.error(&quot;WikiWidget.add: invalid WikiWidget (error aed67c57-3bba-47e0-9b7f-e8d420c7eeea)&quot;);
    }

    $wikiwidget._fancyAdd(location, li);

    if (this.id &amp;&amp; (this.key || this.title) &amp;&amp; window.ta) {
        ta[this.id] = [(this.key||''), (this.title||'')];
        $wikiwidget._scheduleAkeytt();
    }
    return li;
}

$wikiwidget.WikiWidget.prototype.showStatus = function(statusText) {
    $util.buttonShowStatus(this.li, statusText);
}

$wikiwidget.WikiWidget.prototype.hideStatus = function(statusText) {
    $util.buttonHideStatus(this.li, statusText);
}

// Re-render the title and access keys.  Since we add many tabs onLoad, don't
// call akeytt() a unnecessarily -- just call it once after we're done loading.
$wikiwidget._scheduled_akeytt = false;
$wikiwidget._scheduleAkeytt = function() {
    if (!$wikiwidget._scheduled_akeytt) {
        $wikiwidget._scheduled_akeytt = true;
        setTimeout(function() { akeytt(); $wikiwidget._scheduled_akeytt = false; }, 0);
    }
}

$wikiwidget._toggleMenu = function() {
    var mn = this.nextSibling;
    if (!mn || typeof(mn.displayState) != 'boolean') {
        alert(&quot;## invalid target for $wikiwidget._toggleMenu (error f66282ae-0762-4c90-8b5d-f095909cb786)&quot;);
        return;
    }

    if ( (mn.displayState = !mn.displayState) ) {
        // new state: display
        mn.className += ' sticky';
    } else {
        // new state: hide
        mn.className = mn.className.replace(/(^| )sticky/, '');
    }
}

$wikiwidget.addTabMenu = function(name, id)
{
    var parent = $wikiwidget.getPortletTabActions();

    var na = document.createElement('a');
    na.href = 'javascript:void(0)';
    na.appendChild(document.createTextNode(name));
    na.onclick = $wikiwidget._toggleMenu;

    var mn = document.createElement('ul');
    mn.displayState = false;

    var li = document.createElement('li');
    li.id = id;
    li.className = 'tabmenu';
    li.appendChild(na);
    li.appendChild(mn);
    parent.appendChild(li);
    return mn;
}

// deprecated:
$wikiwidget.addLiLinkX = function(location, entry, id, title, key){
    new $wikiwidget.WikiWidget({entry: entry, id: id, title: title, key: key}).add(location);
}

// deprecated:
$wikiwidget.addLiLink = function(location, url, name, id, title, key) {
    new $wikiwidget.WikiWidget({url: url, name: name, id: id, title: title, key: key}).add(location);
}

// deprecated:
$wikiwidget.getPortletPersonal = function() { return $wikiwidget.getPortlet('Personal'); }
// deprecated:
$wikiwidget.getPortletTabActions = function() { return $wikiwidget.getPortlet('Actions'); }
// deprecated:
$wikiwidget.getPortletNavigation = function() { return $wikiwidget.getPortlet('Navigation'); }
// deprecated:
$wikiwidget.getPortletToolbox = function() { return $wikiwidget.getPortlet('Toolbox'); }

// deprecated:
$wikiwidget.addTab = function(url, name, id, title, key) {
    return new $wikiwidget.WikiWidget({url: url, name: name, id: id, title: title, key: key}).add({portlet:'Actions'});
}

// deprecated:
$wikiwidget.addToolboxLink = function(url, name, id, title, key) {
    return new $wikiwidget.WikiWidget({url: url, name: name, id: id, title: title, key: key}).add({portlet:'Toolbox'});
}

// deprecated:
$wikiwidget.addNavigationLink = function(url, name, id, title, key) {
    return new $wikiwidget.WikiWidget({url: url, name: name, id: id, title: title, key: key}).add({portlet:'Navigation'});
}

$util.addOnloadHook($wikiwidget._load);

/****************************************************************************
 * END wikiwidget.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikins.js
 ****************************************************************************/

// -*- coding:utf-8 -*-
// $Id: wikins.js 1241 2006-02-24 11:57:26Z quarl $

// define internationalized namespace strings

// $wikins.namespaceTalk maps English non-Talk namespace to Talk namespace
// $wikins.namespaceNoTalk maps English Talk namespace to non-Talk namespace


// $wikins.namespaces maps local names to English
// $wikins.namespaceNames maps English to local names

// $wikins.User_talk == $wikins.namespaceNames['User talk']

// e.g. on de.wikipedia.org:

//  $wikins.User_talk == 'Benutzerseite Diskussion'
//  $wikins.namespaceNames['User talk'] == 'Benutzerseite Diskussion'
//  $wikins.namespaces['Benutzerseite Diskussion'] == 'User talk'

// originally from Lupin's popups

var $wikins = new Module('wikins.js');

$wikins.namespacesEnglish = [&quot;Media&quot;, &quot;Special&quot;,
                             &quot;Talk&quot;,
                             &quot;User&quot;, &quot;User talk&quot;,
                             &quot;Wikipedia&quot;, &quot;Wikipedia talk&quot;,
                             &quot;Image&quot;, &quot;Image talk&quot;,
                             &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;,
                             &quot;Template&quot;, &quot;Template talk&quot;,
                             &quot;Help&quot;, &quot;Help talk&quot;,
                             &quot;Category&quot;, &quot;Category talk&quot;,
                             &quot;Portal&quot;, &quot;Portal talk&quot;];

$wikins.namespaceTalk = {
    &quot;&quot;          : &quot;Talk&quot;,
    &quot;User&quot;      : &quot;User talk&quot;,
    &quot;Wikipedia&quot; : &quot;Wikipedia talk&quot;,
    &quot;Image&quot;     : &quot;Image talk&quot;,
    &quot;MediaWiki&quot; : &quot;MediaWiki talk&quot;,
    &quot;Template&quot;  : &quot;Template talk&quot;,
    &quot;Help&quot;      : &quot;Help talk&quot;,
    &quot;Category&quot;  : &quot;Category talk&quot;,
    &quot;Portal&quot;    : &quot;Portal talk&quot;
};

$wikins.namespaceNoTalk = {
    &quot;Talk&quot;           : &quot;&quot;,
    &quot;User talk&quot;      : &quot;User&quot;,
    &quot;Wikipedia talk&quot; : &quot;Wikipedia&quot;,
    &quot;Image talk&quot;     : &quot;Image&quot;,
    &quot;MediaWiki talk&quot; : &quot;MediaWiki&quot;,
    &quot;Template talk&quot;  : &quot;Template&quot;,
    &quot;Help talk&quot;      : &quot;Help&quot;,
    &quot;Category talk&quot;  : &quot;Category&quot;,
    &quot;Portal talk&quot;    : &quot;Portal&quot;
};

$wikins.getNS = function(lang) {
    switch(lang) {
        case &quot;en&quot;: return $wikins.namespacesEnglish;
        case &quot;af&quot;: return [&quot;Media&quot;, &quot;Spesiaal&quot;, &quot;Bespreking&quot;, &quot;Gebruiker&quot;, &quot;Gebruikerbespreking&quot;, &quot;Wikipedia&quot;, &quot;Wikipediabespreking&quot;, &quot;Beeld&quot;, &quot;Beeldbespreking&quot;, &quot;MediaWiki&quot;, &quot;MediaWikibespreking&quot;, &quot;Sjabloon&quot;, &quot;Sjabloonbespreking&quot;, &quot;Hulp&quot;, &quot;Hulpbespreking&quot;, &quot;Kategorie&quot;, &quot;Kategoriebespreking&quot;];
        case &quot;als&quot;: return [&quot;Media&quot;, &quot;Spezial&quot;, &quot;Diskussion&quot;, &quot;Benutzer&quot;, &quot;Benutzer Diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskussion&quot;, &quot;Bild&quot;, &quot;Bild Diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskussion&quot;, &quot;Vorlage&quot;, &quot;Vorlage Diskussion&quot;, &quot;Hilfe&quot;, &quot;Hilfe Diskussion&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskussion&quot;];
        case &quot;ar&quot;: return [&quot;Ù…Ù„Ù&quot;, &quot;Ø®Ø§Øµ&quot;, &quot;Ù†Ù‚Ø§Ø´&quot;, &quot;Ù…Ø³ØªØ®Ø¯Ù…&quot;, &quot;Ù†Ù‚Ø§Ø´ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…&quot;, &quot;ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§&quot;, &quot;Ù†Ù‚Ø§Ø´ ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§&quot;, &quot;ØµÙˆØ±Ø©&quot;, &quot;Ù†Ù‚Ø§Ø´ Ø§Ù„ØµÙˆØ±Ø©&quot;, &quot;Ù…ÙŠØ¯ÙŠØ§ÙˆÙŠÙƒÙŠ&quot;, &quot;Ù†Ù‚Ø§Ø´ Ù…ÙŠØ¯ÙŠØ§ÙˆÙŠÙƒÙŠ&quot;, &quot;Template&quot;, &quot;Ù†Ù‚Ø§Ø´ Template&quot;, &quot;Ù…Ø³Ø§Ø¹Ø¯Ø©&quot;, &quot;Ù†Ù‚Ø§Ø´ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©&quot;, &quot;ØªØµÙ†ÙŠÙ&quot;, &quot;Ù†Ù‚Ø§Ø´ Ø§Ù„ØªØµÙ†ÙŠÙ&quot;];
        case &quot;ast&quot;: return [&quot;Media&quot;, &quot;Especial&quot;, &quot;DiscusiÃ³n&quot;, &quot;Usuariu&quot;, &quot;Usuariu discusiÃ³n&quot;, &quot;Uiquipedia&quot;, &quot;Uiquipedia discusiÃ³n&quot;, &quot;Imaxen&quot;, &quot;Imaxen discusiÃ³n&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki discusiÃ³n&quot;, &quot;Plantilla&quot;, &quot;Plantilla discusiÃ³n&quot;, &quot;Ayuda&quot;, &quot;Ayuda discusiÃ³n&quot;, &quot;CategorÃ­a&quot;, &quot;CategorÃ­a discusiÃ³n&quot;];
        case &quot;be&quot;: return [&quot;ÐœÑÐ´Ñ‹Ñ&quot;, &quot;Ð¡Ð¿ÑÑ†Ñ‹ÑÐ»ÑŒÐ½Ñ‹Ñ&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ&quot;, &quot;Ð£Ð´Ð·ÐµÐ»ÑŒÐ½Ñ–Ðº&quot;, &quot;Ð“ÑƒÑ‚Ð°Ñ€ÐºÑ– ÑžÐ´Ð·ÐµÐ»ÑŒÐ½Ñ–ÐºÐ°&quot;, &quot;Ð’Ñ–ÐºÑ–Ð¿ÑÐ´Ñ‹Ñ&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ Ð’Ñ–ÐºÑ–Ð¿ÑÐ´Ñ‹Ñ&quot;, &quot;Ð’Ñ‹ÑÐ²Ð°&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ Ð²Ñ‹ÑÐ²Ñ‹&quot;, &quot;MediaWiki&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ MediaWiki&quot;, &quot;Ð¨Ð°Ð±Ð»Ñ‘Ð½&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ ÑˆÐ°Ð±Ð»Ñ‘Ð½Ñƒ&quot;, &quot;Ð”Ð°Ð¿Ð°Ð¼Ð¾Ð³Ð°&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ Ð´Ð°Ð¿Ð°Ð¼Ð¾Ð³Ñ–&quot;, &quot;ÐšÐ°Ñ‚ÑÐ³Ð¾Ñ€Ñ‹Ñ&quot;, &quot;ÐÐ±Ð¼ÐµÑ€ÐºÐ°Ð²Ð°Ð½ÑŒÐ½Ðµ ÐºÐ°Ñ‚ÑÐ³Ð¾Ñ€Ñ‹Ñ–&quot;];
        case &quot;bg&quot;: return [&quot;ÐœÐµÐ´Ð¸Ñ&quot;, &quot;Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð½Ð¸&quot;, &quot;Ð‘ÐµÑÐµÐ´Ð°&quot;, &quot;ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»&quot;, &quot;ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ» Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;Ð£Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ñ&quot;, &quot;Ð£Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ñ Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;ÐšÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ°&quot;, &quot;ÐšÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ° Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;ÐœÐµÐ´Ð¸ÑÐ£Ð¸ÐºÐ¸&quot;, &quot;ÐœÐµÐ´Ð¸ÑÐ£Ð¸ÐºÐ¸ Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½ Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;ÐŸÐ¾Ð¼Ð¾Ñ‰&quot;, &quot;ÐŸÐ¾Ð¼Ð¾Ñ‰ Ð±ÐµÑÐµÐ´Ð°&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ Ð±ÐµÑÐµÐ´Ð°&quot;];
        case &quot;bm&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Discuter&quot;, &quot;Utilisateur&quot;, &quot;Discussion Utilisateur&quot;, &quot;Wikipedia&quot;, &quot;Discussion Wikipedia&quot;, &quot;Image&quot;, &quot;Discussion Image&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;ModÃ¨le&quot;, &quot;Discussion ModÃ¨le&quot;, &quot;Aide&quot;, &quot;Discussion Aide&quot;, &quot;CatÃ©gorie&quot;, &quot;Discussion CatÃ©gorie&quot;];
        case &quot;bn&quot;: return [&quot;à¦¬à¦¿à¦¶à§‡à¦·&quot;, &quot;à¦†à¦²à¦¾à¦ª&quot;, &quot;à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€&quot;, &quot;à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€ à¦†à¦²à¦¾à¦ª&quot;, &quot;à¦‰à¦‡à¦•à¦¿à¦ªà§‡à¦¡à¦¿à¦¯à¦¼à¦¾&quot;, &quot;à¦‰à¦‡à¦•à¦¿à¦ªà§‡à¦¡à¦¿à¦¯à¦¼à¦¾ à¦†à¦²à¦¾à¦ª&quot;, &quot;à¦šà¦¿à¦¤à§à¦°&quot;, &quot;à¦šà¦¿à¦¤à§à¦° à¦†à¦²à¦¾à¦ª&quot;, &quot;MediaWik i à¦†à¦²à¦¾à¦ª&quot;, &quot;Media&quot;, &quot;MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;br&quot;: return [&quot;Media&quot;, &quot;Dibar&quot;, &quot;Kaozeal&quot;, &quot;Implijer&quot;, &quot;Kaozeadenn Implijer&quot;, &quot;Wikipedia&quot;, &quot;Kaozeadenn Wikipedia&quot;, &quot;Skeudenn&quot;, &quot;Kaozeadenn Skeudenn&quot;, &quot;MediaWiki&quot;, &quot;Kaozeadenn MediaWiki&quot;, &quot;Patrom&quot;, &quot;Kaozeadenn Patrom&quot;, &quot;Skoazell&quot;, &quot;Kaozeadenn Skoazell&quot;, &quot;Rummad&quot;, &quot;Kaozeadenn Rummad&quot;];
        case &quot;ca&quot;: return [&quot;Media&quot;, &quot;Especial&quot;, &quot;DiscussiÃ³&quot;, &quot;Usuari&quot;, &quot;Usuari DiscussiÃ³&quot;, &quot;ViquipÃ¨dia&quot;, &quot;ViquipÃ¨dia DiscussiÃ³&quot;, &quot;Imatge&quot;, &quot;Imatge DiscussiÃ³&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki DiscussiÃ³&quot;, &quot;Template&quot;, &quot;Template DiscussiÃ³&quot;, &quot;Ajuda&quot;, &quot;Ajuda DiscussiÃ³&quot;, &quot;Categoria&quot;, &quot;Categoria DiscussiÃ³&quot;];
        case &quot;cs&quot;: return [&quot;MÃ©dia&quot;, &quot;SpeciÃ¡lnÃ­&quot;, &quot;Diskuse&quot;, &quot;Wikipedista&quot;, &quot;Wikipedista diskuse&quot;, &quot;Wikipedie&quot;, &quot;Wikipedie diskuse&quot;, &quot;Soubor&quot;, &quot;Soubor diskuse&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskuse&quot;, &quot;Å ablona&quot;, &quot;Å ablona diskuse&quot;, &quot;NÃ¡povÄ›da&quot;, &quot;NÃ¡povÄ›da diskuse&quot;, &quot;Kategorie&quot;, &quot;Kategorie diskuse&quot;];
        case &quot;csb&quot;: return [&quot;Media&quot;, &quot;SpecjalnÃ´&quot;, &quot;DiskÃ¹sÃ«jÃ´&quot;, &quot;BrÃ«kÃ²wnik&quot;, &quot;DiskÃ¹sÃ«jÃ´ brÃ«kÃ²wnika&quot;, &quot;Wiki&quot;, &quot;DiskÃ¹sÃ«jÃ´ Wiki&quot;, &quot;Ã’brÃ´zk&quot;, &quot;DiskÃ¹sÃ«jÃ´ Ã²brÃ´zkÃ³w&quot;, &quot;MediaWiki&quot;, &quot;DiskÃ¹sÃ«jÃ´ MediaWiki&quot;, &quot;SzablÃ³na&quot;, &quot;DiskÃ¹sÃ«jÃ´ SzablÃ³nÃ«&quot;, &quot;PÃ²mÃ²c&quot;, &quot;DiskÃ¹sÃ«jÃ´ PÃ²mÃ²cÃ«&quot;, &quot;KategÃ²rÃ«jÃ´&quot;, &quot;DiskÃ¹sÃ«jÃ´ KategÃ²rÃ«ji&quot;];
        case &quot;cv&quot;: return [&quot;ÐœÐµÐ´Ð¸Ð°&quot;, &quot;Ð¯Ñ‚Ð°Ñ€Ð»Äƒ&quot;, &quot;Ð¡Ó³Ñ‚ÑÐµ ÑÐ²Ð°ÑÑÐ¸&quot;, &quot;Ð¥ÑƒÑ‚ÑˆÄƒÐ½Ð°ÐºÐ°Ð½&quot;, &quot;Ð¥ÑƒÑ‚ÑˆÄƒÐ½Ð°ÐºÐ°Ð½ÄƒÐ½ ÐºÐ°Ð½Ð°ÑˆÐ»Ñƒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð¸&quot;, &quot;Wikipedia&quot;, &quot;0&quot;, &quot;Ó²ÐºÐµÑ€Ñ‡Ä•Ðº&quot;, &quot;Ó²ÐºÐµÑ€Ñ‡Ä•ÐºÐµ ÑÓ³Ñ‚ÑÐµ ÑÐ²Ð¼Ð°Ð»Ð»Ð¸&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki ÑÓ³Ñ‚ÑÐµ ÑÐ²Ð¼Ð°Ð»Ð»Ð¸&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½Ð° ÑÓ³Ñ‚ÑÐµ ÑÐ²Ð¼Ð°Ð»Ð»Ð¸&quot;, &quot;ÐŸÑƒÐ»ÄƒÑˆÑƒ&quot;, &quot;ÐŸÑƒÐ»ÄƒÑˆÄƒÐ²Ð° ÑÓ³Ñ‚ÑÐµ ÑÐ²Ð¼Ð°Ð»Ð»Ð¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð½Ðµ ÑÓ³Ñ‚ÑÐµ ÑÐ²Ð¼Ð°Ð»Ð»Ð¸&quot;];
        case &quot;cy&quot;: return [&quot;Media&quot;, &quot;Arbennig&quot;, &quot;Sgwrs&quot;, &quot;Defnyddiwr&quot;, &quot;Sgwrs Defnyddiwr&quot;, &quot;Wicipedia&quot;, &quot;Sgwrs Wicipedia&quot;, &quot;Delwedd&quot;, &quot;Sgwrs Delwedd&quot;, &quot;MediaWiki&quot;, &quot;Sgwrs MediaWiki&quot;, &quot;Nodyn&quot;, &quot;Sgwrs Nodyn&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;da&quot;: return [&quot;Media&quot;, &quot;Speciel&quot;, &quot;Diskussion&quot;, &quot;Bruger&quot;, &quot;Bruger diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia diskussion&quot;, &quot;Billede&quot;, &quot;Billede diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskussion&quot;, &quot;Skabelon&quot;, &quot;Skabelon diskussion&quot;, &quot;HjÃ¦lp&quot;, &quot;HjÃ¦lp diskussion&quot;, &quot;Kategori&quot;, &quot;Kategori diskussion&quot;];
        case &quot;de&quot;: return [&quot;Media&quot;, &quot;Spezial&quot;, &quot;Diskussion&quot;, &quot;Benutzer&quot;, &quot;Benutzer Diskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskussion&quot;, &quot;Bild&quot;, &quot;Bild Diskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskussion&quot;, &quot;Vorlage&quot;, &quot;Vorlage Diskussion&quot;, &quot;Hilfe&quot;, &quot;Hilfe Diskussion&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskussion&quot;, &quot;Portal&quot;, &quot;Portal Diskussion&quot;];
        case &quot;el&quot;: return [&quot;ÎœÎ­ÏƒÎ¿Î½&quot;, &quot;Î•Î¹Î´Î¹ÎºÏŒ&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·&quot;, &quot;Î§ÏÎ®ÏƒÏ„Î·Ï‚&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· Ï‡ÏÎ®ÏƒÏ„Î·&quot;, &quot;Î’Î¹ÎºÎ¹Ï€Î±Î¯Î´ÎµÎ¹Î±&quot;, &quot;Î’Î¹ÎºÎ¹Ï€Î±Î¯Î´ÎµÎ¹Î± ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ·&quot;, &quot;Î•Î¹ÎºÏŒÎ½Î±&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Î ÏÏŒÏ„Ï…Ï€Î¿&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· Ï€ÏÎ¿Ï„ÏÏ€Î¿Ï…&quot;, &quot;Î’Î¿Î®Î¸ÎµÎ¹Î±&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· Î²Î¿Î®Î¸ÎµÎ¹Î±Ï‚&quot;, &quot;ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±&quot;, &quot;Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚&quot;];
        case &quot;eo&quot;: return [&quot;Media&quot;, &quot;Speciala&quot;, &quot;Diskuto&quot;, &quot;Vikipediisto&quot;, &quot;Vikipediista diskuto&quot;, &quot;Vikipedio&quot;, &quot;Vikipedio diskuto&quot;, &quot;Dosiero&quot;, &quot;Dosiera diskuto&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskuto&quot;, &quot;Åœablono&quot;, &quot;Åœablona diskuto&quot;, &quot;Helpo&quot;, &quot;Helpa diskuto&quot;, &quot;Kategorio&quot;, &quot;Kategoria diskuto&quot;];
        case &quot;es&quot;: return [&quot;Media&quot;, &quot;Especial&quot;, &quot;DiscusiÃ³n&quot;, &quot;Usuario&quot;, &quot;Usuario DiscusiÃ³n&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia DiscusiÃ³n&quot;, &quot;Imagen&quot;, &quot;Imagen DiscusiÃ³n&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki DiscusiÃ³n&quot;, &quot;Plantilla&quot;, &quot;Plantilla DiscusiÃ³n&quot;, &quot;Ayuda&quot;, &quot;Ayuda DiscusiÃ³n&quot;, &quot;CategorÃ­a&quot;, &quot;CategorÃ­a DiscusiÃ³n&quot;];
        case &quot;et&quot;: return [&quot;Meedia&quot;, &quot;Eri&quot;, &quot;Arutelu&quot;, &quot;Kasutaja&quot;, &quot;Kasutaja arutelu&quot;, &quot;Vikipeedia&quot;, &quot;Vikipeedia arutelu&quot;, &quot;Pilt&quot;, &quot;Pildi arutelu&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki arutelu&quot;, &quot;Mall&quot;, &quot;Malli arutelu&quot;, &quot;Juhend&quot;, &quot;Juhendi arutelu&quot;, &quot;Kategooria&quot;, &quot;Kategooria arutelu&quot;];
        case &quot;eu&quot;: return [&quot;Media&quot;, &quot;Aparteko&quot;, &quot;Eztabaida&quot;, &quot;Lankide&quot;, &quot;Lankide eztabaida&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia eztabaida&quot;, &quot;Irudi&quot;, &quot;Irudi eztabaida&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki eztabaida&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;fa&quot;: return [&quot;Ù…Ø¯ÛŒØ§&quot;, &quot;ÙˆÛŒÚ˜Ù‡&quot;, &quot;Ø¨Ø­Ø«&quot;, &quot;Ú©Ø§Ø±Ø¨Ø±&quot;, &quot;Ø¨Ø­Ø« Ú©Ø§Ø±Ø¨Ø±&quot;, &quot;ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§&quot;, &quot;Ø¨Ø­Ø« ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§&quot;, &quot;ØªØµÙˆÛŒØ±&quot;, &quot;Ø¨Ø­Ø« ØªØµÙˆÛŒØ±&quot;, &quot;Ù…Ø¯ÛŒØ§ÙˆÛŒÚ©ÛŒ&quot;, &quot;Ø¨Ø­Ø« Ù…Ø¯ÛŒØ§ÙˆÛŒÚ©ÛŒ&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;fi&quot;: return [&quot;Media&quot;, &quot;Toiminnot&quot;, &quot;Keskustelu&quot;, &quot;KÃ¤yttÃ¤jÃ¤&quot;, &quot;Keskustelu kÃ¤yttÃ¤jÃ¤stÃ¤&quot;, &quot;Wikipedia&quot;, &quot;Keskustelu Wikipediasta&quot;, &quot;Kuva&quot;, &quot;Keskustelu kuvasta&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Malline&quot;, &quot;Keskustelu mallineesta&quot;, &quot;Ohje&quot;, &quot;Keskustelu ohjeesta&quot;, &quot;Luokka&quot;, &quot;Keskustelu luokasta&quot;];
        case &quot;fo&quot;: return [&quot;MiÃ°il&quot;, &quot;Serstakur&quot;, &quot;Kjak&quot;, &quot;BrÃºkari&quot;, &quot;BrÃºkari kjak&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia kjak&quot;, &quot;Mynd&quot;, &quot;Mynd kjak&quot;, &quot;MidiaWiki&quot;, &quot;MidiaWiki kjak&quot;, &quot;Fyrimynd&quot;, &quot;Fyrimynd kjak&quot;, &quot;HjÃ¡lp&quot;, &quot;HjÃ¡lp kjak&quot;, &quot;BÃ³lkur&quot;, &quot;BÃ³lkur kjak&quot;];
        case &quot;fr&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Discuter&quot;, &quot;Utilisateur&quot;, &quot;Discussion Utilisateur&quot;, &quot;WikipÃ©dia&quot;, &quot;Discussion WikipÃ©dia&quot;, &quot;Image&quot;, &quot;Discussion Image&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;ModÃ¨le&quot;, &quot;Discussion ModÃ¨le&quot;, &quot;Aide&quot;, &quot;Discussion Aide&quot;, &quot;CatÃ©gorie&quot;, &quot;Discussion CatÃ©gorie&quot;, &quot;Portail&quot;, &quot;Discussion Portail&quot;];
        case &quot;fur&quot;: return [&quot;Media&quot;, &quot;SpeciÃ¢l&quot;, &quot;Discussion&quot;, &quot;Utent&quot;, &quot;Discussion utent&quot;, &quot;Vichipedie&quot;, &quot;Discussion Vichipedie&quot;, &quot;Figure&quot;, &quot;Discussion figure&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Model&quot;, &quot;Discussion model&quot;, &quot;Jutori&quot;, &quot;Discussion jutori&quot;, &quot;Categorie&quot;, &quot;Discussion categorie&quot;];
        case &quot;fy&quot;: return [&quot;Media&quot;, &quot;Wiki&quot;, &quot;Oerlis&quot;, &quot;Meidogger&quot;, &quot;Meidogger oerlis&quot;, &quot;Wikipedy&quot;, &quot;Wikipedy oerlis&quot;, &quot;Ofbyld&quot;, &quot;Ofbyld oerlis&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki oerlis&quot;, &quot;Berjocht&quot;, &quot;Berjocht oerlis&quot;, &quot;Hulp&quot;, &quot;Hulp oerlis&quot;, &quot;Kategory&quot;, &quot;Kategory oerlis&quot;];
        case &quot;ga&quot;: return [&quot;MeÃ¡n&quot;, &quot;Speisialta&quot;, &quot;PlÃ©&quot;, &quot;ÃšsÃ¡ideoir&quot;, &quot;PlÃ© ÃºsÃ¡ideora&quot;, &quot;VicipÃ©id&quot;, &quot;PlÃ© VicipÃ©ide&quot;, &quot;ÃomhÃ¡&quot;, &quot;PlÃ© Ã­omhÃ¡&quot;, &quot;MediaWiki&quot;, &quot;PlÃ© MediaWiki&quot;, &quot;TeimplÃ©ad&quot;, &quot;PlÃ© teimplÃ©id&quot;, &quot;Cabhair&quot;, &quot;PlÃ© cabhrach&quot;, &quot;CatagÃ³ir&quot;, &quot;PlÃ© catagÃ³ire&quot;];
        case &quot;gu&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;àªµàª¿àª•àª¿àªªà«€àª¡àª¿àª¯àª¾&quot;, &quot;àªµàª¿àª•àª¿àªªà«€àª¡àª¿àª¯àª¾ talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;he&quot;: return [&quot;Media&quot;, &quot;×ž×™×•×—×“&quot;, &quot;×©×™×—×”&quot;, &quot;×ž×©×ª×ž×©&quot;, &quot;×©×™×—×ª ×ž×©×ª×ž×©&quot;, &quot;×•×™×§×™×¤×“×™×”&quot;, &quot;×©×™×—×ª ×•×™×§×™×¤×“×™×”&quot;, &quot;×ª×ž×•× ×”&quot;, &quot;×©×™×—×ª ×ª×ž×•× ×”&quot;, &quot;MediaWiki&quot;, &quot;×©×™×—×ª MediaWiki&quot;, &quot;×ª×‘× ×™×ª&quot;, &quot;×©×™×—×ª ×ª×‘× ×™×ª&quot;, &quot;×¢×–×¨×”&quot;, &quot;×©×™×—×ª ×¢×–×¨×”&quot;, &quot;×§×˜×’×•×¨×™×”&quot;, &quot;×©×™×—×ª ×§×˜×’×•×¨×™×”&quot;];
        case &quot;hi&quot;: return [&quot;Media&quot;, &quot;à¤µà¤¿à¤¶à¥‡à¤·&quot;, &quot;à¤µà¤¾à¤°à¥à¤¤à¤¾&quot;, &quot;à¤¸à¤¦à¤¸à¥à¤¯&quot;, &quot;à¤¸à¤¦à¤¸à¥à¤¯ à¤µà¤¾à¤°à¥à¤¤à¤¾&quot;, &quot;à¤µà¤¿à¤•à¤¿à¤ªà¥€à¤¡à¤¿à¤¯à¤¾&quot;, &quot;à¤µà¤¿à¤•à¤¿à¤ªà¥€à¤¡à¤¿à¤¯à¤¾ à¤µà¤¾à¤°à¥à¤¤à¤¾&quot;, &quot;à¤šà¤¿à¤¤à¥à¤°&quot;, &quot;à¤šà¤¿à¤¤à¥à¤° à¤µà¤¾à¤°à¥à¤¤à¤¾&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;à¤¶à¥à¤°à¥‡à¤£à¥€&quot;, &quot;à¤¶à¥à¤°à¥‡à¤£à¥€ à¤µà¤¾à¤°à¥à¤¤à¤¾&quot;, &quot;Help&quot;, &quot;Help talk&quot;];
        case &quot;hr&quot;: return [&quot;Mediji&quot;, &quot;Posebno&quot;, &quot;Razgovor&quot;, &quot;Suradnik&quot;, &quot;Razgovor sa suradnikom&quot;, &quot;Wikipedia&quot;, &quot;Razgovor Wikipedia&quot;, &quot;Slika&quot;, &quot;Razgovor o slici&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki razgovor&quot;, &quot;PredloÅ¾ak&quot;, &quot;Razgovor o predloÅ¡ku&quot;, &quot;PomoÄ‡&quot;, &quot;Razgovor o pomoÄ‡i&quot;, &quot;Kategorija&quot;, &quot;Razgovor o kategoriji&quot;];
        case &quot;hu&quot;: return [&quot;MÃ©dia&quot;, &quot;SpeciÃ¡lis&quot;, &quot;Vita&quot;, &quot;User&quot;, &quot;User vita&quot;, &quot;WikipÃ©dia&quot;, &quot;WikipÃ©dia vita&quot;, &quot;KÃ©p&quot;, &quot;KÃ©p vita&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki vita&quot;, &quot;Sablon&quot;, &quot;Sablon vita&quot;, &quot;SegÃ­tsÃ©g&quot;, &quot;SegÃ­tsÃ©g vita&quot;, &quot;KategÃ³ria&quot;, &quot;KategÃ³ria vita&quot;];
        case &quot;ia&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Discussion&quot;, &quot;Usator&quot;, &quot;Discussion Usator&quot;, &quot;Wikipedia&quot;, &quot;Discussion Wikipedia&quot;, &quot;Imagine&quot;, &quot;Discussion Imagine&quot;, &quot;MediaWiki&quot;, &quot;Discussion MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;id&quot;: return [&quot;Media&quot;, &quot;Istimewa&quot;, &quot;Bicara&quot;, &quot;Pengguna&quot;, &quot;Bicara Pengguna&quot;, &quot;Wikipedia&quot;, &quot;Pembicaraan Wikipedia&quot;, &quot;Gambar&quot;, &quot;Pembicaraan Gambar&quot;, &quot;MediaWiki&quot;, &quot;Pembicaraan MediaWiki&quot;, &quot;Templat&quot;, &quot;Pembicaraan Templat&quot;, &quot;Bantuan&quot;, &quot;Pembicaraan Bantuan&quot;, &quot;Kategori&quot;, &quot;Pembicaraan Kategori&quot;];
        case &quot;is&quot;: return [&quot;MiÃ°ill&quot;, &quot;KerfissÃ­Ã°a&quot;, &quot;Spjall&quot;, &quot;Notandi&quot;, &quot;Notandaspjall&quot;, &quot;Wikipedia&quot;, &quot;Wikipediaspjall&quot;, &quot;Mynd&quot;, &quot;Myndaspjall&quot;, &quot;Melding&quot;, &quot;Meldingarspjall&quot;, &quot;SniÃ°&quot;, &quot;SniÃ°aspjall&quot;, &quot;HjÃ¡lp&quot;, &quot;HjÃ¡lparspjall&quot;, &quot;Flokkur&quot;, &quot;Flokkaspjall&quot;];
        case &quot;it&quot;: return [&quot;Media&quot;, &quot;Speciale&quot;, &quot;Discussione&quot;, &quot;Utente&quot;, &quot;Discussioni utente&quot;, &quot;Wikipedia&quot;, &quot;Discussioni Wikipedia&quot;, &quot;Immagine&quot;, &quot;Discussioni immagine&quot;, &quot;MediaWiki&quot;, &quot;Discussioni MediaWiki&quot;, &quot;Template&quot;, &quot;Discussioni template&quot;, &quot;Aiuto&quot;, &quot;Discussioni aiuto&quot;, &quot;Categoria&quot;, &quot;Discussioni categoria&quot;];
        case &quot;ja&quot;: return [&quot;Media&quot;, &quot;ç‰¹åˆ¥&quot;, &quot;ãƒŽãƒ¼ãƒˆ&quot;, &quot;åˆ©ç”¨è€…&quot;, &quot;åˆ©ç”¨è€…â€ä¼šè©±&quot;, &quot;Wikipedia&quot;, &quot;Wikipediaâ€ãƒŽãƒ¼ãƒˆ&quot;, &quot;ç”»åƒ&quot;, &quot;ç”»åƒâ€ãƒŽãƒ¼ãƒˆ&quot;, &quot;MediaWiki&quot;, &quot;MediaWikiâ€ãƒŽãƒ¼ãƒˆ&quot;, &quot;Template&quot;, &quot;Templateâ€ãƒŽãƒ¼ãƒˆ&quot;, &quot;Help&quot;, &quot;Helpâ€ãƒŽãƒ¼ãƒˆ&quot;, &quot;Category&quot;, &quot;Categoryâ€ãƒŽãƒ¼ãƒˆ&quot;];
        case &quot;ka&quot;: return [&quot;áƒ›áƒ”áƒ“áƒ˜áƒ&quot;, &quot;áƒ¡áƒžáƒ”áƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜&quot;, &quot;áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜&quot;, &quot;áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ•áƒ˜áƒ™áƒ˜áƒžáƒ”áƒ“áƒ˜áƒ&quot;, &quot;áƒ•áƒ˜áƒ™áƒ˜áƒžáƒ”áƒ“áƒ˜áƒ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ¡áƒ£áƒ áƒáƒ—áƒ˜&quot;, &quot;áƒ¡áƒ£áƒ áƒáƒ—áƒ˜ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ›áƒ”áƒ“áƒ˜áƒáƒ•áƒ˜áƒ™áƒ˜&quot;, &quot;áƒ›áƒ”áƒ“áƒ˜áƒáƒ•áƒ˜áƒ™áƒ˜ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ—áƒáƒ áƒ’áƒ˜&quot;, &quot;áƒ—áƒáƒ áƒ’áƒ˜ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ&quot;, &quot;áƒ“áƒáƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;, &quot;áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ&quot;, &quot;áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ áƒ’áƒáƒœáƒ®áƒ˜áƒšáƒ•áƒ&quot;];
        case &quot;ko&quot;: return [&quot;Media&quot;, &quot;íŠ¹ìˆ˜ê¸°ëŠ¥&quot;, &quot;í† ë¡ &quot;, &quot;ì‚¬ìš©ìž&quot;, &quot;ì‚¬ìš©ìží† ë¡ &quot;, &quot;ìœ„í‚¤ë°±ê³¼&quot;, &quot;ìœ„í‚¤ë°±ê³¼í† ë¡ &quot;, &quot;ê·¸ë¦¼&quot;, &quot;ê·¸ë¦¼í† ë¡ &quot;, &quot;ë¶„ë¥˜&quot;, &quot;ë¶„ë¥˜í† ë¡ &quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;];
        case &quot;ku&quot;: return [&quot;Medya&quot;, &quot;Taybet&quot;, &quot;NÃ®qaÅŸ&quot;, &quot;BikarhÃªner&quot;, &quot;BikarhÃªner nÃ®qaÅŸ&quot;, &quot;WÃ®kÃ®pediya&quot;, &quot;WÃ®kÃ®pediya nÃ®qaÅŸ&quot;, &quot;WÃªne&quot;, &quot;WÃªne nÃ®qaÅŸ&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki nÃ®qaÅŸ&quot;, &quot;Åžablon&quot;, &quot;Åžablon nÃ®qaÅŸ&quot;, &quot;AlÃ®karÃ®&quot;, &quot;AlÃ®karÃ® nÃ®qaÅŸ&quot;, &quot;KategorÃ®&quot;, &quot;KategorÃ® nÃ®qaÅŸ&quot;];
        case &quot;la&quot;: return [&quot;Specialis&quot;, &quot;Disputatio&quot;, &quot;Usor&quot;, &quot;Disputatio Usoris&quot;, &quot;Vicipaedia&quot;, &quot;Disputatio Vicipaediae&quot;, &quot;Imago&quot;, &quot;Disputatio Imaginis&quot;, &quot;MediaWiki&quot;, &quot;Disputatio MediaWiki&quot;, &quot;Formula&quot;, &quot;Disputatio Formulae&quot;, &quot;Auxilium&quot;, &quot;Disputatio Auxilii&quot;, &quot;Categoria&quot;, &quot;Disputatio Categoriae&quot;, &quot;Media&quot;];
        case &quot;li&quot;: return [&quot;Media&quot;, &quot;Speciaal&quot;, &quot;Euverlik&quot;, &quot;Gebroeker&quot;, &quot;Euverlik gebroeker&quot;, &quot;Wikipedia&quot;, &quot;Euverlik Wikipedia&quot;, &quot;Aafbeilding&quot;, &quot;Euverlik afbeelding&quot;, &quot;MediaWiki&quot;, &quot;Euverlik MediaWiki&quot;, &quot;Sjabloon&quot;, &quot;Euverlik sjabloon&quot;, &quot;Help&quot;, &quot;Euverlik help&quot;, &quot;Kategorie&quot;, &quot;Euverlik kategorie&quot;];
        case &quot;lt&quot;: return [&quot;Medija&quot;, &quot;Specialus&quot;, &quot;Aptarimas&quot;, &quot;Naudotojas&quot;, &quot;Naudotojo aptarimas&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia aptarimas&quot;, &quot;Vaizdas&quot;, &quot;Vaizdo aptarimas&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki aptarimas&quot;, &quot;Å ablonas&quot;, &quot;Å ablono aptarimas&quot;, &quot;Pagalba&quot;, &quot;Pagalbos aptarimas&quot;, &quot;Kategorija&quot;, &quot;Kategorijos aptarimas&quot;];
        case &quot;mk&quot;: return [&quot;ÐœÐµÐ´Ð¸Ñ˜Ð°&quot;, &quot;Ð¡Ð¿ÐµÑ†Ð¸Ñ˜Ð°Ð»Ð½Ð¸&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;ÐšÐ¾Ñ€Ð¸ÑÐ½Ð¸Ðº&quot;, &quot;ÐšÐ¾Ñ€Ð¸ÑÐ½Ð¸Ðº Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;Ð¡Ð»Ð¸ÐºÐ°&quot;, &quot;Ð¡Ð»Ð¸ÐºÐ° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;ÐœÐµÐ´Ð¸Ñ˜Ð°Ð’Ð¸ÐºÐ¸&quot;, &quot;ÐœÐµÐ´Ð¸Ñ˜Ð°Ð’Ð¸ÐºÐ¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;ÐŸÐ¾Ð¼Ð¾Ñˆ&quot;, &quot;ÐŸÐ¾Ð¼Ð¾Ñˆ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ˜Ð°&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ˜Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;];
        case &quot;ms&quot;: return [&quot;Media&quot;, &quot;Istimewa&quot;, &quot;Perbualan&quot;, &quot;Pengguna&quot;, &quot;Perbualan Pengguna&quot;, &quot;Wikipedia&quot;, &quot;Perbualan Wikipedia&quot;, &quot;Imej&quot;, &quot;Imej Perbualan&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Perbualan&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;mt&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;Wikipedija&quot;, &quot;Wikipedija talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;nap&quot;: return [&quot;Media&quot;, &quot;Speciale&quot;, &quot;Discussione&quot;, &quot;Utente&quot;, &quot;Discussioni utente&quot;, &quot;Wikipedia&quot;, &quot;Discussioni Wikipedia&quot;, &quot;Immagine&quot;, &quot;Discussioni immagine&quot;, &quot;MediaWiki&quot;, &quot;Discussioni MediaWiki&quot;, &quot;Template&quot;, &quot;Discussioni template&quot;, &quot;Aiuto&quot;, &quot;Discussioni aiuto&quot;, &quot;Categoria&quot;, &quot;Discussioni categoria&quot;];
        case &quot;nds&quot;: return [&quot;Media&quot;, &quot;Spezial&quot;, &quot;Diskuschoon&quot;, &quot;Bruker&quot;, &quot;Bruker Diskuschoon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia Diskuschoon&quot;, &quot;Bild&quot;, &quot;Bild Diskuschoon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki Diskuschoon&quot;, &quot;VÃ¶rlaag&quot;, &quot;VÃ¶rlaag Diskuschoon&quot;, &quot;HÃ¼lp&quot;, &quot;HÃ¼lp Diskuschoon&quot;, &quot;Kategorie&quot;, &quot;Kategorie Diskuschoon&quot;];
        case &quot;nl&quot;: return [&quot;Media&quot;, &quot;Speciaal&quot;, &quot;Overleg&quot;, &quot;Gebruiker&quot;, &quot;Overleg gebruiker&quot;, &quot;Wikipedia&quot;, &quot;Overleg Wikipedia&quot;, &quot;Afbeelding&quot;, &quot;Overleg afbeelding&quot;, &quot;MediaWiki&quot;, &quot;Overleg MediaWiki&quot;, &quot;Sjabloon&quot;, &quot;Overleg sjabloon&quot;, &quot;Help&quot;, &quot;Overleg help&quot;, &quot;Categorie&quot;, &quot;Overleg categorie&quot;];
        case &quot;nn&quot;: return [&quot;Filpeikar&quot;, &quot;Spesial&quot;, &quot;Diskusjon&quot;, &quot;Brukar&quot;, &quot;Brukardiskusjon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia-diskusjon&quot;, &quot;Fil&quot;, &quot;Fildiskusjon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki-diskusjon&quot;, &quot;Mal&quot;, &quot;Maldiskusjon&quot;, &quot;Hjelp&quot;, &quot;Hjelpdiskusjon&quot;, &quot;Kategori&quot;, &quot;Kategoridiskusjon&quot;];
        case &quot;no&quot;: return [&quot;Medium&quot;, &quot;Spesial&quot;, &quot;Diskusjon&quot;, &quot;Bruker&quot;, &quot;Brukerdiskusjon&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia-diskusjon&quot;, &quot;Bilde&quot;, &quot;Bildediskusjon&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki-diskusjon&quot;, &quot;Mal&quot;, &quot;Maldiskusjon&quot;, &quot;Hjelp&quot;, &quot;Hjelpdiskusjon&quot;, &quot;Kategori&quot;, &quot;Kategoridiskusjon&quot;];
        case &quot;nv&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Naaltsoos baa yinÃ­sht'Ä¯Ì&quot;, &quot;Choinish'Ä¯Ä¯hÃ­&quot;, &quot;Choinish'Ä¯Ä¯hÃ­ baa yinÃ­sht'Ä¯Ì&quot;, &quot;WikiibÃ­Ã­diiya&quot;, &quot;WikiibÃ­Ã­diiya baa yinÃ­sht'Ä¯Ì&quot;, &quot;E'elyaaÃ­gÃ­Ã­&quot;, &quot;E'elyaaÃ­gÃ­Ã­ baa yinÃ­sht'Ä¯Ì&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki baa yinÃ­sht'Ä¯Ì&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;AnÃ¡'Ã¡lwo'&quot;, &quot;AnÃ¡'Ã¡lwo' baa yinÃ­sht'Ä¯Ì&quot;, &quot;T'Ã¡Ã¡Å‚Ã¡hÃ¡gi Ã¡t'Ã©ego&quot;, &quot;T'Ã¡Ã¡Å‚Ã¡hÃ¡gi Ã¡t'Ã©ego baa yinÃ­sht'Ä¯Ì&quot;];
        case &quot;oc&quot;: return [&quot;Especial&quot;, &quot;Discutir&quot;, &quot;Utilisator&quot;, &quot;Discutida Utilisator&quot;, &quot;OiquipediÃ &quot;, &quot;Discutida OiquipediÃ &quot;, &quot;Image&quot;, &quot;Discutida Image&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Media&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;os&quot;: return [&quot;Media&quot;, &quot;Ð¡Ã¦Ñ€Ð¼Ð°Ð³Ð¾Ð½Ð´&quot;, &quot;Ð”Ð¸ÑÐºÑƒÑÑÐ¸&quot;, &quot;ÐÑ€Ñ…Ð°Ð¹Ã¦Ð³&quot;, &quot;ÐÑ€Ñ…Ð°Ð¹Ã¦Ð´Ð¶Ñ‹ Ð´Ð¸ÑÐºÑƒÑÑÐ¸&quot;, &quot;Wikipedia&quot;, &quot;0&quot;, &quot;ÐÑ‹Ð²&quot;, &quot;ÐÑ‹Ð²Ñ‹ Ñ‚Ñ‹Ñ…Ñ…Ã¦Ð¹ Ð´Ð¸ÑÐºÑƒÑÑÐ¸&quot;, &quot;MediaWiki&quot;, &quot;Ð”Ð¸ÑÐºÑƒÑÑÐ¸ MediaWiki&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Ñ‚Ñ‹Ñ…Ñ…Ã¦Ð¹ Ð´Ð¸ÑÐºÑƒÑÑÐ¸&quot;, &quot;Ã†Ñ…Ñ…ÑƒÑ‹Ñ&quot;, &quot;Ã†Ñ…Ñ…ÑƒÑ‹ÑÑ‹ Ñ‚Ñ‹Ñ…Ñ…Ã¦Ð¹ Ð´Ð¸ÑÐºÑƒÑÑÐ¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹Ñ‹ Ñ‚Ñ‹Ñ…Ñ…Ã¦Ð¹ Ð´Ð¸ÑÐºÑƒÑÑÐ¸&quot;];
        case &quot;pa&quot;: return [&quot;à¨®à©€à¨¡à©€à¨†&quot;, &quot;à¨–à¨¾à¨¸&quot;, &quot;à¨šà¨°à¨šà¨¾&quot;, &quot;à¨®à©ˆà¨‚à¨¬à¨°&quot;, &quot;à¨®à©ˆà¨‚à¨¬à¨° à¨šà¨°à¨šà¨¾&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia à¨šà¨°à¨šà¨¾&quot;, &quot;à¨¤à¨¸à¨µà©€à¨°&quot;, &quot;à¨¤à¨¸à¨µà©€à¨° à¨šà¨°à¨šà¨¾&quot;, &quot;à¨®à©€à¨¡à©€à¨†à¨µà¨¿à¨•à¨¿&quot;, &quot;à¨®à©€à¨¡à©€à¨†à¨µà¨¿à¨•à¨¿ à¨šà¨°à¨šà¨¾&quot;, &quot;à¨¨à¨®à©‚à¨¨à¨¾&quot;, &quot;à¨¨à¨®à©‚à¨¨à¨¾ à¨šà¨°à¨šà¨¾&quot;, &quot;à¨®à¨¦à¨¦&quot;, &quot;à¨®à¨¦à¨¦ à¨šà¨°à¨šà¨¾&quot;, &quot;à¨¸à¨¼à©à¨°à©‡à¨£à©€&quot;, &quot;à¨¸à¨¼à©à¨°à©‡à¨£à©€ à¨šà¨°à¨šà¨¾&quot;];
        case &quot;pl&quot;: return [&quot;Media&quot;, &quot;Specjalna&quot;, &quot;Dyskusja&quot;, &quot;Wikipedysta&quot;, &quot;Dyskusja Wikipedysty&quot;, &quot;Wikipedia&quot;, &quot;Dyskusja Wikipedii&quot;, &quot;Grafika&quot;, &quot;Dyskusja grafiki&quot;, &quot;MediaWiki&quot;, &quot;Dyskusja MediaWiki&quot;, &quot;Szablon&quot;, &quot;Dyskusja szablonu&quot;, &quot;Pomoc&quot;, &quot;Dyskusja pomocy&quot;, &quot;Kategoria&quot;, &quot;Dyskusja kategorii&quot;, &quot;Portal&quot;, &quot;Dyskusja portalu&quot;];
        case &quot;pt&quot;: return [&quot;Media&quot;, &quot;Especial&quot;, &quot;DiscussÃ£o&quot;, &quot;UsuÃ¡rio&quot;, &quot;UsuÃ¡rio DiscussÃ£o&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia DiscussÃ£o&quot;, &quot;Imagem&quot;, &quot;Imagem DiscussÃ£o&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki DiscussÃ£o&quot;, &quot;PredefiniÃ§Ã£o&quot;, &quot;PredefiniÃ§Ã£o DiscussÃ£o&quot;, &quot;Ajuda&quot;, &quot;Ajuda DiscussÃ£o&quot;, &quot;Categoria&quot;, &quot;Categoria DiscussÃ£o&quot;];
        case &quot;ro&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;DiscuÅ£ie&quot;, &quot;Utilizator&quot;, &quot;DiscuÅ£ie Utilizator&quot;, &quot;Wikipedia&quot;, &quot;DiscuÅ£ie Wikipedia&quot;, &quot;Imagine&quot;, &quot;DiscuÅ£ie Imagine&quot;, &quot;MediaWiki&quot;, &quot;DiscuÅ£ie MediaWiki&quot;, &quot;Format&quot;, &quot;DiscuÅ£ie Format&quot;, &quot;Ajutor&quot;, &quot;DiscuÅ£ie Ajutor&quot;, &quot;Categorie&quot;, &quot;DiscuÅ£ie Categorie&quot;];
        case &quot;ru&quot;: return [&quot;ÐœÐµÐ´Ð¸Ð°&quot;, &quot;Ð¡Ð»ÑƒÐ¶ÐµÐ±Ð½Ð°Ñ&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ&quot;, &quot;Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸Ðº&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°&quot;, &quot;Ð’Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ñ&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð’Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ð¸&quot;, &quot;Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ&quot;, &quot;MediaWiki&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ MediaWiki&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°&quot;, &quot;Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ&quot;, &quot;ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸&quot;];
        case &quot;sc&quot;: return [&quot;Speciale&quot;, &quot;ContiÃ¨ndha&quot;, &quot;Utente&quot;, &quot;Utente discussioni&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia discussioni&quot;, &quot;ImmÃ gini&quot;, &quot;ImmÃ gini contiÃ¨ndha&quot;, &quot;Media&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;sk&quot;: return [&quot;MÃ©diÃ¡&quot;, &quot;Å peciÃ¡lne&quot;, &quot;Diskusia&quot;, &quot;Redaktor&quot;, &quot;Diskusia s redaktorom&quot;, &quot;WikipÃ©dia&quot;, &quot;Diskusia k WikipÃ©dii&quot;, &quot;ObrÃ¡zok&quot;, &quot;Diskusia k obrÃ¡zku&quot;, &quot;MediaWiki&quot;, &quot;Diskusia k MediaWiki&quot;, &quot;Å ablÃ³na&quot;, &quot;Diskusia k Å¡ablÃ³ne&quot;, &quot;Pomoc&quot;, &quot;Diskusia k pomoci&quot;, &quot;KategÃ³ria&quot;, &quot;Diskusia ku kategÃ³rii&quot;];
        case &quot;sl&quot;: return [&quot;Media&quot;, &quot;Posebno&quot;, &quot;Pogovor&quot;, &quot;Uporabnik&quot;, &quot;UporabniÅ¡ki pogovor&quot;, &quot;Wikipedija&quot;, &quot;Pogovor k Wikipediji&quot;, &quot;Slika&quot;, &quot;Pogovor k sliki&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;sq&quot;: return [&quot;Media&quot;, &quot;Speciale&quot;, &quot;Diskutim&quot;, &quot;PÃ«rdoruesi&quot;, &quot;PÃ«rdoruesi diskutim&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia diskutim&quot;, &quot;Figura&quot;, &quot;Figura diskutim&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskutim&quot;, &quot;Stampa&quot;, &quot;Stampa diskutim&quot;, &quot;NdihmÃ«&quot;, &quot;NdihmÃ« diskutim&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;sr&quot;: return [&quot;Media&quot;, &quot;ÐŸÐ¾ÑÐµÐ±Ð½Ð¾&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€&quot;, &quot;ÐšÐ¾Ñ€Ð¸ÑÐ½Ð¸Ðº&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ ÑÐ° ÐºÐ¾Ñ€Ð¸ÑÐ½Ð¸ÐºÐ¾Ð¼&quot;, &quot;Ð’Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ñ˜Ð°&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ Ð’Ð¸ÐºÐ¸Ð¿ÐµÐ´Ð¸Ñ˜Ð¸&quot;, &quot;Ð¡Ð»Ð¸ÐºÐ°&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ ÑÐ»Ð¸Ñ†Ð¸&quot;, &quot;ÐœÐµÐ´Ð¸Ñ˜Ð°Ð’Ð¸ÐºÐ¸&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ ÐœÐµÐ´Ð¸Ñ˜Ð°Ð’Ð¸ÐºÐ¸Ñ˜Ñƒ&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ&quot;, &quot;ÐŸÐ¾Ð¼Ð¾Ñ›&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ Ð¿Ð¾Ð¼Ð¾Ñ›Ð¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ˜Ð°&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ˜Ð¸&quot;, &quot;ÐŸÐ¾Ñ€Ñ‚Ð°Ð»&quot;, &quot;Ð Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ð¾ Ð¿Ð¾Ñ€Ñ‚Ð°Ð»Ñƒ&quot;];
        case &quot;sv&quot;: return [&quot;Media&quot;, &quot;Special&quot;, &quot;Diskussion&quot;, &quot;AnvÃ¤ndare&quot;, &quot;AnvÃ¤ndardiskussion&quot;, &quot;Wikipedia&quot;, &quot;Wikipediadiskussion&quot;, &quot;Bild&quot;, &quot;Bilddiskussion&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki diskussion&quot;, &quot;Mall&quot;, &quot;Malldiskussion&quot;, &quot;HjÃ¤lp&quot;, &quot;HjÃ¤lp diskussion&quot;, &quot;Kategori&quot;, &quot;Kategoridiskussion&quot;];
        case &quot;ta&quot;: return [&quot;à®Šà®Ÿà®•à®®à¯&quot;, &quot;à®šà®¿à®±à®ªà¯à®ªà¯&quot;, &quot;à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®ªà®¯à®©à®°à¯&quot;, &quot;à®ªà®¯à®©à®°à¯ à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®ªà®Ÿà®¿à®®à®®à¯&quot;, &quot;à®ªà®Ÿà®¿à®®à®ªà¯ à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®®à¯€à®Ÿà®¿à®¯à®¾à®µà®¿à®•à¯à®•à®¿&quot;, &quot;à®®à¯€à®Ÿà®¿à®¯à®¾à®µà®¿à®•à¯à®•à®¿ à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®µà®¾à®°à¯à®ªà¯à®ªà¯à®°à¯&quot;, &quot;à®µà®¾à®°à¯à®ªà¯à®ªà¯à®°à¯ à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®‰à®¤à®µà®¿&quot;, &quot;à®‰à®¤à®µà®¿ à®ªà¯‡à®šà¯à®šà¯&quot;, &quot;à®ªà®•à¯à®ªà¯à®ªà¯&quot;, &quot;à®ªà®•à¯à®ªà¯à®ªà¯ à®ªà¯‡à®šà¯à®šà¯&quot;];
        case &quot;th&quot;: return [&quot;Media&quot;, &quot;à¸žà¸´à¹€à¸¨à¸©&quot;, &quot;à¸žà¸¹à¸”à¸„à¸¸à¸¢&quot;, &quot;à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰&quot;, &quot;à¸„à¸¸à¸¢à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia talk&quot;, &quot;à¸ à¸²à¸ž&quot;, &quot;à¸„à¸¸à¸¢à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸ à¸²à¸ž&quot;, &quot;MediaWiki&quot;, &quot;à¸„à¸¸à¸¢à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š MediaWiki&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;];
        case &quot;tlh&quot;: return [&quot;Doch&quot;, &quot;le'&quot;, &quot;ja'chuq&quot;, &quot;lo'wI'&quot;, &quot;lo'wI' ja'chuq&quot;, &quot;wIqIpe'DIya&quot;, &quot;wIqIpe'DIya ja'chuq&quot;, &quot;nagh beQ&quot;, &quot;nagh beQ ja'chuq&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki ja'chuq&quot;, &quot;chen'ay'&quot;, &quot;chen'ay' ja'chuq&quot;, &quot;QaH&quot;, &quot;QaH ja'chuq&quot;, &quot;Segh&quot;, &quot;Segh ja'chuq&quot;];
        case &quot;tr&quot;: return [&quot;Media&quot;, &quot;Ã–zel&quot;, &quot;TartÄ±ÅŸma&quot;, &quot;KullanÄ±cÄ±&quot;, &quot;KullanÄ±cÄ± mesaj&quot;, &quot;Vikipedi&quot;, &quot;Vikipedi tartÄ±ÅŸma&quot;, &quot;Resim&quot;, &quot;Resim tartÄ±ÅŸma&quot;, &quot;MedyaViki&quot;, &quot;MedyaViki tartÄ±ÅŸma&quot;, &quot;Åžablon&quot;, &quot;Åžablon tartÄ±ÅŸma&quot;, &quot;YardÄ±m&quot;, &quot;YardÄ±m tartÄ±ÅŸma&quot;, &quot;Kategori&quot;, &quot;Kategori tartÄ±ÅŸma&quot;];
        case &quot;tt&quot;: return [&quot;Media&quot;, &quot;Maxsus&quot;, &quot;BÃ¤xÃ¤s&quot;, &quot;Ã„ÄŸzÃ¤&quot;, &quot;Ã„ÄŸzÃ¤ bÃ¤xÃ¤se&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia bÃ¤xÃ¤se&quot;, &quot;RÃ¤sem&quot;, &quot;RÃ¤sem bÃ¤xÃ¤se&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki bÃ¤xÃ¤se&quot;, &quot;ÃœrnÃ¤k&quot;, &quot;ÃœrnÃ¤k bÃ¤xÃ¤se&quot;, &quot;YÃ¤rdÃ¤m&quot;, &quot;YÃ¤rdÃ¤m bÃ¤xÃ¤se&quot;, &quot;TÃ¶rkem&quot;, &quot;TÃ¶rkem bÃ¤xÃ¤se&quot;];
        case &quot;uk&quot;: return [&quot;ÐœÐµÐ´Ñ–Ð°&quot;, &quot;Ð¡Ð¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ñ–&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ&quot;, &quot;ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°&quot;, &quot;Wikipedia&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Wikipedia&quot;, &quot;Ð—Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ&quot;, &quot;MediaWiki&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ MediaWiki&quot;, &quot;Ð¨Ð°Ð±Ð»Ð¾Ð½&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ&quot;, &quot;Ð”Ð¾Ð²Ñ–Ð´ÐºÐ°&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð´Ð¾Ð²Ñ–Ð´ÐºÐ¸&quot;, &quot;ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ñ–Ñ&quot;, &quot;ÐžÐ±Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ñ–Ñ—&quot;];
        case &quot;vi&quot;: return [&quot;PhÆ°Æ¡ng tiá»‡n&quot;, &quot;Äáº·c biá»‡t&quot;, &quot;Tháº£o luáº­n&quot;, &quot;ThÃ nh viÃªn&quot;, &quot;Tháº£o luáº­n ThÃ nh viÃªn&quot;, &quot;Wikipedia&quot;, &quot;Tháº£o luáº­n Wikipedia&quot;, &quot;HÃ¬nh&quot;, &quot;Tháº£o luáº­n HÃ¬nh&quot;, &quot;MediaWiki&quot;, &quot;Tháº£o luáº­n MediaWiki&quot;, &quot;TiÃªu báº£n&quot;, &quot;Tháº£o luáº­n TiÃªu báº£n&quot;, &quot;Trá»£ giÃºp&quot;, &quot;Tháº£o luáº­n Trá»£ giÃºp&quot;, &quot;Thá»ƒ loáº¡i&quot;, &quot;Tháº£o luáº­n Thá»ƒ loáº¡i&quot;];
        case &quot;wa&quot;: return [&quot;Media&quot;, &quot;SipeciÃ¥s&quot;, &quot;Copene&quot;, &quot;Uzeu&quot;, &quot;Uzeu copene&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia copene&quot;, &quot;ImÃ¥dje&quot;, &quot;ImÃ¥dje copene&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki copene&quot;, &quot;Modele&quot;, &quot;Modele copene&quot;, &quot;Aidance&quot;, &quot;Aidance copene&quot;, &quot;Categoreye&quot;, &quot;Categoreye copene&quot;];
    }
    return null;
}

$wikins.createMap = function(k,v) {
    var r = {&quot;&quot; : &quot;&quot;};
    for (var i = 0; i &lt; k.length; ++i) {
        r[k[i]] = v[i];
    }
    return r;
}

$wikins.init = function() {
    // This works only on Wikimedia-style URLs.  Failsafe is English.
    var lang = window.location.host.split('.')[0];
    var ns = $wikins.getNS(lang) || $wikins.namespacesEnglish;

    $wikins.namespaces = $wikins.createMap(
        ns, $wikins.namespacesEnglish);
    $wikins.namespaceNames = $wikins.createMap(
        $wikins.namespacesEnglish, ns);

    for (var k in $wikins.namespaceNames) {
        $wikins[k.replace(/ /g,'_')] = $wikins.namespaceNames[k];
    }
}

$wikins.nsjoin = function(ns, article) {
    if (ns == &quot;&quot;) return article;
    else return ns + ':' + article;
}

// TODO: this only applies for Wikimedia servers
$wikins.interwiki = 'ab|aa|af|ak|sq|als|am|ang|ar|an|arc|hy|roa-rup|as|ast|av|ay|az|bm|ba|eu|be|bn|bh|bi|bs|br|bg|my|ca|ch|ce|chr|chy|ny|zh|zh-tw|zh-cn|cho|cv|kw|co|cr|hr|cs|da|dv|nl|dz|en|eo|et|ee|fo|fj|fi|fr|fy|ff|gl|ka|de|got|el|kl|gn|gu|ht|ha|haw|he|hz|hi|ho|hu|is|io|ig|id|ia|ie|iu|ik|ga|it|ja|jv|kn|kr|csb|ks|kk|km|ki|rw|rn|tlh|kv|kg|ko|kj|ku|ky|lo|la|lv|li|ln|lt|jbo|nds|lg|lb|mk|mg|ms|ml|mt|gv|mi|minnan|mr|mh|zh-min-nan|mo|mn|mus|nah|na|nv|ne|se|no|nn|oc|or|om|pi|fa|pl|pt|pa|ps|qu|ro|rm|ru|sm|sg|sa|sc|gd|sr|sh|st|tn|sn|scn|simple|sd|si|sk|sl|so|st|es|su|sw|ss|sv|tl|ty|tg|ta|tt|te|th|bo|ti|tpi|to|tokipona|ts|tum|tr|tk|tw|uk|ur|ug|uz|ve|vi|vo|wa|cy|wo|xh|ii|yi|yo|za|zu';

$wikins.init();

/****************************************************************************
 * END wikins.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikipage.js
 ****************************************************************************/

// $Id: wikipage.js 1243 2006-02-24 13:05:03Z quarl $

// wikipage.js - &quot;WikiPage&quot; class for page name, etc. functionality
//   Has i18n support.

// Suppose we are editing [[Template talk:Foo bar 'blah']].
//   wikiDoc.editingP:             true;
//   ...

// wikiPage is a pre-initialized global variable using the current page's canonical URL.
// It uses the &quot;Retrieved from&quot; page hyperlink which is robust against redirections, editing, special characters, special pages.
//
//   wikiPage.url:         &quot;http://en.wikipedia.org/wiki/Template_talk:Foo_bar_%27blah%27&quot;
//   wikiPage.qurl:        &quot;http://en.wikipedia.org/w/index.php?title=Template_talk:Foo_bar_%27blah%27&quot;
//   wikiPage.page:        &quot;Template talk:Foo bar 'blah'&quot;
//   wikiPage.article:     &quot;Foo bar 'blah'&quot;
//   wikiPage.namespace:   &quot;Template talk&quot; // always the English version
//   wikiPage.namespaceNT: &quot;Template&quot;
//   wikiPage.talkP:       true
//   wikiPage.nsTemplateP: true
//   wikiPage.nsMainP:     false
//   wikiPage.nsUserP:     false
//   wikiPage.nsCategoryP: false
//   wikiPage.nsSpecialP:  false
//   wikiPage.nsProjectP:  false    // (namespace &quot;Wikipedia&quot;)

// To create new WikiPage object from a URL:
//   var wp = new WikiPage(&quot;http://en.wikipedia.org/wiki/Article_Name&quot;);
// To create a new WikiPage object from a page name:
//   var wp = new WikiPage(null, 'Article Name');

// TODO: generalize code to other languages

var $wikipage = new Module('wikipage.js');
$wikipage.depend('util.js', 'wikins.js');

var WikiPage = $wikipage.WikiPage = function(url, page, doc, usafe) {
    if (!(this instanceof WikiPage)) {
        var wp= new WikiPage(url, page, doc, usafe);
        if (wp.failed) return null;
        return wp;
    }
    this.doc = doc;
    var extraParams;
    if (url) {
        url = &quot;&quot; + url;
        if (url.match( '^(?:http://'+WikiPage.server+')?/wiki/')) {
            this.pageQuoted = RegExp.rightContext;
        } else if (url.match( '^(?:http://'+WikiPage.server+')?/w/index\\.php\\?title=([^&amp;=+]+)(.*)')) {
            this.pageQuoted = RegExp.$1;
            extraParams = RegExp.$2;
        } else {
            if (usafe) { this.failed=1; return null; }
            return $wikipage.error(&quot;Couldn't parse page name from url '&quot;+url+&quot;' (error 3a9483df-fc14-419f-8b0b-6e00bb4a6d12)&quot;);
        }
        this.pageQuoted = $util.removeAnchor(this.pageQuoted);
        this.page = $util.wpaDecode(this.pageQuoted);
    } else if (page) {
        this.page = $util.removeAnchor(page.replace(/_/g, ' '));
        this.pageQuoted = $util.wpaEscape(page);
    } else {
        return $wikipage.error(&quot;must specify url or page (12af0703-eeba-4d70-87dd-06e10c26dbf8)&quot;);
    }

    // this is the requested oldid for the page, if present
    this.oldid = extraParams &amp;&amp; extraParams.match(/&amp;oldid=([0-9]+)/) &amp;&amp; RegExp.$1;
// XXX TODO this doesn't work right now for window.wikiPage because we use
// canonical URL, not window.location
// maybe we should create another class that wraps WikiPage

    this.url = 'http://'+WikiPage.server+'/wiki/' + this.pageQuoted;
    this.qurl = 'http://'+WikiPage.server+'/w/index.php?title=' + this.pageQuoted;

    if (this.oldid) {
        this.qurl += '&amp;oldid=' + this.oldid;
    }

    // Get term on the left of &quot;:&quot;.  Not any string is a namespace though, only certain hardcoded ones!
    if (this.page.match(/:/) &amp;&amp;
        (this.namespace = $wikins.namespaces[RegExp.leftContext]))
    {
        // this.namespace contains the ENGLISH version of the namespace
        this.article = RegExp.rightContext;
    } else {
        this.namespace = ''; // (main)
        this.article = this.page;
    }

    if ($wikins.namespaceNoTalk[this.namespace]) {
        this.talkP = true;
        this.editableP = true;
        this.namespaceNT = $wikins.namespaceNoTalk[this.namespace];
        this.namespaceT = this.namespace;
    } else if ($wikins.namespaceTalk[this.namespace]) {
        this.talkP = false;
        this.editableP = true;
        this.namespaceNT = this.namespace;
        this.namespaceT = $wikins.namespaceTalk[this.namespace];
    } else {
        // this should be a namespace with no corresponding Talk namespace,
        // i.e. Media or Special
        this.talkP = false;
        this.editableP = false;
        this.namespaceNT = this.namespace;
        this.namespaceT = null;
    }

    if (this.article.match(/\//)) {
        this.superarticle = RegExp.leftContext;
        this.subarticle = RegExp.rightContext;
    } else {
        this.superarticle = this.article;
        this.subarticle = '';
    }

    this.nsMainP = (this.namespaceNT == '');
    this.nsMediaP = (this.namespaceNT == 'Media');
    this.nsSpecialP = (this.namespaceNT == 'Special');
    this.nsUserP = (this.namespaceNT == 'User');
    this.nsPortalP = (this.namespaceNT == 'Portal');
    this.nsImageP = (this.namespaceNT == 'Image');
    this.nsMediaWikiP = (this.namespaceNT == 'MediaWiki');
    this.nsTemplateP = (this.namespaceNT == 'Template');
    this.nsHelpP = (this.namespaceNT == 'Help');
    this.nsCategoryP = (this.namespaceNT == 'Category');
    this.nsProjectP = (this.namespaceNT == 'Wikipedia');

    // remember, this.namespace is in English, but WikiPage argument is the
    // localized wikimarkup name
    this.talkPage = function() {
        if (this.talkP) { return this; }
        if (this.namespaceT == null) return null;
        var ns = $wikins.namespaceNames[this.namespaceT];
        return new WikiPage(null, $wikins.nsjoin(ns, this.article));
    }

    this.notalkPage = function() {
        if (!this.talkP) { return this; }
        var ns = $wikins.namespaceNames[this.namespaceNT];
        return new WikiPage(null, $wikins.nsjoin(ns, this.article));
    }

    this.sandboxP     = Boolean(this.page.match(/sandbox$/i));

    this.setDoc = function(doc) {
        var wd = new WikiDocument(doc, this);

        if (wd.editingP) {
            this.editDoc = wd;
        } else {
            this.viewDoc = wd;
        }

        this.wd = wd;
    }

    if (doc) {
        // Note that a WikiPage may have more than one associated WikiDocument,
        // e.g. one from viewing and one from editing
        this.setDoc(doc);
    }

    this.relevantUser = $wikipage.getRelevantUser0(this, extraParams);
    // TODO: if relevantUser was from extraParams, we need to fixup
    // page/pageQuoted

    return this;
}

WikiPage.prototype.toString = function() {
    return 'WikiPage(null,' + $util.stringQuoteEscape(this.page) + ')';
}


/*
&lt;div class=&quot;printfooter&quot;&gt;
Retrieved from &quot;&lt;a href=&quot;http://en.wikipedia.org/wiki/Albert_Einstein&quot;&gt;http://en.wikipedia.org/wiki/Albert_Einstein&lt;/a&gt;&quot;&lt;/div&gt;
*/


$wikipage.getCanonPageURL0 = function() {
    // for 'Special' pages, use location.href, because the &quot;retrieved from&quot;
    // note doesn't include the sub-page or target
    if (window.location.pathname.match('^/wiki/' + $wikins.Special + ':') ||
        window.location.href.match('/w/index\\.php\\?title=' + $wikins.Special + ':'))
    {
        return window.location.href;
    } else {
        return  $wikipage.getCanonPageURL1();
    }
}

// the &quot;retrieved from&quot; text contains the canonical article URL (even if we're
// looking at an edit or history page)
$wikipage.getCanonPageURL1 = function() {
    return $util.getElementsByClass(&quot;printfooter&quot;, null, 'div')[0].getElementsByTagName('a')[0].href;
}

var WikiDocument = $wikipage.WikiDocument = function(doc, wp) {
    this.doc = doc;
    this.wp = wp;

    this.username     = $wikipage.getUsername0(doc);

    // Note: can't use &quot;doc.editform&quot; or &quot;doc.forms.editform&quot;, because 'doc'
    // might actually be an XMLDocument (not HTMLDocument), if this is the
    // result of an XMLHTTPRequest.
    this.editForm     = doc.getElementById('editform');
    this.editingP     = Boolean(this.editForm);
    // obsolete method: document.title.match(/^Editing /)
    this.protectedP   = Boolean(doc.getElementById(&quot;ca-viewsource&quot;));
    this.newSectionP  = this.editForm &amp;&amp; (this.editForm.wpSection.value == &quot;new&quot;);
    this.movePageP    = Boolean(doc.getElementById(&quot;movepage&quot;));
    this.previewP     = Boolean(doc.getElementById(&quot;wikiPreview&quot;));
    this.historyP     = Boolean(doc.getElementById(&quot;pagehistory&quot;));
    this.permalinkP   = Boolean(doc.getElementById(&quot;t-ispermalink&quot;));

    // this is the revision id for this document, which always exists for
    // saved pages, even if we're looking at a 'latest version' URL.
    this.oldid        = $wikipage.getOldid0(doc, this.permalinkP);
}

$wikipage.getUsername0 = function(doc) {
    // read username from pt-userpage link.
    // &lt;li id=&quot;pt-userpage&quot;&gt;&lt;a href=&quot;/wiki/User:Quarl&quot;&gt;Quarl&lt;/a&gt;&lt;/li&gt;
    return doc.getElementById('pt-userpage').getElementsByTagName('a')[0].text;
}

$wikipage.getUsernameFromLink = function(link) {
    return link &amp;&amp; (new WikiPage(link)).relevantUser;
}

$wikipage.getRelevantUser0 = function(wp, extraParams) {
    if (wp.nsUserP) return wp.superarticle;
    if (wp.nsSpecialP) {
        if (wp.superarticle == 'Contributions' ||
            wp.superarticle == 'Emailuser' ||
            wp.superarticle == 'Blockip'
            )
        {
            // e.g. /w/index.php?title=Special:Contributions&amp;target=foo
            if (extraParams &amp;&amp; extraParams.match(/&amp;target=([^&amp;=+]+)/)) {
                var u = RegExp.$1;
            } else {
                var u = wp.subarticle;
            }

            // Special:Contributions/newbies is a magic username
            if (u == 'newbies') return null;
            return u;
        }
        // TODO: return current user if Watchlist?
        // TODO: /w/index.php?title=Special:Log&amp;user=Quarl
    }

    return null;

    // if (doc &amp;&amp; wp.page == 'Special:Contributions') {
    //     var cdiv = doc.getElementById('contentSub');
    //     if (cdiv.textContent == &quot;For newbies&quot;) return null;
    //     return $wikipage.getUsernameFromLink(cdiv.getElementsByTagName('a')[0]);
    // }
}

// Get the oldid (&quot;permalink&quot;) for the current page.
// Note that we can't get oldid for editing pages, special pages, etc.
$wikipage.getOldid0 = function(doc, perm) {
    var tagid = perm ? 'ca-edit' : 't-permalink';
    var tag = doc.getElementById(tagid);
    if (!tag) return null;
    var href = tag.getElementsByTagName(&quot;a&quot;)[0].href;
    if (!href) return null;
    href.match(/&amp;oldid=([0-9]+)/);
    return RegExp.$1;
}

$wikipage.getQueryVars0 = function(){
    var res = [];
    var queryStr = window.location.search.substring(1);
    if (queryStr) {
        var pairs = queryStr.split(&quot;&amp;&quot;);
        for(var i=0; i &lt; pairs.length; i++){
            var pair = pairs[i].split(&quot;=&quot;);
            res[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
        }
    }
    // default nulls to avoid 'undefined property' warnings for commonly
    // checked properties
    if (!res.fakeaction) res.fakeaction = null;
    return res;
}

$wikipage.getDbName0 = function(server) {
    switch(server) {
        case 'commons.wikimedia.org': return 'commonswiki';
        case 'en.wiktionary.org': return 'enwiktionary';
    }
    if (server.match(/^([a-z][a-z])[.]wikipedia[.]org$/)) {
        return RegExp.$1 + 'wiki';
    }
    if (server.match(/^([a-z][a-z])[.]wikisource[.]org$/)) {
        return RegExp.$1 + 'wikisource';
    }
    $wikipage.error(&quot;unknown server, couldn't figure out dbname (error 3b448857-7545-4187-8959-d80b1cd8149b)&quot;);
    return 'enwiki';
}

$wikipage.load = function() {
    WikiPage.server = window.location.host || 'en.wikipedia.org';
    WikiPage.wikimediaWikiP = Boolean(WikiPage.server.match(/wiki([pm]edia|source|books)\.org|wiktionary\.org/));

    WikiPage.dbname = $wikipage.getDbName0(WikiPage.server);

    window.wikiPage = new WikiPage($wikipage.getCanonPageURL0(), null, document);
    window.wikiDoc = wikiPage.wd;

    WikiDocument.queryVars = $wikipage.getQueryVars0();

    $wikipage.debug(&quot;load(): wikiPage=&quot; + wikiPage);
}

$util.addOnloadHook($wikipage.load);

// obsolete method 1:
// function getPname0() {
//     var z=document.getElementById(&quot;content&quot;).childNodes;
//     for (var n=0;n&lt;z.length;n++) {
//         if (z[n].className==&quot;firstHeading&quot;) return z[n].textContent;
//     }
// }

// function getPname1() {
//     var t = getPname0();
//     t = t.replace(/^Editing /,'');
//     t = t.replace(/ \(section\)$/,'');

//     return t;
// }

// obsolete method 2:
//    document.title.substr(0, document.title.lastIndexOf(' - Wikipedia, the free'));


/****************************************************************************
 * END wikipage.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikipageXfd.js
 ****************************************************************************/

// $Id: wikipageXfd.js 1195 2006-02-24 07:38:24Z quarl $

// wikipageXfd.js - extra afd/rfd/tfd/cfd/mfd-related wikipage
// functionality

var $wikipageXfd = new Module('wikipageXfd.js');
$wikipageXfd.depend('wikipage.js', 'datetime.js');

$wikipageXfd.ddNames = { 'afd' : 'Wikipedia:Articles for deletion',
                        'tfd' : 'Wikipedia:Templates for deletion',
                        'ifd' : 'Wikipedia:Images and media for deletion',
                        'cfd' : 'Wikipedia:Categories for deletion',
                        'sfd' : 'Wikipedia:Stub types for deletion',
                        'rfd' : 'Wikipedia:Redirects for deletion',
                        'mfd' : 'Wikipedia:Miscellany for deletion' };

$wikipageXfd._docIsRedirectP = function(doc) {
    var d = doc.getElementById('contentSub');
    return Boolean(d &amp;&amp; d.textContent == 'Redirect page');
}

$wikipageXfd._textIsRedirectP = function(doc) {
    var d = doc.getElementById('wpTextbox1');
    return Boolean(d &amp;&amp; $wikiparse.isRedirect(d.value));
}

// look at content to see whether this is a RFD
WikiPage.prototype._isRedirectP = function() {
    if (this.viewDoc) {
        return $wikipageXfd._docIsRedirectP(this.viewDoc.doc);
    } else if (this.editDoc) {
        return $wikipageXfd._textIsRedirectP(this.editDoc.doc);
    } else {
        // $wikipageXfd.error(&quot;WikiPage._isRedirectP(): error a2ac8317-fbf3-4995-8041-92a638099adc&quot;);
        // return null;
        return false;
    }
}

// Return deletion debate type depending on page type.
//
// Valid types:
//   afd (Articles)
//   tfd (Templates)
//   ifd (Images and media)
//   cfd (Categories)
//   sfd (Stub types)
//   rfd (Redirects)
//   mfd (Miscellaneous)
//
// Note: technically, if this is a Talk page, would have to use MFD; in
// practice if I'm on the talk page, I really mean to do action on non-Talk
// page.
WikiPage.prototype.xfdType = function() {
    if (this._xfd_type) {
    } else if (this.nsMainP) {
        if (this._isRedirectP()) {
            this._xfd_type = 'rfd';
        } else {
            this._xfd_type = 'afd';
        }
    } else if (this.nsCategoryP) {
        this._xfd_type = 'cfd';
    } else if (this.nsTemplateP) {
        if (this.article.match(/-stub$/)) {
            this._xfd_type = 'sfd';
        } else {
            this._xfd_type = 'tfd';
        }
    } else if (this.nsImageP) {
        this._xfd_type = 'ifd';
    } else {
        this._xfd_type = 'mfd';
    }
    return this._xfd_type;
}

// return log page for given date (default today)
function afdLogPage(d) {
    d = d || new Date();
    return new WikiPage(null,'Wikipedia:Articles for deletion/Log/' + $datetime.datestampYYYYMonthD(d));
}

WikiPage.prototype.xfdDebateName = function() {
    var n = $wikipageXfd.ddNames[this.xfdType()];
    if (!n) {
        alert(&quot;## WikiPage.xfdDebateName error 46d7d9a3-e63e-4749-a393-6de9ed6c87fa&quot;);
        return null;
    }

    return n;
}

WikiPage.prototype.afdPage = function() {
    if (this.xfdType() != 'afd') return null;
    return new WikiPage(null, 'Wikipedia:Articles for deletion/' + this.article);
}

WikiPage.prototype.afdPageX = function() {
    // already an AFD page?
    if (this.afdTargetPage()) return this;
    return this.afdPage();
}

WikiPage.prototype.afdTargetPage = function() {
    if (!this.page.match(/^Wikipedia:Articles for deletion\/(.*?)(?: \([0-9]+|2nd nomination|3rd nomination|4th nomination\))?$/)) return null;

    var p = RegExp.$1;
    if (p.match(/^Log\//)) return null;

    return new WikiPage(null, p);
}

WikiPage.prototype.afdLogDate = function() {
    if (!this.page.match(/^Wikipedia:Articles for deletion\/Log\/(.*?)?$/)) return null;
    var d = RegExp.$1;
    return new Date(Date.parse(d));
}

$wikipageXfd._load = function() {
    window.wpAfdTarget = wikiPage.afdTargetPage();
    window.wpAfd = wikiPage.afdPageX();
    window.wpAfdLogDate = wikiPage.afdLogDate();

    window.afdP = Boolean(wpAfdTarget);
    window.afdLogP = Boolean(wpAfdLogDate);
}

$util.addOnloadHook($wikipageXfd._load);


/****************************************************************************
 * END wikipageXfd.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikiedit.js
 ****************************************************************************/

// $Id: wikiedit.js 1156 2006-02-23 13:26:11Z quarl $

// wikiedit.js - functions for automatically editing pages

// synposis:
//     function beginEdit() {
//         wikiPage.getEditorAsync(myPage_edit, data1, data2);
//     }
//     function myPage_edit(editor, data1, data2) {
//         editor.wpTextbox1 += data1;
//         editor.wpSummary += data2;
//         editor.submit();
//

// WikiEditor is a class that facilitates editing and submitting Wikipedia edit forms.
//
// use wp.getEditorAsync() to use the current edit form if available, else download one.
//     - inside the callback, &quot;this&quot; is equivalent to &quot;editor&quot;
//
// available properties:
//     wpTextbox1
//     wpSummary
//     wpMinoredit
//     wpWatchthis
//
// available functions:
//     submitDirect: submit form directly via document.form.submit
//     submitHidden: create a new hidden form, attach to document, and submit
//     submit: submitDirect if possible, else submitHidden
//     submitAsync: asynchronously submit a form via XMLHTTPRequest, and callback result
//     updateForm: update what the user sees and prepare for submitting
//     refuseCreate: if wpTextbox1 is empty, alert and return 'True'
//

// WikiEditor.addSubmitHook adds a hook that's called from all form
// submissions (including asynchronous ones).  For example usage see
// autoreplace.js.
//     WikiEditor.addSubmitHook(function(editor, button) { ... });

// quarl 2006-01-23 initial version

var $wikiedit = new Module('wikiedit.js');
$wikiedit.depend('util.js', 'wikipage.js');
// recommends: smartsubmit.js

// WikiEditor class
//
// A WikiEditor doubles as an associative array of the edit properties -
// i.e. editor.wpTextbox1 contains the edit text.
var WikiEditor = $wikiedit.WikiEditor = function (wd) {
    if (!(this instanceof WikiEditor)) return new WikiEditor(wd);
    window.wikiEditor = this;

    if (!(wd instanceof WikiDocument)) { return $wikiedit.error(&quot;WikiEditor: need a WikiDocument (error 22a8bb3a-80e9-4df4-87c1-8c100b6aebbf)&quot;); }
    this.wd = wd;
    this.wp = wd.wp;
    this.form = WikiEditor.getEditForm(wd.doc);
    if (!this.form) { return $wikiedit.error(&quot;WikiEditor: no form! (error d49dfc77-752c-4064-a5c8-503b635fdc7b)&quot;); }

    // The HTML default maxlength is 200, but the MediaWiki server actually
    // accepts up to 250 chars!
    this.form.wpSummary.setAttribute('maxlength', 250);

    this.refuseCreate = function() {
        if (!this.wpTextbox1) {
            alert(&quot;Error!  Page is empty; refusing to create.&quot;);
            return true;
        } else {
            return false;
        }
    }

    this.getFormParams = function(button) {
        button = WikiEditor._checkButton(button);
        d = {};
        WikiEditor.updateFields(d, this, WikiEditor.wpFormFields);
        d[button] = this.form[button];
        return d;
    }

    this.updateThis = function() {
        WikiEditor.updateFields(this, this.form, WikiEditor.wpFormFields);
    }

    this.updateForm = function() {
        WikiEditor.updateFields(this.form, this, WikiEditor.wpFormFields);
    }

    // Direct submission, should only be used when the form is part of the
    // currently-viewed HTML page.  Navigates to result page.
    this.submitDirect = function(button) {
        button = WikiEditor._checkButton(button);
        this.updateForm();
        // Click the appropriate button.
        // Note that this generates an onClick event, which in turn calls the
        // runPreSubmitHooks function.
        this.form[button].click();
    }

    // Adds a hidden form to the current page and submits it, navigating to
    // the result page.
    this.submitHidden = function(button) {
        button = WikiEditor._checkButton(button);
        this.runPreSubmitHooks(this, button);
        var newform = document.createElement('form');
        $util.addFormHiddenParams(newform, this.getFormParams(button));
        newform.name = this.form.name;
        newform.method = this.form.method;
        newform.id = this.form.id;
        newform.action = this.form.action;
        document.getElementById('bodyContent').appendChild(newform);
        newform.submit();
    }

    // Asynchronously submit the form and call CALLBACK.
    this.submitAsync = function(button, callback) {
        button = WikiEditor._checkButton(button);
        var cb;
        if (callback) {
            var thisE = this;
            var args = $util.copyArray(arguments);
            args.shift(); args[0] = null;
            cb = function(req) { args[0] = req; callback.apply(thisE, args); };
        } else {
            cb = function(req) { /* dummy */ };
        }
        var data = this.getFormParams(button);
        this.runPreSubmitHooks(data, button);
        $util.asyncPostXML(this.form.action, data, cb);
    }

    // copy input fields from form into this object for easy access (we'll copy back later)
    this.updateThis();
    this.wpTextbox1_orig = this.form.wpTextbox1_orig;

    // If this form is the current document's form, we can submit directly.
    // Else we must use the hidden submit method.
    if (this.form == document.editform) {
        this.submit = this.submitDirect;
    } else {
        this.submit = this.submitHidden;
    }

    return this;
}

WikiEditor.getEditForm = function(doc) {
    if (!doc) doc = document;
    // Note: can't use &quot;doc.editform&quot;, because 'doc' might actually be an XMLDocument (not HTMLDocument), if this is the result of an XMLHTTPRequest.
    return doc.getElementById('editform');
}

WikiEditor.wpFormFields = $util.assocArray( [
    'wpSection', 'wpStarttime', 'wpEdittime', 'wpScrolltop',
    'wpTextbox1', 'wpSummary', 'wpMinoredit', 'wpWatchthis',
    'wpEditToken' ] );
WikiEditor.wpButtons = $util.assocArray( [ 'wpSave', 'wpPreview', 'wpDiff' ] );

WikiEditor._checkButton = function(button) {
    if (!button) return 'wpSave';                   // default
    if (typeof button != 'string' || WikiEditor.wpButtons[button] != 1) {
        alert(&quot;## WikiEditor._checkButton: invalid button '&quot;+button+&quot;' (error 1a0655e7-ac83-4f15-8447-694b16a834ed)&quot;);
        return 'wpPreview';
    }
    return button;
}

WikiEditor.updateFields = function(target, source, fields) {
    var targetFormP = Boolean(target.nodeName);
    var sourceFormP = Boolean(source.nodeName);
    for (var i in fields) {
        var f = fields[i];
        var v;
        if (sourceFormP &amp;&amp; source[f]) {
            if (source[f].type == &quot;checkbox&quot;) {
                v = source[f].checked;
            } else {
                v = source[f].value;
            }
        } else {
            v = source[f];
        }
        if (targetFormP) {
            if (target[f].type == &quot;checkbox&quot;) {
                target[f].checked = v;
            } else {
                // don't set it if unchanged, to avoid focus/selection change
                if (target[f].value != v) target[f].value = v;
            }
        } else {
            target[f] = v;
        }
    }
}

// Get an editor for this WikiPage -- it needs to have an editDoc already (as
// an editing window.wikiPage would have); else need to use getEditorAsync().
// Usually it's easier to just always use getEditorAsync.
WikiPage.prototype.getEditor = function() {
    if (!this.editor) {
        if (!this.editDoc) {
            return $wikiedit.error(&quot;WikiPage.getEditor: no editDoc - use getEditorAsync (error 9f4a2c95-b3e0-437e-972d-88290a5bd7ee)&quot;);
        }
        this.editor = WikiEditor(this.editDoc);
    }
    return this.editor;
}

// If already editing the target page, return a WikiEditor now.
// Else, download the edit form first.
// Call-back with new WikiEditor instance.
WikiPage.prototype.getEditorAsync = function(callback) {
    var wp = this;
    var args = $util.copyArray(arguments); // copy arguments because we need it in 'cb' below

    // already cached
    if (wp.editor) {
        args[0] = wp.editor;
        callback.apply(wp.editor, args); return;
    }

    // do we already have an edit document?  (window.wikiPage.editDoc would be
    // initialized to 'WikiDocument(document)' as appropriate).
    if (wp.editDoc) {
        wp.editor = WikiEditor(wp.editDoc);
        args[0] = wp.editor;
        callback.apply(wp.editor, args); return;
    }

    // need to download a new edit document.
    var cb = function(req) {
        if (req.status != 200) {
            alert(&quot;getEditorAsync: Error downloading edit page!&quot;);
            return;
        }

        wp.setDoc(req.responseXML);
        wp.editor = WikiEditor(wp.editDoc);
        args[0] = wp.editor;
        callback.apply(wp.editor, args); return;
    };
    $util.asyncDownloadXML(wp.qurl + '&amp;action=edit', cb);
}

WikiEditor.pre_submit_hooks = [];

// add a submit hook to all forms (including asynchronous ones).
// Submit hooks are called with arguments (editor, form, button)
//   Note that the form argument may not be the same as editor.form or
//   document.form, if the submit is via submitHidden or submitAsync!
WikiEditor.addPreSubmitHook = function(func) {
    WikiEditor.pre_submit_hooks.push(func);
}

WikiEditor.prototype.runPreSubmitHooks = function(data, button) {
    // 'data' should be a hash array and could be either a WikiEditor
    // instance, or a separate object
    for (var i in WikiEditor.pre_submit_hooks) {
        WikiEditor.pre_submit_hooks[i](this, data, button);
    }
}

WikiEditor.onClickSubmitHook = function(button) {
    var editor = wikiPage.getEditor();
    if (editor.form[button].preventPreSumitHook) return;
    editor.updateThis();
    editor.runPreSubmitHooks(editor, button);
    // submit hooks may have changed data.
    editor.updateForm();
}

document.write('&lt;form style=&quot;display: none;&quot; id=&quot;wikiedit_sessionform&quot;&gt;'+
               '&lt;textarea id=&quot;wikiedit_wpTextbox1_orig&quot;&gt;&lt;/textarea&gt;&lt;/form&gt;');

WikiEditor.load = function() {
    if (document.forms.editform) {
        // save original version of edit box.
        // write this to a hidden field (in a separate form) so that we
        // don't lose this data on forward/back.
        var w = document.getElementById('wikiedit_wpTextbox1_orig');
        if (w.value) {
            document.forms.editform.wpTextbox1_orig = w.value;
        } else {
            document.forms.editform.wpTextbox1_orig = w.value = document.forms.editform.wpTextbox1.value;
        }

        // $util.hookEventObj(document.forms.editform, 'submit', WikiEditor.onClickSubmitHook);

        // add submit hooks
        $util.hookEventObj(document.editform.wpSave, 'click', function() { WikiEditor.onClickSubmitHook('wpSave'); });
        $util.hookEventObj(document.editform.wpDiff, 'click', function() { WikiEditor.onClickSubmitHook('wpDiff'); });
        $util.hookEventObj(document.editform.wpPreview, 'click', function() { WikiEditor.onClickSubmitHook('wpPreview'); });
    }
}

$util.addOnloadHook(WikiEditor.load);


/****************************************************************************
 * END wikiedit.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikistate.js
 ****************************************************************************/

// $Id: wikistate.js 371 2006-02-14 08:40:57Z quarl $

// wikistate.js - utilities to keep track of session state

// Session state persists THROUGHOUT THIS SESSION, on THIS PAGE ONLY

// * Currently works with back/forward/refresh, but not with navigating anew.

// Usage:
//     wikistate.set('foo', 123);
//     alert(&quot;foo = &quot; + wikistate.get('foo'));

// quarl 2006-02-05 initial version

var $wikistate = new Module('wikistate.js');

document.write('&lt;form style=&quot;display: none;&quot; id=&quot;wikiState_sessionform&quot;&gt;'+
               '&lt;textarea id=&quot;wikiState_data&quot;&gt;&lt;/textarea&gt;&lt;/form&gt;');

$wikistate._load = function() {
    $wikistate._dataNode = document.getElementById('wikiState_data');
    $wikistate._dataString = $wikistate._dataNode.value || '';
    $wikistate._data = $wikistate._deserialize($wikistate._dataString) || {};
}

$wikistate.save = function() {
    $wikistate._dataString = $wikistate._serialize($wikistate._data);
    $wikistate._dataNode.value = $wikistate._dataString;
}

$wikistate.get = function(varname) {
    return $wikistate._data[varname];
}

$wikistate.set = function(varname, value, nosave) {
    // if (!(value instanceof String)) {
    //     alert(&quot;wikistate error: must be a string (error 5dc01aeb-2fc1-44ca-a0bd-359ec9210f46)&quot;);
    //     return;
    // }
    $wikistate._data[varname] = value;
    if (!nosave) $wikistate.save();
}

$wikistate._serialize = function(dict) {
    return dict.toSource();
    // var r = '';
    // for (var v in dict) {
    //     var value = dict[r];
    //     if (!(value instanceof String)) continue;
    //     r += value+':'+$util.stringQuoteEscape(value);
    // }
}

$wikistate._deserialize = function(s) {
    // since only we can write to the form data, should be safe to evaluate
    // it.
    return eval(s);
}

$util.addOnloadHook($wikistate._load);


/****************************************************************************
 * END wikistate.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autoreplace.js
 ****************************************************************************/

// $Id: autoreplace.js 305 2006-02-14 06:35:23Z quarl $

// autoreplace.js - provides capability to replace strings (regular
// expressions) in edit boxes on submission.
//    Strings between &lt;nowiki&gt; ... &lt;/nowiki&gt; and comments are not replaced.

// external entry points:
//    $autoreplace.addReplacement(&quot;string&quot;, &quot;replacement&quot; || replacement_function);

// quarl 2006-01-04 initial version

var $autoreplace = new Module('autoreplace.js');
$autoreplace.depend('wikipage.js', 'wikiedit.js', 'util.js');
// recommends: smartsubmit.js

$autoreplace.enabled = true;
$autoreplace.replacements = Array();

// add a replacement
$autoreplace.addReplacement = function(str, replacement) {
    $autoreplace.replacements.push([str,replacement]);
}

$autoreplace.fToStr = function(t) {
    if (typeof t == 'function') t = t();
    return &quot;&quot;+t;
}

$autoreplace.replaceString = function(text, str, replacement) {
    return text.replace(new RegExp(str,'g'), replacement);
}

$autoreplace.replaceStringNoNowiki = function(text, str, replacement) {
    var rtext = '';
    while ( text.match(/&lt;nowiki&gt;(?:.|\n)*?&lt;\/nowiki&gt;|&lt;!--(?:.|\n)*?--&gt;/) ) {
        // save these before they get clobbered!
        var left = RegExp.leftContext;
        var match = RegExp.lastMatch;
        var right = RegExp.rightContext;

        rtext += $autoreplace.replaceString(left, str, replacement) + match;
        text = right;
    }
    rtext += $autoreplace.replaceString(text, str, replacement)
    return rtext;
}

$autoreplace.replaceStrings = function(text) {
    if (!text) return text;
    for (i in $autoreplace.replacements) {
        r = $autoreplace.replacements[i];
        text = $autoreplace.replaceStringNoNowiki(text, r[0], $autoreplace.fToStr(r[1]));
    }
    return text;
}

$autoreplace.preSubmitHook = function(editor, data, button) {
    if (!$autoreplace.enabled) return;

    if (!data.wpTextbox1) return;
    data.wpTextbox1 = $autoreplace.replaceStrings(data.wpTextbox1);
}

$autoreplace.load = function() {
    WikiEditor.addPreSubmitHook($autoreplace.preSubmitHook);
}

$util.addOnloadHook($autoreplace.load);


/****************************************************************************
 * END autoreplace.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikiparse.js
 ****************************************************************************/

// $Id: wikiparse.js 1221 2006-02-24 10:30:51Z quarl $

// functions for parsing wikitext

// quarl 2006-02-22 initial version - refactoring from popups.js

var $wikiparse = new Module('wikiparse.js');
$wikiparse.depend('wikipage.js', 'wikins.js');

// this stuff should be customized for different languages

$wikiparse.stubRegex= RegExp('stub[}][}]|This .*-related article is a .*stub', 'im') ;
$wikiparse.disambigRegex=RegExp('([{][{]\\s*disambig|disambig\\s*[}][}]|dab\\s*[}][}])' +
                                '|[{][{]\\s*(geodis)\\s*[}][}]' + // explicit, whole template names on this line
                                '|is a .*disambiguation.*page', 'im') ;

// end of language-specific things

//                      (^|\[\[)image: *([^|\]]*[^|\] ]) *
//                      (^|\[\[)image: *([^|\]]*[^|\] ])([^0-9\]]*([0-9]+) *px)?
//                                                        $4 = 120 as in 120px

$wikiparse.imageRegex= RegExp('(^|\\[\\[)'+
                       $wikins.Image +
                       ': *([^|\\]]*[^|\\] ])([^0-9\\]]*([0-9]+) *px)?',
                       'img') ;
$wikiparse.imageRegexBracketCount = 4;

$wikiparse.categoryRegex= RegExp('\\[\\['+$wikins.Category+
                          ': *([^|\\]]*[^|\\] ]) *', 'i') ;
$wikiparse.categoryRegexBracketCount = 1;

// this could be improved!
$wikiparse.countLinks = function(wikiText) {
    return wikiText.split('[[').length - 1;
};

// if N = # matches, n = # brackets, then
// String.parenSplit(regex) intersperses the N+1 split elements
// with Nn other elements. So total length is
// L= N+1 + Nn = N(n+1)+1. So N=(L-1)/(n+1).

$wikiparse.countImages = function(wikiText) {
    return (wikiText.parenSplit($wikiparse.imageRegex).length - 1) / ($wikiparse.imageRegexBracketCount + 1);
};

$wikiparse.countCategories = function(wikiText) {
    return (wikiText.parenSplit($wikiparse.categoryRegex).length - 1) / ($wikiparse.categoryRegexBracketCount + 1);
};

$wikiparse.isStub = function(data) {
    return $wikiparse.stubRegex.test(data);
};

$wikiparse.isDisambig = function(wp, data) {
    return wp.editableP &amp;&amp; $wikiparse.disambigRegex.test(data);
};

// returns a WikiPage for the first image found in wikitext (with width at
// least minWidth)
$wikiparse.getValidImageFromWikiText = function(wikiText, minWidth) {
    // In imageRegex, we're interested in the second bracketed expression
    // this may change if the regex changes :-(
    $wikiparse.imageRegex.lastIndex=0;
    var match;
    while ( (match = $wikiparse.imageRegex.exec(wikiText)) ) {
        /* now find a sane image name - exclude templates by seeking { */
        var m = match[2];
        var pxWidth=match[4];
        if ( $wikiimg.isValidImageName(m) &amp;&amp; (!pxWidth || parseInt(pxWidth) &gt;= minWidth) ) {
            return WikiPage(null, $wikins.Image+':'+$util.capitalizeFirstChar(m) );
        }
    }
    return null;
};

// returns target of redirect (as string), or null
$wikiparse.isRedirect = function(wikiText)
{
    var m = wikiText.match(/^[ \n]*[#]redirect[:\s]*\[\[([^\|\]]*)(|[^\]]*)?\]\]\s*(.*)/i);
    return m &amp;&amp; m[1];
};

// returns a sorted array of links which aren't special or interwiki
$wikiparse.getLinks = function(wikitext)
{
    var reg = RegExp('\\[\\[([^|]*?)(\\||\\]\\])', 'gi');
    var ret = [];
    var splitted = wikitext.parenSplit(reg);
    var seen = {};
    for (var i=1; i&lt;splitted.length; i=i+3) {
        var link = splitted[i];
        if (!link) continue;
        if (seen[link]) continue;
        seen[link] = 1;
        ret.push(link);
    }

    ret.sort();
    return ret;
}

/****************************************************************************
 * END wikiparse.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN diff.js
 ****************************************************************************/

// $Id: diff.js 937 2006-02-22 06:30:01Z quarl $

// diff.js - utility functions for doing diffs

// quarl 2006-01-29 initial version

/*
 * $diff() is based on http://ejohn.org/projects/javascript-diff-algorithm/
 *   Copyright John Resig
 */

var $diff = new Module('diff.js');
$diff.depend('util.js');

$diff.diff = function(o, n) {
    var ns = {};
    var os = {};

    for ( var i = 0; i &lt; n.length; i++ ) {
        // note we have to check that it is in fact an object with &quot;rows&quot;, in
        // case ns[i] happens to match a javascript member function of class
        // Array, e.g. &quot;some&quot;!
        if ( ns[ n[i] ] == null || !ns[n[i]].rows )
            ns[ n[i] ] = { rows: new Array(), o: null };
        ns[ n[i] ].rows.push( i );
    }

    for ( var i = 0; i &lt; o.length; i++ ) {
        if ( os[ o[i] ] == null || !os[o[i]].rows )
            os[ o[i] ] = { rows: new Array(), n: null };
        os[ o[i] ].rows.push( i );
    }

    for ( var i in ns ) {
        if ( ns[i].rows.length == 1 &amp;&amp; typeof(os[i]) != &quot;undefined&quot; &amp;&amp; os[i].rows.length == 1 ) {
            n[ ns[i].rows[0] ] = { text: n[ ns[i].rows[0] ], row: os[i].rows[0] };
            o[ os[i].rows[0] ] = { text: o[ os[i].rows[0] ], row: ns[i].rows[0] };
        }
    }

    for ( var i = 0; i &lt; n.length - 1; i++ ) {
        if ( n[i].text != null &amp;&amp; n[i+1].text == null &amp;&amp;
             0 &lt;= n[i].row+1 &amp;&amp; n[i].row+1 &lt; o.length &amp;&amp;
             o[ n[i].row + 1 ].text == null &amp;&amp;
             n[i+1] == o[ n[i].row + 1 ] )
        {
            n[i+1] = { text: n[i+1], row: n[i].row + 1 };
            o[n[i].row+1] = { text: o[n[i].row+1], row: i + 1 };
        }
    }

    for ( var i = n.length - 1; i &gt; 0; i-- ) {
        if ( n[i].text != null &amp;&amp; n[i-1].text == null &amp;&amp;
             0 &lt;= n[i].row-1 &amp;&amp; n[i].row-1 &lt; o.length &amp;&amp;
             o[ n[i].row - 1 ].text == null &amp;&amp;
             n[i-1] == o[ n[i].row - 1 ] )
        {
            n[i-1] = { text: n[i-1], row: n[i].row - 1 };
            o[n[i].row-1] = { text: o[n[i].row-1], row: i - 1 };
        }
    }

    return { o: o, n: n };
}

// if more than this many words of changes, use overflow string
$diff.wikisummary_maxwords = 30;
$diff.wikisummary_overflow = &quot;$1 words changed&quot;;

$diff._split = function(s) {
    //return $util.trimSpaces(s).split(/(?:\s|[.,;\'\&quot;`])+/);
    return $util.trimSpaces(s).split(/\s+/);
}

$diff.aggregate = function(words) {
    var phrases = new Array();
    var cur = null;
    var wordcount = 0;

    // start at virtual index -1 to check for removed words at beginning of
    // text
    for ( var i = -1; i &lt; words.n.length; i++ ) {
        if ( i!=-1 &amp;&amp; words.n[i].text == null ) {
            if (!cur) {
                cur = { o: &quot;&quot;, n: &quot;&quot; };
                phrases.push(cur);
            }
            cur.n += &quot; &quot; + words.n[i];
            wordcount ++;
        } else {
            var pre = &quot;&quot;;
            var j = i==-1 ? 0 : words.n[i].row + 1;
            while ( j &lt; words.o.length &amp;&amp; words.o[j].text == null ) {
                pre += &quot; &quot; + words.o[j];
                j++;
                wordcount ++;
            }
            if (pre) {
                if (!cur) {
                    cur = { o: &quot;&quot;, n: &quot;&quot; };
                    phrases.push(cur);
                }
                cur.o += pre;
            }
            if (pre &amp;&amp; words.n[i+1] &amp;&amp; words.n[i+1].text == null) {
                // If there's an addition following, treat this as part of the
                // same change.
            } else {
                cur = null;
            }
        }
    }

    for (var i in phrases) {
        phrases[i].n = $util.trimSpaces(phrases[i].n);
        phrases[i].o = $util.trimSpaces(phrases[i].o);
    }

    return { phrases: phrases, wordcount: wordcount };
}

$diff.wikiQuote = function(s) {
    if (!s) return s;
    if (s.match(/^\{\{.*\}\}$/)) return s;
    s = s.replace(/\&quot;/g, &quot;'&quot;);
    return '&quot;'+s+'&quot;';
}

// trim the equal chars from the front and back of o,n at a word boundary
$diff.stringTrim = function(o, n) {
    var r = $diff.stringTrim0($util.reverseString(o), $util.reverseString(n));
    return $diff.stringTrim0($util.reverseString(r.o), $util.reverseString(r.n));
}

$diff.stringTrim0 = function(o, n) {
    var i = 0;
    while (i &lt; o.length &amp;&amp; i &lt; n.length &amp;&amp; o[i] == n[i]) {
        ++i;
    }

    // find index of last non-word character
    var prefix = o.substr(0, i);

    // if prefix ends with word characters and suffix starts with non-word,
    // then erase entire prefix
    if (prefix.match(/\w$/) &amp;&amp;
        !o.substr(i, 1).match(/^\w/) &amp;&amp; !n.substr(i, 1).match(/^\w/))
    {
        o = o.substr(i);
        n = n.substr(i);
    } else if (prefix.match(/.*\W/)) {
        i = RegExp.lastMatch.length;
        o = o.substr(i);
        n = n.substr(i);
    } else {
        // keep entire prefix
    }
    return { o: o, n: n };
}

$diff.diffSummary = function(o, n) {
    if (o == n) return &quot;&quot;;
    if (!o) {
        return &quot;new (&quot; + $util.wordCount(n) + &quot; words)&quot;;
    }
    if (!n) {
        return &quot;blank (&quot; + $util.wordCount(o) + &quot; words)&quot;;
    }
    var words = $diff.diff( $diff._split(o), $diff._split(n) );
    var r = $diff.aggregate(words);
    if (!r.wordcount) return &quot;&quot;;
    if (r.wordcount &gt; $diff.wikisummary_maxwords) {
        return $diff.wikisummary_overflow.replace('$1', r.wordcount);
    }

    var phrases = r.phrases;
    var str = [];
    for (var i in phrases) {
        var r = $diff.stringTrim(phrases[i].o, phrases[i].n);
        var ro = $diff.wikiQuote(r.o), rn = $diff.wikiQuote(r.n);
        if (ro &amp;&amp; rn) {
            str.push(ro + ' â†’ ' + rn);
        } else if (ro) {
            str.push('-' + ro);
        } else if (rn) {
            str.push('+' + rn);
        } else {
            // alert(&quot;## internal error 15e1b13f-bae3-4399-86c5-721786822fa2&quot;);
        }
    }

    return str.join(&quot;, &quot;);
}


/****************************************************************************
 * END diff.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN kookie.js
 ****************************************************************************/

// $Id: kookie.js 1184 2006-02-23 22:15:03Z quarl $

// kookie.js - cookie functions

// use a kooky name to avoid name clashes since &quot;cookie&quot; is so common
var $kookie = new Module('kookie.js');

$kookie.get = function(name)
{
    var nameEQ = name + &quot;=&quot;;
    var ca = document.cookie.split(';');
    for(var i=0;i &lt; ca.length;i++)
    {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

$kookie.set = function(name, value, days, path)
{
    if (days) {
        var date = new Date();
        date.setTime(date.getTime()+(days*24*60*60*1000));
        var expires = &quot;; expires=&quot;+date.toGMTString();
    }
    else var expires = &quot;&quot;;

    // use path=&quot;&quot; for no path; path=null defaults to root
    if (path == null) path = &quot;/&quot;;
    if (path) path = &quot;; path=&quot;+path;
    else path = &quot;&quot;;

    var newcookie = name + &quot;=&quot; + value + expires + path;
    $kookie.debug(&quot;set(): &quot; + newcookie);
    document.cookie = newcookie;
}

$kookie.erase = function(name)
{
    $kookie.set(name,&quot;&quot;,-1);
}


/****************************************************************************
 * END kookie.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN md5.js
 ****************************************************************************/

// $Id: md5.js 1186 2006-02-23 22:22:33Z quarl $

// md5.js - md5 digest code

// SYNOPSIS: alert($md5.hex_md5(&quot;foo bar&quot;))

// A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
// Digest Algorithm, as defined in RFC 1321.
// Version 2.2-alpha Copyright (C) Paul Johnston 1999 - 2005
// Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
// Distributed under the BSD License
// See http://pajhome.org.uk/crypt/md5 for more info.

// quarl 2006-02-12 refactored OO
// quarl 2006-02-21 padding fixes; b64u functions

var $md5 = new Module('md5.js');

// Configurable variables. You may need to tweak these to be compatible
// with the server-side, but the defaults work in most cases.
$md5.options = {
    hexcase: 0,             // hex output format. 0 - lowercase; 1 - uppercase
    b64pad : &quot;=&quot;       // base-64 pad character. &quot;=&quot; for strict RFC compliance
};

// These are the functions you'll usually want to call.  They take string
// arguments and return either hex or base-64 encoded strings

$md5.hex_md5 = function (s)
{ return $md5.rstr2hex($md5.rstr_md5($md5.str2rstr_utf8(s))); };

$md5.b64_md5  = function (s)
{ return $md5.rstr2b64($md5.rstr_md5($md5.str2rstr_utf8(s))); };

$md5.b64u_md5  = function (s)
{ return $md5.rstr2b64u($md5.rstr_md5($md5.str2rstr_utf8(s))); };

$md5.any_md5  = function (s, e)
{ return $md5.rstr2any($md5.rstr_md5($md5.str2rstr_utf8(s)), e); };

$md5.hex_hmac_md5  = function(k, d)
{ return $md5.rstr2hex($md5.rstr_hmac_md5($md5.str2rstr_utf8(k), $md5.str2rstr_utf8(d))); };

$md5.b64_hmac_md5  = function(k, d)
{ return $md5.rstr2b64($md5.rstr_hmac_md5($md5.str2rstr_utf8(k), $md5.str2rstr_utf8(d))); };

$md5.b64u_hmac_md5  = function(k, d)
{ return $md5.rstr2b64u($md5.rstr_hmac_md5($md5.str2rstr_utf8(k), $md5.str2rstr_utf8(d))); };

$md5.any_hmac_md5  = function(k, d, e)
{ return $md5.rstr2any($md5.rstr_hmac_md5($md5.str2rstr_utf8(k), $md5.str2rstr_utf8(d)), e); };

// Perform a simple self-test to see if the VM is working
$md5.selftest  = function()
{ return $md5.hex_md5(&quot;abc&quot;) == &quot;900150983cd24fb0d6963f7d28e17f72&quot;; };

// Calculate the MD5 of a raw string
$md5.rstr_md5  = function(s)
{
    return $md5.binl2rstr($md5.binl_md5($md5.rstr2binl(s), s.length * 8));
};

// Calculate the HMAC-MD5, of a key and some data (raw strings)
$md5.rstr_hmac_md5  = function(key, data)
{
    var bkey = $md5.rstr2binl(key);
    if (bkey.length &gt; 16) {
        bkey = $md5.binl_md5(bkey, key.length * 8);
    }

    // pad zeros
    for (var i = bkey.length; i &lt; 16; ++i) {
        bkey[i] = 0;
    }

    var ipad = Array(16), opad = Array(16);
    for(var i = 0; i &lt; 16; i++)
    {
        ipad[i] = bkey[i] ^ 0x36363636;
        opad[i] = bkey[i] ^ 0x5C5C5C5C;
    }

    var hash = $md5.binl_md5(ipad.concat($md5.rstr2binl(data)), 512 + data.length * 8);
    return $md5.binl2rstr($md5.binl_md5(opad.concat(hash), 512 + 128));
};

// Convert a raw string to a hex string
$md5.rstr2hex  = function(input)
{
    var hex_tab = $md5.options.hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;
    var output = &quot;&quot;;
    var x;
    for(var i = 0; i &lt; input.length; i++)
    {
        x = input.charCodeAt(i);
        output += (   hex_tab.charAt((x &gt;&gt;&gt; 4) &amp; 0x0F)
                      +  hex_tab.charAt( x        &amp; 0x0F));
    }
    return output;
};

// Convert a raw string to a base-64 string
$md5.rstr2b64  = function(input)
{
    var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;
    var output = &quot;&quot;;
    var len = input.length;
    for(var i = 0; i &lt; len; i += 3)
    {
        var triplet = (input.charCodeAt(i) &lt;&lt; 16)
            | (i + 1 &lt; len ? input.charCodeAt(i+1) &lt;&lt; 8 : 0)
            | (i + 2 &lt; len ? input.charCodeAt(i+2)      : 0);
        for(var j = 0; j &lt; 4; j++)
        {
            if(i * 8 + j * 6 &gt; input.length * 8) output += $md5.options.b64pad;
            else output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-j)) &amp; 0x3F);
        }
    }
    return output;
};

// Convert a raw string to a URL-friendly base-64 string
//
// Uses '*' and '-' as the 63rd and 64th characters, since '/' and '+' have
// special meaning in URLs and would need ugly encoding/decoding.  Does not
// pad with '='.
$md5.rstr2b64u  = function(input)
{
    var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*-&quot;;
    var output = &quot;&quot;;
    var len = input.length;
    for(var i = 0; i &lt; len; i += 3)
    {
        var triplet = (input.charCodeAt(i) &lt;&lt; 16)
            | (i + 1 &lt; len ? input.charCodeAt(i+1) &lt;&lt; 8 : 0)
            | (i + 2 &lt; len ? input.charCodeAt(i+2)      : 0);
        for(var j = 0; j &lt; 4; j++)
        {
            if(i * 8 + j * 6 &gt; input.length * 8) break;
            output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-j)) &amp; 0x3F);
        }
    }
    return output;
};

// Convert a raw string to an arbitrary string encoding
$md5.rstr2any  = function(input, encoding)
{
    var divisor = encoding.length;
    var remainders = Array();
    var i, q, x, quotient;

    /* Convert to an array of 16-bit big-endian values, forming the dividend */
    var dividend = Array(input.length / 2);
    for(i = 0; i &lt; dividend.length; i++)
    {
        dividend[i] = (input.charCodeAt(i * 2) &lt;&lt; 8) | input.charCodeAt(i * 2 + 1);
    }

    /*
     * Repeatedly perform a long division. The binary array forms the dividend,
     * the length of the encoding is the divisor. Once computed, the quotient
     * forms the dividend for the next step. We stop when the dividend is zero.
     * All remainders are stored for later use.
     */
    while(dividend.length &gt; 0)
    {
        quotient = Array();
        x = 0;
        for(i = 0; i &lt; dividend.length; i++)
        {
            x = (x &lt;&lt; 16) + dividend[i];
            q = Math.floor(x / divisor);
            x -= q * divisor;
            if(quotient.length &gt; 0 || q &gt; 0)
                quotient[quotient.length] = q;
        }
        remainders[remainders.length] = x;
        dividend = quotient;
    }

    /* Convert the remainders to the output string */
    var output = &quot;&quot;;
    for(i = remainders.length - 1; i &gt;= 0; i--)
        output += encoding.charAt(remainders[i]);

    return output;
};

// Encode a string as utf-8.
// For efficiency, this assumes the input is valid utf-16.
$md5.str2rstr_utf8  = function(input)
{
    var output = &quot;&quot;;
    var i = -1;
    var x, y;

    while(++i &lt; input.length)
    {
        /* Decode utf-16 surrogate pairs */
        x = input.charCodeAt(i);
        y = i + 1 &lt; input.length ? input.charCodeAt(i + 1) : 0;
        if(0xD800 &lt;= x &amp;&amp; x &lt;= 0xDBFF &amp;&amp; 0xDC00 &lt;= y &amp;&amp; y &lt;= 0xDFFF)
        {
            x = 0x10000 + ((x &amp; 0x03FF) &lt;&lt; 10) + (y &amp; 0x03FF);
            i++;
        }

        /* Encode output as utf-8 */
        if(x &lt;= 0x7F)
            output += String.fromCharCode(x);
        else if(x &lt;= 0x7FF)
            output += String.fromCharCode(0xC0 | ((x &gt;&gt;&gt; 6 ) &amp; 0x1F),
                                          0x80 | ( x         &amp; 0x3F));
        else if(x &lt;= 0xFFFF)
            output += String.fromCharCode(0xE0 | ((x &gt;&gt;&gt; 12) &amp; 0x0F),
                                          0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                          0x80 | ( x         &amp; 0x3F));
        else if(x &lt;= 0x1FFFFF)
            output += String.fromCharCode(0xF0 | ((x &gt;&gt;&gt; 18) &amp; 0x07),
                                          0x80 | ((x &gt;&gt;&gt; 12) &amp; 0x3F),
                                          0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                          0x80 | ( x         &amp; 0x3F));
    }
    return output;
};

// Encode a string as utf-16
$md5.str2rstr_utf16le  = function(input)
{
    var output = &quot;&quot;;
    for(var i = 0; i &lt; input.length; i++)
        output += String.fromCharCode( input.charCodeAt(i)        &amp; 0xFF,
                                       (input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF);
    return output;
};

$md5.str2rstr_utf16be  = function(input)
{
    var output = &quot;&quot;;
    for(var i = 0; i &lt; input.length; i++)
        output += String.fromCharCode((input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF,
                                      input.charCodeAt(i)        &amp; 0xFF);
    return output;
};

// Convert a raw string to an array of little-endian words
// Characters &gt;255 have their high-byte silently ignored.
$md5.rstr2binl  = function(input)
{
    var output = Array((input.length+3) &gt;&gt; 2);
    for(var i = 0; i &lt; output.length; i++)
        output[i] = 0;
    for(var i = 0; i &lt; input.length * 8; i += 8)
        output[i&gt;&gt;5] |= (input.charCodeAt(i / 8) &amp; 0xFF) &lt;&lt; (i%32);
    return output;
};

// Convert an array of little-endian words to a string
$md5.binl2rstr  = function(input)
{
    var output = &quot;&quot;;
    for(var i = 0; i &lt; input.length * 32; i += 8)
        output += String.fromCharCode((input[i&gt;&gt;5] &gt;&gt;&gt; (i % 32)) &amp; 0xFF);
    return output;
};

// Calculate the MD5 of an array of little-endian words, and a bit length.
$md5.binl_md5  = function(x, len)
{
    /* append padding */
    var padupto = (((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14;   // 448 bits
    // write zeros so that we don't get 'undefined' later (otherwise we get a
    // bajillion javascript warnings!)
    for (var i = x.length; i &lt; padupto; ++i) {
        x[i] = 0;
    }
    // append the bit &quot;1&quot; to end of message
    x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((len) % 32);
    // add length as a 64-bit little-endian integer
    x[padupto] = len;
    x[padupto+1] = 0;

    var a =  1732584193;
    var b = -271733879;
    var c = -1732584194;
    var d =  271733878;

    for(var i = 0; i &lt; x.length; i += 16)
    {
        var olda = a;
        var oldb = b;
        var oldc = c;
        var oldd = d;

        a = $md5._ff(a, b, c, d, x[i+ 0], 7 , -680876936);
        d = $md5._ff(d, a, b, c, x[i+ 1], 12, -389564586);
        c = $md5._ff(c, d, a, b, x[i+ 2], 17,  606105819);
        b = $md5._ff(b, c, d, a, x[i+ 3], 22, -1044525330);
        a = $md5._ff(a, b, c, d, x[i+ 4], 7 , -176418897);
        d = $md5._ff(d, a, b, c, x[i+ 5], 12,  1200080426);
        c = $md5._ff(c, d, a, b, x[i+ 6], 17, -1473231341);
        b = $md5._ff(b, c, d, a, x[i+ 7], 22, -45705983);
        a = $md5._ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
        d = $md5._ff(d, a, b, c, x[i+ 9], 12, -1958414417);
        c = $md5._ff(c, d, a, b, x[i+10], 17, -42063);
        b = $md5._ff(b, c, d, a, x[i+11], 22, -1990404162);
        a = $md5._ff(a, b, c, d, x[i+12], 7 ,  1804603682);
        d = $md5._ff(d, a, b, c, x[i+13], 12, -40341101);
        c = $md5._ff(c, d, a, b, x[i+14], 17, -1502002290);
        b = $md5._ff(b, c, d, a, x[i+15], 22,  1236535329);

        a = $md5._gg(a, b, c, d, x[i+ 1], 5 , -165796510);
        d = $md5._gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
        c = $md5._gg(c, d, a, b, x[i+11], 14,  643717713);
        b = $md5._gg(b, c, d, a, x[i+ 0], 20, -373897302);
        a = $md5._gg(a, b, c, d, x[i+ 5], 5 , -701558691);
        d = $md5._gg(d, a, b, c, x[i+10], 9 ,  38016083);
        c = $md5._gg(c, d, a, b, x[i+15], 14, -660478335);
        b = $md5._gg(b, c, d, a, x[i+ 4], 20, -405537848);
        a = $md5._gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
        d = $md5._gg(d, a, b, c, x[i+14], 9 , -1019803690);
        c = $md5._gg(c, d, a, b, x[i+ 3], 14, -187363961);
        b = $md5._gg(b, c, d, a, x[i+ 8], 20,  1163531501);
        a = $md5._gg(a, b, c, d, x[i+13], 5 , -1444681467);
        d = $md5._gg(d, a, b, c, x[i+ 2], 9 , -51403784);
        c = $md5._gg(c, d, a, b, x[i+ 7], 14,  1735328473);
        b = $md5._gg(b, c, d, a, x[i+12], 20, -1926607734);

        a = $md5._hh(a, b, c, d, x[i+ 5], 4 , -378558);
        d = $md5._hh(d, a, b, c, x[i+ 8], 11, -2022574463);
        c = $md5._hh(c, d, a, b, x[i+11], 16,  1839030562);
        b = $md5._hh(b, c, d, a, x[i+14], 23, -35309556);
        a = $md5._hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
        d = $md5._hh(d, a, b, c, x[i+ 4], 11,  1272893353);
        c = $md5._hh(c, d, a, b, x[i+ 7], 16, -155497632);
        b = $md5._hh(b, c, d, a, x[i+10], 23, -1094730640);
        a = $md5._hh(a, b, c, d, x[i+13], 4 ,  681279174);
        d = $md5._hh(d, a, b, c, x[i+ 0], 11, -358537222);
        c = $md5._hh(c, d, a, b, x[i+ 3], 16, -722521979);
        b = $md5._hh(b, c, d, a, x[i+ 6], 23,  76029189);
        a = $md5._hh(a, b, c, d, x[i+ 9], 4 , -640364487);
        d = $md5._hh(d, a, b, c, x[i+12], 11, -421815835);
        c = $md5._hh(c, d, a, b, x[i+15], 16,  530742520);
        b = $md5._hh(b, c, d, a, x[i+ 2], 23, -995338651);

        a = $md5._ii(a, b, c, d, x[i+ 0], 6 , -198630844);
        d = $md5._ii(d, a, b, c, x[i+ 7], 10,  1126891415);
        c = $md5._ii(c, d, a, b, x[i+14], 15, -1416354905);
        b = $md5._ii(b, c, d, a, x[i+ 5], 21, -57434055);
        a = $md5._ii(a, b, c, d, x[i+12], 6 ,  1700485571);
        d = $md5._ii(d, a, b, c, x[i+ 3], 10, -1894986606);
        c = $md5._ii(c, d, a, b, x[i+10], 15, -1051523);
        b = $md5._ii(b, c, d, a, x[i+ 1], 21, -2054922799);
        a = $md5._ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
        d = $md5._ii(d, a, b, c, x[i+15], 10, -30611744);
        c = $md5._ii(c, d, a, b, x[i+ 6], 15, -1560198380);
        b = $md5._ii(b, c, d, a, x[i+13], 21,  1309151649);
        a = $md5._ii(a, b, c, d, x[i+ 4], 6 , -145523070);
        d = $md5._ii(d, a, b, c, x[i+11], 10, -1120210379);
        c = $md5._ii(c, d, a, b, x[i+ 2], 15,  718787259);
        b = $md5._ii(b, c, d, a, x[i+ 9], 21, -343485551);

        a = $md5._safe_add(a, olda);
        b = $md5._safe_add(b, oldb);
        c = $md5._safe_add(c, oldc);
        d = $md5._safe_add(d, oldd);
    }
    return Array(a, b, c, d);
};

// These functions implement the four basic operations the algorithm uses.
$md5._cmn  = function(q, a, b, x, s, t)
{
    return $md5._safe_add($md5._bit_rol($md5._safe_add($md5._safe_add(a, q), $md5._safe_add(x, t)), s),b);
};
$md5._ff  = function(a, b, c, d, x, s, t)
{
    return $md5._cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);
};
$md5._gg  = function(a, b, c, d, x, s, t)
{
    return $md5._cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);
};
$md5._hh  = function(a, b, c, d, x, s, t)
{
    return $md5._cmn(b ^ c ^ d, a, b, x, s, t);
};
$md5._ii  = function(a, b, c, d, x, s, t)
{
    return $md5._cmn(c ^ (b | (~d)), a, b, x, s, t);
};

// Add integers, wrapping at 2^32. This uses 16-bit operations internally
// to work around bugs in some JS interpreters.
$md5._safe_add  = function(x, y)
{
    var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
    var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
    return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
};

// Bitwise rotate a 32-bit number to the left.
$md5._bit_rol  = function(num, cnt)
{
    return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));
};

/****************************************************************************
 * END md5.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN token.js
 ****************************************************************************/

// $Id: token.js 969 2006-02-22 09:03:19Z quarl $

// $token.makeAuthToken - create an authentication token using HMAC

var $token = new Module('token.js');
$token.depend('md5.js', 'wikipage.js', 'kookie.js');

$token.getKey0 = function() {
    var l = [];
    if (WikiPage.dbname &amp;&amp; document.cookie) {
        var v1 = $kookie.get(WikiPage.dbname+'Token');
        var v2 = $kookie.get(WikiPage.dbname+'_session');
        if (v1 &amp;&amp; v2) return (v1 + '%' + v2 + '%' + wikiDoc.username);
    }

    // fail-safe - this is still secure; it's just more likely to mis-match a
    // valid token (if the cookie somehow changes by the next transaction)
    if (l.length == 0 &amp;&amp; document.cookie) {
        return document.cookie + '%' + wikiDoc.username;
    }

    if (wikiDoc.username) {
        return wikiDoc.username;
    }

    return '';
}

$token.load = function() {
    $token.key = $token.getKey0();
}

$util.addOnloadHook($token.load);

$token.getKey = function() {
    return $token.key;
}

// Return an authentication token useful to pass through URL for automatic
// edits, to prevent XSS attacks.  Accepts arbitrary string arguments.
$token.makeAuthToken = function() {
    return $md5.b64u_hmac_md5(
        $token.getKey(), 'auth_token:'+Array.join(arguments, '%') + '%%%%%xxx');
}

/****************************************************************************
 * END token.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN shortcuts.js
 ****************************************************************************/

// $Id: shortcuts.js 938 2006-02-22 06:30:21Z quarl $

// shortcuts.js - shortcut utilities

// Defines the Shortcuts class.
//   Input is an associative array like this:
//
/*
   s = Shortcuts({
                    'x1'   : 'str 1',
                    'x2 '  : 'str 2', // the space after x2 prevents msg() from displaying this entry
                    'x3,x4': 'str 34' // x3 and x4 are aliases; msg() only displays x3
                });
*/

var $shortcuts = new Module('shortcuts.js');

var Shortcuts = $shortcuts.Shortcuts = function(input) {
    if (!(this instanceof Shortcuts)) return new Shortcuts(input);

    this.shortcuts = {};
    for (k in input) {
        var keys = k.toUpperCase().split(',');
        this.shortcuts[keys[0]] = input[k];
        for (var i=1; i &lt; keys.length; ++i) {
            this.shortcuts[keys[i]] = input[k] + ' ';
        }
    }

    return this;
}

Shortcuts.prototype.msg = function() {
    var msg = 'Shortcuts available:\n';
    for (var key in this.shortcuts) {
        if (this.shortcuts[key].match(/ $/)) continue;
        msg += key + ': ' + this.shortcuts[key] + '\n';
    }
    return msg;
}

Shortcuts.prototype.subst = function(word) {
    return $util.trimSpaces(this.shortcuts[word.toUpperCase()]) || word;
}

Shortcuts.prototype.substP = function(word) {
    return Boolean(this.shortcuts[word.toUpperCase()]);
}

// replace the first word (doesn't require uppercase)
Shortcuts.prototype.substFirstWord = function(msg) {
    if (!msg) return msg;
    if (msg.match(/^([a-zA-Z]+)(.*)$/)) {
        return this.subst(RegExp.$1) + RegExp.$2;
    }
    return msg;
}

// replace all UPPERCASE words
Shortcuts.prototype.substUppercaseWords = function(msg) {
    if (!msg) return msg;
    var ret = '';
    var m;
    while (msg &amp;&amp; (m = msg.match(/^(.*?)\b([A-Z]+)\b(.*)$/)) ) {
        ret += m[1] + this.subst(m[2]);
        msg = m[3];
    }

    ret += msg;
    return ret;
}

// replace all words (ignoring case)
Shortcuts.prototype.substWords = function(msg) {
    if (!msg) return msg;
    var ret = '';
    var m;
    while (msg &amp;&amp; (m = msg.match(/^(.*?)\b([A-Za-z]+)\b(.*)$/)) ) {
        ret += m[1] + this.subst(m[2]);
        msg = m[3];
    }

    ret += msg;
    return ret;
}


/****************************************************************************
 * END shortcuts.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN diffsince.js
 ****************************************************************************/

// $Id: diffsince.js 1249 2006-02-25 06:25:32Z quarl $

// diffsince.js - utility functions for doing a &quot;diff since I last edited&quot;

// Synopsis:
//    url = diffsince.makeUrl(wikiPage);
//    href = '&lt;a onclick=&quot;javascript:diffsince.diffThis()&quot; href=&quot;'+url+'&quot;&gt;diff since&lt;/a&gt;';

// Or:
//    url = diffsince.makeUrl(wp);
//    href = '&lt;a onclick=&quot;javascript:diffsince.diffPageAsync(wp)&quot; href=&quot;'+url+'&quot;&gt;diff since&lt;/a&gt;';


// Navigating to the value of makeUrl will open a history page, parse it, and
// jump to the appropriate diff.

// The diffPageAsync() function asynchronously downloads the history page and
// then navigates to the diff.  It is appropriate as an onClick handler.

// The diffThis() function does the diff directly if already looking at a
// history page, else calls diffPageAsync(wikiPage).

// diffPageAsync and diffThis take status_node and status_text parameters for
// showing progress.

// quarl 2006-01-16 (asynchronous code originally written in show_diff_since.js)
// quarl 2006-02-03 factored as library

var $diffsince = new Module('diffsince.js');
$diffsince.depend('wikipage.js', 'util.js');

$diffsince.options = { history_limit: [200] };

// return a URL that points to a &quot;fakeaction&quot; page for doing a diff.
$diffsince.makeUrl = function(wp) {
    return wp.qurl + '&amp;fakeaction=diffsince&amp;action=history&amp;limit='+$diffsince.options.history_limit[0];
}

$diffsince._load = function() {
    if (WikiDocument.queryVars.fakeaction == 'diffsince') {
        $diffsince._parseHistory(document);
    }
}

$diffsince.diffPageAsync = function(wp, statusNode, statusText) {
    var url = wp.qurl + '&amp;action=history&amp;limit='+$diffsince.options.history_limit[0];
    var req = new XMLHttpRequest();

    // change the button to show the user we're doing something and
    // prevent another click
    $util.buttonShowStatus(statusNode, statusText); // (statusNode, statusText are optional)

    $util.asyncDownloadXML(url, $diffsince._handleHistoryPage,
                           { statusNode: statusNode });
    return false;
}

$diffsince.diffThis = function(statusNode, statusText) {
    if (wikiDoc.historyP) {
        // already looking at a history page
        $diffsince._parseHistory(document);
    } else {
        // not yet a history page -- asynchronously download it first
        $diffsince.diffPageAsync(wikiPage, statusNode, statusText);
    }
    return false;
}

$diffsince._handleHistoryPage = function(req) {
    // restore button in case this fails, so user can click again
    $util.buttonRestoreStatus(req.statusNode);

    if (req.status == 200) {
        $diffsince._parseHistory(req.responseXML);
    } else {
        alert(&quot;Error downloading history page!&quot;);
    }
}

$diffsince._parseHistory = function(doc) {
    if (!doc) { return $diffsince.error(&quot;no doc?! (error 771d4660-0109-4e56-9cd7-70fc583fd4b5)&quot;); }
    var hists = doc.getElementById(&quot;pagehistory&quot;).childNodes;
    if (!hists) { return $diffsince.error(&quot;Couldn't parse history from page (error db3ebe3e-cc2f-48ab-9c18-d348f92b0d91)&quot;); }
    for (n=0;n&lt;hists.length;n++) {
        if (hists[n].getElementsByTagName &amp;&amp;
            hists[n].getElementsByTagName(&quot;span&quot;)[0].textContent==wikiDoc.username)
        {
            document.location = hists[n].childNodes[1].href;
            return;
        }
    }

    alert(&quot;diffsince: Couldn't find your entry in the history page; you haven't edited recently!&quot;);
    // TODO: retry with a larger limit
}

$util.addOnloadHook($diffsince._load);


/****************************************************************************
 * END diffsince.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikiwatch.js
 ****************************************************************************/

// $Id: wikiwatch.js 633 2006-02-17 08:03:52Z quarl $

// wikiwatch.js - utility functions for manipulating watchlist

// quarl 2006-01-09 (initial asynchronous implementation at unwatch.js)
// quarl 2006-02-03 factored out to utility library

var $wikiwatch = new Module('wikiwatch.js');
$wikiwatch.depend('wikipage.js', 'util.js');

$wikiwatch.unwatchAsync = function(wp, callback, statusNode, statusText) {
    $wikiwatch.wuwatchAsync(false, wp, callback, statusNode, statusText);
}

$wikiwatch.watchAsync = function(wp, callback, statusNode, statusText) {
    $wikiwatch.wuwatchAsync(true, wp, callback, statusNode, statusText);
}

$wikiwatch.makeUrl = function(wp, wuwp) {
    if (wuwp) {
        return wp.qurl + '&amp;action=watch';
    } else {
        return wp.qurl + '&amp;action=unwatch';
    }
}

// wuwp true: watch
// wuwp false: unwatch
$wikiwatch.wuwatchAsync = function(wuwp, wp, callback, statusNode, statusText) {
    var h1expect = wuwp ? 'Added to watchlist' : 'Removed from watchlist';

    wp = wp.notalkPage();
    $util.buttonShowStatus(statusNode, statusText);
    var cb = function(req) {
        $util.buttonRestoreStatus(statusNode);
        var m;
        if ((req.status == 200) &amp;&amp;
            (req.responseXML.getElementById('content').getElementsByTagName('h1')[0].textContent == h1expect))
        {
            if (callback) {
                callback(wp, wuwp);
            }
        } else {
            alert(&quot;$wikiwatch.wuwatchAsync &quot;+wuwp+&quot; '&quot;+wp.page+&quot;' failed!&quot;);
        }
    };
    $util.asyncDownloadXML($wikiwatch.makeUrl(wp, wuwp), cb);
}

/****************************************************************************
 * END wikiwatch.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autoedit.js
 ****************************************************************************/

// $Id: autoedit.js 1208 2006-02-24 09:22:41Z quarl $

// autoedit.js - tab menu &amp; framework for automatically editing
// wiki pages

// SYNOPSIS:
//    var myeditor = new $autoedit('myeditor', 'MyEdit', 'ca-myedit', 'Do my edits', 'Edit summary prefix');
//    myeditor.initData = function() { this.foo=5; } /* optional */
//    myeditor.splitText = function(s) { return s.split('\n'); } /* optional */
//    myeditor.buildRegExp = function() { return /foo/ }
//    myeditor.replaceRegExp = function(s) { return + &quot;(&quot;+s+&quot;)&quot; }

// USER USAGE:
//    myeditor.widgetLoad();

// quarl 2006-02-08 initial version, refactoring *_canonicalize.js scripts

var $autoedit = new Module('autoedit.js');
$autoedit.depend('wikipage.js','wikiedit.js', 'util.js',
                 'wikiwidget.js', 'token.js');

$autoedit.editors = {};

$autoedit.options = { submitButton : 'wpDiff' };

// auto edit if query string asks us to (more commonly this is not necessary;
// user will invoke through tab)
$autoedit.load = function() {
    var v = WikiDocument.queryVars['autoedit'];
    if (!v) return;

    var autoeditor = $autoedit.editors[v];
    if (!autoeditor || !autoeditor.varname) {
        alert(&quot;$autoedit: invalid autoeditor! (error ae2a3784-7daf-49fb-9c6c-b68a7f28dc63)&quot;);
        return;
    }

    if (WikiDocument.queryVars['auth'] != autoeditor._makeAuthToken(wikiPage)) {
        alert(&quot;$autoedit: invalid auth token! (error a1908c50-620b-4104-bcfa-881ecf094442)&quot;);
        return;
    }

    setTimeout(function(){autoeditor.run();}, 50);
}

$autoedit._getMenu = function() {
    if (!$autoedit._menuAutoEdit) {
        $autoedit._menuAutoEdit = $wikiwidget.addTabMenu('AutoEdit', 'mn-autoedit');
    }
    return $autoedit._menuAutoEdit;
}

$autoedit.AutoEditor = function(varname, name, id, title, summaryPrefix) {
    this.varname = varname;
    this.summaryPrefix = summaryPrefix;
    this.name = name;
    this.id = id;
    this.title = title;

    this.widgetLoad = $util.bindThis(this, this.widgetLoad_);

    $autoedit.editors[varname] = this;
};

$autoedit.AutoEditor.prototype = {
    widgetLoad_ : function(location) {
        var me = this;
        if (!(me instanceof $autoedit.AutoEditor)) {
            alert(&quot;## $autoedit.widgetLoad: need $autoedit instance (error 87bd9bfd-7ff6-4577-a59c-488936fa536c)&quot;);
            return;
        }
        $util.addOnloadHook(function() {
                if (wikiPage.nsSpecialP) return;
                if (wikiDoc.protectedP) return;

                this.widget = new WikiWidget({default_location: $autoedit._getMenu,
                                              onclick: $util.bindThis(me, me.run),
                                              href: me.makeEditUrl(wikiPage),
                                              name: me.name, id: me.id, title: me.title});
                this.widget.add(location);
                });
    },

    _makeAuthToken: function(wp) {
        return $token.makeAuthToken('autoedit', this.varname, wp.page);
    },

    makeEditUrl : function(wp) {
        return (wp.qurl + '&amp;action=edit&amp;autoedit=' + this.varname + '&amp;auth=' +
                this._makeAuthToken(wp));
    },

    run : function() {
        this.initData();
        $util.buttonShowStatus(this.tab);
        wikiPage.getEditorAsync(this._edit0, this);
        return false;
    },

    _edit0 : function(editor, this_) {
        this_._edit1(editor);
    },

    _edit1 : function(editor) {
        var result = '';
        var input = editor.wpTextbox1;
        var changes = [];

        var inputs = this.splitText(input);

        var result = this.editStrings(inputs, changes);

        $util.buttonRestoreStatus(this.tab);
        if (changes.length) {
            editor.wpTextbox1 = result;
            editor.wpSummary = this.summaryPrefix + ': ' + changes.join('; ');
            editor.wpMinoredit = true;
            editor.submit($autoedit.options.submitButton);
        } else {
            alert(&quot;No changes to make!&quot;);
        }
    },

    initData : function() {
        /* TO BE OVERRIDDEN */
        // default: nothing to initialize
    },

    splitText : function(s) {
        /* TO BE OVERRIDDEN */
        // default: don't split at all
        return [s];
    },

    editStrings : function(inputs, changes) {
        for (var i in inputs) {
            inputs[i] = this.editString(inputs[i], changes);
        }
        return inputs.join('');
    },

    editString : function(input, changes) {
        /* TO BE OVERRIDDEN */
        return this.regexpEditString(input, changes);
    },

    regexpEditString : function(input, changes) {
        var result = '';

        var regexp = this.buildRegExp();
        var m;
        while ((m=input.match(regexp))) {
            result += RegExp.leftContext;

            // This descriptor is passed in for input as well as taken as output.
            //
            // LEFT is the text on the left of the match; TEXT is the text itself;
            // RIGHT is the text on the right of the match.  All 3 can be modified.
            //
            // Return value of replaceRegExp overrides d.text if non-null --
            // it's simply a convenience feature.

            var d = { left: result, text: m[0], right: RegExp.rightContext };

            var dresult = this.replaceRegExp(d, m);
            if (dresult != null) {
                d.text = dresult;
            }

            if (d.text != m[0]) {
                changes.push('&quot;'+m[0]+'&quot;' + ' â†’ ' +'&quot;'+d.text+'&quot;');
            }
            result = d.left + d.text;
            input = d.right;
        }
        result += input;
        return result;
    },

    buildRegExp : function() {
        alert(&quot;## $autoedit.AutoEditor.buildRegExp() not overridden! (38c826f0-9f24-4ce2-9708-567d8e55a7c5)&quot;);
    },

    replaceRegExp : function(d, match) {
        // d.left
        // d.text
        // d.right
        alert(&quot;## $autoedit.AutoEditor.replaceRegExp() not overridden! (1a791fee-8020-453f-adb1-df3c69dc6828)&quot;);
    },

    // $autoedit._findCategoryContentTable = function() {
    //     var tables = document.getElementsByTagName('table');
    //     for (var i = 0; i &lt; tables.length; ++i) {
    //         var table = tables[i];
    //         if (table.previousSibling.textContent.match(/^There are/)) {
    //             return table;
    //         }
    //     }
    //     return false;
    // }

    // prefix [varname] buttons before all wikilinks.  Good for category pages.
    addAutoEditButtons : function() {
        // if (!wikiPage.nsCategoryP) return;

        // var table = $autoedit._findCategoryContentTable();
        // if (!table) return;

        var d = document.getElementById('bodyContent');

        var links = $util.copyArray(d.getElementsByTagName('a'));
        for (var i = 0; i &lt; links.length; ++i) {
            var link = links[i];
            if (!link.href || !link.href.match(/\/wiki\//)) continue;
            if (link.href.match(/#/)) continue;
            if (link.className.match(/external/)) continue;
            var wp = new WikiPage(link);
            var url = this.makeEditUrl(wp);

            var span = document.createElement('span');
            span.innerHTML = '[&lt;a href=&quot;'+url+'&quot;&gt;'+this.varname+'&lt;/a&gt;] ';
            $util.addNodeBefore(link, span);
        }
    }
};

$util.addOnloadHook($autoedit.load);

/****************************************************************************
 * END autoedit.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN nav_custom.js
 ****************************************************************************/

// $Id: nav_custom.js 894 2006-02-22 05:54:10Z quarl $

// nav_custom.js - customizations for navigation box

//  - adds links:
//     [[User:Quarl/todo]]
//     [[User:Quarl/sandbox]]
//     [[User:Quarl/monobook]]

//  - removes links:
//     [[Help:Contents]]
//     [[Wikipedia:Contact us]]
//     [http://wikimediafoundation.org/wiki/Fundraising#Donation_methods]

var $nav_custom = new Module('nav_custom.js');
$nav_custom.depend('wikipage.js', 'wikiwidget.js');

$nav_custom.addNavLink = function(params) {
    var wp = WikiPage(null, params.pagename);
    var wpe = params.editpagename ? WikiPage(null, params.editpagename) : wp;
    var urlN = wp.url, urlE = wpe.qurl+'&amp;action=edit';
    var name = params.name || wp.article;
    var e = &quot;&lt;a style='display:inline' href='&quot; + urlN + &quot;'&gt;&quot; + name + &quot;&lt;/a&gt; (&lt;a style='display:inline' href='&quot;+urlE+&quot;'&gt;edit&lt;/a&gt;)&quot;;

    var widget = new WikiWidget({default_location: {portlet:'Navigation'},
                                 entry: e,
                                 id: params.id,
                                 key: params.key});
    widget.add(params.location||null);
}

$nav_custom.delNavLink = function(id) {
    var node = document.getElementById(id);
    if (!node) return;
    //node.style.display = 'none';
    node.className += ' hiddenStructure';
}

$nav_custom.alterLinkText = function(id, newText) {
    var node = document.getElementById(id);
    if (!node) return;
    node.firstChild.innerHTML = newText;
}

/****************************************************************************
 * END nav_custom.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN iframedl.js
 ****************************************************************************/

// $Id: iframedl.js 632 2006-02-17 05:27:33Z quarl $

// iframedl.js - download content in a hidden &lt;iframe&gt;
//
// $iframedl.refreshUrl: refreshes a URL
//
// $iframedl.loadUrl: loads a URL and return the HTMLDocument
//   advantage over XMLHttpRequest: browser automatically caches the contents
//   as a regular document.
//
//  Note that as with XMLHttpRequest, you cannot retrieve pages from other
//  domains.

// quarl 2006-01-10 initial version

var $iframedl = new Module('iframedl.js');

$iframedl.refreshUrl = function(url, callback) {
    // We can't do frm.location.reload() right now because frm.location will
    // still be &quot;about:blank&quot;, but if we complete this event and start a new
    // one, it works.

    //frm.location.replace(url);
    //frm.location.href = url;

    $iframedl.node.src = url;

    var cb = function() {
        $iframedl.frm.location.reload();
        if (callback) callback();
    };

    setTimeout(cb, 0);
}

$iframedl._ifrmDoc = function(frm) {
    if (frm.contentDocument) {
        // For NS6
        return frm.contentDocument;
    } else if (frm.contentWindow) {
        // For IE5.5 and IE6
        return frm.contentWindow.document;
    } else if (frm.document) {
        // For IE5
        return frm.document;
    } else {
        return null;
    }
}

$iframedl.loadUrl = function(url, callback) {
    var doc = $iframedl._ifrmDoc($iframedl.node);
    // doc.location.replace(url);
    $iframedl.node.src = url;

    var cb = function() {
        // $iframedl.frm.location.reload();
        if (callback) callback(doc);
    };

    setTimeout(cb, 1);
}

// write the hidden iframe.  Note: don't use display:none !
document.write('&lt;div style=&quot;position:absolute;left:0px;top:0px;visibility:hidden;&quot; id=&quot;iframedl_hidden_div&quot;&gt;' +
               '&lt;iframe src=&quot;about:blank&quot; height=&quot;0&quot; width=&quot;0&quot; name=&quot;iframedl_iframe&quot; id=&quot;iframedl_iframe&quot;&gt;' +
               '&lt;/iframe&gt;&lt;/div&gt;');

$iframedl.node = document.getElementById('iframedl_iframe');
$iframedl.frm = window.frames['iframedl_iframe'];

/****************************************************************************
 * END iframedl.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN wikiimg.js
 ****************************************************************************/

// $Id: wikiimg.js 1246 2006-02-25 04:51:53Z quarl $

// wikiimg.js -- utilities for downloading images

// quarl 2006-02-20 initial version, based on image code in Lupin's popups

var $wikiimg = new Module('wikiimg.js');
$wikiimg.depend('util.js', 'wikipage.js');

$wikiimg.options = {
    same_wiki_only : false,
    no_thumbs : false,
    max_concurrent_downloads : 5,

    // this sets the MINIMUM latency between calls to $wikiimage._checkImages
    // -- that doesn't mean it gets called every 50 ms, just that it's not
    // called faster than 50 ms !
    update_latency : 50                             // in milliseconds
};

$wikiimg.load = function() {
    var commonsWiki='commons.wikimedia.org';
    var thisWiki = WikiPage.server;

    var imageSources = $wikiimg.imageSources = [];

    // frequently seen thumbs
    imageSources.push(
        {wiki: thisWiki, thumb: true,  width: 180}, // default
        {wiki: thisWiki, thumb: true,  width: 120} // gallery
        );

    // frequently seen thumbs on commons
    if (WikiPage.wikimediaWikiP &amp;&amp; thisWiki!=commonsWiki) {
        imageSources.push(
            {wiki: commonsWiki, thumb: true,  width: 180},
            {wiki: commonsWiki, thumb: true,  width: 120},
            {wiki: commonsWiki, thumb: true,  width: 96}
            );
    }

    // unusual thumb sizes and full-size
    imageSources.push(
        {wiki: thisWiki, thumb: true,  width: 200}, // common?
        {wiki: thisWiki, thumb: true,  width: 250}, // common?
        {wiki: thisWiki, thumb: true,  width: 300},
        {wiki: thisWiki, thumb: true,  width: 210},
        {wiki: thisWiki, thumb: true,  width: 230},
        {wiki: thisWiki, thumb: false, width: 0} // no comma
        );

    // full-size on commons
    if (WikiPage.wikimediaWikiP &amp;&amp; thisWiki!=commonsWiki) {
        imageSources.push({wiki: commonsWiki, thumb: false, width: 0});
    }
}
$util.addOnloadHook($wikiimg.load);

// this returns a trailing slash
$wikiimg.getUrlBase = function(wiki) {
    switch (wiki) {
        case 'en.wikipedia.org':      return 'http://upload.wikimedia.org/wikipedia/en/';
        case 'commons.wikimedia.org': return 'http://upload.wikimedia.org/wikipedia/commons/';
        case 'en.wiktionary.org':     return 'http://en.wiktionary.org/upload/en/';
        default: // unsupported - take a guess
        if (WikiPage.wikimediaWikiP) {
            var lang=wiki.split('.')[0];
            return 'http://upload.wikimedia.org/wikipedia/' + lang +'/';
        }
        else /* this should work for wikicities */
            return 'http://' + wiki + '/images/';
    }
};

// those a/a5/ bits of image urls
$wikiimg.imagePathComponent = function(filename) {
    var hash = $md5.hex_md5($util.wpaEscape(filename));
    return hash.substring(0,1) + '/' + hash.substring(0,2) + '/';
};

$wikiimg.imageURL = function(filename, wiki) {
    if (!wiki) return $wikiimg.error(&quot;imageURL: need 'wiki'&quot;);
    if ($wikiimg.options.same_wiki_only &amp;&amp; wiki != WikiPage.server) return null;
    return ($wikiimg.getUrlBase(wiki) +
            $wikiimg.imagePathComponent(filename) +
            filename);
};

$wikiimg.imageThumbURL = function(filename, wiki, width) {
    //
    // eg http://upload.wikimedia.org/wikipedia/en/thumb/6/61/
    //           Rubiks_cube_solved.jpg/120px-Rubiks_cube_solved.jpg
    //           ^^^^^^^^^^^^^^^^^^^^^^^
    //          wikicities omits this bit
    //  AND wikicities needs a new pathcpt for each filename including thumbs
    if ($wikiimg.options.same_wiki_only &amp;&amp; wiki != WikiPage.server) return null;
    if ($wikiimg.options.no_thumbs) return null;

    var thumbname = width + &quot;px-&quot; + filename;

    var imgurl = $wikiimg.getUrlBase(wiki) +  &quot;thumb/&quot;;

    if (WikiPage.wikimediaWikiP) {
        imgurl += $wikiimg.imagePathComponent(filename);
        imgurl += filename + '/';
    } else {
        imgurl += $wikiimg.imagePathComponent(thumbname);
    }

    imgurl += thumbname;
    return imgurl;
};

// returns a list of URLs, which have an attached 'wiki' property.
$wikiimg.getUrls = function(filename) {
    var urls = [];
    for (var i in $wikiimg.imageSources) {
        var imgsrc = $wikiimg.imageSources[i];
        var url = null;
        if (imgsrc.thumb)
            url=$wikiimg.imageThumbURL(filename, imgsrc.wiki, imgsrc.width);
        else
            url=$wikiimg.imageURL(filename, imgsrc.wiki);
        if (url) {
            url = new String(url);
            url.wiki = imgsrc.wiki;
            urls.push(url);
        }
    }
    return urls;
};

$wikiimg.isValidImageName = function(str)
{
    return str.match(/\{/) == null;
};

$wikiimg._cache = {};
$wikiimg._inProgress = {}; // maps filename to map from url to Image
$wikiimg._concurrent_downloads = 0;

// asynchronously starts downloading possible URL(s) for the given Image wp.
// Calls callback(wp, img) on success and callback(wp, null) on failure.  Memoized.
//
// img is an Image instance with the extra property img.wiki being the
// hostname of the wiki it's from.
$wikiimg.downloadImage = function(filename, callback) {
    if (!$wikiimg.isValidImageName(filename)) {
        $wikiimg.error(&quot;downloadImage: '&quot; + filename + &quot;' is not a valid image link (error e341bf13-3a16-475d-94bc-574233981e07)&quot;);
        return;
    }
    if ($wikiimg._cache[filename]) {
        callback(filename, $wikiimg._cache[filename]);
        return;
    }
    var urls = $wikiimg.getUrls(filename);
    $wikiimg._downloadImagesParallel(filename, urls, callback);
}

$wikiimg._downloadImagesParallel = function(filename, urls, callback)
{
    var descriptor = $wikiimg._inProgress[filename];
    if (descriptor) {
        // download already in progress.
        descriptor.callbacks.push(callback);
        return;
    }
    descriptor = $wikiimg._inProgress[filename] = {
        filename: filename, callbacks: [callback], imgs: [] };

    for (var i in urls) {
        var img = new Image();
        img.bLoaded = false;
        img.bErrored = false;
        img.bAborted = false;
        img.rsrc = urls[i];
        img.wiki = urls[i].wiki;
        // we don't actually initiate the download yet; that is the job of
        // _checkImages
        descriptor.imgs.push(img);
    }
    $wikiimg._checkImages();           // call it now to start downloading
};

$wikiimg._checkImages = function() {
    if (typeof window.$wikiimg == 'undefined') return; // unloaded?

    var findOk = function(imgs) {
        for (var i in imgs) {
            var img = imgs[i];
            if (img.bLoaded) return img;
        }
        return null;
    }

    var allFailedP = function(imgs) {
        for (var i in imgs) {
            if (!imgs[i].bErrored) return false;
        }
        return true;
    }

    var checkImagesScheduled = false;
    var imgCompletedSchedCheckImages = function(img) {
        if (typeof window.$wikiimg == 'undefined') return; // unloaded
        $wikiimg.debug(&quot;imgCompletedSchedCheckImages &quot; + img.rsrc);
        $wikiimg._concurrent_downloads --;
        if (!checkImagesScheduled) {
            checkImagesScheduled = true;
            setTimeout($wikiimg._checkImages, $wikiimg.options.update_latency);
        }
    }

    var startImgDownload = function(img) {
        $wikiimg.debug(&quot;startImgDownload &quot; + img.rsrc);
        img.onload = function() { img.bLoaded = true; imgCompletedSchedCheckImages(img); };
        img.onerror = function() { img.bErrored = true; imgCompletedSchedCheckImages(img); };
        // img.onabort = function() { img.bAborted = true; imgCompletedSchedCheckImages(); };
        img.onabort = $wikiimg.abortAllDownloads;
        img.src = img.rsrc;
    }

    var startDownloads = function(imgs) {
        for (var i in imgs) {
            if ($wikiimg._concurrent_downloads &gt;= $wikiimg.options.max_concurrent_downloads)
                return;
            var img = imgs[i];
            if (! img.src) {
                startImgDownload(img);
                $wikiimg._concurrent_downloads ++;
            }
        }
    }

    var stopDownloads = function(imgs) {
        while (imgs.length) {
            var img = imgs[0];
            delete img.onload;
            delete img.onerror;
            delete img.onabort;
            if (img.src) {
                $wikiimg._concurrent_downloads --;
            }
            imgs.shift();
        }
    }

    // have any of the concurrent download completed?
    for (var filename in $wikiimg._inProgress) {
        var descriptor = $wikiimg._inProgress[filename];
        if (allFailedP(descriptor.imgs)) {
            // failed :(
            $wikiimg.debug(&quot;Failed all &quot;+descriptor.imgs.length+&quot; attempts to download &quot;+filename);
            $util.callHooks(descriptor.callbacks, descriptor.filename, null);
            stopDownloads(descriptor.imgs);
            delete $wikiimg._inProgress[filename];
            continue;
        }
        var img = findOk(descriptor.imgs);
        if (img) {
            // success! now call the callbacks and clear the data
            // structure
            $wikiimg.debug(&quot;Successfully downloaded &quot;+filename+ &quot; at &quot; + img.src);
            $wikiimg._cache[descriptor.filename] = img;
            $util.callHooks(descriptor.callbacks, descriptor.filename, img);
            stopDownloads(descriptor.imgs);
            delete $wikiimg._inProgress[filename];
            continue;
        }
        // Still looking.  Start new downloads?
        startDownloads(descriptor.imgs);
    }
};

$wikiimg.imageIdCounter = 0;
$wikiimg.htmlDlImages = [];
$wikiimg.makeAutoDlHtml = function(filename) {
    var id = $wikiimg.imageIdCounter++;
    $wikiimg.htmlDlImages[id] = filename;
    // use CSS background-url javascript hack so that as soon as this HTML
    // fragment is inserted into the document, we start downloading the
    // image.  This is useful when we don't know when the resulting HTML will
    // be inserted into the document.
    var jsurl = $util.pprintf(&quot;javascript:$wikiimg._htmlDownloadImage($1)&quot;, id);
    return $util.pprintf('&lt;img id=&quot;wikiimg-$1&quot; style=&quot;background:url(\'$2\')&quot; /&gt;',
                        id, jsurl);
};


$wikiimg._htmlDownloadImage = function(id)
{
    $wikiimg.debug(&quot;htmlDownloadImage(&quot;+id+&quot;)&quot;);
    var filename = $wikiimg.htmlDlImages[id];
    if (!filename) {
        $wikiimg.debug(&quot;htmlDownloadImage(&quot;+id+&quot;): no filename&quot;);
        return;
    }
    var img = document.getElementById('wikiimg-'+id);
    if (!img) {
        $wikiimg.debug(&quot;htmlDownloadImage(&quot;+id+&quot;): no img&quot;);
        return;
    }

    var cb = function(filename, dlImg) {
        $wikiimg.debug('htmlDownloadImage ' + filename + ' ' + dlImg&amp;&amp;dlImg.src);
        if (dlImg) {
            img.src = dlImg.src;
        }
    };

    $wikiimg.downloadImage(filename, cb);
};


$wikiimg.abortAllDownloads = function() {
    $wikiimg._downloads = [];
    $wikiimg._concurrent_downloads = 0;
};

$util.addOnunloadHook($wikiimg.abortAllDownloads);

/****************************************************************************
 * END wikiimg.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN drag.js
 ****************************************************************************/

// $Id: drag.js 1119 2006-02-23 07:38:50Z quarl $

var $drag = new Module('drag.js');
$drag.depend('util.js');

$drag.makeDraggable = function(obj, root, args)
{
    if (obj.dragger) return false;

    obj.dragger = new $drag.Dragger(obj, root, args);
    return true;
}

$drag.Dragger = function(obj, root, args)
{
    // args: pickupCondition, onPickup

    var dragger = this;
    this.obj = obj;
    this.root = root || obj;
    this.dragging = false;
    $util.merge(this, args);

    $util.hookEventObj(this.obj, 'mousedown', function(e){dragger.pickup(e)});
    $util.hookEventObj(this.obj, 'click', function(e){dragger.click(e)});
};

$drag.Dragger.prototype.pickup = function(e)
{
    if (!$util.eventLeftButtonP(e)) return;
    if (this.pickupCondition &amp;&amp; !this.pickupCondition(e)) return;
    if (this.onPickup) this.onPickup(e);

    if (this.dragging) {
        // we could get here due to a Mozilla bug(?) where if you drag and
        // release off-window, no mouseUp event is delivered
        e.preventDefault();
        this.dragging = false;
        return;
    }

    this.mouse_x = e.clientX;
    this.mouse_y = e.clientY;

    this.drag_top = parseInt(this.obj.style.top);
    this.drag_left = parseInt(this.obj.style.left);

    this.dragging = false;

    var dragger = this;
    $util.hookEventObj(document, 'mousemove',
                       (this.hookMouseMove = function(e){dragger.drag(e)}));
    $util.hookEventObj(document, 'mouseup',
                       (this.hookMouseUp = function(e){dragger.drop(e)}));

    e.preventDefault();
};

$drag.Dragger.prototype.drag = function(e)
{
    this.dragging = true;

    var x = e.clientX;
    var y = e.clientY;

    this.obj.style.top = (y - this.mouse_y + this.drag_top) + &quot;px&quot;;
    this.obj.style.left = (x - this.mouse_x + this.drag_left) + &quot;px&quot;;
};

$drag.Dragger.prototype.click = function(e) {
    if (this.dragging) e.preventDefault();
}

$drag.Dragger.prototype.drop = function(e)
{
    document.removeEventListener(&quot;mousemove&quot;, this.hookMouseMove, false);
    document.removeEventListener(&quot;mouseup&quot;, this.hookMouseUp, false);
    this.dragging = false;
};

/****************************************************************************
 * END drag.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN overlib/overlib.js
 ****************************************************************************/

var $overlib = new Module('overlib/overlib.js');

//\/////
//\  overLIB 4.21 - You may not remove or change this notice.
//\  Copyright Erik Bosrup 1998-2004. All rights reserved.
//\
//\  Contributors are listed on the homepage.
//\  This file might be old, always check for the latest version at:
//\  http://www.bosrup.com/web/overlib/
//\
//\  Please read the license agreement (available through the link above)
//\  before using overLIB. Direct any licensing questions to erik@bosrup.com.
//\
//\  Do not sell this as your own work or remove this copyright notice.
//\  For full details on copying or changing this script please read the
//\  license agreement at the link above. Please give credit on sites that
//\  use overLIB and submit changes of the script so other people can use
//\  them as well.
//   $Revision: 1.119 $                $Date: 2005/07/02 23:41:44 $
//\/////
//\mini

////////
// PRE-INIT
// Ignore these lines, configuration is below.
////////
var olLoaded = 0;var pmStart = 10000000; var pmUpper = 10001000; var pmCount = pmStart+1; var pmt=''; var pms = new Array(); var olInfo = new Info('4.21', 1);
var FREPLACE = 0; var FBEFORE = 1; var FAFTER = 2; var FALTERNATE = 3; var FCHAIN=4;
var olHideForm=0;  // parameter for hiding SELECT and ActiveX elements in IE5.5+
var olHautoFlag = 0;  // flags for over-riding VAUTO and HAUTO if corresponding
var olVautoFlag = 0;  // positioning commands are used on the command line
var hookPts = new Array(), postParse = new Array(), cmdLine = new Array(), runTime = new Array();
// for plugins
registerCommands('donothing,inarray,caparray,sticky,background,noclose,caption,left,right,center,offsetx,offsety,fgcolor,bgcolor,textcolor,capcolor,closecolor,width,border,cellpad,status,autostatus,autostatuscap,height,closetext,snapx,snapy,fixx,fixy,relx,rely,fgbackground,bgbackground,padx,pady,fullhtml,above,below,capicon,textfont,captionfont,closefont,textsize,captionsize,closesize,timeout,function,delay,hauto,vauto,closeclick,wrap,followmouse,mouseoff,closetitle,cssoff,compatmode,cssclass,fgclass,bgclass,textfontclass,captionfontclass,closefontclass');

////////
// DEFAULT CONFIGURATION
// Settings you want everywhere are set here. All of this can also be
// changed on your html page or through an overLIB call.
////////
if (typeof ol_fgcolor=='undefined') var ol_fgcolor=&quot;#CCCCFF&quot;;
if (typeof ol_bgcolor=='undefined') var ol_bgcolor=&quot;#333399&quot;;
if (typeof ol_textcolor=='undefined') var ol_textcolor=&quot;#000000&quot;;
if (typeof ol_capcolor=='undefined') var ol_capcolor=&quot;#FFFFFF&quot;;
if (typeof ol_closecolor=='undefined') var ol_closecolor=&quot;#9999FF&quot;;
if (typeof ol_textfont=='undefined') var ol_textfont=&quot;Verdana,Arial,Helvetica&quot;;
if (typeof ol_captionfont=='undefined') var ol_captionfont=&quot;Verdana,Arial,Helvetica&quot;;
if (typeof ol_closefont=='undefined') var ol_closefont=&quot;Verdana,Arial,Helvetica&quot;;
if (typeof ol_textsize=='undefined') var ol_textsize=&quot;1&quot;;
if (typeof ol_captionsize=='undefined') var ol_captionsize=&quot;1&quot;;
if (typeof ol_closesize=='undefined') var ol_closesize=&quot;1&quot;;
if (typeof ol_width=='undefined') var ol_width=&quot;200&quot;;
if (typeof ol_border=='undefined') var ol_border=&quot;1&quot;;
if (typeof ol_cellpad=='undefined') var ol_cellpad=2;
if (typeof ol_offsetx=='undefined') var ol_offsetx=10;
if (typeof ol_offsety=='undefined') var ol_offsety=10;
if (typeof ol_text=='undefined') var ol_text=&quot;Default Text&quot;;
if (typeof ol_cap=='undefined') var ol_cap=&quot;&quot;;
if (typeof ol_sticky=='undefined') var ol_sticky=0;
if (typeof ol_background=='undefined') var ol_background=&quot;&quot;;
if (typeof ol_close=='undefined') var ol_close=&quot;Close&quot;;
if (typeof ol_hpos=='undefined') var ol_hpos=RIGHT;
if (typeof ol_status=='undefined') var ol_status=&quot;&quot;;
if (typeof ol_autostatus=='undefined') var ol_autostatus=0;
if (typeof ol_height=='undefined') var ol_height=-1;
if (typeof ol_snapx=='undefined') var ol_snapx=0;
if (typeof ol_snapy=='undefined') var ol_snapy=0;
if (typeof ol_fixx=='undefined') var ol_fixx=-1;
if (typeof ol_fixy=='undefined') var ol_fixy=-1;
if (typeof ol_relx=='undefined') var ol_relx=null;
if (typeof ol_rely=='undefined') var ol_rely=null;
if (typeof ol_fgbackground=='undefined') var ol_fgbackground=&quot;&quot;;
if (typeof ol_bgbackground=='undefined') var ol_bgbackground=&quot;&quot;;
if (typeof ol_padxl=='undefined') var ol_padxl=1;
if (typeof ol_padxr=='undefined') var ol_padxr=1;
if (typeof ol_padyt=='undefined') var ol_padyt=1;
if (typeof ol_padyb=='undefined') var ol_padyb=1;
if (typeof ol_fullhtml=='undefined') var ol_fullhtml=0;
if (typeof ol_vpos=='undefined') var ol_vpos=BELOW;
if (typeof ol_aboveheight=='undefined') var ol_aboveheight=0;
if (typeof ol_capicon=='undefined') var ol_capicon=&quot;&quot;;
if (typeof ol_frame=='undefined') var ol_frame=self;
if (typeof ol_timeout=='undefined') var ol_timeout=0;
if (typeof ol_function=='undefined') var ol_function=null;
if (typeof ol_delay=='undefined') var ol_delay=0;
if (typeof ol_hauto=='undefined') var ol_hauto=0;
if (typeof ol_vauto=='undefined') var ol_vauto=0;
if (typeof ol_closeclick=='undefined') var ol_closeclick=0;
if (typeof ol_wrap=='undefined') var ol_wrap=0;
if (typeof ol_followmouse=='undefined') var ol_followmouse=1;
if (typeof ol_mouseoff=='undefined') var ol_mouseoff=0;
if (typeof ol_closetitle=='undefined') var ol_closetitle='Close';
if (typeof ol_compatmode=='undefined') var ol_compatmode=0;
if (typeof ol_css=='undefined') var ol_css=CSSOFF;
if (typeof ol_fgclass=='undefined') var ol_fgclass=&quot;&quot;;
if (typeof ol_bgclass=='undefined') var ol_bgclass=&quot;&quot;;
if (typeof ol_textfontclass=='undefined') var ol_textfontclass=&quot;&quot;;
if (typeof ol_captionfontclass=='undefined') var ol_captionfontclass=&quot;&quot;;
if (typeof ol_closefontclass=='undefined') var ol_closefontclass=&quot;&quot;;

////////
// ARRAY CONFIGURATION
////////

// You can use these arrays to store popup text here instead of in the html.
if (typeof ol_texts=='undefined') var ol_texts = new Array(&quot;Text 0&quot;, &quot;Text 1&quot;);
if (typeof ol_caps=='undefined') var ol_caps = new Array(&quot;Caption 0&quot;, &quot;Caption 1&quot;);

////////
// END OF CONFIGURATION
// Don't change anything below this line, all configuration is above.
////////





////////
// INIT
////////
// Runtime variables init. Don't change for config!
var o3_text=&quot;&quot;;
var o3_cap=&quot;&quot;;
var o3_sticky=0;
var o3_background=&quot;&quot;;
var o3_close=&quot;Close&quot;;
var o3_hpos=RIGHT;
var o3_offsetx=2;
var o3_offsety=2;
var o3_fgcolor=&quot;&quot;;
var o3_bgcolor=&quot;&quot;;
var o3_textcolor=&quot;&quot;;
var o3_capcolor=&quot;&quot;;
var o3_closecolor=&quot;&quot;;
var o3_width=100;
var o3_border=1;
var o3_cellpad=2;
var o3_status=&quot;&quot;;
var o3_autostatus=0;
var o3_height=-1;
var o3_snapx=0;
var o3_snapy=0;
var o3_fixx=-1;
var o3_fixy=-1;
var o3_relx=null;
var o3_rely=null;
var o3_fgbackground=&quot;&quot;;
var o3_bgbackground=&quot;&quot;;
var o3_padxl=0;
var o3_padxr=0;
var o3_padyt=0;
var o3_padyb=0;
var o3_fullhtml=0;
var o3_vpos=BELOW;
var o3_aboveheight=0;
var o3_capicon=&quot;&quot;;
var o3_textfont=&quot;Verdana,Arial,Helvetica&quot;;
var o3_captionfont=&quot;Verdana,Arial,Helvetica&quot;;
var o3_closefont=&quot;Verdana,Arial,Helvetica&quot;;
var o3_textsize=&quot;1&quot;;
var o3_captionsize=&quot;1&quot;;
var o3_closesize=&quot;1&quot;;
var o3_frame=self;
var o3_timeout=0;
var o3_timerid=0;
var o3_allowmove=0;
var o3_function=null;
var o3_delay=0;
var o3_delayid=0;
var o3_hauto=0;
var o3_vauto=0;
var o3_closeclick=0;
var o3_wrap=0;
var o3_followmouse=1;
var o3_mouseoff=0;
var o3_closetitle='';
var o3_compatmode=0;
var o3_css=CSSOFF;
var o3_fgclass=&quot;&quot;;
var o3_bgclass=&quot;&quot;;
var o3_textfontclass=&quot;&quot;;
var o3_captionfontclass=&quot;&quot;;
var o3_closefontclass=&quot;&quot;;

// Display state variables
var o3_x = 0;
var o3_y = 0;
var o3_showingsticky = 0;
var o3_removecounter = 0;

// Our layer
var over = null;
var fnRef, hoveringSwitch = false;
var olHideDelay;

// Decide browser version
var isMac = (navigator.userAgent.indexOf(&quot;Mac&quot;) != -1);
var olOp = (navigator.userAgent.toLowerCase().indexOf('opera') &gt; -1 &amp;&amp; document.createTextNode);  // Opera 7
var olNs4 = (navigator.appName=='Netscape' &amp;&amp; parseInt(navigator.appVersion) == 4);
var olNs6 = (document.getElementById) ? true : false;
var olKq = (olNs6 &amp;&amp; /konqueror/i.test(navigator.userAgent));
var olIe4 = (document.all) ? true : false;
var olIe5 = false;
var olIe55 = false; // Added additional variable to identify IE5.5+
var docRoot = 'document.body';

// Resize fix for NS4.x to keep track of layer
if (olNs4) {
	var oW = window.innerWidth;
	var oH = window.innerHeight;
	window.onresize = function() { if (oW != window.innerWidth || oH != window.innerHeight) location.reload(); }
}

// Microsoft Stupidity Check(tm).
if (olIe4) {
	var agent = navigator.userAgent;
	if (/MSIE/.test(agent)) {
		var versNum = parseFloat(agent.match(/MSIE[ ](\d\.\d+)\.*/i)[1]);
		if (versNum &gt;= 5){
			olIe5=true;
			olIe55=(versNum&gt;=5.5&amp;&amp;!olOp) ? true : false;
			if (olNs6) olNs6=false;
		}
	}
	if (olNs6) olIe4 = false;
}

// Check for compatability mode.
if (document.compatMode &amp;&amp; document.compatMode == 'CSS1Compat') {
	docRoot= ((olIe4 &amp;&amp; !olOp) ? 'document.documentElement' : docRoot);
}

// Add window onload handlers to indicate when all modules have been loaded
// For Netscape 6+ and Mozilla, uses addEventListener method on the window object
// For IE it uses the attachEvent method of the window object and for Netscape 4.x
// it sets the window.onload handler to the OLonload_handler function for Bubbling
if(window.addEventListener) window.addEventListener(&quot;load&quot;,OLonLoad_handler,false);
else if (window.attachEvent) window.attachEvent(&quot;onload&quot;,OLonLoad_handler);

var capExtent;

////////
// PUBLIC FUNCTIONS
////////

// overlib(arg0,...,argN)
// Loads parameters into global runtime variables.
overlib = $overlib.overlib = function() {
	if (!olLoaded || isExclusive(arguments)) return true;
	if (olCheckMouseCapture) olMouseCapture();
	if (over) {
		over = (typeof over.id != 'string') ? o3_frame.document.all['overDiv'] : over;
		cClick();
	}

	// Load defaults to runtime.
  olHideDelay=0;
	o3_text=ol_text;
	o3_cap=ol_cap;
	o3_sticky=ol_sticky;
	o3_background=ol_background;
	o3_close=ol_close;
	o3_hpos=ol_hpos;
	o3_offsetx=ol_offsetx;
	o3_offsety=ol_offsety;
	o3_fgcolor=ol_fgcolor;
	o3_bgcolor=ol_bgcolor;
	o3_textcolor=ol_textcolor;
	o3_capcolor=ol_capcolor;
	o3_closecolor=ol_closecolor;
	o3_width=ol_width;
	o3_border=ol_border;
	o3_cellpad=ol_cellpad;
	o3_status=ol_status;
	o3_autostatus=ol_autostatus;
	o3_height=ol_height;
	o3_snapx=ol_snapx;
	o3_snapy=ol_snapy;
	o3_fixx=ol_fixx;
	o3_fixy=ol_fixy;
	o3_relx=ol_relx;
	o3_rely=ol_rely;
	o3_fgbackground=ol_fgbackground;
	o3_bgbackground=ol_bgbackground;
	o3_padxl=ol_padxl;
	o3_padxr=ol_padxr;
	o3_padyt=ol_padyt;
	o3_padyb=ol_padyb;
	o3_fullhtml=ol_fullhtml;
	o3_vpos=ol_vpos;
	o3_aboveheight=ol_aboveheight;
	o3_capicon=ol_capicon;
	o3_textfont=ol_textfont;
	o3_captionfont=ol_captionfont;
	o3_closefont=ol_closefont;
	o3_textsize=ol_textsize;
	o3_captionsize=ol_captionsize;
	o3_closesize=ol_closesize;
	o3_timeout=ol_timeout;
	o3_function=ol_function;
	o3_delay=ol_delay;
	o3_hauto=ol_hauto;
	o3_vauto=ol_vauto;
	o3_closeclick=ol_closeclick;
	o3_wrap=ol_wrap;
	o3_followmouse=ol_followmouse;
	o3_mouseoff=ol_mouseoff;
	o3_closetitle=ol_closetitle;
	o3_css=ol_css;
	o3_compatmode=ol_compatmode;
	o3_fgclass=ol_fgclass;
	o3_bgclass=ol_bgclass;
	o3_textfontclass=ol_textfontclass;
	o3_captionfontclass=ol_captionfontclass;
	o3_closefontclass=ol_closefontclass;

	setRunTimeVariables();

	fnRef = '';

	// Special for frame support, over must be reset...
	o3_frame = ol_frame;

	if(!(over=createDivContainer())) return false;

	parseTokens('o3_', arguments);
	if (!postParseChecks()) return false;

	if (o3_delay == 0) {
		return runHook(&quot;olMain&quot;, FREPLACE);
 	} else {
		o3_delayid = setTimeout(&quot;runHook('olMain', FREPLACE)&quot;, o3_delay);
		return false;
	}
}

// Clears popups if appropriate
function nd(time) {
	if (olLoaded &amp;&amp; !isExclusive()) {
		hideDelay(time);  // delay popup close if time specified

		if (o3_removecounter &gt;= 1) { o3_showingsticky = 0 };

		if (o3_showingsticky == 0) {
			o3_allowmove = 0;
			if (over != null &amp;&amp; o3_timerid == 0) runHook(&quot;hideObject&quot;, FREPLACE, over);
		} else {
			o3_removecounter++;
		}
	}

	return true;
}

// The Close onMouseOver function for stickies
function cClick() {
	if (olLoaded) {
		runHook(&quot;hideObject&quot;, FREPLACE, over);
		o3_showingsticky = 0;
	}
	return false;
}

// Method for setting page specific defaults.
function overlib_pagedefaults() {
	parseTokens('ol_', arguments);
}


////////
// OVERLIB MAIN FUNCTION
////////

// This function decides what it is we want to display and how we want it done.
function olMain() {
	var layerhtml, styleType;
 	runHook(&quot;olMain&quot;, FBEFORE);

	if (o3_background!=&quot;&quot; || o3_fullhtml) {
		// Use background instead of box.
		layerhtml = runHook('ol_content_background', FALTERNATE, o3_css, o3_text, o3_background, o3_fullhtml);
	} else {
		// They want a popup box.
		styleType = (pms[o3_css-1-pmStart] == &quot;cssoff&quot; || pms[o3_css-1-pmStart] == &quot;cssclass&quot;);

		// Prepare popup background
		if (o3_fgbackground != &quot;&quot;) o3_fgbackground = &quot;background=\&quot;&quot;+o3_fgbackground+&quot;\&quot;&quot;;
		if (o3_bgbackground != &quot;&quot;) o3_bgbackground = (styleType ? &quot;background=\&quot;&quot;+o3_bgbackground+&quot;\&quot;&quot; : o3_bgbackground);

		// Prepare popup colors
		if (o3_fgcolor != &quot;&quot;) o3_fgcolor = (styleType ? &quot;bgcolor=\&quot;&quot;+o3_fgcolor+&quot;\&quot;&quot; : o3_fgcolor);
		if (o3_bgcolor != &quot;&quot;) o3_bgcolor = (styleType ? &quot;bgcolor=\&quot;&quot;+o3_bgcolor+&quot;\&quot;&quot; : o3_bgcolor);

		// Prepare popup height
		if (o3_height &gt; 0) o3_height = (styleType ? &quot;height=\&quot;&quot;+o3_height+&quot;\&quot;&quot; : o3_height);
		else o3_height = &quot;&quot;;

		// Decide which kinda box.
		if (o3_cap==&quot;&quot;) {
			// Plain
			layerhtml = runHook('ol_content_simple', FALTERNATE, o3_css, o3_text);
		} else {
			// With caption
			if (o3_sticky) {
				// Show close text
				layerhtml = runHook('ol_content_caption', FALTERNATE, o3_css, o3_text, o3_cap, o3_close);
			} else {
				// No close text
				layerhtml = runHook('ol_content_caption', FALTERNATE, o3_css, o3_text, o3_cap, &quot;&quot;);
			}
		}
	}

	// We want it to stick!
	if (o3_sticky) {
		if (o3_timerid &gt; 0) {
			clearTimeout(o3_timerid);
			o3_timerid = 0;
		}
		o3_showingsticky = 1;
		o3_removecounter = 0;
	}

	// Created a separate routine to generate the popup to make it easier
	// to implement a plugin capability
	if (!runHook(&quot;createPopup&quot;, FREPLACE, layerhtml)) return false;

	// Prepare status bar
	if (o3_autostatus &gt; 0) {
		o3_status = o3_text;
		if (o3_autostatus &gt; 1) o3_status = o3_cap;
	}

	// When placing the layer the first time, even stickies may be moved.
	o3_allowmove = 0;

	// Initiate a timer for timeout
	if (o3_timeout &gt; 0) {
		if (o3_timerid &gt; 0) clearTimeout(o3_timerid);
		o3_timerid = setTimeout(&quot;cClick()&quot;, o3_timeout);
	}

	// Show layer
	runHook(&quot;disp&quot;, FREPLACE, o3_status);
	runHook(&quot;olMain&quot;, FAFTER);

	return (olOp &amp;&amp; event &amp;&amp; event.type == 'mouseover' &amp;&amp; !o3_status) ? '' : (o3_status != '');
}

////////
// LAYER GENERATION FUNCTIONS
////////
// These functions just handle popup content with tags that should adhere to the W3C standards specification.

// Makes simple table without caption
function ol_content_simple(text) {
	var cpIsMultiple = /,/.test(o3_cellpad);
	var txt = '&lt;table width=&quot;'+o3_width+ '&quot; border=&quot;0&quot; cellpadding=&quot;'+o3_border+'&quot; cellspacing=&quot;0&quot; '+(o3_bgclass ? 'class=&quot;'+o3_bgclass+'&quot;' : o3_bgcolor+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; '+((olNs4||!cpIsMultiple) ? 'cellpadding=&quot;'+o3_cellpad+'&quot; ' : '')+'cellspacing=&quot;0&quot; '+(o3_fgclass ? 'class=&quot;'+o3_fgclass+'&quot;' : o3_fgcolor+' '+o3_fgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td valign=&quot;TOP&quot;'+(o3_textfontclass ? ' class=&quot;'+o3_textfontclass+'&quot;&gt;' : ((!olNs4&amp;&amp;cpIsMultiple) ? ' style=&quot;'+setCellPadStr(o3_cellpad)+'&quot;&gt;' : '&gt;'))+(o3_textfontclass ? '' : wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass ? '' : wrapStr(1,o3_textsize))+'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';

	set_background(&quot;&quot;);
	return txt;
}

// Makes table with caption and optional close link
function ol_content_caption(text,title,close) {
	var nameId, txt, cpIsMultiple = /,/.test(o3_cellpad);
	var closing, closeevent;

	closing = &quot;&quot;;
	closeevent = &quot;onmouseover&quot;;
	if (o3_closeclick == 1) closeevent = (o3_closetitle ? &quot;title='&quot; + o3_closetitle +&quot;'&quot; : &quot;&quot;) + &quot; onclick&quot;;
	if (o3_capicon != &quot;&quot;) {
	  nameId = ' hspace = \&quot;5\&quot;'+' align = \&quot;middle\&quot; alt = \&quot;\&quot;';
	  if (typeof o3_dragimg != 'undefined' &amp;&amp; o3_dragimg) nameId =' hspace=\&quot;5\&quot;'+' name=\&quot;'+o3_dragimg+'\&quot; id=\&quot;'+o3_dragimg+'\&quot; align=\&quot;middle\&quot; alt=\&quot;Drag Enabled\&quot; title=\&quot;Drag Enabled\&quot;';
	  o3_capicon = '&lt;img src=\&quot;'+o3_capicon+'\&quot;'+nameId+' /&gt;';
	}

	if (close != &quot;&quot;)
		closing = '&lt;td '+(!o3_compatmode &amp;&amp; o3_closefontclass ? 'class=&quot;'+o3_closefontclass : 'align=&quot;RIGHT')+'&quot;&gt;&lt;a href=&quot;javascript:return '+fnRef+'cClick();&quot;'+((o3_compatmode &amp;&amp; o3_closefontclass) ? ' class=&quot;' + o3_closefontclass + '&quot; ' : ' ')+closeevent+'=&quot;return '+fnRef+'cClick();&quot;&gt;'+(o3_closefontclass ? '' : wrapStr(0,o3_closesize,'close'))+close+(o3_closefontclass ? '' : wrapStr(1,o3_closesize,'close'))+'&lt;/a&gt;&lt;/td&gt;';
	txt = '&lt;table width=&quot;'+o3_width+ '&quot; border=&quot;0&quot; cellpadding=&quot;'+o3_border+'&quot; cellspacing=&quot;0&quot; '+(o3_bgclass ? 'class=&quot;'+o3_bgclass+'&quot;' : o3_bgcolor+' '+o3_bgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td'+(o3_captionfontclass ? ' class=&quot;'+o3_captionfontclass+'&quot;&gt;' : '&gt;')+(o3_captionfontclass ? '' : '&lt;b&gt;'+wrapStr(0,o3_captionsize,'caption'))+o3_capicon+title+(o3_captionfontclass ? '' : wrapStr(1,o3_captionsize)+'&lt;/b&gt;')+'&lt;/td&gt;'+closing+'&lt;/tr&gt;&lt;/table&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; '+((olNs4||!cpIsMultiple) ? 'cellpadding=&quot;'+o3_cellpad+'&quot; ' : '')+'cellspacing=&quot;0&quot; '+(o3_fgclass ? 'class=&quot;'+o3_fgclass+'&quot;' : o3_fgcolor+' '+o3_fgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td valign=&quot;TOP&quot;'+(o3_textfontclass ? ' class=&quot;'+o3_textfontclass+'&quot;&gt;' :((!olNs4&amp;&amp;cpIsMultiple) ? ' style=&quot;'+setCellPadStr(o3_cellpad)+'&quot;&gt;' : '&gt;'))+(o3_textfontclass ? '' : wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass ? '' : wrapStr(1,o3_textsize)) + '&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';

	set_background(&quot;&quot;);
	return txt;
}

// Sets the background picture,padding and lots more. :)
function ol_content_background(text,picture,hasfullhtml) {
	if (hasfullhtml) {
		txt=text;
	} else {
		txt='&lt;table width=&quot;'+o3_width+'&quot; border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; height=&quot;'+o3_height+'&quot;&gt;&lt;tr&gt;&lt;td colspan=&quot;3&quot; height=&quot;'+o3_padyt+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td width=&quot;'+o3_padxl+'&quot;&gt;&lt;/td&gt;&lt;td valign=&quot;TOP&quot; width=&quot;'+(o3_width-o3_padxl-o3_padxr)+(o3_textfontclass ? '&quot; class=&quot;'+o3_textfontclass : '')+'&quot;&gt;'+(o3_textfontclass ? '' : wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass ? '' : wrapStr(1,o3_textsize))+'&lt;/td&gt;&lt;td width=&quot;'+o3_padxr+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&quot;3&quot; height=&quot;'+o3_padyb+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
	}

	set_background(picture);
	return txt;
}

// Loads a picture into the div.
function set_background(pic) {
	if (pic == &quot;&quot;) {
		if (olNs4) {
			over.background.src = null;
		} else if (over.style) {
			over.style.backgroundImage = &quot;none&quot;;
		}
	} else {
		if (olNs4) {
			over.background.src = pic;
		} else if (over.style) {
			over.style.width=o3_width + 'px';
			over.style.backgroundImage = &quot;url(&quot;+pic+&quot;)&quot;;
		}
	}
}

////////
// HANDLING FUNCTIONS
////////
var olShowId=-1;

// Displays the popup
function disp(statustext) {
	runHook(&quot;disp&quot;, FBEFORE);

	if (o3_allowmove == 0) {
		runHook(&quot;placeLayer&quot;, FREPLACE);
		(olNs6&amp;&amp;olShowId&lt;0) ? olShowId=setTimeout(&quot;runHook('showObject', FREPLACE, over)&quot;, 1) : runHook(&quot;showObject&quot;, FREPLACE, over);
		o3_allowmove = (o3_sticky || o3_followmouse==0) ? 0 : 1;
	}

	runHook(&quot;disp&quot;, FAFTER);

	if (statustext != &quot;&quot;) self.status = statustext;
}

// Creates the actual popup structure
function createPopup(lyrContent){
	runHook(&quot;createPopup&quot;, FBEFORE);

	if (o3_wrap) {
		var wd,ww,theObj = (olNs4 ? over : over.style);
		theObj.top = theObj.left = ((olIe4&amp;&amp;!olOp) ? 0 : -10000) + (!olNs4 ? 'px' : 0);
		layerWrite(lyrContent);
		wd = (olNs4 ? over.clip.width : over.offsetWidth);
		if (wd &gt; (ww=windowWidth())) {
			lyrContent=lyrContent.replace(/\&amp;nbsp;/g, ' ');
			o3_width=ww;
			o3_wrap=0;
		}
	}

	layerWrite(lyrContent);

	// Have to set o3_width for placeLayer() routine if o3_wrap is turned on
	if (o3_wrap) o3_width=(olNs4 ? over.clip.width : over.offsetWidth);

	runHook(&quot;createPopup&quot;, FAFTER, lyrContent);

	return true;
}

// Decides where we want the popup.
function placeLayer() {
	var placeX, placeY, widthFix = 0;

	// HORIZONTAL PLACEMENT, re-arranged to work in Safari
	if (o3_frame.innerWidth) widthFix=18;
	iwidth = windowWidth();

	// Horizontal scroll offset
	winoffset=(olIe4) ? eval('o3_frame.'+docRoot+'.scrollLeft') : o3_frame.pageXOffset;

	placeX = runHook('horizontalPlacement',FCHAIN,iwidth,winoffset,widthFix);

	// VERTICAL PLACEMENT, re-arranged to work in Safari
	if (o3_frame.innerHeight) {
		iheight=o3_frame.innerHeight;
	} else if (eval('o3_frame.'+docRoot)&amp;&amp;eval(&quot;typeof o3_frame.&quot;+docRoot+&quot;.clientHeight=='number'&quot;)&amp;&amp;eval('o3_frame.'+docRoot+'.clientHeight')) {
		iheight=eval('o3_frame.'+docRoot+'.clientHeight');
	}

	// Vertical scroll offset
	scrolloffset=(olIe4) ? eval('o3_frame.'+docRoot+'.scrollTop') : o3_frame.pageYOffset;
	placeY = runHook('verticalPlacement',FCHAIN,iheight,scrolloffset);

	// Actually move the object.
	repositionTo(over, placeX, placeY);
}

// Moves the layer
olMouseMove = $overlib.olMouseMove = function(e) {
	var e = (e) ? e : event;

	if (e.pageX) {
		o3_x = e.pageX;
		o3_y = e.pageY;
	} else if (e.clientX) {
		o3_x = eval('e.clientX+o3_frame.'+docRoot+'.scrollLeft');
		o3_y = eval('e.clientY+o3_frame.'+docRoot+'.scrollTop');
	}

	if (o3_allowmove == 1) runHook(&quot;placeLayer&quot;, FREPLACE);

	// MouseOut handler
	if (hoveringSwitch &amp;&amp; !olNs4 &amp;&amp; runHook(&quot;cursorOff&quot;, FREPLACE)) {
		(olHideDelay ? hideDelay(olHideDelay) : cClick());
		hoveringSwitch = !hoveringSwitch;
	}
}

// Fake function for 3.0 users.
function no_overlib() { return ver3fix; }

// Capture the mouse and chain other scripts.
function olMouseCapture() {
	capExtent = document;
	var fN, str = '', l, k, f, wMv, sS, mseHandler = olMouseMove;
	var re = /function[ ]*(\w*)\(/;

	wMv = (!olIe4 &amp;&amp; window.onmousemove);
	if (document.onmousemove || wMv) {
		if (wMv) capExtent = window;
		f = capExtent.onmousemove.toString();
		fN = f.match(re);
		if (fN == null) {
			str = f+'(e); ';
		} else if (fN[1] == 'anonymous' || fN[1] == 'olMouseMove' || (wMv &amp;&amp; fN[1] == 'onmousemove')) {
			if (!olOp &amp;&amp; wMv) {
				l = f.indexOf('{')+1;
				k = f.lastIndexOf('}');
				sS = f.substring(l,k);
				if ((l = sS.indexOf('(')) != -1) {
					sS = sS.substring(0,l).replace(/^\s+/,'').replace(/\s+$/,'');
					if (eval(&quot;typeof &quot; + sS + &quot; == 'undefined'&quot;)) window.onmousemove = null;
					else str = sS + '(e);';
				}
			}
			if (!str) {
				olCheckMouseCapture = false;
				return;
			}
		} else {
			if (fN[1]) str = fN[1]+'(e); ';
			else {
				l = f.indexOf('{')+1;
				k = f.lastIndexOf('}');
				str = f.substring(l,k) + '\n';
			}
		}
		str += 'olMouseMove(e); ';
		mseHandler = new Function('e', str);
	}

	capExtent.onmousemove = mseHandler;
	if (olNs4) capExtent.captureEvents(Event.MOUSEMOVE);
}

////////
// PARSING FUNCTIONS
////////

// Does the actual command parsing.
function parseTokens(pf, ar) {
	// What the next argument is expected to be.
	var v, i, mode=-1, par = (pf != 'ol_');
	var fnMark = (par &amp;&amp; !ar.length ? 1 : 0);

	for (i = 0; i &lt; ar.length; i++) {
		if (mode &lt; 0) {
			// Arg is maintext,unless its a number between pmStart and pmUpper
			// then its a command.
			if (typeof ar[i] == 'number' &amp;&amp; ar[i] &gt; pmStart &amp;&amp; ar[i] &lt; pmUpper) {
				fnMark = (par ? 1 : 0);
				i--;   // backup one so that the next block can parse it
			} else {
				switch(pf) {
					case 'ol_':
						ol_text = ar[i].toString();
						break;
					default:
						o3_text=ar[i].toString();
				}
			}
			mode = 0;
		} else {
			// Note: NS4 doesn't like switch cases with vars.
			if (ar[i] &gt;= pmCount || ar[i]==DONOTHING) { continue; }
			if (ar[i]==INARRAY) { fnMark = 0; eval(pf+'text=ol_texts['+ar[++i]+'].toString()'); continue; }
			if (ar[i]==CAPARRAY) { eval(pf+'cap=ol_caps['+ar[++i]+'].toString()'); continue; }
			if (ar[i]==STICKY) { if (pf!='ol_') eval(pf+'sticky=1'); continue; }
			if (ar[i]==BACKGROUND) { eval(pf+'background=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==NOCLOSE) { if (pf!='ol_') opt_NOCLOSE(); continue; }
			if (ar[i]==CAPTION) { eval(pf+&quot;cap='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==CENTER || ar[i]==LEFT || ar[i]==RIGHT) { eval(pf+'hpos='+ar[i]); if(pf!='ol_') olHautoFlag=1; continue; }
			if (ar[i]==OFFSETX) { eval(pf+'offsetx='+ar[++i]); continue; }
			if (ar[i]==OFFSETY) { eval(pf+'offsety='+ar[++i]); continue; }
			if (ar[i]==FGCOLOR) { eval(pf+'fgcolor=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==BGCOLOR) { eval(pf+'bgcolor=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==TEXTCOLOR) { eval(pf+'textcolor=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CAPCOLOR) { eval(pf+'capcolor=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CLOSECOLOR) { eval(pf+'closecolor=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==WIDTH) { eval(pf+'width='+ar[++i]); continue; }
			if (ar[i]==BORDER) { eval(pf+'border='+ar[++i]); continue; }
			if (ar[i]==CELLPAD) { i=opt_MULTIPLEARGS(++i,ar,(pf+'cellpad')); continue; }
			if (ar[i]==STATUS) { eval(pf+&quot;status='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==AUTOSTATUS) { eval(pf +'autostatus=('+pf+'autostatus == 1) ? 0 : 1'); continue; }
			if (ar[i]==AUTOSTATUSCAP) { eval(pf +'autostatus=('+pf+'autostatus == 2) ? 0 : 2'); continue; }
			if (ar[i]==HEIGHT) { eval(pf+'height='+pf+'aboveheight='+ar[++i]); continue; } // Same param again.
			if (ar[i]==CLOSETEXT) { eval(pf+&quot;close='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==SNAPX) { eval(pf+'snapx='+ar[++i]); continue; }
			if (ar[i]==SNAPY) { eval(pf+'snapy='+ar[++i]); continue; }
			if (ar[i]==FIXX) { eval(pf+'fixx='+ar[++i]); continue; }
			if (ar[i]==FIXY) { eval(pf+'fixy='+ar[++i]); continue; }
			if (ar[i]==RELX) { eval(pf+'relx='+ar[++i]); continue; }
			if (ar[i]==RELY) { eval(pf+'rely='+ar[++i]); continue; }
			if (ar[i]==FGBACKGROUND) { eval(pf+'fgbackground=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==BGBACKGROUND) { eval(pf+'bgbackground=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==PADX) { eval(pf+'padxl='+ar[++i]); eval(pf+'padxr='+ar[++i]); continue; }
			if (ar[i]==PADY) { eval(pf+'padyt='+ar[++i]); eval(pf+'padyb='+ar[++i]); continue; }
			if (ar[i]==FULLHTML) { if (pf!='ol_') eval(pf+'fullhtml=1'); continue; }
			if (ar[i]==BELOW || ar[i]==ABOVE) { eval(pf+'vpos='+ar[i]); if (pf!='ol_') olVautoFlag=1; continue; }
			if (ar[i]==CAPICON) { eval(pf+'capicon=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==TEXTFONT) { eval(pf+&quot;textfont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==CAPTIONFONT) { eval(pf+&quot;captionfont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==CLOSEFONT) { eval(pf+&quot;closefont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==TEXTSIZE) { eval(pf+'textsize=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CAPTIONSIZE) { eval(pf+'captionsize=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CLOSESIZE) { eval(pf+'closesize=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==TIMEOUT) { eval(pf+'timeout='+ar[++i]); continue; }
			if (ar[i]==FUNCTION) { if (pf=='ol_') { if (typeof ar[i+1]!='number') { v=ar[++i]; ol_function=(typeof v=='function' ? v : null); }} else {fnMark = 0; v = null; if (typeof ar[i+1]!='number') v = ar[++i];  opt_FUNCTION(v); } continue; }
			if (ar[i]==DELAY) { eval(pf+'delay='+ar[++i]); continue; }
			if (ar[i]==HAUTO) { eval(pf+'hauto=('+pf+'hauto == 0) ? 1 : 0'); continue; }
			if (ar[i]==VAUTO) { eval(pf+'vauto=('+pf+'vauto == 0) ? 1 : 0'); continue; }
			if (ar[i]==CLOSECLICK) { eval(pf +'closeclick=('+pf+'closeclick == 0) ? 1 : 0'); continue; }
			if (ar[i]==WRAP) { eval(pf +'wrap=('+pf+'wrap == 0) ? 1 : 0'); continue; }
			if (ar[i]==FOLLOWMOUSE) { eval(pf +'followmouse=('+pf+'followmouse == 1) ? 0 : 1'); continue; }
			if (ar[i]==MOUSEOFF) { eval(pf +'mouseoff=('+pf+'mouseoff==0) ? 1 : 0'); v=ar[i+1]; if (pf != 'ol_' &amp;&amp; eval(pf+'mouseoff') &amp;&amp; typeof v == 'number' &amp;&amp; (v &lt; pmStart || v &gt; pmUpper)) olHideDelay=ar[++i]; continue; }
			if (ar[i]==CLOSETITLE) { eval(pf+&quot;closetitle='&quot;+escSglQuote(ar[++i])+&quot;'&quot;); continue; }
			if (ar[i]==CSSOFF||ar[i]==CSSCLASS) { eval(pf+'css='+ar[i]); continue; }
			if (ar[i]==COMPATMODE) { eval(pf+'compatmode=('+pf+'compatmode==0) ? 1 : 0'); continue; }
			if (ar[i]==FGCLASS) { eval(pf+'fgclass=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==BGCLASS) { eval(pf+'bgclass=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==TEXTFONTCLASS) { eval(pf+'textfontclass=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CAPTIONFONTCLASS) { eval(pf+'captionfontclass=&quot;'+ar[++i]+'&quot;'); continue; }
			if (ar[i]==CLOSEFONTCLASS) { eval(pf+'closefontclass=&quot;'+ar[++i]+'&quot;'); continue; }
			i = parseCmdLine(pf, i, ar);
		}
	}

	if (fnMark &amp;&amp; o3_function) o3_text = o3_function();

	if ((pf == 'o3_') &amp;&amp; o3_wrap) {
		o3_width = 0;

		var tReg=/&lt;.*\n*&gt;/ig;
		if (!tReg.test(o3_text)) o3_text = o3_text.replace(/[ ]+/g, '&amp;nbsp;');
		if (!tReg.test(o3_cap))o3_cap = o3_cap.replace(/[ ]+/g, '&amp;nbsp;');
	}
	if ((pf == 'o3_') &amp;&amp; o3_sticky) {
		if (!o3_close &amp;&amp; (o3_frame != ol_frame)) o3_close = ol_close;
		if (o3_mouseoff &amp;&amp; (o3_frame == ol_frame)) opt_NOCLOSE(' ');
	}
}


////////
// LAYER FUNCTIONS
////////

// Writes to a layer
function layerWrite(txt) {
	txt += &quot;\n&quot;;
	if (olNs4) {
		var lyr = o3_frame.document.layers['overDiv'].document
		lyr.write(txt)
		lyr.close()
	} else if (typeof over.innerHTML != 'undefined') {
		if (olIe5 &amp;&amp; isMac) over.innerHTML = '';
		over.innerHTML = txt;
	} else {
		range = o3_frame.document.createRange();
		range.setStartAfter(over);
		domfrag = range.createContextualFragment(txt);

		while (over.hasChildNodes()) {
			over.removeChild(over.lastChild);
		}

		over.appendChild(domfrag);
	}
}

// Make an object visible
function showObject(obj) {
	runHook(&quot;showObject&quot;, FBEFORE);

	var theObj=(olNs4 ? obj : obj.style);
	theObj.visibility = 'visible';

	runHook(&quot;showObject&quot;, FAFTER);
}

// Hides an object
function hideObject(obj) {
        if (!obj) {
            try { throw 0; } catch(e) {};
            return;
        }

	runHook(&quot;hideObject&quot;, FBEFORE);

	var theObj=(olNs4 ? obj : obj.style);
	if (olNs6 &amp;&amp; olShowId&gt;0) { clearTimeout(olShowId); olShowId=0; }
	theObj.visibility = 'hidden';
	theObj.top = theObj.left = ((olIe4&amp;&amp;!olOp) ? 0 : -10000) + (!olNs4 ? 'px' : 0);

	if (o3_timerid &gt; 0) clearTimeout(o3_timerid);
	if (o3_delayid &gt; 0) clearTimeout(o3_delayid);

	o3_timerid = 0;
	o3_delayid = 0;
	self.status = &quot;&quot;;

	if (obj.onmouseout||obj.onmouseover) {
		if (olNs4) obj.releaseEvents(Event.MOUSEOUT || Event.MOUSEOVER);
		obj.onmouseout = obj.onmouseover = null;
	}

	runHook(&quot;hideObject&quot;, FAFTER);
}

// Move a layer
function repositionTo(obj, xL, yL) {
	var theObj=(olNs4 ? obj : obj.style);
	theObj.left = xL + (!olNs4 ? 'px' : 0);
	theObj.top = yL + (!olNs4 ? 'px' : 0);
}

// Check position of cursor relative to overDiv DIVision; mouseOut function
function cursorOff() {
	var left = parseInt(over.style.left);
	var top = parseInt(over.style.top);
	var right = left + (over.offsetWidth &gt;= parseInt(o3_width) ? over.offsetWidth : parseInt(o3_width));
	var bottom = top + (over.offsetHeight &gt;= o3_aboveheight ? over.offsetHeight : o3_aboveheight);

	if (o3_x &lt; left || o3_x &gt; right || o3_y &lt; top || o3_y &gt; bottom) return true;

	return false;
}


////////
// COMMAND FUNCTIONS
////////

// Calls callme or the default function.
function opt_FUNCTION(callme) {
	o3_text = (callme ? (typeof callme=='string' ? (/.+\(.*\)/.test(callme) ? eval(callme) : callme) : callme()) : (o3_function ? o3_function() : 'No Function'));

	return 0;
}

// Handle hovering
function opt_NOCLOSE(unused) {
	if (!unused) o3_close = &quot;&quot;;

	if (olNs4) {
		over.captureEvents(Event.MOUSEOUT || Event.MOUSEOVER);
		over.onmouseover = function () { if (o3_timerid &gt; 0) { clearTimeout(o3_timerid); o3_timerid = 0; } }
		over.onmouseout = function (e) { if (olHideDelay) hideDelay(olHideDelay); else cClick(e); }
	} else {
		over.onmouseover = function () {hoveringSwitch = true; if (o3_timerid &gt; 0) { clearTimeout(o3_timerid); o3_timerid =0; } }
	}

	return 0;
}

// Function to scan command line arguments for multiples
function opt_MULTIPLEARGS(i, args, parameter) {
  var k=i, re, pV, str='';

  for(k=i; k&lt;args.length; k++) {
		if(typeof args[k] == 'number' &amp;&amp; args[k]&gt;pmStart) break;
		str += args[k] + ',';
	}
	if (str) str = str.substring(0,--str.length);

	k--;  // reduce by one so the for loop this is in works correctly
	pV=(olNs4 &amp;&amp; /cellpad/i.test(parameter)) ? str.split(',')[0] : str;
	eval(parameter + '=&quot;' + pV + '&quot;');

	return k;
}

// Remove &amp;nbsp; in texts when done.
function nbspCleanup() {
	if (o3_wrap) {
		o3_text = o3_text.replace(/\&amp;nbsp;/g, ' ');
		o3_cap = o3_cap.replace(/\&amp;nbsp;/g, ' ');
	}
}

// Escape embedded single quotes in text strings
function escSglQuote(str) {
  return str.toString().replace(/\'/g,&quot;\\'&quot;);
}

// Onload handler for window onload event
function OLonLoad_handler(e) {
	var re = /\w+\(.*\)[;\s]+/g, olre = /overlib\(|nd\(|cClick\(/, fn, l, i;

	if(!olLoaded) olLoaded=1;

  // Remove it for Gecko based browsers
	if(window.removeEventListener &amp;&amp; e.eventPhase == 3) window.removeEventListener(&quot;load&quot;,OLonLoad_handler,false);
	else if(window.detachEvent) { // and for IE and Opera 4.x but execute calls to overlib, nd, or cClick()
		window.detachEvent(&quot;onload&quot;,OLonLoad_handler);
		var fN = document.body.getAttribute('onload');
		if (fN) {
			fN=fN.toString().match(re);
			if (fN &amp;&amp; fN.length) {
				for (i=0; i&lt;fN.length; i++) {
					if (/anonymous/.test(fN[i])) continue;
					while((l=fN[i].search(/\)[;\s]+/)) != -1) {
						fn=fN[i].substring(0,l+1);
						fN[i] = fN[i].substring(l+2);
						if (olre.test(fn)) eval(fn);
					}
				}
			}
		}
	}
}

// Wraps strings in Layer Generation Functions with the correct tags
//    endWrap true(if end tag) or false if start tag
//    fontSizeStr - font size string such as '1' or '10px'
//    whichString is being wrapped -- 'text', 'caption', or 'close'
function wrapStr(endWrap,fontSizeStr,whichString) {
	var fontStr, fontColor, isClose=((whichString=='close') ? 1 : 0), hasDims=/[%\-a-z]+$/.test(fontSizeStr);
	fontSizeStr = (olNs4) ? (!hasDims ? fontSizeStr : '1') : fontSizeStr;
	if (endWrap) return (hasDims&amp;&amp;!olNs4) ? (isClose ? '&lt;/span&gt;' : '&lt;/div&gt;') : '&lt;/font&gt;';
	else {
		fontStr='o3_'+whichString+'font';
		fontColor='o3_'+((whichString=='caption')? 'cap' : whichString)+'color';
		return (hasDims&amp;&amp;!olNs4) ? (isClose ? '&lt;span style=&quot;font-family: '+quoteMultiNameFonts(eval(fontStr))+'; color: '+eval(fontColor)+'; font-size: '+fontSizeStr+';&quot;&gt;' : '&lt;div style=&quot;font-family: '+quoteMultiNameFonts(eval(fontStr))+'; color: '+eval(fontColor)+'; font-size: '+fontSizeStr+';&quot;&gt;') : '&lt;font face=&quot;'+eval(fontStr)+'&quot; color=&quot;'+eval(fontColor)+'&quot; size=&quot;'+(parseInt(fontSizeStr)&gt;7 ? '7' : fontSizeStr)+'&quot;&gt;';
	}
}

// Quotes Multi word font names; needed for CSS Standards adherence in font-family
function quoteMultiNameFonts(theFont) {
	var v, pM=theFont.split(',');
	for (var i=0; i&lt;pM.length; i++) {
		v=pM[i];
		v=v.replace(/^\s+/,'').replace(/\s+$/,'');
		if(/\s/.test(v) &amp;&amp; !/[\'\&quot;]/.test(v)) {
			v=&quot;\'&quot;+v+&quot;\'&quot;;
			pM[i]=v;
		}
	}
	return pM.join();
}

// dummy function which will be overridden
function isExclusive(args) {
	return false;
}

// Sets cellpadding style string value
function setCellPadStr(parameter) {
	var Str='', j=0, ary = new Array(), top, bottom, left, right;

	Str+='padding: ';
	ary=parameter.replace(/\s+/g,'').split(',');

	switch(ary.length) {
		case 2:
			top=bottom=ary[j];
			left=right=ary[++j];
			break;
		case 3:
			top=ary[j];
			left=right=ary[++j];
			bottom=ary[++j];
			break;
		case 4:
			top=ary[j];
			right=ary[++j];
			bottom=ary[++j];
			left=ary[++j];
			break;
	}

	Str+= ((ary.length==1) ? ary[0] + 'px;' : top + 'px ' + right + 'px ' + bottom + 'px ' + left + 'px;');

	return Str;
}

// function will delay close by time milliseconds
function hideDelay(time) {
	if (time&amp;&amp;!o3_delay) {
		if (o3_timerid &gt; 0) clearTimeout(o3_timerid);

		o3_timerid=setTimeout(&quot;cClick()&quot;,(o3_timeout=time));
	}
}

// Was originally in the placeLayer() routine; separated out for future ease
function horizontalPlacement(browserWidth, horizontalScrollAmount, widthFix) {
	var placeX, iwidth=browserWidth, winoffset=horizontalScrollAmount;
	var parsedWidth = parseInt(o3_width);

	if (o3_fixx &gt; -1 || o3_relx != null) {
		// Fixed position
		placeX=(o3_relx != null ? ( o3_relx &lt; 0 ? winoffset +o3_relx+ iwidth - parsedWidth - widthFix : winoffset+o3_relx) : o3_fixx);
	} else {
		// If HAUTO, decide what to use.
		if (o3_hauto == 1) {
			if ((o3_x - winoffset) &gt; (iwidth / 2)) {
				o3_hpos = LEFT;
			} else {
				o3_hpos = RIGHT;
			}
		}

		// From mouse
		if (o3_hpos == CENTER) { // Center
			placeX = o3_x+o3_offsetx-(parsedWidth/2);

			if (placeX &lt; winoffset) placeX = winoffset;
		}

		if (o3_hpos == RIGHT) { // Right
			placeX = o3_x+o3_offsetx;

			if ((placeX+parsedWidth) &gt; (winoffset+iwidth - widthFix)) {
				placeX = iwidth+winoffset - parsedWidth - widthFix;
				if (placeX &lt; 0) placeX = 0;
			}
		}
		if (o3_hpos == LEFT) { // Left
			placeX = o3_x-o3_offsetx-parsedWidth;
			if (placeX &lt; winoffset) placeX = winoffset;
		}

		// Snapping!
		if (o3_snapx &gt; 1) {
			var snapping = placeX % o3_snapx;

			if (o3_hpos == LEFT) {
				placeX = placeX - (o3_snapx+snapping);
			} else {
				// CENTER and RIGHT
				placeX = placeX+(o3_snapx - snapping);
			}

			if (placeX &lt; winoffset) placeX = winoffset;
		}
	}

	return placeX;
}

// was originally in the placeLayer() routine; separated out for future ease
function verticalPlacement(browserHeight,verticalScrollAmount) {
	var placeY, iheight=browserHeight, scrolloffset=verticalScrollAmount;
	var parsedHeight=(o3_aboveheight ? parseInt(o3_aboveheight) : (olNs4 ? over.clip.height : over.offsetHeight));

	if (o3_fixy &gt; -1 || o3_rely != null) {
		// Fixed position
		placeY=(o3_rely != null ? (o3_rely &lt; 0 ? scrolloffset+o3_rely+iheight - parsedHeight : scrolloffset+o3_rely) : o3_fixy);
	} else {
		// If VAUTO, decide what to use.
		if (o3_vauto == 1) {
			if ((o3_y - scrolloffset) &gt; (iheight / 2) &amp;&amp; o3_vpos == BELOW &amp;&amp; (o3_y + parsedHeight + o3_offsety - (scrolloffset + iheight) &gt; 0)) {
				o3_vpos = ABOVE;
			} else if (o3_vpos == ABOVE &amp;&amp; (o3_y - (parsedHeight + o3_offsety) - scrolloffset &lt; 0)) {
				o3_vpos = BELOW;
			}
		}

		// From mouse
		if (o3_vpos == ABOVE) {
			if (o3_aboveheight == 0) o3_aboveheight = parsedHeight;

			placeY = o3_y - (o3_aboveheight+o3_offsety);
			if (placeY &lt; scrolloffset) placeY = scrolloffset;
		} else {
			// BELOW
			placeY = o3_y+o3_offsety;
		}

		// Snapping!
		if (o3_snapy &gt; 1) {
			var snapping = placeY % o3_snapy;

			if (o3_aboveheight &gt; 0 &amp;&amp; o3_vpos == ABOVE) {
				placeY = placeY - (o3_snapy+snapping);
			} else {
				placeY = placeY+(o3_snapy - snapping);
			}

			if (placeY &lt; scrolloffset) placeY = scrolloffset;
		}
	}

	return placeY;
}

// checks positioning flags
function checkPositionFlags() {
	if (olHautoFlag) olHautoFlag = o3_hauto=0;
	if (olVautoFlag) olVautoFlag = o3_vauto=0;
	return true;
}

// get Browser window width
function windowWidth() {
	var w;
	if (o3_frame.innerWidth) w=o3_frame.innerWidth;
	else if (eval('o3_frame.'+docRoot)&amp;&amp;eval(&quot;typeof o3_frame.&quot;+docRoot+&quot;.clientWidth=='number'&quot;)&amp;&amp;eval('o3_frame.'+docRoot+'.clientWidth'))
		w=eval('o3_frame.'+docRoot+'.clientWidth');
	return w;
}

// create the div container for popup content if it doesn't exist
function createDivContainer(id,frm,zValue) {
	id = (id || 'overDiv'), frm = (frm || o3_frame), zValue = (zValue || 1000);
	var objRef, divContainer = layerReference(id);

	if (divContainer == null) {
		if (olNs4) {
			divContainer = frm.document.layers[id] = new Layer(window.innerWidth, frm);
			objRef = divContainer;
		} else {
			var body = (olIe4 ? frm.document.all.tags('BODY')[0] : frm.document.getElementsByTagName(&quot;BODY&quot;)[0]);
			if (olIe4&amp;&amp;!document.getElementById) {
				body.insertAdjacentHTML(&quot;beforeEnd&quot;,'&lt;div id=&quot;'+id+'&quot;&gt;&lt;/div&gt;');
				divContainer=layerReference(id);
			} else {
				divContainer = frm.document.createElement(&quot;DIV&quot;);
				divContainer.id = id;
				body.appendChild(divContainer);
			}
			objRef = divContainer.style;
		}

		objRef.position = 'absolute';
		objRef.visibility = 'hidden';
		objRef.zIndex = zValue;
		if (olIe4&amp;&amp;!olOp) objRef.left = objRef.top = '0px';
		else objRef.left = objRef.top =  -10000 + (!olNs4 ? 'px' : 0);
	}

	return divContainer;
}

// get reference to a layer with ID=id
function layerReference(id) {
	return (olNs4 ? o3_frame.document.layers[id] : (document.all ? o3_frame.document.all[id] : o3_frame.document.getElementById(id)));
}
////////
//  UTILITY FUNCTIONS
////////

// Checks if something is a function.
function isFunction(fnRef) {
	var rtn = true;

	if (typeof fnRef == 'object') {
		for (var i = 0; i &lt; fnRef.length; i++) {
			if (typeof fnRef[i]=='function') continue;
			rtn = false;
			break;
		}
	} else if (typeof fnRef != 'function') {
		rtn = false;
	}

	return rtn;
}

// Converts an array into an argument string for use in eval.
function argToString(array, strtInd, argName) {
	var jS = strtInd, aS = '', ar = array;
	argName=(argName ? argName : 'ar');

	if (ar.length &gt; jS) {
		for (var k = jS; k &lt; ar.length; k++) aS += argName+'['+k+'], ';
		aS = aS.substring(0, aS.length-2);
	}

	return aS;
}

// Places a hook in the correct position in a hook point.
function reOrder(hookPt, fnRef, order) {
	var newPt = new Array(), match, i, j;

	if (!order || typeof order == 'undefined' || typeof order == 'number') return hookPt;

	if (typeof order=='function') {
		if (typeof fnRef=='object') {
			newPt = newPt.concat(fnRef);
		} else {
			newPt[newPt.length++]=fnRef;
		}

		for (i = 0; i &lt; hookPt.length; i++) {
			match = false;
			if (typeof fnRef == 'function' &amp;&amp; hookPt[i] == fnRef) {
				continue;
			} else {
				for(j = 0; j &lt; fnRef.length; j++) if (hookPt[i] == fnRef[j]) {
					match = true;
					break;
				}
			}
			if (!match) newPt[newPt.length++] = hookPt[i];
		}

		newPt[newPt.length++] = order;

	} else if (typeof order == 'object') {
		if (typeof fnRef == 'object') {
			newPt = newPt.concat(fnRef);
		} else {
			newPt[newPt.length++] = fnRef;
		}

		for (j = 0; j &lt; hookPt.length; j++) {
			match = false;
			if (typeof fnRef == 'function' &amp;&amp; hookPt[j] == fnRef) {
				continue;
			} else {
				for (i = 0; i &lt; fnRef.length; i++) if (hookPt[j] == fnRef[i]) {
					match = true;
					break;
				}
			}
			if (!match) newPt[newPt.length++]=hookPt[j];
		}

		for (i = 0; i &lt; newPt.length; i++) hookPt[i] = newPt[i];
		newPt.length = 0;

		for (j = 0; j &lt; hookPt.length; j++) {
			match = false;
			for (i = 0; i &lt; order.length; i++) {
				if (hookPt[j] == order[i]) {
					match = true;
					break;
				}
			}
			if (!match) newPt[newPt.length++] = hookPt[j];
		}
		newPt = newPt.concat(order);
	}

	hookPt = newPt;

	return hookPt;
}

////////
//  PLUGIN ACTIVATION FUNCTIONS
////////

// Runs plugin functions to set runtime variables.
function setRunTimeVariables(){
	if (typeof runTime != 'undefined' &amp;&amp; runTime.length) {
		for (var k = 0; k &lt; runTime.length; k++) {
			runTime[k]();
		}
	}
}

// Runs plugin functions to parse commands.
function parseCmdLine(pf, i, args) {
	if (typeof cmdLine != 'undefined' &amp;&amp; cmdLine.length) {
		for (var k = 0; k &lt; cmdLine.length; k++) {
			var j = cmdLine[k](pf, i, args);
			if (j &gt;- 1) {
				i = j;
				break;
			}
		}
	}

	return i;
}

// Runs plugin functions to do things after parse.
function postParseChecks(pf,args){
	if (typeof postParse != 'undefined' &amp;&amp; postParse.length) {
		for (var k = 0; k &lt; postParse.length; k++) {
			if (postParse[k](pf,args)) continue;
			return false;  // end now since have an error
		}
	}
	return true;
}


////////
//  PLUGIN REGISTRATION FUNCTIONS
////////

// Registers commands and creates constants.
function registerCommands(cmdStr) {
	if (typeof cmdStr!='string') return;

	var pM = cmdStr.split(',');
	pms = pms.concat(pM);

	for (var i = 0; i&lt; pM.length; i++) {
		eval(pM[i].toUpperCase()+'='+pmCount++);
	}
}

// Registers no-parameter commands
function registerNoParameterCommands(cmdStr) {
	if (!cmdStr &amp;&amp; typeof cmdStr != 'string') return;
	pmt=(!pmt) ? cmdStr : pmt + ',' + cmdStr;
}

// Register a function to hook at a certain point.
function registerHook(fnHookTo, fnRef, hookType, optPm) {
	var hookPt, last = typeof optPm;

	if (fnHookTo == 'plgIn'||fnHookTo == 'postParse') return;
	if (typeof hookPts[fnHookTo] == 'undefined') hookPts[fnHookTo] = new FunctionReference();

	hookPt = hookPts[fnHookTo];

	if (hookType != null) {
		if (hookType == FREPLACE) {
			hookPt.ovload = fnRef;  // replace normal overlib routine
			if (fnHookTo.indexOf('ol_content_') &gt; -1) hookPt.alt[pms[CSSOFF-1-pmStart]]=fnRef;

		} else if (hookType == FBEFORE || hookType == FAFTER) {
			var hookPt=(hookType == 1 ? hookPt.before : hookPt.after);

			if (typeof fnRef == 'object') {
				hookPt = hookPt.concat(fnRef);
			} else {
				hookPt[hookPt.length++] = fnRef;
			}

			if (optPm) hookPt = reOrder(hookPt, fnRef, optPm);

		} else if (hookType == FALTERNATE) {
			if (last=='number') hookPt.alt[pms[optPm-1-pmStart]] = fnRef;
		} else if (hookType == FCHAIN) {
			hookPt = hookPt.chain;
			if (typeof fnRef=='object') hookPt=hookPt.concat(fnRef); // add other functions
			else hookPt[hookPt.length++]=fnRef;
		}

		return;
	}
}

// Register a function that will set runtime variables.
function registerRunTimeFunction(fn) {
	if (isFunction(fn)) {
		if (typeof fn == 'object') {
			runTime = runTime.concat(fn);
		} else {
			runTime[runTime.length++] = fn;
		}
	}
}

// Register a function that will handle command parsing.
function registerCmdLineFunction(fn){
	if (isFunction(fn)) {
		if (typeof fn == 'object') {
			cmdLine = cmdLine.concat(fn);
		} else {
			cmdLine[cmdLine.length++] = fn;
		}
	}
}

// Register a function that does things after command parsing.
function registerPostParseFunction(fn){
	if (isFunction(fn)) {
		if (typeof fn == 'object') {
			postParse = postParse.concat(fn);
		} else {
			postParse[postParse.length++] = fn;
		}
	}
}

////////
//  PLUGIN REGISTRATION FUNCTIONS
////////

// Runs any hooks registered.
function runHook(fnHookTo, hookType) {
	var l = hookPts[fnHookTo], k, rtnVal = null, optPm, arS, ar = arguments;

	if (hookType == FREPLACE) {
		arS = argToString(ar, 2);

		if (typeof l == 'undefined' || !(l = l.ovload)) rtnVal = eval(fnHookTo+'('+arS+')');
		else rtnVal = eval('l('+arS+')');

	} else if (hookType == FBEFORE || hookType == FAFTER) {
		if (typeof l != 'undefined') {
			l=(hookType == 1 ? l.before : l.after);

			if (l.length) {
				arS = argToString(ar, 2);
				for (var k = 0; k &lt; l.length; k++) eval('l[k]('+arS+')');
			}
		}
	} else if (hookType == FALTERNATE) {
		optPm = ar[2];
		arS = argToString(ar, 3);

		if (typeof l == 'undefined' || (l = l.alt[pms[optPm-1-pmStart]]) == 'undefined') {
			rtnVal = eval(fnHookTo+'('+arS+')');
		} else {
			rtnVal = eval('l('+arS+')');
		}
	} else if (hookType == FCHAIN) {
		arS=argToString(ar,2);
		l=l.chain;

		for (k=l.length; k &gt; 0; k--) if((rtnVal=eval('l[k-1]('+arS+')'))!=void(0)) break;
	}

	return rtnVal;
}

////////
// OBJECT CONSTRUCTORS
////////

// Object for handling hooks.
function FunctionReference() {
	this.ovload = null;
	this.before = new Array();
	this.after = new Array();
	this.alt = new Array();
	this.chain = new Array();
}

// Object for simple access to the overLIB version used.
// Examples: simpleversion:351 major:3 minor:5 revision:1
function Info(version, prerelease) {
	this.version = version;
	this.prerelease = prerelease;

	this.simpleversion = Math.round(this.version*100);
	this.major = parseInt(this.simpleversion / 100);
	this.minor = parseInt(this.simpleversion / 10) - this.major * 10;
	this.revision = parseInt(this.simpleversion) - this.major * 100 - this.minor * 10;
	this.meets = meets;
}

// checks for Core Version required
function meets(reqdVersion) {
	return (!reqdVersion) ? false : this.simpleversion &gt;= Math.round(100*parseFloat(reqdVersion));
}


////////
// STANDARD REGISTRATIONS
////////
registerHook(&quot;ol_content_simple&quot;, ol_content_simple, FALTERNATE, CSSOFF);
registerHook(&quot;ol_content_caption&quot;, ol_content_caption, FALTERNATE, CSSOFF);
registerHook(&quot;ol_content_background&quot;, ol_content_background, FALTERNATE, CSSOFF);
registerHook(&quot;ol_content_simple&quot;, ol_content_simple, FALTERNATE, CSSCLASS);
registerHook(&quot;ol_content_caption&quot;, ol_content_caption, FALTERNATE, CSSCLASS);
registerHook(&quot;ol_content_background&quot;, ol_content_background, FALTERNATE, CSSCLASS);
registerPostParseFunction(checkPositionFlags);
registerHook(&quot;hideObject&quot;, nbspCleanup, FAFTER);
registerHook(&quot;horizontalPlacement&quot;, horizontalPlacement, FCHAIN);
registerHook(&quot;verticalPlacement&quot;, verticalPlacement, FCHAIN);
if (olNs4||(olIe5&amp;&amp;isMac)||olKq) olLoaded=1;
registerNoParameterCommands('sticky,autostatus,autostatuscap,fullhtml,hauto,vauto,closeclick,wrap,followmouse,mouseoff,compatmode');
///////
// ESTABLISH MOUSECAPTURING
///////

// Capture events, alt. diffuses the overlib function.
var olCheckMouseCapture=true;
if ((olNs4 || olNs6 || olIe4)) {
	olMouseCapture();
} else {
	overlib = no_overlib;
	nd = no_overlib;
	ver3fix = true;
}

/****************************************************************************
 * END overlib/overlib.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN instaview.js
 ****************************************************************************/

// $Id: instaview.js 1240 2006-02-24 11:51:03Z quarl $

// Synopsis:
//    foo.innerHTML = $instaview.convert(&quot;[[wiki]] markup&quot;);

// From User:Pilaf/instaview.js
//     Last update: 21:20, 11 February 2006 (UTC)

var $instaview = new Module('instaview.js');
$instaview.depend('md5.js', 'util.js', 'wikipage.js', 'wikins.js', 'wikiimg.js');

// Note: this file only contains the $instaview.convert library function; the
// functionality for annotating the 'edit' page is in instapreview.js.

/*
 * InstaView - a Mediawiki to HTML converter in JavaScript
 * Version 0.6
 * Copyright (C) Pedro Fayolle 2005
 * http://en.wikipedia.org/wiki/User:Pilaf
 * Distributed under the BSD license
 *
 * Changelog:
 *
 * 0.6
 * - Changed name to InstaView
 * - Some major code reorganizations and factored out some common functions
 * - Handled conversion of relative links (i.e. [[/foo]])
 * - Fixed misrendering of adjacent definition list items
 * - Fixed bug in table headings handling
 * - Changed date format in signatures to reflect Mediawiki's
 * - Fixed handling of [[:Image:...]]
 * - Updated MD5 function (hopefully it will work with UTF-8)
 * - Fixed bug in handling of links inside images
 *
 * To do:
 * - Better support for math
 * - Full support for nowiki
 * - Parser-based (against RegExp-based) inline wikicode handling (make it one pass)
 * - Support for templates (through AJAX)
 * - Support for coloured links (AJAX)
 */

// options
$instaview.options =
{
    default_thumb_width: 180,

    paths: {
        articles: '/wiki/',
        math: '/math/',
        magnify_icon: 'skins/common/images/magnify-clip.png'
    }
}

// define constants
$instaview.BLOCK_IMAGE = new RegExp('^\\[\\['+$wikins.Image+':.*?\\|.*?(?:frame|thumbnail|thumb|none|right|left|center)', 'i');

$instaview.dump = function(from, to)
{
    if (typeof from == 'string') from = document.getElementById(from)
    if (typeof to == 'string') to = document.getElementById(to)
    to.innerHTML = this.convert(from.value)
}

$instaview.imgCounter = 0;

$instaview.convert = function(wiki)
{
    var     ll = (typeof wiki == 'string')? wiki.split(/\n/): wiki, // lines of wikicode
        o='',   // output
        p=0,    // paragraph flag
        $r  // result of passing $() a regexp

    // some shorthands
    function remain() { return ll.length }
    function sh() { return ll.shift() } // shift
    function ps(s) { o+=s } // push

    function f() // similar to C's printf, uses ? as placeholders, ?? to escape question marks
    {
        var i=1,a=arguments,f=a[0],o='',c,p
        for (;i&lt;a.length; i++) if ((p=f.indexOf('?'))+1) {
            // allow character escaping
            i -= c=f.charAt(p+1)=='?'?1:0
            o += f.substring(0,p)+(c?'?':a[i])
            f=f.substr(p+1+c)
        } else break;
        return o+f
    }

    function strip_cr(s) { return s.replace(/\n\r/g,&quot;\n&quot;).replace(/\r/g,'') }
    function html_entities(s) { return s.replace(/&amp;/g,&quot;&amp;amp;&quot;).replace(/&lt;/g,&quot;&amp;lt;&quot;).replace(/&gt;/g,&quot;&amp;gt;&quot;) }

    function max(a,b) { return (a&gt;b)?a:b }
    function min(a,b) { return (a&lt;b)?a:b }

    // return the first non matching character position between two strings
    function str_imatch(a, b)
    {
        for (var i=0, l=min(a.length, b.length); i&lt;l; i++) if (a.charAt(i)!=b.charAt(i)) break
        return i
    }

    // compare against a string or regexp
    // if passed a regexp the result is stored in $r
    function $(c) { return (typeof c == 'string') ? (ll[0].substr(0,c.length)==c) : ($r = ll[0].match(c)) }

    function $$(c) { return ll[0]==c } // compare whole line
    function _(p) { return ll[0].charAt(p) } // return char at pos p

    function endl(s) { ps(s); sh() }

    function parse_list()
    {
        var prev='';

        while (remain() &amp;&amp; $(/^([*#:;]+)(.*)$/)) {

            var l_match = $r

            sh()

            var ipos = str_imatch(prev, l_match[1])

            // close uncontinued lists
            for (var i=prev.length-1; i &gt;= ipos; i--) {

                var pi = prev.charAt(i)

                if (pi=='*') ps('&lt;/ul&gt;')
                else if (pi=='#') ps('&lt;/ol&gt;')
                // close a dl only if the new item is not a dl item (:, ; or empty)
                else switch (l_match[1].charAt(i)) { case'':case'*':case'#': ps('&lt;/dl&gt;') }
            }

            // open new lists
            for (var i=ipos; i&lt;l_match[1].length; i++) {

                var li = l_match[1].charAt(i)

                if (li=='*') ps('&lt;ul&gt;')
                else if (li=='#') ps('&lt;ol&gt;')
                // open a new dl only if the prev item is not a dl item (:, ; or empty)
                else switch(prev.charAt(i)) { case'':case'*':case'#': ps('&lt;dl&gt;') }
            }

            switch (l_match[1].charAt(l_match[1].length-1)) {

                case '*': case '#':
                    ps('&lt;li&gt;' + parse_inline_nowiki(l_match[2])); break

                case ';':
                    ps('&lt;dt&gt;');

                    var dt_match;

                    // handle ;dt :dd format
                    if ((dt_match = l_match[2].match(/(.*?) (:.*?)$/))) {

                        ps(parse_inline_nowiki(dt_match[1]))
                        ll.unshift(dt_match[2])

                    } else ps(parse_inline_nowiki(l_match[2]))

                    break

                case ':':
                    ps('&lt;dd&gt;' + parse_inline_nowiki(l_match[2]))
            }

            prev=l_match[1]
        }

        // close remaining lists
        for (var i=prev.length-1; i&gt;=0; i--)
            ps(f('&lt;/?&gt;', (prev.charAt(i)=='*')? 'ul': ((prev.charAt(i)=='#')? 'ol': 'dl')))
    }

    function parse_table()
    {
        endl(f('&lt;table?&gt;', $(/^\{\|( .*)$/)? $r[1]: ''))

        for (;remain();) if ($('|')) switch (_(1)) {
            case '}': endl('&lt;/table&gt;'); return
            case '-': endl(f('&lt;tr ?&gt;', $(/\|-*(.*)/)[1])); break
            default: parse_table_data()
        }
        else if ($('!')) parse_table_data()
        else sh()
    }

    function parse_table_data()
    {
        var td_line, match_i

        // 1: &quot;|+&quot;, '|' or '+'
        // 2: ??
        // 3: attributes ??
        // TODO: finish commenting this regexp
        var td_match = sh().match(/^(\|\+|\||!)((?:([^[|]*?)\|(?!\|))?(.*))$/)

        if (td_match[1] == '|+') ps('&lt;caption');
        else ps('&lt;t' + ((td_match[1]=='|')?'d':'h'))

        if (typeof td_match[3] != 'undefined') {

            ps(' ' + td_match[3])
            match_i = 4

        } else match_i = 2

        ps('&gt;')

        if (td_match[1] != '|+') {

            // use || or !! as a cell separator depending on context
            // NOTE: when split() is passed a regexp make sure to use non-capturing brackets
            td_line = td_match[match_i].split((td_match[1] == '|')? '||': /(?:\|\||!!)/)

            ps(parse_inline_nowiki(td_line.shift()))

            while (td_line.length) ll.unshift(td_match[1] + td_line.pop())

        } else ps(td_match[match_i])

        var tc = 0, td = []

        for (;remain(); td.push(sh()))
        if ($('|')) {
            if (!tc) break // we're at the outer-most level (no nested tables), skip to td parse
            else if (_(1)=='}') tc--
        }
        else if (!tc &amp;&amp; $('!')) break
        else if ($('{|')) tc++

        if (td.length) ps($instaview.convert(td))
    }

    function parse_pre()
    {
        ps('&lt;pre&gt;')
        do endl(parse_inline_nowiki(ll[0].substring(1)) + &quot;\n&quot;); while (remain() &amp;&amp; $(' '))
        ps('&lt;/pre&gt;')
    }

    function parse_block_image()
    {
        ps(parse_image(sh()))
    }

    function parse_image(str)
    {
        // get what's in between &quot;[[Image:&quot; and &quot;]]&quot;
        var tag = str.substring($wikins.Image.length + 3, str.length - 2);

        var width;
        var attr = [], filename, caption = '';
        var thumb=0, frame=0, center=0;
        var align='';

        if (tag.match(/\|/)) {
            // manage nested links
            var nesting = 0;
            var last_attr;
            for (var i = tag.length-1; i &gt; 0; i--) {
                if (tag.charAt(i) == '|' &amp;&amp; !nesting) {
                    last_attr = tag.substr(i+1);
                    tag = tag.substring(0, i);
                    break;
                } else switch (tag.substr(i-1, 2)) {
                    case ']]':
                        nesting++;
                        i--;
                        break;
                    case '[[':
                        nesting--;
                        i--;
                }
            }

            attr = tag.split(/\s*\|\s*/);
            attr.push(last_attr);
            filename = attr.shift();

            var w_match;

            for (;attr.length; attr.shift()) {
                if ((w_match = attr[0].match(/^(\d*)px$/))) {
                    width = w_match[1];
                } else {
                    switch(attr[0]) {
                    case 'thumb':
                    case 'thumbnail':
                        thumb=true;
                    case 'frame':
                        frame=true;
                        break;
                    case 'none':
                    case 'right':
                    case 'left':
                        center=false;
                        align=attr[0];
                        break;
                    case 'center':
                        center=true;
                        align='none';
                        break;
                    default:
                        if (attr.length == 1) caption = attr[0];
                    }
                }
            }

        } else filename = tag;


        var o='';

        if (frame) {

            if (align=='') align = 'right';

            o += f(&quot;&lt;div class='thumb t?'&gt;&quot;, align);

            if (thumb) {
                if (!width) width = $instaview.options.default_thumb_width;

                o += f(&quot;&lt;div style='width:?px;'&gt;?&quot;, 2+width*1, make_image(filename, caption, width)) +
                    f(&quot;&lt;div class='thumbcaption'&gt;&lt;div class='magnify' style='float:right'&gt;&lt;a href='?' class='internal' title='Enlarge'&gt;&lt;img src='?'&gt;&lt;/a&gt;&lt;/div&gt;?&lt;/div&gt;&quot;,
                        $instaview.options.paths.articles + $wikins.Image + ':' + filename,
                        $instaview.options.paths.magnify_icon,
                        parse_inline_nowiki(caption)
                    )
            } else {
                o += '&lt;div&gt;' + make_image(filename, caption) + f(&quot;&lt;div class='thumbcaption'&gt;?&lt;/div&gt;&quot;, parse_inline_nowiki(caption))
            }

            o += '&lt;/div&gt;&lt;/div&gt;';

        } else if (align != '') {
            o += f(&quot;&lt;div class='float?'&gt;&lt;span&gt;?&lt;/span&gt;&lt;/div&gt;&quot;, align, make_image(filename, caption, width));
        } else {
            return make_image(filename, caption, width);
        }

        return center? f(&quot;&lt;div class='center'&gt;?&lt;/div&gt;&quot;, o): o;
    }

    function parse_inline_nowiki(str)
    {
        var start, lastend=0
        var substart=0, nestlev=0, open, close, subloop;
        var html='';

        while (-1 != (start = str.indexOf('&lt;nowiki&gt;', substart))) {
            html += parse_inline_wiki(str.substring(lastend, start));
            start += 8;
            substart = start;
            subloop = true;
            do {
                open = str.indexOf('&lt;nowiki&gt;', substart);
                close = str.indexOf('&lt;/nowiki&gt;', substart);
                if (close&lt;=open || open==-1) {
                    if (close==-1) {
                        return html + html_entities(str.substr(start));
                    }
                    substart = close+9;
                    if (nestlev) {
                        nestlev--;
                    } else {
                        lastend = substart;
                        html += html_entities(str.substring(start, lastend-9));
                        subloop = false;
                    }
                } else {
                    substart = open+8;
                    nestlev++;
                }
            } while (subloop)
        }

        return html + parse_inline_wiki(str.substr(lastend));
    }

    function make_image(filename, caption, width)
    {
        var id = 'instaview-img-' + $instaview.imgCounter++;

        if (width) {
            var source = $wikiimg.imageThumbURL(filename, WikiPage.server, width);
        } else {
            var source = $wikiimg.imageURL(filename, WikiPage.server);
        }

        caption = $util.trimSpaces(strip_inline_wiki(caption));

        if (width) width = &quot;width='&quot; + width + &quot;px'&quot;;

        var img = f(&quot;&lt;img src='?' ? ?&gt;&quot;, source, caption, width);

        // TODO: $wikiimg.makeAutoDlHtml
        // var img = f(&quot;&lt;img id='?' ? ?&gt;&quot;, id,
        //             caption ? &quot;alt='&quot; + caption + &quot;'&quot; : '',
        //             width);

        return f(&quot;&lt;a class='image' ? href='?'&gt;?&lt;/a&gt;&quot;,
                 caption ? &quot;title='&quot; + caption + &quot;'&quot; : '',
                 $instaview.options.paths.articles + $wikins.Image + ':' + filename,
                 img);
    }

    function parse_inline_images(str)
    {
        var start, substart=0, nestlev=0;
        var loop, close, open, wiki, html;

        while (-1 != (start=str.indexOf('[[', substart))) {
            if(str.substr(start+2).match(RegExp('^' + $wikins.Image + ':','i'))) {
                loop=true;
                substart=start;
                do {
                    substart+=2;
                    close=str.indexOf(']]',substart);
                    open=str.indexOf('[[',substart);
                    if (close&lt;=open||open==-1) {
                        if (close==-1) return str;
                        substart=close;
                        if (nestlev) {
                            nestlev--;
                        } else {
                            wiki=str.substring(start,close+2);
                            html=parse_image(wiki);
                            str=str.replace(wiki,html);
                            substart=start+html.length;
                            loop=false;
                        }
                    } else {
                        substart=open;
                        nestlev++;
                    }
                } while (loop)

            } else break;
        }

        return str;
    }

    function parse_inline_wiki(str)
    {
        var aux_match;

        str = parse_inline_images(str);

        while ((aux_match = str.match(/&lt;(?:)math&gt;(.*?)&lt;\/math&gt;/i))) {
            var math_md5 = $md5.hex_md5(aux_match[1]);
            str = str.replace(aux_match[0], f(&quot;&lt;img src='?.png'&gt;&quot;, $instaview.options.paths.math+math_md5));
        }

        // Build a Mediawiki-formatted date string
        var date = new Date;
        var minutes = date.getUTCMinutes();
        if (minutes &lt; 10) minutes = '0' + minutes;
        var date = f(&quot;?:?, ? ? ? (UTC)&quot;, date.getUTCHours(), minutes, date.getUTCDate(), $datetime.monthnames[date.getUTCMonth()], date.getUTCFullYear());

        // text formatting
        return str.
            replace(/'''''(.*?)''(.*?)'''/g, '&lt;strong&gt;&lt;em&gt;$1&lt;/em&gt;$2&lt;/strong&gt;').
            replace(/'''''(.*?)'''(.*?)''/g, '&lt;em&gt;&lt;strong&gt;$1&lt;/strong&gt;$2&lt;/em&gt;').
            replace(/'''(.*?)''(.*?)'''''/g, '&lt;strong&gt;$1&lt;em&gt;$2&lt;/em&gt;&lt;/strong&gt;').
            replace(/'''(.*?)'''/g, '&lt;strong&gt;$1&lt;/strong&gt;').
            replace(/''(.*?)''/g, '&lt;em&gt;$1&lt;/em&gt;').

            // signatures
            replace(/~{5}(?!~)/g, date).
            replace(/~{4}(?!~)/g, wikiDoc.username+' '+date).
            replace(/~{3}(?!~)/g, wikiDoc.username).

            // [[:Category:...]], [[:Image:...]], etc...
            replace(RegExp('\\[\\[:((?:'+$wikins.Category+'|'+$wikins.Image+'|'+$wikins.interwiki+'):.*?)\\]\\]','gi'), &quot;&lt;a href='&quot;+$instaview.options.paths.articles+&quot;$1'&gt;$1&lt;/a&gt;&quot;).
            replace(RegExp('\\[\\[(?:'+$wikins.Category+'|'+$wikins.interwiki+'):.*?\\]\\]','gi'),'').

            // [[/Relative links]]
            replace(/\[\[(\/[^|]*?)\]\]/g, f(&quot;&lt;a href='?$1'&gt;$1&lt;/a&gt;&quot;, location)).

            // [[/Replaced|Relative links]]
            replace(/\[\[(\/.*?)\|(.+?)\]\]/g, f(&quot;&lt;a href='?$1'&gt;$2&lt;/a&gt;&quot;, location)).

            // [[Common links]]
            replace(/\[\[([^|]*?)\]\](\w*)/g, f(&quot;&lt;a href='?$1'&gt;$1$2&lt;/a&gt;&quot;, $instaview.options.paths.articles)).

            // [[Replaced|Links]]
            replace(/\[\[(.*?)\|([^\]]+?)\]\](\w*)/g, f(&quot;&lt;a href='?$1'&gt;$2$3&lt;/a&gt;&quot;, $instaview.options.paths.articles)).

            // [[Stripped:Namespace|Namespace]]
            replace(/\[\[([^\]]*?:)?(.*?)( *\(.*?\))?\|\]\]/g, f(&quot;&lt;a href='?$1$2$3'&gt;$2&lt;/a&gt;&quot;, $instaview.options.paths.articles)).

            // External links
            replace(/\[(https?|news|ftp|mailto|gopher|irc):(\/*)([^\]]*?) (.*?)\]/g, &quot;&lt;a href='$1:$2$3'&gt;$4&lt;/a&gt;&quot;).
            replace(/\[http:\/\/(.*?)\]/g, &quot;&lt;a href='http://$1'&gt;[#]&lt;/a&gt;&quot;).
            replace(/\[(news|ftp|mailto|gopher|irc):(\/*)(.*?)\]/g, &quot;&lt;a href='$1:$2$3'&gt;$1:$2$3&lt;/a&gt;&quot;).
            replace(/(^| )(https?|news|ftp|mailto|gopher|irc):(\/*)([^ $]*)/g, &quot;$1&lt;a href='$2:$3$4'&gt;$2:$3$4&lt;/a&gt;&quot;).

            replace('__NOTOC__','').
            replace('__NOEDITSECTION__','');
    }

    function strip_inline_wiki(str)
    {
        return str
            .replace(/\[\[[^\]]*\|(.*?)\]\]/g,'$1')
            .replace(/\[\[(.*?)\]\]/g,'$1')
            .replace(/''(.*?)''/g,'$1');
    }

    // begin parsing
    for (;remain();) if ($(/^(={1,6})(.*)\1(.*)$/)) {
        p=0
        endl(f('&lt;h?&gt;?&lt;/h?&gt;?', $r[1].length, parse_inline_nowiki($r[2]), $r[1].length, $r[3]))

    } else if ($(/^[*#:;]/)) {
        p=0
        parse_list()

    } else if ($(' ')) {
        p=0
        parse_pre()

    } else if ($('{|')) {
        p=0
        parse_table()

    } else if ($(/^----+$/)) {
        p=0
        endl('&lt;hr/&gt;')

    } else if ($($instaview.BLOCK_IMAGE)) {
        p=0
        parse_block_image()

    } else {

        if ($$('')) {
            if ((p = (remain()&gt;1 &amp;&amp; ll[1]==('')))) endl('&lt;p&gt;&lt;br/&gt;');
        } else {
            if(!p) {
                ps('&lt;p&gt;')
                p=1
            }
            ps(parse_inline_nowiki(ll[0]) + ' ')
        }

        sh();
    }

    // from Lupin.
    // TODO: fix this in the code itself!

    var fixHTML = function(s) {
        // work around quoting bug:
        // wiki2html('[[Foo\'s &quot;bar&quot;]]') gives &lt;a href='Foo's &quot;bar&quot;'&gt; which doesn't do very well
        // we change this into &lt;a href=&quot;Foo's %22bar%22&quot;&gt;
        var splitted=s.parenSplit(/href='([^&gt;]*)'/g);
        var ret='';
        for (var i=0; i&lt;splitted.length; ++i) {
            if(i%2==0) { ret += splitted[i]; continue; }
            if(i%2==1) { ret += 'href=&quot;' + splitted[i].split('&quot;').join('%22') + '&quot;'; }
        }
        return ret;
    }

    o = fixHTML(o);

    return o;
};

/****************************************************************************
 * END instaview.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN instaviewtiny.js
 ****************************************************************************/

// $Id: instaviewtiny.js 1245 2006-02-24 20:50:18Z quarl $

// instaviewtiny - make a 1-paragraph preview of a wiki page

// synopsis:
//   html = $instaviewtiny.makePreview(s)

// originally from Lupin's popups.js's previewMaker

var $instaviewtiny = new Module('instaviewtiny.js');
$instaviewtiny.depend('instaview.js');

$instaviewtiny.options = {
    max_sentences: 4,
    max_characters: 600,
    first_paragraph_only: true
};

$instaviewtiny.previewMaker = function(wikiText) {
    this.data=wikiText;
}

$instaviewtiny.previewMaker.prototype.killComments = function () {
    this.data=this.data.replace(RegExp('&lt;!--(\\n|.)*?--&gt;', 'g'), '');
};

$instaviewtiny.previewMaker.prototype.killDivs=function () {
    // say goodbye, divs (can be nested, so use * not *?)
    this.data=this.data.replace(RegExp('&lt; *div[^&gt;]* *&gt;[\\s\\S]*&lt; */ *div *&gt;',
                                       'gi'), '');
};

$instaviewtiny.previewMaker.prototype.killGalleries=function () {
    this.data=this.data.replace(RegExp('&lt; *gallery[^&gt;]* *&gt;[\\s\\S]*?&lt; */ *gallery *&gt;',
                                       'gi'), '');
};

$instaviewtiny.previewMaker.prototype.killBoxTemplates=function () {
    // taxobox hack... in fact, there's a saudiprincebox_begin, so let's be more general
    this.data=this.data.replace(RegExp('[{][{][^}\\s|]*box[ _](begin|start)' +
                                       '[\\s\\S]*[^{\\s|]*box[ _](end|finish) *[}][}]', 'gi'), '');

    // also, have float_begin, ... float_end
    this.data=this.data.replace(RegExp('[{][{][^}\\s|]*float[ _]begin' +
                                       '[\\s\\S]*[^{\\s|]*float[ _]end.*?[}][}]',
                                       'gi'), '');

    // from [[User:Zyxw/popups.js]]: kill frames too
    this.data=this.data.replace(RegExp('[{][{][^}\\s|]*frame' +
                                       '[\\s\\S]*[^{\\s|]*[Ee][_ ]+frame[}][}]', 'gi'), '');
};

$instaviewtiny.previewMaker.prototype.killTemplates = function () {
    this.data=this.data.replace(RegExp('[{][{]([{][{][^}]*[}][}]|[^{}])*[}][}]', 'g'), ' ');
};

$instaviewtiny.previewMaker.prototype.killMultilineTemplates = function() {
  this.data=this.data.replace(RegExp('\\s*[{][{][^{}]*\\n[^{}]*[}][}]', 'g'), ' ');
}

$instaviewtiny.previewMaker.prototype.stripLongTemplates = function() {
    // operates on the HTML!
    this.html=this.html.replace(RegExp('^.{0,1000}[{][{][^}]*?(&lt;(p|br)( /)?&gt;\\s*){2,}([^{}]*?[}][}])?', 'gi'), '');
    this.html=this.html.split('\n').join(' '); // workaround for &lt;pre&gt; templates
    this.html=this.html.replace(RegExp('[{][{][^}]*&lt;pre&gt;[^}]*[}][}]','gi'), '');
    //this.html=this.html.replace(RegExp('[{][{]([^}]*|\\s){0,50}?&lt;pre&gt;[^{}]*?[}][}]', 'gi'), '');
    //window.h=this.html;
    //alert(this.html);
}


$instaviewtiny.previewMaker.prototype.killTables=function () {
    // tables are bad, too
    this.data=this.data.replace
    (RegExp('[{]\\|([{][|]([^\\|]|\\|[^}])*[|][}]|[^\\|]|\\|[^}])*\\|[}]', 'g')
     , '');
    // remove lines starting with a pipe
    this.data=this.data.replace(RegExp('^[|].*$', 'mg'), '');
};

$instaviewtiny.previewMaker.prototype.killImages=function () {
    // images are a nono
    // who says regexes aren't fun?
    // i think we should match:
    // [[image: ...... ]] where ....... consists of repetitions of any of:
    // 1. not [ or ]
    // 2. [[ (not ])* ]]
    // 3. [ (not ])* ]
    var imagedetector =
    '[[][[]\\s*('+
    $wikins.Image + '|' + $wikins.Category+
    ')\\s*:([^\\[\\]]|\\[\\[[^\\]]*\\]\\]|\\[[^\\]]*\\])*\\]\\]';
    var crudeImageRegex = RegExp(imagedetector, 'gi');
    this.data=this.data.replace(crudeImageRegex, '');
};

$instaviewtiny.previewMaker.prototype.killHTML=function () {
    // kill html tables // this doesn't cope with embedded tables
    // may this is good enough?
    this.data=this.data.replace(RegExp('&lt;table.*?&gt;(.|\\n.)*?\\n?&lt;/ *table *&gt;\\n+', 'gi'), '');

    // let's also delete entire lines starting with &lt;. it's worth a try.
    this.data=this.data.replace(RegExp('(^|\\n) *&lt;.*', 'g'), '\n');

    // and those pesky html tags
    this.data=this.data.replace(RegExp('&lt;.*?&gt;','g'),'');
};

$instaviewtiny.previewMaker.prototype.killChunks=function() { // heuristics alert
    // chunks of italic text? you crazy, man?
    var italicChunkRegex=new RegExp
    (&quot;((^|\\n)\\s*:*\\s*''[^']([^']|'''|'[^']){20}(.|\\n[^\\n])*''[.!?\\s]*\\n)*&quot;, 'g');
    this.data=this.data.replace(italicChunkRegex, '');
};

$instaviewtiny.previewMaker.prototype.mopup=function () {
    // we simply *can't* be doing with horizontal rules right now
    this.data=this.data.replace(RegExp('^-{4,}','mg'),'');

    // no indented lines
    this.data=this.data.replace(RegExp('(^|\\n) *:[^\\n]*','g'), '\n');

    // replace __TOC__, __NOTOC__ and whatever else there is
    // this'll probably do
    this.data=this.data.replace(RegExp('^__[A-Z_]*__ *$', 'gmi'),'');
};

$instaviewtiny.previewMaker.prototype.firstBit=function () {
    // dont't be givin' me no subsequent paragraphs, you hear me?
    /// first we &quot;normalize&quot; section headings, removing whitespace after, adding before

    this.data=this.data.replace(RegExp('\\s*(==+[^=]*==+)\\s*', 'g'), '\n\n$1 ');

    /// then we want to get rid of paragraph breaks whose text ends badly
    this.data=this.data.replace(RegExp('([:;]) *\\n{2,}', 'g'), '$1\n');

    this.data=this.data.replace(RegExp('^[\\s\\n]*'), '');
    var d = this.data;
    if ($instaviewtiny.options.first_paragraph_only) {
        var stuff=(RegExp('^([^\\n]|\\n[^\\n\\s])*')).exec(this.data);
        if (stuff) d = stuff[0];
    };

    /// now put \n\n after sections so that bullets and numbered lists work
    d=d.replace(RegExp('(==+[^=]*==+)\\s*', 'g'), '$1\n\n');

    // superfluous sentences are RIGHT OUT.
    // note: exactly 1 set of parens here needed to make the slice work
    d = d.parenSplit(RegExp('([!?.]+[&quot;'+&quot;'&quot;+']*\\s)','g'));
    // remove leading spaces
    d[0]=d[0].replace(/^\s+/, '');

    var notSentenceEnds=RegExp('([^.][a-z][.][a-z]|etc|sic|Dr|Mr|Mrs|Ms)$'
                               + '|' +
                               '\\[[^\\]]*$'
                               , 'i');

    d = $instaviewtiny.fixSentenceEnds(d, notSentenceEnds);

    var n = $instaviewtiny.options.max_sentences;
    var dd;

    do {dd=$instaviewtiny.firstSentences(d,n); --n; }
    while ( dd.length &gt; $instaviewtiny.options.max_characters &amp;&amp; n &gt; 0 );

    this.data = dd;
};

$instaviewtiny.fixSentenceEnds=function(strs, reg) {
    // take an array of strings, strs
    // join strs[i] to strs[i+1] &amp; strs[i+2] if strs[i] matches regex reg

    for (var i=0; i&lt;strs.length-2; ++i) {
        if (reg.test(strs[i])) {
            a=[];
            for (var j=0; j&lt;strs.length; ++j) {
                if (j&lt;i)   a[j]=strs[j];
                if (j==i)  a[i]=strs[i]+strs[i+1]+strs[i+2];
                if (j&gt;i+2) a[j-2]=strs[j];
            }
            return $instaviewtiny.fixSentenceEnds(a,reg);
        }
    }
    return strs;
};

$instaviewtiny.firstSentences=function(strs, howmany) {
    var t=strs.slice(0, 2*howmany);
    return t.join('');
};

$instaviewtiny.previewMaker.prototype.makePreview=function() {
    this.killComments();
    this.killDivs();
    this.killGalleries();
    this.killBoxTemplates();

    if (getValueOf('popupPreviewKillTemplates')) {
        this.killTemplates();
    } else {
        this.killMultilineTemplates();
    }

    this.killTables();
    this.killImages();
    this.killHTML();
    this.killChunks();
    this.mopup();

    this.firstBit();

    this.html = $instaview.convert(this.data);

    this.stripLongTemplates();

    this.html = $util.trimSpaces(this.html);

    return this.html;
};


$instaviewtiny.makePreview = function(s) {
    var v = new $instaviewtiny.previewMaker(s);
    v.makePreview();
    return v.html || null;
}

/****************************************************************************
 * END instaviewtiny.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN notes.js
 ****************************************************************************/

// $Id: notes.js 1122 2006-02-23 07:41:53Z quarl $

// from http://en.wikipedia.org/wiki/User:Zocky/PicturePopups.js

var $notes = new Module('notes.js');
$notes.depend('util.js', 'drag.js');
$notes.depend('notes.css');

$notes.load = function() {
    $notes.container = document.getElementById('globalWrapper');
}

$notes.top = 100;

$notes.Note = function(params) {
    if (!(this instanceof $notes.Note)) return new $notes.Note(params);
    var note = this;

    var div = note.div = document.createElement(&quot;div&quot;);

    div.className = 'note ' + params.className;
    div.setAttribute('minimized', 0);

    div.innerHTML = ('&lt;table&gt;&lt;tr class=&quot;note-titlebar&quot;&gt;'
                     + '&lt;td class=&quot;note-title&quot;&gt;&lt;span&gt;'
                     + params.title + '&lt;/span&gt;&lt;/td&gt;'
                     + '&lt;td class=&quot;note-icons&quot; align=&quot;right&quot;&gt;&lt;/td&gt;&lt;/tr&gt;'
                     + '&lt;tr&gt;&lt;td class=&quot;note-content&quot; colspan=&quot;2&quot;&gt;'
                     + params.content + '&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;');
    var tds = div.getElementsByTagName('td');
    note.contentCell = tds[2];
    tds[1].appendChild(note._makeIcons());

    $drag.makeDraggable(div, null,
                        { onPickup: function() { note.bringToFront(); },
                          pickupCondition: function(e) { return !e.ctrlKey; } });

    note.setLocation(params.x, params.y);
    note.show();
    return note;
}

$notes.Note.prototype.setLocation = function(x, y) {
    var div = this.div;
    x&gt;0 ? (div.style.left = x + &quot;px&quot;) : (div.style.right = -x + &quot;px&quot;);
    y&gt;0 ? (div.style.top = y + &quot;px&quot;)  : (div.style.bottom = -y + &quot;px&quot;);
}

$notes.Note.prototype.show = function()
{
    this.closed = false;
    this.bringToFront();
    $notes.container.appendChild(this.div);
}

$notes.Note.prototype._makeIcons = function()
{
    var note = this;
    var span = document.createElement('nobr');
    span.innerHTML = ('[&lt;a&gt; - &lt;/a&gt;] [&lt;a&gt; x &lt;/a&gt;]');;

    var links = span.getElementsByTagName('a');
    links[0].onclick = function() { note.toggleMinimized() };
    links[1].onclick = function() { note.close(); };
    return span;
}

$notes.Note.prototype.close = function() {
    this.closed = true;
    $notes.container.removeChild(this.div);
}

$notes.Note.prototype.toggleShow = function() {
    if (this.closed) {
        // a previously closed note - just show it again in the same location
        this.show();
    } else {
        // currently showing the note; close it
        this.close();
    }
}

$notes.Note.prototype.toggleMinimized = function() {
    // 'minimized' attribute is used by stylesheet
    this.div.setAttribute('minimized', 1 - this.div.getAttribute('minimized'));
}

$notes.Note.prototype.bringToFront = function() {
    this.div.style.zIndex = ++$notes.top;
}

$util.addOnloadHook($notes.load);

/****************************************************************************
 * END notes.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN linkedit.js
 ****************************************************************************/

// $Id: linkedit.js 1228 2006-02-24 10:46:38Z quarl $

// quarl 2006-02-24 initial version - based on popups.js changeLinkTargetLink

// TODO: more intelligent bypassing for prefixes, e.g. [[Humankind]] -&gt;
// [[Human]]kind rather than [[Human|Humankind]].

var $linkedit = new Module('linkedit.js');
$linkedit.depend('wikiedit.js');

$linkedit.options = {
    dab_summary: 'Disambiguating from [[$1]] to [[$2]]',
    dab_button: 'wpSave',
    redir_summary: 'Redirection bypass from [[$1]] to [[$2]]',
    redir_button: 'wpDiff',
    n_changes: ' ($1 changes)'
};

// changes links pointing to origTarget to newTarget.
//
// if newTarget is null, remove the link
//
// returns { wtext: new_wtext, count: number_of_changes }
$linkedit.changeLink = function(wtext, origTarget, newTarget)
{
    // newTarget = $util.wpaEscape(newTarget)

    var re = ($popups._reUpperOrLower($util.reEscape(origTarget.charAt(0))) +
              $util.reEscape(origTarget.substring(1)));

    re = re.replace(/[_ ]+/g, '[_ ]+');
    re = re.replace(/\(/g, '(?:%28|\\()');
    re = re.replace(/\)/g, '(?:%29|\\))');
    re = '\\s*(' + re + ')\\s*';

    // e.g. Computer (archaic) -&gt; \s*([Cc]omputer[_ ](?:%28|\()archaic(?:%28|\)))\s*

    var count = 0; var r;
    if (newTarget == null) {
        // delete link
        r = $util.reReplaceAll(wtext, '\\[\\['+re+'\\]\\]', '$1'); wtext = r.str; count += r.count;
        r = $util.reReplaceAll(wtext, '\\[\\['+re+'\\|(.*?)\\]\\]', '$2'); wtext = r.str; count += r.count;
    } else {
        // change link
        r = $util.reReplaceAll(wtext, '\\[\\['+re+'\\]\\]', '[['+newTarget+'|$1]]'); wtext = r.str; count += r.count;
        r = $util.reReplaceAll(wtext, '\\[\\['+re+'\\|', '[['+newTarget+'|'); wtext = r.str; count += r.count;
    }
    return {wtext: wtext, count: count};
};

$linkedit.editLink = function(wp, origTarget, newTarget, summary, button)
{
    wp.getEditorAsync(function(editor) {
            var r = $linkedit.changeLink(editor.wpTextbox1, origTarget, newTarget);
            if (r.count == 0) {
                alert(&quot;No changes made!&quot;);
                return;
            }
            editor.wpTextbox1 = r.wtext;
            editor.wpSummary = $util.pprintf(summary, origTarget, newTarget);
            if (r.count &gt; 1) {
                editor.wpSummary += $util.pprintf($linkedit.options.n_changes, r.count);
            }
            editor.wpMinoredit = true;
            editor.submit(button);
        });
};

$linkedit.editLinkDisambig = function(wp, origTarget, newTarget)
{
    $linkedit.editLink(wp, origTarget, newTarget,
                       $linkedit.options.dab_summary,
                       $linkedit.options.dab_button);
};

$linkedit.editRedirectBypass = function(wp, origTarget, newTarget)
{
    $linkedit.editLink(wp, origTarget, newTarget,
                       $linkedit.options.redir_summary,
                       $linkedit.options.redir_button);
};

/****************************************************************************
 * END linkedit.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN sig.js
 ****************************************************************************/

// -*- coding: utf-8 -*-
// $Id: sig.js 465 2006-02-14 12:26:12Z quarl $

// sig.js - allows advanced custom signatures.
//
//   - &quot;&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;&quot; is replaced by anything you want (any string or function) when you hit 'submit'
//   - Defaults to nicely-formatted and [[ISO 8061]] timestamp
//       - Wiki-linked timestamp enables date preferences
//       - Uses &lt;span class=&quot;user-Username&quot;&gt; tags around entire signature (including timestamp) - see [[User:HorsePunchKid]]
//   - the toolbar &quot;--&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;&quot; button is replaced by anything you want
//
//   - You could even use this to vary your signature based on the article or namespace
//     (for example an extra link on AFD pages)

///////////////////////////////////////////////////////////////
// EXTERNAL ENTRY POINTS
//
// makeSignature():     Returns the custom signature.
//

///////////////////////////////////////////////////////////////
// USER-CONFIGURABLE SETTINGS

// signature:           This is your signature. (can be string or function)
//
//                      To emulate normal behavior:
//                          signature = '&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
//
//                      Default:
//                          signature = build_default_signature;
//
//                      Other examples:
//                          signature = function() { return '--~~~ ' + wikiTimestampISO() }
//                          signature = '&lt;i&gt;&amp;mdash;[[User:Quarl|Quarl]] &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;~&lt;/i&gt;';
//
//
// toolbar_signature:   What the &quot;signature&quot; toolbar button inserts. (can be string or function)
//                      I recommend removing the '--' (or &amp;mdash;) and having it instead be part of the signature.
//
//                      To emulate normal behavior:
//                          toolbar_signature = '--&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
//
//                      Default:
//                          toolbar_signature = '&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
//
//                      Other examples:
//                          toolbar_signature = makeSignature;
//                          toolbar_signature = '&amp;mdash;&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
//

//
// The following are used by build_default_signature.
//
// sig_username:        Used by build_default_signature as username in CSS span tag class name.
//                      Result is &lt;span user-Quarl&gt; for sig_user='Quarl'.  (can be string or function)
//
//                      Default (should work for most people):
//                          sig_username = wikiDoc.username; // read from Wikipedia page
//
//                      Other examples:
//                          sig_username = 'QuarlXYZ';
//
// signature_user:      Used by build_default_signature for username wiki link. (can be string or function)
//                      I recommend embedding the &amp;mdash; so you don't have to type it every time.
//
//                      To emulate normal behavior:
//                          signature_user = '~~~';
//
//                      Default:
//                          signature_user = '&amp;mdash;~~~';
//
//                      Other examples:
//                          signature_user = '[[User:Quarl|Quarl]] &lt;sup&gt;([[User talk:quarl|talk]])&lt;/sup&gt;';
//
// signature_timestamp: Used by build_default_signature for timestamp (can be string or function).
//                      I recommend using wikiTimestampISO since I love [[ISO 8601]] time format, and
//                      this would allow everyone to see their preferred time format.
//
//                      To emulate normal behavior:
//                          signature_timestamp = '&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;~';
//
//                      Default:
//                          signature_timestamp = wikiTimestampISO;
//

// To allow use of advanced_sig.js in other scripts but not require it, use the following:
//      if(typeof window.makeSignature=='undefined')makeSignature=function(){return &quot;&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;&quot;};

// quarl 2005-12-30 initial version
// quarl 2006-01-04 add feature to replace &quot;&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;&quot; in text; factored it so it's easy to customize

// If this script looks simple, it's because all the hard stuff has been
// factored out to the library :)

var $sig = new Module('sig.js');
$sig.depend('util.js', 'datetime.js', 'autoreplace.js', 'wikipage.js');

$sig.getUsername = function() { return wikiDoc.username; }

$sig.wikiTimestampISO = function() {
    // return &quot;[[&quot;+$datetime.datestampUTCISO()+&quot;]]&amp;nbsp;&quot;+$datetime.timestampUTCISO()+&quot;[[ISO 8601|Z]]&quot;;
    return &quot;[[&quot;+$datetime.datestampUTCISO()+&quot;]] &quot;+$datetime.timestampUTCISO()+&quot;Z&quot;;
}

$sig.spansig = function(user, sigUser, sigTimestamp) {
    return '&lt;span class=&quot;user-sig user-'+user+'&quot;&gt;&lt;i&gt;' + sigUser +  ' &lt;small&gt;'+sigTimestamp+'&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
}

$sig.build_default_signature = function() {
    return $sig.spansig($util.funkyval($sig.options.sig_username),
                        $util.funkyval($sig.options.signature_user),
                        $util.funkyval($sig.options.signature_timestamp));
}

$sig.makeSignature = function() { return $util.funkyval($sig.options.signature) };

$sig.replaceSignatureButton = function() {
    // Note: a slightly more complicated version is required to replace the signature with the evaluation of getToolbarSignature() at the time of pressing the button rather than time of page load, but it doesn't matter if you are just replacing it with &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt; and using autoreplace as below.
    var toolbar = document.getElementById('toolbar');
    if (!toolbar) return;
    var links = toolbar.getElementsByTagName('a');
    for (var i = 0; i &lt; links.length; i++) {
        links[i].href = links[i].href.replace(/--&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;/, $util.funkyval($sig.options.toolbar_signature));
    }
}

$sig.replaceSignatureOnSubmit = function() {
    $autoreplace.addReplacement('&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;', $sig.makeSignature);
}

///////////////////////////////////////////////////////////////
// user-configurable settings (see top of page for commentary)

$sig.options = {
    signature: $sig.build_default_signature,
    sig_username: $sig.getUsername,
    // signature_user: '&amp;mdash;~~~',
    signature_user: '&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;',
    signature_timestamp: $sig.wikiTimestampISO,
    toolbar_signature: '&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;'
};

$util.addOnloadHook($sig.replaceSignatureButton);
$util.addOnloadHook($sig.replaceSignatureOnSubmit);

/****************************************************************************
 * END sig.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN rollback.js
 ****************************************************************************/

// $Id: rollback.js 1206 2006-02-24 09:10:37Z quarl $

// rollback.js - rollback button for non-admins

// USAGE:
//    $module.depend('rollback.js');
//    $rollback.widgetLoad();

// based on http://sam.zoy.org/wikipedia/godmode-light.js
//   - more robust (works with Popups, etc)
//   - factored code


// -----------------------------------------------------------------------------
// God-like Monobook skin
// (c) 2005 Sam Hocevar &lt;sam@zoy.org&gt;
// Forked from: Id: godmode-light.js 980 2005-11-12 01:51:51Z sam
// -----------------------------------------------------------------------------

// -----------------------------------------------------------------------------
// Language support, taken from phase3/languages/*
// -----------------------------------------------------------------------------

var $rollback = new Module('rollback.js');
$rollback.depend('util.js', 'md5.js', 'wikipage.js', 'wikiedit.js');

$rollback.options = {
    link_text: 'rollback',

    // var $rollback.cantrollback = 'Cannot revert edit; last contributor is only author of this page.';
    // var $rollback.alreadyrolled = 'Cannot rollback last edit of [[$1]] by [[User:$2|$2]] ([[User talk:$2|Talk]]); someone else has edited or rolled back the page already. Last edit was by [[User:$3|$3]] ([[User talk:$3|Talk]]). ';

    summary: 'Reverted edits by [[User:$2|$2]] ([[User talk:$2|t]]) ([[Special:Contributions/$2|c]]) to last version by $1'
};

$rollback.revert = function() {
    var token = WikiDocument.queryVars['token'];
    $rollback.vandal = WikiDocument.queryVars['vandal'];

    document.cont = document.getElementById('bodyContent');

    document.cont.innerHTML = 'Please wait, reverting edits by ' + $rollback.vandal + '...';
    // Avoid XSS attacks via authentication token
    if (!token || token != $rollback._mkToken(wikiPage, $rollback.vandal)) {
        document.cont.innerHTML += 'ERROR: Bad authentication token!';
        return;
    }

    document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Getting article history...';
    $util.asyncDownloadXML(wikiPage.qurl + '&amp;action=history&amp;limit=50', $rollback._revert2);
}

// Get the vandal and new editor names
$rollback._parseHistory = function(doc) {
    var l = doc.getElementById('pagehistory').getElementsByTagName('li');
    for (i = 0; i &lt; l.length; i++) {
        var name = l[i].getElementsByTagName('span')[0].getElementsByTagName('a')[0].innerHTML.replace(/_/g,' ');
        if (!name) continue;
        if (i == 0) {
            if (name != $rollback.vandal) {
                document.cont.innerHTML += '&lt;br /&gt;Error: Last editor is ' + name + ', not ' + $rollback.vandal + '!';
                return {};
            }
        } else {
            if (name != $rollback.vandal) {
                var oldid = l[i].getElementsByTagName('input')[0].value;
                var editor = name;
                return {'oldid':oldid, 'editor':editor};
            }
        }
    }
    return {};
}

$rollback._revert2 = function(xmlhttp) {
    doc = xmlhttp.responseXML;

    var r = $rollback._parseHistory(doc);
    var oldid = r.oldid;
    $rollback.editor = r.editor;
    if (!$rollback.editor) {
        document.cont.innerHTML += '&lt;br /&gt;Error: ' + $rollback.vandal + ' is the only editor!';
        return;
    }

    var url = wikiPage.qurl + '&amp;action=edit&amp;oldid=' + oldid;
    document.cont.innerHTML += '&lt;br /&gt;Getting article edit form...';
    $util.asyncDownloadXML(url, $rollback._revert3);
}

$rollback._revert3 = function(xmlhttp) {
    summary_text = $util.pprintf($rollback.options.summary,
                                 $rollback.editor,
                                 $rollback.vandal);

    document.cont.innerHTML += '&lt;br /&gt;Submitting form...';

    var wd = new WikiDocument(xmlhttp.responseXML, wikiPage);
    var editor = new WikiEditor(wd);
    editor.wpSummary = summary_text;
    editor.submit();
}

$rollback._mkToken = function(wp, vandal) {
    return $token.makeAuthToken('rollback', wp.page, vandal);
}

$rollback._mkUrl = function(wp, vandal) {
    return $util.urlGetPath(wp.qurl + '&amp;fakeaction=rollback&amp;vandal=' +
                       escape(vandal) + '&amp;token=' + escape($rollback._mkToken(wp, vandal)));
}

// -----------------------------------------------------------------------------
// Add revert buttons to the page
// -----------------------------------------------------------------------------
$rollback._addButtonDiff = function() {
    if (wikiDoc.editingP) return; // preview diff pages should not have
                                  // rollback buttons; detect them since they
                                  // will also be edit pages

    var difftag = $util.getElementsByClass('diff-ntitle',document.getElementById('bodyContent'),'td')[0];
    if (!difftag) return;

    // if toplink has an oldid then this is not a diff against current revision.
    var toplink = difftag.getElementsByTagName('a')[0].href;
    if (toplink.match(/oldid=/)) return;

    var vandal = $wikipage.getUsernameFromLink(difftag.getElementsByTagName('a')[1]);
    if (!vandal) { alert(&quot;Couldn't parse username in diff page!&quot;); return; }

    var url = $rollback._mkUrl(wikiPage,vandal);
    var newtext = ' &amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;strong&gt;[&lt;a href=&quot;' + url + '&quot;&gt;' + $rollback.options.link_text + '&lt;/a&gt;]&lt;/strong&gt; ';

    difftag.innerHTML = difftag.innerHTML.replace(/(&lt;\/a&gt;\))( *&lt;br)/i, '$1'+newtext+'$2');
}

$rollback._addButtonContributions = function() {
    if (wikiPage.page != 'Special:Contributions') return;

    var vandal = wikiPage.relevantUser;
    if (!vandal) return;

    var l = document.getElementById('bodyContent').getElementsByTagName('li');
    for (i = 0; i &lt; l.length; i++) {
        var t = l[i].innerHTML;
        // If we are already a sysop on this wiki, abort
        if (t.match(/&gt;rollback&lt;\/a&gt;]/)) return;

        if (t.match(/&lt;strong&gt; \(/)) {
            var wp = new WikiPage(l[i].getElementsByTagName('a')[0].href);
            var url = $rollback._mkUrl(wp,vandal);
            l[i].innerHTML += ' [&lt;a href=&quot;' + url + '&quot;&gt;' + $rollback.options.link_text + '&lt;/a&gt;]';
        }
    }
}

$rollback.load = function() {
    if (WikiDocument.queryVars['fakeaction'] == 'rollback') {
        $rollback.revert();
    }
}

$rollback.widgetLoad = function() {
    $util.addOnloadHook(function() {
            $rollback._addButtonDiff();
            $rollback._addButtonContributions();
        });
}

$util.addOnloadHook($rollback.load);


/****************************************************************************
 * END rollback.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autotag.js
 ****************************************************************************/

// $Id: autotag.js 737 2006-02-21 01:43:30Z quarl $

// autotag.js - automatically add custom tags to article

// usage:
//    $module.depend('autotag.js');
//    $autotag.widgetLoad();

// quarl 2006-01-03 initial version
// quarl 2006-01-23 use wikiedit.js

var $autotag = new Module('autotag.js');
$autotag.depend('wikipage.js', 'wikiedit.js', 'shortcuts.js', 'wikiwidget.js', 'datetime.js', 'util.js');

// TODO: sort the tags by this order (note that these are primary names of
// tags since they all have many aliases; subsituted tags such as afd are
// tricky; support piped data such as db|reason)

//order : 'delete,afd,hoax,original research,npov,cleanup,importance'.split(','),

$autotag.options = {
    mark_minor : true
};

$autotag.shortcuts = Shortcuts({
        'cleanup,clean' : 'cleanup-date|' + $datetime.datestampMonthYYYY(),
        'or,original' : 'original research',
        'afd,vfd' : 'subst:afd',
        'catz' : 'categorize',
        'cped' : 'copyedit',
        'wfy' : 'wikify' // equivalent, but easier for someone reading wikisource/history
});

$autotag.run = function() {
    $autotag.widget.showStatus('&lt;a&gt;&lt;b&gt;Tagging...&lt;/b&gt;&lt;/a&gt;');
    var tags = window.prompt(&quot;Enter tags to add, separated by &amp;&amp;. Example: hoax &amp;&amp; not verified &amp;&amp; original research &amp;&amp; npov &amp;&amp; mergeto|another article, cleanup&quot;);
    $autotag.tag(tags);
};

$autotag._iscat = function(s) {
    return Boolean(s.match(/^category:/i));
};

$autotag.remove_braces = function(s) {
    // remove any brackets or braces
    s = s.replace(/^\{\{(.*)\}\}$/, '$1');
    s = s.replace(/^\[\[(.*)\]\]$/, '$1');
    return s;
};

$autotag._addBraces = function(s) {
    if ($autotag._iscat(s)) {
        return '[['+s+']]';
    } else {
        return '{{'+s+'}}';
    }
};

$autotag._canonicalizeCategory = function(s) {
    if (s.match(/^cat(egory|egories)? *: */i)) {
        s = 'Category: ' + $util.capitalizeFirstChar(RegExp.rightContext);
    }
    return s;
};

$autotag._expandShortcuts = function(s) {
    s = $autotag.shortcuts.subst(s);
    // common mistake: {{unverified}} is for images only
    if (!wikiPage.nsImageP) s = s.replace(/unverified/, 'not verified');
    s = $autotag._canonicalizeCategory(s);
    // common mistake: {{d|reason}} should be {{db|reason}}
    s = s.replace(/^d\|/, 'db|');
    return s;
};

$autotag._tagAtTopP = function(t) {
    if ($autotag._iscat(t)) return false;
    if (t.match(/stub$/)) return false;
    return true;
};

$autotag.tag = function(tags) {
    wikiPage.getEditorAsync($autotag._edit, tags);
};

$autotag._edit = function(editor, tags) {
    tags = tags.split(/&amp;&amp;/);
    //var ntags = Array();
    var ttags = Array();
    var ttags_top = Array();
    var ttags_bot = Array();
    for (i in tags) {
        var tag = tags[i];
        tag = $autotag._expandShortcuts($autotag.remove_braces($util.trimSpaces(tag)));
        if (!tag) continue;
        var btag = $autotag._addBraces(tag);
        //ntags.push(tag);
        ttags.push(btag);
        if ($autotag._tagAtTopP(tag)) {
            ttags_top.push(btag);
        } else {
            ttags_bot.push(btag);
        }
    }
    if (!ttags.length) return;

    if (editor.refuseCreate()) return;
    var prepend = ttags_top.length ? (ttags_top.join('\n\n')+'\n\n') : '';
    var append = ttags_bot.length ? ('\n\n'+ttags_bot.join('\n\n')) : '';
    editor.wpTextbox1 = prepend + $util.trimLines(editor.wpTextbox1) + append;
    editor.wpSummary = 'Tagged as ' + ttags.join(', ');
    editor.wpMinoredit = $autotag.options.mark_minor;
    editor.submit();
};

$autotag.load = function() {
    if (wikiPage.nsSpecialP) return;

    if (WikiDocument.queryVars['fakeaction'] == 'autotag') {
        $autotag.run();
    }

    $autotag.widget = new WikiWidget({
        href: wikiPage.qurl + '&amp;fakeaction=autotag',
        onclick: $autotag.run,
        name: 'Tag',
        id: 'ca-autotag',
        title: &quot;Add tag(s)&quot;,
        default_location: {portlet:'Actions'}});
}

$autotag.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
                if ($autotag.widget) $autotag.widget.add(location);
            });
};

$util.addOnloadHook($autotag.load);


/****************************************************************************
 * END autotag.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN copyvio.js
 ****************************************************************************/

// $Id: copyvio.js 924 2006-02-22 06:19:19Z quarl $

// copyvio.js - add copyvio tag and add entry to 'copyright
// problems' page

// USAGE:
//    $module.depend('copyvio.js');
//    $copyvio.widgetLoad();

var $copyvio = new Module('copyvio.js');
$copyvio.depend('wikipage.js', 'wikiwidget.js');

$copyvio.logEntry = function(wp, url, callback) {
    $copyvio._getLogWP().getEditorAsync($copyvio._logEntryEdit, wp, url, callback);
};

$copyvio._logEntryEdit = function(editor, wp, url, callback) {
    if (editor.wpTextbox1.indexOf('[['+wp.page+']]') == -1) {
        editor.wpTextbox1 += '* {{subst:article-cv|'+wp.page+'}} from ['+url+']. &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
        editor.wpSummary += 'Listing [['+wp.page+']] as copyvio of '+url;
        editor.submitAsync(callback, wp, url);
    } else {
        alert(&quot;[[&quot;+wp.page+&quot;]] already on log page; not relisting!&quot;);
        callback(wp, url);
    }
};

$copyvio.tagEntry = function(wp, url) {
    wp.getEditorAsync($copyvio._tagEntryEdit, url);
};

$copyvio._tagEntryEdit = function(editor, url) {
    // **replace** content!
    editor.wpTextbox1 = '{' + '{' + 'copyvio|url='+url+'}}\n&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;';
    editor.wpSummary = '[[Wikipedia:Copyrights|copyvio]] of '+url+' ([['+$copyvio._getLogWP().page+'|log]])';
    editor.submit();
};

$copyvio._getLogWP = function() {
    var logPageName = 'Wikipedia:Copyright problems/' + $datetime.datestampYYYYMonthD();
    return new WikiPage(null, logPageName);
};

$copyvio.logAndTagWp = function(wp, url) {
    $copyvio.logEntry(wp, url, $copyvio.tagEntry)
};

// query for URL; add {{copyvio}} tag and add to log page
$copyvio.run = function() {
    var url = window.prompt(&quot;Copyvio of which URL?&quot;);
    if (!url) return false;

    $copyvio.logAndTagWp(wikiPage, url);
    return false;
};

$copyvio.load = function() {
    // copyvios generally only in article space
    if (!wikiPage.nsMainP) return;

    if (WikiDocument.queryVars['fakeaction'] == 'copyvio') {
        $copyvio.run();
    }

    $copyvio.widget = new Widget( {name: 'CopyVio',
                                   title: 'Tag as copyright violation',
                                   id: 'ca-copyvio',
                                   onclick: $copyvio.run,
                                   href: wikiPage.qurl+'&amp;action=edit&amp;fakeaction=copyvio',
                                   default_location: {portlet:'Actions'}} );
}

$copyvio.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($copyvio.widget) $copyvio.widget.add(location);
        });
}

/****************************************************************************
 * END copyvio.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN edittop.js
 ****************************************************************************/

// $Id: edittop.js 438 2006-02-14 11:18:33Z quarl $

// edittop.js - adds an [edit top] link at the top of pages

// USAGE:
//    $module.depend('edittop.js');
//    $edittop.widgetLoad();

// based on http://en.wikipedia.org/wiki/Wikipedia:WikiProject_User_scripts/Scripts/Add_Edit_Top_Link
// by User:Pile0nades

var $edittop = new Module('edittop.js');
$edittop.depend('wikipage.js', 'util.js');

$edittop.widgetAdd = function() {
    // if this is preview page or generated page, stop
    if (wikiDoc.previewP || wikiPage.nsSpecialP) return;

    var editURL = wikiPage.qurl + '&amp;action=edit&amp;section=0';

    var style = 'float:right;margin-left:5px;margin-top:3px;';

    // create div and set innerHTML to link
    var divContainer = document.createElement(&quot;div&quot;);
    divContainer.innerHTML = ('&lt;div class=&quot;editsection&quot; style=&quot;'+style+'&quot;&gt;' +
                              '[&lt;a href=&quot;'+editURL+' title=&quot;'+wikiPage.page+'&quot;&gt;edit top&lt;/a&gt;]' +
                              '&lt;/div&gt;');

    // insert divContainer into the DOM before the h1
    document.getElementById(&quot;content&quot;).insertBefore(divContainer, document.getElementsByTagName(&quot;h1&quot;)[0]);
};

$edittop.widgetLoad = function() {
    $util.addOnloadHook($edittop.widgetAdd);
};

/****************************************************************************
 * END edittop.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN watchlist.js
 ****************************************************************************/

// $Id: watchlist.js 1136 2006-02-23 09:18:43Z quarl $

// watchlist.js - adds buttons to watchlist: &quot;unwatch&quot;, &quot;diff
// since&quot;

//  UNWATCH button asynchronously unwatches and crosses the entry off the
//  watchlist.
//
//  DIFF SINCE button shows differences since last edited.

// USAGE:
//   $module.depend('watchlist.js');
//   $watchlist.widgetLoad();

// quarl 2006-01-09 added asynchronous feature.
// quarl 2006-02-03 factored; added diff since.

// originally based on http://en.wikipedia.org/wiki/User:Omegatron/monobook.js
// see also http://en.wikipedia.org/wiki/User:Matthewmayer/monobook.js

// see also Bug 424 http://bugzilla.wikipedia.org/show_bug.cgi?id=424

var $watchlist = new Module('watchlist.js');
$watchlist.depend('wikipage.js', 'util.js', 'wikiwatch.js', 'diffsince.js');

$watchlist.options = {
    enabled: true,
    textlink_diffsince: 'since',
    textlink_unwatch: 'unwatch',
    textlink_watch: 'watch'
};

$watchlist.wp = {};

$watchlist.wuwatchAsync = function(wp) {
    if (!wp) { return $watchlist.error(&quot;internal error 72192d74-ab57-4a98-917f-8c6ca03b0559&quot;); }

    var updateWuwLink = function(wpX, nextWuwAction) {
        if (!wpX) return;
        // don't use just &quot;$util.findHref(wpX.url)&quot;, because if the target is
        // a User or User talk page, we don't want to accidentally match the
        // contributor link.
        if (!$watchlist._addremoveStrikeThrough(nextWuwAction, wpX.targetLink)) {
            alert(&quot;$watchlist.wuwatchAsync: Couldn't annotate link for '&quot; + wpX.page + &quot;'&quot;);
        }

        wpX.nextWuwAction = nextWuwAction;
        wpX.unwatchLink.innerHTML = (
            nextWuwAction ? $watchlist.options.textlink_watch : $watchlist.options.textlink_unwatch);
        wpX.unwatchLink.href = $wikiwatch.makeUrl(wp, nextWuwAction);
    }

    var lookupWp = function(wp) {
        return wp &amp;&amp; $watchlist.wp[wp.page];
    }

    var cb = function() {
        // note: wp.talkPage can be null for certain non-talkable pages
        var wpNT = lookupWp(wp.notalkPage());
        var wpT = lookupWp(wp.talkPage());
        if (!wpT &amp;&amp; !wpNT) {
            $watchlist.error(&quot;wuwatchAsync: neither talkPage nor notalkPage found (error 16e495b9-d198-4b80-8e9d-ba4088b77a98)&quot;);
            return;
        }
        var nextWuwAction = !wp.nextWuwAction;
        updateWuwLink(wpT, nextWuwAction);
        updateWuwLink(wpNT, nextWuwAction);
    }

    $wikiwatch.wuwatchAsync(wp.nextWuwAction, wp, cb, wp.unwatchSpan);
    return false;
}

$watchlist.diffSince = function(wp) {
    if (!wp) { return $watchlist.error(&quot;## internal error 72192d74-ab57-4a98-917f-8c6ca03b0559&quot;); }
    return $diffsince.diffPageAsync(wp, wp.diffsinceSpan);
}

$watchlist._addremoveStrikeThrough = function(addp, node) {
    // return node &amp;&amp; $util.insertNode(node, document.createElement('s'));
    if (!node) return 0;

    if (addp) {
        $util.addClass($util.ensureSpan(node), 'history-deleted');
    } else {
        $util.removeClass($util.ensureSpan(node), 'history-deleted');
    }
    return 1;
}


$watchlist.widgetLoad = function()
{
    $util.addOnloadHook(function() {
            if (wikiPage.page.match(/^Special:Watchlist/)) $watchlist._annotatePage();
        });
}

$watchlist._annotatePage = function() {
    // everything disabled?
    if (!$watchlist.options.enabled) return;

    var annotateLine = function(histLink, targetLink) {
        // note: 'wp' is needed by the onclick closure below -- do not just
        // put this inside the 'for' loop!
        var wp = new WikiPage(histLink.href);
        wp.targetLink = targetLink;
        $watchlist.wp[wp.page] = wp;

        wp.nextWuwAction = 0;
        wp.unwatchSpan = document.createElement('span');
        wp.unwatchLink = document.createElement('a');
        wp.unwatchLink.innerHTML = $watchlist.options.textlink_unwatch;
        wp.unwatchLink.href = $wikiwatch.makeUrl(wp, 0);
        wp.unwatchLink.onclick = function() { return $watchlist.wuwatchAsync(wp) };
        wp.unwatchSpan.appendChild(wp.unwatchLink);
        $util.addNodeAfter(histLink, wp.unwatchSpan);
        $util.addNodeAfter(histLink, document.createTextNode('; '));

        wp.diffsinceSpan = document.createElement('span');
        var diffsinceLink = document.createElement('a');
        diffsinceLink.innerHTML = $watchlist.options.textlink_diffsince;
        diffsinceLink.href = $diffsince.makeUrl(wp);
        diffsinceLink.onclick = function() { return $watchlist.diffSince(wp) };
        wp.diffsinceSpan.appendChild(diffsinceLink);
        $util.addNodeBefore(histLink, wp.diffsinceSpan);
        $util.addNodeBefore(histLink, document.createTextNode('; '));
    }

    var links = $util.copyArray(document.getElementById('bodyContent').getElementsByTagName('a'));
    var targetLink;
    for (i in links) {
        var link = links[i];
        if (!link.href) continue;
        if (link.href.match(/^http:\/\/(?:[^\/]+?)\/wiki\//)) {
            targetLink = link;
            continue;
        }
        if (link.href.match(/&amp;action=history$/)) {
            annotateLine(link, targetLink);
        }
    }
}


/****************************************************************************
 * END watchlist.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN watchbutton.js
 ****************************************************************************/

// $Id: watchbutton.js 612 2006-02-17 03:12:55Z quarl $

// watchbutton.js - change standard watch/unwatch tab to be
// asynchronous.

// USAGE:
//   $module.depend('watchbutton.js');
//   $watchbutton.widgetLoad();

// quarl 2006-02-03 initial version

var $watchbutton = new Module('watchbutton.js');
$watchbutton.depend('wikiwatch.js', 'util.js');

$watchbutton.options = { enabled: true };

$watchbutton.toggleAsync = function() {
    $wikiwatch.wuwatchAsync(! $watchbutton.currentlyWatched, wikiPage,
                            $watchbutton._wuwSuccess, $watchbutton.tab);
    return false;
}

$watchbutton._wuwSuccess = function() {
    $watchbutton.currentlyWatched = !$watchbutton.currentlyWatched;
    if ($watchbutton.currentlyWatched) {
        $watchbutton.link.innerHTML = 'Unwatch';
        $watchbutton.link.href = wikiPage.qurl + '&amp;action=unwatch';
        $watchbutton.link.title = 'Remove this page from your watchlist';
    } else {
        $watchbutton.link.innerHTML = 'Watch';
        $watchbutton.link.href = wikiPage.qurl + '&amp;action=watch';
        $watchbutton.link.title = 'Add this page to your watchlist';
    }
}

$watchbutton.widgetLoad_ = function()
{
    if (!$watchbutton.options.enabled) return;

    if (($watchbutton.tab = document.getElementById('ca-unwatch'))) {
        $watchbutton.currentlyWatched = true;
    } else if (($watchbutton.tab = document.getElementById('ca-watch'))) {
        $watchbutton.currentlyWatched = false;
    } else {
        // couldn't find watch/unwatch button.
        return;
    }

    $watchbutton.link = $watchbutton.tab.getElementsByTagName('a')[0];
    $watchbutton.link.onclick = $watchbutton.toggleAsync;

}

$watchbutton.widgetLoad = function() {
    $util.addOnloadHook($watchbutton.widgetLoad_);
}

/****************************************************************************
 * END watchbutton.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autofocus.js
 ****************************************************************************/

// $Id: autofocus.js 441 2006-02-14 11:21:27Z quarl $

// autofocus.js - Auto-focus the cursor to appropriate edit fields.

// Edit page: focus the main edit area.
// Move page: focus the new page title.

//  usage:
//     $module.depend('autofocus.js');
//     $autofocus.enable();

// quarl 2006-01-03 initial version

var $autofocus = new Module('autofocus.js');
$autofocus.depend('wikipage.js');

$autofocus.run = function() {
    if (wikiDoc.editingP &amp;&amp; !wikiDoc.previewP) {
        if (wikiDoc.newSectionP) {
            document.forms.editform.wpSummary.focus();
        } else {
            document.forms.editform.wpTextbox1.focus();
        }
        return;
    }

    if (wikiDoc.movePageP) {
        document.forms.movepage.wpNewTitle.focus();
        return;
    }
}

$autofocus.enable = function() {
    $util.addOnloadHook($autofocus.run);
}


/****************************************************************************
 * END autofocus.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN directredirect.js
 ****************************************************************************/

// $Id: directredirect.js 398 2006-02-14 09:21:10Z quarl $

// directredirect.js - automatically fix double redirects
//   Annotates Special:Whatlinkshere pages with [fix] and [fix all] buttons
//   that asynchronously change the target to a direct redirect.

// quarl 2006-01-31 initial version

var $directredirect = new Module('directredirect.js');
$directredirect.depend('wikipage.js', 'wikiedit.js', 'util.js');

$directredirect.options = { enabled: true };

$directredirect.annotatePage = function() {
    var contentDiv = document.getElementById('bodyContent');
    var links = contentDiv.getElementsByTagName('a');
    $directredirect.wpTarget = null;
    var redirects = $directredirect.redirects = [];

    for (var i in links) {
        var link = links[i];
        if (!link.href) continue;
        if (!link.href.match(/redirect=no/)) continue;

        var wp = new WikiPage(link.href);
        if (!$directredirect.wpTarget) {
            // first &quot;redirect=no&quot; link, this is the target
            $directredirect.wpTarget = wp;
        } else {
            // redirect page; is it a double (or worse) redirect?

            if (link.parentNode.parentNode.parentNode == contentDiv) {
                // if the parent is contentDiv, then it's a first-level
                // redirect.
            } else {
                // double redirect; add button
                var url = &quot;javascript:$directredirect.fix(&quot; + $util.stringQuoteEscape(wp.page) + &quot;)&quot;;
                var button = document.createElement('span');
                button.innerHTML = ' [&lt;a href=&quot;'+url+'&quot;&gt;&lt;b&gt;fix&lt;/b&gt;&lt;/a&gt;]';
                $util.addNodeAfter(link.nextSibling, button);
                var o = { wp: wp, link: link, button: button };
                redirects[wp.page] = o;
                redirects.push(o);
            }
        }
    }

    if (redirects.length) {
        var p = contentDiv.getElementsByTagName('p')[0];
        var button = document.createElement('blockquote');
        button.innerHTML = 'There are '+redirects.length+' indirect redirects. [&lt;a href=&quot;javascript:$directredirect.fixall()&quot;&gt;fix all&lt;/a&gt;]';
        $util.addNodeBefore(p, button);
    }
}

$directredirect.fix = function(pagename) {
    $directredirect.fix0( $directredirect.redirects[pagename] );
}

$directredirect.fixall = function() {
    for (var i in $directredirect.redirects) {
        $directredirect.fix0( $directredirect.redirects[i] );
    }
}

$directredirect.fix0 = function(redirect) {
    if (!redirect) { alert (&quot;## internal error 8e747379-406c-4bcf-b85f-770c855d9db1&quot;); return; }
    redirect.button.innerHTML = ' [&lt;b&gt;fixing&lt;/b&gt;: downloading...]';
    redirect.wp.getEditorAsync($directredirect.edit, redirect);
}

$directredirect.edit = function(editor, redirect) {
    redirect.button.innerHTML = ' [&lt;b&gt;fixing&lt;/b&gt;: submitting...]';
    var pagename = $directredirect.wpTarget.page;
    if (!pagename) { alert (&quot;## internal error 4cf6e5b6-5ed4-4d97-98d3-6288eb8e4f39&quot;); return; }
    var redir = '#REDIRECT [['+pagename+']]';
    editor.wpTextbox1 = redir;
    editor.wpSummary = 'Direct redirect '+redir;
    editor.wpMinoredit = true;
    editor.submitAsync(null, $directredirect.editCompleted, redirect);
}

$directredirect.editCompleted = function(req, redirect) {
    if (req.status != 200) {
        alert( &quot;Error submitting new redirect content!&quot; );
        return;
    }

    redirect.button.innerHTML = ' [&lt;b&gt;fixed&lt;/b&gt;]';
}

$directredirect.load = function() {
    if (!$directredirect.options.enabled) return;
    if (wikiPage.page != 'Special:Whatlinkshere') return;
    $directredirect.annotatePage();
}

$util.addOnloadHook($directredirect.load);

/****************************************************************************
 * END directredirect.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN locz.js
 ****************************************************************************/

// $Id: locz.js 912 2006-02-22 06:06:30Z quarl $

// locz.js - canonicalizes location WikiLinks
// as per [[Wikipedia:WikiProject Location Format]]

//  Example: [[Seattle, Washington]] becomes [[Seattle, Washington|Seattle]], [[Washington]], [[USA]].

// USAGE:
//   $module.depend('locz.js');
//   $locz.widgetLoad();

// quarl 2006-01-22 initial version
// quarl 2006-02-08 refactored to $autoedit.js

var $locz = new Module('locz.js');
$locz.depend('autoedit.js');

$locz.ae = new $autoedit.AutoEditor(
    'locz',
    'LocZ', 'ca-locz', 'Canonicalize location wikilinks',
    'Location canonicalization');

$locz.ae.initData = function() {
    var CountryData = function(states, link_country, regexp_country) {
        this.states = states;
        this.link_country = link_country.match(/\[/) ? link_country : '[['+link_country+']]';
        regexp_country = regexp_country || '\\[\\['+link_country+'\\]\\]';
        this.regexp_country = new RegExp(regexp_country);
        this.regexp_country_sq = new RegExp('^, *'+regexp_country);
        this.regexp_substate = (
            new RegExp('^([^,]+), *(' + this.states.join('|') + ')$'));
        this.regexp_state = (
            new RegExp('^(?:' + this.states.join('|') + ')$'));
    }

    this.countries = [
        new CountryData( // USA
            ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado',
             'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho',
             'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine',
             'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi',
             'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey',
             'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio',
             'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina',
             'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia',
             'Washington', 'West Virginia', 'Wisconsin', 'Wyoming',
             'Washington, DC', 'Washington, D.C.' // not strictly a state, but needs to be qualified with country also
             ],
            '[[United States]]', // '[[United States|USA]]',
            '\\[\\[(?:United[ _]States(?:[ _][^|\\\]]+?)?|USA)(?:\\|[^|\\\]]+?)?\\]\\]'),

        new CountryData( // Canada
            ['British Columbia', 'Alberta', 'Saskatchewan', 'Manitoba',
             'Ontario', 'Quebec', 'New Brunswick', 'Nova Scotia',
             'Prince Edward Island', 'Newfoundland and Labrador'],
            'Canada'),

        new CountryData( // England
            ['Bedfordshire', 'Berkshire', 'City of Bristol',
             'Buckinghamshire', 'Cambridgeshire', 'Cheshire',
             'Cornwall', 'Cumbria', 'Derbyshire', 'Devon', 'Dorset',
             'Durham', 'East Riding of Yorkshire', 'East Sussex', 'Essex',
             'Gloucestershire', 'Greater London', 'Greater Manchester',
             'Hampshire', 'Herefordshire', 'Hertfordshire', 'Isle of Wight',
             'Kent', 'Lancashire', 'Leicestershire', 'Lincolnshire',
             'City of London', 'Merseyside', 'Norfolk', 'Northamptonshire',
             'Northumberland', 'North Yorkshire', 'Nottinghamshire',
             'Oxfordshire', 'Rutland', 'Shropshire', 'Somerset',
             'South Yorkshire', 'Staffordshire', 'Suffolk', 'Surrey',
             'Tyne and Wear', 'Warwickshire', 'West Midlands', 'West Sussex',
             'West Yorkshire', 'Wiltshire', 'Worcestershire'],
            'England'),

        ];
}

$locz.ae.splitText = function(input) {
    var inputs = [];

    // special case for hat link, if there is one
    if (input.match(/^: *''.*/)) {
        var infobox = RegExp.lastMatch;
        var right = RegExp.rightContext;

        inputs.push(infobox);
        input = right;
    }

    // special case the first Infobox, if there is one
    if (input.match(/^(?:{{Infobox(?:.|\n)*?\n}}|{\|(?:.|\n)*?\n\|})/i)) {
        // var left = RegExp.leftContext;
        var infobox = RegExp.lastMatch;
        var right = RegExp.rightContext;

        // treat the infobox separately, so that USA links get added to main
        // article.
        inputs.push(infobox);
        input = right;
    }

    inputs.push(input);
    return inputs;
}

$locz.ae.buildRegExp = function() {
    return /\[\[ *(?:([^|\]]+?) *\| *)?([^\]]+?) *\]\]/;
}

$locz.ae.replaceRegExp = function(d, m) {
    var wlink = m[1] || m[2];
    var wtext = m[2];

    // non-main namespace - usually a category
    if (wtext.match(/:/)) return;

    if (wlink != wtext) return;

    for (i in this.countries) {
        var c = this.countries[i];

        var changes = 0;
        var wfull;
        if (wtext.match(c.regexp_substate)) {
            var city = RegExp.$1, state = RegExp.$2;
            wfull = '[[' + wtext + '|' + city + ']]';
            // only add link to state if we haven't link it yet.
            if (d.left.match('\\[\\['+state+'\\]\\]')) {
                wfull += ', ' + state;
            } else {
                wfull += ', [['+state+']]';
            }
            ++changes;
        } else if (wtext.match(c.regexp_state)) {
            // state link -- just need to add country link as necessary
            wfull = '[['+wtext+']]';
        }

        if (!wfull) continue;

        if (d.left.match(c.regexp_country)) {
            // Already mentioned country.  Delete redundant subsequent
            // country links
            if (d.right.match(c.regexp_country_sq)) {
                d.right = RegExp.rightContext;
                // only count as a change if we actually delete it!
                ++changes;
            }
        } else {
            // Haven't mentioned country earlier
            if (d.right.match(c.regexp_country_sq)) {
                // it's right after the current link; good.
            } else {
                // not there; add it.
                wfull += ', ' + c.link_country;
                ++changes;
            }
        }

        if (changes) {
            d.text = wfull;
        }
        return;
    }

    return;
}

$locz.widgetLoad = $locz.ae.widgetLoad;

/****************************************************************************
 * END locz.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN datez.js
 ****************************************************************************/

// $Id: datez.js 913 2006-02-22 06:07:05Z quarl $

// date_canonicalize.js - canonicalizes date WikiLinks

//  Example: July 17, 1982 becomes [[1982-07-17]]

// USAGE:
//   $module.depend('datez.js');
//   $datez.widgetLoad();

// quarl 2006-01-31 initial version

var $datez = new Module('datez.js');
$datez.depend('autoedit.js', 'datetime.js');

$datez.ae = new $autoedit.AutoEditor(
    'datez',
    'DateZ',
    'ca-datez',
    'Canonicalize dates',
    'Date canonicalization');

// Return a string for a regexp that matches possibly wiki-linked dates in
// various date formats.  This is a monster regexp, the hardest part of this
// script!
$datez.ae.buildRegExp = function() {

    var groupIfNeccessary = function(s) {
        // I don't know a good way to check against e.g. &quot;(foo)|(bar)&quot;; for now just be conservative in adding grouping
        if (s.match(/\|/) /*&amp;&amp; !s.match(/^\(/) */ ) {
            return '(?:' + s + ')';
        } else {
            return s;
        }
    }

    var joinRE = function() {
        // desplice arguments
        var args = Array.concat.apply(Array, arguments).map(groupIfNeccessary);

        return '(?:' + args.join('|') + ')';
    }

    var linked = function(s) {
        return '\\[\\[ *'+s+' *\\]\\]';
    }

    var maybelinked = function(s) {
        return joinRE(linked(s), s);
    }

    var abbrevMonth = function(s) {
        return s.substr(0,3);
    }

    var word = function(s) {
        return '\\b' + s + '\\b';
    }

    var year4 = word('[012][0-9][0-9][0-9]');
    var year42 = word(joinRE(year4, '[890][0-9]'));
    var month = word(joinRE('0?[1-9]', '1[012]'));
    var monthS = word(joinRE($datetime.monthnames, $datetime.monthnames.map(abbrevMonth)));
    var day = word('[0123]?[0-9](?:\'?st|nd|rd|th)?');

    var delimz = '[ ,/.-]+';

    var all = joinRE(
        // YYYY-MM-DD formats
        linked( year4 + '-' + month + '-' + day ),
        maybelinked(year4)+'-'+maybelinked(month+'-'+day),
        maybelinked(year4)+'/'+month+'/'+day,
        maybelinked(year4)+'\\.'+month+'\\.'+day,
        year4 + ' ' + month + ' ' + day,

        maybelinked(year4 + delimz + monthS + delimz + day),

        // MM-DD-YYYY formats
        month + '-' + day + '-' + year4,
        month + '/' + day + '/' + year42,

        linked(monthS + delimz + day + delimz + year42),
        maybelinked(monthS + delimz + day) + delimz + maybelinked(year42),
        linked(monthS) + delimz + linked(day) + delimz + '(?:of\s*)?' + linked(year42),

        // DD-MM-YYYY formats: only support monthS, because it's ambiguous
        // otherwise
        linked( day + delimz + monthS + delimz + year4 ),
        maybelinked(day + delimz + monthS) + delimz + maybelinked(year4)
        );
    return new RegExp(all, 'i');
}

$datez.ae.replaceRegExp = function(d, m) {
    s = m[0];
    s = s.replace(/[\[\]]/g, '');
    s = s.replace(/[-.]/g, '/');     // Date only understands '/' as delimiter
    s = s.replace(/([0-9])\'?(?:st|nd|rd|th)\b/, '$1'); // get rid of ordinals
    var date = new Date(s);                                // parses date string

    if (!date.getFullYear()) {
        // couldn't parse
        return null;
    }

    return '[[' + $datetime.datestampUTCISO(date) + ']]';
}

$datez.widgetLoad = $datez.ae.widgetLoad;

/****************************************************************************
 * END datez.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN coorz.js
 ****************************************************************************/

// $Id: coorz.js 447 2006-02-14 11:30:43Z quarl $

// coorz.js - canonicalizes geographical coordinates

//  Example: 59Â° 55â€² N, 10Â° 44â€² E becomes {{coor dm|59|55|N|10|44|E|}}

// USAGE:
//   $module.depend('coorz.js');
//   $coorz.widgetLoad();

// quarl 2006-02-01 initial version

var $coorz = new Module('coorz.js');
$coorz.depend('autoedit.js');

$coorz.ae = new $autoedit.AutoEditor(
    'coorz',
    'CoorZ', 'ca-coorz', 'Canonicalize geographic coordinates',
    'Coor canonicalization');

$coorz.ae.buildRegExp = function() {
    var sp = function(s) { return ' *' + s + ' *'; }

    var d = sp(&quot;(?:Â°|&amp;deg;)&quot;);
    var m = sp(&quot;(?:â€²|'|&amp;prime;|&amp;#x2032;)&quot;);
    var s = sp('(?:â€³|&quot;|&amp;Prime;|&amp;#x2033;)');

    var C = '(-?[0-9.]+)';

    var dms = C + d + '(?:' + C + m + '(?:' + C + s + ')?' + ')?';

    var all = '\\b' + dms + '\\s*(N|S|[Nn]orth|[Ss]outh)[ \t,]*' + dms + '\\s*(E|W|[Ee]ast|[Ww]est)' + '\\b';
    return new RegExp(all);
}

$coorz.ae.replaceRegExp = function(d, m)
{
    var latitude = [m[1], m[2], m[3]];
    var latitude_pole = m[4][0].toUpperCase();
    var longitude = [m[5], m[6], m[7]];
    var longitude_pole = m[8][0].toUpperCase();

    if (latitude[2] || longitude[2]) {
        // dms
        return ('{{coor dms|' +
                latitude[0] + '|' + latitude[1] + '|' + latitude[2] + '|' + latitude_pole + '|' +
                longitude[0] + '|' + longitude[1] + '|' + longitude[2] + '|' + longitude_pole + '|}}');
    } else if (latitude[1] || longitude[1]) {
        // dm
        return ('{{coor dm|' +
                latitude[0] + '|' + latitude[1] + '|' + latitude_pole + '|' +
                longitude[0] + '|' + longitude[1] + '|' + longitude_pole + '|}}');
    } else if (latitude[0] || longitude[0]) {
        // d
        return ('{{coor d|' +
                latitude[0] + '|' + latitude_pole + '|' +
                longitude[0] + '|' + longitude_pole + '|}}');
    } else {
        alert (&quot;## internal error a86f430f-f362-4324-b8ce-df5f84e8f65b&quot;);
        return null;
    }
}

$coorz.widgetLoad = $coorz.ae.widgetLoad;

/****************************************************************************
 * END coorz.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN imdbz.js
 ****************************************************************************/

// $Id: imdbz.js 447 2006-02-14 11:30:43Z quarl $

// imdbz.js - canonicalizes IMDB external links

//  Example: [http://www.imdb.com/title/tt0403832/ IMDB Entry] becomes
//           {{imdb title|id=0403832|title=Quarl/imdb canonicalize.js}}

// USAGE:
//   $module.depend('idmbz.js');
//   $idmbz.widgetLoad();

// quarl 2006-02-06 initial version


var $imdbz = new Module('imdbz.js');
$imdbz.depend('autoedit.js');

$imdbz.ae = new $autoedit.AutoEditor(
    'imdbz',
    'ImdbZ',
    'ca-imdbz',
    'Canonicalize IMDB links',
    'IMDB canonicalization');

$imdbz.ae.buildRegExp = function() {
    return new RegExp(
        '\\[http://(?:www\\.)?imdb\\.com/(title|name)/(?:tt|nm)([0-9]+)/?[^\\]]*\\]');
}

$imdbz.ae.replaceRegExp = function(d, m)
{
    var type = m[1];
    var idnum = m[2];
    if (type == 'name') {
        return '{{imdb name|id='+idnum+'|name={{subst:PAGENAME}}}}';
    } else if (type == 'title') {
        return '{{imdb title|id='+idnum+'|name={{subst:PAGENAME}}}}';
    }
    alert (&quot;## internal error 781cea49-9cb7-44b1-8656-368608c5457c&quot;);
    return null;
}

$imdbz.widgetLoad = $imdbz.ae.widgetLoad;

/****************************************************************************
 * END imdbz.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN alexafy.js
 ****************************************************************************/

// $Id: alexafy.js 457 2006-02-14 11:53:01Z quarl $

// alexafy.js - adds &quot;alexa&quot; links to external links

// usage:
//        $module.depend('alexafy.js');
//        $alexafy.widgetLoad();

// quarl 2005-01-10 initial version

var $alexafy = new Module('alexafy.js');
$alexafy.depend('wikiwidget.js', 'util.js');

$alexafy._whitelistedP = function(url) {
    if (url.match(/wikipedia.org/)) return true;
    return false;
}

$alexafy.run = function() {
    var content = document.getElementById('content');
    var externallinks = $util.getElementsByClass('external',content,'a');
    for (i in externallinks) {
        var alink = externallinks[i];
        if ($alexafy._whitelistedP(alink.href)) continue;
        $alexafy._annotateLink(alink);
    }
}

$alexafy._annotateLink = function(alink) {
    var alexaUrl = $alexafy.makeUrl(alink.href);
    var dnode = document.createElement('span');
    dnode.innerHTML = ' [&lt;a href=&quot;'+alexaUrl+'&quot;&gt;Alexa&lt;/a&gt;]';
    $util.addNodeAfter(alink, dnode);
}

$alexafy.makeUrl = function(url) {
    return 'http://www.alexa.com/data/details/traffic_details?q=&amp;url=' + url;
}

$alexafy.load = function() {
    $alexafy.widget = new WikiWidget({ default_location: {portlet: 'Toolbox'},
                                       onclick: $alexafy.run,
                                       name: 'Alexafy links',
                                       id: 'ca-alexafy'});
}

$util.addOnloadHook($alexafy.load);

$alexafy.widgetLoad = function() {
    $util.addOnloadHook(function() {
            $alexafy.widget.add();
        });
}

/****************************************************************************
 * END alexafy.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN userscript.js
 ****************************************************************************/

// $Id: userscript.js 637 2006-02-17 09:51:30Z quarl $

// userscript.js - utilities to help develop user scripts and
// style sheets

// - adds &quot;raw&quot; tab to user script pages
// - adds &quot;refresh&quot; tab to user script pages (refresh the raw script)
// - automatically refreshes the raw version when you save a user script page

// quarl 2006-01-10 initial version

var $userscript = new Module('userscript.js');
$userscript.depend('wikipage.js', 'kookie.js', 'wikiwidget.js');

$userscript.rawUrl = function(wp) {
    // note: wp.qurl is parsed from source and is not the same as blindly
    // escaping the input!  String has to exactly match what the user is
    // using, e.g. &quot;User:Quarl/script&quot;, not &quot;User%3AQuarl/script&quot;!

    if (wp.page.match(/[.]js$/)) {
        return wp.qurl + '&amp;action=raw&amp;ctype=text/javascript&amp;dontcountme=s';
    } else if (wp.page.match(/\/monobook[.]css$/)) {
        return wp.qurl + '&amp;action=raw&amp;ctype=text/css';
    } else if (wp.page.match(/[.]css$/)) {
        return wp.qurl + '&amp;action=raw&amp;ctype=text/css&amp;dontcountme=s';
    } else {
        return null;
    }
}

$userscript._load = function() {
    var url = $userscript.rawUrl(wikiPage);
    if (!url) return;

    $userscript.widgetRaw = new WikiWidget({
        default_location: {portlet: 'Actions'},
        url: url,
        name: 'Raw', id: 'ca-raw', title: &quot;Show raw version of user script&quot;});
    $userscript.widgetRefresh = new WikiWidget({
        default_location: {portlet: 'Actions'},
        onclick: $userscript.doRefresh,
        name: 'Refresh', id: 'ca-refresh',
        title: &quot;Force browser to refresh the raw version of this script&quot;});

    $userscript.refreshIfChanged();
}

$userscript.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($userscript.widgetRaw) {
                $userscript.widgetRaw.add(location);
                $userscript.widgetRefresh.add(location);
            }
        });
}

// Check if the current script has changed since last time we looked at it;
// if so, refresh.  Use a cookie to check.
$userscript.refreshIfChanged = function() {
    // if we're not looking at current revision, don't do anything.
    if (wikiDoc.permalinkP) return;

    // we don't have the oldid for some reason (e.g. we're currently editing)
    if (!wikiDoc.oldid) return;

    //var cookie_name = 'usl_oldid_' + wikiPage.pageQuoted;
    var cookie_name = 'usl_oldid';

    // by using a different cookie-path we avoid sending tons of cookies for every page,
    // and we don't have to uniquify the cookie name.  Note that if unspecified, the path
    // is equivalent to &quot;/wiki/User:Quarl/&quot; instead of &quot;/wiki/User:Quarl/foo.js&quot;, which is
    // just as bad as &quot;/&quot;
    var path = $util.urlGetPath(wikiPage.url); // only bother with canonical URL
    last_oldid = $kookie.get(cookie_name);
    if (last_oldid != wikiDoc.oldid) {
        // first time we're looking at the page, or the page has changed. refresh.
        $userscript.doRefresh();
    }
    $kookie.set(cookie_name, wikiDoc.oldid, 7, path);
}

$userscript.doRefresh = function() {
    $userscript._forceRefresh($userscript.rawUrl(wikiPage));
}

$userscript._forceRefresh = function(url) {
    // We can't do frm.location.reload() right now because frm.location will still be &quot;about:blank&quot;, but if we complete this event and start a new one, it works.

    //frm.location.replace(url);
    //frm.location.href = url;

    $util.buttonShowStatus($userscript.widgetRefresh.li, '&lt;b&gt;&lt;a&gt;Refreshing...&lt;/a&gt;&lt;/b&gt;');

    document.getElementById('userscript_refresher').src = url;
    setTimeout($userscript._forceRefresh_1, 0);
}

$userscript._forceRefresh_1 = function() {
    var frm = window.frames['userscript_refresher'];
    frm.location.reload();

    $util.buttonRestoreStatus($userscript.widgetRefresh.li, '&lt;b&gt;&lt;a&gt;Refreshed&lt;/a&gt;&lt;/b&gt;');
}

$util.addOnloadHook($userscript._load);

// hidden iframe
if (false) // debug
document.write('&lt;div style=&quot;float:right;&quot; id=&quot;hidden_userscript_iframe_div&quot;&gt;&lt;iframe src=&quot;about:blank&quot; height=&quot;80&quot; width=&quot;80&quot; name=&quot;userscript_refresher&quot; id=&quot;userscript_refresher&quot;&gt;&lt;/iframe&gt;&lt;/div&gt;');
else
document.write('&lt;div style=&quot;position:absolute;left:0px;top:0px;visibility:hidden;&quot; id=&quot;hidden_userscript_iframe_div&quot;&gt;&lt;iframe src=&quot;about:blank&quot; height=&quot;0&quot; width=&quot;0&quot; name=&quot;userscript_refresher&quot; id=&quot;userscript_refresher&quot;&gt;&lt;/iframe&gt;&lt;/div&gt;');

/****************************************************************************
 * END userscript.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autosummary.js
 ****************************************************************************/

// $Id: autosummary.js 1248 2006-02-25 06:22:25Z quarl $

// autosummary.js - automatically fill in edit summary based on diff; short cuts

// quarl 2006-01-26 added shortcuts
// quarl 2006-01-30 auto diff

// TODO: add a checkbox for &quot;auto&quot; next to summary, to disable auto diff

var $autosummary = new Module('autosummary.js');
$autosummary.depend('wikipage.js', 'wikiedit.js', 'util.js', 'diff.js', 'shortcuts.js');
// recommends: smartsubmit.js

// see also: [[Wikipedia:Edit_summary_legend]]
$autosummary.shortcuts = Shortcuts({
  // 'ed' : 'editing', // 'edit'
  'cped,cpediting,cpyed,copyed,copyedit' : 'copy-editing',
  'mn ' : 'minor',
  'mnf ' : 'minor fixes',
  'fmt' : 'formatting',
  'mfmt ' : 'minor formatting',
  'rv' : 'reverting',
  'rvv' : 'reverting vandalism',
  'gr' : 'grammar',
  'sp' : 'spelling',
  'rd ' : 'redirect',
  'cmt' : 'commenting',
  'cla' : 'clarifying',
  'xl,xlink' : 'external link',
  'sa' : 'see also',
  'cap' : 'capitalization',
  'catz' : 'categorizing',
  'cl,cu' : 'cleaning up',
  'newart,creat' : 'creating new article',
  'dab,disamb,disam,disambig' : 'disambiguating',
  'rddab' : 'replacing redirect with disambiguation page',
  //'st' : 'see Talk page',
  // 'style' : 'style',
  'punc,punct,pnct' : 'punctuation',
  'wfy,wkfy' : 'wikifying'
});

$autosummary.options = {
    prompt : 'Enter edit summary.',

    // whether to query even when filled via auto diff
    query: true,

    // whether to default edit summary to diff (not needed if
    // $autosummary.auto_diff is enabled)
    diff: true,

    // whether to automatically prepend &quot;(auto diff)&quot; to edit summary while
    // editing.  Use integer number of seconds for update interval (in sec),
    // or false to disable.
    auto_diff: 3,

    // whether to automatically select text after the /* section */ and Â« diff
    // Â»
    auto_select: true,

    // whether shortcut expansion is enabled
    shortcuts_enabled: false
};

$autosummary.load = function()
{
    if (!wikiDoc.editingP) return;
    if (wikiDoc.newSectionP) return;

    if ($autosummary.options.auto_diff) {
        $autosummary._autoDiffSetup();
    }

    if ($autosummary.options.auto_select) {
        $util.hookEventObj(document.editform.wpSummary, 'focus', $autosummary._focusSummaryEvent);
    }

    $util.hookEventObj(document.editform.wpSave, 'click', $autosummary._preSubmitEvent);
}

$autosummary._autoDiffSetup = function() {
    $util.hookEventObj(document.editform.wpTextbox1, 'blur', $autosummary._updateAutoDiff);
    $autosummary.intervalHandle = setInterval($autosummary._updateAutoDiff,
                                              1000*$autosummary.options.auto_diff);
}

$autosummary._textFilter = function(s) {
    // ignore signature when diffing
    return s.replace(/&lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;/g,'').replace(/&lt;span class=[\'\&quot;]user-sig.*?&lt;\/span&gt;/g, '');
}

$autosummary._diffStrings = function(s1,s2) {
    return $diff.diffSummary($autosummary._textFilter(s1), $autosummary._textFilter(s2));
}

$autosummary.diffTextbox = function() {
    var editor = wikiPage.getEditor();
    return $autosummary._diffStrings(editor.wpTextbox1_orig, editor.wpTextbox1);
}

// update the edit summary with diff
$autosummary._updateAutoDiff = function() {
    var editor = wikiPage.getEditor();
    editor.updateThis();

    if (editor.wpTextbox1_prev == editor.wpTextbox1) {
        // no change since last update
        return;
    }
    editor.wpTextbox1_prev = editor.wpTextbox1;

    var s = $autosummary.diffTextbox();
    if (s) {
        s = &quot;Â«&quot; + s + &quot;Â» &quot;;
    }

    if (editor.wpSummary.match(/\Â«/)) {
        editor.wpSummary = editor.wpSummary.replace(/Â«.*?Â» */, s);
    } else if (s &amp;&amp; !$autosummary._pruneSection(editor.wpSummary)) {
        editor.wpSummary = $util.trimSpaces(editor.wpSummary);
        if (editor.wpSummary) editor.wpSummary += ' ';
        editor.wpSummary += s;
    }

    editor.updateForm();
}

$autosummary._preSubmitEvent = function(event)
{
    if ($autosummary.options.auto_diff) $autosummary._updateAutoDiff();
    var editor = wikiPage.getEditor();
    editor.updateThis();
    var r = $autosummary._edit(editor);
    editor.updateForm();

    if (!r) {
        event.preventDefault();
        event.stopPropagation();
    }
}

// auto focus
$autosummary._focusSummaryEvent = function(event) {
    var sumField = document.editform.wpSummary;
    if (sumField.value.match(/^(?:\/\*.*?\*\/)?\s*(?:Â«(?:.*)Â»)? ?/)) {
        var n = RegExp.lastMatch.length;
        var m = sumField.value.length;
        // apparently you can't setSelectionRange in an onFocus handler, but
        // you can set a timer to do it 0 seconds from now.
        setTimeout(function() { sumField.setSelectionRange(n, m) }, 0);
    }
}

$autosummary._pruneSection = function(s) {
    return $util.trimSpaces(s.replace(/^\/\\*.*?\\*\//,''));
}

$autosummary._edit = function(editor)
{
    if (editor.wpTextbox1_orig == editor.wpTextbox1) {
        // no change
        return true;
    }

    var auto = false;

    if (!editor.wpSummary.match(/REDIRECT/i) &amp;&amp;
        editor.wpTextbox1.match(/^#REDIRECT/i))
    {
        // it's a redirect.  Annotate with REDIRECT.
        if ($autosummary.options.auto_diff) {
            // don't need auto diff
            // editor.wpSummary = editor.wpSummary.replace(/^ã€ˆ.*?ã€‰ */, '');
        }
        editor.wpSummary += editor.wpTextbox1;
        auto = true;
    } else if ($autosummary._pruneSection(editor.wpSummary)) {
        // non-negligible summary exists; continue with submission
        if ($autosummary.options.shortcuts_enabled) {
            editor.wpSummary = $autosummary.shortcuts.substWords(editor.wpSummary);
        }
        return true;
    } else if ($autosummary.options.diff) {
        // if we get here then we're not using auto diff, or user manually
        // removed it
        var s = $autosummary.diffTextbox();
        if (s) {
            editor.wpSummary += s;
            auto = true;
        }
    }

    if (!auto || $autosummary.options.query) {
        var pr = $autosummary.options.prompt;
        if ($autosummary.options.shortcuts_enabled) {
            pr += '  ' + $autosummary.shortcuts.msg();
        }

        var r = window.prompt(pr, editor.wpSummary);
        if(r == null) { return false; } // cancel
        if ($autosummary.options.shortcuts_enabled) {
            editor.wpSummary = $autosummary.shortcuts.substWords(r);
        }
    }

    return true;
}

$util.addOnloadHook($autosummary.load);


/****************************************************************************
 * END autosummary.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN smartsubmit.js
 ****************************************************************************/

// $Id: smartsubmit.js 915 2006-02-22 06:07:39Z quarl $

// smartsubmit.js - smarter diff/preview buttons

//  Instead of navigating to a new page, the &quot;Show preview&quot; and &quot;Show
//  changes&quot; buttons download the target asynchronously and update the current
//  page.
//
// Advantages:
//  - Can continue editing without losing changes
//  - Can use up to 250 characters in edit summary (normally, preview/diff
//    would cut to 200 characters)
//  - enhances auto_summary.js: the auto diff is based on the &quot;previous&quot;
//    version of the page, but normally pressing preview/diff would cause the
//    preview version to be &quot;previous&quot;, as there is no way to save the
//    original text
//  - enhances $autoreplace.js (including advanced_sig.js): replacements not
//    substituted in the edit box on preview/diff
//  - don't lose cursor position in text box

// Side effects:
//  - Since the browser doesn't navigate the window to a new location, it
//    doesn't register as a history event (i.e. &quot;back&quot; goes to the page
//    visited before any initial editing)

// quarl 2006-02-02 initial version

var $smartsubmit = new Module('smartsubmit.js');
$smartsubmit.depend('wikiedit.js', 'util.js');
// enhances: wikiedit.js, $autoreplace.js, auto_summary.js

$smartsubmit.options = {
    enabled: true,
    focus_after_download: true
};

$smartsubmit.load = function() {
    if (!$smartsubmit.options.enabled) return;

    if (!wikiDoc.editingP) return;

    if (!$smartsubmit.annotatePageInit()) return;

    document.editform.wpDiff.preventPreSumitHook = true;
    $util.hookEventObj(document.editform.wpDiff, 'click',
                      function(event){$smartsubmit.click(event,'wpDiff');});
    document.editform.wpPreview.preventPreSumitHook = true;
    $util.hookEventObj(document.editform.wpPreview, 'click',
                      function(event){$smartsubmit.click(event,'wpPreview');});
}

// returns true value on success
$smartsubmit.annotatePageInit = function() {
    var divLoc = document.getElementById('jump-to-nav');
    if (!divLoc) {
        return $smartsubmit.error(&quot;couldn't get 'jump-to-nav' (error 1639a197-bdd2-4e9d-9777-9c8a5987fe2c)&quot;);
    }
    $smartsubmit.div = document.createElement('div');
    $smartsubmit.div.id = 'smartsubmit-preview';
    $util.addNodeAfter(divLoc, $smartsubmit.div);

    // create an empty &lt;a&gt; so that we can focus on it
    $smartsubmit.focusloc = document.createElement('a');
    $smartsubmit.focusloc.id = 'smartsubmit-focusloc';
    $util.addNodeAfter(divLoc, $smartsubmit.focusloc);

    return true;
}

$smartsubmit.focusPreview = function() {
    $smartsubmit.focusloc.focus();
}

// The user clicked wpDiff or wpPreview.  Instead of submitting, we're going
// to make a new asynchronous request, download the data, insert into the
// current page.
$smartsubmit.click = function(event, button) {
    if (!$smartsubmit.options.enabled) {
        return true;
    }

    // don't allow multiple concurrent clicks
    document.editform[button].disabled = true;
    $smartsubmit.div.innerHTML = 'Submitting...';

    wikiPage.getEditor().submitAsync(button, $smartsubmit.updatePage, button);

    event.preventDefault();
    event.stopPropagation();
    return false;
}

$smartsubmit.updatePage = function(req, button) {
    if (button == 'wpDiff') {
        var divId = 'wikiDiff';
    } else if (button == 'wpPreview') {
        var divId = 'wikiPreview';
    } else {
        $smartsubmit.error(&quot;internal error dcd4ab5a-4e10-4576-9cd5-874d589455da&quot;);
        return;
    }

    var editor = this;
    // re-enable button
    document.editform[button].disabled = false;
    if (req.status != 200) {
        $smartsubmit.error(&quot;downloading page failed! (error af129b48-ac16-4459-bf8c-86ed9e38d8f0)&quot;);
        $smartsubmit.options.enabled = false;
        wikiPage.getEditor().submit(button);
        return;
    }

    var newDoc = req.responseXML;

    var newDiv = newDoc.getElementById(divId);

    if (!newDiv) {
        $smartsubmit.warning(&quot;Couldn't get &quot;+divId+&quot; from downloaded document (error e3f57370-85c8-4ab6-8430-00d6441b828b)&quot;);
        // fall back: disable and do normal submit
        $smartsubmit.options.enabled = false;
        wikiPage.getEditor().submit(button);
        return;
    }

    // clear and add newDiv
    $smartsubmit.div.innerHTML = '';
    $smartsubmit.div.appendChild(newDiv);

    if ($smartsubmit.options.focus_after_download) {
        $smartsubmit.focusPreview();
    }
}

$util.addOnloadHook($smartsubmit.load);


/****************************************************************************
 * END smartsubmit.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN newmessages.js
 ****************************************************************************/

// $Id: newmessages.js 636 2006-02-17 08:40:02Z quarl $

// newmessages.js
// - annotate the &quot;You have new messages&quot; alert to add &quot;diff since&quot; and &quot;hist&quot;
//   links.
// - tag fake &quot;new messages&quot; boxes as such

// quarl 2006-01-16 initial version

var $newmessages = new Module('newmessages.js');
$newmessages.depend('wikipage.js', 'diffsince.js', 'util.js');

$newmessages.options = {
    add_since_hist: true,
    tag_fake: true
};

$newmessages.load = function() {
    var boxes = $util.getElementsByClass(
        'usermessage', document.getElementById('bodyContent'),'div');

    var seenreal = 0, seenfake = 0;

    for (var i in boxes) {
        var box = boxes[i];

        // People love to create lookalikes as a practical joke.  The easiest
        // way to tell is that real talk message boxes are before the &lt;div
        // id=&quot;jump-to-nav&quot;&gt; tag.

        if (box.textContent == &quot;You have new messages (diff).&quot; &amp;&amp;
            box.nextSibling.nextSibling.id == 'jump-to-nav')
        {
            if (seenreal++) continue;               // at most one real
            $newmessages.annotateRealMessageBox(box);
            continue;
        }

        if (box.textContent.match(/You have new messages/)) {
            // only bother tagging at most one fake box
            if (seenfake++) continue;
            $newmessages.annotateFakeMessageBox(box);
        }
    }
}

$newmessages.annotateRealMessageBox = function(talkmessagebox)
{
    if (!$newmessages.options.add_since_hist) return;
    $newmessages.wpTalk = new WikiPage(null,'User talk:' + wikiDoc.username);
    var histUrl = $newmessages.wpTalk.qurl + '&amp;action=history';
    var diffSinceUrl = $diffsince.makeUrl($newmessages.wpTalk);

    talkmessagebox.className += ' plainlinks';

    var t = (' (&lt;span id=&quot;newmessages-diffsince&quot;&gt;' +
             '&lt;a onclick=&quot;javascript:return $newmessages.diffSince()&quot; href=&quot;'+diffSinceUrl+'&quot;&gt;' +
             'diff since&lt;/a&gt;&lt;/span&gt;)' +
             ' (&lt;a href=&quot;'+histUrl+'&quot;&gt;history&lt;/a&gt;)');

    // insert before final period
    talkmessagebox.innerHTML = talkmessagebox.innerHTML.replace(/(?=[.]$)/, t);
}

$newmessages.annotateFakeMessageBox = function(talkmessagebox)
{
    if (!$newmessages.options.tag_fake) return;
    var sp = document.createElement('span');
    sp.style.color = 'red';
    sp.innerHTML = '(FAKE)';

    talkmessagebox.insertBefore(sp, talkmessagebox.firstChild);
}

$newmessages.diffSince = function() {
    return $diffsince.diffPageAsync($newmessages.wpTalk,
                            document.getElementById('newmessages-diffsince'),
                            '&lt;b&gt;diff since...&lt;/b&gt;');
}

$util.addOnloadHook($newmessages.load);

/****************************************************************************
 * END newmessages.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN tabdiff.js
 ****************************************************************************/

// $Id: tabdiff.js 1253 2006-02-25 06:39:02Z quarl $

// tabdiff.js - add &quot;diff&quot; tab to do most recent diff

// USAGE:
//   $module.depend('tabdiff.js');
//   $tabdiff.widgetLoad();

var $tabdiff = new Module('tabdiff.js');
$tabdiff.depend('wikiwidget.js', 'wikipage.js');

$tabdiff.load = function()
{
    if (wikiPage.nsSpecialP) return;
    $tabdiff.widget = new WikiWidget({
        default_location: {portlet: 'Actions'},
        url: wikiPage.qurl + &quot;&amp;diff=0&quot;,
        name: &quot;Diff&quot;,
        id: &quot;ca-last&quot;,
        title: &quot;Show most recent diff&quot;});
}

$tabdiff.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($tabdiff.widget) $tabdiff.widget.add(location);
        });
}


$util.addOnloadHook($tabdiff.load);


/****************************************************************************
 * END tabdiff.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN tabsince.js
 ****************************************************************************/

// $Id: tabsince.js 1253 2006-02-25 06:39:02Z quarl $

// tabsince.js - add 'since' tab to show change since I last edited

// Left-click navigates asynchronously; new tab/window works as well.

// USAGE:
//   $module.depend('tabsince.js');
//   $tabsince.widgetLoad();

// quarl 2006-01-16 rewritten to asynchronously download history page

var $tabsince = new Module('tabsince.js');
$tabsince.depend('wikipage.js', 'wikiwidget.js', 'diffsince.js');

$tabsince.load = function() {
    if (wikiPage.nsSpecialP) return;
    $tabsince.widget = new WikiWidget({
        default_location: {portlet: 'Actions'},
        href: $diffsince.makeUrl(wikiPage),
        onclick: $tabsince.run,
        name: &quot;Since&quot;,
        id: &quot;ca-since&quot;,
        title: &quot;Show changes since I last edited&quot;});
}

$tabsince.run = function() {
    return $diffsince.diffThis($tabsince.tab);
}

$tabsince.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($tabsince.widget) $tabsince.widget.add(location);
        });
}


$util.addOnloadHook($tabsince.load);


/****************************************************************************
 * END tabsince.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN purge.js
 ****************************************************************************/

// $Id: purge.js 567 2006-02-15 04:45:36Z quarl $

// purge.js - add &quot;purge&quot; tab to the purge server cache

// USAGE:
//   $module.depend('purge.js');
//   $purge.widgetLoad();

var $purge = new Module('purge.js');
$purge.depend('wikiwidget.js', 'wikipage.js', 'util.js');

$purge.load = function()
{
    if (wikiPage.nsSpecialP) return;
    $purge.widget = new WikiWidget({
        default_location: {portlet: 'Actions'},
        url: $purge.makeUrl(),
        onclick: $purge.asyncPurge,
        name: &quot;Purge&quot;,
        id: &quot;ca-purge&quot;,
        title: &quot;Purge the internal cache for this page&quot;});
}

$purge.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($purge.widget) $purge.widget.add(location);
        });
}

$purge.makeUrl = function() {
    return wikiPage.qurl + &quot;&amp;action=purge&quot;;
}

$purge.asyncPurge = function() {
    var tab = $purge.widget.li;

    var callback = function(req) {
        if (req.status != 200) {
            $purge.alert(&quot;Error purging! (error 3c0bf0ac-62f2-46d1-a19d-4436a2fb2f75)&quot;);
        }

        $util.buttonRestoreStatus(tab, '&lt;a&gt;&lt;b&gt;Purged&lt;/b&gt;&lt;/a&gt;');
    };

    $util.buttonShowStatus(tab);
    $util.asyncDownloadXML($purge.makeUrl, callback);
    return false;
}

$util.addOnloadHook($purge.load);

/****************************************************************************
 * END purge.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN editcount.js
 ****************************************************************************/

// $Id: editcount.js 1232 2006-02-24 11:13:06Z quarl $

// editcount.js - link to Interiot's edit counter when viewing user pages

// USAGE:
//     $module.depend('editcount.js');
//     $editcount.widgetLoad();

// quarl 2006-01-16 initial version

var $editcount = new Module('editcount.js');
$editcount.depend('wikipage.js', 'wikiwidget.js');

$editcount.interiotLink = function(username)
{
    if (!username) return null;

    return ('http://tools.wikimedia.de/~interiot/cgi-bin/count_edits?user=' +
            encodeURIComponent(username)+'&amp;dbname=' + WikiPage.dbname + '_p');
}

$editcount.load = function()
{
    var url = $editcount.interiotLink(wikiPage.relevantUser);
    if (url) {
        $editcount.widget = new WikiWidget({
            default_location: {portlet:'Toolbox'},
            url: url,
            name: 'Edit count',
            id: 'pt-editcount',
            title: &quot;Show Interiot's edit count for &quot;+wikiPage.relevantUser});
    }
}

$editcount.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($editcount.widget) $editcount.widget.add(location);
        });
}

$util.addOnloadHook($editcount.load);

/****************************************************************************
 * END editcount.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN nav_logs.js
 ****************************************************************************/

// $Id: nav_logs.js 707 2006-02-20 23:22:11Z quarl $

// toolbox_logs.js - adds relevant Logs links to Toolbox

// based on http://en.wikipedia.org/wiki/Wikipedia:WikiProject_User_scripts/Scripts/Logs_link

// adds a 'logs for this page' link to the navigation bar
// if the page is a user's page, talk page (but not subpage), the link will go to logs for the user instead
// if the page is a special page, then no link is displayed

var $nav_logs = new Module('nav_logs.js');
$nav_logs.depend('wikipage.js', 'wikiwidget.js');

$nav_logs.load = function() {
    var url;
    var show;
    if (wikiPage.relevantUser) {
        url = &quot;http://en.wikipedia.org/w/index.php?title=Special:Log&amp;user=&quot; + wikiPage.relevantUser;
        show = &quot;User &quot; + wikiPage.relevantUser;
    } else if (wikiPage.nsSpecialP) {
        // don't display link for special pages (other than those with relevantUser)
        return;
    } else {
        url = &quot;http://en.wikipedia.org/w/index.php?title=Special:Log&amp;page=&quot; + wikiPage.page;
        show = wikiPage.page;
    }

    $nav_logs.widget = new WikiWidget({
        default_location: {portlet: 'Toolbox'},
        url: url,
        name: &quot;Logs&quot;,
        id: &quot;pt-logs&quot;,
        title: &quot;Show logs for &quot; + show});
}

$nav_logs.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($nav_logs.widget) $nav_logs.widget.add(location);
        });
}

$util.addOnloadHook($nav_logs.load);

/****************************************************************************
 * END nav_logs.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN nav_afd.js
 ****************************************************************************/

// $Id: nav_afd.js 1194 2006-02-24 07:34:05Z quarl $

// nav_afd.js - add AFD/Today and AFD/Yesterday links to Toolbox

// USAGE:
//    $module.depend('nav_afd.js');
//    $nav_afd.widgetLoad();

// quarl 2006-01-03 initial version
// quarl 2006-01-24 show three direct links (avoid WP:AFD/Today, etc)

var $nav_afd = new Module('nav_afd.js');
$nav_afd.depend('wikipageXfd.js', 'datetime.js', 'wikiwidget.js');

$nav_afd.options = { num: 2 };

$nav_afd.load = function() {
    $nav_afd.widgets = [];

    for (var i=0; i &lt; $nav_afd.options.num; ++i) {
        var d = $datetime.previousDay(i);
        var date = $datetime.datestampUTCISO(d);

        $nav_afd.widgets[i] = new WikiWidget( { default_location: { portlet: 'Navigation' },
                                            url: afdLogPage(d).url,
                                            name: &quot;AFD/&quot;+date,
                                            id: &quot;pt-afd-&quot;+i,
                                            title: &quot;Show AFD log for &quot;+date } );
    }
}

$nav_afd.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            for (var i in $nav_afd.widgets) {
                $nav_afd.widgets[i].add(location);
            }
        });
}

$util.addOnloadHook($nav_afd.load);

/****************************************************************************
 * END nav_afd.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN hideown.js
 ****************************************************************************/

// $Id: hideown.js 1180 2006-02-23 22:10:45Z quarl $

// hideown.js - change the &quot;my watchlist&quot; navigation button to default to hide own.

var $hideown = new Module('hideown.js');
$hideown.depend('util.js');

$hideown.options = { enabled: true };

$hideown.load = function() {
    if (!$hideown.options.enabled) return;

    var wl = document.getElementById('pt-watchlist');
    if (!wl) return;

    var a = wl.getElementsByTagName('a')[0];
    if (!a || !a.href || !a.href.match(/Special:Watchlist/)) return;

    $hideown.debug(&quot;load(): Annotating pt-watchlist link&quot;);
    a.href += '?hideOwn=1';
}

$util.addOnloadHook($hideown.load);


/****************************************************************************
 * END hideown.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN google.js
 ****************************************************************************/

// $Id: google.js 1182 2006-02-23 22:11:34Z quarl $

// quarl 2006-02-13 initial version

// usage:
//    $module.depend('google.js');
//    $google.widgetLoad();

var $google = new Module('google.js');
$google.depend('wikipage.js');

$google.options = {
    google_server: 'http://www.google.com',
    site: null
    // site: 'en.wikipedia.org'
};

$google.click = function() {
    var t = document.forms.searchform.searchInput.value;
    $google.debug(&quot;click(): searchInput = &quot; + $util.stringQuoteEscape(t));
    if (!t) return;

    var site = $google.options.site || WikiPage.server;

    var url = $google.options.google_server + '/search?&amp;q=site:' + site + '+' + encodeURIComponent(t);
    document.location = url;
}

$google.widgetLoad_ = function() {
    $google.debug(&quot;widgetLoad(): adding Google button&quot;);
    var button = document.createElement('input');
    button.type = &quot;button&quot;;
    button.onclick = $google.click;
    button.value = &quot;Google&quot;;
    button.className = &quot;searchButton&quot;;

    var form = document.getElementById('searchform');
    form.appendChild(button);
}

$google.widgetLoad = function() {
    $util.addOnloadHook($google.widgetLoad_);
}

/****************************************************************************
 * END google.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN debugnote.js
 ****************************************************************************/

// $Id: debugnote.js 1190 2006-02-23 22:24:40Z quarl $

// debugnote -- displays a popup window that scrolls the debug log

// quarl 2006-02-22 initial version

var $debugnote = new Module('debugnote.js');
$debugnote.depend('msg.js', 'notes.js', 'wikiwidget.js');
$debugnote.depend('debugnote.css');

$debugnote.options = {
    log_update_interval: 1000,
    log_display_size: 40
};

$debugnote.logContainer = null;

$debugnote.div = null;
$debugnote.showlogDiv = function()
{
    if (!$debugnote.div) {
        $debugnote.div = document.createElement('div');
        $debugnote.div.id = 'debugnote_div';
        $debugnote.div.innerHTML = '&lt;pre id=&quot;debugnote_log&quot; /&gt;';

        var content = document.getElementById('bodyContent');
        var contentSub = document.getElementById('contentSub');
        content.insertBefore($debugnote.div, contentSub);

        $debugnote.logContainer = document.getElementById('debugnote_log');
        $debugnote.logContainerText = document.createTextNode('');
        $debugnote.logContainer.appendChild($debugnote.logContainerText);
    }

    $debugnote.initUpdate();
}

$debugnote.note = null;
$debugnote.showlogNote = function()
{
    if ($debugnote.note) {
        $debugnote.note.toggleShow();
    } else {
        $debugnote.note = new $notes.Note({
            x: Math.round(Math.random()*200),
                    y: Math.round(Math.random()*200),
                    title:'Debug log',
                    content:'&lt;pre id=&quot;debugnote_log&quot; /&gt;',
                    className: 'debugnote_note'
                    });
        $debugnote.logContainer = document.getElementById('debugnote_log');
        $debugnote.logContainerText = document.createTextNode('');
        $debugnote.logContainer.appendChild($debugnote.logContainerText);
    }
    $debugnote.initUpdate();
}

$debugnote.interval = null;
$debugnote.initUpdate = function()
{
    if (!$debugnote.interval &amp;&amp; $debugnote.options.log_update_interval) {
        $debugnote.interval = setInterval($debugnote._updatelog,
                                    $debugnote.options.log_update_interval);
    }
    $debugnote._updatelog();
}

$debugnote.lastNElements = function(array, n) {
    var max = function(a,b) { return a&gt;b ? a : b }
    return array.slice(max(0, array.length - n));
}

$debugnote._updatelog = function()
{
    if ($debugnote.note &amp;&amp; $debugnote.note.closed) return;

    if ($debugnote.logContainerText) {
        // use a Text node instead of innerHTML so we don't need to
        // entity-escape the text as HTML
        $debugnote.logContainerText.nodeValue = (
            $debugnote.lastNElements($msg.debuglog, $debugnote.options.log_display_size).join('\n'));
    }
}

$debugnote.load = function()
{
    $debugnote.widget = new WikiWidget({ default_location: {portlet: 'Navigation'},
                                       onclick: $debugnote.showlogNote,
                                       name: 'PowerTools Debug log',
                                       id: 'ca-debugnote'});
}

$debugnote.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            $debugnote.widget.add(location);
        });
}

$util.addOnloadHook($debugnote.load);

/****************************************************************************
 * END debugnote.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN querysave.js
 ****************************************************************************/

// $Id: querysave.js 1173 2006-02-23 22:00:51Z quarl $

// querysave.js -- confirm that the user wants to lose unsaved changes.

// SYNOPSIS:
//    $querysave.enable();

// note: this relies on onbeforeunload, which is not a W3C standard event; it
// only exists in MSIE and very new Mozilla (1.7a+)

// quarl 2006-02-23 initial version

var $querysave = new Module('querysave.js');
$querysave.depend('wikiedit.js', 'util.js');
// recommends: smartsubmit.js

$querysave.saved = false;

$querysave.enable = function()
{
    $util.addOnloadHook(function() {
            if (wikiDoc.editingP) {
                $util.hookEventObj(window, 'beforeunload', $querysave._exit);
                $util.hookEventObj(window, 'submit', $querysave._submit);
            }
        });
};

$querysave._submit = function()
{
    var editor = wikiPage.getEditor();
    if (!editor) {
        // this function should only even be called if wikiDoc.editingP, so
        // lack of editor at this point is an error
        $querysave.error(&quot;_submit(): No editor?! (error 0c2eac53-6d7f-43a9-8e7f-792e8f2fadda)&quot;);
        return;
    }

    editor.updateThis();
    editor.wpTextbox1_saved = editor.wpTextbox1;
    $querysave.debug(&quot;_submit(): marked as clean &quot; + $util.describeCharCount(editor.wpTextbox1_saved));
}


$querysave._exit = function(e)
{
    var editor = wikiPage.getEditor();
    if (!editor) {
        $querysave.debug(&quot;_exit(): editor=&quot; + editor);
        return;
    }

    editor.updateThis();
    if (editor.wpTextbox1_saved == editor.wpTextbox1) {
        $querysave.debug(&quot;_exit(): data is clean (saving)&quot;);
        return;
    }

    if (editor.wpTextbox1_orig == editor.wpTextbox1) {
        $querysave.debug(&quot;_exit(): data is clean (never modified)&quot;);
        return;
    }

    $querysave.debug(&quot;_exit(): data is dirty&quot;);
    e.returnValue = &quot;Your wiki text has not been saved.&quot;;
};

/****************************************************************************
 * END querysave.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN extedit.js
 ****************************************************************************/

// $Id: extedit.js 438 2006-02-14 11:18:33Z quarl $

// extedit.js - &quot;ext-edit&quot; widget

// USAGE:
//    $module.depend('extedit.js');
//    $extedit.widgetLoad();

var $extedit = new Module('extedit.js');
$extedit.depend('wikipage.js', 'wikiwidget.js');

$extedit.load = function() {
    if (wikiPage.protectedP) return;
    if (wikiPage.nsSpecialP) return;

    $extedit.widget = new Widget({default_location: {portlet:'Actions'},
                                  url: wikiPage.qurl + '&amp;action=edit&amp;externaledit=true',
                                  name: 'ext-edit',
                                  id: 'ca-extedit',
                                  title: 'Edit with external editor'});
}

$extedit.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($extedit.widget) $extedit.widget.add(location);
        });
}


/****************************************************************************
 * END extedit.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN autoafd.js
 ****************************************************************************/

// $Id: autoafd.js 387 2006-02-14 09:17:19Z quarl $

// autoafd.js - automatic AFD nomination

// quarl 2006-01-23 new version that opens the nomination page on invocation; adds
//                  checkboxes for tag &amp; log (default on); do the tagging and logging
//                  asynchronously on 'submit'.

// TODO: add buttons for manually tagging/listing

var $autoafd = new Module('autoafd.js');
$autoafd.depend('wikipage.js', 'wikipageXfd.js', 'wikiwidget.js', 'util.js');

$autoafd.makeBeginUrl = function() {
    var wp = wikiPage.afdPageX();
    return wp.qurl + '&amp;action=edit&amp;fakeaction=autoafd';
}

$autoafd.load = function()
{
    if (WikiDocument.queryVars['fakeaction'] == 'autoafd') {
        $autoafd.begin();
        return;
    }

    if (!wikiPage.nsMainP) {
        // don't bother with non-main-namespace articles
        return;
    }

    if (document.getElementById('afd')) {
        // this article already has an AFD tag.
        return;
    }

    if (wikiPage.xfdType() == 'afd')
        $wikiwidget.addTab($autoafd.makeBeginUrl(), 'Afd', 'ca-autoafd', 'Nominate for deletion');
}

$autoafd.begin = function() {
    if (window.afdEditor) return; // already initialized

    // TODO: some of this is redundant with wikipageAfd.js
    window.wpAfd = wikiPage;
    window.wpAfdTarget = wpAfd.afdTargetPage();
    if (!wpAfdTarget) {
        alert(&quot;Doesn't look like an AFD page?!&quot;);
        return;
    }
    window.wpAfdLog = afdLogPage();

    var editor = window.afdEditor = wpAfd.getEditor();
    if (editor.wpTextbox1) {
        // TODO: automatically go to #2 etc.
        alert(&quot;There's an old AFD at the default location already.\n\n&quot; +
              'Please manually edit [[' + wikiPage.page + ' (2)]]).');
        return;
    }

    editor.wpTextbox1 = '===[[' + wpAfdTarget.page + ']]===\n' +
              &quot;Nomination.  '''Delete''' &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;\n*\n*\n*\n&quot;;
    editor.wpSummary = &quot;Initial nomination for deletion of [[&quot; + wpAfdTarget.page + &quot;]]&quot;;
    editor.updateForm();

    $autoafd.annotate();
}

$autoafd.annotate = function() {
    $autoafd.add_new_checkboxes();
    $util.hookEventObj(document.editform.wpSave, 'click', $autoafd.submitHook_Event);
    window.$autoafd.async_wait = null;
    // Don't submit! Let the user type in peace.
}

$autoafd.add_new_checkboxes = function() {
    if (document.getElementById('autoafd-options')) return;

    var tagTitle = 'Add {{subst:afd}} to ' + $util.stringQuoteEscape(wpAfdTarget.page)
    var tagText = 'Tag &lt;a href=&quot;' + $util.urlGetPath(wpAfdTarget.url) + '&quot;&gt;' +
                  wpAfdTarget.page + '&lt;/a&gt; with {{afd}}';

    var listTitle = 'List this AFD on today\'s AFD log page';
    var listText = 'List in &lt;a href=&quot;'+$util.urlGetPath(wpAfdLog.url) + '&quot;&gt;' +
                   //wpAfdLog.page +
                   'log page' +
                   '&lt;/a&gt;';

    $autoafd.newstuff = document.createElement('div');
    $autoafd.newstuff.id = 'autoafd-options';
    $autoafd.newstuff.innerHTML = (
        '&lt;input type=&quot;checkbox&quot; value=&quot;1&quot; name=&quot;wpTagAFD&quot; id=&quot;wpTagAFD&quot; checked=&quot;1&quot; /&gt;'+
        '&lt;label for=&quot;wpTagAFD&quot; title=&quot;' + tagTitle + '&quot;&gt;' +
        tagText + '&lt;/label&gt;' +
        '&amp;nbsp;&amp;nbsp;&amp;nbsp;' +
        '&lt;input type=&quot;checkbox&quot; value=&quot;1&quot; name=&quot;wpListAFD&quot; id=&quot;wpListAFD&quot;  checked=&quot;1&quot; /&gt;'+
        '&lt;label for=&quot;wpListAFD&quot; title=&quot;' + listTitle + '&quot;&gt;' +
        listText + '&lt;/label&gt;');
    $util.addNodeBefore(document.editform.wpMinoredit, $autoafd.newstuff);
}


$autoafd.submitHook_Event = function(event)
{
    if (!($autoafd.submitHook())) {
        event.preventDefault();
        event.stopPropagation();
    }
}

$autoafd.submitHook = function() {
    window.afdEditor.updateThis();

    // $autoafd.async_wait is initially set to null.  The first time we arrive here
    // we set it to 0.  We wait for up to two asynchronous submissions to occur first
    // before actually submitting the form.

    if ($autoafd.async_wait == 0) {
        return true;
    }
    if ($autoafd.async_wait == null) {
        $autoafd.async_wait = 0;
    }

    if (document.editform.wpTagAFD.checked &amp;&amp; !window.asyncTagAFDStarted) {
        window.asyncTagAFDStarted = true;
        $autoafd.async_wait++;
        var status = window.$autoafd.status_tag = document.createElement('div');
        status.innerHTML = 'Tagging page: Downloading...';
        status.id = 'status-tagafd';
        $util.addNodeAfter($autoafd.newstuff, status);
        wpAfdTarget.getEditorAsync($autoafd.TagAFD);
    }
    if (document.editform.wpListAFD.checked &amp;&amp; !window.asyncListAFDStarted) {
        window.asyncListAFDStarted = true;
        $autoafd.async_wait++;
        var status = window.$autoafd.status_list = document.createElement('div');
        status.innerHTML = 'Listing: Downloading...';
        status.id = 'status-listafd';
        $util.addNodeAfter($autoafd.newstuff, status);
        wpAfdLog.getEditorAsync($autoafd.ListAFD);
    }

    if ($autoafd.async_wait == 0) return true;

    // prevent repeat clicks
    document.editform.wpSave.disabled = true;
    return false;
}

$autoafd.TagAFD = function(editor) {
    if (editor.refuseCreate()) return;

    if (editor.wpTextbox1.match(/{{afd/) ||
        editor.wpTextbox1.match(/\[\[Category:Pages for deletion\]\]/))
    {
         $autoafd.status_tag.innerHTML += ' Already tagged!';
    } else {
        $autoafd.status_tag.innerHTML += ' submitting...';
        editor.wpTextbox1 = '{{subst:afd}}\n\n' + $util.trimLines(editor.wpTextbox1);
        editor.wpSummary = 'Nominating [['+wpAfdTarget.page+']] for [['+wpAfd.page+'|AFD]]';
        editor.submitAsync(null, $autoafd.TagAFD_done);
    }
}

$autoafd.ListAFD = function(editor) {
    if (editor.refuseCreate()) return; // safety check
    var newText = '{{'+wpAfd.page+'}}';
    if (editor.wpTextbox1.indexOf(newText)!=-1) {
        $autoafd.status_list.innerHTML += ' already listed!';
    } else {
        $autoafd.status_list.innerHTML += ' submitting...';
        editor.wpTextbox1 = $util.trimLines(editor.wpTextbox1) + '\n' + newText + '\n';
        editor.wpSummary = 'Listing [['+wpAfdTarget.page+']] for [['+wpAfd.page+'|AFD]]';
        editor.submitAsync(null, $autoafd.ListAFD_done);
    }
}

$autoafd.TagAFD_done = function(req) {
    if (req.status != 200) {
        alert(&quot;Error tagging article for AFD!&quot;); return;
    }
    $autoafd.status_tag.innerHTML += ' done!';
    $autoafd.async_done_1();
}

$autoafd.ListAFD_done = function(req) {
    if (req.status != 200) {
        alert(&quot;Error listing article for AFD!&quot;); return;
    }
    $autoafd.status_list.innerHTML += ' done!';
    $autoafd.async_done_1();
}

$autoafd.async_done_1 = function() {
    if (--$autoafd.async_wait == 0) {
        document.editform.wpSave.disabled = false;
        //document.editform.wpSave.click();
        document.editform.submit();
    }
}

$util.addOnloadHook($autoafd.load);

/****************************************************************************
 * END autoafd.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN afd_vote.js
 ****************************************************************************/

// $Id: afd_vote.js 408 2006-02-14 09:50:41Z quarl $

// afd_vote.js - AFD auto-voting and shortcuts

// originally based on http://en.wikipedia.org/wiki/User:Jnothman/afd_helper/script.js
// [[User:Jnothman/afd_helper/script.js]]

//  - asynchronous updating (never opens new windows)
//  - live updating of log page
//  - huge list of shortcut expansions and other shortcut features
//  - more &quot;vote&quot; buttons such as in original article
//  - escaping bugs ('&amp;&amp;', '+', etc) fixed
//  - refuse to create AFD pages (in case of more escaping bugs)

var $afd_vote = new Module('afd_vote.js');
$afd_vote.depend('wikipageXfd.js', 'wikiedit.js', 'util.js', 'shortcuts.js', 'datetime.js');
// enhanced by: advanced_sig.js

$afd_vote.summary_prompt = true;

$afd_vote.shortcuts = Shortcuts({
            'D'         : 'Delete',
            'DA'        : 'Delete all',
            'K'         : 'Keep',
            'M'         : 'Merge',
            'MV'        : 'Move',
            'R,RD'      : 'Redirect',
            'RW'        : 'Rewrite',
            'T'         : 'Transwiki',
            'WD'        : 'Weak delete',
            'SD'        : 'Strong delete',
            'SP'        : 'Speedy delete',
            'SK'        : 'Strong keep',
            'SM'        : 'Slight merge',
            'WK'        : 'Weak keep',
            //'SPK'     : '[[Wikipedia:Speedy keep|Speedy keep]]',
            'SPK'       : 'Speedy keep',
            'C'         : 'Comment',
            'MC'        : 'Metacomment',
            'BJAODN,BJ' : 'BJAODN'
            });

$afd_vote.comment_shortcuts = Shortcuts( {
            'PN'                          : 'per nomination',
            'NN'                          : '[[WP:N|non-notable]]',
            'V,VAIN,VANITY'               : '[[WP:VAIN|vanity]]',
            'NNBIO'                       : '[[WP:BIO|non-notable biography]]',
            'NNVBIO'                      : '[[WP:BIO|non-notable vanity biography]]',
            'NNWEB'                       : '[[WP:WEB|non-notable website]]',
            'NNWEBCOMIC '                 : '[[WP:WEB|non-notable webcomic]]',
            'NNBLOG,NNWEBLOG'             : '[[WP:WEB|non-notable weblog]] ',
            'NNFORUM,NNWEBFORUM'          : '[[WP:WEB|non-notable web forum]] ',
            'NNSOFTWARE,NNSOFT,NNSW'      : '[[WP:SOFTWARE|non-notable software]] ',
            'NNCORP,NNCOMPANY'            : '[[WP:CORP|non-notable corporation]]',
            'NNMUSIC'                     : '[[WP:MUSIC|non-notable musical group]]',
            'NNBAND'                      : '[[WP:MUSIC|non-notable band]]',
            'NNUNEO'                      : '[[Wikipedia:Avoid_neologisms|non-notable unstable neologism, i.e. protologism]]',
            'NNUUNEO'                     : '[[Wikipedia:Avoid_neologisms|non-notable unverifiable unstable neologism, i.e. protologism]]',
            'NNFICT,NNFICTION'            : '[[WP:FICT|non-notable reference to fictional work]]',
            'NNFICTC,NNFICTCHAR,NNCHAR'   : '[[WP:FICT|non-notable character from fictional work]] ',
            'FANCRUFT,NNFAN'              : '[[Wikipedia:Fancruft|fancruft]]',
            'NNFANFIC'                    : '[[Wikipedia:Fancruft|non-notable fan fiction]]',
            'NNGAME'                      : '[[WP:N|non-notable]] online gaming group',
            'U'                           : '[[WP:V|unverifiable]]',
            'UPH'                         : '[[WP:V|unverifiable]], possible [[WP:HOAX|hoax]]',
            'OR'                          : '[[WP:NOR|original research]]',
            'UOR'                         : '[[WP:V|unverifiable]] and/or [[WP:NOR|original research]]',
            'H'                           : '[[WP:HOAX|hoax]]',
            'HSANC,HSANCT,HSANCTION'      : '[[WP:HOAX|hoax]], and sanction article author',
            'ATTACK'                      : '[[WP:CSD|attack page]]',
            'WISHSP,WISHEXPAND'           : 'I wish for expansion of [[WP:CSD]] so that this kind of article could be speedy-deleted when no notability is asserted ',
            'UNENC,UNENCYCLO,NOTPEDIC'    : '[[WP:NOT|unencyclopedic]]',
            'NOT'                         : '[[WP:NOT|Wikipedia is not]]',
            'NOTADVERT'                   : '[[WP:NOT|Wikipedia is not a vehicle for advertising]] ',
            'NOTBALL,NOTCRYSTAL'          : '[[WP:NOT|Wikipedia is not a crystal ball]] ',
            'NOTCRUFT'                    : '[[WP:NOT|Wikipedia is not an indiscriminate collection of information]] ',
            'NOTDICT,NOTDIC'              : '[[WP:NOT|Wikipedia is not a dictionary]] (but [[Wiktionary]] is) ',
            'NOTMEMORIAL'                 : '[[WP:NOT|Wikipedia is not a memorial]] ',
            'NOTOR,NOTORIGINAL'           : '[[WP:NOT|Wikipedia is not a publisher of original thought]] ',
            'NOTSOAPBOX'                  : '[[WP:NOT|Wikipedia is not a soapbox]] ',
            'NOTSW,NOTSWDIR'              : '[[WP:NOT|Wikipedia is not a software directory]] ',
            'NOTWEBHOST,NOTFREEHOST'      : '[[WP:NOT|Wikipedia is not a free host or webspace provider]] ',
            'NOTWEBDIR'                   : '[[WP:NOT|Wikipedia is not a web directory]] ',
            'NFT,NOTSCHDAY,NOTSCH'        : '[[WP:NFT|Wikipedia is not for things made up in school one day]] ',
            'XBIO,BIOX'                   : 'Recommend the article author see [http://www.wikime.org/ WikiMe] for writing biographies and/or [http://www.wikitree.org WikiTree] for writing genealogies ',
            'XUSERFY,USERFYX'             : 'Article author may want to consider moving the content to his [[Wikipedia:User page|user page]] ',
            'XPROTO,XPROTOLOGISM,PROTOX'  : 'Protologisms may deserve listing at [[Wiktionary:List_of_protologisms]] ',
            'BALLS,BALL'                  : '[[WP:BALLS|Complete bollocks]]'
            });

$afd_vote._load = function() {
    if (afdLogP) {
        // log page
        $afd_vote.annotateAfd();
    } else if (afdP) {
        // AFD page
        $afd_vote.annotateAfd();
        $wikiwidget.addTab('javascript:$afd_vote.doVote()', 'vote', 'ca-vote', &quot;Vote on this AFD&quot;);
    } else {
        $afd_vote.annotateArticle();
    }
}

$afd_vote.annotateArticle = function() {
    // is this a regular article that has an AFD notice?
    var afd = document.getElementById('afd');
    if (!afd) return;

    var href = 'javascript:$afd_vote.doVote()';
    var title = 'Vote on deletion of '+wikiPage.page;

    var anchors = $util.copyArray(afd.getElementsByTagName('a'));
    for (i in anchors) {
        if (anchors[i].text == &quot;this article's entry&quot; &amp;&amp;
            anchors[i].href.match(/Wikipedia:Articles_for_deletion\/.*/))
        {
            var span = document.createElement('span');
            span.innerHTML = ' [&lt;a href=&quot;'+href+'&quot; title=&quot;'+title+'&quot;&gt;vote&lt;/a&gt;]';
            $util.addNodeAfter(anchors[i], span);
            break;
        }
    }

    $wikiwidget.addTab(href, 'vote', 'ca-vote', title);
}

$afd_vote.annotateAfd = function() {
    var url_re = /(\/w\/index.php\?title=Wikipedia:Articles_for_deletion\/([^&amp;]+))&amp;action=edit&amp;/;
    var url, matches;
    $afd_vote.sectionDivs = $util.getElementsByClass('editsection', document.getElementById('bodyContent'), 'div');
    $afd_vote.labeledSectionDivs = {};

    for (var i in $afd_vote.sectionDivs) {
        var div = $afd_vote.sectionDivs[i];
        div.i = i;
        var anchor = div.getElementsByTagName('a')[0];
        if (!( anchor.text == &quot;edit&quot;
               &amp;&amp; (matches = anchor.href.match(url_re))
               &amp;&amp; (matches[2].substr(0, 4) != 'Log/')) )
            continue;
        var title = &quot;&quot;+unescape(matches[2]).replace(/_/g,' ');

        // setup for easy lookup and traversal later
        $afd_vote.labeledSectionDivs[title] = div;

        var closed = Boolean(anchor.parentNode.parentNode.getAttribute('class')=='boilerplate metadata vfd');

        if (!closed) {
            var vote_href = &quot;javascript:$afd_vote.doVote(&quot;+$util.stringQuoteEscape(title)+&quot;)&quot;;
            $util.addNodeAfter(anchor, $util.createHref(vote_href, 'Vote on deletion of '+title, 'vote'));
            $util.addNodeAfter(anchor, document.createTextNode(&quot;] [&quot;));
        }
        var log_href = &quot;/w/index.php?title=Special:Log&amp;page=&quot; + $util.wpaEscape(title);
        $util.addNodeBefore(anchor, $util.createHref(log_href, title, 'log'));
        $util.addNodeBefore(anchor, document.createTextNode(&quot;] [&quot;));
        var afd_href = matches[1];
        $util.addNodeBefore(anchor, $util.createHref(afd_href, title, 'afd'));
        $util.addNodeBefore(anchor, document.createTextNode(&quot;] [&quot;));
    }
}

// return true if string ends with period (can also have symbols such as closing paren after period)
$afd_vote._ends_with_period = function(str) {
    return Boolean(str.match(/[.?!][^a-zA-Z]*$/));
}

// return true if comment needs to be prefixed by 'as '
$afd_vote._comment_needs_as = function(comment) {
    var m = comment.match(/^([a-zA-Z]+)(.*)$/);
    var word1 = m &amp;&amp; m[1];
    if (!word1) return false;
    if (word1 == 'or') return false; // special case for lowercase 'or'
    if (word1.toUpperCase() == 'PN') return false; // special case for 'PN'
    return $afd_vote.comment_shortcuts.substP(word1);
}

$afd_vote.expand_vote = function(vote) {
    vote = $afd_vote.shortcuts.substFirstWord(vote);
    vote = $afd_vote.shortcuts.substUppercaseWords(vote);
    return vote;
}

$afd_vote.expand_comment = function(vote, comment) {
    // if first word is a shortcut other than 'per nomination', prefix with 'as'

    var need_as = $afd_vote._comment_needs_as(comment);

    comment = $afd_vote.comment_shortcuts.substUppercaseWords(comment);
    if (!comment.match(/^or /)) {
        // &quot;or&quot; is too common as first word... use uppercase &quot;OR&quot; if that's intended.
        comment = $afd_vote.comment_shortcuts.substFirstWord(comment);
    }

    if (need_as) {
        comment = 'as ' + comment;
    }

    if (!$afd_vote._ends_with_period(comment)) {
        comment += &quot;.&quot;;
    }

    // prefix with space if necessary
    if (!comment.match(/^[.,:; ]/)) {
        comment = &quot; &quot; + comment;
        if (vote == 'Comment') comment = &quot;:&quot; + comment;
    }

    // common mistake
    comment = comment.replace(/{{(nn-?bio|nn-?band|db-attack|db-repost)}}/, '{{tl|$1}}');

    return comment;
}

$afd_vote._comment_possibly_unexpanded = function(comment) {
    // did user typo one of the shortcuts?
    return comment.match(/[A-Z][A-Z][A-Z]+(?![\]A-Z\|])/);
}

$afd_vote.doVote = function(pagename) {
    if (pagename) {
        $afd_vote.doVoteWP(new WikiPage(null,pagename));
    } else {
        $afd_vote.doVoteWP(wikiPage);
    }
}

$afd_vote.doVoteWP = function(wp) {
    wp = wp.afdPageX();
    if (!(wp instanceof WikiPage)) { alert(&quot;## internal error bfc4b745-0e83-4e9a-9a16-7107c8e046ef: $afd_vote: not a WikiPage&quot;); return; }
    var vote0 = window.prompt(&quot;Enter your vote.   &quot; + $afd_vote.shortcuts.msg());
    if (!vote0) return;
    var vote = $afd_vote.expand_vote(vote0);
    var vote_used_shortcut = (vote != vote0);

    var comment0prev;
    var comment0 = '';
    var comment;
    var pr = &quot;Enter your comment.  &quot;;

    while(true) {
        comment0 = window.prompt(pr + $afd_vote.comment_shortcuts.msg(), comment0);
        if (typeof comment0 != 'string') return;
        comment = $afd_vote.expand_comment(vote, comment0);

        if (comment0 != comment0prev &amp;&amp;
            $afd_vote._comment_possibly_unexpanded(comment))
        {
            comment0prev = comment0;
            pr = &quot;Did you really mean '&quot;+RegExp.lastMatch+&quot;'?  Correct if you want.  &quot;;
            continue;
        }
        break;
    }

    var default_summary = &quot;vote '&quot;+vote+&quot;'&quot;;
    var summary;

    if ($afd_vote.summary_prompt &amp;&amp; !vote_used_shortcut) {
        summary = window.prompt(&quot;Enter the edit summary:&quot;, default_summary);
        if (typeof summary != 'string') return;
    }
    summary = summary || default_summary;

    var newtext = &quot;* '''&quot;+vote+&quot;'''&quot;+comment+&quot; &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;&quot;;
    wp.getEditorAsync($afd_vote._edit, newtext, summary);
}

$afd_vote._edit = function(editor, newtext, summary) {
    if (editor.refuseCreate()) return;

    editor.wpTextbox1 = $util.trimLines(editor.wpTextbox1) + '\n' + newtext;
    editor.wpSummary += summary;

    // are we at a log page?  (Note that 'window.location.href' is not as good as wikiPage because of shortcut redirects such as [[WP:AFD/Today]])

    var title = editor.wp.afdTargetPage().page;
    if (!title) {
        alert(&quot;## $afd_vote._edit: bad page name (error b2e39d30-fd3d-405e-adf1-5f0c7c034e53)&quot;);
    }

    var div, sec_end;
    if (afdP || afdLogP) {
        // show status if we're on an AFD or AFD Log page
        if (afdLogP) {
            div = $afd_vote.labeledSectionDivs[title];
            if (!div) { alert(&quot;## No labeledSectionDivs['&quot;+title+&quot;']&quot;); return; }
            sec_end = $afd_vote.sectionDivs[parseInt(div.i)+1];
            if (!sec_end) {
                // No next entry, must be end of page.  Add an empty div.
                sec_end = document.createElement('div');
                div.parentNode.appendChild(sec_end);
            } else if (sec_end.parentNode.id != 'bodyContent') {
                // if the next entry is a closed discussion then we need to go
                // one node up the tree
                sec_end = sec_end.parentNode;
            }
        } else {
            sec_end = $util.getElementsByClass('printfooter', document, 'div')[0];
        }
        var statusDiv = document.createElement('div');
        statusDiv.innerHTML = &quot;&lt;i&gt;(submitting...)&lt;/i&gt;&quot;;
        $util.addNodeBefore( sec_end, statusDiv );
    }

    if (afdLogP) {
        // We're looking at a log page.  Submit this asynchronously and replace
        // the content of this section of the log page with new content.

        editor.submitAsync(null, $afd_vote.log_update, div, sec_end);
    } else {
        // submit and go to changed page
        editor.submit();
    }
}

$afd_vote.log_update = function(req, div, sec_end) {
    if (req.status != 200) { alert (&quot;Error submitting vote!&quot;); return; }
    if (!div || !sec_end) { alert (&quot;## $afd_vote.log_update error&quot;); return; }

    // Replace nodes between div and next div with new content.
    // Start at the &lt;h3&gt; tag, because the afd page text doesn't have a
    // section number (1.123), but the log text does.
    var newnodes_start = $util.getElementsByClass('editsection', req.responseXML, 'div')[0].nextSibling.nextSibling.nextSibling.nextSibling.nextSibling;
    var newnodes_end = $util.getElementsByClass('printfooter', req.responseXML, 'div')[0];
    var replacement_nodes = $util.getNodesInRange(newnodes_start, newnodes_end);
    var newnode = document.createElement('div');
    for (i in replacement_nodes) { newnode.appendChild(replacement_nodes[i]); }

    var oldnodes_start = div.nextSibling.nextSibling.nextSibling.nextSibling.nextSibling;
    $util.removeNodesInRange(oldnodes_start, sec_end);
    $util.addNodeAfter(div.nextSibling.nextSibling.nextSibling.nextSibling, newnode);
}

$util.addOnloadHook($afd_vote._load);

/****************************************************************************
 * END afd_vote.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN xfdclose.js
 ****************************************************************************/

// $Id: xfdclose.js 438 2006-02-14 11:18:33Z quarl $

// xfdclose.js - close afd/mfd/etc.

// quarl 2006-01-04 initial version

// USAGE:
//   $module.depend('xfdclose.js');
//   $xfdclose.widgetLoad();

// TODO: shortcuts

var $xfdclose = new Module('xfdclose.js');
$xfdclose.depend('wikipage.js', 'wikipageXfd.js', 'wikiedit.js', 'wikiwidget.js');

$xfdclose.load = function() {
    if (window.afdP || wikiPage.sandboxP) {
        $xfdclose.widget = new WikiWidget({
            default_location: {portlet: 'Actions'},
            onclick: $xfdclose.run,
            // url: TODO,
            name: 'Close',                          // TODO: close AFD/MFD/etc
            id: 'ca-xfdclose',
            title: &quot;Close this AFD discussion&quot;      // TODO: close AFD/MFD/etc
            });
    }
};

$xfdclose.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($xfdclose.widget) $xfdclose.widget.add(location);
        });
};

$xfdclose.run = function() {
    $xfdclose.close(wikiPage, window.prompt(&quot;Enter closing comment.  Example: '''Delete''' as non-notable band.&quot;));
}

$xfdclose.close = function(wp, comment) {
    wp.getEditorAsync($xfdclose._edit, comment);
}

$xfdclose._edit = function(editor, comment) {
    if (!comment) return;
    var add_before = &quot;{{subst:afd top}} &quot; + comment + &quot; &lt;span class=&quot;user-sig user-Adrian&quot;&gt;&lt;i&gt;—~~~ &lt;small&gt;[[2006-02-26]] 01:57Z&lt;/small&gt;&lt;/i&gt;&lt;/span&gt;\n\n&quot;;
    var add_after = &quot;\n\n{{subst:afd bottom}}\n&quot;;
    var summary = 'AFD closed; result: ' + comment;

    editor.wpTextbox1 = add_before + $util.trimLines(editor.wpTextbox1) + add_after;
    editor.wpSummary = summary;
    editor.submit();
}

$util.addOnloadHook($xfdclose.load);


/****************************************************************************
 * END xfdclose.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN obsolete/autowarn.js
 ****************************************************************************/

// $Id: autowarn.js 926 2006-02-22 06:19:49Z quarl $

// autowarn.js -- obsoleted by userwarn.js




// [[User:Quarl/autowarn.js]] - warn user using templates.  Adds a &quot;warn&quot;
// menu.  (formerly [[User:Quarl/auto_testn.js]])

// Prompts for relevant pages; e.g. enter &quot;foo &amp;&amp; bar &amp;&amp; baz&quot;, and outputs
// &quot;This message concerns the pages [[foo]], [[bar]], and [[baz]].  Thanks for
// experimenting...&quot;

// depends: wikipage.js, wikiedit.js, wikitabs.js
// enhanced by: advanced_sig.js

// &lt;pre&gt;&lt;nowiki&gt;

var $autowarn = new Module('obsolete/autowarn.js');
var autowarn = $autowarn;

autowarn.warn = function(template) {
    var pagenames = prompt(&quot;Vandalism to which article(s) (separate using &amp;&amp;)?&quot;);
    if (typeof pagenames != 'string') return;

    wikiPage.getEditorAsync(autowarn._edit, template, pagenames);
}

autowarn._englishJoin = function(words) {
    if (words.length == 0) {
        return '';
    } else if (words.length == 1) {
        return words[0];
    } else if (words.length == 2) {
        return words[0] + ' and ' + words[1];
    } else {
        words[words.length-1] = 'and ' + words[words.length-1];
        return words.join(', ');
    }
}

autowarn._splitPageNames = function(s) {
    var words = s.split('&amp;&amp;');
    var pages = [];
    for (var i in words) {
        var word = $util.trimSpaces(words[i]);
        if (!word) continue;
        word = word.replace(/^\[\[/, '');
        word = word.replace(/\]\]$/, '');
        pages.push('[[' + word + ']]');
    }
    return pages;
}

autowarn._edit = function(editor, template, pagenames) {
    if (typeof(template) != 'string') { alert(&quot;autowarn Internal error 5f95d195-b1c8-4f7e-b751-740230b1926a&quot;); return; }

    var pagesw = autowarn._splitPageNames(pagenames);
    var pages = autowarn._englishJoin(pagesw);

    var text = '{{subst:' + template + '}} ' + '~~~~' + '\n';

    if (pages) {
        text = ('This message concerns the ' + (pagesw.length==1?'page':'pages') + ' ' +
                pages + '.  ' + text);
    }
    text = '\n\n' + text;

    var summary = &quot;Warning {{&quot; + template + &quot;}}&quot;;
    if (pages) {
        summary += &quot;, concerning &quot; + pages;
    }

    // if (editor.refuseCreate()) return;
    editor.wpTextbox1 = $util.trimLines(editor.wpTextbox1) + text;
    editor.wpSummary = summary;
    editor.submit();
}

autowarn._load = function() {
    // Only add tab to User talk pages (but not subpages)

    if (wikiPage.sandboxP ||
        wikiPage.namespace == 'User talk' &amp;&amp; !wikiPage.subarticle)
    {
        autowarn._addTabs();
    }
}

autowarn.widgetLoad_ = function()
{
    if (!wikiPage.nsUser) return;

    var menu = $wikiwidget.addTabMenu('Warn', 'mn-warn');

    var qt = function(s) { return s ? '&quot;'+s+'&quot;' : 'null'; }

    var warning = function(template /*, alttemplate */, title) {
        title = &quot;Warn user using template {{&quot;+template+&quot;}}: &quot; + title;
        $wikiwidget.addLiLink(menu, 'javascript:autowarn.warn(' + qt(template) /* + ', ' + qt(alttemplate)*/ + ')',
                            template, 'ca-autowarn-'+template,
                            title);
    }

    warning('nn-test', 'Non-notable additions');
    // warning('test0', 'Before making controversial edits, please discuss');
    warning('selftest', 'Thanks for reverting yourself');
    warning('test1', 'Your test worked, and has been reverted');
    warning('test2', 'Stop adding nonsense ');
    warning('test2a', 'Vandalism level 2 (blanking)');
    warning('test3', 'Stop vandalizing, or face block');
    warning('test4', 'Last warning before block');
    warning('test4im', 'This is your ONLY WARNING before block');
    warning('test5', 'You have been temporarily BLOCKED');
    warning('test6', 'You have been BLOCKED for repeated vandalism');
    warning('bv', 'Blatant vandal');

    // warning('spam1',);
    // warning('spam2',);


}

autowarn.widgetLoad = function() {
    $util.addOnloadHook(autowarn.widgetLoad_);
}

//

// &lt;/nowiki&gt;&lt;/pre&gt;

/****************************************************************************
 * END obsolete/autowarn.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN redirector.js
 ****************************************************************************/

// $Id: redirector.js 1128 2006-02-23 07:53:07Z quarl $

// redirector.js - &quot;Redirector&quot; application

// When you invoke the Redirector (through a tab), adds a new form to the
// document.  Start typing page names and press ENTER after each one.  A table
// will show the current status of each page (already a redirect, doesn't
// exist, etc.), and if you click &quot;Redirect!&quot;, the target page will be updated
// to redirect to the current page.

// USAGE:
//   $module.depend('redirector.js');
//   $redirector.widgetLoad();

// quarl 2006-02-09 initial version

var $redirector = new Module('redirector.js');
$redirector.depend('util.js', 'wikipage.js', 'wikiedit.js', 'wikiwidget.js', 'wikiparse.js');
$redirector.depend('redirector.css');

$redirector.options = {
    // seconds between updates
    update_interval: 1.0,

    // maximum number of concurrent requests
    max_concurrent_requests: 5
};

$redirector._entries = [];
$redirector._requests_in_progress = 0;

$redirector.run = function() {
    $redirector.widget.li.innerHTML = '&lt;a&gt;&lt;b&gt;Redirector&lt;/b&gt;&lt;/a&gt;'; // prevent future clicks
    $redirector.annotateDocument();
}

$redirector.annotateDocument = function() {
    if (document.getElementById('redirector')) {
        // already done, called again for some reason
        return;
    }

    var divLoc = document.getElementById('jump-to-nav');
    if (!divLoc) {
        alert(&quot;Redirector: couldn't get 'jump-to-nav' (error d5153643-a8c1-46ad-8d8e-c5d3fe066c77)&quot;);
        return;
    }

    $redirector.doc = new Object();
    $redirector.doc.div = document.createElement('div');
    $redirector.doc.div.id = 'redirector';

    $redirector.doc.div.innerHTML = (
        '&lt;h2&gt;Redirector&lt;/h2&gt;' +
        'Enter names of articles to redirect to &lt;tt&gt;'+wikiPage.page+'&lt;/tt&gt;, and press ENTER after each one:' +
        '&lt;form id=&quot;rcInputForm&quot;&gt;&lt;input type=&quot;text&quot; id=&quot;rcConsole&quot; name=&quot;rcConsole&quot; size=&quot;60&quot; /&gt;' +
        '&lt;input type=&quot;submit&quot; onclick=&quot;javascript:return $redirector.inputClicked()&quot; value=&quot;Enter&quot; /&gt;' +
        '&lt;input type=&quot;submit&quot; onclick=&quot;javascript:return $redirector.resetClicked()&quot; value=&quot;Clear all&quot; /&gt;' +
        '&lt;/form&gt;' +
        '&lt;table id=&quot;rcStatus&quot; class=&quot;prettytable&quot;&gt;&lt;tr&gt;&lt;th&gt;Page&lt;/th&gt;&lt;th&gt;Status&lt;/th&gt;&lt;th&gt;Action&lt;/th&gt;&lt;/table&gt;'
        );
    $util.addNodeAfter(divLoc, $redirector.doc.div);

    $redirector.doc.rcConsole = document.getElementById('rcConsole');
    $redirector.doc.rcStatus = document.getElementById('rcStatus');

    $redirector.doc.rcConsole.value = wikiPage.page;

    $redirector.doc.rcConsole.focus();

    $redirector.intervalHandle = setInterval($redirector.update, $redirector.options.update_interval * 1000);
}

$redirector.inputClicked = function() {
    var target = $util.trimSpaces($redirector.doc.rcConsole.value);
    if (!target) return false;
    if (target == wikiPage.page) return false;
    $redirector.addEntry(target);
    // $redirector.doc.rcConsole.value = wikiPage.page;
    return false;
}

$redirector.resetClicked = function() {
    for (var i in $redirector._entries) {
        $redirector._entries[i].clearentry = true;
    }
    return false;
}

$redirector.addEntry = function(s) {
    var t = new Object();

    // wiki page
    t.wp = new WikiPage(null, s);
    if (!t.wp) return;

    // delete old entry if any
    for (var i in $redirector._entries) {
        if ($redirector._entries[i].wp.page == t.wp.page) {
            $redirector._entries[i].clearentry = true;
        }
    }

    // object for document status nodes.  null = not yet added
    t.statusnode = null;

    // download request status.  0 = not yet initiated; 1 = initiated; 2 =
    // finished
    t.downloadstatus = 0;

    // WikiEditor instance
    t.editor = null;

    // string value of old contents of target page
    t.oldcontents = null;
    t.oldredirect = null;

    // whether user has clicked &quot;update&quot; button
    t.updatewanted = false;

    // whether update requires confirmation
    t.updatedangerous = false;

    // update request status.  0 = not yet initiated; 1 = iniatited; 2 =
    // completed
    t.updatestatus = 0;

    // whether this entry should be cleared when done with it
    t.clearentry = false;
    t.ignore = false;

    $redirector._entries.push(t);
    $redirector.update();
}

// main action loop
$redirector.update = function() {
    for (var i in $redirector._entries) {
        var t = $redirector._entries[i];

        if (t.ignore) continue;
        if (t.clearentry) {
            // only clear it if nothing in progress
            if ((t.downloadstatus == 0 || t.downloadstatus == 2) &amp;&amp;
                (t.updatestatus == 0 || t.updatestatus == 2))
            {
                t.statusnode.tr.parentNode.removeChild(t.statusnode.tr);
                t.ignore = true;
                continue;
            }
        }

        if (!t.statusnode) {
            $redirector._addStatusNode(t);
        }

        if ($redirector._requests_in_progress &lt; $redirector.options.max_concurrent_requests) {
            if (t.downloadstatus == 0) {
                $redirector._initiateDownload(t);
            } else if (t.downloadstatus == 2 &amp;&amp; t.updatewanted &amp;&amp; t.updatestatus == 0) {
                $redirector._initiateUpdate(t);
            }
        }
    }
}

$redirector._addStatusNode = function(t) {
    t.statusnode = new Object();
    t.statusnode.tr = document.createElement('tr');

    t.statusnode.page = document.createElement('td');
    var url = t.wp.qurl + '&amp;redirect=no';
    var urlEdit = t.wp.qurl + '&amp;action=edit';
    t.statusnode.page.innerHTML = (
        '&lt;a href=&quot;' + url + '&quot;&gt;' + t.wp.page + '&lt;/a&gt;' +
        ' [&lt;a href=&quot;' + urlEdit +'&quot;&gt;edit&lt;/a&gt;]');

    t.statusnode.status = document.createElement('td');
    t.statusnode.status.className = 'redirectorStatus';
    t.statusnode.status.innerHTML = '...';

    t.statusnode.action = document.createElement('td');
    t.statusnode.button = document.createElement('button');
    t.statusnode.button.onclick = function() { $redirector._actionClick(t) };
    t.statusnode.button.disabled = true;
    t.statusnode.button.innerHTML = 'please wait';
    t.statusnode.action.appendChild(t.statusnode.button);

    t.statusnode.tr.appendChild(t.statusnode.page);
    t.statusnode.tr.appendChild(t.statusnode.status);
    t.statusnode.tr.appendChild(t.statusnode.action);

    $redirector.doc.rcStatus.appendChild(t.statusnode.tr);
}

$redirector._actionClick = function(t) {
    if (t.updatedangerous) {
        if (!window.confirm(&quot;The target is not a redirect.  Are you sure?&quot;)) return;
    }

    t.updatewanted = true;
    t.statusnode.button.disabled = true;
}

$redirector._initiateDownload = function(t) {
    t.downloadstatus = 1;
    $redirector._requests_in_progress ++;
    t.statusnode.status.innerHTML = '&lt;span class=&quot;downloading&quot;&gt;downloading...&lt;/span&gt;';
    t.wp.getEditorAsync($redirector._downloadComplete, t);
}

$redirector._downloadComplete = function(editor, t) {
    t.downloadstatus = 2;
    $redirector._requests_in_progress --;
    t.editor = editor;
    t.oldcontents = t.editor.wpTextbox1;

    if (t.oldcontents.match(/^(?:\s|\n)*$/)) {
        t.status = 'empty';
        t.statustext = &quot;empty&quot;;
        t.statusnode.button.innerHTML = 'Create redirect!';
        t.statusnode.button.disabled = false;
    } else if ( (t.oldredirect = $wikiparse.isRedirect(t.oldcontents)) ) {
        t.oldredirectwp = new WikiPage(null, t.oldredirect);
        // use the parsed version (e.g. some people use _ or % escapes)
        t.oldredirect = t.oldredirectwp.page;
        if (t.oldredirect == wikiPage.page) {
            t.status = 'toHere';
            t.statustext = 'redirect to here';
            t.statusnode.button.innerHTML = 'Nothing to do!';
            t.statusnode.button.disabled = true;
        } else {
            t.status = 'toElsewhere';
            t.statustext = 'redirect to &lt;a href=&quot;'+t.oldredirectwp.url+'&quot;&gt;'+t.oldredirectwp.page+'&lt;/a&gt;';
            t.statusnode.button.innerHTML = 'Alter redirect!';
            t.updatedangerous = true;
            t.statusnode.button.disabled = false;
        }
    } else {
        t.status = 'notRedirect';
        t.statustext = 'non-redirect (' + $util.wordCount(t.oldcontents) + ' words)';
        t.statusnode.button.innerHTML = 'Change to redirect';
        t.updatedangerous = true;
        t.statusnode.button.disabled = false;
    }

    t.statusnode.status.innerHTML = '&lt;span class=&quot;'+t.status+'&quot;&gt;' + t.statustext + '&lt;/span&gt;';
}

$redirector._initiateUpdate = function(t) {
    t.updatestatus = 1;
    t.statusnode.button.innerHTML = 'Submitting...';
    $redirector._requests_in_progress ++;
    var rd = t.editor.wpTextbox1 = '#REDIRECT [[' + wikiPage.page + ']]\n';
    if (t.status == 'empty') {
        t.editor.wpSummary = 'Creating ' + rd;
    } else if (t.status == 'toElsewhere') {
        t.editor.wpSummary = 'Changing redirect from [[' + t.oldredirectwp.page + ']] to ' + rd;
    } else if (t.status == 'notRedirect') {
        t.editor.wpSummary = 'Changing article (' + $util.wordCount(t.oldcontents) + ' words) to ' + rd;
    } else {
        alert(&quot;internal error 3056fdaf-1147-4433-8334-d92eb2ffd8b7&quot;);
        return;
    }

    t.editor.submitAsync(null, $redirector._updateComplete, t);
}

$redirector._updateComplete = function(editor, t) {
    t.updatestatus = 2;
    t.statusnode.button.innerHTML = 'Done!';
    $redirector._requests_in_progress --;

    t.statusnode.status.innerHTML = '&lt;span class=&quot;done&quot;&gt;Redirected to here! (&lt;span class=&quot;previous&quot;&gt;' + t.statustext + '&lt;/span&gt;)&lt;/span&gt;';
}

$redirector.load = function() {
    if (wikiPage.nsSpecialP) return;

    $redirector.widget = new WikiWidget({
        default_location: {portlet: 'Toolbox'},
        onclick: $redirector.run,
        name: 'Redirector',
        id: 'ca-rediretor',
        title: 'Run the Redirector'});
};

$util.addOnloadHook($redirector.load);

$redirector.widgetLoad = function(location) {
    $util.addOnloadHook(function() {
            if ($redirector.widget) $redirector.widget.add(location);
        });
};

/****************************************************************************
 * END redirector.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN popups.js
 ****************************************************************************/

// -*- coding:utf-8 -*-
// $Id: popups.js 1250 2006-02-25 06:27:07Z quarl $

// originally from http://en.wikipedia.org/wiki/User:Lupin/popups.js
// [[User:Lupin/popups.js]]

var $popups = new Module('popups.js');
$popups.depend('overlib/overlib.js',
               'instaviewtiny.js',
               'md5.js', 'drag.js',
               'kookie.js', 'util.js',
               'wikipage.js', 'wikins.js',
               'wikiimg.js', 'wikiparse.js',
               'download.js', 'linkedit.js',
               'editcount.js');
$popups.depend('popups.css');


var ipUserRegex=RegExp('('+$wikins.User+':)?' +
                       '((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}' +
                       '(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])');

var oldidRegex=RegExp('[?&amp;]oldid=([0-9]*)');

var popupImageSize=60;

$popups.popupIdCount = 0;

// for setPopupHTML - needed for timers and stuff
var popupHTMLTimers=new Array();
var popupHTMLLoopFunctions = new Array();

// options

// if there's no cookie, this should expand to something like
// if (window.foo===null) window.foo=window.dfoo;
function defaultize(x) {
  var val=null;
  var a='window.'+x;
  var b='window.d'+x;
  if (x!='popupCookies') {
    defaultize('popupCookies');
    if (popupCookies &amp;&amp; (val=$kookie.get(x))) {
      eval(a + '=' + val + ';');
      return;
    }
  }
  eval('if ('+a+'===null) '+a+'=' + b + ';');
};

// this should expand to something like
// if (typeof window.foo=='undefined') { window.foo=null; }; window.dfoo = 0.5;
function newOption(x, def) {
  var a='window.'  + x;
  var b='window.d' + x;
  eval('if (typeof '+ a + '==\'undefined\') {' + a + '=null; }; ' + b + '=' + def + ';');
};

function getValueOf(varName) {defaultize(varName); return eval(varName);};

// user-settable parameters and defaults
// names beginning with a d are probably a bad idea!
// NB strings must be &quot;'double-quoted'&quot;
newOption('popupDelay', 0.5);
newOption('removeTitles', true);
newOption('imagePopupsForImages', true);
newOption('popupSummaryData', true);
newOption('simplePopups',  false);
newOption('popupAdminLinks',  false);
newOption('popupImages', true);
newOption('popupPreviews', true);
newOption('popupNavLinks', true);
newOption('popupNavLinkSeparator', &quot;' &amp;sdot; '&quot;);
newOption('popupOnlyArticleLinks', true);
newOption('popupNeverGetThumbs', false);
newOption('popupImagesFromThisWikiOnly', false);
newOption('popupAppendRedirNavLinks', true);
newOption('popupMaxWidth', 300);
newOption('popupSimplifyMainLink', true);
newOption('popupMinImageWidth', 50);
newOption('popupLastEditLink', true);
newOption('popupHistoricalLinks', true);
newOption('popupFixRedirs', true);
newOption('popupLiveOptions', false);
newOption('popupCookies', false);
newOption('popupLinkShowPreview', false);
newOption('popupShortcutKeys', false);
newOption('popupLiveOptionsExpanded', false);
newOption('popupFixDabs', true);
newOption('popupImagesToggleSize',true);
newOption('popupNewWindows', false);
// see later - default for popupStructure is &quot;'original'&quot; if simplePopups is true
newOption('popupStructure', &quot;'menus'&quot;);
newOption('popupInitialWidth', false); // integer or false
newOption('popupNavLinkStyle', &quot;'default'&quot;);
newOption('popupDragging', true);
newOption('popupActionsMenu', true);
newOption('popupRevertSummary', &quot;'Reversion to revision %s'&quot;);
newOption('popupPreviewKillTemplates', true);

// browser-specific hacks

if (typeof window.opera != 'undefined') {
  dpopupStructure='original';
}

if ((self.navigator.appName)=='Konqueror') {
  dpopupNavLinkSeparator=' &amp;bull; ';
} else if ((self.navigator.appName).indexOf(&quot;Microsoft&quot;)!=-1) {
  dpopupNavLinkSeparator=' &amp;#183; ';
  dpopupStructure='original';
}

$popups.Popup = function(a) {
    this.a = a;
    if (!a.wp) {
        a.wp = WikiPageRelevant(a.href);
    }
    this.wp = a.wp;
    this.popupId = $popups.popupIdCount++;
}

$popups.Popup.prototype.debug = function(s) {
    return $popups.debug('Popup('+this.popupId+')' + s);
}

// generate html for popup image
// &lt;a id=&quot;popupImageLinkn&quot;&gt;&lt;img id=&quot;popupImagen&quot;&gt;
// where n=popupId
$popups.Popup.prototype.imageHTML = function(article) {
  var ret='';
  ret += '&lt;a id=&quot;popupImageLink' + this.popupId + '&quot;&gt;';
  ret += '&lt;img align=&quot;right&quot; valign=&quot;top&quot; id=&quot;popupImg' + this.popupId + '&quot; '
    + 'style=&quot;display: none;&quot;&gt;&lt;/img&gt;';
  ret += '&lt;/a&gt;';
  return ret;
};

function isInToc(a) {
    return $util.isDescendent(a, document.getElementById('toc'), '_descendent_toc');
}

function isInArticle(a) {
    // 'content' is for monobook
    if (document.getElementById('article'))
        return $util.isDescendent(a, document.getElementById('article'), '_descendent_article');
    else
        return $util.isDescendent(a, document.getElementById('content'), '_descendent_content');
};

function WikiPageRelevant(h, safe) {
    var wp = WikiPage(h, null, null, safe);
    if (!wp) return null;
    if (wp.relevantUser &amp;&amp; !wp.nsUserP) {
        wp = WikiPage(null, $wikins.User + ':' + wp.relevantUser);
    }
    return wp;
};

function oldidFromURL(a) { var m=oldidRegex.exec(a); if (m) return m[1]; return null; };

// if redir is present and true then redirTarget is mandatory
$popups.Popup.prototype.fillEmptySpans = function(args) {
    if (!this.a) {
        $popups.error(&quot;fillEmptySpans: no 'a' (error 9b76dad9-f13a-4f4a-9b6f-2afc5247c1c4)&quot;);
        return;
    }

    var wp, hint, oldid;
    var redir = false;
    if (args &amp;&amp; args.redir) {
        wp = args.redir; hint=null;
        redir = true;
    } else {
        wp = this.wp;
        hint = this.a.originalTitle || wp.page;
        oldid=(getValueOf('popupHistoricalLinks'))?oldidFromURL(this.a.href):null;
    }

    this.debug('.fillEmptySpans(): redir='+redir+ ', page='+wp.page);

    var x={wp: wp,
           hint: hint,
           oldid: oldid };

    defaultize('popupStructure');
    var structure=window.popupStructures[popupStructure];
    if (typeof structure != 'object') {
        this.setPopupHTML('popupError', 'Unknown structure: '+ popupStructure);
        return;
    }
    var spans=$util.flatten(window.popupLayout);
    var redirs=window.popupRedirSpans;
    this.debug('.fillEmptySpans(): spans.length='+spans.length);
    for (var i=0; i&lt;spans.length; ++i) {
        var f=findThis(redirs, spans[i]);
        // $popups.debug('redir='+redir+', f='+f+', spans[i]='+spans[i]);
        if ( (f!=null &amp;&amp; !redir) || (f==null &amp;&amp; redir) ) {
            // $popups.debug('skipping this set of the loop');
            continue;
        }
        var structurefn=structure[spans[i]];
        switch (typeof structurefn) {
        case 'function':
            this.debug('.fillEmptySpans(): running '+spans[i]+'({wp:'+x.wp+', hint:'+x.hint+', oldid: '+x.oldid+'})');
            this.setPopupHTML(structurefn(x), spans[i]);
            break;
        case 'string':
            this.setPopupHTML(structurefn, spans[i]);
            break;
        case 'undefined':
            break;
        default:
            $popups.error(&quot;unknown thing with label &quot;+spans[i] + &quot;, type &quot;+(typeof structurefn) + &quot; (error 64fcb997-630c-46a7-a337-8aa0fd01eb01)&quot;);
            break;
        }
    }
};

window.popupStructures = new Object;

window.popupStructures.original=new Object;

window.popupStructures.original.popupLayout=function () {
  return ['popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupData', 'popupOtherLinks',
          'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
          'popupMiscTools', ['popupLiveOptions', 'popupShowPreview'],
          'popupPreview', 'popupFixDab'];
};
// TODO: ripe for major cleanup, partition popupLayout, or at least set
// properties
window.popupStructures.original.popupRedirSpans=function () {
  return ['popupRedir', 'popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'];
};
window.popupStructures.original.popupTitle=function (x) {
  $popups.debug('defaultstructure.popupTitle');
  if (!getValueOf('popupNavLinks')) return navlinkStringToHTML('&lt;b&gt;&lt;&lt;mainlink&gt;&gt;&lt;/b&gt;',x.wp,x.oldid);
  return '';
};
window.popupStructures.original.popupTopLinks=function (x) {
  $popups.debug('defaultstructure.popupTopLinks');
  if (getValueOf('popupNavLinks')) return navLinksHTML(x.wp, x.hint, x.oldid);
  return '';
};
window.popupStructures.original.popupImage=function(x) {
  $popups.debug('original.popupImage, x.wp='+x.wp+', popupId='+$popups.currentPopup.popupId); // TODO
  return $popups.currentPopup.imageHTML(x.wp);
};
window.popupStructures.original.popupShowPreview=function(x) {
  if (getValueOf('popupLinkShowPreview')) return '&lt;br/&gt;&lt;span onClick=&quot;javascript:$popups.currentPopup.showPreview()&quot; '
    + 'style=&quot;cursor:pointer; border: thin dotted black&quot; '
    + 'title=&quot;Download preview data from the Wikipedia servers&quot;&gt;'
    + 'Get preview data'
    + '&lt;/span&gt;';
  return '';
};
window.popupStructures.original.popupRedirTitle=window.popupStructures.original.popupTitle;
window.popupStructures.original.popupRedirTopLinks=window.popupStructures.original.popupTopLinks;


var prop;

function copyStructure(oldStructure, newStructure) {
  window.popupStructures[newStructure]=new Object();
  for (var prop in window.popupStructures[oldStructure])
    window.popupStructures[newStructure][prop]=window.popupStructures[oldStructure][prop];
}

/** -- fancy -- **/
copyStructure('original', 'fancy');
window.popupStructures.fancy.popupTitle=function (x) {
  return navlinkStringToHTML('&lt;font size=+0&gt;&lt;&lt;mainlink&gt;&gt;&lt;/font&gt;',x.wp,x.oldid);
};

window.popupStructures.fancy.popupTopLinks=function(x) {
  var hist='&lt;&lt;history|shortcut=h|hist&gt;&gt;|&lt;&lt;lastEdit|shortcut=/|last&gt;&gt;';
  var watch='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m&gt;&gt;';
  return navlinkStringToHTML('if(talk){'
                            +'&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;new|shortcut=+|+&gt;&gt;*' + hist + '*'
                            +'&lt;&lt;article|shortcut=a|article&gt;&gt;|&lt;&lt;editArticle|edit&gt;&gt;' + '*' + watch + '*' + move
                            +'}else{&lt;&lt;edit|shortcut=e&gt;&gt;*' + hist
                            +'*&lt;&lt;talk|shortcut=t&gt;&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;'
                            +'*' + watch + '*' + move+'}&lt;br/&gt;', x.wp, x.oldid);
};

window.popupStructures.fancy.popupOtherLinks=function(x) {
  var admin='&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d|del&gt;&gt;';
  var user='&lt;&lt;contribs|shortcut=c&gt;&gt;';
  if (WikiPage.wikimediaWikiP) user+='if(ipuser){}else{|&lt;&lt;count|shortcut=#|#&gt;&gt;}';
  user+='if(ipuser){}else{*&lt;&lt;email|shortcut=E&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}';

  var normal='&lt;&lt;whatLinksHere|shortcut=l|links here&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r|related&gt;&gt;';
  return navlinkStringToHTML('&lt;br/&gt;if(user){' + user + '*}if(admin){'+admin+'if(user){&lt;br/&gt;}else{*}}'
            +normal, x.wp, x.oldid);
};

window.popupStructures.fancy.popupRedirTitle=window.popupStructures.fancy.popupTitle;
window.popupStructures.fancy.popupRedirTopLinks=window.popupStructures.fancy.popupTopLinks;
window.popupStructures.fancy.popupRedirOtherLinks=window.popupStructures.fancy.popupOtherLinks;


/** -- fancy2 -- **/
// hack for [[User:MacGyverMagic]]
copyStructure('fancy', 'fancy2');
window.popupStructures.fancy2.popupTopLinks=function(x) { // hack out the &lt;br&gt; at the end and put one at the beginning
  return '&lt;br&gt;'+window.popupStructures.fancy.popupTopLinks(x).replace(RegExp('&lt;br ?/?&gt;$','i'),'');
};
window.popupStructures.fancy2.popupLayout=function () { // move toplinks to after the title
  return ['popupError', 'popupImage', 'popupTitle', 'popupData', 'popupTopLinks', 'popupOtherLinks',
          'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
          'popupMiscTools', ['popupLiveOptions', 'popupShowPreview'],
          'popupPreview', 'popupFixDab'];
};

/** -- menus -- **/
copyStructure('original', 'menus');
window.popupStructures.menus.popupLayout=function () {
  return ['popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupOtherLinks',
          'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'],
          'popupData', 'popupMiscTools', ['popupLiveOptions', 'popupShowPreview'],
          'popupPreview', 'popupFixDab'];
};

window.popupStructures.menus.popupTopLinks = function (x) {
  var s='';
  var hist='&lt;&lt;history|shortcut=h&gt;&gt;';
  var lastedit='&lt;&lt;lastEdit|shortcut=/|show last edit&gt;&gt;';
  var linkshere='&lt;&lt;whatLinksHere|shortcut=l|what links here&gt;&gt;';
  var related='&lt;&lt;relatedChanges|shortcut=r|related changes&gt;&gt;';
  var search='&lt;&lt;search|shortcut=s&gt;&gt;';
  if (WikiPage.wikimediaWikiP) search += '|&lt;&lt;globalsearch|shortcut=g|global&gt;&gt;';
  var watch='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';
  var protect='&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;';
  var del='&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m|move page&gt;&gt;';
  var dropdiv='&lt;div class=&quot;popup_drop&quot;&gt;';
  var menuspan='&lt;span class=&quot;popup_menu&quot;&gt;';
  var rowspan='&lt;span class=&quot;popup_menu_row&quot;&gt;';
  var enddiv='&lt;/div&gt;';
  var endspan='&lt;/span&gt;';
  if (getValueOf('popupActionsMenu')) s += '&lt;&lt;mainlink&gt;&gt;*' + dropdiv + '&lt;a href=&quot;#&quot;&gt;actions&lt;/a&gt;';
  else s+= dropdiv + '&lt;&lt;mainlink&gt;&gt;';
  s+= menuspan
        + 'if(oldid){'+rowspan+'&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;editOld|shortcut=e|this&amp;nbsp;revision&gt;&gt;' + endspan
        + '&lt;&lt;revert|shortcut=v|revert&gt;&gt;'
        + '}else{&lt;&lt;edit|shortcut=e&gt;&gt;}'
        + 'if(talk){&lt;&lt;new|shortcut=+|new topic&gt;&gt;}'
        + hist + lastedit + move
        + linkshere + related
        // + '&lt;&lt;nullEdit|shortcut=n|null edit&gt;&gt;'
        + rowspan + search + endspan
        + '&lt;hr/&gt;'
        + rowspan + watch + endspan
        + 'if(admin){' + rowspan + protect + endspan + rowspan + del + endspan + '}'
        + 'if(talk){'
        + '&lt;hr/&gt;'
        + '&lt;&lt;article|shortcut=a|view article&gt;&gt;'
        + '&lt;&lt;editArticle|edit article&gt;&gt;'
        + '}else{'
        + '&lt;hr/&gt;'
        + '&lt;&lt;talk|shortcut=t|talk page&gt;&gt;'
        + '&lt;&lt;editTalk|edit talk&gt;&gt;'
        + '&lt;&lt;newTalk|shortcut=+|new topic&gt;&gt;'
        + '}'
        + endspan
  + enddiv;
  s+='if(user){*' + dropdiv + '&lt;a href=&quot;#&quot;&gt;user&lt;/a&gt;' + menuspan
        + rowspan + '&lt;&lt;userPage|shortcut=u|user page&gt;&gt;|&lt;&lt;userSpace|space&gt;&gt;' + endspan
        + '&lt;&lt;userTalk|shortcut=t|user talk&gt;&gt;'
        + '&lt;&lt;editUserTalk|edit user talk&gt;&gt;'
        + '&lt;&lt;newUserTalk|shortcut=+|leave comment&gt;&gt;'
        + 'if(ipuser){}else{&lt;&lt;email|shortcut=E|email user&gt;&gt;}'
        + '&lt;hr/&gt;'
        + '&lt;&lt;contribs|shortcut=c|contributions&gt;&gt;'
        + '&lt;&lt;userlog|shortcut=L|user log&gt;&gt;'
        + ((WikiPage.wikimediaWikiP)?'&lt;&lt;count|shortcut=#|edit counter&gt;&gt;':'')
        + 'if(admin){' + rowspan + '&lt;&lt;unblock|un&gt;&gt;|&lt;&lt;block|shortcut=b|block user&gt;&gt;' + endspan +'}'
        + '&lt;&lt;blocklog|shortcut=B|block log&gt;&gt;'
        + endspan + enddiv
        + '}';
  return navlinkStringToHTML(s, x.wp, x.oldid);
};

window.popupStructures.menus.popupRedirTitle=window.popupStructures.menus.popupTitle;
window.popupStructures.menus.popupRedirTopLinks=window.popupStructures.menus.popupTopLinks;

// Generate html for whole popup
$popups.Popup.prototype.generateHTMLspans = function() { // TODO: cleanup
    defaultize('popupStructure');
    var structure=window.popupStructures[popupStructure];
    if (typeof structure != 'object') {
        return $popups.error('Unknown structure: '+popupStructure+&quot; (error fc49e7b6-1d0c-4b57-98a9-f3c75358feb0)&quot;);
    }
    if (typeof structure.popupLayout != 'function') {
        return $popups.error(&quot;Bad structure.popupLayout (error 90049255-00a1-4ff5-a0f2-53e01ea9c12c)&quot;);
    }
    window.popupLayout=structure.popupLayout();
    if (typeof structure.popupRedirSpans == 'function') {
        window.popupRedirSpans=structure.popupRedirSpans();
    } else {
        window.popupRedirSpans=[];
    }
    return this.makeEmptySpans(window.popupLayout);
};

$popups.Popup.prototype.makeEmptySpans = function (list) {
    var ret='';
    for (var i=0; i&lt;list.length; ++i) {
        if (typeof list[i] == typeof '')
            ret += emptySpanHTML(list[i], this.popupId);
        else if (typeof list[i] == typeof [] ) {
            ret = ret.substring(0,ret.length-'&lt;/span&gt;'.length) + this.makeEmptySpans(list[i]) + '&lt;/span&gt;';
        }
    }
    return ret;
};

function isIpUser(user) {return user &amp;&amp; ipUserRegex.test(user);};

function popupToggleVar(varstring) {
  defaultize(varstring);
  //eval('window.'+varstring+'=!window.' + varstring);
  window[varstring] = !window[varstring];
  defaultize('popupCookies');
  if (popupCookies) $kookie.set(varstring, String(window[varstring]));
};

function popupToggleShowOptions (dummy) {
  // just update state if dummy is true
  defaultize('popupLiveOptionsExpanded');
  if (!dummy) window.popupLiveOptionsExpanded=!window.popupLiveOptionsExpanded;
  $popups.currentPopup.setPopupHTML(
      (window.popupLiveOptionsExpanded) ? '&amp;lt;&amp;lt;' : '&amp;gt;&amp;gt;',
      'optionPopped');
  var s=document.getElementById('popupOptionsDiv');
  // if (!s) return;
  if (window.popupLiveOptionsExpanded) s.style.display='inline';
  else s.style.display='none';
};

function popupOptionsCheckboxHTML(varstring, label, title) {
  var html='&lt;br/&gt;';
  html += '&lt;span title=&quot;'+title+'&quot;&gt;';
  html += '&lt;input type=&quot;checkbox&quot; id=&quot;'+varstring+'Checkbox&quot; ';
  html += (window[varstring]) ? 'checked=&quot;checked&quot; ' : '';
  html += 'onClick=&quot;javascript:popupToggleVar(' + &quot;'&quot; + varstring + &quot;'&quot; +
    ')&quot;&gt;' + label + '&lt;/input&gt;&lt;/span&gt;';
  return html;
};

function popupLiveOptionsHTML() {
  var html = '';
  html += '&lt;br/&gt;';
  html += '&lt;span title=&quot;Show/hide options&quot; ';
  html += 'style=&quot;border: thin dotted black; cursor: pointer&quot; ';
  html += 'onClick=&quot;javascript:popupToggleShowOptions()&quot;&gt;';
  html += 'Options &lt;span id=&quot;optionPopped' + $popups.currentPopup.popupId + '&quot;&gt;&lt;/span&gt;'; // TODO
  html += '&lt;/span&gt;';
  html += '&lt;div style=&quot;display: none&quot; id=&quot;popupOptionsDiv&quot;&gt;';
  html += popupOptionsCheckboxHTML('simplePopups', 'Simple popups',
               'Never download extra stuff for images/previews');
  html += popupOptionsCheckboxHTML('popupLinkShowPreview', 'Preview only on click',
               'Only start downloading when told to do so');
  //html += popupOptionsCheckboxHTML('popupCookies', 'cookies',
  //             'Use cookies to store popups options');
  html += popupOptionsCheckboxHTML('popupNavLinks', 'Show navigation links',
               'Display navigation links at the top of the popup');
  html += popupOptionsCheckboxHTML('popupImages', 'Show image previews',
               'Load images');
  html += popupOptionsCheckboxHTML('popupSummaryData', 'Show summary data',
               'Show page summary data');
  html += popupOptionsCheckboxHTML('popupPreviews', 'Show text previews',
               'Show previews');

  var extraOptions=[
                    'imagePopupsForImages',
                    'popupAdminLinks',
                    'popupAppendRedirNavLinks',
                    'popupCookies',
                    'popupFixDabs',
                    'popupFixRedirs',
                    'popupHistoricalLinks',
                    // 'popupImagesFromThisWikiOnly',
                    'popupImagesToggleSize',
                    'popupLastEditLink',
                    'popupLiveOptions',
                    'popupNeverGetThumbs',
                    'popupOnlyArticleLinks',
                    'popupPreviewKillTemplates',
                    'popupPreviewFirstParOnly',
                    'popupShortcutKeys',
                    'popupSimplifyMainLink',
                    'removeTitles' // no ,
  ];
  for (var i=0; i&lt;extraOptions.length; ++i) {
    html += popupOptionsCheckboxHTML(extraOptions[i], extraOptions[i], 'Toggle this option');
  }

  html += '&lt;/div&gt;';
  return html;
};

// TODO
function emptySpanHTML(name, id) {return '&lt;span id=&quot;' + name + id + '&quot;&gt;&lt;/span&gt;';};

// function emptySpanHTML(name, id, tag, classname) {
//   tag = tag || 'span';
//   classname = classname || name;
//   return simplePrintf('&lt;%s id=&quot;%s&quot; class=&quot;%s&quot;&gt;&lt;/%s&gt;', [tag, name + id, classname, tag]);
// }

function addLinkProperty(html, property) {
  // take &quot;&lt;a href=...&gt;...&lt;/a&gt; and add a property
  // not sophisticated at all, easily broken
  var i=html.indexOf('&gt;');
  if (i&lt;0) return html;
  return html.substring(0,i) + ' ' + property + html.substring(i);
};

// TODO: CLEANUP!
function addPopupShortcut(html, key) {
  if (!getValueOf('popupShortcutKeys')) return html;
  var ret= addLinkProperty(html, 'popupkey=&quot;'+key+'&quot;');
  if (key==' ') key='space';
  return ret.replace(RegExp('^(.*?)(title=&quot;)(.*?)(&quot;.*)$', 'i'),'$1$2$3 ['+key+']$4');
};

function crypticNavlinkSpec() {
  if (typeof popupNavLinkSeparator=='undefined') window.dpopupNavLinkSeparator=window.dpopupNavLinkSeparator.split(' ').join('');
  var str= '&lt;b&gt;&lt;&lt;mainlink|shortcut= &gt;&gt;&lt;/b&gt;&lt;&lt;imagestatus&gt;&gt;if(admin){&lt;br/&gt;}else{*}if(user){&lt;&lt;contribs|shortcut=c|c&gt;&gt;' +
    'if(ipuser){}else{|&lt;&lt;email|shortcut=E|e&gt;&gt;}';
  if (WikiPage.wikimediaWikiP) str += 'if(ipuser){}else{|&lt;&lt;count|shortcut=#|#&gt;&gt;}';
  str+='if(admin){|&lt;&lt;block|shortcut=b|b&gt;&gt;}*}if(talk){if(oldid){&lt;&lt;editOld|shortcut=e|e&gt;&gt;|&lt;&lt;revert|shortcut=v|rv&gt;&gt;|&lt;&lt;edit|c&gt;&gt;*}else{&lt;&lt;edit|shortcut=e|e&gt;&gt;}|&lt;&lt;new|shortcut=+|+&gt;&gt;*&lt;&lt;history|shortcut=h|h&gt;&gt;*&lt;&lt;unwatch|un|u&gt;&gt;/&lt;&lt;watch|shortcut=w|w&gt;&gt;*&lt;b&gt;&lt;&lt;article|shortcut=a|a&gt;&gt;&lt;/b&gt;|&lt;&lt;editArticle|edit|e&gt;&gt;}else{if(oldid){&lt;&lt;editOld|shortcut=e|e&gt;&gt;|&lt;&lt;revert|shortcut=v|rv&gt;&gt;|&lt;&lt;edit|cur|c&gt;&gt;}else{&lt;&lt;edit|shortcut=e|e&gt;&gt;}*&lt;&lt;history|shortcut=h|h&gt;&gt;*&lt;&lt;unwatch|un|u&gt;&gt;/&lt;&lt;watch|shortcut=w|w&gt;&gt;*&lt;b&gt;&lt;&lt;talk|shortcut=t|t&gt;&gt;&lt;/b&gt;|&lt;&lt;editTalk|edit|e&gt;&gt;|&lt;&lt;newTalk|shortcut=+|+&gt;&gt;}*&lt;&lt;whatLinksHere|shortcut=l|l&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r|r&gt;&gt;*&lt;&lt;move|shortcut=m|m&gt;&gt;if(admin){*&lt;&lt;unprotect|un|u&gt;&gt;/&lt;&lt;protect|shortcut=p|p&gt;&gt;*&lt;&lt;undelete|un|u&gt;&gt;/&lt;&lt;delete|shortcut=d|d&gt;&gt;}';

  return str;
};

function defaultNavlinkSpec() {
  var str='';
  str += '&lt;b&gt;&lt;&lt;mainlink|shortcut= &gt;&gt;&lt;/b&gt;';
  if (getValueOf('popupLastEditLink')) str += '*&lt;&lt;lastEdit|shortcut=/&gt;&gt;if(oldid){|&lt;&lt;oldEdit&gt;&gt;|&lt;&lt;diffCur&gt;&gt;}';
  str+='&lt;&lt;imagestatus&gt;&gt;';

  // user links
  // contribs - log - count - email - block
  // count only if applicable; block only if popupAdminLinks
  str += 'if(user){&lt;br/&gt;&lt;&lt;contribs|shortcut=c&gt;&gt;*&lt;&lt;userlog|shortcut=L|log&gt;&gt;';
  if (WikiPage.wikimediaWikiP) str+='if(ipuser){}else{*&lt;&lt;count|shortcut=#&gt;&gt;}';
  str+='if(ipuser){}else{*&lt;&lt;email|shortcut=E&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}}';

  // editing links
  // talkpage   -&gt; edit|new - history - un|watch - article|edit
  // other page -&gt; edit - history - un|watch - talk|edit|new
  var editstr='&lt;&lt;edit|shortcut=e&gt;&gt;';
  var editOldidStr='if(oldid){&lt;&lt;editOld|shortcut=e&gt;&gt;|&lt;&lt;revert|shortcut=v|rv&gt;&gt;|&lt;&lt;edit|cur&gt;&gt;}else{' + editstr + '}'
  var historystr='&lt;&lt;history|shortcut=h&gt;&gt;';
  var watchstr='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';

  str+='&lt;br/&gt;if(talk){' +
    editOldidStr+'|&lt;&lt;new|shortcut=+&gt;&gt;' + '*' + historystr+'*'+watchstr + '*' + '&lt;b&gt;&lt;&lt;article|shortcut=a&gt;&gt;&lt;/b&gt;|&lt;&lt;editArticle|edit&gt;&gt;'
    + '}else{' // not a talk page
    + editOldidStr + '*' + historystr + '*' + watchstr + '*' + '&lt;b&gt;&lt;&lt;talk|shortcut=t&gt;&gt;&lt;/b&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;'
    + '}';

  // misc links
  str += '&lt;br/&gt;&lt;&lt;whatLinksHere|shortcut=l&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r&gt;&gt;*&lt;&lt;move|shortcut=m&gt;&gt;';

  // admin links
  str += 'if(admin){&lt;br/&gt;&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*' + '&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;}';
  return str;
};

function navLinksHTML (wp, hint, oldid) {
  //  defaultize('popupNavLinkSeparator');
  var str = '&lt;span class=&quot;popupNavLinks&quot;&gt;';
  var style=getValueOf('popupNavLinkStyle');
  switch (style) {
  case 'cryptic':
    str += crypticNavlinkSpec();
    break;
  case 'default':
    str += defaultNavlinkSpec();
    break;
  default:
    if (typeof style == 'function') str += style();
    else str+=String(style);
  }
  str += '&lt;/span&gt;';

  // BAM
  return navlinkStringToHTML(str, wp, oldid);
};

function expandConditionalNavlinkString(s,wp,oldid,recursionCount) {
  // nested conditionals (up to 10 deep) are ok, hopefully! (work from the inside out)
  if (typeof recursionCount!=typeof 0) recursionCount=0;
  var conditionalSplitRegex=RegExp(
    '(;?\\s*if\\s*\\(\\s*([a-z]*)\\s*\\)\\s*\\{([^{}]*)\\}(\\s*else\\s*\\{([^{}]*?)\\}|))', 'i');
  var splitted=s.parenSplit(conditionalSplitRegex);
  // $1: whole conditional
  // $2: user|talk
  // $3: true expansion
  // $4: else clause (possibly empty)
  // $5: false expansion (possibly null)
  var numParens=5;
  var ret = splitted[0];
  for (var i=1; i&lt;splitted.length; i=i+numParens+1) {

    var testString=splitted[i+2-1];
    var trueString=splitted[i+3-1];
    var falseString=splitted[i+5-1];
    if (typeof falseString=='undefined' || !falseString) falseString='';
    var testResult=null;

    switch (testString) {
    case 'user':
      testResult=wp.relevantUser?true:false;
      break;
    case 'talk':
        if (!wp || !wp.talkPage) { testResult=false;break;}//XXX
        testResult=wp.talkPage()?false:true; // talkPage converts _articles_ to talkPages
      break;
    case 'admin':
      testResult=getValueOf('popupAdminLinks')?true:false;
      break;
    case 'oldid':
      testResult=(typeof oldid != 'undefined' &amp;&amp; oldid)?true:false;
      break;
    case 'ipuser':
      testResult=(isIpUser(wp.relevantUser))?true:false;
      break;
    case 'mainspace':
        testResult=wp.nsMainP;
        break;
    case 'wikimedia':
        testResult= WikiPage.wikimediaWikiP;
      break;
    }

    switch(testResult) {
    case null: ret+=splitted[i];  break;
    case true: ret+=trueString;   break;
    case false: ret+=falseString; break;
    }


    // append non-conditional string
    ret += splitted[i+numParens];
  }
  if (conditionalSplitRegex.test(ret) &amp;&amp; recursionCount &lt; 10)
    return expandConditionalNavlinkString(ret,wp,oldid,recursionCount+1);
  else return ret;
};

function navlinkStringToArray(s, wp, oldid) {
  s=expandConditionalNavlinkString(s,wp,oldid);
  var splitted=s.parenSplit(RegExp('&lt;&lt;(.*?)&gt;&gt;'));
  var ret=[];
  for (var i=0; i&lt;splitted.length; ++i) {
    if (i%2) { // i odd, so s is a tag
      var t=new navlinkTag();
      var ss=splitted[i].split('|');
      t.id=ss[0];
      for (var j=1; j&lt;ss.length; ++j) {
        var sss=ss[j].split('=');
        if (sss.length&gt;1)
          // eval ('t.'+sss[0]+'=&quot;'+sss[1]+'&quot;;');
          t[sss[0]]=sss[1];
        else
          t.text=sss[0];
      }
      t.wp = wp;
      if (typeof oldid != 'undefined' &amp;&amp; oldid != null) t.oldid=oldid;
      ret.push(t);
    }
    else { // plain HTML
      ret.push(splitted[i].split('*').join(getValueOf('popupNavLinkSeparator')));
    }
  }
  return ret;
};

// navlinkString: * becomes the separator
//                &lt;&lt;foo|bar=baz|fubar&gt;&gt; becomes a foo-link with attribute bar='baz'
//                                      and visible text 'fubar'
//                if(test){...} and if(test){...}else{...} work too (nested ok)

function navlinkStringToHTML(s,wp,oldid) {
  var p=navlinkStringToArray(s,wp,oldid);
  var html='';
  for (var i=0; i&lt;p.length; ++i) {
    if (typeof p[i] == typeof '') {
      html+=p[i];
    } else if (typeof p[i].type != 'undefined' &amp;&amp; p[i].type=='navlinkTag') {
      html+=p[i].html();
    }
  }
  return html;
}

function navlinkTag() {this.type='navlinkTag';};

navlinkTag.prototype.html=function () {
  this.getPrintFunction();
  var html='';
  if (typeof this.print!='function') {
    $popups.error('Oh dear - invalid print function for a navlinkTag, id='+this.id);
  } else {
    html=this.print(this);
    if (typeof html != typeof '') {html='';}
    else if (typeof this.shortcut!='undefined') html=addPopupShortcut(html, this.shortcut);
  }
  return '&lt;span class=&quot;popup_'+this.id+'&quot;&gt;'+html+'&lt;/span&gt;';
};

navlinkTag.prototype.getPrintFunction=function() {
    if (!this.id || !this.wp) return;

    var html='';
    var a,t;

    switch (this.id) {
    case 'email':     case 'contribs':  case 'block':     case 'unblock':
    case 'userlog':   case 'blocklog':  case 'userSpace':
        this.wp = WikiPage(null, $wikins.User+':'+ this.wp.relevantUser);//TODO
    }

    switch (this.id) {
        case 'blocklog': this.wp = WikiPage(null, $wikins.User+':'+this.wp.relevantUser); // TODO
    }

    switch (this.id) {
        case 'userTalk': case 'newUserTalk': case 'editUserTalk':
        case 'userPage':
        delete this.oldid;
        this.wp = WikiPage(null, $wikins.User+':'+this.wp.relevantUser); // TODO
    }

    if (this.id != 'mainlink') {
        if (typeof this.text=='undefined') this.text=this.id;
    }

    var wpT = this.wp.talkPage();
    var wpNT = this.wp.notalkPage();

    switch (this.id) {
    case 'undelete':       this.print=specialLink; this.specialpage='Undelete'; this.sep='/'; break;
    case 'whatLinksHere':  this.print=specialLink; this.specialpage='Whatlinkshere'; break;
    case 'relatedChanges': this.print=specialLink; this.specialpage='Recentchangeslinked'; break;
    case 'move':           this.print=specialLink; this.specialpage='Movepage'; break;

    case 'contribs':       this.print=specialLink; this.specialpage='Contributions'; break;
    case 'email':          this.print=specialLink; this.specialpage='Emailuser'; break;
    case 'block':          this.print=specialLink; this.specialpage='Blockip'; this.sep='&amp;ip='; break;
    case 'unblock':        this.print=specialLink; this.specialpage='Ipblocklist'; this.sep='&amp;action=unblock&amp;ip='; break;
    case 'userlog':        this.print=specialLink; this.specialpage='Log'; this.sep='&amp;user='; break;
    case 'blocklog':       this.print=specialLink; this.specialpage='Log'; this.sep='&amp;type=block&amp;page='; break;
    case 'userSpace':      this.print=specialLink; this.specialpage='Prefixindex'; this.sep='&amp;namespace=2&amp;from='; break;
    case 'search':         this.print=specialLink; this.specialpage='Search'; this.sep='&amp;fulltext=Search&amp;search='; break;
    case 'history': case 'unwatch': case 'watch':
    case 'unprotect': case 'protect': case 'delete':
        this.print=wikiLink; this.action=this.id; break;

    case 'edit': case 'view':
        this.print=wikiLink;
        delete this.oldid;
        this.action=this.id; break;

    case 'new':
        this.print=wikiLink; this.action='edit&amp;section=new'; break;

    case 'mainlink':
        if (!this.text) this.text=this.wp.page;
        if (getValueOf('popupSimplifyMainLink') &amp;&amp; this.wp.namespace != &quot;&quot;) {
            // get last path component
            var s=this.text.split('/'); this.text=s[s.length-1];
            if (this.text=='' &amp;&amp; s.length &gt; 1) this.text=s[s.length-2];
        }
        this.print=titledWikiLink;
        if (typeof this.title=='undefined' &amp;&amp;
            $popups.currentPopup &amp;&amp;
            $popups.currentPopup.a)
        {
            if ($popups.currentPopup.a.originalTitle) {//TODO
                this.title = /*$util.wpaDecode(*/$popups.currentPopup.a.originalTitle;
            } else {
                this.title = this.wp.page;
            }
            if (typeof this.oldid != 'undefined' &amp;&amp; this.oldid) this.title='Revision ' + this.oldid + ' of ' + this.title;
        }
        this.action='view'; break;

    case 'userPage':
    case 'article':
        if (wpNT) { this.wp = wpNT; delete this.oldid; }
        this.print=wikiLink;
        this.action='view'; break;

    case 'editArticle':
        if (wpNT) { this.wp = wpNT; delete this.oldid; }
        this.print=wikiLink;
        this.action='edit'; break;

    case 'userTalk':
    case 'talk':
        t = this.wp.talkPage();
        if (t) { this.wp = t; delete this.oldid; }
        this.print=wikiLink;
        this.action='view'; break;

    case 'count':
        this.print=kateLink; break;
    case 'globalsearch':
        this.print=globalSearchLink; break;

    case 'lastEdit':
        this.print=titledDiffLink;
        this.title='Show the last edit';
        this.from='prev'; this.to='cur'; break;

    case 'oldEdit':
        this.print=titledDiffLink;
        this.title='Show the edit made to get revision '+this.oldid;
        this.from='prev'; this.to=this.oldid; break;

    case 'editOld':
        this.print=wikiLink; this.action='edit'; break;
    case 'revert':
        this.print=wikiLink; this.action='revert'; break;

    // case 'nullEdit':
    //     this.print=wikiLink; this.action='nullEdit'; break;

    case 'diffCur':
        this.print=titledDiffLink;
        this.title='Show changes since revision '+ this.oldid;
        this.from=this.oldid; this.to='cur'; break;

    case 'editUserTalk':
    case 'editTalk':
        if (wpT) { this.wp = wpT; delete this.oldid; }
        this.action='edit'; this.print=wikiLink; break;

    case 'newUserTalk':
    case 'newTalk':
        if (wpT) { this.wp = wpT; delete this.oldid; }
        this.action='edit&amp;section=new'; this.print=wikiLink; break;

    case 'imagestatus':
        this.print=function () { return emptySpanHTML('popupImageStatus', $popups.currentPopup.popupId); } // TODO
        break;

    default:
        this.print=function () {return 'Unknown navlink type: '+this.id+''};
    }
};

$popups._makeRawDownloadUrl = function(wp, oldid) {
    // set ctype=text/css to get around opera bug
    var url = wp.qurl + '&amp;action=raw&amp;ctype=text/css';
    if (oldid) url += '&amp;oldid='+oldid;
    return url;
}


/////////////////////
// LINK GENERATION //
/////////////////////

// titledDiffLink --&gt; titledWikiLink --&gt; generalLink
// wikiLink       --&gt; titledWikiLink --&gt; generalLink
// kateLink --&gt; generalLink

function titledDiffLink(l) { // wp, text, title, from, to) {
    return titledWikiLink({wp: l.wp, action: l.to + '&amp;oldid=' + l.from,
                                  text: l.text, title: l.title,
                                  /* hack: no oldid here */
                                  actionName: 'diff'});
};

function wikiLink(l) {
    //{wp:wp, action:action, text:text, oldid}) {
    var prehint=null;
    if (! (l.wp
           &amp;&amp; typeof l.action == typeof '' &amp;&amp; typeof l.text==typeof '')) return null;
    if (typeof l.oldid == 'undefined') l.oldid=null;
    if (l.action!='edit' &amp;&amp; l.action!='view' &amp;&amp; l.action != 'revert') l.oldid=null;
    switch (l.action) {
    case 'edit':             prehint = 'Edit ';                 break;
    case 'history':          prehint = 'Show history for ';     break;
    case 'unwatch':          prehint = 'Stop watching ';        break;
    case 'watch':            prehint = 'Watch ';                break;
    case 'view':             prehint = 'Go to ';                break;
    case 'unprotect':        prehint = 'Unprotect ';            break;
    case 'protect':          prehint = 'Protect ';              break;
    case 'delete':           prehint = 'Delete ';               break;
    case 'edit&amp;section=new': prehint = 'Start a new topic on '; break;
    case 'revert':           prehint = 'Revert to ';
        // TODO: show the timestamp and username of revert target
        l.action='edit&amp;autoclick=wpSave&amp;autosummary=' + $util.printf(getValueOf('popupRevertSummary'), l.oldid);
        break;
    // case 'nullEdit':         prehint = 'Make a null edit to ';
    //     l.action='edit&amp;autoclick=wpSave&amp;autosummary=null';
    //     break;
    }


  var hint;
  if (prehint != null) {
    if (l.oldid) prehint += 'revision '+l.oldid +' of ';
    hint=prehint + l.wp.page;
  }
  else hint = (l.wp.page + '&amp;action=' + l.action
               + (l.oldid) ? '&amp;oldid='+l.oldid : '');

  return titledWikiLink({wp: l.wp, action: l.action, text: l.text,
                                title: hint, oldid: l.oldid});
};


var defaultNavlinkClassname='popupNavLink';

function titledWikiLink(l) {
    // possible properties of argument:
    // wp, action, text, title, oldid, actionName, className
    // oldid = null is fine here

    // wp and action are mandatory args
    if (!l.wp || typeof l.action=='undefined') return null;
    var base = l.wp.qurl;
    var url=base;

    if (typeof l.actionName=='undefined' || !l.actionName) l.actionName='action';

    // no need to add &amp;action=view, and this confuses anchors
    if (l.action != 'view') url = base + '&amp;' + l.actionName + '=' + l.action;

    if (typeof l.oldid!='undefined' &amp;&amp; l.oldid) url+='&amp;oldid='+l.oldid;

    var cssClass=defaultNavlinkClassname;
    if (typeof l.className!='undefined' &amp;&amp; l.className) cssClass=l.className;

    return generalLink({url: url,
                               title: (typeof l.title != 'undefined') ? l.title : null,
                               newWin: getValueOf('popupNewWindows'),
                               className: cssClass,
                               text: (typeof l.text!='undefined')?l.text:null});
};

function specialLink(l) {
  // properties: wp, specialpage, text, sep
  if (typeof l.specialpage=='undefined'||!l.specialpage) return null;
  var base = 'http://'+WikiPage.server+'/w/index.php?title=' + $wikins.Special+':'+l.specialpage;
  if (typeof l.sep == 'undefined' || l.sep===null) l.sep='&amp;target=';
  var wp = l.wp;
  var prehint=null;
  var user = false;
  switch (l.specialpage) {
  case 'Whatlinkshere':       prehint='Show articles which link to ';                                  break;
  case 'Recentchangeslinked': prehint='Show changes in articles related to ';                          break;
  case 'Contributions':       prehint='Show contributions made by '; user=true;                        break;
  case 'Emailuser':           prehint='Email '; user=true;                                             break;
  case 'Blockip':             prehint='Block '; user=true;                                             break;
  case 'Ipblocklist':         prehint='Unblock '; user=true;                                           break;
  case 'Movepage':            prehint='Move '; user=true;                                              break;
  case 'Undelete':            prehint='Show deletion history for ';                                    break;
  case 'Log':                 prehint=(l.sep=='&amp;user=')?'Show log for ' : 'Block log for '; user=true; break;
  case 'Prefixindex':         prehint='Show the userspace pages of '; user=true;                       break;
  case 'Search':              prehint='Search for ';                                                   break;
  default: prehint=l.specialpage+':'; break;
  }
  var url = base + l.sep + (user ? wp.relevantUser : wp.page);
  var hint = prehint + wp.page;

  return generalLink({url: url, title: hint, text: l.text,
                             newWin: getValueOf('popupNewWindows'),
                             className: 'popupNavLink'});
};

function generalLink(l) {
    // l.url, l.text, l.title, l.newWin, l.className

    if (typeof l.url=='undefined') return null;

    // only quotation marks in the url can screw us up now... I think
    var url=l.url.split('&quot;').join('%22');

    var ret='&lt;a href=&quot;' + url + '&quot;';
    if (typeof l.title!='undefined' &amp;&amp; l.title) ret += ' title=&quot;' + l.title + '&quot;';
    if (typeof l.newWin!='undefined' &amp;&amp; l.newWin) ret += ' target=&quot;_blank&quot;';
    if (typeof l.className!='undefined'&amp;&amp;l.className) ret+=' class=&quot;'+l.className+'&quot;';
    ret += '&gt;';
    if (typeof l.text==typeof '') ret+= l.text;
    ret +='&lt;/a&gt;';
    return ret;
}

function literalizeRegex(str){
  return str.replace(RegExp('([-.()\\+?*^${}\\[\\]])', 'g'), '\\$1');
};

function appendParamsToLink(linkstr, params) {
  var sp=linkstr.parenSplit(RegExp('(href=&quot;[^&quot;]+?)&quot;', 'i'));
  if (sp.length&lt;2) return null;
  var ret=sp.shift() + sp.shift();
  ret += '&amp;' + params + '&quot;';
  ret += sp.join('');
 return ret;
};

$popups._reUpperOrLower = function(c) {
    return '[' + c.toUpperCase() + c.toLowerCase() + ']';
}

$popups.Popup.prototype.redirLink = function(wpRedirTarget) {
    var ret='';

    if (getValueOf('popupAppendRedirNavLinks') &amp;&amp; getValueOf('popupNavLinks')) {
        ret += '&lt;hr/&gt;';
        if (getValueOf('popupFixRedirs')) {
            ret += addPopupShortcut(
                (
                    // TODO: this will be much cleaner once we're manipulating DOM elements
                    '&lt;a href=&quot;javascript:$linkedit.editRedirectBypass(wikiPage,' +
                    $util.stringQuoteEscape(this.wp.page) + ', ' +
                    $util.stringQuoteEscape(wpRedirTarget.page) + ')&quot;' +
                    ' class=' + $util.stringQuoteEscape(defaultNavlinkClassname) +
                    ' title=&quot;Bypass redirect&quot;&gt;Redirects&lt;/a&gt;') ,
                'R');
            ret += ' to ';
        } else {
            ret += 'Redirects to ';
        }

        this.fillEmptySpans({redir: wpRedirTarget});
        return ret;
    } else {
        return ('&lt;br/&gt; Redirects to ' +
                titledWikiLink({wp: wpRedirTarget, action: 'view',
                                text: wpRedirTarget.page, title: 'Bypass redirect'}));
    }
};

function kateLink(l) {
    if (!l.wp || typeof l.text != typeof '') return null;
    var uN = l.wp.relevantUser;
    if (!uN || isIpUser(uN) || ! WikiPage.wikimediaWikiP) return null;

    var newWin='';
    if (getValueOf('popupNewWindows')) newWin=' target=&quot;_blank&quot;';

    return generalLink({url:$editcount.interiotLink(uN),
                               title: 'Count the countributions made by '+uN,
                               newWin: getValueOf('popupNewWindows'),
                               className: defaultNavlinkClassname,
                               text: l.text});
};

function globalSearchLink(l) {
    if (!l.wp || typeof l.text != typeof '') return null;

    var newWin='';
    if (getValueOf('popupNewWindows')) newWin=' target=&quot;_blank&quot;';

    var base='http://vs.aka-online.de/cgi-bin/globalwpsearch.pl?timeout=120&amp;search=';

    return generalLink({url:base + l.wp.pageQuoted,
                               title: 'Search all wikipedias for '+l.wp.page,
                               newWin: getValueOf('popupNewWindows'),
                               className: defaultNavlinkClassname,
                               text: l.text});
};


////////////////////////////
// MANIPULATION FUNCTIONS //
////////////////////////////

function listLinks(wikitext, wpOrigTarget) {
    // $popups.debug(&quot;## listLinks: origTarget=&quot;+origTarget);

    var links = $wikiparse.getLinks(wikitext);

    // ^[a-z]+ should match interwiki links, hopefully (case-sensitive) and
    // ^[a-z]* should match those and [[:Category...]] style links too
    // TODO: improve this
    var omitRegex=RegExp('^[a-z]*:|^[Ss]pecial:|^[Ii]mage|^[Cc]ategory');

    var ret = [];
    for (var i in links) {
        var link = links[i];
        if (omitRegex.test(link)) continue;
        ret.push(
            // TODO: this will be much cleaner once we're manipulating DOM elements
            '&lt;a href=&quot;javascript:$linkedit.editLinkDisambig(wikiPage,' +
            $util.stringQuoteEscape(wpOrigTarget.page) + ', ' +
            $util.stringQuoteEscape(link) + ')&quot;' +
            ' class=' + $util.stringQuoteEscape(defaultNavlinkClassname) +
            ' title=' + $util.stringQuoteEscape(&quot;Disambiguate this link to [[&quot;+link+&quot;]]&quot;) + '&gt;' +
            link.replace(/ /g,'&amp;nbsp;') +
            '&lt;/a&gt;');
    }

    ret.push(
        // TODO: this will be much cleaner once we're manipulating DOM elements
        '&lt;a href=&quot;javascript:$linkedit.editLinkDisambig(wikiPage,' +
        $util.stringQuoteEscape(wpOrigTarget.page) + ', ' +
        'null' + ')&quot;' +
        ' class=' + $util.stringQuoteEscape(defaultNavlinkClassname) +
        ' title=' + $util.stringQuoteEscape(&quot;Remove all links to this disambig page from this article&quot;) + '&gt;' +
        'remove&amp;nbsp;this&amp;nbsp;link' +
        '&lt;/a&gt;');

    return ret;

};

function makeFixDab(data, wpOrigTarget) {
    var list=listLinks(data, wpOrigTarget);
    if (list.length==0) return null;
    var html='&lt;hr/&gt;Disambiguate this link to:&lt;br/&gt;' + list.join(', ');
    return html;
};

$popups._plural = function(num, pl, sing) {
    if (num == 1) return num + '&amp;nbsp;' + sing;
    else return num + '&amp;nbsp;' + pl;
}

function formatBytes(num) {
    return (num &gt; 949) ? (Math.round(num/100)/10+'kB') : (num +'&amp;nbsp;bytes') ;
};

function popupFilterStubDetect(download) {
    return ($wikiparse.isStub(download.data)) ? 'stub' : '';
};

function popupFilterDisambigDetect(download) {
    if ($wikiparse.isDisambig(download.wp, download.data)) return 'disambig';
};

function popupFilterPageSize(download) {
    return formatBytes(download.data.length);
};

function popupFilterCountLinks(download) {
    return $popups._plural($wikiparse.countLinks(download.data), 'wikiLinks', 'wikiLink');
};

function popupFilterCountImages(download) {
    return $popups._plural($wikiparse.countImages(download.data), 'images', 'image');
};

function popupFilterCountCategories(download) {
    return $popups._plural($wikiparse.countCategories(download.data), 'categories', 'category');
};

function popupFilterLastModified(download) {
    if (!download.lastModified) return null;

    var age = (new Date()) - download.lastModified;
    return ($datetime.formatAge(age) + ' old').replace(/ /g, '&amp;nbsp;');
}

var popupFilters=[popupFilterStubDetect,popupFilterDisambigDetect,popupFilterPageSize,popupFilterCountLinks,
                  popupFilterCountImages,popupFilterCountCategories,popupFilterLastModified];

if (typeof extraPopupFilters=='undefined') { var extraPopupFilters=new Array(); }

$popups.getPageInfo = function(download) {
    if (!download || download.data == null) {
        return $popups.error(&quot;error 8c099fa4-d6f7-4b15-a431-61a494436aec&quot;);
    }
    if (!download.data) return 'Empty page';

    var pageInfoArray = [];
    var i,s;
    for (i=0; i&lt;     popupFilters.length; ++i) {s=     popupFilters[i](download);if (s) pageInfoArray.push(s);}
    for (i=0; i&lt;extraPopupFilters.length; ++i) {s=extraPopupFilters[i](download);if (s) pageInfoArray.push(s);}

    return $util.capitalizeFirstChar(pageInfoArray.join(', '));
};

/////////////
// ACTIONS //
/////////////

$popups.Popup.prototype.loadImage = function(filename)
{
    this.debug('loadImage(' + filename + ')');
    var popup = this;
    var cb = function(filename, img) {
        if (typeof window.$popups == 'undefined') return; // unloaded

        popup.debug('loadImage(' + filename + ') =&gt; img=' + (img&amp;&amp;img.src));

        var popupImage = document.getElementById(&quot;popupImg&quot;+popup.popupId);

        if (!popupImage || typeof popupImage.src == 'undefined') {
            popup.debug('loadImage(' + filename + '): no popupImage div!');
            return;
        }

        if (img) {
            // success
            // popup.setImageStatus('');
            popupImage.src = img.src;
            popupImage.width = popupImageSize;
            popupImage.style.display = 'inline';
            this.setPopupImageLink(img, img.wiki);
        } else {
            // failure
            // popup.setImageStatus(' :-(');
        }
    }
    $wikiimg.downloadImage(filename, cb);
}

function findThis(array, value) {
  if (typeof array.length == 'undefined') return null;
  for (var i=0; i&lt;array.length; ++i) {
    if (array[i]==value) return i;
  }
  return null;
};

// this has to use a timer loop as we don't know if the DOM element exists
// when we want to set the text
$popups.Popup.prototype.setPopupHTML = function (str, elementId, onSuccess) {
    this.debug('.setPopupHTML(): ' + 'elementId='+elementId + ', str='+$util.strAbbrev(str,50));
    var popupElement=document.getElementById(elementId+this.popupId);
    var timer;

    if (typeof popupHTMLTimers[elementId] == 'undefined') timer=null;
    else timer=popupHTMLTimers[elementId];

    if (popupElement != null) {
        if(timer) clearInterval(timer);
        popupHTMLTimers[elementId]=null;
        popupElement.innerHTML=str;
        if (onSuccess) onSuccess();
        return true;
    } else {
        // TODO: GET RID OF THIS!!
        // call this function again in a little while...
        var popup = this;
        var loopFunction=function() { popup.setPopupHTML(str,elementId,onSuccess);}
        popupHTMLLoopFunctions[elementId] = loopFunction;
        if (!timer) {
            var doThis = 'popupHTMLLoopFunctions[&quot;'+elementId+'&quot;]()';
            popupHTMLTimers[elementId] = setInterval(doThis, 600);
        }
    }
    return null;
};

// $popups.Popup.prototype.setImageStatus = function(str) = {
//     return this.setPopupHTML(str, 'popupImageStatus');
// };

$popups.Popup.prototype.setPopupTrailer = function(str) {
    return this.setPopupHTML(str, 'popupData');
};

function toggleSize() {
  var imgContainer=this;
  if (!imgContainer) { alert('imgContainer is null :/'); return;}
  img=imgContainer.firstChild;
  if (!img) { alert('img is null :/'); return;}
  if (!img.style.width || img.style.width=='') img.style.width='100%';
  else img.style.width=''; // popupImageSize+'px';
};

$popups.Popup.prototype.setPopupImageLink = function (img, wiki) {
    if( wiki === null || img === null ) return null;

    var a=document.getElementById(&quot;popupImageLink&quot;+this.popupId);
    if (a === null) return null;

    var linkURL = $wikiimg.imageURL(img, wiki);
    if (linkURL != null) {
        if (getValueOf('popupImagesToggleSize')) {
            a.onclick=toggleSize;
            a.title='Toggle image size';
        } else {
            a.href=linkURL;
            a.title='Open full-size image';
        }
    }
    return linkURL;
};

$popups.loaded = false;
$popups.unloaded = false;

$popups.load = function() {
    if ($popups.loaded) {
        $popups.error(&quot;load() called again&quot;);
        return;
    }
    $popups.loaded = true;

    var anchors;

    // article/content is a structure-dependent thing
    if (getValueOf('popupOnlyArticleLinks'))
        anchors = ( document.getElementById('article') ||
                    document.getElementById('content')   ).getElementsByTagName('A');
    else
        anchors = document.getElementsByTagName('A');

    for (var i=0; i&lt;anchors.length; ++i) {
        var a = anchors[i];
        if (a.onclick) continue;
        if (isInToc(a)) continue;
        var h = a.href;
        if (!h) continue;
        if (h.match(/limit=/)) continue;
        var wp = WikiPageRelevant(h, true);
        if (!wp) continue;
        if (wp.nsSpecialP) continue;

        a.wp = wp;
        $popups._setupTooltipLink(a);
        if (getValueOf('removeTitles') &amp;&amp; typeof a.originalTitle=='undefined') {
            a.originalTitle = a.title;
            a.title='';
        }
    }

    // popups for &quot;User&quot; tab
    var tab = document.getElementById('ca-nstab-user');
    if (tab) {
        $popups._setupTooltipLink(tab.getElementsByTagName('a')[0]);
        if (getValueOf('removeTitles')) {
            $util.addOnloadHook(function() {
                                    tab.originalTitle = tab.title;
                                    tab.title = '';
                                    // have to do this to prevent title from
                                    // reappearing on the next akeytt() call (this
                                    // remove the access key itself, just the
                                    // tooltip)
                                    window.ta['ca-nstab-user'] = ['',''];
                                });
        }
    }
};

$popups._setupTooltipLink = function(a) {
    if (!a) return;
    a.onmouseover = $popups.mouseOverWikiLink;
    a.onmouseout = $popups.mouseOutWikiLink;
    a.onclick = $popups.killPopup;
}

$popups.unload = function() {
    $popups.unloaded = true;
    $popups.killPopup();
}



//////////////
// THINGIES //
//////////////

function popupHandleKeypress(evt) {
  var keyCode = evt.keyCode ? evt.keyCode :
    evt.charCode ? evt.charCode : evt.which;
  if (!keyCode || !over) return;
  if (keyCode==27) { // escape
    $popups.killPopup();
    return;
  }

  var letter=String.fromCharCode(keyCode);
  var links=over.getElementsByTagName('A');
  var startLink=0;
  var i,j;

  if (window.lastPopupLinkSelected) {
    for (i=0; i&lt;links.length; ++i) {
      if (links[i]==window.lastPopupLinkSelected) startLink=i;
    }
  }
  for (j=0; j&lt;links.length; ++j) {
    i=(startLink + j + 1) % links.length;
    if (links[i].getAttribute('popupkey')==letter) {
      if (evt.preventDefault) evt.preventDefault();
      links[i].focus();
      window.lastPopupLinkSelected=links[i];
      break;
    }
  }
};

function addPopupShortcuts() {
  if (document.onkeypress==popupHandleKeypress) return;
  document.oldPopupOnkeypress=document.onkeypress;
  document.onkeypress=popupHandleKeypress;
};

function rmPopupShortcuts() {
  if (String(document.oldPopupOnkeypress)==String(popupHandleKeypress)) {
    // panic
    document.onkeypress=function () {};
    return;
  }
  document.onkeypress=document.oldPopupOnkeypress;
};

// add CSS class to table

function addPopupStylesheetClasses () {
  var tables=over.getElementsByTagName('table');
  tables[0].className='popupBorderTable';
  tables[1].className='popupTable';
  var fonts=over.getElementsByTagName('font');
  fonts[0].className='popupFont';
  fonts[0].id='overFontWrapper';
};

// TODO: get rid of this hook stuff!
$popups._alreadyRegisteredOverlibHooks = false;
$popups._registerOverlibHooks = function() {
  if ($popups._alreadyRegisteredOverlibHooks) return;
  $popups._alreadyRegisteredOverlibHooks = true;

  defaultize('popupMaxWidth');

  if (typeof popupMaxWidth == 'number') {
    window.setmaxwidth = function () {
      over.style.maxWidth = popupMaxWidth+'px';

      // hack for IE
      // see http://www.svendtofte.com/code/max_width_in_ie/
      // who knows if this will work? not me.


      // this seems to be the source of that error.... grr.....
      if (over.style.setExpression) {
        over.style.setExpression('width',
                                 'document.body.clientWidth &gt; '
                                 + popupMaxWidth + ' ? &quot;'
                                 + popupMaxWidth + 'px&quot;: &quot;auto&quot;');
      }
    };
    registerHook(&quot;createPopup&quot;, window.setmaxwidth, FAFTER);
  }

  registerHook('createPopup', function(){ $popups.currentPopup.fillEmptySpans()}, FAFTER);

  if (getValueOf('popupShortcutKeys')) {
    registerHook(&quot;createPopup&quot;, window.addPopupShortcuts, FAFTER);
    registerHook(&quot;hideObject&quot;, window.rmPopupShortcuts, FAFTER);
  }

  if (getValueOf('popupDragging'))
    registerHook(&quot;createPopup&quot;, $popups.makeOverDraggable, FAFTER);

  registerHook(&quot;createPopup&quot;, window.addPopupStylesheetClasses, FAFTER);
};

$popups.makeOverDraggable = function() {
    if (typeof over == 'undefined' || !over) return;
    $drag.makeDraggable(over, null,
                        {
                        pickupCondition: function(e) {
                                // only drag while shift is pressed
                                return e.shiftKey;
                            }
                        });
};

$popups.currentPopup = null;

$popups.currentlyDraggingP = function() {
    return (typeof over != 'undefined' &amp;&amp; over != null
            &amp;&amp; typeof over.dragging != 'undefined' &amp;&amp; over.dragging);
}

$popups.mouseOverWikiLink = function() {
    // if no $popups then we're totally unloaded
    if (typeof window.$popups == 'undefined') return;
    if (!$popups.loaded || $popups.unloaded) return;

    var a = this;

    // TODO: should not generate the HTML until the delay has elapsed,
    // and then popup immediately. Can be a CPU hog otherwise.

    $popups.debug('mouseOverWikiLink: a='+a);

    if ($popups.currentlyDraggingP()) return;
    if ($popups.currentPopup &amp;&amp; $popups.currentPopup.a == a) return;

    $popups.currentPopup = new $popups.Popup(a);
    $popups.currentPopup.startPopup();
}

$popups.Popup.prototype.startPopup = function()
{
    this.debug('.startPopup()');
    this.redirCount = 0;

    if (getValueOf('simplePopups') &amp;&amp; window.popupStructure===null) {
        // reset *default value* of popupStructure
        $popups.debug('simplePopups is true and no popupStructure selected. Defaulting to &quot;original&quot;');
        newOption('popupStructure', &quot;'original'&quot;);
    }

    var html = this.generateHTMLspans();
    this.oldid = oldidFromURL(this.a.href);                 // TODO

    // keep this (or fix other refs)
    defaultize('popupImages');

    // $popups.debug('running overlib now');
    $popups._registerOverlibHooks();

    defaultize('popupInitialWidth');
    if (typeof popupInitialWidth == typeof 0) {
        $overlib.overlib(html, STICKY, WIDTH, popupInitialWidth,
                         CELLPAD, 5, OFFSETX, 2, OFFSETY, 2,
                         DELAY, getValueOf('popupDelay')*1000);
    } else {
        $overlib.overlib(html, STICKY, WRAP,
                         CELLPAD, 5, OFFSETX, 2, OFFSETY, 2,
                         DELAY, getValueOf('popupDelay')*1000);
    }

    if ($popups.checkPopupPositionTimer) clearInterval($popups.checkPopupPositionTimer);
    $popups.checkPopupPositionTimer=setInterval($popups.checkPopupPosition, 600);

    if (getValueOf('popupLiveOptions')) {
        this.setPopupHTML(popupLiveOptionsHTML(), 'popupLiveOptions',
                     function () { popupToggleShowOptions(true); } );
    }

    if (getValueOf('simplePopups')) return;

    if (getValueOf('popupLinkShowPreview')) return;

    this.showPreview();
};

$popups._anchorContainsImage = function(a) {
    return a.getElementsByTagName('IMG').length &gt; 0;
};

$popups.Popup.prototype.showPreview = function () {
    if (!this.wp) { $popups.error(&quot;showPreview: error bab74883-6615-4db3-8b72-c08f59917bdf&quot;); return; }
    if (!this.a) { $popups.error(&quot;showPreview: error acae3e5d-f872-40af-99f7-935facfbc63c&quot;); return; }

    if (this.wp.nsImageP) {
        if (getValueOf('popupImages') &amp;&amp;
            (getValueOf('imagePopupsForImages') || !$popups._anchorContainsImage(this.a) ))
        {
            this.loadImage(this.wp.article);
        }
    } else {
        this.loadPreviewImage(this.wp, this.oldid);
    }

    var s = document.getElementById('popupLinkShowPreview' + this.popupId);
    if (s &amp;&amp; s.style) {
        s.style.display='none';
    }
};


$popups.Popup.prototype.loadPreviewImage = function(wp, oldid) {
    var popup = this;

    this.debug('.loadPreviewImage(): wikipage='+wp.page + ', oldid='+oldid);

    $download.downloadUrl($popups._makeRawDownloadUrl(wp, oldid),
                          function(d) {
                              popup.insertPreviewImage(wp, oldid, d);
                          });
};

$popups.Popup.prototype.loadPreviewImageFromRedir = function(redirPage, redirTarget) {
    this.debug('.loadPreviewImageFromRedir(): redirCount='+this.redirCount + ', redirPage=' + redirPage, ', redirTarget=' + redirTarget);
    this.redirCount ++;
    var wpTarget = WikiPage(null,redirTarget);
    var warnRedir = this.redirLink(wpTarget);

    this.setPopupHTML(warnRedir, 'popupWarnRedir');

    return this.loadPreviewImage(wpTarget);
};

// TODO: wp
$popups.Popup.prototype.makeFixDabs = function(wikiText, wpOrigTarget)
{
    // this.debug('.makeFixDabs(): origTarget='+origTarget);
    if (getValueOf('popupFixDabs') &amp;&amp; $wikiparse.isDisambig(this.wp,wikiText) &amp;&amp;
        !wikiPage.nsSpecialP &amp;&amp;
        this.wp.editableP)
    {
        this.setPopupHTML(makeFixDab(wikiText, wpOrigTarget), 'popupFixDab');
    }
}

$popups.Popup.prototype.insertPreviewImage = function(wp, oldid, download) {
    this.debug('.insertPreviewImage(): redirCount='+this.redirCount +
               ', download.data = ' + $util.describeCharCount(download.data==null));

    var wikiText = download.data;
    if (wikiText == null) {
        // TODO: download failed
        return;
    }

    if (this.redirCount==0) {
        var redir = $wikiparse.isRedirect(wikiText);
        if (redir) {
            this.loadPreviewImageFromRedir(wp.page, redir);
            return;
        }
    }

    this.makeFixDabs(wikiText, this.wp);

    if (getValueOf('popupSummaryData')) {
        download.wp = wp;
        var pgInfo = $popups.getPageInfo(download);
        this.setPopupTrailer('&lt;br/&gt;' + pgInfo);
    }

    defaultize('popupMinImageWidth');
    var wpImage = $wikiparse.getValidImageFromWikiText(wikiText, popupMinImageWidth);
    if (wpImage &amp;&amp; wpImage.nsImageP) {
        this.loadImage(wpImage.article);
    }

    if (getValueOf('popupPreviews') &amp;&amp; wikiText) {
        this.insertPopupPreview(wikiText);
    }
};

$popups.Popup.prototype.insertPopupPreview = function(wikiText)
{
    this.debug('.insertPopupPreview(' + $util.describeCharCount(wikiText) + ')');
    if ( this.wp.nsTemplateP ) {
        // TODO: once we write this using DOM it'll be much more
        // efficient to just use createTextNode directly instead of
        // $util.escapeHTML
        var h='&lt;hr/&gt;&lt;tt&gt;' + $util.escapeHTML(wikiText) + '&lt;/tt&gt;';
        this.setPopupHTML(h, 'popupPreview');
        // TODO     getValueOf('popupSubpopups') ? function() { pop.runOnce( popTips, 250 ); } : null );
    } else {
        var html = $instaviewtiny.makePreview(wikiText.substring(0,10000));
        if (html) {
            this.setPopupHTML('&lt;hr/&gt;'+html, 'popupPreview');
        }
    }
}


function fuzzyCursorOffMenus(fuzz) {
  if(!over) return null;
  var spans=over.getElementsByTagName('span');
  for (var i=0; i&lt;spans.length; ++i) {
    if (typeof spans[i].className != 'undefined' &amp;&amp; spans[i].className=='popup_menu') {
      if (!fuzzyCursorOffDiv(fuzz, spans[i])) return false;
    } // else {document.title+='.';}
  }
  return true;
};

function fuzzyCursorOffDiv(fuzz, div) {
  // $popups.debug('fuzzyCursorOffDiv: mouse (x,y)=('+o3_x+',' + o3_y+')');
  var left=findPosX(div)-fuzz;
  var top=findPosY(div) - fuzz;
  var right=left + div.offsetWidth + 2*fuzz;
  var height=0;
  for (var i=0; i&lt;div.childNodes.length;++i) {
    // $popups.debug('adding child '+div.childNodes[i]+'.offsetHeight: '+div.childNodes[i].offsetHeight);
    if (typeof div.childNodes[i].offsetHeight==typeof 1)
      height+=div.childNodes[i].offsetHeight;
  }
  var bottom = top + height + 2*fuzz;
  // $popups.debug(left+'-&gt;'+right+' , '+top+'-&gt;'+bottom);
  //document.title+=' offsetHeight:'+div.offsetHeight;
  if (typeof left != 'number' || typeof right != 'number' || typeof top != 'number') return true;
  if (o3_x &lt; left || o3_x &gt; right || o3_y &lt; top) // || o3_y &gt; bottom) // FIXME: should check the bottom too
    return true;
  return false;
};

// TODO: don't do this as a timer; just set it right the first time; and run
// it when content changes.  otherwise it also interacts poorly with dragging.

// TODO: stop it from running off bottom!
$popups.checkPopupPosition = function () { // stop the popup running off the right of the screen
  if (typeof over == 'undefined' || !over) return null;
  var x=findPosX(over);
  var w=parseInt(over.offsetWidth);
  if ( (x+w) &gt;= document.body.clientWidth ) {
    // for what I am about to do, may the Lord forgive me
    over.style.left=0;
    var ww=parseInt(over.offsetWidth);
    over.style.left=(document.body.clientWidth-ww-1)+'px';
  }
  /*
  var y=findPosY(over);
  var h=parseInt(over.offsetHeight);
  var winH=window.innerHeight + window.pageYOffset;
  document.title=[y,h,winH].join(',');
  if ( h &lt; winH &amp;&amp; (y+h) &gt;= winH ) {
    over.style.top=0;
    var hh=parseInt(over.offsetHeight);
    document.title+=','+hh;
    over.style.top=(winH-hh-24)+'px';
  }
  */
  return true;
};


function findPosX(obj)
{
    var curleft = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curleft += obj.offsetLeft
            obj = obj.offsetParent;
        }
    }
    else if (obj.x)
        curleft += obj.x;
    return curleft;
}

function findPosY(obj)
{
    var curtop = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curtop += obj.offsetTop
            obj = obj.offsetParent;
        }
    }
    else if (obj.y)
        curtop += obj.y;
    return curtop;
}


function fuzzyCursorOffOver(fuzz) {
  if (!over) return null;
  var left = parseInt(over.style.left);
  var top = parseInt(over.style.top);
  var right = left +
    (over.offsetWidth &gt;= parseInt(o3_width) ? over.offsetWidth : parseInt(o3_width));
  var bottom = top +
    (over.offsetHeight &gt;= o3_aboveheight ? over.offsetHeight : o3_aboveheight);

  if (o3_x &lt; left-fuzz || o3_x &gt; right+fuzz || o3_y &lt; top-fuzz || o3_y &gt; bottom + fuzz)
   return true;
  return false;
};

window.fuzzyCursorOff=function(fuzz) {
  return fuzzyCursorOffOver(fuzz) &amp;&amp; fuzzyCursorOffMenus(fuzz);
}

// seems that fuzzyCursorOff should precede mouseOutWikiLink in the source
// or sometimes during page loads, errors are generated

var stopPopupTimer=null;

$popups.mouseOutWikiLink = function () {
    // TODO: cleanup
    if (typeof window.$popups == 'undefined') return;
    if (!$popups.loaded || $popups.unloaded) return;
    if ($popups.currentlyDraggingP()) return;
    if (fuzzyCursorOff(5)) {
        if (window.stopPopupTimer) {
            clearInterval(window.stopPopupTimer);
            window.stopPopupTimer=null;
        }
        $popups.killPopup();
        return;
    }
    if (!window.stopPopupTimer)
        window.stopPopupTimer=setInterval($popups.mouseOutWikiLink, 500);
};

$popups.killPopup = function() {
    // TODO: this is currently used to close a single popup  through regular
    // mouseout as well as total unload abort.  factor this.
    // TODO: don't actually &quot;kill&quot; popups on mouse out, just hide

    // o3_showingsticky should be defined in overlib.js
    //if ( typeof o3_showingsticky != &quot;undefined&quot; &amp;&amp; o3_showingsticky == 0 ) {
    if (getValueOf('popupShortcutKeys')) rmPopupShortcuts();
    if (window.over) {
        cClick(); // hide overlay
    }
    $popups.currentPopup = null;
    // $downloads.abortAllDownloads();
    $wikiimg.abortAllDownloads();
    if ($popups.checkPopupPositionTimer) { clearInterval($popups.checkPopupPositionTimer); }
    return true; // preserve default action (eg from onclick)
};

$util.addOnloadHook($popups.load);
$util.addOnunloadHook($popups.unload);

/****************************************************************************
 * END popups.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN picturepopups.js
 ****************************************************************************/

// $Id: picturepopups.js 1143 2006-02-23 09:36:43Z quarl $

// picture popups - clicking on an image shows a popup.

// originally based on
// http://en.wikipedia.org/wiki/User:Zocky/PicturePopups.js

var $picturepopups = new Module('picturepopups.js');
$picturepopups.depend('picturepopups.css');
$picturepopups.depend('util.js', 'notes.js');

$picturepopups.notes = {};

// Handle clicks on images
$picturepopups.onImageClick = function(e)
{
    // loaded yet?
    if (! (document.getElementById('content')||
           document.getElementById('article'))) return;

    if (e.ctrlKey || e.shiftKey || !$util.eventLeftButtonP(e)) return;
    if (!(e.target &amp;&amp;
          e.target.tagName &amp;&amp;
          e.target.tagName.toUpperCase() == 'IMG'))
    {
        return;
    }

    var t=e.target;
    while (t.parentNode &amp;&amp; t.tagName!='A') { t=t.parentNode; }

    if (!t.href) return;
    var wp = WikiPage(t.href);
    if (!wp.url) return;

    var note = $picturepopups[wp.page];
    if (note) {
        note.toggleShow();
    } else {
        $picturepopups[wp.page] = $picturepopups.showImageNote(wp);
    }

    e.preventDefault();
}

$picturepopups.load = function() {
    // adding this hook in an onload hook helps prevent the user from clicking
    // before we're ready
    $util.hookEventObj(document, 'click', $picturepopups.onImageClick);
};
$util.addOnloadHook($picturepopups.load);

$picturepopups.showImageNote = function(wp) {
    var note = new $notes.Note({
        x: Math.round(Math.random()*200),
        y: Math.round(Math.random()*200),
        title: '[&lt;a href=&quot;'+wp.url+'&quot;&gt; &amp;gt; &lt;/a&gt;] '+wp.article,
        content:'&lt;blink&gt;&lt;small&gt;&lt;i&gt;loading...&lt;/i&gt;&lt;/small&gt;&lt;/blink&gt;',
        className: 'note-picturepopup'
        });

    note.contentCell.addEventListener('click',$picturepopups.noteContentClick,true);

    $util.asyncDownloadXML(wp.url, $picturepopups._imgLoaded, null, note);
    return note;
}

// Stop popup images from linking to hi-res pages
$picturepopups.noteContentClick = function(e)
{
    if (e.target.tagName &amp;&amp; e.target.tagName.toUpperCase()=='IMG') {
        e.preventDefault();
    }
}

$picturepopups._imgLoaded = function(req, note) {
    if (!note) {
        $picturepopups.error(&quot;_loaded(): no note?! (error 7f66ea29-8cb9-41cb-aada-3a9769a33d26)&quot;);
        return;
    }

    var contentCell = note.contentCell;

    if (req.status == 200) {
        var file = $util.findDescendantById(req.responseXML,'file');
        if (!file) {
            contentCell.innerHTML = &quot;Failed. &lt;a&gt;retry&lt;/a&gt;&quot;;
            return;
        }
        contentCell.innerHTML = '';
        contentCell.appendChild(file);
        var license = $util.findDescendantById(req.responseXML,'imageLicense');
        if (license) {
            contentCell.appendChild(license);
        }
    } else {
        contentCell.innerHTML == req.statusText;
        alert(req.statusText);
    }
}

/****************************************************************************
 * END picturepopups.js
 ****************************************************************************/

/****************************************************************************
 * BEGIN instapreview.js
 ****************************************************************************/

// $Id: instapreview.js 967 2006-02-22 08:56:49Z quarl $

// Instapreview -- adds &quot;InstaView&quot; button to edit pages.

// factored from instaview.js.  Uses CSS; fixes autoedit.js compatibility bug.

var $instapreview = new Module('instapreview.js');
$instapreview.depend('instaview.js', 'util.js', 'wikipage.js');
$instapreview.depend('instapreview.css');

// embed InstaView in MediaWiki's edit page
$instapreview.widgetLoad_ = function() {
    if (wikiDoc.editingP) {
        var wpPreview = document.getElementById('wpPreview');

        $instapreview.dumpdiv = document.createElement('div');
        $instapreview.dumpdiv.id = 'instapreviewDump'; // (see CSS)

        var instapreviewButton = document.createElement('input');

        instapreviewButton.setAttribute('type', 'button');
        // instapreviewButton.setAttribute('style', 'font-style: italic');
        instapreviewButton.type = 'button';
        instapreviewButton.value = 'InstaView';
        instapreviewButton.onclick = function() {
            $instaview.dump(document.getElementById('wpTextbox1'), $instapreview.dumpdiv)};

        $util.addNodeBefore(wpPreview, instapreviewButton);
        $util.addNodeAfter(wpPreview.parentNode, $instapreview.dumpdiv);
        // note: don't use &quot;innerHTML +=&quot; because that resets any existing
        // onclick handlers
    }
};

$instapreview.widgetLoad = function() {
    $util.addOnloadHook($instapreview.widgetLoad_);
}

/****************************************************************************
 * END instapreview.js
 ****************************************************************************/
</pre><div class="printfooter">
Retrieved from "<a href="http://en.wikipedia.org../../../a/d/r/User%7EAdrian_combined.js_17fc.html">http://en.wikipedia.org../../../a/d/r/User%7EAdrian_combined.js_17fc.html</a>"</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-user"
	       class="selected"	       ><a href="../../../a/d/r/User%7EAdrian_combined.js_17fc.html">User page</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../a/d/r/User_talk%7EAdrian_combined.js_cfcb.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://en.wikipedia.org/wiki/User:Adrian/combined.js">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../images/wiki-en.png);"
	    href="../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-Main-page"><a href="../../../index.html">Main page</a></li>
	     	      <li id="n-Contents"><a href="../../../c/o/n/Wikipedia%7EContents_3181.html">Contents</a></li>
	     	      <li id="n-Featured-content"><a href="../../../f/e/a/Wikipedia%7EFeatured_content_24ba.html">Featured content</a></li>
	     	      <li id="n-currentevents"><a href="../../../c/u/r/Portal%7ECurrent_events_bb60.html">Current events</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-interaction'>
	  <h5>interaction</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-About-Wikipedia"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html">About Wikipedia</a></li>
	     	      <li id="n-portal"><a href="../../../c/o/m/Wikipedia%7ECommunity_Portal_6a3c.html">Community portal</a></li>
	     	      <li id="n-contact"><a href="../../../c/o/n/Wikipedia%7EContact_us_afd6.html">Contact us</a></li>
	     	      <li id="n-sitesupport"><a href="http://wikimediafoundation.org/wiki/Fundraising">Make a donation</a></li>
	     	      <li id="n-help"><a href="../../../c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="http://wikimediafoundation.org/"><img src="../../../images/wikimedia-button.png" border="0" alt="Wikimedia Foundation"/></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 04:59, 26 February 2006 by Wikipedia user <a href="../../../a/d/r/User%7EAdrian_9077.html" title="User:Adrian">Adrian</a>. </li>	  <li id="f-copyright">All text is available under the terms of the <a class='internal' href="../../../t/e/x/Wikipedia%7EText_of_the_GNU_Free_Documentation_License_702a.html" title="Wikipedia:Text of the GNU Free Documentation License">GNU Free Documentation License</a>. (See <b><a class='internal' href="../../../c/o/p/Wikipedia%7ECopyrights_92c4.html" title="Wikipedia:Copyrights">Copyrights</a></b> for details.) <br /> Wikipedia&reg; is a registered trademark of the <a href="http://www.wikimediafoundation.org">Wikimedia Foundation, Inc</a>., a US-registered <a class='internal' href="../../../5/0/1/501%28c%29.html#501.28c.29.283.29" title="501(c)(3)">501(c)(3)</a> <a href="http://wikimediafoundation.org/wiki/Deductibility_of_donations">tax-deductible</a> <a class='internal' href="../../../n/o/n/Non-profit_organization.html" title="Non-profit organization">nonprofit</a> <a href="../../../c/h/a/Charitable_organization.html" title="Charitable organization">charity</a>.<br /></li>	  <li id="f-about"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html" title="Wikipedia:About">About Wikipedia</a></li>	  <li id="f-disclaimer"><a href="../../../g/e/n/Wikipedia%7EGeneral_disclaimer_3e44.html" title="Wikipedia:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
