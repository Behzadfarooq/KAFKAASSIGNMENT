<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    		<meta name="keywords" content="User:Appleboy/monobook.js,Blocking policy,Bypass your cache,Village pump (technical)" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="/w/opensearch_desc.php" title="Wikipedia (English)" />
		<link rel="copyright" href="../../../COPYING.html" />
    <title>User:Appleboy/monobook.js - Wikipedia, the free encyclopedia</title>
    <style type="text/css">/*<![CDATA[*/ @import "../../../skins/htmldump/main.css"; /*]]>*/</style>
    <link rel="stylesheet" type="text/css" media="print" href="../../../skins/common/commonPrint.css" />
    <!--[if lt IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE50Fixes.css";</style><![endif]-->
    <!--[if IE 5.5000]><style type="text/css">@import "../../../skins/monobook/IE55Fixes.css";</style><![endif]-->
    <!--[if IE 6]><style type="text/css">@import "../../../skins/monobook/IE60Fixes.css";</style><![endif]-->
    <!--[if IE]><script type="text/javascript" src="../../../skins/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]-->
    <script type="text/javascript" src="../../../skins/common/wikibits.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/md5.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/utf8.js"></script>
    <script type="text/javascript" src="../../../skins/htmldump/lookup.js"></script>
    <script type="text/javascript" src="../../../raw/gen.js"></script>        <style type="text/css">/*<![CDATA[*/
@import "../../../raw/MediaWiki%7ECommon.css";
@import "../../../raw/MediaWiki%7EMonobook.css";
@import "../../../raw/gen.css";
/*]]>*/</style>          </head>
  <body
    class="ns-2">
    <div id="globalWrapper">
      <div id="column-content">
	<div id="content">
	  <a name="top" id="contentTop"></a>
	        <h1 class="firstHeading">User:Appleboy/monobook.js</h1>
	  <div id="bodyContent">
	    <h3 id="siteSub">From Wikipedia, the free encyclopedia</h3>
	    <div id="contentSub"><span class="subpages">&lt; <a href="../../../a/p/p/User%7EAppleboy_7cf8.html" title="User:Appleboy">User:Appleboy</a></span></div>
	    	    	    <!-- start content -->
	    <p><span id="clearyourcache"><b>Note:</b> After saving, you have to <a href="../../../b/y/p/Wikipedia%7EBypass_your_cache_1dae.html" title="Wikipedia:Bypass your cache">bypass your browser's cache</a> to see the changes. <b>Firefox/Mozilla/Safari:</b> hold down <i>Shift</i> while clicking <i>Reload</i> (or press <i>Ctrl-Shift-R</i>), <b>Internet Explorer:</b> press <i>Ctrl-F5</i>, <b>Opera/Konqueror:</b> press <i>F5</i>. 
</p>
<div style="color:darkred;background-color:#EEEEEE;border: darkred 2px solid;padding:5px;" id="jswarning"><div style="clear: both;color:darkred;"></div><b><div style="display:block;">If a message on your talk page led you here, please be wary of who left it.  The code below could contain malicious content capable of compromising your account; if your account appears to be compromised, it will be <a href="../../../b/l/o/Wikipedia%7EBlocking_policy_2eb0.html" title="Wikipedia:Blocking policy">blocked</a>.  If you are unsure whether the code is safe, you can ask at the appropriate <a href="../../../v/i/l/Wikipedia%7EVillage_pump_%28technical%29_e812.html" title="Wikipedia:Village pump (technical)">village pump</a>.</b></div></div></span>
<pre>/* &lt;nowiki&gt; */

/////////////////////////////////////////////////////////////////////////////////////////////
// -----------------------------------------------------------------------------
// God-like Monobook skin
// (c) 2005 Sam Hocevar &lt;sam@zoy.org&gt;
// $Id: godmode-light.js 907 2005-06-28 12:57:06Z sam $
// -----------------------------------------------------------------------------
// Modified to use test-n, test2-n and test3-n. Remember to put the article title in the tag.
// See [[User:Drini]] for information on the -n templates.
// 2005-09-02 Modified VfD functions to reference new AfD pages.

//Sam's godmode-light.
// -----------------------------------------------------------------------------
// God-like Monobook skin
// (c) 2005 Sam Hocevar &lt;sam@zoy.org&gt;
// $Id: godmode-light.js 911 2005-08-09 10:06:39Z sam $
// -----------------------------------------------------------------------------

// -----------------------------------------------------------------------------
// Language support, taken from phase3/languages/*
// -----------------------------------------------------------------------------
var rollbacklink = 'rollback';
var cantrollback = 'Cannot revert edit; last contributor is only author of this page.';
var alreadyrolled = 'Cannot rollback last edit of [[$1]] by [[User:$2|$2]] ([[User talk:$2|Talk]]); someone else has edited or rolled back the page already. Last edit was by [[User:$3|$3]] ([[User talk:$3|Talk]]). ';
var revertpage = 'Reverted edits by [[Special:Contributions/$2|$2]] to last version by $1';
switch (document.getElementsByTagName('html')[0].lang) {
}

// -----------------------------------------------------------------------------
// XMLHttpRequest support
// -----------------------------------------------------------------------------
if (document.implementation.createDocument) {
  var xmlparser = new DOMParser();
}

function XMLParse(string) {
  if (document.implementation.createDocument) {
    return xmlparser.parseFromString(string, &quot;text/xml&quot;);
  } else if (window.ActiveXObject) {
    var xmldoc = new ActiveXObject(&quot;Microsoft.XMLDOM&quot;);
    xmldoc.async = &quot;false&quot;;
    ret = xmldoc.loadXML(string);      
    if (!ret)
      return null;
    return xmldoc.documentElement;
  }
  return null;
}

var xmlhttp;

function HTTPClient() {
  var http;
  if(window.XMLHttpRequest) {
    http = new XMLHttpRequest();
  } else if (window.ActiveXObject) {
    try {
      http = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
    } catch (e) {
      try {
        http = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
      } catch (E) {
        http = false;
      }
    }
  }
  return http;
}

// -----------------------------------------------------------------------------
// MD5 hash calculator
// -----------------------------------------------------------------------------
// Version 2.1 Copyright (C) Paul Johnston 1999 - 2002.
// Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
// Distributed under the BSD License
// See http://pajhome.org.uk/crypt/md5 for more info.
// -----------------------------------------------------------------------------
var hexcase = 0;
var b64pad  = &quot;&quot;;
var chrsz   = 8;

function hex_md5(s){ return binl2hex(core_md5(str2binl(s), s.length * chrsz));}

function core_md5(x, len)
{
  x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((len) % 32);
  x[(((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14] = len;

  var a =  1732584193;
  var b = -271733879;
  var c = -1732584194;
  var d =  271733878;

  for(var i = 0; i &lt; x.length; i += 16)
  {
    var olda = a;
    var oldb = b;
    var oldc = c;
    var oldd = d;

    a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936); d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586); c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819); b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330); a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897); d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426); c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341); b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983); a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416); d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417); c = md5_ff(c, d, a, b, x[i+10], 17, -42063); b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162); a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682); d = md5_ff(d, a, b, c, x[i+13], 12, -40341101); c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290); b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);

    a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510); d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632); c = md5_gg(c, d, a, b, x[i+11], 14,  643717713); b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302); a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691); d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083); c = md5_gg(c, d, a, b, x[i+15], 14, -660478335); b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848); a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438); d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690); c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961); b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501); a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467); d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784); c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473); b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);

    a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558); d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463); c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562); b = md5_hh(b, c, d, a, x[i+14], 23, -35309556); a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060); d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353); c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632); b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640); a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174); d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222); c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979); b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189); a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487); d = md5_hh(d, a, b, c, x[i+12], 11, -421815835); c = md5_hh(c, d, a, b, x[i+15], 16,  530742520); b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);

    a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844); d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415); c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905); b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055); a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571); d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606); c = md5_ii(c, d, a, b, x[i+10], 15, -1051523); b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799); a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359); d = md5_ii(d, a, b, c, x[i+15], 10, -30611744); c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380); b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649); a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070); d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379); c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259); b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);

    a = safe_add(a, olda);
    b = safe_add(b, oldb);
    c = safe_add(c, oldc);
    d = safe_add(d, oldd);
  }
  return Array(a, b, c, d);

}

function md5_cmn(q, a, b, x, s, t) { return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b); }
function md5_ff(a, b, c, d, x, s, t) { return md5_cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t); }
function md5_gg(a, b, c, d, x, s, t) { return md5_cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t); }
function md5_hh(a, b, c, d, x, s, t) { return md5_cmn(b ^ c ^ d, a, b, x, s, t); }
function md5_ii(a, b, c, d, x, s, t) { return md5_cmn(c ^ (b | (~d)), a, b, x, s, t); }

function safe_add(x, y)
{
  var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
  var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
  return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
}

function bit_rol(num, cnt)
{
  return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));
}

function str2binl(str)
{
  var bin = Array();
  var mask = (1 &lt;&lt; chrsz) - 1;
  for(var i = 0; i &lt; str.length * chrsz; i += chrsz)
    bin[i&gt;&gt;5] |= (str.charCodeAt(i / chrsz) &amp; mask) &lt;&lt; (i%32);
  return bin;
}

function binl2hex(binarray)
{
  var hex_tab = hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;
  var str = &quot;&quot;;
  for(var i = 0; i &lt; binarray.length * 4; i++)
  {
    str += hex_tab.charAt((binarray[i&gt;&gt;2] &gt;&gt; ((i%4)*8+4)) &amp; 0xF) +
           hex_tab.charAt((binarray[i&gt;&gt;2] &gt;&gt; ((i%4)*8  )) &amp; 0xF);
  }
  return str;
}

// -----------------------------------------------------------------------------
// Our nice Revert functions
// -----------------------------------------------------------------------------
var gml_vandal, gml_editor, gml_url;

function PerformRevert() {
  var l, token = '', revert = false;
  // Look for '&amp;fakeaction=rollback' in URL
  gml_url = location.pathname;
  l = location.search.substring(1).split('&amp;');
  for (i = 0; i &lt; l.length; i++) {
    var n = l[i].indexOf('=');
    var name = l[i].substring(0, n);
    if (name == 'fakeaction') {
      if (l[i].substring(n + 1) == 'rollback')
        revert = true;
    } else if (name == 'vandal') {
      gml_vandal = unescape(l[i].substring(n + 1));
    } else if (name == 'token') {
      token = unescape(l[i].substring(n + 1));
    } else if (name == 'title') {
      gml_url += '?' + l[i];
    }
  }
  if (!revert)
    return;
  document.getElementById('bodyContent').innerHTML = 'Please wait, reverting edits by ' + gml_vandal + '...';
  // Avoid XSS kiddies by using a special token
  if (token == '' || token != hex_md5(gml_url + gml_vandal + document.cookie)) {
    document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Bad authentication token!';
    return;
  }

  xmlhttp = HTTPClient();
  if (!xmlhttp)
    return;
  document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Getting article history...';
  xmlhttp.open(&quot;GET&quot;, gml_url + '&amp;action=history&amp;limit=50', true);
  xmlhttp.onreadystatechange = RevertStepTwo;
  xmlhttp.send(null);
}

function RevertStepTwo() {
  if (xmlhttp.readyState != 4)
    return
  var l;
  var oldid;
  // Get the vandal and new editor names
  gml_editor = '';
  doc = XMLParse(xmlhttp.responseText);
  l = doc.getElementById('pagehistory').getElementsByTagName('li');
  //l = doc.selectSingleNode('//*[@id=&quot;pagehistory&quot;]').getElementsByTagName('li');
  for (i = 0; i &lt; l.length; i++) {
    var name = l[i].getElementsByTagName('span')[0].getElementsByTagName('a')[0].innerHTML;
    if (i == 0 &amp;&amp; name != gml_vandal) {
      document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Error: ' + gml_vandal + ' is not the last editor!';
      return;
    } else if (i &gt; 0 &amp;&amp; name != gml_vandal) {
      oldid = l[i].getElementsByTagName('input')[0].value;
      gml_editor = name;
      break;
    }
  }
  if (gml_editor == '') {
    document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Error: ' + gml_vandal + ' is the only editor!';
    return;
  }

  xmlhttp = HTTPClient();
  if (!xmlhttp)
    return;
  document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Getting article edit form (GET' + gml_url + '&amp;action=edit&amp;oldid=' + oldid + ')...';
  xmlhttp.open('GET', gml_url + '&amp;action=edit&amp;oldid=' + oldid, true);
  xmlhttp.onreadystatechange = RevertStepThree;
  xmlhttp.send(null);
}

function RevertStepThree() {
  if (xmlhttp.readyState != 4)
    return
  var form, newform, l;
  // Insert the downloaded form in our current page, using
  // only hidden form inputs.
  doc = XMLParse(xmlhttp.responseText);
  form = doc.getElementById('editform');
  newform = document.createElement('form');
  l = form.getElementsByTagName('textarea');
  for (i = l.length; i--; ) {
    var t = document.createElement('input');
    t.type = 'hidden';
    t.name = l[i].name;
    t.value = l[i].innerHTML;
    newform.appendChild(t);
  }
  l = form.getElementsByTagName('input');
  for (i = l.length; i--; ) {
    if (l[i].name == 'wpSummary') {
      l[i].value = revertpage.replace(/\$1/g, gml_editor).replace(/\$2/g, gml_vandal);
    } else if (l[i].name == 'wpMinoredit') {
      l[i].value = '1';
    } else if (l[i].name == 'wpWatchthis') {
      if (!l[i].checked)
        continue; // Donât touch the &quot;watch&quot; status
      l[i].value = &quot;on&quot;;
    } else if (l[i].name == 'wpPreview') {
      continue;
    } else if (l[i].name == 'wpDiff') {
      continue;
    }
    l[i].type = 'hidden';
    newform.appendChild(l[i]);
  }
  newform.name = form.name;
  newform.method = form.method;
  newform.id = form.id;
  newform.action = form.action;
  document.getElementById('bodyContent').innerHTML += '&lt;br /&gt;Submitting form...';
  document.getElementById('bodyContent').appendChild(newform);
  // Submit the form
  newform.submit();
}

// -----------------------------------------------------------------------------
// Add revert buttons to the page
// -----------------------------------------------------------------------------
function AddRevertButtons() {
  var l, article = '', vandal;
  // Add 'revert' links to a diff page
  l = document.getElementById('bodyContent').getElementsByTagName('td');
  for (i = 0; i &lt; l.length; i++) {
    if (l[i].className == 'diff-otitle') {
      article = l[i].getElementsByTagName('a')[0].href.split('&amp;')[0].replace(/[^\/]*\/\/[^\/]*/, '');
    } else if (l[i].className == 'diff-ntitle') {
      var toplink = l[i].getElementsByTagName('a')[0].href;
      vandal = l[i].getElementsByTagName('a')[1].title.split(':')[1];
      var t = l[i].innerHTML
      n = t.indexOf('&lt;/a&gt;) &lt;br') + t.indexOf('&lt;/A&gt;) &lt;BR') + 1; // XXX: WOW HACK!!!!
      if (n &gt;= 0 &amp;&amp; article != '' &amp;&amp; toplink.indexOf('oldid=') == -1) {
        l[i].innerHTML = t.substring(0, n + 5) + ' &amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;strong&gt;[&lt;a href=&quot;' + article + '&amp;fakeaction=rollback&amp;vandal=' + vandal + '&amp;token=' + hex_md5(article + vandal + document.cookie) + '&quot;&gt;' + rollbacklink + '&lt;/a&gt;]&lt;/strong&gt; ' + t.substring(n + 5, t.length);
      }
    }
  }
  // Add 'revert' links to a contributions page
  if (location.href.indexOf(':Contributions') != -1) {
    var c = document.getElementById('contentSub');
    var a = c.getElementsByTagName('a');
    if (a.length == 2) {
      vandal = a[0].innerHTML;
    } else {
      vandal = c.innerHTML.replace(/ \(.*/, '').replace(/.* /, '');
    }
    l = document.getElementById('bodyContent').getElementsByTagName('li');
    for (i = 0; i &lt; l.length; i++) {
      var t = l[i].innerHTML
      // If we are already a sysop on this wiki, abort
      if (t.indexOf('&gt;' + rollbacklink + '&lt;/a&gt;]') != -1)
          break;
      //if (t.indexOf('&amp;amp;diff=0') != -1) {
      if (t.indexOf('&lt;strong&gt; (') != -1) {
        article = l[i].getElementsByTagName('a')[0].href.split('&amp;')[0].replace(/[^\/]*\/\/[^\/]*/, '');
        l[i].innerHTML += ' [&lt;a href=&quot;' + article + '&amp;fakeaction=rollback&amp;vandal=' + vandal + '&amp;token=' + hex_md5(article + vandal + document.cookie) + '&quot;&gt;' + rollbacklink + '&lt;/a&gt;]';
      }
    }
  }
}

// -----------------------------------------------------------------------------
// Modify the page once it is loaded
// -----------------------------------------------------------------------------
if (window.addEventListener) {
  window.addEventListener(&quot;load&quot;, PerformRevert, false);
  window.addEventListener(&quot;load&quot;, AddRevertButtons, false);
} else if (window.attachEvent) {
  window.attachEvent(&quot;onload&quot;, PerformRevert);
  window.attachEvent(&quot;onload&quot;, AddRevertButtons);
}



// [[User:Lupin/popups.js]] -

var popupVersion=&quot;Fri Oct 7 20:30:37 EDT 2005 bugfix(1)&quot;;
// CONTENTS

// Stylesheets

// Utility functions

// Popup stuff
//   global variables 
//   html generation 
//   downloading 
//   link generation 
//   manipulation functions 
//   tests 
//   actions 
//   thingies 


////////////////////////////////////////////////////////////////////
// Import stylesheet(s)
////////////////////////////////////////////////////////////////////

document.write('&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;'  
             + 'http://en.wikipedia.org/w/index.php?title=User:Lupin/menus.css'
             + '&amp;action=raw&amp;ctype=text/css&amp;dontcountme=s&quot;&gt;');

////////////////////////////////////////////////////////////////////
// Utility functions
////////////////////////////////////////////////////////////////////

function time() {
  var d=new Date();
  return d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds() +
    '.' + (d.getTime() % 1000);
};

var gMsg='';
function log(x) { if(gMsg!='')gMsg += '\n'; gMsg+=time() + ' ' + x; };

function myalert(x) { return alert(time()+'\n'+ x); };


////////////////////////////////////////////////////////////////////
// Popup stuff
////////////////////////////////////////////////////////////////////

// livepreview uses a broken hex_md5 function, so we avoid it
function md5_hex(s) { return rstr2hex(rstr_md5(str2rstr_utf8(s))); };

/////////////////////
// GLOBAL VARIABLES //
//////////////////////

var splitLoc=window.location.href.split('/');
var thisWiki=splitLoc[2];
var wikiLang=thisWiki.split('.')[0];

// regexes and so on

// this stuff should be customized for different languages

var popNamespaces = [&quot;Media&quot;, &quot;Special&quot;, &quot;Talk&quot;, &quot;User&quot;, &quot;User talk&quot;, &quot;Wikipedia&quot;, &quot;Wikipedia talk&quot;, &quot;Image&quot;, &quot;Image talk&quot;, &quot;MediaWiki&quot;, &quot;MediaWiki talk&quot;, &quot;Template&quot;, &quot;Template talk&quot;, &quot;Help&quot;, &quot;Help talk&quot;, &quot;Category&quot;, &quot;Category talk&quot;, &quot;Portal&quot;, &quot;Portal talk&quot;];

switch (wikiLang) {
}

var popNamespacesWithTalk=[null]; // NB root (article) corresponds with this entry, null
var popTalkNamespaces=[popNamespaces[2]];

// if the number of namespaces changes then this will have to be changed
// maybe the easiest way is to specify the arrays by hand as in the comments following the loop

for (var i=3; i+1&lt;popNamespaces.length; i=i+2) { 
  popNamespacesWithTalk.push(popNamespaces[i]);
  popTalkNamespaces.push(popNamespaces[i+1]);
}

var popSpecialNamespace=popNamespaces[1];
var popImageNamespace=popNamespaces[7];
var popUserNamespace=popNamespaces[3];
var popCategoryNamespace=[15];
var stubRegex= RegExp('stub[}][}]|This .*-related article is a .*stub', 'im') ;
var disambigRegex=RegExp('([{][{]disambig|disambig[}][}]|dab[}][}])' +
                         '|is a .*disambiguation.*page', 'im') ;

// end of language-specific things


var popContribsPage=popSpecialNamespace+':' + 'Contributions';
var popEmailPage=popSpecialNamespace+':' + 'Emailuser';

var exceptions=RegExp('((title=|/)'+popSpecialNamespace+':|section=[0-9])') ;
var contributions=RegExp('(title=|/)'+popContribsPage+'(&amp;target=|/|/'+
                         popUserNamespace+':)(.*)') ;
var emailuser=    RegExp('(title=|/)'+popEmailPage   +'(&amp;target=|/|/'+
                         popUserNamespace+':)(.*)') ;

//                      (^|\[\[)image: *([^|\]]*[^|\] ]) * 
//                      (^|\[\[)image: *([^|\]]*[^|\] ])([^0-9\]]*([0-9]+) *px)?
//                                                        $4 = 120 as in 120px
var imageRegex= RegExp('(^|\\[\\[)'+
                       popImageNamespace+
                       ': *([^|\\]]*[^|\\] ])([^0-9\\]]*([0-9]+) *px)?',
                       'img') ;
var imageRegexBracketCount = 4;

var categoryRegex= RegExp('\\[\\['+popCategoryNamespace+
                          ': *([^|\\]]*[^|\\] ]) *', 'i') ;
var categoryRegexBracketCount = 1;

var ipUserRegex=RegExp('('+popUserNamespace+':)?' + 
                       '((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}' + 
                       '(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])');

var oldidRegex=RegExp('[?&amp;]oldid=([0-9]*)');

var wikimediaWiki=RegExp('wiki([pm]edia|source|books)\\.org|wiktionary\\.org').test(thisWiki);
var localWiki=RegExp('^localhost').test(thisWiki);
var protocol=splitLoc[0].split(':')[0];

var titletail='/index.php?title=';
if (wikimediaWiki) titletail = '/w' + titletail;
else if (localWiki) titletail = '/wiki' + titletail;



// /REGEX

// we're not set up for interwiki stuff yet - only affect en, commons 
// and wiktionary links

var reStart='[^:]*://';
var preTitles='wiki/|w/index\\.php\\?title=';

if (!wikimediaWiki) {
  preTitles = 'wiki/index\\.php\\?title=|wiki/index\\.php/|'+preTitles
    + '|index\\.php\\?title=' ;
}
var reEnd='/(' + preTitles + ')([^&amp;?]*)';
var re = RegExp(reStart + thisWiki.split('.').join('\\.') + reEnd);

var titlebase=protocol+'://'+thisWiki+titletail;     
var wikibase=protocol+'://'+thisWiki+'/wiki/';

var popupImageSize=60;

var imageSources=new Array ();

var commonsWiki='commons.wikimedia.org';

// frequently seen thumbs
imageSources.push(
   {wiki: thisWiki, thumb: true,  width: 180}, // default
   {wiki: thisWiki, thumb: true,  width: 120} // gallery
 );

// frequently seen thumbs on commons
if (wikimediaWiki &amp;&amp; thisWiki!=commonsWiki) {
  imageSources.push(
    {wiki: commonsWiki, thumb: true,  width: 180},
    {wiki: commonsWiki, thumb: true,  width: 120}
  );
}

// unusual thumb sizes and full-size
imageSources.push(
   {wiki: thisWiki, thumb: true,  width: 200}, // common?
   {wiki: thisWiki, thumb: true,  width: 250}, // common?
   {wiki: thisWiki, thumb: true,  width: 300},
   {wiki: thisWiki, thumb: true,  width: 210},
   {wiki: thisWiki, thumb: true,  width: 230},
   {wiki: thisWiki, thumb: false, width: 0} // no comma
);

// full-size on commons
if (wikimediaWiki &amp;&amp; thisWiki!=commonsWiki) {
  imageSources.push({wiki: commonsWiki, thumb: false, width: 0});
}

// downloading images are put here
var imageArray=new Array();

// page caching
var gCachedPages = new Array ();
var gImageCache = new Array();
  
// FIXME what is this for?
var gImage=null; // global for image

// check to see if images are done with this timer
var popupImageTimer=null;

// misc debug messages
var popupDebug=null;

// These are for checkImages()
var counter=0;
var checkImagesTimer=null;
var checkPoupPositionTimer=null;
var loopcounter=0;

// ids change with each popup: popupImage0, popupImage1 etc
var popupIdNumber=0;

var kateBase='http://kohl.wikimedia.org/~kate/cgi-bin/count_edits?dbname=';
switch(thisWiki) {
 case commonsWiki:          kateBase += 'commonswiki';  break;
 case  'en.wiktionary.org': kateBase += 'enwiktionary';  break;
 default: 
   kateBase += wikiLang+'wiki';
}
kateBase += '&amp;user=';

// for myDecodeURI
var decodeExtras = new Array ();
decodeExtras.push ( 
  {from: '%2C', to: ',' },
  {from: '_',   to: ' ' },
  {from: '%26',   to: '&amp;' } // no ,
);

// for setPopupHTML - needed for timers and stuff
var popupHTMLTimers=new Array();
var popupHTMLLoopFunctions = new Array();

// FIXME - eliminate this
var redirCount=0;

// Cookie handling
// pasted straight from http://www.quirksmode.org/js/cookies.html

function createCookie(name,value,days)
{
  var expires;
  if (days)
    {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      expires = &quot;; expires=&quot;+date.toGMTString();
    }
  else expires = &quot;&quot;;
  document.cookie = name+&quot;=&quot;+value+expires+&quot;; path=/&quot;;
};

function readCookie(name)
{
  var nameEQ = name + &quot;=&quot;;
  var ca = document.cookie.split(';');
  for(var i=0;i &lt; ca.length;i++)
    {
      var c = ca[i];
      while (c.charAt(0)==' ') c = c.substring(1,c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
  return null;
};

function eraseCookie(name)
{
  createCookie(name,&quot;&quot;,-1);
};


// options

// if there's no cookie, this should expand to something like
// if (window.foo===null) window.foo=window.dfoo;
function defaultize(x) {
  var val=null;
  var a='window.'+x;
  var b='window.d'+x;
  if (x!='popupCookies') {
    defaultize('popupCookies');
    if (popupCookies &amp;&amp; (val=readCookie(x))) {
      eval(a + '=' + val + ';');
      return;
    }
  }
  eval('if ('+a+'===null) '+a+'=' + b + ';');
};

// this should expand to something like
// if (typeof window.foo=='undefined') { window.foo=null; }; window.dfoo = 0.5;
function newOption(x, def) {
  var a='window.'  + x;
  var b='window.d' + x;
  eval('if (typeof '+ a + '==\'undefined\') {' + a + '=null; }; ' + b + '=' + def + ';');
};

function getValueOf(varName) {defaultize(varName); return eval(varName);};

// user-settable parameters and defaults
// names beginning with a d are probably a bad idea!
// NB strings must be &quot;'double-quoted'&quot;
newOption('popupDelay', 0.5);
newOption('removeTitles', true);
newOption('imagePopupsForImages', true);
newOption('popupSummaryData', true);
newOption('simplePopups',  false);
newOption('popupAdminLinks',  false);
newOption('popupImages', true);
newOption('popupPreviews', true);
newOption('popupMaxPreviewSentences', 4);
newOption('popupMaxPreviewCharacters', 600);
newOption('popupNavLinks', true);
newOption('popupNavLinkSeparator', &quot;' &amp;sdot; '&quot;);
newOption('popupOnlyArticleLinks', true);
newOption('popupNeverGetThumbs', false);
newOption('popupImagesFromThisWikiOnly', false);
newOption('popupAppendRedirNavLinks', true);
newOption('popupMaxWidth', 300);
newOption('popupSimplifyMainLink', true);
newOption('popupMinImageWidth', 50);
newOption('popupLastEditLink', true);
newOption('popupHistoricalLinks', true);
newOption('popupFixRedirs', true);
newOption('popupLiveOptions', false);
newOption('popupCookies', false);
newOption('popupUnsimplifyLink', false);
newOption('popupLoadImagesSequentially', false);
newOption('popupShortcutKeys', false);
newOption('popupLiveOptionsExpanded', false);
newOption('popupFixDabs', false);
newOption('popupImagesToggleSize',true);
newOption('popupNewWindows', false);
// see later - default for popupStructure is &quot;'original'&quot; if simplePopups is true
newOption('popupStructure', &quot;'menus'&quot;); 
newOption('popupInitialWidth', false); // integer or false
newOption('popupNavLinkStyle', &quot;'default'&quot;);
newOption('popupDragging', true); 
newOption('popupLastModified', true);

// browser-specific hacks

if (typeof window.opera != 'undefined') {
  newOption('popupStructure', &quot;'original'&quot;);
}

if ((self.navigator.appName)=='Konqueror') {
  dpopupNavLinkSeparator=' &amp;bull; ';
} else if ((self.navigator.appName).indexOf(&quot;Microsoft&quot;)!=-1) {
  dpopupNavLinkSeparator=' &amp;#183; ';
}

// String.prototype.parenSplit should do what ECMAscript says 
// String.prototype.split does, interspersing paren matches between
// the split elements

if (String('abc'.split(/(b)/))!='a,b,c') {
  // broken String.split, e.g. konq, IE
  String.prototype.parenSplit=function (re) {
    var m=re.exec(this);
    if (!m) return [this];
    // without the following loop, we have 
    // 'ab'.parenSplit(/a|(b)/) != 'ab'.split(/a|(b)/)
    for(var i=0; i&lt;m.length; ++i) {
      if (typeof m[i]=='undefined') m[i]='';
    }
    return [this.substring(0,m.index)]
      .concat(m.slice(1))
      .concat(this.substring(m.index+m[0].length).parenSplit(re));
  };
} else {
  String.prototype.parenSplit=function (re) {return this.split(re);};
}

/////////////////////
// HTML GENERATION //
/////////////////////

// generate html for popup image
// &lt;a id=&quot;popupImageLinkn&quot;&gt;&lt;img id=&quot;popupImagen&quot;&gt;
// where n=popupIdNumber
function imageHTML(article) {
  var ret='';
  ret += '&lt;a id=&quot;popupImageLink' + popupIdNumber + '&quot;&gt;';
  ret += '&lt;img align=&quot;right&quot; valign=&quot;top&quot; id=&quot;popupImg' + popupIdNumber + '&quot; ' 
    + 'style=&quot;display: none;&quot;&gt;&lt;/img&gt;';
  ret += '&lt;/a&gt;';
  return ret;
};

function isInToc(a) { return isSubElementOf(a,'toc'); };

function isInArticle(a) { 
  // content is for monobook.. damn. was hoping to avoid wikipedia skin references
  if (document.getElementById('article')) return isSubElementOf(a, 'article');
  else return isSubElementOf(a, 'content');
};

function isSubElementOf(a, tag) {
  var obj = a;
  var i=0;
  // this may well slow things down when this function is iterated
  // would perhaps be more efficient to cache this result before the 
  // function is called. or maybe the browser does that magically anyway
  var tagged=document.getElementById(tag);
  if (!tagged) return false;

  do {obj = obj.parentNode; ++i; }
  while (obj != tagged &amp;&amp; obj.nodeName != 'HTML');

  if (obj.nodeName == 'HTML') return false;
  return true;
};

function articleFromURL(h) {
  if (typeof h != 'String') h=String(h);
  h=decodeURI(h);
  var article=null;

  var contribs=contributions.exec(h);
  if (contribs != null) { article=popUserNamespace+':'+contribs[3];  return article;  } 
  
  var email=emailuser.exec(h);
  if (email != null) { article=popUserNamespace+':'+email[3]; return article;  } 

  // no more special cases to check --
  // hopefully it's not a disguised user-related page

  var m=re.exec(h);
  if(m===null) return null;
  article=m[2];
  return article;
};

function articleFromAnchor(a) {return articleFromURL(a.href);};

function oldidFromAnchor(a) { var m=oldidRegex.exec(a.href); if (m) return m[1]; return null; };

function fillEmptySpans(args) { return fillEmptySpans2(args); }

function fillEmptySpans2(args) { // if redir is present and true then redirTarget is mandatory
  var redir=true;
  if (typeof args != 'object' || typeof args.redir == undef || !args.redir) redir=false;
  var a=window.currentLink;
  log('fillEmptySpans: a='+a+', window.currentLink='+window.currentLink);
  if (!a) { log('*****\nfillEmptySpans: a is no good\n*****'); return; }
  
  var article, hint, oldid;
  if (redir &amp;&amp; typeof args.redirTarget == typeof '') {
    article=args.redirTarget; hint=null;
  } else {
    article=articleFromAnchor(a);
    hint=a.originalTitle;
    if (hint == '' || hint == null) hint = safeDecodeURI(article);
    oldid=(getValueOf('popupHistoricalLinks'))?oldidFromAnchor(a):null;
  }
  
  log('fillEmptySpans: redir='+redir+', article='+article);
  var x={article: article,
         hint: hint,
         oldid: oldid };
  
  defaultize('popupStructure');
  var structure=eval('window.popupStructures.'+popupStructure);
  if (typeof structure != 'object') {
    setPopupHTML('popupError', 'Unknown structure: '+ popupStructure);
    return;
  }
  var spans=flatten(window.popupLayout);
  var redirs=window.popupRedirSpans;
  log('fillEmptySpans: spans.length='+spans.length);
  for (var i=0; i&lt;spans.length; ++i) {
    var f=findThis(redirs, spans[i]); 
    log('redir='+redir+', f='+f+', spans[i]='+spans[i]);
    if ( (f!=null &amp;&amp; !redir) || (f==null &amp;&amp; redir) ) {
      log('skipping this set of the loop');
      continue;
    }
    var structurefn=eval('structure.'+spans[i]);
    switch (typeof structurefn) {
    case 'function':
      log('running '+spans[i]+'({article:'+x.article+', hint:'+x.hint+', oldid: '+x.oldid+'})');
      setPopupHTML(structurefn(x), spans[i]);
      break;
    case 'string':
      setPopupHTML(structurefn, spans[i]);
      break;
    default:
      log('unknown thing with label '+spans[i]);
      break;
    }
  }
};

// flatten an array
function flatten(list, start) {
  var ret=[];
  if (typeof start == undef) start=0;
  for (var i=start; i&lt;list.length; ++i) {
    if (typeof list[i] == typeof []) {
      return ret.concat(flatten(list[i])).concat(flatten(list, i+1));
    }
    else ret.push(list[i]);
  }
  return ret;
};


window.popupStructures = new Object;

window.popupStructures.original=new Object;

window.popupStructures.original.popupLayout=function () {
  return ['popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupData', 'popupOtherLinks', 
          'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'], 
          'popupMiscTools', ['popupLiveOptions', 'popupUnsimplify'],  
          'popupPreview', 'popupFixDab'];
};
window.popupStructures.original.popupRedirSpans=function () {
  return ['popupRedir', 'popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'];
};
window.popupStructures.original.popupTitle=function (x) {
  log ('defaultstructure.popupTitle');
  if (!getValueOf('popupNavLinks')) return navlinkStringToHTML('&lt;b&gt;&lt;&lt;mainlink&gt;&gt;&lt;/b&gt;',x.article,x.oldid);
  return '';
};
window.popupStructures.original.popupTopLinks=function (x) {
  log ('defaultstructure.popupTopLinks');
  if (getValueOf('popupNavLinks')) return navLinksHTML(x.article, x.hint, x.oldid);
  return '';
};
window.popupStructures.original.popupImage=function(x) {
  log ('original.popupImage, x.article='+x.article+', popupIdNumber='+popupIdNumber);
  return imageHTML(x.article);
};
window.popupStructures.original.popupUnsimplify=function(x) {
  if (getValueOf('popupUnsimplifyLink')) return '&lt;br&gt;&lt;span onClick=&quot;javascript:popupUnsimplify()&quot; ' 
    + 'style=&quot;cursor:pointer; border: thin dotted black&quot; ' 
    + 'title=&quot;Download preview data from the Wikipedia servers&quot;&gt;' 
    + 'Get preview data' 
    + '&lt;/span&gt;';
  return '';
};
window.popupStructures.original.popupRedirTitle=window.popupStructures.original.popupTitle;
window.popupStructures.original.popupRedirTopLinks=window.popupStructures.original.popupTopLinks;



window.popupStructures.fancy=new Object;
window.popupStructures.fancy.popupTitle=function (x) {
  return navlinkStringToHTML('&lt;font size=+0&gt;&lt;&lt;mainlink&gt;&gt;&lt;/font&gt;',x.article,x.oldid);
};
window.popupStructures.fancy.popupTopLinks=function(x) {
  var hist='&lt;&lt;history|shortcut=h|hist&gt;&gt;|&lt;&lt;lastEdit|shortcut=/|last&gt;&gt;';
  var watch='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m&gt;&gt;';
  return navlinkStringToHTML('if(talk){' 
                            +'&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;new|shortcut=+|+&gt;&gt;*' + hist + '*'
                            +'&lt;&lt;article|shortcut=a|article&gt;&gt;|&lt;&lt;editArticle|edit&gt;&gt;' + '*' + watch + '*' + move
                            +'}else{&lt;&lt;edit|shortcut=e&gt;&gt;*' + hist 
                            +'*&lt;&lt;talk|shortcut=t&gt;&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;'
                            +'*' + watch + '*' + move+'}&lt;br&gt;', x.article, x.oldid);
};
window.popupStructures.fancy.popupOtherLinks=function(x) {
  var admin='&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d|del&gt;&gt;';
  var user='&lt;&lt;contribs|shortcut=c&gt;&gt;';
  if (wikimediaWiki) user+='if(ipuser){}else{|&lt;&lt;count|shortcut=#|#&gt;&gt;}';
  user+='if(ipuser){}else{*&lt;&lt;email|shortcut=E&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}';

  var normal='&lt;&lt;whatLinksHere|shortcut=l|links here&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r|related&gt;&gt;';
  return navlinkStringToHTML('&lt;br&gt;if(user){' + user + '*}if(admin){'+admin+'if(user){&lt;br&gt;}else{*}}'
            +normal, x.article, x.oldid);
};
window.popupStructures.fancy.popupLayout=window.popupStructures.original.popupLayout;
window.popupStructures.fancy.popupImage=window.popupStructures.original.popupImage;
window.popupStructures.fancy.popupRedirSpans=window.popupStructures.original.popupRedirSpans;
window.popupStructures.fancy.popupUnsimplify=window.popupStructures.original.popupUnsimplify;

window.popupStructures.fancy.popupRedirTitle=window.popupStructures.fancy.popupTitle;
window.popupStructures.fancy.popupRedirTopLinks=window.popupStructures.fancy.popupTopLinks;
window.popupStructures.fancy.popupRedirOtherLinks=window.popupStructures.fancy.popupOtherLinks;


window.popupStructures.menus=new Object;
window.popupStructures.menus.popupLayout=function () {
  return ['popupError', 'popupImage', 'popupTopLinks', 'popupTitle', 'popupOtherLinks', 
          'popupRedir', ['popupWarnRedir', 'popupRedirTopLinks', 'popupRedirTitle', 'popupRedirData', 'popupRedirOtherLinks'], 
          'popupData', 'popupMiscTools', ['popupLiveOptions', 'popupUnsimplify'],  
          'popupPreview', 'popupFixDab'];
};
window.popupStructures.menus.popupImage=window.popupStructures.original.popupImage;
window.popupStructures.menus.popupUnsimplify=window.popupStructures.original.popupUnsimplify;
window.popupStructures.menus.popupRedirSpans=window.popupStructures.original.popupRedirSpans;

window.popupStructures.menus.popupTopLinks = function (x) {
  var s='';
  var hist='&lt;&lt;history|shortcut=h&gt;&gt;';
  var lastedit='&lt;&lt;lastEdit|shortcut=/|show last edit&gt;&gt;';
  var linkshere='&lt;&lt;whatLinksHere|shortcut=l|what links here&gt;&gt;';
  var related='&lt;&lt;relatedChanges|shortcut=r|related changes&gt;&gt;';
  var watch='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';
  var protect='&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;';
  var del='&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;';
  var move='&lt;&lt;move|shortcut=m|move page&gt;&gt;';
  var dropdiv='&lt;div class=&quot;popup_drop&quot;&gt;';
  var menuspan='&lt;span class=&quot;popup_menu&quot;&gt;';
  var rowspan='&lt;span class=&quot;popup_menu_row&quot;&gt;';
  var enddiv='&lt;/div&gt;';
  var endspan='&lt;/span&gt;';
  s+= dropdiv + '&lt;&lt;mainlink&gt;&gt;' 
        + menuspan 
        + 'if(oldid){'+rowspan+'&lt;&lt;edit|shortcut=e&gt;&gt;|&lt;&lt;editOld|shortcut=e|this&amp;nbsp;revision&gt;&gt;' + endspan 
        + '}else{&lt;&lt;edit|shortcut=e&gt;&gt;}'       
        + 'if(talk){&lt;&lt;new|shortcut=+|new topic&gt;&gt;}' 
        + hist + lastedit + move 
        + linkshere + related
        + '&lt;hr&gt;'
        + rowspan + watch + endspan
        + 'if(admin){' + rowspan + protect + endspan + rowspan + del + endspan + '}'
        + 'if(talk){'
        + '&lt;hr&gt;' 
        + '&lt;&lt;article|shortcut=a|view article&gt;&gt;'
        + '&lt;&lt;editArticle|edit article&gt;&gt;'  
        + '}else{'
        + '&lt;hr&gt;' 
        + '&lt;&lt;talk|shortcut=t|talk page&gt;&gt;'
        + '&lt;&lt;editTalk|edit talk&gt;&gt;' 
        + '&lt;&lt;newTalk|shortcut=+|new topic&gt;&gt;' 
        + '}'
        + endspan
  + enddiv;
  s+='if(user){*' + dropdiv + '&lt;a href=&quot;#&quot;&gt;user&lt;/a&gt;' + menuspan
        + rowspan + '&lt;&lt;userPage|shortcut=u|user page&gt;&gt;|&lt;&lt;userSpace|shortcut=s|space&gt;&gt;' + endspan
        + '&lt;&lt;userTalk|shortcut=t|user talk&gt;&gt;'
        + '&lt;&lt;editUserTalk|edit user talk&gt;&gt;'
        + '&lt;&lt;newUserTalk|shortcut=+|leave comment&gt;&gt;' 
        + 'if(ipuser){}else{&lt;&lt;email|shortcut=E|email user&gt;&gt;}'
        + '&lt;hr&gt;'
        + '&lt;&lt;contribs|shortcut=c|contributions&gt;&gt;' 
        + '&lt;&lt;userlog|shortcut=L|user log&gt;&gt;'
        + ((wikimediaWiki)?'&lt;&lt;count|shortcut=#|edit counter&gt;&gt;':'')
        + 'if(admin){' + rowspan + '&lt;&lt;unblock|un&gt;&gt;|&lt;&lt;block|shortcut=b|block user&gt;&gt;' + endspan +'}'
        + '&lt;&lt;blocklog|shortcut=B|block log&gt;&gt;'
        + endspan + enddiv
        + '}';
  return navlinkStringToHTML(s, x.article, x.oldid);
};

window.popupStructures.menus.popupRedirTitle=window.popupStructures.menus.popupTitle;
window.popupStructures.menus.popupRedirTopLinks=window.popupStructures.menus.popupTopLinks;


// Generate html for whole popup
function popupHTML (a) {
  defaultize('popupStructure');
  var structure=eval('window.popupStructures.'+popupStructure);
  if (typeof structure != 'object') return 'Unknown structure: '+popupStructure;
  if (typeof structure.popupLayout != 'function') return 'Bad layout';
  window.popupLayout=structure.popupLayout();
  if (typeof structure.popupRedirSpans == 'function') window.popupRedirSpans=structure.popupRedirSpans();
  else window.popupRedirSpans=[];
  return makeEmptySpans(window.popupLayout);
}; 

function makeEmptySpans (list) {
  var ret='';
  for (var i=0; i&lt;list.length; ++i) {
    if (typeof list[i] == typeof '')
      ret += emptySpanHTML(list[i], popupIdNumber);
    else if (typeof list[i] == typeof [] ) {
      ret = ret.substring(0,ret.length-'&lt;/span&gt;'.length) + makeEmptySpans(list[i]) + '&lt;/span&gt;';
    }
  }
  return ret;
};

function popupUnsimplify() {};

function isIpUser(user) {return ipUserRegex.test(user);};

function popupToggleVar(varstring) {
  defaultize(varstring);
  eval('window.'+varstring+'=!window.' + varstring);
  defaultize('popupCookies');
  if (popupCookies) createCookie(varstring, String(eval(varstring)));
};

function popupToggleShowOptions (dummy) {
  // just update state if dummy is true
  defaultize('popupLiveOptionsExpanded');
  if (!dummy) window.popupLiveOptionsExpanded=!window.popupLiveOptionsExpanded;
  setPopupHTML((window.popupLiveOptionsExpanded) ? '&amp;lt;&amp;lt;' : '&amp;gt;&amp;gt;',
               'optionPopped');
  var s=document.getElementById('popupOptionsDiv');
  // if (!s) return;
  if (window.popupLiveOptionsExpanded) s.style.display='inline';
  else s.style.display='none';
};

function popupOptionsCheckboxHTML(varstring, label, title) {
  var html='&lt;br&gt;';
  html += '&lt;span title=&quot;'+title+'&quot;&gt;';
  html += '&lt;input type=&quot;checkbox&quot; id=&quot;'+varstring+'Checkbox&quot; ';
  html += (eval(varstring)) ? 'checked=&quot;checked&quot; ' : '';
  html += 'onClick=&quot;javascript:popupToggleVar(' + &quot;'&quot; + varstring + &quot;'&quot; + 
    ')&quot;&gt;' + label + '&lt;/input&gt;&lt;/span&gt;';
  return html;
};

function popupLiveOptionsHTML() {
  var html = '';
  html += '&lt;br&gt;';
  html += '&lt;span title=&quot;Show/hide options&quot; ';
  html += 'style=&quot;border: thin dotted black; cursor: pointer&quot; ';
  html += 'onClick=&quot;javascript:popupToggleShowOptions()&quot;&gt;';
  html += 'Options &lt;span id=&quot;optionPopped' + popupIdNumber + '&quot;&gt;&lt;/span&gt;';
  html += '&lt;/span&gt;';
  html += '&lt;div style=&quot;display: none&quot; id=&quot;popupOptionsDiv&quot;&gt;';
  html += popupOptionsCheckboxHTML('simplePopups', 'Simple popups', 
               'Never download extra stuff for images/previews');
  html += popupOptionsCheckboxHTML('popupUnsimplifyLink', 'Preview only on click', 
               'Only start downloading when told to do so');
  //html += popupOptionsCheckboxHTML('popupCookies', 'cookies', 
  //             'Use cookies to store popups options');
  html += popupOptionsCheckboxHTML('popupNavLinks', 'Show navigation links', 
               'Display navigation links at the top of the popup');
  html += popupOptionsCheckboxHTML('popupImages', 'Show image previews', 
               'Load images');
  html += popupOptionsCheckboxHTML('popupSummaryData', 'Show summary data', 
               'Show page summary data');
  html += popupOptionsCheckboxHTML('popupPreviews', 'Show text previews', 
               'Show previews');
    
  var extraOptions=[
                    'imagePopupsForImages',
                    'popupAdminLinks',
                    'popupAppendRedirNavLinks',
                    'popupCookies',
                    'popupFixDabs',
                    'popupFixRedirs',
                    'popupHistoricalLinks',
                    'popupImagesFromThisWikiOnly',
                    'popupImagesToggleSize',
                    'popupLastEditLink',
                    'popupLiveOptions',
                    'popupLoadImagesSequentially',
                    'popupNeverGetThumbs',
                    'popupOnlyArticleLinks',
                    'popupShortcutKeys',
                    'popupSimplifyMainLink',
                    'removeTitles' // no ,
  ];
  for (var i=0; i&lt;extraOptions.length; ++i) {
    html += popupOptionsCheckboxHTML(extraOptions[i], extraOptions[i], 'Toggle this option');
  }
  
  html += '&lt;/div&gt;';
  return html;
};

function emptySpanHTML(name, id) {return '&lt;span id=&quot;' + name + id + '&quot;&gt;&lt;/span&gt;';};

function addLinkProperty(html, property) {
  // take &quot;&lt;a href=...&gt;...&lt;/a&gt; and add a property
  // not sophisticated at all, easily broken
  var i=html.indexOf('&gt;');
  if (i&lt;0) return html;
  return html.substring(0,i) + ' ' + property + html.substring(i);
};

function addPopupShortcut(html, key) {
  if (!getValueOf('popupShortcutKeys')) return html;
  var ret= addLinkProperty(html, 'popupkey=&quot;'+key+'&quot;');
  if (key==' ') key='space';
  return ret.replace(RegExp('^(.*?)(title=&quot;)(.*?)(&quot;.*)$', 'i'),'$1$2$3 ['+key+']$4');
};

function crypticNavlinkSpec() {
  if (typeof popupNavLinkSeparator==undef) window.dpopupNavLinkSeparator=window.dpopupNavLinkSeparator.split(' ').join('');
  var str= '&lt;b&gt;&lt;&lt;mainlink|shortcut= &gt;&gt;&lt;/b&gt;&lt;&lt;imagestatus&gt;&gt;if(admin){&lt;br&gt;}else{*}if(user){&lt;&lt;contribs|shortcut=c|c&gt;&gt;' +
    'if(ipuser){}else{|&lt;&lt;email|shortcut=E|e&gt;&gt;}';
  if (wikimediaWiki) str += 'if(ipuser){}else{|&lt;&lt;count|shortcut=#|#&gt;&gt;}';
  str+='if(admin){|&lt;&lt;block|shortcut=b|b&gt;&gt;}*}if(talk){if(oldid){&lt;&lt;editOld|shortcut=e|e&gt;&gt;|&lt;&lt;edit|c&gt;&gt;*}else{&lt;&lt;edit|shortcut=e|e&gt;&gt;}|&lt;&lt;new|shortcut=+|+&gt;&gt;*&lt;&lt;history|shortcut=h|h&gt;&gt;*&lt;&lt;unwatch|un|u&gt;&gt;/&lt;&lt;watch|shortcut=w|w&gt;&gt;*&lt;b&gt;&lt;&lt;article|shortcut=a|a&gt;&gt;&lt;/b&gt;|&lt;&lt;editArticle|edit|e&gt;&gt;}else{if(oldid){&lt;&lt;editOld|shortcut=e|e&gt;&gt;|&lt;&lt;edit|cur|c&gt;&gt;}else{&lt;&lt;edit|shortcut=e|e&gt;&gt;}*&lt;&lt;history|shortcut=h|h&gt;&gt;*&lt;&lt;unwatch|un|u&gt;&gt;/&lt;&lt;watch|shortcut=w|w&gt;&gt;*&lt;b&gt;&lt;&lt;talk|shortcut=t|t&gt;&gt;&lt;/b&gt;|&lt;&lt;editTalk|edit|e&gt;&gt;|&lt;&lt;newTalk|shortcut=+|+&gt;&gt;}*&lt;&lt;whatLinksHere|shortcut=l|l&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r|r&gt;&gt;*&lt;&lt;move|shortcut=m|m&gt;&gt;if(admin){*&lt;&lt;unprotect|un|u&gt;&gt;/&lt;&lt;protect|shortcut=p|p&gt;&gt;*&lt;&lt;undelete|un|u&gt;&gt;/&lt;&lt;delete|shortcut=d|d&gt;&gt;}';

  return str;
};

function defaultNavlinkSpec() {
  var str='';
  str += '&lt;b&gt;&lt;&lt;mainlink|shortcut= &gt;&gt;&lt;/b&gt;';
  if (getValueOf('popupLastEditLink')) str += '*&lt;&lt;lastEdit|shortcut=/&gt;&gt;if(oldid){|&lt;&lt;oldEdit&gt;&gt;|&lt;&lt;diffCur&gt;&gt;}';
  str+='&lt;&lt;imagestatus&gt;&gt;';
  
  // user links
  // contribs - count - email - block
  // count only if applicable; block only if popupAdminLinks
  str += 'if(user){&lt;br&gt;&lt;&lt;contribs|shortcut=c&gt;&gt;';
  if (wikimediaWiki) str+='if(ipuser){}else{*&lt;&lt;count|shortcut=#&gt;&gt;}';
  str+='if(ipuser){}else{*&lt;&lt;email|shortcut=E&gt;&gt;}if(admin){*&lt;&lt;block|shortcut=b&gt;&gt;}}';
  
  // editing links
  // talkpage   -&gt; edit|new - history - un|watch - article|edit 
  // other page -&gt; edit - history - un|watch - talk|edit|new
  var editstr='&lt;&lt;edit|shortcut=e&gt;&gt;';
  var editOldidStr='if(oldid){&lt;&lt;editOld|shortcut=e&gt;&gt;|&lt;&lt;edit|cur&gt;&gt;}else{' + editstr + '}'
  var historystr='&lt;&lt;history|shortcut=h&gt;&gt;';
  var watchstr='&lt;&lt;unwatch|un&gt;&gt;|&lt;&lt;watch|shortcut=w&gt;&gt;';

  str+='&lt;br&gt;if(talk){' + 
    editOldidStr+'|&lt;&lt;new|shortcut=+&gt;&gt;' + '*' + historystr+'*'+watchstr + '*' + '&lt;b&gt;&lt;&lt;article|shortcut=a&gt;&gt;&lt;/b&gt;|&lt;&lt;editArticle|edit&gt;&gt;'
    + '}else{' // not a talk page
    + editOldidStr + '*' + historystr + '*' + watchstr + '*' + '&lt;b&gt;&lt;&lt;talk|shortcut=t&gt;&gt;&lt;/b&gt;|&lt;&lt;editTalk|edit&gt;&gt;|&lt;&lt;newTalk|shortcut=+|new&gt;&gt;'
    + '}';
  
  // misc links
  str += '&lt;br&gt;&lt;&lt;whatLinksHere|shortcut=l&gt;&gt;*&lt;&lt;relatedChanges|shortcut=r&gt;&gt;*&lt;&lt;move|shortcut=m&gt;&gt;';

  // admin links
  str += 'if(admin){&lt;br&gt;&lt;&lt;unprotect|un&gt;&gt;|&lt;&lt;protect|shortcut=p&gt;&gt;*' + '&lt;&lt;undelete|un&gt;&gt;|&lt;&lt;delete|shortcut=d&gt;&gt;}';
  return str;
};

function navLinksHTML (article, hint, oldid) {
  //  defaultize('popupNavLinkSeparator');
  var str = '&lt;span class=&quot;popupNavLinks&quot;&gt;';
  var style=getValueOf('popupNavLinkStyle');
  switch (style) {
  case 'cryptic':
    str += crypticNavlinkSpec();
    break;
  case 'default':
    str += defaultNavlinkSpec();
    break;
  default:
    if (typeof style == 'function') str += style();
    else str+=String(style);
  }
  str += '&lt;/span&gt;';

  // BAM
  return navlinkStringToHTML(str, article, oldid);
};

function reportErrorHTML(err) {
  return 'Error: '+err+ ' Please &lt;a href=&quot;' + 
    'http://en.wikipedia.org/wiki/User_talk:Lupin?action=edit&amp;section=new' + 
    '&quot;&gt;report this&lt;/a&gt;!';
};

function expandConditionalNavlinkString(s,article,oldid,recursionCount) {
  // nested conditionals (up to 10 deep) are ok, hopefully! (work from the inside out)
  if (typeof recursionCount!=typeof 0) recursionCount=0;
  var conditionalSplitRegex=RegExp(
    '(;?\\s*if\\s*\\(\\s*([a-z]*)\\s*\\)\\s*\\{([^{}]*)\\}(\\s*else\\s*\\{([^{}]*?)\\}|))', 'i');
  var splitted=s.parenSplit(conditionalSplitRegex);
  // $1: whole conditional
  // $2: user|talk
  // $3: true expansion
  // $4: else clause (possibly empty)
  // $5: false expansion (possibly null)
  var numParens=5;
  ret = splitted[0];
  for (var i=1; i&lt;splitted.length; i=i+numParens+1) {
    
    var testString=splitted[i+2-1];
    var trueString=splitted[i+3-1];
    var falseString=splitted[i+5-1];
    if (typeof falseString==undef || !falseString) falseString='';
    var testResult=null;

    switch (testString) {
    case 'user':
      testResult=(userName(article))?true:false;
      break;
    case 'talk':
      testResult=(talkPage(article))?false:true; // talkPage converts _articles_ to talkPages
      break;
    case 'admin':
      testResult=getValueOf('popupAdminLinks')?true:false;
      break;
    case 'oldid':
      testResult=(typeof oldid != undef &amp;&amp; oldid)?true:false;
      break;
    case 'ipuser':
      testResult=(isIpUser(userName(article)))?true:false;
      break;
    }

    switch(testResult) {
    case null: ret+=splitted[i];  break;
    case true: ret+=trueString;   break;
    case false: ret+=falseString; break;
    }

    
    // append non-conditional string 
    ret += splitted[i+numParens];
  }
  if (conditionalSplitRegex.test(ret) &amp;&amp; recursionCount &lt; 10) 
    return expandConditionalNavlinkString(ret,article,oldid,recursionCount+1);
  else return ret;
};

function navlinkStringToArray(s, article, oldid) {
  s=expandConditionalNavlinkString(s,article,oldid);
  var splitted=s.parenSplit(RegExp('&lt;&lt;(.*?)&gt;&gt;'));
  var ret=[];
  for (var i=0; i&lt;splitted.length; ++i) {
    if (i%2) { // i odd, so s is a tag
      var t=new navlinkTag();
      var ss=splitted[i].split('|');
      t.id=ss[0];
      for (var j=1; j&lt;ss.length; ++j) {
        var sss=ss[j].split('=');
        if (sss.length&gt;1)
          eval ('t.'+sss[0]+'=&quot;'+sss[1]+'&quot;;');
        else
          t.text=sss[0];
      }
      t.article=article;
      if (typeof oldid != undef &amp;&amp; oldid != null) t.oldid=oldid;
      ret.push(t);
    }
    else { // plain HTML
      ret.push(splitted[i].split('*').join(getValueOf('popupNavLinkSeparator')));
    }
  }
  return ret;
};

// navlinkString: * becomes the separator
//                &lt;&lt;foo|bar=baz|fubar&gt;&gt; becomes a foo-link with attribute bar='baz'
//                                      and visible text 'fubar'
//                if(test){...} and if(test){...}else{...} work too (nested ok)

function navlinkStringToHTML(s,article,oldid) {
  var p=navlinkStringToArray(s,article,oldid);
  var html='';
  for (var i=0; i&lt;p.length; ++i) {
    if (typeof p[i] == typeof '') {
      html+=p[i];
    } else if (typeof p[i].type != undef &amp;&amp; p[i].type=='navlinkTag') {
      html+=p[i].html();
    }
  }
  return html;
}

function navlinkTag() {this.type='navlinkTag';};

navlinkTag.prototype.html=function () {
  this.getPrintFunction();
  var html='';
  if (typeof this.print!='function') {
    log ('Oh dear - invalid print function for a navlinkTag, id='+this.id);
  } else {
    html=this.print(this);
    if (typeof html != typeof '') {html='';}
    else if (typeof this.shortcut!=undef) html=addPopupShortcut(html, this.shortcut);
  }
  return '&lt;span class=&quot;popup_'+this.id+'&quot;&gt;'+html+'&lt;/span&gt;';
};

navlinkTag.prototype.getPrintFunction=function() { //think about this some more
  // this.id and this.article should already be defined
  if (typeof this.id!=typeof '' || typeof this.article!=typeof'') return;
  var html='';
  var a,t;

  switch (this.id) {
  case 'email':     case 'contribs':  case 'block':     case 'unblock':
  case 'userlog':   case 'blocklog':  case 'userSpace':
    this.article=userName(this.article);
  }

  switch (this.id) {
    case 'blocklog': this.article=popUserNamespace+':'+this.article;
  }
  
  switch (this.id) {
  case 'userTalk': case 'newUserTalk': case 'editUserTalk':
  case 'userPage':
    delete this.oldid;
    this.article=popUserNamespace+':'+userName(this.article);
  }

  if (this.id != 'mainlink') {
    this.article=removeAnchor(this.article);
    if (typeof this.text==undef) this.text=this.id;
  }

  switch (this.id) {
  case 'undelete':       this.print=specialLink; this.specialpage='Undelete'; this.sep='/'; break;
  case 'whatLinksHere':  this.print=specialLink; this.specialpage='Whatlinkshere'; break;
  case 'relatedChanges': this.print=specialLink; this.specialpage='Recentchangeslinked'; break;
  case 'move':           this.print=specialLink; this.specialpage='Movepage'; break;

  case 'contribs':       this.print=specialLink; this.specialpage='Contributions'; break;
  case 'email':          this.print=specialLink; this.specialpage='Emailuser'; break;
  case 'block':          this.print=specialLink; this.specialpage='Blockip'; this.sep='&amp;ip='; break;
  case 'unblock':        this.print=specialLink; this.specialpage='Ipblocklist'; this.sep='&amp;action=unblock&amp;ip='; break;
  case 'userlog':        this.print=specialLink; this.specialpage='Log'; this.sep='&amp;user='; break;
  case 'blocklog':       this.print=specialLink; this.specialpage='Log'; this.sep='&amp;type=block&amp;page='; break;
  case 'userSpace':      this.print=specialLink; this.specialpage='Prefixindex'; this.sep='&amp;namespace=2&amp;from='; break;
  case 'history': case 'unwatch': case 'watch':
  case 'unprotect': case 'protect': case 'delete':
    this.print=wikiLink; this.action=this.id; break;

  case 'edit': case 'view':
    this.print=wikiLink;
    delete this.oldid;
    this.action=this.id; break;
  case 'new':
    this.print=wikiLink; this.action='edit&amp;section=new'; break;
  case 'mainlink':
    if (typeof this.text==undef) this.text=safeDecodeURI(this.article);
    if (getValueOf('popupSimplifyMainLink')) { 
      var s=this.text.split('/'); this.text=s[s.length-1]; 
      if (this.text=='' &amp;&amp; s.length &gt; 1) this.text=s[s.length-2];
    }
    this.print=titledWikiLink;
    if (typeof this.title==undef &amp;&amp; window.currentLink &amp;&amp; typeof window.currentLink.href != undef) { 
      this.title=safeDecodeURI((window.currentLink.originalTitle)?window.currentLink.originalTitle:this.article);
      if (typeof this.oldid != undef &amp;&amp; this.oldid) this.title='Revision ' + this.oldid + ' of ' + this.title;
    }
    this.action='view'; break;
  case 'userPage':
  case 'article': 
    a=articleFromTalkPage(this.article); if (a) { this.article=a; delete this.oldid; }
    this.print=wikiLink;
    this.action='view'; break;
  case 'editArticle': 
    a=articleFromTalkPage(this.article); if (a) { this.article=a; delete this.oldid; }
    this.print=wikiLink;
    this.action='edit'; break;
  case 'userTalk':
  case 'talk':
    t=talkPage(this.article); if(t) { this.article=t; delete this.oldid; }
    this.print=wikiLink; 
    this.action='view'; break;
  case 'count':
    this.print=kateLink; break;
  case 'lastEdit':
    this.print=titledDiffLink;
    this.title='Show the last edit';
    this.from='prev'; this.to='cur'; break;
  case 'oldEdit':
    this.print=titledDiffLink;
    this.title='Show the edit made to get revision '+this.oldid;
    this.from='prev'; this.to=this.oldid; break;
  case 'editOld':
    this.print=wikiLink; this.action='edit'; break;
  case 'diffCur':
    this.print=titledDiffLink;
    this.title='Show changes since revision '+ this.oldid;
    this.from=this.oldid; this.to='cur'; break;
  case 'editUserTalk':
  case 'editTalk':
    t=talkPage(this.article); if (t) { this.article=t; delete this.oldid; }
    this.action='edit'; this.print=wikiLink; break;
  case 'newUserTalk':
  case 'newTalk':
    t=talkPage(this.article); if (t) { this.article=t; delete this.oldid; }
    this.action='edit&amp;section=new'; this.print=wikiLink; break;
  case 'imagestatus':
    this.print=function () { return emptySpanHTML('popupImageStatus', popupIdNumber); }
    break;
  default:
    this.print=function () {return 'Unknown navlink type: '+this.id+''};
  }
};


/////////////////
// DOWNLOADING //
/////////////////

//////////////
//
// downloader
//

function downloader(url) {
  // Source: http://jibbering.com/2002/4/httprequest.html
  this.http = false;

  /*@cc_on @*/
  /*@if (@_jscript_version &gt;= 5)
  // JScript gives us Conditional compilation, 
  // we can cope with old IE versions.
  // and security blocked creation of the objects.
  try {
  this.http = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);
  } catch (e) {
  try {
  this.http = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
  } catch (E) {
  // this.http = false;
  }
  }
  @end @*/

  if (! this.http &amp;&amp; typeof XMLHttpRequest!='undefined') this.http = new XMLHttpRequest();

  this.url = url; this.id=null;
  this.lastModified = null;
  this.callbackFunction = null;
};

new downloader();

downloader.prototype.send = function (x) {if (!this.http) return null; return this.http.send(x);};
downloader.prototype.abort = function () {if (!this.http) return null; return this.http.abort();};
downloader.prototype.runCallback = function () {this.callbackFunction(this);};
downloader.prototype.getData = function () {if(!this.http) return null; return this.http.responseText;};
downloader.prototype.setTarget = function () {if(!this.http) return null; this.http.open(&quot;GET&quot;, this.url, true);};
downloader.prototype.start=function () {if(!this.http) return null; return this.http.send(null);};
downloader.prototype.getReadyState=function () {if(!this.http) return null; return this.http.readyState;};

downloader.prototype.getLastModifiedDate=function () {
  if(!this.http) return null; 
  var lastmod=null;
  try {
    lastmod=this.http.getResponseHeader('Last-Modified'); 
  } catch (err) {}
  if (lastmod) return new Date(lastmod);
  return null;
}

downloader.prototype.setCallback = function (f) { 
  if(!this.http) return;
  this.http.onreadystatechange = f;
  this.callbackFunction = f;
};


function newDownload(url, id, callback) {
  var d=new downloader(url);
  if (!d.http) return 'ohdear';
  d.id=id;
  d.setTarget();
  var f = function () {
    if (d.getReadyState() == 4) { 
      d.data=d.getData(); 
      d.lastModified=d.getLastModifiedDate();
      callback(d);
    }
  };
  d.setCallback(f);
  return d;//d.start();
};

function fakeDownload(url, id, callback, data, lastModified) {
  var d=newDownload(url,callback);
  d.id=id; d.data=data;
  d.lastModified=lastModified;
  return callback(d);
};

function startDownload(url, id, callback) {
  var d=newDownload(url, id, callback); 
  if (typeof d == typeof '' ) return d;
  return d.start();
};

//
// downloader
//
//////////////


// Schematic for a getWiki call
//
//   getWiki-&gt;-getPageWithCaching
//                    |
//       false        |          true
// getPage&lt;-[findPictureInCache]-&gt;-onComplete(a fake download)
//   \.
//     (async)-&gt;addPageToCache(download)-&gt;-onComplete(download)

function getWiki(wikipage, onComplete, oldid) {
  log('getWiki, wikipage='+wikipage);
  // set global variable (ugh) to holdwikipage
  window.currentArticle=wikipage;

  // set ctype=text/css to get around opera bug
  var url = titlebase + removeAnchor(wikipage) + '&amp;action=raw&amp;ctype=text/css';
  if (oldid!=null &amp;&amp; oldid!='') url += '&amp;oldid='+oldid;
  return getPageWithCaching(url, onComplete);
};

// check cache to see if page exists

function getPageWithCaching(url, onComplete) {
  log('getPageWithCaching, url='+url);
  var i=findInPageCache(url);
  if (i &gt; -1) return fakeDownload(url, popupIdNumber, onComplete, gCachedPages[i].data, gCachedPages[i].lastModified);
  return getPage(url, onComplete);
};

function getPage(url, onComplete) {
  log('getPage');
  var callback= function (d) {addPageToCache(d); onComplete(d) };
  return startDownload(url, popupIdNumber, callback);
};

function findInPageCache(url) {
  for (var i=0; i&lt;gCachedPages.length; ++i) if (url==gCachedPages[i].url) return i;
  return -1; 
};

function cachedPage (url, data, lastModified) {this.url=url; this.data=data; this.lastModified=lastModified};

function addPageToCache(download) {
  log('addPageToCache '+download.url);
  var page = new cachedPage(download.url, download.data, download.lastModified);
  return gCachedPages.push(page);
};

/*
  var gCurrentDownload = null;

  function abortCurrentDownload(download) {
  if (gCurrentDownload) {
  try { gCurrentDownload.abort(); }
  catch (anerror) {return 'could not abort download object';}
  }
  return true;
  }
*/


/////////////////////
// LINK GENERATION //
/////////////////////

// titledDiffLink --&gt; titledWikiLink --&gt; generalLink
// wikiLink       --&gt; titledWikiLink --&gt; generalLink
// kateLink --&gt; generalLink

function titledDiffLink(l) { // article, text, title, from, to) {
  return titledWikiLink({article: l.article, action: l.to + '&amp;oldid=' + l.from, 
                                    text: l.text, title: l.title, 
                                    /* hack: no oldid here */ 
                                    actionName: 'diff'});
};

function wikiLink(l) { 
  //{article:article, action:action, text:text, oldid}) {
  var prehint=null;
  if (! (typeof l.article == typeof '' 
         &amp;&amp; typeof l.action == typeof '' &amp;&amp; typeof l.text==typeof '')) return null;
  if (typeof l.oldid == undef) l.oldid=null;
  switch (l.action) {
  case 'edit':             prehint = 'Edit ';                 break;
  case 'history':          prehint = 'Show history for ';     break;
  case 'unwatch':          prehint = 'Stop watching ';        break;
  case 'watch':            prehint = 'Watch ';                break;
  case 'view':             prehint = 'Go to ';                break;
  case 'unprotect':        prehint = 'Unprotect ';            break;
  case 'protect':          prehint = 'Protect ';              break;
  case 'delete':           prehint = 'Delete ';               break;
  case 'edit&amp;section=new': prehint = 'Start a new topic on '; break;
  }

  if (l.action!='edit' &amp;&amp; l.action!='view') l.oldid=null;
  
  var hint;
  if (prehint != null) {
    if (l.oldid) prehint += 'revision '+l.oldid +' of ';
    hint=prehint + safeDecodeURI(l.article);
  }
  else hint = safeDecodeURI(l.article + '&amp;action=' + l.action) 
         + (l.oldid) ? '&amp;oldid='+l.oldid : '';
  return titledWikiLink({article: l.article, action: l.action, text: l.text,
                                    title: hint, oldid: l.oldid});
};


var undef='undefined';
var defaultNavlinkClassname='popupNavLink';

function titledWikiLink(l) {
  // possible properties of argument:
  // article, action, text, title, oldid, actionName, className
  // oldid = null is fine here

  // article and action are mandatory args
  if (typeof l.article == undef || typeof l.action==undef) return null;
  var base = titlebase +  l.article;
  var url=base;

  if (typeof l.actionName==undef || !l.actionName) l.actionName='action';
  
  // no need to add &amp;action=view, and this confuses anchors
  if (l.action != 'view') url = base + '&amp;' + l.actionName + '=' + l.action;

  if (typeof l.oldid!=undef &amp;&amp; l.oldid) url+='&amp;oldid='+l.oldid;
  
  var cssClass=defaultNavlinkClassname;
  if (typeof l.className!=undef &amp;&amp; l.className) cssClass=l.className;
  
  return generalLink({url: url, 
                             title: (typeof l.title != undef) ? l.title : null, 
                             newWin: getValueOf('popupNewWindows'), 
                             className: cssClass,
                             text: (typeof l.text!=undef)?l.text:null});
};

function specialLink(l) {
  // properties: article, specialpage, text, sep
  if (typeof l.specialpage==undef||!l.specialpage) return null;
  var base = titlebase +  popSpecialNamespace+':'+l.specialpage;
  if (typeof l.sep == undef || l.sep===null) l.sep='&amp;target=';
  var url = base + l.sep + l.article;
  var prehint=null;
  switch (l.specialpage) {
  case 'Whatlinkshere':       prehint='Show articles which link to ';                       break;
  case 'Recentchangeslinked': prehint='Show changes in articles related to ';               break;
  case 'Contributions':       prehint='Show contributions made by ';                        break;
  case 'Blockip':             prehint='Block ';                                             break;
  case 'Ipblocklist':         prehint='Unblock ';                                           break;
  case 'Movepage':            prehint='Move ';                                              break;
  case 'Log':                 prehint=(l.sep=='&amp;user=')?'Show log for ' : 'Block log for '; break;
  case 'Prefixindex':         prehint='Show the userspace pages of ';                       break;
  }
  var hint;
  if (prehint != null) hint = prehint + safeDecodeURI(l.article);
  else hint = safeDecodeURI(l.specialpage+':'+l.article) ;

  return generalLink({url: url, title: hint, text: l.text, 
                             newWin: getValueOf('popupNewWindows'),
                             className: 'popupNavLink'});
};

function generalLink(l) {
  // l.url, l.text, l.title, l.newWin, l.className
  
  if (typeof l.url==undef) return null;

  // only quotation marks in the url can screw us up now... I think
  var url=l.url.split('&quot;').join('%22');

  var ret='&lt;a href=&quot;' + url + '&quot;';
  if (typeof l.title!=undef &amp;&amp; l.title) ret += ' title=&quot;' + l.title + '&quot;';
  if (typeof l.newWin!=undef &amp;&amp; l.newWin) ret += ' target=&quot;_blank&quot;';
  if (typeof l.className!=undef&amp;&amp;l.className) ret+=' class=&quot;'+l.className+'&quot;';
  ret += '&gt;';
  if (typeof l.text==typeof '') ret+= l.text;
  ret +='&lt;/a&gt;';
  return ret;
}

function literalizeRegex(str){
  return str.replace(RegExp('([-.()\\+?*^${}\\[\\]])', 'g'), '\\$1');
};

function appendParamsToLink(linkstr, params) {
  var sp=linkstr.parenSplit(RegExp('(href=&quot;[^&quot;]+?)&quot;', 'i'));
  if (sp.length&lt;2) return null;
  var ret=sp.shift() + sp.shift();
  ret += '&amp;' + params + '&quot;';
  ret += sp.join('');
 return ret;
};

function changeLinkTargetLink(x) { // newTarget, text, hint, summary, clickButton, minor) {
  // optional: oldTarget (in wikitext)

  // escape '&amp;' and other nasties
  x.newTarget=encodeURI(x.newTarget);
  x.text=encodeURI(x.text);
  x.clickButton=encodeURI(x.clickButton);

  // this'll break if charAt(0) is nasty
  if (typeof x.oldTarget != typeof '') x.oldTarget=decodeURI(window.currentArticle);
  var cA=literalizeRegex(x.oldTarget);
  var chs=cA.charAt(0).toUpperCase();
  chs='['+chs + chs.toLowerCase()+']';
  var currentArticleRegexBit=chs+cA.substring(1);
  currentArticleRegexBit=currentArticleRegexBit
    .split(RegExp('[_ ]', 'g')).join('[_ ]');
      
  // autoedit=s~\[\[([Cc]ad)\]\]~[[Computer-aided%20design|$1]]~g;s~\[\[([Cc]AD)[|]~[[Computer-aided%20design|~g
  var lk=titledWikiLink({article: removeAnchor(articleFromURL(location.href)),
                                    action:  'edit', 
                                    text:    x.text, 
                                    title:   x.hint
                                    });
  var cmd='s~\\[\\[('+currentArticleRegexBit+')\\]\\]~[['+x.newTarget+'|$1]]~g;';
  cmd +=  's~\\[\\[('+currentArticleRegexBit+')[|]~[['+x.newTarget+'|~g';
  cmd += '&amp;autoclick='+x.clickButton;
  cmd += '&amp;autominor='+x.minor;
  cmd += '&amp;autosummary='+x.summary;
  return appendParamsToLink(lk, 'autoedit='+cmd);
};


newOption('popupRedirAutoClick', &quot;'wpSave'&quot;);

function redirLink(redirMatch) { 
  /* NB redirMatch is in wikiText */
  var ret='';

  if (getValueOf('popupAppendRedirNavLinks') &amp;&amp; getValueOf('popupNavLinks')) {
    ret += '&lt;hr&gt;';
    if (getValueOf('popupFixRedirs') &amp;&amp; typeof autoEdit != 'undefined' &amp;&amp; autoEdit) {
      ret += addPopupShortcut(
                              changeLinkTargetLink({newTarget: redirMatch, text: 'Redirects', hint: 'Fix this redirect',
                                                   summary: 'Bypassing redirect from [[' + window.currentArticle.split('_').join(' ') 
                                                   + ']] to [[' + redirMatch + ']]',
                                                   clickButton: getValueOf('popupRedirAutoClick'), minor: true})
                              , 'R');
      ret += ' to ';
    }
    else ret += 'Redirects to ';

    fillEmptySpans({redir: true, redirTarget: wikiMarkupToAddressFragment(redirMatch)});
    return ret;
  }
    
  else return '&lt;br&gt; Redirects to ' +
         titledWikiLink({article: myEncodeURI(redirMatch), action: 'view', 
                        text: safeDecodeURI(redirMatch), title: 'Bypass redirect'});
};

function kateLink(l) {
  if (typeof l.article != typeof '' || typeof l.text != typeof '') return null;
  if (isIpUser(userName(l.article)) || ! wikimediaWiki) return null;

  var uN=safeDecodeURI(userName(l.article));
  
  var newWin='';
  if (getValueOf('popupNewWindows')) newWin=' target=&quot;_blank&quot;';

  return generalLink({url:kateBase + uN,
                            title: 'Count the countributions made by '+uN,
                            newWin: getValueOf('popupNewWindows'),
                            className: defaultNavlinkClassname,
                            text: l.text});
};

////////////////////////////
// MANIPULATION FUNCTIONS //
////////////////////////////

function upcaseFirst(str) {
  if (typeof str != typeof '' || str=='') return '';
  return str.charAt(0).toUpperCase() + str.substring(1);
};

function formatBytes(num) {return (num &gt; 949) ? (Math.round(num/100)/10+'kB') : (num +'&amp;nbsp;bytes') ;};
function popupFilterStubDetect(data) {return (isStub(data)) ? 'stub' : '';};

function popupFilterDisambigDetect(data) {
  if (!isDisambig(data)) return '';
  // FIXME: this side-effect should live somewhere else
  return 'disambig';
};

function listLinks(wikitext, oldTarget) {
  var reg=RegExp('\\[\\[([^|]*?)(\\||\\]\\])', 'gi');
  var ret=[];
  var splitted=wikitext.parenSplit(reg);
  // ^[a-z]+ should match interwiki links, hopefully (case-insensitive)
  // and ^[a-z]* should match those and [[:Category...]] style links too
  var omitRegex=RegExp('^[a-z]*:|^[Ss]pecial:|^[Ii]mage|^[Cc]ategory');
  for (var i=1; i&lt;splitted.length; i=i+3) {
    if (typeof splitted[i] == typeof 'string' &amp;&amp; splitted[i].length&gt;0 &amp;&amp; !omitRegex.test(splitted[i])) {
      ret.push(changeLinkTargetLink({newTarget: splitted[i], 
                                    text: splitted[i].split(' ').join('&amp;nbsp;'),
                                    hint: 'Disambiguate the this link to [['+splitted[i]+']]',
                                    summary: '[[Wikipedia:Tools/Navigation_popups|Popups]]-assisted disambiguation from [[' +
                                      window.currentArticle.split('_').join(' ') + ']] to [['+
                                      splitted[i] + ']]',
                                    clickButton: 'wpDiff', minor: true, oldTarget: oldTarget}));
    } /* if */
  } /* for loop */
  
  return rmDupesFromSortedList(ret.sort());
};

function rmDupesFromSortedList(list) {
  var ret=[];
  for (var i=0; i&lt;list.length; ++i) {
    if (ret.length==0 || list[i]!=ret[ret.length-1]) ret.push(list[i]);
  }
  return ret;
};

function makeFixDab(data, oldTarget) {
  var list=listLinks(data, oldTarget);
  if (list.length==0) return null;
  var html='&lt;hr&gt;Click to disambiguate this link to:&lt;br&gt;';
  html+=list[0];
  for (var i=1; i&lt;list.length; ++i) html += ', '+list[i];
  return html;
};

function popupFilterPageSize(data) {return formatBytes(data.length);};
function popupFilterCountLinks(data) {var num=countLinks(data);return String(num) + '&amp;nbsp;wikiLink' + ((num!=1)?'s':'');};
function popupFilterCountImages(data) {var num=countImages(data);return String(num) + '&amp;nbsp;image' + ((num!=1)?'s':'');};

function popupFilterCountCategories(data) {
  var num=countCategories(data); return String(num) + '&amp;nbsp;categor' + ((num!=1)?'ies':'y');
};


function popupFilterLastModified(data,download) {
  var lastmod=download.lastModified;
  var now=new Date(); 
  var age=now-lastmod;
  if (lastmod &amp;&amp; getValueOf('popupLastModified')) 
    return (formatAge(age) + ' old').replace(RegExp(' ','g'), '&amp;nbsp;');
  //String(lastmod)
  //      .replace(RegExp('GMT[+-][0-9]+\\s*[(]([A-Z]{1,4})[)]\\s*'), '$1')
  //      .replace(RegExp('^(... ... )0'),'$1')
  //      .replace(' ','&amp;nbsp;');
  return '';
}

function formatAge(age) {
  // coerce into a number
  var a=aa=0+age;

  var seclen=1000;
  var minlen=60*seclen;
  var hourlen=60*minlen;
  var daylen=24*hourlen;
  var weeklen=7*daylen;

  var numweeks=(a-a%weeklen)/weeklen; a=a-numweeks*weeklen; var sweeks=addunit(numweeks, 'week');
  var numdays=(a-a%daylen)/daylen;    a=a-numdays*daylen;   var sdays=addunit(numdays, 'day');
  var numhours=(a-a%hourlen)/hourlen; a=a-numhours*hourlen; var shours=addunit(numhours, 'hour');
  var nummins=(a-a%minlen)/minlen;    a=a-nummins*minlen;   var smins=addunit(nummins, 'minute');
  var numsecs=(a-a%seclen)/seclen;    a=a-numsecs*seclen;   var ssecs=addunit(numsecs, 'second');

  //alert( [numdays,numhours,nummins,numsecs].join(':') );

  var ret=numdays + ' days';
  if (aa &gt; 4*weeklen) return sweeks;
  if (aa &gt; weeklen) return sweeks + ' ' + sdays;
  if (aa &gt; daylen) return sdays + ' ' + shours;
  if (aa &gt; 6*hourlen) shours;
  if (aa &gt; hourlen) return shours + ' ' + smins;
  if (aa &gt; 10*minlen) return smins;
  if (aa &gt; minlen) return smins + ' ' + ssecs;
  return ssecs;
}

function addunit(num,str) { return '' + num + ' ' + str + ((num!=1) ? 's' : '') ;}


var popupFilters=[popupFilterStubDetect,popupFilterDisambigDetect,popupFilterPageSize,popupFilterCountLinks,
                  popupFilterCountImages,popupFilterCountCategories,popupFilterLastModified];

if (typeof extraPopupFilters=='undefined') { var extraPopupFilters=new Array(); }

function getPageInfo(data, download) {
  if (!data || data.length == 0) return 'Empty page';

  var pageInfoArray=new Array();
  var i,s;
  for (i=0; i&lt;     popupFilters.length; ++i) {s=     popupFilters[i](data,download);if (s!='') pageInfoArray.push(s);}
  for (i=0; i&lt;extraPopupFilters.length; ++i) {s=extraPopupFilters[i](data,download);if (s!='') pageInfoArray.push(s);}

  var pageInfo=pageInfoArray.join(', ');
  if (pageInfo != '' ) pageInfo = upcaseFirst(pageInfo);
  return pageInfo;
};     

function getValidImageFromWikiText(wikiText) {
  var imagePage=null;
  // nb in imageRegex we're interested in the second bracketed expression 
  // this may change if the regex changes :-(
  //var match=imageRegex.exec(wikiText);
  var matched=null;
  var match;
  defaultize('popupMinImageWidth');
  while ( match = imageRegex.exec(wikiText) ) {
    /* now find a sane image name - exclude templates by seeking { */
    var m = match[2];
    var pxWidth=match[4];
    if ( isValidImageName(m) &amp;&amp; (!pxWidth || parseInt(pxWidth) &gt;= popupMinImageWidth) ) { 
      matched=m; 
      break;
    }
  } 
  imageRegex.lastIndex=0;
  if (!matched) return null;
  return popImageNamespace+':'+upcaseFirst(matched);
};

// this could be improved!
function countLinks(wikiText) { return wikiText.split('[[').length - 1; };

// if N = # matches, n = # brackets, then
// String.parenSplit(regex) intersperses the N+1 split elements
// with Nn other elements. So total length is
// L= N+1 + Nn = N(n+1)+1. So N=(L-1)/(n+1).

function countImages(wikiText) {return (wikiText.parenSplit(imageRegex).length - 1) / (imageRegexBracketCount + 1);};

function countCategories(wikiText) {return (wikiText.parenSplit(categoryRegex).length - 1) / (categoryRegexBracketCount + 1); };

// returns /^(Talk|User[_ ]talk|Wikipedia[_ ]talk|...):$/
function namespaceListToRegex(list) {return RegExp('^('+list.join('|').split(' ').join('[ _]')+'):');};

function talkPage(article) { // convert article to a talk page, or if we can't return null
  if (article===null) return null;
  var talkRegex=namespaceListToRegex(popTalkNamespaces);
  if (talkRegex.exec(article)) {return null;}

  var nsRegex=namespaceListToRegex(popNamespacesWithTalk);
  var splitted=article.parenSplit(nsRegex);
  if (splitted.length&lt;2) return (popTalkNamespaces[0]+':'+article).split(' ').join('_');
  for (var i=0; i&lt; popNamespacesWithTalk.length; ++i) {
    if (splitted[1]==popNamespacesWithTalk[i]) {
      splitted[1]=popTalkNamespaces[i];
      return splitted.join(':').substring(1).split(' ').join('_');
    }
  }
  return null;
};

function articleFromTalkPage(talkpage) {
  var talkRegex=namespaceListToRegex(popTalkNamespaces);
  var splitted=talkpage.parenSplit(talkRegex);
  if (splitted.length &lt; 2 || splitted[0].length &gt; 0) return null;
  if (splitted[1]==popTalkNamespaces[0]) {
    splitted[1]=''; return splitted.join(':').substring(2).split(' ').join('_');
  }
  for (var i=1; i&lt; popTalkNamespaces.length; ++i) {
    if (splitted[1]==popTalkNamespaces[i] 
        || splitted[1]==popTalkNamespaces[i].split(' ').join('_')) {
      splitted[1]=popNamespacesWithTalk[i];
      return splitted.join(':').substring(1).split(' ').join('_');
    }
  }
  return null;
};

function userName(article) {
  var i=article.indexOf(popUserNamespace);
  var j=article.indexOf(':');
  if  (i != 0 || j == -1) return null;
  var k=article.indexOf('/');
  if (k==-1) return article.substring(j+1);
  else return article.substring(j+1,k);
};

function stripNamespace(article) {
  // this isn't very sophisticated 
  // it just removes everything up to the final :
  // BUG: probably does silly things for images with colons in the name - check it out
  var list = article.split(':');
  return list[list.length-1];
};

// those odd a/a5/ bits of image urls
function imagePathComponent(article) {
  var stripped=stripNamespace(article);
  var forhash=safeDecodeURI(stripped).split(' ').join('_');
  var hash=md5_hex(forhash);
  return hash.substring(0,1) + '/' + hash.substring(0,2) + '/';
};

function getImageUrlStart(wiki) { // this returns a trailing slash
  switch (wiki) {
    case 'en.wikipedia.org':  return 'http://upload.wikimedia.org/wikipedia/en/';
    case commonsWiki:         return 'http://upload.wikimedia.org/wikipedia/commons/';
    case 'en.wiktionary.org': return 'http://en.wiktionary.org/upload/en/';
    default: // unsupported - take a guess
      if (wikimediaWiki) {
        var lang=wiki.split('.')[0];
        return 'http://upload.wikimedia.org/wikipedia/' + lang +'/';
      }
      else /* this should work for wikicities */
        return 'http://' + wiki + '/images/';
  }
};

function imageURL(img, wiki) {
  if (getValueOf('popupImagesFromThisWikiOnly') &amp;&amp; wiki != thisWiki) return null;
  var imgurl=null;
  if (isImage(img)) {
    var pathcpt = imagePathComponent(img);
    var stripped=stripNamespace(img);
    imgurl=getImageUrlStart(wiki) + pathcpt + stripped;
  }
  return imgurl;
};

function imageThumbURL(img, wiki, width) {
  // 
  // eg http://upload.wikimedia.org/wikipedia/en/thumb/6/61/ 
  //           Rubiks_cube_solved.jpg/120px-Rubiks_cube_solved.jpg
  //           ^^^^^^^^^^^^^^^^^^^^^^^ 
  //          wikicities omits this bit
  //  AND wikicities needs a new pathcpt for each filename including thumbs

  if (getValueOf('popupImagesFromThisWikiOnly') &amp;&amp; wiki != thisWiki) return null;
  if (getValueOf('popupNeverGetThumbs')) return null;

  var imgurl=null;
  if (isImage(img)) {
    var stripped=stripNamespace(img);
    var pathcpt;
    if (wikimediaWiki) pathcpt = imagePathComponent(stripped);
    else pathcpt = imagePathComponent(width+'px-'+stripped);
    imgurl=getImageUrlStart(wiki) +  &quot;thumb/&quot; + pathcpt;
    if (wikimediaWiki) imgurl += stripped + '/';
    imgurl += width +&quot;px-&quot; + stripped;
  }
  return imgurl;
};


// (a) myDecodeURI (first standard decodeURI, then exceptions)
// (b) change spaces to underscores
// (c) encodeURI (just the straight one, no exceptions)

function wikiMarkupToAddressFragment (str) { // for images
  var ret = safeDecodeURI(str);
  ret = ret.split(' ').join('_');
  ret = encodeURI(ret);
  return ret;
};

function addressFragmentToWikiMarkup (str) { 
  // seemingly, not :( the inverse of wikiMarkupToAddressFragment
  return safeDecodeURI(str);
};

function myDecodeURI (str) {
  // log('myDecodeURI, str=' + str);
  var ret;
  try { ret=decodeURI(str); }
  catch (summat) { return null; }
  for (var i=0; i&lt;decodeExtras.length; ++i) {
    var from=decodeExtras[i].from;
    var to=decodeExtras[i].to;
    ret=ret.split(from).join(to);
  }
  return ret;
};

function safeDecodeURI(str) {var ret=myDecodeURI(str); return ret || str;};

function myEncodeURI (str) {
  log ('myEncodeURI: str='+str);
  var ret=str;
  ret=encodeURI(ret);
  for (var i=0; i&lt;decodeExtras.length; ++i) {
    var from=decodeExtras[i].from;
    var to=decodeExtras[i].to;
    ret=ret.split(to).join(from);
  }
  return ret;
};

function removeAnchor(article) {
  // is there a #? if not, we're done
  var i=article.indexOf('#');
  if (i == -1) return article;
  return article.substring(0,i);
};

///////////
// TESTS //
///////////

function isStub(data) { return stubRegex.test(data); };
function isDisambig(data) { return talkPage(window.currentArticle) &amp;&amp; disambigRegex.test(data); };

function isValidImageName(str){ // extend as needed...
  return ( str.indexOf('{') == -1 );
};

function isInNamespaceOrTalk(article, namespace) {
  if (isInNamespace(article, namespace)) return true;
  if  (article.indexOf(namespace+'_talk:') == 0) return true;
  return false;
};

function isInNamespace(article, namespace) {
  if (article.indexOf(namespace+':')==0) return true;
  return false;
};

function isImage(thing) {return isInNamespaceOrTalk(thing, popImageNamespace);};

function isImageOk(img)
{ 
  // gecko test
  if (typeof img.naturalWidth != &quot;undefined&quot; &amp;&amp; img.naturalWidth == 0)
    return false;
  // No other way of checking: assume it's ok.
  return true;
};

function anchorContainsImage(a) {
  // iterate over children of anchor a
  // see if any are images
  if (a===null) return false;
  kids=a.childNodes;
  for (var i=0; i&lt;kids.length; ++i) if (kids[i].nodeName=='IMG') return true;
  return false;
};

/////////////
// ACTIONS //
/////////////

var imageCache = new Array ();

function loadThisImage(image) {
  if (getValueOf('popupLoadImagesSequentially')) return sequentialLoadThisImage(image);
  else return parallelLoadThisImage(image);
};

function getImageUrls(image) {
  var imageUrls=new Array();
  for (var i=0; i&lt;imageSources.length; ++i) {
    var url;
    if (imageSources[i].thumb) 
      url=imageThumbURL(image, imageSources[i].wiki, imageSources[i].width);
    else 
      url=imageURL(image, imageSources[i].wiki);
    for (var j=0; j&lt;gImageCache.length; ++j) {
      if (url == gImageCache[j]) {
        loadThisImageAtThisUrl(image, url);
        return null;
      }
    }
    if (url!=null) imageUrls.push(url);
  }
  return imageUrls;
};


// this is probably very wasteful indeed of bandwidth
// hey ho

function parallelLoadThisImage (image) {
  if (!popupImages) return;
  if (!isValidImageName(image)) return false;
  
  var imageUrls=getImageUrls(image);
  if (!imageUrls) return null;

  for (var i=0; i&lt;imageUrls.length; ++i) {
    var url = imageUrls[i];
    imageArray[i]=new Image();
    imageArray[i].src=url;
  }
  if (popupImageTimer != null) {
    clearInterval(popupImageTimer);
    counter=0;
  }
  gImage=image;
  popupImageTimer=setInterval(&quot;checkImages()&quot;, 250);
  return true;
};

function nextOne (array, value) {
  // NB if the array has two consecutive entries equal 
  //    then this will loop on successive calls
  if (typeof array.length == 'undefined') return null;
  for (var i=0; i&lt;array.length-1; ++i) {
    if (array[i]==value) return array[i+1];
  }
  return null;
};

function findThis(array, value) {
  if (typeof array.length == 'undefined') return null;
  for (var i=0; i&lt;array.length; ++i) {
    if (array[i]==value) return i;
  }
  return null;
};

// global array for 404'ed image urls
var gBadImageUrls=[];

function sequentialLoadThisImage (image) {
  if (!popupImages) return false;
  if (!isValidImageName(image)) return false;

  var imageUrls=getImageUrls(image);
  if (!imageUrls) return null;

  var img=new Image();
  img.isNew=true;
  img.popupIdNumber=popupIdNumber;
  img.counter=1;

  img.onload = function () {
    // clear status thingy
    setImageStatus('');

    var i=findThis(imageUrls, this.src);
    var goodSrc=this.src;

    var setPopupImage=function () {
      var popupImage=document.getElementById(&quot;popupImage&quot;+this.popupIdNumber);
      if (popupImage &amp;&amp; typeof popupImage.src != 'undefined') {
        clearInterval(popupImageTimer);
        popupImage.src=goodSrc;
        popupImage.width=popupImageSize;
        popupImage.style.display='inline';
        setPopupImageLink(image, imageSources[i].wiki);
        return true;
      } else return false;
    };
    popupImageTimer=setInterval(setPopupImage, 250);
    gImageCache.push(goodSrc); 
  };
  
  img.onerror = function () {
    gBadImageUrls.push(this.src);
    // if the popup is visible, move on
    if (over &amp;&amp; over.style.visibility=='visible' &amp;&amp; this.popupIdNumber==popupIdNumber) this.setNext();
  };
  
  img.setNext = function () {
    var currentSrc=null;
    var newSrc;
    if (!this.isNew) currentSrc=this.src;
    this.isNew=false;
    
    newSrc= (currentSrc) ? nextOne(imageUrls, currentSrc) : imageUrls[0];

    while (findThis(gBadImageUrls, newSrc))  {
      newSrc=nextOne(imageUrls, newSrc);
      if (!newSrc) {
        setImageStatus (' :-(');
        return;
      }
    }
    setImageStatus(' '+findThis(imageUrls, newSrc));
    this.src=newSrc;
  }
  
  // start the ball rolling
  img.setNext();

};

function loadThisImageAtThisUrl(image, url) {
  log('loading &quot;best&quot; image:\n'+url);
  gImage=image;
  imageArray = new Array();
  imageArray[0] = new Image();
  imageArray[0].src=url;
  if (popupImageTimer != null) {
    clearInterval(popupImageTimer);
    counter=0;
  }
  popupImageTimer=setInterval(&quot;checkImages()&quot;, 250);
  return;
};

function loadImages(article) {if(! isImage(article) ) return null; return loadThisImage(article);};

// this has to use a timer loop as we don't know if the DOM element exists when we want to set the text
function setPopupHTML (str, elementId, popupId, onSuccess) {
  log('setPopupHTML, str='+str.substring(0,100)+'..., \n elementId='+elementId+', popupId='+popupId);
  if (typeof popupId === 'undefined') popupId = popupIdNumber;
  var popupElement=document.getElementById(elementId+popupId);
  var timer;

  if (typeof popupHTMLTimers[elementId] == 'undefined') timer=null;
  else timer=popupHTMLTimers[elementId];

  if (popupElement != null) {
    if(timer) clearInterval(timer);
    popupHTMLTimers[elementId]=null;
    popupElement.innerHTML=str;
    if (onSuccess) onSuccess();
    return true;
  } else {
    // call this function again in a little while...
    var loopFunction=function() { setPopupHTML(str,elementId,popupId,onSuccess);}
    popupHTMLLoopFunctions[elementId] = loopFunction;
    if (!timer) {
      var doThis = 'popupHTMLLoopFunctions[&quot;'+elementId+'&quot;]()';
      popupHTMLTimers[elementId] = setInterval(doThis, 600);
    }
  }
  return null;
};

function setImageStatus(str, id) {return setPopupHTML(str, 'popupImageStatus', id);};
function setPopupTrailer(str,id) {return setPopupHTML(str, 'popupData', id);};

// methinks this is unbelievably silly
// it dovetails with the parallel image loader function
function checkImages() {
  log('checkImages: loopcounter='+loopcounter+'; counter='+counter);
  if (checkImagesTimer!=null) {
    clearInterval(checkImagesTimer);
    checkImagesTimer=null;
    if (loopcounter &gt; 10); {loopcounter=0; log('too many iterations of checkImages'); return;}
    loopcounter++;
  } else counter++;

  var status =  ( counter % 2 ) ? ':' : '.' ;
  setImageStatus(status);

  if (counter &gt; 100) {counter = 0; log ('counter too big in checkImages; returning'); clearInterval(popupImageTimer);}

  var popupImage=null;
  popupImage=document.getElementById(&quot;popupImg&quot;+popupIdNumber);
  if (popupImage == null) {
    // this doesn't seem to happen any more in practise for some reason
    // still, I'll leave it in
    log('checkImages: document.getElementById(&quot;popupImg'+popupIdNumber+'&quot;) is null! retrying in 333ms...');
    checkImagesTimer=setInterval(&quot;checkImages()&quot;,333);
    return;
  }
  
  log('checkImages: found element popupImg'+popupIdNumber+', and src='+popupImage.src);
 
  // get the first image to successfully load
  // and put it in the popupImage
  for(var i = 0; i &lt; imageArray.length; ++i) {
    if(isImageOk(imageArray[i])) {
      // stop all the gubbins, assign the image and return
     
      log('checkImages: got at pos '+i+', src='+imageArray[i].src);
      clearInterval(popupImageTimer);

      if(isImage(gImage)) {
        popupImage.src=imageArray[i].src;
        popupImage.width=popupImageSize;
        popupImage.style.display='inline';
        // should we check to see if it's already there? maybe...
        gImageCache.push(imageArray[i].src); 

        setPopupImageLink(gImage, imageSources[i].wiki);
        stopImagesDownloading();
      }

      setImageStatus('');

      // reset evil nonconstant globals
      delete imageArray; imageArray=new Array();
      popupImageTimer=null;

      counter=0;
      loopcounter=0;

      return popupImage.src; 
    }
  }
  log('checkImages: no good image found. retrying in a tic...');
  checkImagesTimer=setInterval(&quot;checkImages()&quot;,333);
};

function stopImagesDownloading() {
  gImage=null;
  if (imageArray == null) return null;
  var i;
  for (i=0; i&lt;imageArray.length; ++i) {
    //imageArray[i].src=''; // this is a REALLY BAD IDEA
    delete imageArray[i];
    //imageArray[i] = new Image();
  }
  imageArray = new Array ();
  return i;
};

function toggleSize() {
  var imgContainer=this;
  if (!imgContainer) { alert('imgContainer is null :/'); return;}
  img=imgContainer.firstChild;
  if (!img) { alert('img is null :/'); return;}
  if (!img.style.width || img.style.width=='') img.style.width='100%'; 
  else img.style.width=''; // popupImageSize+'px';
};

function setPopupImageLink (img, wiki) {
  if( wiki === null || img === null ) return null;
 
  var a=document.getElementById(&quot;popupImageLink&quot;+popupIdNumber);
  if (a === null) return null; 

  var linkURL = imageURL(img, wiki); 
  if (linkURL != null) {
    if (getValueOf('popupImagesToggleSize')) { a.onclick=toggleSize; a.title='Toggle image size'; } 
    else { a.href=linkURL; a.title='Open full-size image'; }
  }
  return linkURL;
};

var ranSetupTooltipsAlready=false;

function setupTooltips() {
  if (ranSetupTooltipsAlready) return;
  ranSetupTooltipsAlready=true;

  var anchors;
  
  // article/content is a structure-dependent thing
  if (getValueOf('popupOnlyArticleLinks'))
    anchors=( document.getElementById('article') || 
              document.getElementById('content')   ).getElementsByTagName('A');
  else
    anchors=document.getElementsByTagName('A');

  for (var i=0; i&lt;anchors.length; ++i) {
    var a=anchors[i];
    var h=a.href;
    if (
        ( (re.test(h)  &amp;&amp; !exceptions.test(h)) 
          || 
          (contributions.test(h) &amp;&amp; h.indexOf('&amp;limit=') == -1 ) 
        )
        &amp;&amp; (! isInToc(a)) 
       ) {
      a.onmouseover=mouseOverWikiLink;
      a.onmouseout= mouseOutWikiLink;
      a.onclick= killPopup;
      if (getValueOf('removeTitles') &amp;&amp; typeof a.originalTitle=='undefined') {
        a.originalTitle=a.title;
        a.title='';
      }
    }
  }
};


//////////////
// THINGIES //
//////////////

// How the URLs for images in the popup come about

//   loadPreviewImage 
//          |                                  
//       getWiki                                
//          |&lt;----------------see other schematic for details 
//    insertPreviewImage      (insertPreviewImage = onComplete)
//          |
//          |            insertPreviewImage gets a wikiText fragment from 
//          |                       the wikiText downloaded by getWiki
//          |                                   
//  [wikiMarkupToAddressFragment]         
//       |                                      
//       |                     mouseOverWikiLink  (gets an &quot;address fragment&quot;,       
//       |                            |            no processing needed)
//       \-&gt;-loadThisImage---&lt;----loadImages    
//                 |                            
//           [image(Thumb)URL]--&gt;--hopefully valid image urls


window.currentLink=null;

function popupHandleKeypress(evt) {
  var keyCode = evt.keyCode ? evt.keyCode : 
    evt.charCode ? evt.charCode : evt.which;
  if (!keyCode || !over) return;
  if (keyCode==27) { // escape
    killPopup();
    return;
  }

  var letter=String.fromCharCode(keyCode);
  var links=over.getElementsByTagName('A');
  var startLink=0;
  var i,j;
  
  if (window.lastPopupLinkSelected) {
    for (i=0; i&lt;links.length; ++i) {
      if (links[i]==window.lastPopupLinkSelected) startLink=i;
    }
  }
  for (j=0; j&lt;links.length; ++j) {
    i=(startLink + j + 1) % links.length;
    if (links[i].getAttribute('popupkey')==letter) {
      if (evt.preventDefault) evt.preventDefault();
      links[i].focus();
      window.lastPopupLinkSelected=links[i];
      break;
    }
  }
};

function addPopupShortcuts() {
  if (document.onkeypress==popupHandleKeypress) return;
  document.oldPopupOnkeypress=document.onkeypress;
  document.onkeypress=popupHandleKeypress;
};

function rmPopupShortcuts() {
  if (String(document.oldPopupOnkeypress)==String(popupHandleKeypress)) {
    // panic
    document.onkeypress=function () {};
    return;
  }
  document.onkeypress=document.oldPopupOnkeypress;
};

// add CSS class to table

function addPopupStylesheetClasses () {
  var tables=over.getElementsByTagName('table');
  tables[0].className='popupBorderTable';
  tables[1].className='popupTable';
  var fonts=over.getElementsByTagName('font');
  fonts[0].className='popupFont';
  fonts[0].id='overFontWrapper';
};

var alreadyRegisteredHooks=false;

function registerHooks() {
  if (window.alreadyRegisteredHooks) return;
  window.alreadyRegisteredHooks=true;
  
  defaultize('popupMaxWidth');

  if (typeof popupMaxWidth == 'number') {
    window.setmaxwidth = function () {
      over.style.maxWidth = popupMaxWidth+'px'; 
      
      // hack for IE
      // see http://www.svendtofte.com/code/max_width_in_ie/
      // who knows if this will work? not me.
      // use setExpression as documented here on msdn: http://tinyurl.com/dqljn 
      
      if (over.style.setExpression) {
        over.style.setExpression('width', 
                                 'document.body.clientWidth &gt; '
                                 + popupMaxWidth + ' ? &quot;' 
                                 + popupMaxWidth + 'px&quot;: &quot;auto&quot; );');
      }
    };
    registerHook(&quot;createPopup&quot;, window.setmaxwidth, FAFTER);
  }
  
  registerHook('createPopup', window.fillEmptySpans, FAFTER);
  
  if (getValueOf('popupShortcutKeys')) {
    registerHook(&quot;createPopup&quot;, window.addPopupShortcuts, FAFTER);
    registerHook(&quot;hideObject&quot;, window.rmPopupShortcuts, FAFTER);
  }

  if (getValueOf('popupDragging')) 
    registerHook(&quot;createPopup&quot;, window.makeOverDraggable, FAFTER);

  registerHook(&quot;createPopup&quot;, window.addPopupStylesheetClasses, FAFTER);
};


function makeOverDraggable() {
  if (typeof over == undef || !over) return null;
  if (typeof over.draggable != undef &amp;&amp; over.draggable) return null;
  Drag.originalEnd=Drag.end;
  Drag.end=function(e) { Drag.originalEnd(); olMouseMove(e); return false; }
  Drag.originalStart=Drag.start;
  Drag.start=function (e) { if (!e.shiftKey) return; 
                            Drag.originalStart.apply(this, [e]); 
                            return false; }
  Drag.init(over);
};

function mouseOverWikiLink() {
  return mouseOverWikiLink2(this);
};

function mouseOverWikiLink2(a) {
  // FIXME: should not generate the HTML until the delay has elapsed,
  //        and then popup immediately. Can be a CPU hog otherwise.
 
  log('mouseOverWikiLink: a='+a+', window.currentLink='+window.currentLink);

  // try not to duplicate effort
  if (a==window.currentLink) return;
  window.currentLink=a;

  if (typeof over != undef &amp;&amp; over != null
      &amp;&amp; typeof over.dragging != undef &amp;&amp; over.dragging) return;

  // increment global counter now
  popupIdNumber++;


  if (getValueOf('simplePopups') &amp;&amp; window.popupStructure===null) {
    // reset *default value* of popupStructure
    log ('simplePopups is true and no popupStructure selected. Defaulting to &quot;original&quot;');
    newOption('popupStructure', &quot;'original'&quot;);
  }

  var html = popupHTML(a);
  var article=articleFromAnchor(a); 
  var oldid=oldidFromAnchor(a);

  if (popupImageTimer != null) {
    clearInterval(popupImageTimer);
    counter=0;
  }
  
  // keep this (or fix other refs)
  defaultize('popupImages');

  log('running overlib now');
  
  registerHooks();
  
  defaultize('popupInitialWidth');
  if (typeof popupInitialWidth == typeof 0) {
    overlib(html, STICKY, WIDTH, popupInitialWidth,
            CELLPAD, 5, OFFSETX, 2, OFFSETY, 2, 
            DELAY, getValueOf('popupDelay')*1000);
  } else {
    overlib(html, STICKY, WRAP, 
            CELLPAD, 5, OFFSETX, 2, OFFSETY, 2, 
            DELAY, getValueOf('popupDelay')*1000);
  }    
  
  if (typeof window.checkPopupPosition==typeof 1) clearInterval(window.checkPopupPosition);
  checkPopupPositionTimer=setInterval(checkPopupPosition, 600);

  if (getValueOf('popupLiveOptions')) {
    setPopupHTML(popupLiveOptionsHTML(), 'popupLiveOptions', popupIdNumber,
                 function () { popupToggleShowOptions(true); } );
  }

  if(getValueOf('simplePopups')) return;

  
  // dunno what this is doing here
  // FIXME: what is going on?
  window.popupUnsimplify = function () {
    var previewImage=true;
    
    gImage=null;
    
    if (isImage(article) &amp;&amp; ( getValueOf('imagePopupsForImages') || ! anchorContainsImage(a) )) {
      loadImages(article);
    }
    else if (!isImage(article) &amp;&amp; previewImage) {
      redirCount=0;
      loadPreviewImage(article, oldid);
    }

    var s=document.getElementById('popupUnsimplify' + popupIdNumber);
    if (s &amp;&amp; s.style) {
      s.style.display='none';
    }
    
  };

  if (getValueOf('popupUnsimplifyLink')) return;

  window.popupUnsimplify();
};

function loadPreviewImage(article, oldid) {return getWiki(article, insertPreviewImage, oldid);};

function loadPreviewImageFromRedir(redirPage, redirMatch) {
  /* redirMatch is a regex match */
  log('loadPreviewImageFromRedir, redirCount='+redirCount);
  var target = redirMatch[1];
  var trailingRubbish=redirMatch[2];
  window.redirCount=window.redirCount+1;
  var warnRedir = redirLink(target);

  setPopupHTML(warnRedir, 'popupWarnRedir');

  return loadPreviewImage(myEncodeURI(target));
};

// header...!___ -&gt; ...
function extractChunk(str, header, breakChar) {
  if (str.indexOf(header) != 0) return null;
  if (!breakChar) return str.substring(header.length);
  var findChar=str.indexOf(breakChar);
  if (findChar==-1) return str.substring(header.length);
  return str.substring(header.length, findChar);
};

function urlToWikiPage (url) {
  log ('urlToWikiPage\nurl='+url);
  var urlFragment=null;
  if (!urlFragment) urlFragment=extractChunk(url, titlebase, '&amp;');
  if (!urlFragment) urlFragment=extractChunk(url, wikibase, '?');
  if (!urlFragment) return null;
  return addressFragmentToWikiMarkup(urlFragment);
};

function makeFixDabs(wikiText, oldTarget)
{
  if (getValueOf('popupFixDabs') &amp;&amp; isDisambig(wikiText) &amp;&amp; 
      location.href.indexOf(popSpecialNamespace+':') == -1 &amp;&amp;
      talkPage(window.currentArticle)
      ) 
    setPopupHTML(makeFixDab(wikiText, oldTarget), 'popupFixDab', popupIdNumber);
}

function insertPreviewImage(download) {
  log('insertPreviewImage, redirCount='+redirCount);
  if (download.id != popupIdNumber) {
    log ('insertPreviewImage: download.id='+download.id+' but popupIdNumber='+popupIdNumber+'. Bailing...');
    return;
  }
  var wikiText=download.data;
  var redirectRegex= RegExp('^[ \\n]*[#]redirect[: \\n]*\\[\\[([^\\]]*)\\]\\]\\s*(.*)', 'i') ;
  var redirMatch = redirectRegex.exec(wikiText);

  var art=window.currentArticle;

  if (redirCount==0 &amp;&amp; redirMatch) {
    window.currentRedirectionSource=window.currentArticle;
    loadPreviewImageFromRedir(urlToWikiPage(download.url), redirMatch);
    return;
  }

  var redirSource=window.currentRedirectionSource||'';

  if (redirCount==0) makeFixDabs(wikiText); // not a redir, so we don't have to specify an oldTarget
  else makeFixDabs(wikiText, redirSource);

  window.currentRedirectionSource=null;
  redirCount=0;

  if (getValueOf('popupSummaryData')) {
    var pgInfo=getPageInfo(wikiText, download);
    setPopupTrailer('&lt;br&gt;' + pgInfo);
  }


  var imagePage=getValidImageFromWikiText(wikiText);
  if(imagePage) {
    // loadThisImage expects an &quot;address fragment&quot;
    imagePage = wikiMarkupToAddressFragment(imagePage); 
    defaultize('popupLoadImagesSequentially');
    loadThisImage(imagePage);
  }
   
  if (getValueOf('popupPreviews')) {
    if (download &amp;&amp; typeof download.data == typeof ''){
      
      if (isInNamespace(window.currentArticle, 'Template')) {
        var h='&lt;hr&gt;&lt;tt&gt;'
          +download.data
          .split(&quot;&amp;&quot;).join(&quot;&amp;amp;&quot;)
          .split(&quot;&lt;&quot;).join(&quot;&amp;lt;&quot;)
          .split(&quot;&gt;&quot;).join(&quot;&amp;gt;&quot;)
          .split('\\n').join('&lt;br&gt;\\n')
          +'&lt;/tt&gt;';
        setPopupHTML(h, 'popupPreview');
      }
      else {
        var p=new previewMaker(download.data.substring(0,10000));
        p.showPreview();
      }
      
    }
  }
};

var localTest=false;

function previewMaker(wikiText) {this.data=wikiText;}
previewMaker.prototype.killComments = function () {
  this.data=this.data.replace(RegExp('&lt;!--(\\n|.)*?--&gt;', 'g'), '');
};
previewMaker.prototype.killDivs=function () {
  // say goodbye, divs (can be nested, so use * not *?)
  this.data=this.data.replace(RegExp('&lt; *div[^&gt;]* *&gt;(.|\\n)*&lt; */ *div *&gt;',
                           'gi'), '');
};
previewMaker.prototype.killGalleries=function () {
  this.data=this.data.replace(RegExp('&lt; *gallery[^&gt;]* *&gt;(.|\\n)*?&lt; */ *gallery *&gt;',
                           'gi'), '');
};
previewMaker.prototype.killBoxTemplates=function () {
  // taxobox hack... in fact, there's a saudiprincebox_begin, so let's be more general
  this.data=this.data.replace(RegExp('[{][{][^}\\s|]*box[ _]begin' + 
                           '(.|\\n)*[^{\\s|]*box[ _]end *[}][}]', 'gi'), '');

  // also, have float_begin, ... float_end
  this.data=this.data.replace(RegExp('[{][{][^}\\s|]*float[ _]begin' + 
                           '(.|\\n)*[^{\\s|]*float[ _]end.*?[}][}]',
                           'gi'), '');
};
previewMaker.prototype.killTemplates = function () {
  this.data=this.data.replace(RegExp('[{][{]([{][{][^}]*[}][}]|[^{}])*[}][}]', 'g'), ' ');
};
previewMaker.prototype.killTables=function () {
  // tables are bad, too
  this.data=this.data.replace
  (RegExp('[{]\\|([{][|]([^\\|]|\\|[^}])*[|][}]|[^\\|]|\\|[^}])*\\|[}]', 'g')
   , '');
  // remove lines starting with a pipe
  this.data=this.data.replace(RegExp('^[|].*$', 'mg'), '');
};
previewMaker.prototype.killImages=function () {
  // images are a nono
  // who says regexes aren't fun?
  // i think we should match:
  // [[image: ...... ]] where ....... consists of repetitions of any of:
  // 1. not [ or ]
  // 2. [[ (not ])* ]] 
  // 3. [ (not ])* ]
  var imagedetector =
  '[[][[]\\s*('+
    popImageNamespace + '|' + popCategoryNamespace+
  ')\\s*:([^\\[\\]]|\\[\\[[^\\]]*\\]\\]|\\[[^\\]]*\\])*\\]\\]';
  var crudeImageRegex = RegExp(imagedetector, 'gi');
  this.data=this.data.replace(crudeImageRegex, '');
};
previewMaker.prototype.killHTML=function () {
  // kill html tables // this doesn't cope with embedded tables
  // may this is good enough?
  this.data=this.data.replace(RegExp('&lt;table.*?&gt;(.|\\n.)*?\\n?&lt;/ *table *&gt;\\n+', 'gi'), '');
  
  // let's also delete entire lines starting with &lt;. it's worth a try.
  this.data=this.data.replace(RegExp('(^|\\n) *&lt;.*', 'g'), '\n');

  // and those pesky html tags
  this.data=this.data.replace(RegExp('&lt;.*?&gt;','g'),'');
};
previewMaker.prototype.killChunks=function() { // heuristics alert
  // chunks of italic text? you crazy, man?
  var italicChunkRegex=new RegExp
    (&quot;((^|\\n)\\s*:*\\s*''[^']([^']|'''|'[^']){20}(.|\\n[^\\n])*''[.!?\\s]*\\n)*&quot;, 'g');
  this.data=this.data.replace(italicChunkRegex, '');
};
previewMaker.prototype.mopup=function () {
  // we simply *can't* be doing with horizontal rules right now
  this.data=this.data.replace(RegExp('^-{4,}','mg'),'');

  // no indented lines 
  this.data=this.data.replace(RegExp('(^|\\n) *:[^\\n]*','g'), '\n');

  // replace __TOC__, __NOTOC__ and whatever else there is
  // this'll probably do
  this.data=this.data.replace(RegExp('^__[A-Z_]*__ *$', 'gmi'),'');
};
previewMaker.prototype.firstBit=function () {
  // dont't be givin' me no subsequent paragraphs, you hear me?
  /// first we &quot;normalize&quot; section headings, removing whitespace after, adding before
  
  this.data=this.data.replace(RegExp('\\s*(==+[^=]*==+)\\s*', 'g'), '\n\n$1 ');

  /// then we want to get rid of paragraph breaks whose text ends badly
  this.data=this.data.replace(RegExp('([:;]) *\\n{2,}', 'g'), '$1\n');

  this.data=this.data.replace(RegExp('^[\\s\\n]*'), '');
  stuff=(RegExp('^([^\\n]|\\n[^\\n\\s])*')).exec(this.data);
  var d;
  if (stuff) d = stuff[0];  
  
  /// now put \n\n after sections so that bullets and numbered lists work
  d=d.replace(RegExp('(==+[^=]*==+)\\s*', 'g'), '$1\n\n');

  // superfluous sentences are RIGHT OUT.
  // note: exactly 1 set of parens here needed to make the slice work
  d = d.parenSplit(RegExp('([!?.]+[&quot;'+&quot;'&quot;+']*\\s)','g'));
  // leading space is bad, mmkay?
  d[0]=d[0].replace(RegExp('^\\s*'), '');

  var notSentenceEnds=RegExp('([^.][a-z][.][a-z]|etc|sic|Dr|Mr|Mrs|Ms)$'
                             + '|' +
                             '\\[[^\\]]*$'
                             , 'i');
  
  d = this.fixSentenceEnds(d, notSentenceEnds);

  defaultize('popupMaxPreviewSentences');
  defaultize('popupMaxPreviewCharacters');
  
  var n=getValueOf('popupMaxPreviewSentences'); 
  var dd;
  
  do {dd=this.firstSentences(d,n); --n; } 
  while ( dd.length &gt; popupMaxPreviewCharacters &amp;&amp; n &gt; 0 );
  
  this.data = dd;
};
previewMaker.prototype.fixSentenceEnds=function(strs, reg) { 
  // take an array of strings, strs
  // join strs[i] to strs[i+1] &amp; strs[i+2] if strs[i] matches regex reg
  
  for (var i=0; i&lt;strs.length-2; ++i) {
    if (reg.test(strs[i])) {
      a=[];
      for (var j=0; j&lt;strs.length; ++j) {
        if (j&lt;i)   a[j]=strs[j];
        if (j==i)  a[i]=strs[i]+strs[i+1]+strs[i+2];
        if (j&gt;i+2) a[j-2]=strs[j];
      }
      return this.fixSentenceEnds(a,reg);
    }
  }
  return strs;
};
previewMaker.prototype.firstSentences=function(strs, howmany) {
  var t=strs.slice(0, 2*howmany); 
  return t.join(''); 
};
previewMaker.prototype.makePreview=function() {
  this.killComments();
  this.killDivs();
  this.killGalleries();
  this.killBoxTemplates();
  this.killTemplates();
  this.killTables();
  this.killImages();
  this.killHTML();
  this.killChunks();
  this.mopup();
  
  this.firstBit();

  this.html=wiki2html(this.data); // needs livepreview
};
previewMaker.prototype.showPreview=function () {
  this.makePreview();
  if (typeof this.html != typeof '') return;
  if (RegExp('^\\s*$').test(this.html)) return;
  //if (getValueOf('popupNavLinks') || getValueOf('popupSummaryData')) 
  setPopupHTML('&lt;hr&gt;'+this.html, 'popupPreview');
};


function fuzzyCursorOffMenus(fuzz) {
  if(!over) return null;
  var spans=over.getElementsByTagName('span');
  for (var i=0; i&lt;spans.length; ++i) {
    if (typeof spans[i].className != undef &amp;&amp; spans[i].className=='popup_menu') {
      if (!fuzzyCursorOffDiv(fuzz, spans[i])) return false;
    } // else {document.title+='.';}
  }
  return true;
};

function fuzzyCursorOffDiv(fuzz, div) {
  log('fuzzyCursorOffDiv: mouse (x,y)=('+o3_x+',' + o3_y+')');
  var left=findPosX(div)-fuzz; 
  var top=findPosY(div) - fuzz;
  var right=left + div.offsetWidth + 2*fuzz;
  var height=0;
  for (var i=0; i&lt;div.childNodes.length;++i) {
    log('adding child '+div.childNodes[i]+'.offsetHeight: '+div.childNodes[i].offsetHeight);
    if (typeof div.childNodes[i].offsetHeight==typeof 1)
      height+=div.childNodes[i].offsetHeight;
  }
  var bottom = top + height + 2*fuzz;
  log(left+'-&gt;'+right+' , '+top+'-&gt;'+bottom);
  //document.title+=' offsetHeight:'+div.offsetHeight;
  if (typeof left != 'number' || typeof right != 'number' || typeof top != 'number') return true;
  if (o3_x &lt; left || o3_x &gt; right || o3_y &lt; top) // || o3_y &gt; bottom) // FIXME: should check the bottom too
    return true;
  return false;
};

function checkPopupPosition () { // stop the popup running off the right of the screen
  if (typeof over == undef || !over) return null;
  var x=findPosX(over);
  var w=parseInt(over.offsetWidth);
  if ( (x+w) &gt;= document.body.clientWidth ) {
    // for what I am about to do, may the Lord forgive me
    over.style.left=0;
    var ww=parseInt(over.offsetWidth);
    over.style.left=(document.body.clientWidth-ww-1)+'px';
  }
  return true;
};


function findPosX(obj)
{
	var curleft = 0;
	if (obj.offsetParent)
	{
		while (obj.offsetParent)
		{
			curleft += obj.offsetLeft
			obj = obj.offsetParent;
		}
	}
	else if (obj.x)
		curleft += obj.x;
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	if (obj.offsetParent)
	{
		while (obj.offsetParent)
		{
			curtop += obj.offsetTop
			obj = obj.offsetParent;
		}
	}
	else if (obj.y)
		curtop += obj.y;
	return curtop;
}


function fuzzyCursorOffOver(fuzz) {
  if (!over) return null;
  var left = parseInt(over.style.left);
  var top = parseInt(over.style.top);
  var right = left + 
    (over.offsetWidth &gt;= parseInt(o3_width) ? over.offsetWidth : parseInt(o3_width));
  var bottom = top + 
    (over.offsetHeight &gt;= o3_aboveheight ? over.offsetHeight : o3_aboveheight);

  if (o3_x &lt; left-fuzz || o3_x &gt; right+fuzz || o3_y &lt; top-fuzz || o3_y &gt; bottom + fuzz)
   return true;
  return false;
};

window.fuzzyCursorOff=function(fuzz) {
  return fuzzyCursorOffOver(fuzz) &amp;&amp; fuzzyCursorOffMenus(fuzz);
}

// seems that fuzzyCursorOff should precede mouseOutWikiLink in the source
// or sometimes during page loads, errors are generated

var stopPopupTimer=null;

function mouseOutWikiLink () {
  if (typeof over != undef &amp;&amp;  over &amp;&amp; over.dragging) return null;
  if (fuzzyCursorOff(5)) { 
    if (window.stopPopupTimer) {
      clearInterval(window.stopPopupTimer); 
      window.stopPopupTimer=null; 
    }
    killPopup(); 
    return;
  }
  if (!window.stopPopupTimer) 
    window.stopPopupTimer=setInterval(&quot;mouseOutWikiLink()&quot;, 500);
};

function killPopup() {
  // o3_showingsticky should be defined in overlib.js
  //if ( typeof o3_showingsticky != &quot;undefined&quot; &amp;&amp; o3_showingsticky == 0 ) {
  if (getValueOf('popupShortcutKeys')) rmPopupShortcuts();
  cClick();
  window.currentLink=null;
  // abortCurrentDownload();
  stopImagesDownloading();
  if (checkPopupPositionTimer != null) { clearInterval(checkPopupPositionTimer); checkPopupPositionTimer=null; }
  if (checkImagesTimer != null) { clearInterval(checkImagesTimer); checkImagesTimer=null; }
  if (popupImageTimer != null) { clearInterval(popupImageTimer); popupImageTimer=null; }
  return true; // preserve default action (eg from onclick)
};

////////////////////////////////////////////////////////////////////
// Run things
////////////////////////////////////////////////////////////////////

if (window.addEventListener) {
  window.addEventListener(&quot;load&quot;,setupTooltips,false);
}
else if (window.attachEvent) {
  window.attachEvent(&quot;onload&quot;,setupTooltips);
}
else {
  window._old_popup_onload = window.onload;
  window.onload = function() {
    window._old_popup_onload();
    setupTooltips();
  }
}

/// Local Variables: ///
/// mode:c ///
/// End: ///
// --FILE BOUNDARY-- // --FILE BOUNDARY-- // --FILE BOUNDARY--
function getParamValue(paramName) {
  var cmdRe=RegExp('[&amp;?]'+paramName+'=([^&amp;]*)');
  var h=document.location;
  var m;
  if (m=cmdRe.exec(h)) {
    try { 
      return decodeURI(m[1]);
    } catch (someError) {}
  }
  return null;
};

function substitute(data,cmdBody) {
  // alert('sub\nfrom: '+cmdBody.from+'\nto: '+cmdBody.to+'\nflags: '+cmdBody.flags);
  var fromRe=RegExp(cmdBody.from, cmdBody.flags);
  return data.replace(fromRe, cmdBody.to);
};

function execCmds(data, cmdList) {
  for (var i=0; i&lt;cmdList.length; ++i) {
    data=cmdList[i].action(data, cmdList[i]);
  }
  return data;
}

function parseCmd(str) {
  // returns a list of commands
  if (!str.length) return [];
  var p=false;
  switch (str.charAt(0)) {
  case 's':
    p=parseSubstitute(str);
    break;
  case 'j':
    p=parseJavascript(str);
    break;
  default:
    return false;
  }
  if (p) return [p].concat(parseCmd(p.remainder));
  return false;
};

function unEscape(str, sep) {
  return str.split('\\\\').join('\\')
        .split('\\'+sep).join(sep)
        .split('\\n').join('\n');
};


function runJavascript(data, argWrapper) {
  // flags aren't used (yet)

  // from the user's viewpoint,
  // data is a special variable may appear inside code
  // and gets assigned the text in the edit box

  // alert('eval-ing '+argWrapper.code);

  return eval(argWrapper.code);
};

function parseJavascript(str) {
  // takes a string like j/code/;othercmds and parses it

  var tmp,code,flags;

  if (str.length&lt;3) return false;
  var sep=str.charAt(1);
  str=str.substring(2);
  
  tmp=skipOver(str,sep);
  if (tmp) { code=tmp.segment.split('\n').join('\\n'); str=tmp.remainder; }
  else return false;

  flags='';
  if (str.length) {
    tmp=skipOver(str,';') || skipToEnd(str, ';');
    if (tmp) {flags=tmp.segment; str=tmp.remainder; }
  }

  return { action: runJavascript, code: code, flags: flags, remainder: str };
};

function parseSubstitute(str) {
  // takes a string like s/a/b/flags;othercmds and parses it

  var from,to,flags,tmp;

  if (str.length&lt;4) return false;
  var sep=str.charAt(1);
  str=str.substring(2);

  tmp=skipOver(str,sep);
  if (tmp) { from=tmp.segment; str=tmp.remainder; } 
  else return false;

  tmp=skipOver(str,sep);
  if (tmp) { to=tmp.segment; str=tmp.remainder; } 
  else return false;

  flags='';
  if (str.length) {
    tmp=skipOver(str,';') || skipToEnd(str, ';');
    if (tmp) {flags=tmp.segment; str=tmp.remainder; }
  }
  
  return {action: substitute, from: from, to: to, flags: flags, remainder: str};

};

function skipOver(str,sep) {
  var endSegment=findNext(str,sep);
  if (endSegment&lt;0) return false;
  var segment=unEscape(str.substring(0,endSegment), sep);
  return {segment: segment, remainder: str.substring(endSegment+1)};
}

function skipToEnd(str,sep) {
  return {segment: str, remainder: ''};
}

function findNext(str, ch) {
  for (var i=0; i&lt;str.length; ++i) {
    if (str.charAt(i)=='\\') i+=2;
    if (str.charAt(i)==ch) return i;
  }
  return -1;
};

function runOnLoad(f) {
  if (window.addEventListener) {
    window.addEventListener(&quot;load&quot;,f,false);
  }
  else if (window.attachEvent) {
    window.attachEvent(&quot;onload&quot;,f);
  }
  else {
    window._old_popup_autoedit_onload = window.onload;
    window.onload = function() {
      window._old_popup_autoedit_onload();
      f();
    }
  }
};

function autoEdit() {

  var cmdString=getParamValue('autoedit');
  if (cmdString) {
    try { 
      var editbox=document.editform.wpTextbox1;
    } catch (dang) { return; }
    var cmdList=parseCmd(cmdString);
    var input=editbox.value;
    var output=execCmds(input, cmdList);
    editbox.value=output;
  }

  var summary=getParamValue('autosummary');
  if (summary) document.editform.wpSummary.value=summary;

  var minor=getParamValue('autominor');
  if (minor) {
    switch (minor) {
    case '1':
    case 'yes':
    case 'true':
      document.editform.wpMinoredit.checked=true;
      break;
    case '0':
    case 'no':
    case 'false':
      document.editform.wpMinoredit.checked=false;
    }
  }

  var btn=getParamValue('autoclick');
  if (btn) {
    if (document.editform &amp;&amp; eval('document.editform.'+btn)) {
      var headings=document.getElementsByTagName('h1');
      if (headings) {
        var div=document.createElement('div');
        var button=eval('document.editform.'+btn);
        div.innerHTML='&lt;font size=+1&gt;&lt;b&gt;The &quot;' + button.value + 
          '&quot; button has been automatically clicked.' + 
          ' Please wait for the next page to load.&lt;/b&gt;&lt;/font&gt;';
        document.title='('+document.title+')';
        headings[0].parentNode.insertBefore(div, headings[0]);
        button.click();
      }
    } else {
      alert('autoedit.js\n\nautoclick: could not find button &quot;'+ btn +'&quot;.');
    }  
  }
};

runOnLoad(autoEdit);
// --FILE BOUNDARY-- // --FILE BOUNDARY-- // --FILE BOUNDARY--
// Last update: 21:51, 15 Feb 2005 (UTC)

// Script to embed Live Preview in MediaWiki's edit page
function LivePreviewInstall()
{
 copywarn = document.getElementById('editpage-copywarn');
 if (copywarn != null) {
  var cleaner = &quot;&lt;br style=\\'clear:both;\\' /&gt;&quot;;
  LivePreviewHTML = '&lt;input type=&quot;button&quot; value=&quot;Live Preview&quot; onclick=&quot;document.getElementById(\'PreviewBox\').innerHTML = wiki2html(editform.wpTextbox1.value) + \'' + cleaner + '\';&quot; /&gt;';
  //LivePreviewHTML = '&lt;input type=&quot;button&quot; value=&quot;Live Preview&quot; onclick=&quot;document.getElementById(\'PreviewBox\').innerHTML = wiki2html(editform.wpTextbox1.value);&quot; /&gt;';
  LivePreviewHTML += '&lt;div style=&quot;margin-top: 5px; margin-bottom: 5px; padding: 5px; border: 3px double orange;&quot; id=&quot;PreviewBox&quot;&gt;&lt;/div&gt;';
  copywarn.innerHTML = LivePreviewHTML + copywarn.innerHTML;
 }
}

// User options
var wpUserName=wpUserName||'Wikipedian';
var wpUserSignature=wpUserSignature||wpUserName;
var wpShowImages=wpShowImages||true;

// System options
var wpLanguageCode=wpLanguageCode||'en';
var wpInterwikiCodes=wpInterwikiCodes||'aa|ab|af|ak|als|am|an|ang|ar|arc|as|ast|av|ay|az|ba|be|ber|bg|bh|bi|bm|bn|bdf|bo|br|bs|ca|ce|ceb|ch|cho|chr|chy|co|cr|cs|csb|cu|cv|cy|da|de|dv|dz|el|en|eo|es|et|eu|fa|ff|fi|fiu-vro|fj|fo|fr|fur|fy|ga|gd|gil|gl|gn|got|gu|gv|ha|haw|he|hi|ho|hr|ht|hu|hy|hz|ia|id|ie|ig|ii|ik|io|is|it|iu|ja|jbo|jv|ka|kg|ki|kj|kk|kl|km|kn|ko|kr|ks|ku|kv|kw|ky|la|lad|lan|lb|lg|li|ln|lo|lt|lu|lv|mg|mh|mi|mk|ml|mn|mo|mr|ms|mt|mus|my|na|nah|nap|nb|nd|nds|ne|ng|nl|nn|no|nr|nv|ny|oc|oj|om|or|os|pa|pam|pi|pl|ps|pt|qu|rm|rn|ro|roa-rup|ru|rw|sa|sc|scn|sco|sd|se|sg|sh|si|sk|sl|sm|smg|sn|so|sq|sr|ss|st|su|sv|sw|ta|te|tg|th|ti|tk|tl|tlh|tn|to|tpi|tr|ts|tt|tum|tw|ty|ug|uk|ur|uz|ve|vi|vk|vo|wa|war|wen|wo|xh|yi|yo|za|zh|zh-min-nan|zu';
var wpBaseArticlePath=wpBaseArticlePath||'/wiki/';
var wpMathBasePath=wpMathBasePath||'/math/';
var wpImageBasePath=wpImageBasePath||'http://upload.wikimedia.org/wikipedia/'+wpLanguageCode+'/';
var wpImageFallbackPath=wpImageFallbackPath||'http://upload.wikimedia.org/wikipedia/commons/';
var wpDefaultThumbWidth=wpDefaultThumbWidth||180;
var wpSkinMagnifyClip=wpSkinMagnifyClip||'/skins/common/images/magnify-clip.png';
var wpUserNamespace=wpUserNamespace||'User';
var wpImageNamespace=wpImageNamespace||'Image';
var wpCategoryNamespace=wpCategoryNamespace||'Category';

// Packed code (DO NOT MODIFY)
function wiki2html(str)
{str=strip_cr(str);var w=new WikiCode();w.lines=str.split(/\n/);w.parse();return w.html;};var wpSignature='[['+wpUserNamespace+':'+wpUserName+'|'+wpUserSignature+']]';var wpBlockImage=new RegExp('^\\[\\['+wpImageNamespace+':.*?\\|.*?(?:frame|thumbnail|thumb|none|right|left|center)','i');function WikiCode()
{this.lines=new Array;this.html=new String;this._endline=function(str)
{this.html+=str;this.lines.shift();};this.parse=function()
{var p=false;do{if(h_match=this.lines[0].match(/^(={1,6})(.*)\1(.*)$/)){p=false;this._endline('&lt;h'+h_match[1].length+'&gt;'+_parse_inline_nowiki(h_match[2])+'&lt;/h'+h_match[1].length+'&gt;'+h_match[3]);}else if(this.lines[0].match(/^[*#:;]/)){p=false;this._parse_list();}else if(this.lines[0].charAt(0)==' '){p=false;this._parse_pre();}else if(this.lines[0].substr(0,2)=='{|'){p=false;this._parse_table();}else if(this.lines[0].match(/^----+$/)){p=false;this._endline('&lt;hr/&gt;');}else if(this.lines[0].match(wpBlockImage)){p=false;this._parse_block_image();}else{if(this.lines[0]==''){if(p=(this.lines.length&gt;1&amp;&amp;this.lines[1]=='')){this._endline('&lt;p&gt;&lt;br /&gt;');}}else{if(!p){this.html+='&lt;p&gt;';p=true;}
this.html+=_parse_inline_nowiki(this.lines[0])+' ';}
this.lines.shift();}}while(this.lines.length);};this._parse_list=function(){var prev=new String;var l_match,imatch,dt_match;while(this.lines.length&amp;&amp;(l_match=this.lines[0].match(/^([*#:;]+)(.*)$/))){this.lines.shift();imatch=str_imatch(prev,l_match[1]);for(var i=prev.length-1;i&gt;=imatch;i--){if(prev.charAt(i)=='*'){this.html+='&lt;/ul&gt;';}else if(prev.charAt(i)=='#'){this.html+='&lt;/ol&gt;'}else{this.html+='&lt;/d'+((prev.charAt(i)==';')?'t':'d')+'&gt;';switch(l_match[1].charAt(i)){case'':case'*':case'#':this.html+='&lt;/dl&gt;';}}}
for(var i=imatch;i&lt;l_match[1].length;i++){if(l_match[1].charAt(i)=='*'){this.html+='&lt;ul&gt;';}else if(l_match[1].charAt(i)=='#'){this.html+='&lt;ol&gt;';}else{switch(prev.charAt(i)){case'':case'*':case'#':this.html+='&lt;dl&gt;';}
this.html+='&lt;d'+((l_match[1].charAt(i)==';')?'t':'d')+'&gt;';}}
switch(l_match[1].charAt(l_match[1].length-1)){case'*':case'#':this.html+='&lt;li&gt;'+_parse_inline_nowiki(l_match[2]);break;case';':if(dt_match=l_match[2].match(/(.*?) (:.*?)$/)){this.html+=_parse_inline_nowiki(dt_match[1]);this.lines.unshift(dt_match[2]);break;}
case':':this.html+=_parse_inline_nowiki(l_match[2]);}
prev=l_match[1];}
for(i=prev.length-1;i&gt;=0;i--){if(prev.charAt(i)=='*'){this.html+='&lt;/ul&gt;';}else if(prev.charAt(i)=='#'){this.html+='&lt;/ol&gt;';}else{this.html+='&lt;/d'+((prev.charAt(i)==';')?'t':'d')+'&gt;&lt;/dl&gt;';}}};this._parse_table=function()
{var table_match;if(table_match=this.lines[0].match(/^\{\|( .*)$/)){this._endline('&lt;table'+table_match[1]+'&gt;');}else this._endline('&lt;table&gt;');do{if(this.lines[0].charAt(0)=='|'){switch(this.lines[0].charAt(1)){case'}':this._endline('&lt;/table&gt;');return;case'-':this._endline('&lt;tr '+this.lines[0].match(/\|-*(.*)/)[1]+'&gt;');break;default:this._parse_table_data();}}else if(this.lines[0].charAt(0)=='!'){this._parse_table_data();}else{this.lines.shift();}}while(this.lines.length)};this._parse_table_data=function()
{var td_match,td_line;td_match=this.lines.shift().match(/^(\|\+|\||!)((?:([^[|]*?)\|(?!\|))?(.*))$/);if(td_match[1]=='|+'){this.html+='&lt;caption';}else{this.html+='&lt;t'+((td_match[1]=='|')?'d':'h');}
if(typeof td_match[3]!='undefined'){this.html+=' '+td_match[3];td_line=td_match[4].split('||');}else{td_line=td_match[2].split('||');}
this.html+='&gt;';while(td_line.length&gt;1){this.lines.unshift(td_match[1]+td_line.pop());}
this.html+=_parse_inline_nowiki(td_line[0]);var td=new WikiCode;var table_count=0;while(this.lines.length){if(this.lines[0].charAt(0)=='|'){if(table_count==0)break;else if(this.lines[0].charAt(1)=='}')table_count--;}else if(this.lines[0].charAt(0)=='!'&amp;&amp;table_count==0){break;}else if(this.lines[0].substr(0,2)=='{|')table_count++;td.lines.push(this.lines.shift());}
if(td.lines.length){td.parse();}
this.html+=td.html;};this._parse_pre=function()
{this.html+='&lt;pre&gt;';do{this._endline(_parse_inline_nowiki(this.lines[0].substring(1,this.lines[0].length))+&quot;\n&quot;);}while(this.lines.length&amp;&amp;this.lines[0].charAt(0)==' ');this.html+='&lt;/pre&gt;';};this._parse_block_image=function()
{this.html+=_parse_image(this.lines.shift());};};function _parse_image(str)
{var attr=str.substring(wpImageNamespace.length+3,str.length-2).split(/\s*\|\s*/);var filename=attr[0];var caption=attr[attr.length-1];var width,w_match;var thumb=false;var frame=false;var center=false;var align='';var html='';do{if(w_match=attr[0].match(/^(\d*)px$/)){width=w_match[1];}else switch(attr[0]){case'thumb':case'thumbnail':thumb=true;case'frame':frame=true;break;case'none':case'right':case'left':center=false;align=attr[0];break;case'center':center=true;align='none';}
attr.shift();}while(attr.length);if(frame){if(align=='')align='right';html+=&quot;&lt;div class='thumb t&quot;+align+&quot;'&gt;&quot;;if(thumb){if(!width)width=wpDefaultThumbWidth;html+=&quot;&lt;div style='width:&quot;+(2+parseInt(width))+&quot;px;'&gt;&quot;;html+=_make_image(filename,caption,width);html+=&quot;&lt;div class='thumbcaption'&gt;&lt;div class='magnify' style='float:right'&gt;&lt;a href='&quot;+wpBaseArticlePath+wpImageNamespace+':'+filename+&quot;' class='internal' title='Enlarge'&gt;&lt;img src='&quot;+wpSkinMagnifyClip+&quot;' /&gt;&lt;/a&gt;&lt;/div&gt;&quot;+_parse_inline_nowiki(caption)+&quot;&lt;/div&gt;&quot;;}else{html+='&lt;div&gt;';html+=_make_image(filename,caption);html+=&quot;&lt;div class='thumbcaption'&gt;&quot;+_parse_inline_nowiki(caption)+&quot;&lt;/div&gt;&quot;;}
html+='&lt;/div&gt;&lt;/div&gt;';}else if(align!=''){html+=&quot;&lt;div class='float&quot;+align+&quot;'&gt;&lt;span&gt;&quot;+_make_image(filename,caption,width)+&quot;&lt;/span&gt;&lt;/div&gt;&quot;;}else{return _make_image(filename,caption,width);}
if(center){return&quot;&lt;div class='center'&gt;&quot;+html+'&lt;/div&gt;';}else{return html;}};this._parse_inline_nowiki=function(str)
{var start,lastend=0
var substart=0,nestlev=0,open,close,subloop;var html='';while(-1!=(start=str.indexOf('&lt;'+'nowiki&gt;',substart))){html+=_parse_inline_wiki(str.substring(lastend,start));start+=8;substart=start;subloop=true;do{open=str.indexOf('&lt;'+'nowiki&gt;',substart);close=str.indexOf('&lt;/nowiki&gt;',substart);if(close&lt;=open||open==-1){if(close==-1){return html+html_entities(str.substr(start));}
substart=close+9;if(nestlev){nestlev--;}else{lastend=substart;html+=html_entities(str.substring(start,lastend-9));subloop=false;}}else{substart=open+8;nestlev++;}}while(subloop);}
return html+_parse_inline_wiki(str.substr(lastend));};function _make_image(filename,caption,width)
{filename=filename.charAt(0).toUpperCase()+filename.substr(1);filename=filename.replace(/ /g,'_');var md5=hex_md5(filename);var source=md5.charAt(0)+'/'+md5.substr(0,2)+'/'+filename;var img;if(wpShowImages){if(width){width=&quot;width='&quot;+width+&quot;px'&quot;;}
img=&quot;&lt;img onerror='this.onerror=null;this.src=\&quot;&quot;+wpImageFallbackPath+source+&quot;\&quot;;' src='&quot;+wpImageBasePath+source+&quot;' alt='&quot;+caption+&quot;' &quot;+width+&quot;/&gt;&quot;;}else{img=wpImageNamespace+':'+filename+&quot; &lt;em style='color:red;'&gt;(images disabled)&lt;/em&gt;&quot;;}
caption=_strip_inline_wiki(caption);return&quot;&lt;a class='image' title='&quot;+caption+&quot;' href='&quot;+wpBaseArticlePath+wpImageNamespace+':'+filename+&quot;'&gt;&quot;+img+&quot;&lt;/a&gt;&quot;;};function _parse_inline_images(str)
{var start,substart=0,nestlev=0;var loop,close,open,wiki,html;while(-1!=(start=str.indexOf('[[',substart))){if(str.substr(start+2).match(RegExp('^'+wpImageNamespace+':','i'))){loop=true;substart=start;do{substart+=2;close=str.indexOf(']]',substart);open=str.indexOf('[[',substart);if(close&lt;=open||open==-1){if(close==-1)return str;substart=close;if(nestlev){nestlev--;}else{wiki=str.substring(start,close+2);html=_parse_image(wiki);str=str.replace(wiki,html);substart=start+html.length;loop=false;}}else{substart=open;nestlev++;}}while(loop);}else{break;}}
return str;};function _parse_inline_wiki(str)
{var aux_match,math_md5;str=_parse_inline_images(str);while(aux_match=str.match(/&lt;(?:)math&gt;(.*?)&lt;\/math&gt;/i)){math_md5=hex_md5(aux_match[1]);str=str.replace(aux_match[0],&quot;&lt;img src='&quot;+wpMathBasePath+math_md5+'.png'+&quot;' /&gt;&quot;);}
return str.replace(/'''''(.*?)''(.*?)'''/g,'&lt;strong&gt;&lt;em&gt;$1&lt;/em&gt;$2&lt;/strong&gt;').replace(/'''''(.*?)'''(.*?)''/g,'&lt;em&gt;&lt;strong&gt;$1&lt;/strong&gt;$2&lt;/em&gt;').replace(/'''(.*?)''(.*?)'''''/g,'&lt;strong&gt;$1&lt;em&gt;$2&lt;/em&gt;&lt;/strong&gt;').replace(/'''(.*?)'''/g,'&lt;strong&gt;$1&lt;/strong&gt;').replace(/''(.*?)''/g,'&lt;em&gt;$1&lt;/em&gt;').replace(/~{5}(?!~)/g,Date()).replace(/~{4}(?!~)/g,wpSignature+' '+Date()).replace(/~{3}(?!~)/g,wpSignature).replace(RegExp('\\[\\[:((?:'+wpCategoryNamespace+'|'+wpInterwikiCodes+'):.*?)\\]\\]','gi'),&quot;&lt;a href='&quot;+wpBaseArticlePath+&quot;$1'&gt;$1&lt;/a&gt;&quot;).replace(RegExp('\\[\\[(?:'+wpCategoryNamespace+'|'+wpInterwikiCodes+'):.*?\\]\\]','gi'),'').replace(/\[\[([^|]*?)\]\](\w*)/g,&quot;&lt;a href='&quot;+wpBaseArticlePath+&quot;$1'&gt;$1$2&lt;/a&gt;&quot;).replace(/\[\[(.*?)\|([^\]]+?)\]\](\w*)/g,&quot;&lt;a href='&quot;+wpBaseArticlePath+&quot;$1'&gt;$2$3&lt;/a&gt;&quot;).replace(/\[\[([^\]]*?:)?(.*?)( *\(.*?\))?\|\]\]/g,&quot;&lt;a href='&quot;+wpBaseArticlePath+&quot;$1$2$3'&gt;$2&lt;/a&gt;&quot;).replace(/\[(http|news|ftp|mailto|gopher|irc):(\/*)([^\]]*?) (.*?)\]/g,&quot;&lt;a href='$1:$2$3'&gt;$4&lt;/a&gt;&quot;).replace(/\[http:\/\/(.*?)\]/g,&quot;&lt;a href='http://$1'&gt;[#]&lt;/a&gt;&quot;).replace(/\[(news|ftp|mailto|gopher|irc):(\/*)(.*?)\]/g,&quot;&lt;a href='$1:$2$3'&gt;$1:$2$3&lt;/a&gt;&quot;).replace(/(^| )(http|news|ftp|mailto|gopher|irc):(\/*)([^ $]*)/g,&quot;$1&lt;a href='$2:$3$4'&gt;$2:$3$4&lt;/a&gt;&quot;).replace('__NOTOC__','').replace('__NOEDITSECTION__','');};function _strip_inline_wiki(str)
{return str.replace(/\[\[[^\]]*\|(.*?)\]\]/g,'$1').replace(/\[\[(.*?)\]\]/g,'$1').replace(/''(.*?)''/g,'$1');};function max(a,b)
{if(a&gt;b)return a;else return b;};function min(a,b)
{if(a&lt;b)return a;else return b;};function str_imatch(str_a,str_b)
{var lim=min(str_a.length,str_b.length);for(var i=0;i&lt;lim;i++){if(str_a.charAt(i)!=str_b.charAt(i))return i;}
return i;};function strip_cr(str)
{return str.replace(/\n\r/g,&quot;\n&quot;).replace(/\r/g,'');};function html_entities(str)
{return str.replace(/&amp;/g,&quot;&amp;amp;&quot;).replace(/&lt;/g,&quot;&amp;lt;&quot;).replace(/&gt;/g,&quot;&amp;gt;&quot;);};var chrsz=8;var hex_tab=&quot;0123456789abcdef&quot;;function hex_md5(s){return binl2hex(core_md5(str2binl(s),s.length*chrsz));};function core_md5(x,len)
{x[len&gt;&gt;5]|=0x80&lt;&lt;((len)%32);x[(((len+64)&gt;&gt;&gt;9)&lt;&lt;4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i&lt;x.length;i+=16)
{var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);}
return Array(a,b,c,d);};function md5_cmn(q,a,b,x,s,t)
{return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b);};function md5_ff(a,b,c,d,x,s,t)
{return md5_cmn((b&amp;c)|((~b)&amp;d),a,b,x,s,t);};function md5_gg(a,b,c,d,x,s,t)
{return md5_cmn((b&amp;d)|(c&amp;(~d)),a,b,x,s,t);};function md5_hh(a,b,c,d,x,s,t)
{return md5_cmn(b^c^d,a,b,x,s,t);};function md5_ii(a,b,c,d,x,s,t)
{return md5_cmn(c^(b|(~d)),a,b,x,s,t);};function safe_add(x,y)
{var lsw=(x&amp;0xFFFF)+(y&amp;0xFFFF);var msw=(x&gt;&gt;16)+(y&gt;&gt;16)+(lsw&gt;&gt;16);return(msw&lt;&lt;16)|(lsw&amp;0xFFFF);};function bit_rol(num,cnt)
{return(num&lt;&lt;cnt)|(num&gt;&gt;&gt;(32-cnt));};function str2binl(str)
{var bin=Array();var mask=(1&lt;&lt;chrsz)-1;for(var i=0;i&lt;str.length*chrsz;i+=chrsz)
bin[i&gt;&gt;5]|=(str.charCodeAt(i/chrsz)&amp;mask)&lt;&lt;(i%32);return bin;};function binl2hex(binarray)
{var str='';for(var i=0;i&lt;binarray.length*4;i++)
{str+=hex_tab.charAt((binarray[i&gt;&gt;2]&gt;&gt;((i%4)*8+4))&amp;0xF)+
hex_tab.charAt((binarray[i&gt;&gt;2]&gt;&gt;((i%4)*8))&amp;0xF);}
return str;}; // &lt;/math&gt;// --FILE BOUNDARY-- // --FILE BOUNDARY-- // --FILE BOUNDARY--
/*
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2-alpha Copyright (C) Paul Johnston 1999 - 2005
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

/*
 * Configurable variables. You may need to tweak these to be compatible with
 * the server-side, but the defaults work in most cases.
 */
var hexcase = 0;   /* hex output format. 0 - lowercase; 1 - uppercase        */
var b64pad  = &quot;&quot;; /* base-64 pad character. &quot;=&quot; for strict RFC compliance   */

/*
 * These are the functions you'll usually want to call
 * They take string arguments and return either hex or base-64 encoded strings
 */
function hex_md5(s)    { return rstr2hex(rstr_md5(str2rstr_utf8(s))); }
function b64_md5(s)    { return rstr2b64(rstr_md5(str2rstr_utf8(s))); }
function any_md5(s, e) { return rstr2any(rstr_md5(str2rstr_utf8(s)), e); }
function hex_hmac_md5(k, d)
  { return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function b64_hmac_md5(k, d)
  { return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d))); }
function any_hmac_md5(k, d, e)
  { return rstr2any(rstr_hmac_md5(str2rstr_utf8(k), str2rstr_utf8(d)), e); }

/*
 * Perform a simple self-test to see if the VM is working
 */
function md5_vm_test()
{
  return hex_md5(&quot;abc&quot;) == &quot;900150983cd24fb0d6963f7d28e17f72&quot;;
}

/*
 * Calculate the MD5 of a raw string
 */
function rstr_md5(s)
{
  return binl2rstr(binl_md5(rstr2binl(s), s.length * 8));
}

/*
 * Calculate the HMAC-MD5, of a key and some data (raw strings)
 */
function rstr_hmac_md5(key, data)
{
  var bkey = rstr2binl(key);
  if(bkey.length &gt; 16) bkey = binl_md5(bkey, key.length * 8);

  var ipad = Array(16), opad = Array(16);
  for(var i = 0; i &lt; 16; i++)
  {
    ipad[i] = bkey[i] ^ 0x36363636;
    opad[i] = bkey[i] ^ 0x5C5C5C5C;
  }

  var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
  return binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
}

/*
 * Convert a raw string to a hex string
 */
function rstr2hex(input)
{
  var hex_tab = hexcase ? &quot;0123456789ABCDEF&quot; : &quot;0123456789abcdef&quot;;
  var output = &quot;&quot;;
  var x;
  for(var i = 0; i &lt; input.length; i++)
  {
    x = input.charCodeAt(i);
    output += hex_tab.charAt((x &gt;&gt;&gt; 4) &amp; 0x0F)
           +  hex_tab.charAt( x        &amp; 0x0F);
  }
  return output;
}

/*
 * Convert a raw string to a base-64 string
 */
function rstr2b64(input)
{
  var tab = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;
  var output = &quot;&quot;;
  var len = input.length;
  for(var i = 0; i &lt; len; i += 3)
  {
    var triplet = (input.charCodeAt(i) &lt;&lt; 16)
                | (i + 1 &lt; len ? input.charCodeAt(i+1) &lt;&lt; 8 : 0)
                | (i + 2 &lt; len ? input.charCodeAt(i+2)      : 0);
    for(var j = 0; j &lt; 4; j++)
    {
      if(i * 8 + j * 6 &gt; input.length * 8) output += b64pad;
      else output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-j)) &amp; 0x3F);
    }
  }
  return output;
}

/*
 * Convert a raw string to an arbitrary string encoding
 */
function rstr2any(input, encoding)
{
  var divisor = encoding.length;
  var remainders = Array();
  var i, q, x, quotient;

  /* Convert to an array of 16-bit big-endian values, forming the dividend */
  var dividend = Array(input.length / 2);
  for(i = 0; i &lt; dividend.length; i++)
  {
    dividend[i] = (input.charCodeAt(i * 2) &lt;&lt; 8) | input.charCodeAt(i * 2 + 1);
  }

  /*
   * Repeatedly perform a long division. The binary array forms the dividend,
   * the length of the encoding is the divisor. Once computed, the quotient
   * forms the dividend for the next step. We stop when the dividend is zero.
   * All remainders are stored for later use.
   */
  while(dividend.length &gt; 0)
  {
    quotient = Array();
    x = 0;
    for(i = 0; i &lt; dividend.length; i++)
    {
      x = (x &lt;&lt; 16) + dividend[i];
      q = Math.floor(x / divisor);
      x -= q * divisor;
      if(quotient.length &gt; 0 || q &gt; 0)
        quotient[quotient.length] = q;
    }
    remainders[remainders.length] = x;
    dividend = quotient;
  }

  /* Convert the remainders to the output string */
  var output = &quot;&quot;;
  for(i = remainders.length - 1; i &gt;= 0; i--)
    output += encoding.charAt(remainders[i]);

  return output;
}

/*
 * Encode a string as utf-8.
 * For efficiency, this assumes the input is valid utf-16.
 */
function str2rstr_utf8(input)
{
  var output = &quot;&quot;;
  var i = -1;
  var x, y;

  while(++i &lt; input.length)
  {
    /* Decode utf-16 surrogate pairs */
    x = input.charCodeAt(i);
    y = i + 1 &lt; input.length ? input.charCodeAt(i + 1) : 0;
    if(0xD800 &lt;= x &amp;&amp; x &lt;= 0xDBFF &amp;&amp; 0xDC00 &lt;= y &amp;&amp; y &lt;= 0xDFFF)
    {
      x = 0x10000 + ((x &amp; 0x03FF) &lt;&lt; 10) + (y &amp; 0x03FF);
      i++;
    }

    /* Encode output as utf-8 */
    if(x &lt;= 0x7F)
      output += String.fromCharCode(x);
    else if(x &lt;= 0x7FF)
      output += String.fromCharCode(0xC0 | ((x &gt;&gt;&gt; 6 ) &amp; 0x1F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0xFFFF)
      output += String.fromCharCode(0xE0 | ((x &gt;&gt;&gt; 12) &amp; 0x0F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
    else if(x &lt;= 0x1FFFFF)
      output += String.fromCharCode(0xF0 | ((x &gt;&gt;&gt; 18) &amp; 0x07),
                                    0x80 | ((x &gt;&gt;&gt; 12) &amp; 0x3F),
                                    0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
                                    0x80 | ( x         &amp; 0x3F));
  }
  return output;
}

/*
 * Encode a string as utf-16
 */
function str2rstr_utf16le(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode( input.charCodeAt(i)        &amp; 0xFF,
                                  (input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF);
  return output;
}

function str2rstr_utf16be(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length; i++)
    output += String.fromCharCode((input.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF,
                                   input.charCodeAt(i)        &amp; 0xFF);
  return output;
}

/*
 * Convert a raw string to an array of little-endian words
 * Characters &gt;255 have their high-byte silently ignored.
 */
function rstr2binl(input)
{
  var output = Array(input.length &gt;&gt; 2);
  for(var i = 0; i &lt; output.length; i++)
    output[i] = 0;
  for(var i = 0; i &lt; input.length * 8; i += 8)
    output[i&gt;&gt;5] |= (input.charCodeAt(i / 8) &amp; 0xFF) &lt;&lt; (i%32);
  return output;
}

/*
 * Convert an array of little-endian words to a string
 */
function binl2rstr(input)
{
  var output = &quot;&quot;;
  for(var i = 0; i &lt; input.length * 32; i += 8)
    output += String.fromCharCode((input[i&gt;&gt;5] &gt;&gt;&gt; (i % 32)) &amp; 0xFF);
  return output;
}

/*
 * Calculate the MD5 of an array of little-endian words, and a bit length.
 */
function binl_md5(x, len)
{
  /* append padding */
  x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((len) % 32);
  x[(((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14] = len;

  var a =  1732584193;
  var b = -271733879;
  var c = -1732584194;
  var d =  271733878;

  for(var i = 0; i &lt; x.length; i += 16)
  {
    var olda = a;
    var oldb = b;
    var oldc = c;
    var oldd = d;

    a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
    d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
    c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
    b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
    a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
    d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
    c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
    b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
    a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
    d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
    c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
    b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
    a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
    d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
    c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
    b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);

    a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
    d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
    c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
    b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
    a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
    d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
    c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
    b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
    a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
    d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
    c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
    b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
    a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
    d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
    c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
    b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);

    a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
    d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
    c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
    b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
    a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
    d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
    c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
    b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
    a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
    d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
    c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
    b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
    a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
    d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
    c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
    b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);

    a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
    d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
    c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
    b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
    a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
    d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
    c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
    b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
    a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
    d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
    c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
    b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
    a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
    d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
    c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
    b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);

    a = safe_add(a, olda);
    b = safe_add(b, oldb);
    c = safe_add(c, oldc);
    d = safe_add(d, oldd);
  }
  return Array(a, b, c, d);
}

/*
 * These functions implement the four basic operations the algorithm uses.
 */
function md5_cmn(q, a, b, x, s, t)
{
  return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b);
}
function md5_ff(a, b, c, d, x, s, t)
{
  return md5_cmn((b &amp; c) | ((~b) &amp; d), a, b, x, s, t);
}
function md5_gg(a, b, c, d, x, s, t)
{
  return md5_cmn((b &amp; d) | (c &amp; (~d)), a, b, x, s, t);
}
function md5_hh(a, b, c, d, x, s, t)
{
  return md5_cmn(b ^ c ^ d, a, b, x, s, t);
}
function md5_ii(a, b, c, d, x, s, t)
{
  return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
}

/*
 * Add integers, wrapping at 2^32. This uses 16-bit operations internally
 * to work around bugs in some JS interpreters.
 */
function safe_add(x, y)
{
  var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
  var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
  return (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
}

/*
 * Bitwise rotate a 32-bit number to the left.
 */
function bit_rol(num, cnt)
{
  return (num &lt;&lt; cnt) | (num &gt;&gt;&gt; (32 - cnt));
}// --FILE BOUNDARY-- // --FILE BOUNDARY-- // --FILE BOUNDARY--
//\/////
//\  overLIB 4.21 - You may not remove or change this notice.
//\  Copyright Erik Bosrup 1998-2004. All rights reserved.
//\
//\  Contributors are listed on the homepage.
//\  This file might be old, always check for the latest version at:
//\  http://www.bosrup.com/web/overlib/
//\
//\  Please read the license agreement (available through the link above)
//\  before using overLIB. Direct any licensing questions to erik@bosrup.com.
//\
//\  Do not sell this as your own work or remove this copyright notice. 
//\  For full details on copying or changing this script please read the
//\  license agreement at the link above. Please give credit on sites that
//\  use overLIB and submit changes of the script so other people can use
//\  them as well.
//\/////
//\  THIS IS A VERY MODIFIED VERSION. DO NOT EDIT OR PUBLISH. GET THE ORIGINAL!
var olLoaded=0,pmStart=10000000,pmUpper=10001000,pmCount=pmStart+1,pmt='',pms=new Array(),olInfo=new Info('4.21',1),FREPLACE=0,FBEFORE=1,FAFTER=2,FALTERNATE=3,FCHAIN=4,olHideForm=0,olHautoFlag=0,olVautoFlag=0,hookPts=new Array(),postParse=new Array(),cmdLine=new Array(),runTime=new Array();
registerCommands('donothing,inarray,caparray,sticky,background,noclose,caption,left,right,center,offsetx,offsety,fgcolor,bgcolor,textcolor,capcolor,closecolor,width,border,cellpad,status,autostatus,autostatuscap,height,closetext,snapx,snapy,fixx,fixy,relx,rely,fgbackground,bgbackground,padx,pady,fullhtml,above,below,capicon,textfont,captionfont,closefont,textsize,captionsize,closesize,timeout,function,delay,hauto,vauto,closeclick,wrap,followmouse,mouseoff,closetitle,cssoff,compatmode,cssclass,fgclass,bgclass,textfontclass,captionfontclass,closefontclass');
if(typeof ol_fgcolor=='undefined')var ol_fgcolor=&quot;#CCCCFF&quot;;if(typeof ol_bgcolor=='undefined')var ol_bgcolor=&quot;#333399&quot;;if(typeof ol_textcolor=='undefined')var ol_textcolor=&quot;#000000&quot;;if(typeof ol_capcolor=='undefined')var ol_capcolor=&quot;#FFFFFF&quot;;if(typeof ol_closecolor=='undefined')var ol_closecolor=&quot;#9999FF&quot;;if(typeof ol_textfont=='undefined')var ol_textfont=&quot;Verdana,Arial,Helvetica&quot;;if(typeof ol_captionfont=='undefined')var ol_captionfont=&quot;Verdana,Arial,Helvetica&quot;;if(typeof ol_closefont=='undefined')var ol_closefont=&quot;Verdana,Arial,Helvetica&quot;;if(typeof ol_textsize=='undefined')var ol_textsize=&quot;1&quot;;if(typeof ol_captionsize=='undefined')var ol_captionsize=&quot;1&quot;;if(typeof ol_closesize=='undefined')var ol_closesize=&quot;1&quot;;if(typeof ol_width=='undefined')var ol_width=&quot;200&quot;;if(typeof ol_border=='undefined')var ol_border=&quot;1&quot;;if(typeof ol_cellpad=='undefined')var ol_cellpad=2;if(typeof ol_offsetx=='undefined')var ol_offsetx=10;if(typeof ol_offsety=='undefined')var ol_offsety=10;if(typeof ol_text=='undefined')var ol_text=&quot;Default Text&quot;;if(typeof ol_cap=='undefined')var ol_cap=&quot;&quot;;if(typeof ol_sticky=='undefined')var ol_sticky=0;if(typeof ol_background=='undefined')var ol_background=&quot;&quot;;if(typeof ol_close=='undefined')var ol_close=&quot;Close&quot;;if(typeof ol_hpos=='undefined')var ol_hpos=RIGHT;if(typeof ol_status=='undefined')var ol_status=&quot;&quot;;if(typeof ol_autostatus=='undefined')var ol_autostatus=0;if(typeof ol_height=='undefined')var ol_height=-1;if(typeof ol_snapx=='undefined')var ol_snapx=0;if(typeof ol_snapy=='undefined')var ol_snapy=0;if(typeof ol_fixx=='undefined')var ol_fixx=-1;if(typeof ol_fixy=='undefined')var ol_fixy=-1;if(typeof ol_relx=='undefined')var ol_relx=null;if(typeof ol_rely=='undefined')var ol_rely=null;if(typeof ol_fgbackground=='undefined')var ol_fgbackground=&quot;&quot;;if(typeof ol_bgbackground=='undefined')var ol_bgbackground=&quot;&quot;;if(typeof ol_padxl=='undefined')var ol_padxl=1;if(typeof ol_padxr=='undefined')var ol_padxr=1;if(typeof ol_padyt=='undefined')var ol_padyt=1;if(typeof ol_padyb=='undefined')var ol_padyb=1;if(typeof ol_fullhtml=='undefined')var ol_fullhtml=0;if(typeof ol_vpos=='undefined')var ol_vpos=BELOW;if(typeof ol_aboveheight=='undefined')var ol_aboveheight=0;if(typeof ol_capicon=='undefined')var ol_capicon=&quot;&quot;;if(typeof ol_frame=='undefined')var ol_frame=self;if(typeof ol_timeout=='undefined')var ol_timeout=0;if(typeof ol_function=='undefined')var ol_function=null;if(typeof ol_delay=='undefined')var ol_delay=0;if(typeof ol_hauto=='undefined')var ol_hauto=0;if(typeof ol_vauto=='undefined')var ol_vauto=0;if(typeof ol_closeclick=='undefined')var ol_closeclick=0;if(typeof ol_wrap=='undefined')var ol_wrap=0;if(typeof ol_followmouse=='undefined')var ol_followmouse=1;if(typeof ol_mouseoff=='undefined')var ol_mouseoff=0;if(typeof ol_closetitle=='undefined')var ol_closetitle='Close';if(typeof ol_compatmode=='undefined')var ol_compatmode=0;if(typeof ol_css=='undefined')var ol_css=CSSOFF;if(typeof ol_fgclass=='undefined')var ol_fgclass=&quot;&quot;;if(typeof ol_bgclass=='undefined')var ol_bgclass=&quot;&quot;;if(typeof ol_textfontclass=='undefined')var ol_textfontclass=&quot;&quot;;if(typeof ol_captionfontclass=='undefined')var ol_captionfontclass=&quot;&quot;;if(typeof ol_closefontclass=='undefined')var ol_closefontclass=&quot;&quot;;
if(typeof ol_texts=='undefined')var ol_texts=new Array(&quot;Text 0&quot;,&quot;Text 1&quot;);if(typeof ol_caps=='undefined')var ol_caps=new Array(&quot;Caption 0&quot;,&quot;Caption 1&quot;);
var o3_text=&quot;&quot;,o3_cap=&quot;&quot;,o3_sticky=0,o3_background=&quot;&quot;,o3_close=&quot;Close&quot;,o3_hpos=RIGHT,o3_offsetx=2,o3_offsety=2,o3_fgcolor=&quot;&quot;,o3_bgcolor=&quot;&quot;,o3_textcolor=&quot;&quot;,o3_capcolor=&quot;&quot;,o3_closecolor=&quot;&quot;,o3_width=100,o3_border=1,o3_cellpad=2,o3_status=&quot;&quot;,o3_autostatus=0,o3_height=-1,o3_snapx=0,o3_snapy=0,o3_fixx=-1,o3_fixy=-1,o3_relx=null,o3_rely=null,o3_fgbackground=&quot;&quot;,o3_bgbackground=&quot;&quot;,o3_padxl=0,o3_padxr=0,o3_padyt=0,o3_padyb=0,o3_fullhtml=0,o3_vpos=BELOW,o3_aboveheight=0,o3_capicon=&quot;&quot;,o3_textfont=&quot;Verdana,Arial,Helvetica&quot;,o3_captionfont=&quot;Verdana,Arial,Helvetica&quot;,o3_closefont=&quot;Verdana,Arial,Helvetica&quot;,o3_textsize=&quot;1&quot;,o3_captionsize=&quot;1&quot;,o3_closesize=&quot;1&quot;,o3_frame=self,o3_timeout=0,o3_timerid=0,o3_allowmove=0,o3_function=null,o3_delay=0,o3_delayid=0,o3_hauto=0,o3_vauto=0,o3_closeclick=0,o3_wrap=0,o3_followmouse=1,o3_mouseoff=0,o3_closetitle='',o3_compatmode=0,o3_css=CSSOFF,o3_fgclass=&quot;&quot;,o3_bgclass=&quot;&quot;,o3_textfontclass=&quot;&quot;,o3_captionfontclass=&quot;&quot;,o3_closefontclass=&quot;&quot;;
var o3_x=0,o3_y=0,o3_showingsticky=0,o3_removecounter=0;
var over=null,fnRef,hoveringSwitch=false,olHideDelay;
var isMac=(navigator.userAgent.indexOf(&quot;Mac&quot;)!=-1),olOp=(navigator.userAgent.toLowerCase().indexOf('opera')&gt;-1&amp;&amp;document.createTextNode),olNs4=(navigator.appName=='Netscape'&amp;&amp;parseInt(navigator.appVersion)==4),olNs6=(document.getElementById)?true:false,olKq=(olNs6&amp;&amp;/konqueror/i.test(navigator.userAgent)),olIe4=(document.all)?true:false,olIe5=false,olIe55=false,docRoot='document.body';
if(olNs4){var oW=window.innerWidth;var oH=window.innerHeight;window.onresize=function(){if(oW!=window.innerWidth||oH!=window.innerHeight)location.reload();}}
if(olIe4){var agent=navigator.userAgent;if(/MSIE/.test(agent)){var versNum=parseFloat(agent.match(/MSIE[ ](\d\.\d+)\.*/i)[1]);if(versNum&gt;=5){olIe5=true;olIe55=(versNum&gt;=5.5&amp;&amp;!olOp)?true:false;if(olNs6)olNs6=false;}}
if(olNs6)olIe4=false;}
if(document.compatMode&amp;&amp;document.compatMode=='CSS1Compat'){docRoot=((olIe4&amp;&amp;!olOp)?'document.documentElement':docRoot);}
if(window.addEventListener)window.addEventListener(&quot;load&quot;,OLonLoad_handler,false);else if(window.attachEvent)window.attachEvent(&quot;onload&quot;,OLonLoad_handler);
var capExtent;
function overlib(){if(!olLoaded||isExclusive(overlib.arguments))return true;if(olCheckMouseCapture)olMouseCapture();if(over){over=(typeof over.id!='string')?o3_frame.document.all['overDiv']:over;cClick();}
olHideDelay=0;o3_text=ol_text;o3_cap=ol_cap;o3_sticky=ol_sticky;o3_background=ol_background;o3_close=ol_close;o3_hpos=ol_hpos;o3_offsetx=ol_offsetx;o3_offsety=ol_offsety;o3_fgcolor=ol_fgcolor;o3_bgcolor=ol_bgcolor;o3_textcolor=ol_textcolor;o3_capcolor=ol_capcolor;o3_closecolor=ol_closecolor;o3_width=ol_width;o3_border=ol_border;o3_cellpad=ol_cellpad;o3_status=ol_status;o3_autostatus=ol_autostatus;o3_height=ol_height;o3_snapx=ol_snapx;o3_snapy=ol_snapy;o3_fixx=ol_fixx;o3_fixy=ol_fixy;o3_relx=ol_relx;o3_rely=ol_rely;o3_fgbackground=ol_fgbackground;o3_bgbackground=ol_bgbackground;o3_padxl=ol_padxl;o3_padxr=ol_padxr;o3_padyt=ol_padyt;o3_padyb=ol_padyb;o3_fullhtml=ol_fullhtml;o3_vpos=ol_vpos;o3_aboveheight=ol_aboveheight;o3_capicon=ol_capicon;o3_textfont=ol_textfont;o3_captionfont=ol_captionfont;o3_closefont=ol_closefont;o3_textsize=ol_textsize;o3_captionsize=ol_captionsize;o3_closesize=ol_closesize;o3_timeout=ol_timeout;o3_function=ol_function;o3_delay=ol_delay;o3_hauto=ol_hauto;o3_vauto=ol_vauto;o3_closeclick=ol_closeclick;o3_wrap=ol_wrap;o3_followmouse=ol_followmouse;o3_mouseoff=ol_mouseoff;o3_closetitle=ol_closetitle;o3_css=ol_css;o3_compatmode=ol_compatmode;o3_fgclass=ol_fgclass;o3_bgclass=ol_bgclass;o3_textfontclass=ol_textfontclass;o3_captionfontclass=ol_captionfontclass;o3_closefontclass=ol_closefontclass;
setRunTimeVariables();
fnRef='';
o3_frame=ol_frame;
if(!(over=createDivContainer()))return false;
parseTokens('o3_',overlib.arguments);if(!postParseChecks())return false;
if(o3_delay==0){return runHook(&quot;olMain&quot;,FREPLACE);}else{o3_delayid=setTimeout(&quot;runHook('olMain',FREPLACE)&quot;,o3_delay);return false;}}
function nd(time){if(olLoaded&amp;&amp;!isExclusive()){hideDelay(time);
if(o3_removecounter&gt;=1){o3_showingsticky=0 };
if(o3_showingsticky==0){o3_allowmove=0;if(over!=null&amp;&amp;o3_timerid==0)runHook(&quot;hideObject&quot;,FREPLACE,over);}else{o3_removecounter++;}}
return true;}
function cClick(){if(olLoaded){runHook(&quot;hideObject&quot;,FREPLACE,over);o3_showingsticky=0;}
return false;}
function overlib_pagedefaults(){parseTokens('ol_',overlib_pagedefaults.arguments);}
function olMain(){var layerhtml,styleType;runHook(&quot;olMain&quot;,FBEFORE);
if(o3_background!=&quot;&quot;||o3_fullhtml){
layerhtml=runHook('ol_content_background',FALTERNATE,o3_css,o3_text,o3_background,o3_fullhtml);}else{
styleType=(pms[o3_css-1-pmStart]==&quot;cssoff&quot;||pms[o3_css-1-pmStart]==&quot;cssclass&quot;);
if(o3_fgbackground!=&quot;&quot;)o3_fgbackground=&quot;background=\&quot;&quot;+o3_fgbackground+&quot;\&quot;&quot;;if(o3_bgbackground!=&quot;&quot;)o3_bgbackground=(styleType?&quot;background=\&quot;&quot;+o3_bgbackground+&quot;\&quot;&quot;:o3_bgbackground);
if(o3_fgcolor!=&quot;&quot;)o3_fgcolor=(styleType?&quot;bgcolor=\&quot;&quot;+o3_fgcolor+&quot;\&quot;&quot;:o3_fgcolor);if(o3_bgcolor!=&quot;&quot;)o3_bgcolor=(styleType?&quot;bgcolor=\&quot;&quot;+o3_bgcolor+&quot;\&quot;&quot;:o3_bgcolor);
if(o3_height&gt;0)o3_height=(styleType?&quot;height=\&quot;&quot;+o3_height+&quot;\&quot;&quot;:o3_height);else o3_height=&quot;&quot;;
if(o3_cap==&quot;&quot;){
layerhtml=runHook('ol_content_simple',FALTERNATE,o3_css,o3_text);}else{
if(o3_sticky){
layerhtml=runHook('ol_content_caption',FALTERNATE,o3_css,o3_text,o3_cap,o3_close);}else{
layerhtml=runHook('ol_content_caption',FALTERNATE,o3_css,o3_text,o3_cap,&quot;&quot;);}}}
if(o3_sticky){if(o3_timerid&gt;0){clearTimeout(o3_timerid);o3_timerid=0;}
o3_showingsticky=1;o3_removecounter=0;}
if(!runHook(&quot;createPopup&quot;,FREPLACE,layerhtml))return false;
if(o3_autostatus&gt;0){o3_status=o3_text;if(o3_autostatus&gt;1)o3_status=o3_cap;}
o3_allowmove=0;
if(o3_timeout&gt;0){if(o3_timerid&gt;0)clearTimeout(o3_timerid);o3_timerid=setTimeout(&quot;cClick()&quot;,o3_timeout);}
runHook(&quot;disp&quot;,FREPLACE,o3_status);runHook(&quot;olMain&quot;,FAFTER);
return(olOp&amp;&amp;event&amp;&amp;event.type=='mouseover'&amp;&amp;!o3_status)?'':(o3_status!='');}
function ol_content_simple(text){var cpIsMultiple=/,/.test(o3_cellpad);var txt='&lt;table width=&quot;'+o3_width+'&quot; border=&quot;0&quot; cellpadding=&quot;'+o3_border+'&quot; cellspacing=&quot;0&quot; '+(o3_bgclass?'class=&quot;'+o3_bgclass+'&quot;':o3_bgcolor+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; '+((olNs4||!cpIsMultiple)?'cellpadding=&quot;'+o3_cellpad+'&quot; ':'')+'cellspacing=&quot;0&quot; '+(o3_fgclass?'class=&quot;'+o3_fgclass+'&quot;':o3_fgcolor+' '+o3_fgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td valign=&quot;TOP&quot;'+(o3_textfontclass?' class=&quot;'+o3_textfontclass+'&quot;&gt;':((!olNs4&amp;&amp;cpIsMultiple)?' style=&quot;'+setCellPadStr(o3_cellpad)+'&quot;&gt;':'&gt;'))+(o3_textfontclass?'':wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass?'':wrapStr(1,o3_textsize))+'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
set_background(&quot;&quot;);return txt;}
function ol_content_caption(text,title,close){var nameId,txt,cpIsMultiple=/,/.test(o3_cellpad);var closing,closeevent;
closing=&quot;&quot;;closeevent=&quot;onmouseover&quot;;if(o3_closeclick==1)closeevent=(o3_closetitle?&quot;title='&quot;+o3_closetitle+&quot;'&quot;:&quot;&quot;)+&quot; onclick&quot;;if(o3_capicon!=&quot;&quot;){nameId=' hspace=\&quot;5\&quot;'+' align=\&quot;middle\&quot; alt=\&quot;\&quot;';if(typeof o3_dragimg!='undefined'&amp;&amp;o3_dragimg)nameId=' hspace=\&quot;5\&quot;'+' name=\&quot;'+o3_dragimg+'\&quot; id=\&quot;'+o3_dragimg+'\&quot; align=\&quot;middle\&quot; alt=\&quot;Drag Enabled\&quot; title=\&quot;Drag Enabled\&quot;';o3_capicon='&lt;img src=\&quot;'+o3_capicon+'\&quot;'+nameId+' /&gt;';}
if(close!=&quot;&quot;)
closing='&lt;td '+(!o3_compatmode&amp;&amp;o3_closefontclass?'class=&quot;'+o3_closefontclass:'align=&quot;RIGHT')+'&quot;&gt;&lt;a href=&quot;javascript:return '+fnRef+'cClick();&quot;'+((o3_compatmode&amp;&amp;o3_closefontclass)?' class=&quot;'+o3_closefontclass+'&quot; ':' ')+closeevent+'=&quot;return '+fnRef+'cClick();&quot;&gt;'+(o3_closefontclass?'':wrapStr(0,o3_closesize,'close'))+close+(o3_closefontclass?'':wrapStr(1,o3_closesize,'close'))+'&lt;/a&gt;&lt;/td&gt;';txt='&lt;table width=&quot;'+o3_width+'&quot; border=&quot;0&quot; cellpadding=&quot;'+o3_border+'&quot; cellspacing=&quot;0&quot; '+(o3_bgclass?'class=&quot;'+o3_bgclass+'&quot;':o3_bgcolor+' '+o3_bgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td'+(o3_captionfontclass?' class=&quot;'+o3_captionfontclass+'&quot;&gt;':'&gt;')+(o3_captionfontclass?'':'&lt;b&gt;'+wrapStr(0,o3_captionsize,'caption'))+o3_capicon+title+(o3_captionfontclass?'':wrapStr(1,o3_captionsize)+'&lt;/b&gt;')+'&lt;/td&gt;'+closing+'&lt;/tr&gt;&lt;/table&gt;&lt;table width=&quot;100%&quot; border=&quot;0&quot; '+((olNs4||!cpIsMultiple)?'cellpadding=&quot;'+o3_cellpad+'&quot; ':'')+'cellspacing=&quot;0&quot; '+(o3_fgclass?'class=&quot;'+o3_fgclass+'&quot;':o3_fgcolor+' '+o3_fgbackground+' '+o3_height)+'&gt;&lt;tr&gt;&lt;td valign=&quot;TOP&quot;'+(o3_textfontclass?' class=&quot;'+o3_textfontclass+'&quot;&gt;' :((!olNs4&amp;&amp;cpIsMultiple)?' style=&quot;'+setCellPadStr(o3_cellpad)+'&quot;&gt;':'&gt;'))+(o3_textfontclass?'':wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass?'':wrapStr(1,o3_textsize))+'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
set_background(&quot;&quot;);return txt;}
function ol_content_background(text,picture,hasfullhtml){if(hasfullhtml){txt=text;}else{txt='&lt;table width=&quot;'+o3_width+'&quot; border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; height=&quot;'+o3_height+'&quot;&gt;&lt;tr&gt;&lt;td colspan=&quot;3&quot; height=&quot;'+o3_padyt+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td width=&quot;'+o3_padxl+'&quot;&gt;&lt;/td&gt;&lt;td valign=&quot;TOP&quot; width=&quot;'+(o3_width-o3_padxl-o3_padxr)+(o3_textfontclass?'&quot; class=&quot;'+o3_textfontclass:'')+'&quot;&gt;'+(o3_textfontclass?'':wrapStr(0,o3_textsize,'text'))+text+(o3_textfontclass?'':wrapStr(1,o3_textsize))+'&lt;/td&gt;&lt;td width=&quot;'+o3_padxr+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&quot;3&quot; height=&quot;'+o3_padyb+'&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';}
set_background(picture);return txt;}
function set_background(pic){if(pic==&quot;&quot;){if(olNs4){over.background.src=null;}else if(over.style){over.style.backgroundImage=&quot;none&quot;;}
}else{if(olNs4){over.background.src=pic;}else if(over.style){over.style.width=o3_width+'px';over.style.backgroundImage=&quot;url(&quot;+pic+&quot;)&quot;;}}}
var olShowId=-1;
function disp(statustext){runHook(&quot;disp&quot;,FBEFORE);
if(o3_allowmove==0){runHook(&quot;placeLayer&quot;,FREPLACE);(olNs6&amp;&amp;olShowId&lt;0)?olShowId=setTimeout(&quot;runHook('showObject',FREPLACE,over)&quot;,1):runHook(&quot;showObject&quot;,FREPLACE,over);o3_allowmove=(o3_sticky||o3_followmouse==0)?0:1;}
runHook(&quot;disp&quot;,FAFTER);
if(statustext!=&quot;&quot;)self.status=statustext;}
function createPopup(lyrContent){runHook(&quot;createPopup&quot;,FBEFORE);
if(o3_wrap){var wd,ww,theObj=(olNs4?over:over.style);theObj.top=theObj.left=((olIe4&amp;&amp;!olOp)?0:-10000)+(!olNs4?'px':0);layerWrite(lyrContent);wd=(olNs4?over.clip.width:over.offsetWidth);if(wd&gt;(ww=windowWidth())){lyrContent=lyrContent.replace(/\&amp;nbsp;/g,' ');o3_width=ww;o3_wrap=0;}}
layerWrite(lyrContent);
if(o3_wrap)o3_width=(olNs4?over.clip.width:over.offsetWidth);
runHook(&quot;createPopup&quot;,FAFTER,lyrContent);
return true;}
function placeLayer(){var placeX,placeY,widthFix=0;
if(o3_frame.innerWidth)widthFix=18;iwidth=windowWidth();
winoffset=(olIe4)?eval('o3_frame.'+docRoot+'.scrollLeft'):o3_frame.pageXOffset;
placeX=runHook('horizontalPlacement',FCHAIN,iwidth,winoffset,widthFix);
if(o3_frame.innerHeight){iheight=o3_frame.innerHeight;}else if(eval('o3_frame.'+docRoot)&amp;&amp;eval(&quot;typeof o3_frame.&quot;+docRoot+&quot;.clientHeight=='number'&quot;)&amp;&amp;eval('o3_frame.'+docRoot+'.clientHeight')){iheight=eval('o3_frame.'+docRoot+'.clientHeight');}
scrolloffset=(olIe4)?eval('o3_frame.'+docRoot+'.scrollTop'):o3_frame.pageYOffset;placeY=runHook('verticalPlacement',FCHAIN,iheight,scrolloffset);
repositionTo(over,placeX,placeY);}
function olMouseMove(e){var e=(e)?e:event;
if(e.pageX){o3_x=e.pageX;o3_y=e.pageY;}else if(e.clientX){o3_x=eval('e.clientX+o3_frame.'+docRoot+'.scrollLeft');o3_y=eval('e.clientY+o3_frame.'+docRoot+'.scrollTop');}
if(o3_allowmove==1)runHook(&quot;placeLayer&quot;,FREPLACE);
if(hoveringSwitch&amp;&amp;!olNs4&amp;&amp;runHook(&quot;cursorOff&quot;,FREPLACE)){(olHideDelay?hideDelay(olHideDelay):cClick());hoveringSwitch=!hoveringSwitch;}}
function no_overlib(){return ver3fix;}
function olMouseCapture(){capExtent=document;var fN,str='',l,k,f,wMv,sS,mseHandler=olMouseMove;var re=/function[ ]*(\w*)\(/;
wMv=(!olIe4&amp;&amp;window.onmousemove);if(document.onmousemove||wMv){if(wMv)capExtent=window;f=capExtent.onmousemove.toString();fN=f.match(re);if(fN==null){str=f+'(e);';}else if(fN[1]=='anonymous'||fN[1]=='olMouseMove'||(wMv&amp;&amp;fN[1]=='onmousemove')){if(!olOp&amp;&amp;wMv){l=f.indexOf('{')+1;k=f.lastIndexOf('}');sS=f.substring(l,k);if((l=sS.indexOf('('))!=-1){sS=sS.substring(0,l).replace(/^\s+/,'').replace(/\s+$/,'');if(eval(&quot;typeof &quot;+sS+&quot;=='undefined'&quot;))window.onmousemove=null;else str=sS+'(e);';}}
if(!str){olCheckMouseCapture=false;return;}
}else{if(fN[1])str=fN[1]+'(e);';else{l=f.indexOf('{')+1;k=f.lastIndexOf('}');str=f.substring(l,k)+'\n';}}
str+='olMouseMove(e);';mseHandler=new Function('e',str);}
capExtent.onmousemove=mseHandler;if(olNs4)capExtent.captureEvents(Event.MOUSEMOVE);}
function parseTokens(pf,ar){
var v,i,mode=-1,par=(pf!='ol_'),fnMark=(par&amp;&amp;!ar.length?1:0);
for(i=0;i&lt;ar.length;i++){if(mode&lt;0){
if(typeof ar[i]=='number'&amp;&amp;ar[i]&gt;pmStart&amp;&amp;ar[i]&lt;pmUpper){fnMark=(par?1:0);i--;}else{switch(pf){case 'ol_':
ol_text=ar[i].toString();break;default:
o3_text=ar[i].toString();}}
mode=0;}else{
if(ar[i]&gt;=pmCount||ar[i]==DONOTHING){continue;}
if(ar[i]==INARRAY){fnMark=0;eval(pf+'text=ol_texts['+ar[++i]+'].toString()');continue;}
if(ar[i]==CAPARRAY){eval(pf+'cap=ol_caps['+ar[++i]+'].toString()');continue;}
if(ar[i]==STICKY){if(pf!='ol_')eval(pf+'sticky=1');continue;}
if(ar[i]==BACKGROUND){eval(pf+'background=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==NOCLOSE){if(pf!='ol_')opt_NOCLOSE();continue;}
if(ar[i]==CAPTION){eval(pf+&quot;cap='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==CENTER||ar[i]==LEFT||ar[i]==RIGHT){eval(pf+'hpos='+ar[i]);if(pf!='ol_')olHautoFlag=1;continue;}
if(ar[i]==OFFSETX){eval(pf+'offsetx='+ar[++i]);continue;}
if(ar[i]==OFFSETY){eval(pf+'offsety='+ar[++i]);continue;}
if(ar[i]==FGCOLOR){eval(pf+'fgcolor=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==BGCOLOR){eval(pf+'bgcolor=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==TEXTCOLOR){eval(pf+'textcolor=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CAPCOLOR){eval(pf+'capcolor=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CLOSECOLOR){eval(pf+'closecolor=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==WIDTH){eval(pf+'width='+ar[++i]);continue;}
if(ar[i]==BORDER){eval(pf+'border='+ar[++i]);continue;}
if(ar[i]==CELLPAD){i=opt_MULTIPLEARGS(++i,ar,(pf+'cellpad'));continue;}
if(ar[i]==STATUS){eval(pf+&quot;status='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==AUTOSTATUS){eval(pf+'autostatus=('+pf+'autostatus==1)?0:1');continue;}
if(ar[i]==AUTOSTATUSCAP){eval(pf+'autostatus=('+pf+'autostatus==2)?0:2');continue;}
if(ar[i]==HEIGHT){eval(pf+'height='+pf+'aboveheight='+ar[++i]);continue;}
if(ar[i]==CLOSETEXT){eval(pf+&quot;close='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==SNAPX){eval(pf+'snapx='+ar[++i]);continue;}
if(ar[i]==SNAPY){eval(pf+'snapy='+ar[++i]);continue;}
if(ar[i]==FIXX){eval(pf+'fixx='+ar[++i]);continue;}
if(ar[i]==FIXY){eval(pf+'fixy='+ar[++i]);continue;}
if(ar[i]==RELX){eval(pf+'relx='+ar[++i]);continue;}
if(ar[i]==RELY){eval(pf+'rely='+ar[++i]);continue;}
if(ar[i]==FGBACKGROUND){eval(pf+'fgbackground=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==BGBACKGROUND){eval(pf+'bgbackground=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==PADX){eval(pf+'padxl='+ar[++i]);eval(pf+'padxr='+ar[++i]);continue;}
if(ar[i]==PADY){eval(pf+'padyt='+ar[++i]);eval(pf+'padyb='+ar[++i]);continue;}
if(ar[i]==FULLHTML){if(pf!='ol_')eval(pf+'fullhtml=1');continue;}
if(ar[i]==BELOW||ar[i]==ABOVE){eval(pf+'vpos='+ar[i]);if(pf!='ol_')olVautoFlag=1;continue;}
if(ar[i]==CAPICON){eval(pf+'capicon=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==TEXTFONT){eval(pf+&quot;textfont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==CAPTIONFONT){eval(pf+&quot;captionfont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==CLOSEFONT){eval(pf+&quot;closefont='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==TEXTSIZE){eval(pf+'textsize=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CAPTIONSIZE){eval(pf+'captionsize=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CLOSESIZE){eval(pf+'closesize=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==TIMEOUT){eval(pf+'timeout='+ar[++i]);continue;}
if(ar[i]==FUNCTION){if(pf=='ol_'){if(typeof ar[i+1]!='number'){v=ar[++i];ol_function=(typeof v=='function'?v:null);}}else{fnMark=0;v=null;if(typeof ar[i+1]!='number')v=ar[++i]; opt_FUNCTION(v);} continue;}
if(ar[i]==DELAY){eval(pf+'delay='+ar[++i]);continue;}
if(ar[i]==HAUTO){eval(pf+'hauto=('+pf+'hauto==0)?1:0');continue;}
if(ar[i]==VAUTO){eval(pf+'vauto=('+pf+'vauto==0)?1:0');continue;}
if(ar[i]==CLOSECLICK){eval(pf+'closeclick=('+pf+'closeclick==0)?1:0');continue;}
if(ar[i]==WRAP){eval(pf+'wrap=('+pf+'wrap==0)?1:0');continue;}
if(ar[i]==FOLLOWMOUSE){eval(pf+'followmouse=('+pf+'followmouse==1)?0:1');continue;}
if(ar[i]==MOUSEOFF){eval(pf+'mouseoff=('+pf+'mouseoff==0)?1:0');v=ar[i+1];if(pf!='ol_'&amp;&amp;eval(pf+'mouseoff')&amp;&amp;typeof v=='number'&amp;&amp;(v&lt;pmStart||v&gt;pmUpper))olHideDelay=ar[++i];continue;}
if(ar[i]==CLOSETITLE){eval(pf+&quot;closetitle='&quot;+escSglQuote(ar[++i])+&quot;'&quot;);continue;}
if(ar[i]==CSSOFF||ar[i]==CSSCLASS){eval(pf+'css='+ar[i]);continue;}
if(ar[i]==COMPATMODE){eval(pf+'compatmode=('+pf+'compatmode==0)?1:0');continue;}
if(ar[i]==FGCLASS){eval(pf+'fgclass=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==BGCLASS){eval(pf+'bgclass=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==TEXTFONTCLASS){eval(pf+'textfontclass=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CAPTIONFONTCLASS){eval(pf+'captionfontclass=&quot;'+ar[++i]+'&quot;');continue;}
if(ar[i]==CLOSEFONTCLASS){eval(pf+'closefontclass=&quot;'+ar[++i]+'&quot;');continue;}
i=parseCmdLine(pf,i,ar);}}
if(fnMark&amp;&amp;o3_function)o3_text=o3_function();
if((pf=='o3_')&amp;&amp;o3_wrap){o3_width=0;
var tReg=/&lt;.*\n*&gt;/ig;if(!tReg.test(o3_text))o3_text=o3_text.replace(/[ ]+/g,'&amp;nbsp;');if(!tReg.test(o3_cap))o3_cap=o3_cap.replace(/[ ]+/g,'&amp;nbsp;');}
if((pf=='o3_')&amp;&amp;o3_sticky){if(!o3_close&amp;&amp;(o3_frame!=ol_frame))o3_close=ol_close;if(o3_mouseoff&amp;&amp;(o3_frame==ol_frame))opt_NOCLOSE(' ');}}
function layerWrite(txt){txt+=&quot;\n&quot;;if(olNs4){var lyr=o3_frame.document.layers['overDiv'].document
lyr.write(txt)
lyr.close()
}else if(typeof over.innerHTML!='undefined'){if(olIe5&amp;&amp;isMac)over.innerHTML='';over.innerHTML=txt;}else{range=o3_frame.document.createRange();range.setStartAfter(over);domfrag=range.createContextualFragment(txt);
while(over.hasChildNodes()){over.removeChild(over.lastChild);}
over.appendChild(domfrag);}}
function showObject(obj){runHook(&quot;showObject&quot;,FBEFORE);
var theObj=(olNs4?obj:obj.style);theObj.visibility='visible';
runHook(&quot;showObject&quot;,FAFTER);}
function hideObject(obj){runHook(&quot;hideObject&quot;,FBEFORE);
var theObj=(olNs4?obj:obj.style);if(olNs6&amp;&amp;olShowId&gt;0){clearTimeout(olShowId);olShowId=0;}
theObj.visibility='hidden';theObj.top=theObj.left=((olIe4&amp;&amp;!olOp)?0:-10000)+(!olNs4?'px':0);
if(o3_timerid&gt;0)clearTimeout(o3_timerid);if(o3_delayid&gt;0)clearTimeout(o3_delayid);
o3_timerid=0;o3_delayid=0;self.status=&quot;&quot;;
if(obj.onmouseout||obj.onmouseover){if(olNs4)obj.releaseEvents(Event.MOUSEOUT||Event.MOUSEOVER);obj.onmouseout=obj.onmouseover=null;}
runHook(&quot;hideObject&quot;,FAFTER);}
function repositionTo(obj,xL,yL){var theObj=(olNs4?obj:obj.style);theObj.left=xL+(!olNs4?'px':0);theObj.top=yL+(!olNs4?'px':0);}
function cursorOff(){var left=parseInt(over.style.left);var top=parseInt(over.style.top);var right=left+(over.offsetWidth&gt;=parseInt(o3_width)?over.offsetWidth:parseInt(o3_width));var bottom=top+(over.offsetHeight&gt;=o3_aboveheight?over.offsetHeight:o3_aboveheight);
if(o3_x&lt;left||o3_x&gt;right||o3_y&lt;top||o3_y&gt;bottom)return true;
return false;}
function opt_FUNCTION(callme){o3_text=(callme?(typeof callme=='string'?(/.+\(.*\)/.test(callme)?eval(callme):callme):callme()):(o3_function?o3_function():'No Function'));
return 0;}
function opt_NOCLOSE(unused){if(!unused)o3_close=&quot;&quot;;
if(olNs4){over.captureEvents(Event.MOUSEOUT||Event.MOUSEOVER);over.onmouseover=function(){if(o3_timerid&gt;0){clearTimeout(o3_timerid);o3_timerid=0;} }
over.onmouseout=function(e){if(olHideDelay)hideDelay(olHideDelay);else cClick(e);}
}else{over.onmouseover=function(){hoveringSwitch=true;if(o3_timerid&gt;0){clearTimeout(o3_timerid);o3_timerid=0;} }}
return 0;}
function opt_MULTIPLEARGS(i,args,parameter){var k=i,re,pV,str='';
for(k=i;k&lt;args.length;k++){if(typeof args[k]=='number'&amp;&amp;args[k]&gt;pmStart)break;str+=args[k]+',';}
if(str)str=str.substring(0,--str.length);
k--;pV=(olNs4&amp;&amp;/cellpad/i.test(parameter))?str.split(',')[0]:str;eval(parameter+'=&quot;'+pV+'&quot;');
return k;}
function nbspCleanup(){if(o3_wrap){o3_text=o3_text.replace(/\&amp;nbsp;/g,' ');o3_cap=o3_cap.replace(/\&amp;nbsp;/g,' ');}}
function escSglQuote(str){return str.toString().replace(/'/g,&quot;\\'&quot;);}
function OLonLoad_handler(e){var re=/\w+\(.*\)[;\s]+/g,olre=/overlib\(|nd\(|cClick\(/,fn,l,i;
if(!olLoaded)olLoaded=1;
if(window.removeEventListener&amp;&amp;e.eventPhase==3)window.removeEventListener(&quot;load&quot;,OLonLoad_handler,false);else if(window.detachEvent){window.detachEvent(&quot;onload&quot;,OLonLoad_handler);var fN=document.body.getAttribute('onload');if(fN){fN=fN.toString().match(re);if(fN&amp;&amp;fN.length){for(i=0;i&lt;fN.length;i++){if(/anonymous/.test(fN[i]))continue;while((l=fN[i].search(/\)[;\s]+/))!=-1){fn=fN[i].substring(0,l+1);fN[i]=fN[i].substring(l+2);if(olre.test(fn))eval(fn);}}}}}}
function wrapStr(endWrap,fontSizeStr,whichString){var fontStr,fontColor,isClose=((whichString=='close')?1:0),hasDims=/[%\-a-z]+$/.test(fontSizeStr);fontSizeStr=(olNs4)?(!hasDims?fontSizeStr:'1'):fontSizeStr;if(endWrap)return(hasDims&amp;&amp;!olNs4)?(isClose?'&lt;/span&gt;':'&lt;/div&gt;'):'&lt;/font&gt;';else{fontStr='o3_'+whichString+'font';fontColor='o3_'+((whichString=='caption')? 'cap':whichString)+'color';return(hasDims&amp;&amp;!olNs4)?(isClose?'&lt;span style=&quot;font-family: '+quoteMultiNameFonts(eval(fontStr))+';color: '+eval(fontColor)+';font-size: '+fontSizeStr+';&quot;&gt;':'&lt;div style=&quot;font-family: '+quoteMultiNameFonts(eval(fontStr))+';color: '+eval(fontColor)+';font-size: '+fontSizeStr+';&quot;&gt;'):'&lt;font face=&quot;'+eval(fontStr)+'&quot; color=&quot;'+eval(fontColor)+'&quot; size=&quot;'+(parseInt(fontSizeStr)&gt;7?'7':fontSizeStr)+'&quot;&gt;';}}
function quoteMultiNameFonts(theFont){var v,pM=theFont.split(',');for(var i=0;i&lt;pM.length;i++){v=pM[i];v=v.replace(/^\s+/,'').replace(/\s+$/,'');if(/\s/.test(v)&amp;&amp;!/['&quot;]/.test(v)){v=&quot;\'&quot;+v+&quot;\'&quot;;pM[i]=v;}}
return pM.join();}
function isExclusive(args){return false;}
function setCellPadStr(parameter){var Str='',j=0,ary=new Array(),top,bottom,left,right;
Str+='padding: ';ary=parameter.replace(/\s+/g,'').split(',');
switch(ary.length){case 2:
top=bottom=ary[j];left=right=ary[++j];break;case 3:
top=ary[j];left=right=ary[++j];bottom=ary[++j];break;case 4:
top=ary[j];right=ary[++j];bottom=ary[++j];left=ary[++j];break;}
Str+=((ary.length==1)?ary[0]+'px;':top+'px '+right+'px '+bottom+'px '+left+'px;');
return Str;}
function hideDelay(time){if(time&amp;&amp;!o3_delay){if(o3_timerid&gt;0)clearTimeout(o3_timerid);
o3_timerid=setTimeout(&quot;cClick()&quot;,(o3_timeout=time));}}
function horizontalPlacement(browserWidth,horizontalScrollAmount,widthFix){var placeX,iwidth=browserWidth,winoffset=horizontalScrollAmount;var parsedWidth=parseInt(o3_width);
if(o3_fixx&gt;-1||o3_relx!=null){
placeX=(o3_relx!=null?( o3_relx&lt;0?winoffset+o3_relx+iwidth-parsedWidth-widthFix:winoffset+o3_relx):o3_fixx);}else{
if(o3_hauto==1){if((o3_x-winoffset)&gt;(iwidth/2)){o3_hpos=LEFT;}else{o3_hpos=RIGHT;}}
if(o3_hpos==CENTER){placeX=o3_x+o3_offsetx-(parsedWidth/2);
if(placeX&lt;winoffset)placeX=winoffset;}
if(o3_hpos==RIGHT){placeX=o3_x+o3_offsetx;
if((placeX+parsedWidth)&gt;(winoffset+iwidth-widthFix)){placeX=iwidth+winoffset-parsedWidth-widthFix;if(placeX&lt;0)placeX=0;}}
if(o3_hpos==LEFT){placeX=o3_x-o3_offsetx-parsedWidth;if(placeX&lt;winoffset)placeX=winoffset;}
if(o3_snapx&gt;1){var snapping=placeX % o3_snapx;
if(o3_hpos==LEFT){placeX=placeX-(o3_snapx+snapping);}else{
placeX=placeX+(o3_snapx-snapping);}
if(placeX&lt;winoffset)placeX=winoffset;}}
return placeX;}
function verticalPlacement(browserHeight,verticalScrollAmount){var placeY,iheight=browserHeight,scrolloffset=verticalScrollAmount;var parsedHeight=(o3_aboveheight?parseInt(o3_aboveheight):(olNs4?over.clip.height:over.offsetHeight));
if(o3_fixy&gt;-1||o3_rely!=null){
placeY=(o3_rely!=null?(o3_rely&lt;0?scrolloffset+o3_rely+iheight-parsedHeight:scrolloffset+o3_rely):o3_fixy);}else{
if(o3_vauto==1){if((o3_y-scrolloffset)&gt;(iheight/2)&amp;&amp;o3_vpos==BELOW&amp;&amp;(o3_y+parsedHeight+o3_offsety-(scrolloffset+iheight)&gt;0)){o3_vpos=ABOVE;}else if(o3_vpos==ABOVE&amp;&amp;(o3_y-(parsedHeight+o3_offsety)-scrolloffset&lt;0)){o3_vpos=BELOW;}}
if(o3_vpos==ABOVE){if(o3_aboveheight==0)o3_aboveheight=parsedHeight;
placeY=o3_y-(o3_aboveheight+o3_offsety);if(placeY&lt;scrolloffset)placeY=scrolloffset;}else{
placeY=o3_y+o3_offsety;}
if(o3_snapy&gt;1){var snapping=placeY % o3_snapy;
if(o3_aboveheight&gt;0&amp;&amp;o3_vpos==ABOVE){placeY=placeY-(o3_snapy+snapping);}else{placeY=placeY+(o3_snapy-snapping);}
if(placeY&lt;scrolloffset)placeY=scrolloffset;}}
return placeY;}
function checkPositionFlags(){if(olHautoFlag)olHautoFlag=o3_hauto=0;if(olVautoFlag)olVautoFlag=o3_vauto=0;return true;}
function windowWidth(){var w;if(o3_frame.innerWidth)w=o3_frame.innerWidth;else if(eval('o3_frame.'+docRoot)&amp;&amp;eval(&quot;typeof o3_frame.&quot;+docRoot+&quot;.clientWidth=='number'&quot;)&amp;&amp;eval('o3_frame.'+docRoot+'.clientWidth'))
w=eval('o3_frame.'+docRoot+'.clientWidth');return w;}
function createDivContainer(id,frm,zValue){id=(id||'overDiv'),frm=(frm||o3_frame),zValue=(zValue||1000);var objRef,divContainer=layerReference(id);
if(divContainer==null){if(olNs4){divContainer=frm.document.layers[id]=new Layer(window.innerWidth,frm);objRef=divContainer;}else{var body=(olIe4?frm.document.all.tags('BODY')[0]:frm.document.getElementsByTagName(&quot;BODY&quot;)[0]);if(olIe4&amp;&amp;!document.getElementById){body.insertAdjacentHTML(&quot;beforeEnd&quot;,'&lt;div id=&quot;'+id+'&quot;&gt;&lt;/div&gt;');divContainer=layerReference(id);}else{divContainer=frm.document.createElement(&quot;DIV&quot;);divContainer.id=id;body.appendChild(divContainer);}
objRef=divContainer.style;}
objRef.position='absolute';objRef.visibility='hidden';objRef.zIndex=zValue;if(olIe4&amp;&amp;!olOp)objRef.left=objRef.top='0px';else objRef.left=objRef.top=-10000+(!olNs4?'px':0);}
return divContainer;}
function layerReference(id){return(olNs4?o3_frame.document.layers[id]:(document.all?o3_frame.document.all[id]:o3_frame.document.getElementById(id)));}
function isFunction(fnRef){var rtn=true;
if(typeof fnRef=='object'){for(var i=0;i&lt;fnRef.length;i++){if(typeof fnRef[i]=='function')continue;rtn=false;break;}
}else if(typeof fnRef!='function'){rtn=false;}
return rtn;}
function argToString(array,strtInd,argName){var jS=strtInd,aS='',ar=array;argName=(argName?argName:'ar');
if(ar.length&gt;jS){for(var k=jS;k&lt;ar.length;k++)aS+=argName+'['+k+'], ';aS=aS.substring(0,aS.length-2);}
return aS;}
function reOrder(hookPt,fnRef,order){var newPt=new Array(),match,i,j;
if(!order||typeof order=='undefined'||typeof order=='number')return hookPt;
if(typeof order=='function'){if(typeof fnRef=='object'){newPt=newPt.concat(fnRef);}else{newPt[newPt.length++]=fnRef;}
for(i=0;i&lt;hookPt.length;i++){match=false;if(typeof fnRef=='function'&amp;&amp;hookPt[i]==fnRef){continue;}else{for(j=0;j&lt;fnRef.length;j++)if(hookPt[i]==fnRef[j]){match=true;break;}}
if(!match)newPt[newPt.length++]=hookPt[i];}
newPt[newPt.length++]=order;
}else if(typeof order=='object'){if(typeof fnRef=='object'){newPt=newPt.concat(fnRef);}else{newPt[newPt.length++]=fnRef;}
for(j=0;j&lt;hookPt.length;j++){match=false;if(typeof fnRef=='function'&amp;&amp;hookPt[j]==fnRef){continue;}else{for(i=0;i&lt;fnRef.length;i++)if(hookPt[j]==fnRef[i]){match=true;break;}}
if(!match)newPt[newPt.length++]=hookPt[j];}
for(i=0;i&lt;newPt.length;i++)hookPt[i]=newPt[i];newPt.length=0;
for(j=0;j&lt;hookPt.length;j++){match=false;for(i=0;i&lt;order.length;i++){if(hookPt[j]==order[i]){match=true;break;}}
if(!match)newPt[newPt.length++]=hookPt[j];}
newPt=newPt.concat(order);}
hookPt=newPt;
return hookPt;}
function setRunTimeVariables(){if(typeof runTime!='undefined'&amp;&amp;runTime.length){for(var k=0;k&lt;runTime.length;k++){runTime[k]();}}}
function parseCmdLine(pf,i,args){if(typeof cmdLine!='undefined'&amp;&amp;cmdLine.length){for(var k=0;k&lt;cmdLine.length;k++){var j=cmdLine[k](pf,i,args);if(j &gt;-1){i=j;break;}}}
return i;}
function postParseChecks(pf,args){if(typeof postParse!='undefined'&amp;&amp;postParse.length){for(var k=0;k&lt;postParse.length;k++){if(postParse[k](pf,args))continue;return false;}}
return true;}
function registerCommands(cmdStr){if(typeof cmdStr!='string')return;
var pM=cmdStr.split(',');pms=pms.concat(pM);
for(var i=0;i&lt; pM.length;i++){eval(pM[i].toUpperCase()+'='+pmCount++);}}
function registerNoParameterCommands(cmdStr){if(!cmdStr&amp;&amp;typeof cmdStr!='string')return;pmt=(!pmt)?cmdStr:pmt+','+cmdStr;}
function registerHook(fnHookTo,fnRef,hookType,optPm){var hookPt,last=typeof optPm;
if(fnHookTo=='plgIn'||fnHookTo=='postParse')return;if(typeof hookPts[fnHookTo]=='undefined')hookPts[fnHookTo]=new FunctionReference();
hookPt=hookPts[fnHookTo];
if(hookType!=null){if(hookType==FREPLACE){hookPt.ovload=fnRef;if(fnHookTo.indexOf('ol_content_')&gt;-1)hookPt.alt[pms[CSSOFF-1-pmStart]]=fnRef;
}else if(hookType==FBEFORE||hookType==FAFTER){var hookPt=(hookType==1?hookPt.before:hookPt.after);
if(typeof fnRef=='object'){hookPt=hookPt.concat(fnRef);}else{hookPt[hookPt.length++]=fnRef;}
if(optPm)hookPt=reOrder(hookPt,fnRef,optPm);
}else if(hookType==FALTERNATE){if(last=='number')hookPt.alt[pms[optPm-1-pmStart]]=fnRef;}else if(hookType==FCHAIN){hookPt=hookPt.chain;if(typeof fnRef=='object')hookPt=hookPt.concat(fnRef);else hookPt[hookPt.length++]=fnRef;}
return;}}
function registerRunTimeFunction(fn){if(isFunction(fn)){if(typeof fn=='object'){runTime=runTime.concat(fn);}else{runTime[runTime.length++]=fn;}}}
function registerCmdLineFunction(fn){if(isFunction(fn)){if(typeof fn=='object'){cmdLine=cmdLine.concat(fn);}else{cmdLine[cmdLine.length++]=fn;}}}
function registerPostParseFunction(fn){if(isFunction(fn)){if(typeof fn=='object'){postParse=postParse.concat(fn);}else{postParse[postParse.length++]=fn;}}}
function runHook(fnHookTo,hookType){var l=hookPts[fnHookTo],k,rtnVal=null,optPm,arS,ar=runHook.arguments;
if(hookType==FREPLACE){arS=argToString(ar,2);
if(typeof l=='undefined'||!(l=l.ovload))rtnVal=eval(fnHookTo+'('+arS+')');else rtnVal=eval('l('+arS+')');
}else if(hookType==FBEFORE||hookType==FAFTER){if(typeof l!='undefined'){l=(hookType==1?l.before:l.after);
if(l.length){arS=argToString(ar,2);for(var k=0;k&lt;l.length;k++)eval('l[k]('+arS+')');}}
}else if(hookType==FALTERNATE){optPm=ar[2];arS=argToString(ar,3);
if(typeof l=='undefined'||(l=l.alt[pms[optPm-1-pmStart]])=='undefined'){rtnVal=eval(fnHookTo+'('+arS+')');}else{rtnVal=eval('l('+arS+')');}
}else if(hookType==FCHAIN){arS=argToString(ar,2);l=l.chain;
for(k=l.length;k&gt;0;k--)if((rtnVal=eval('l[k-1]('+arS+')'))!=void(0))break;}
return rtnVal;}
function FunctionReference(){this.ovload=null;this.before=new Array();this.after=new Array();this.alt=new Array();this.chain=new Array();}
function Info(version,prerelease){this.version=version;this.prerelease=prerelease;
this.simpleversion=Math.round(this.version*100);this.major=parseInt(this.simpleversion/100);this.minor=parseInt(this.simpleversion/10)-this.major * 10;this.revision=parseInt(this.simpleversion)-this.major * 100-this.minor * 10;this.meets=meets;}
function meets(reqdVersion){return(!reqdVersion)?false:this.simpleversion&gt;=Math.round(100*parseFloat(reqdVersion));}
registerHook(&quot;ol_content_simple&quot;,ol_content_simple,FALTERNATE,CSSOFF);registerHook(&quot;ol_content_caption&quot;,ol_content_caption,FALTERNATE,CSSOFF);registerHook(&quot;ol_content_background&quot;,ol_content_background,FALTERNATE,CSSOFF);registerHook(&quot;ol_content_simple&quot;,ol_content_simple,FALTERNATE,CSSCLASS);registerHook(&quot;ol_content_caption&quot;,ol_content_caption,FALTERNATE,CSSCLASS);registerHook(&quot;ol_content_background&quot;,ol_content_background,FALTERNATE,CSSCLASS);registerPostParseFunction(checkPositionFlags);registerHook(&quot;hideObject&quot;,nbspCleanup,FAFTER);registerHook(&quot;horizontalPlacement&quot;,horizontalPlacement,FCHAIN);registerHook(&quot;verticalPlacement&quot;,verticalPlacement,FCHAIN);if(olNs4||(olIe5&amp;&amp;isMac)||olKq)olLoaded=1;registerNoParameterCommands('sticky,autostatus,autostatuscap,fullhtml,hauto,vauto,closeclick,wrap,followmouse,mouseoff,compatmode');
var olCheckMouseCapture=true;if((olNs4||olNs6||olIe4)){olMouseCapture();}else{overlib=no_overlib;nd=no_overlib;ver3fix=true;}// --FILE BOUNDARY-- // --FILE BOUNDARY-- // --FILE BOUNDARY--
/**************************************************
 * dom-drag.js
 * 09.25.2001
 * www.youngpup.net
 **************************************************
 * 10.28.2001 - fixed minor bug where events
 * sometimes fired off the handle, not the root.
 **************************************************/

// Minor modifications by [[User:Lupin]]

var Drag = {

    obj : null,

    init : function(o, oRoot, minX, maxX, minY, maxY, bSwapHorzRef, bSwapVertRef, fXMapper, fYMapper)
    {
        o.onmousedown    = Drag.start;
        o.dragging       = false;
        o.draggable      = true;
        o.hmode          = bSwapHorzRef ? false : true ;
        o.vmode          = bSwapVertRef ? false : true ;

        o.root = oRoot &amp;&amp; oRoot != null ? oRoot : o ;

        if (o.hmode  &amp;&amp; isNaN(parseInt(o.root.style.left  ))) o.root.style.left   = &quot;0px&quot;;
        if (o.vmode  &amp;&amp; isNaN(parseInt(o.root.style.top   ))) o.root.style.top    = &quot;0px&quot;;
        if (!o.hmode &amp;&amp; isNaN(parseInt(o.root.style.right ))) o.root.style.right  = &quot;0px&quot;;
        if (!o.vmode &amp;&amp; isNaN(parseInt(o.root.style.bottom))) o.root.style.bottom = &quot;0px&quot;;

        o.minX    = typeof minX != 'undefined' ? minX : null;
        o.minY    = typeof minY != 'undefined' ? minY : null;
        o.maxX    = typeof maxX != 'undefined' ? maxX : null;
        o.maxY    = typeof maxY != 'undefined' ? maxY : null;

        o.xMapper = fXMapper ? fXMapper : null;
        o.yMapper = fYMapper ? fYMapper : null;

        o.root.onDragStart    = new Function();
        o.root.onDragEnd    = new Function();
        o.root.onDrag        = new Function();
    },

    start : function(e)
    {
        var o = Drag.obj = this;
        e = Drag.fixE(e);
        var y = parseInt(o.vmode ? o.root.style.top  : o.root.style.bottom);
        var x = parseInt(o.hmode ? o.root.style.left : o.root.style.right );
        o.root.onDragStart(x, y);

        o.lastMouseX    = e.clientX;
        o.lastMouseY    = e.clientY;

        if (o.hmode) {
            if (o.minX != null)    o.minMouseX    = e.clientX - x + o.minX;
            if (o.maxX != null)    o.maxMouseX    = o.minMouseX + o.maxX - o.minX;
        } else {
            if (o.minX != null) o.maxMouseX = -o.minX + e.clientX + x;
            if (o.maxX != null) o.minMouseX = -o.maxX + e.clientX + x;
        }

        if (o.vmode) {
            if (o.minY != null)    o.minMouseY    = e.clientY - y + o.minY;
            if (o.maxY != null)    o.maxMouseY    = o.minMouseY + o.maxY - o.minY;
        } else {
            if (o.minY != null) o.maxMouseY = -o.minY + e.clientY + y;
            if (o.maxY != null) o.minMouseY = -o.maxY + e.clientY + y;
        }

        o.onmousemoveDefault    = document.onmousemove;
        o.dragging              = true;
        document.onmousemove    = Drag.drag;
        document.onmouseup      = Drag.end;

        return false;
    },

    drag : function(e)
    {
        e = Drag.fixE(e);
        var o = Drag.obj;

        var ey    = e.clientY;
        var ex    = e.clientX;
        var y = parseInt(o.vmode ? o.root.style.top  : o.root.style.bottom);
        var x = parseInt(o.hmode ? o.root.style.left : o.root.style.right );
        var nx, ny;

        if (o.minX != null) ex = o.hmode ? Math.max(ex, o.minMouseX) : Math.min(ex, o.maxMouseX);
        if (o.maxX != null) ex = o.hmode ? Math.min(ex, o.maxMouseX) : Math.max(ex, o.minMouseX);
        if (o.minY != null) ey = o.vmode ? Math.max(ey, o.minMouseY) : Math.min(ey, o.maxMouseY);
        if (o.maxY != null) ey = o.vmode ? Math.min(ey, o.maxMouseY) : Math.max(ey, o.minMouseY);

        nx = x + ((ex - o.lastMouseX) * (o.hmode ? 1 : -1));
        ny = y + ((ey - o.lastMouseY) * (o.vmode ? 1 : -1));

        if (o.xMapper)        nx = o.xMapper(y)
        else if (o.yMapper)    ny = o.yMapper(x)

        Drag.obj.root.style[o.hmode ? &quot;left&quot; : &quot;right&quot;] = nx + &quot;px&quot;;
        Drag.obj.root.style[o.vmode ? &quot;top&quot; : &quot;bottom&quot;] = ny + &quot;px&quot;;
        Drag.obj.lastMouseX    = ex;
        Drag.obj.lastMouseY    = ey;

        Drag.obj.root.onDrag(nx, ny);
        return false;
    },

    end : function()
    {
        //Document.onmousemove = null;
        document.onmousemove=Drag.obj.onmousemoveDefault;
        document.onmouseup   = null;
        Drag.obj.dragging    = false;
        Drag.obj.root.onDragEnd(    parseInt(Drag.obj.root.style[Drag.obj.hmode ? &quot;left&quot; : &quot;right&quot;]), 
                                    parseInt(Drag.obj.root.style[Drag.obj.vmode ? &quot;top&quot; : &quot;bottom&quot;]));
        Drag.obj = null;
    },

    fixE : function(e)
    {
        if (typeof e == 'undefined') e = window.event;
        if (typeof e.layerX == 'undefined') e.layerX = e.offsetX;
        if (typeof e.layerY == 'undefined') e.layerY = e.offsetY;
        return e;
    }
};

// Copyright Aaron Boodman. Saying stupid things daily since March 2001.


simplePopups=true;

//////////////////////////////////////////
// Tabs by Korath
// returns &lt;li&gt;&lt;a href=&quot;url&quot;&gt;name&lt;/a&gt;&lt;/li&gt;
/////////////////////////////////////////
function addlilink(url, name)
{
  var na = document.createElement('a');
  na.setAttribute('href', url);

  var txt = document.createTextNode(name);
  na.appendChild(txt);

  var li = document.createElement('li');
  li.appendChild(na);
  return li;
}

// appends msg to the currently-editted page, sets the summary to summ,
// and marks or unmarks the Watch this page checkbox according to watch.
function edit_summary_watch(msg, summ, watch)
{
  var f = document.editform, t = f.wpTextbox1;
  if (t.value.length &gt; 0)
    t.value += '\n';
  t.value += msg;
  f.wpSummary.value = summ;
  f.wpWatchthis.checked = watch;
}


// appends msg to the currently-editted page, sets the summary to summ,
// and marks or unmarks the Watch this page checkbox according to watch.
function add_del_tag(msg, summ, watch)
{
  var f = document.editform, t = f.wpTextbox1;
    msg += '\n';
    msg += t.value;
    t.value = msg;
  f.wpSummary.value = summ;
  f.wpWatchthis.checked = watch;
}
  
// adds various tabs to call the above
function add_tabs()
{
  var c1 = document.getElementById('column-one');
  var tabs = c1.getElementsByTagName('div')[0].getElementsByTagName('ul')[0];

  // Only add for pages with &quot;Editing User talk:&quot; somewhere in the title
  if (document.title.indexOf(&quot;Editing User talk:&quot;) != -1)
    {
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:Vanity|}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;Vanity}}&quot;, true, 1)',&quot;Vanity&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:spam1}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;spam1}}&quot;, true, 1)',&quot;Spam1&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:spam2}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;spam2}}&quot;, true, 1)',&quot;Spam2&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:rvfd|}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;rvfd}}&quot;, true, 1)',&quot;rvfd&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:blanking}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;blanking}}&quot;, true, 1)',&quot;blank&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;subst:nothanks|}} -- ~&quot; + &quot;~&quot; + &quot;~&quot; + &quot;~&quot;, &quot;{{&quot; + &quot;nothanks}}&quot;, true, 1)',&quot;nothanks&quot;));


    }
   if (document.title.indexOf(&quot;Editing User talk:&quot;) == -1 &amp;&amp; document.title.indexOf(&quot;Editing User:&quot;) == -1 &amp;&amp; document.title.indexOf(&quot;Editing &quot;) == 0)
   {

      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;db|}}&quot;, &quot;{{&quot; + &quot;db}}&quot;, true, 1)',&quot;db&quot;));
      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;dv}}&quot;, &quot;{{&quot; + &quot;dv}}&quot;, true, 1)',&quot;dv&quot;));
      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;db-empty}}&quot;, &quot;{{&quot; + &quot;db-empty}}&quot;, true, 1)',&quot;nc&quot;));
      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;db-attack}}&quot;, &quot;{{&quot; + &quot;db-attack}}&quot;, true, 1)',&quot;attack&quot;));
      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;nonsense}}&quot;, &quot;{{&quot; + &quot;nonsense}}&quot;, true, 1)',&quot;nonsense&quot;));
      tabs.appendChild(addlilink('javascript:add_del_tag(&quot;{{&quot; + &quot;PotentialVanity}}&quot;, &quot;{{&quot; + &quot;PotentialVanity}}&quot;, true, 1)',&quot;pv&quot;));
      tabs.appendChild(addlilink('javascript:edit_summary_watch(&quot;{{&quot; + &quot;stub}}&quot;, &quot;stubify&quot;, false, 1)',&quot;stub&quot;));
   }

   if (document.title.indexOf(&quot;Editing&quot;) != 0)
   {
      
   }
}

if (window.addEventListener)
  window.addEventListener(&quot;load&quot;, add_tabs, false);
else if (window.attachEvent)
  window.attachEvent(&quot;onload&quot;, add_tabs);

///////////////////////////////////////////////////////////////////
// AutoVFD by Korath
// This needs to change depending on skin used.
//////////////////////////////////////////////////////////////////
function add_link2(url, name)
{
  var na = document.createElement('a');
  na.setAttribute('href', url);
  na.appendChild(document.createTextNode(name));

  var li = document.createElement('li');
  li.appendChild(na);

  var tabs = document.getElementById('p-cactions').getElementsByTagName('ul')[0];
  tabs.appendChild(li);
}

function strip_namespace(target)
{
  var colon = target.indexOf(':');
  if (colon != -1)
    {
      var spaces = new Array('User', 'Wikipedia', 'Image', 'MediaWiki', 'Template', 'Help', 'Category');
      var ns = target.substring(0, colon);
      if (ns == '' || ns == 'Talk')
        return target.substring(colon + 1);
      else
        for (var i = 0; i &lt; spaces.length; ++i)
          {
            if (ns == spaces[i]
                || ns == spaces[i] + '_talk')
              return target.substring(colon + 1);
          }
    }

  return target;
}

function vfd()
{
  document.editform.wpTextbox1.value = '{' + '{' + 'subst:afd}}\n' + document.editform.wpTextbox1.value;
  document.editform.wpSummary.value = 'afd';

  var target = document.editform.action;
  target = target.substring(target.indexOf('title=') + 6,
                            target.lastIndexOf('&amp;action=submit'));

  var months = new Array('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December');
  var date = new Date();
  date = date.getUTCFullYear() + '_' + months[date.getUTCMonth()] + '_' + date.getUTCDate();

  var pagename = strip_namespace(target);

  window.open('/w/index.php?title=Wikipedia:Articles_for_deletion/' + pagename + '&amp;action=edit&amp;fakeaction=vfdsub&amp;faketarget=' + target,
              'Afd ' + unescape(target),
              'status,toolbar,location,menubar,directories,resizeable,scrollbars');
  window.open('/w/index.php?title=Wikipedia:Articles_for_deletion/Log/' + date + '&amp;action=edit&amp;fakeaction=vfdlist&amp;faketarget=' + pagename,
              'VfdLog ' + unescape(target),
              'status,toolbar,location,menubar,directories,resizeable,scrollbars');
}

function autovfd()
{
  if (document.title.indexOf('Editing ') == 0)
    {
      var action = '';
      var target = '';
      if (location.search)
        {
          var l = location.search.substring(1).split('&amp;');
          for (var i = 0; i &lt; l.length; ++i)
            {
              var eq = l[i].indexOf('=');
              var name = l[i].substring(0, eq);
              if (name == 'fakeaction')
                action = l[i].substring(eq + 1);
              else if (name == 'faketarget')
                target = unescape(l[i].substring(eq + 1)).replace(/_/g, ' ');
            }
        }

      if (action == 'vfdlist')
        {
          document.editform.wpTextbox1.value += '{{' + 'subst:afd3|pg=' + target + '}}\n';
          document.editform.wpSummary.value = '[[Wikipedia:Articles for deletion/' + target + ']]';
        }
      else if (action == 'vfdsub')
        {
          if (document.editform.wpTextbox1.value.length &gt; 0)
            {
              target = document.editform.action;
              target = unescape(target.substring(target.indexOf('title=') + 6, target.lastIndexOf('&amp;action=submit'))).replace(/_/g, ' ');
              window.alert(&quot;There's an old vfd at the default location already.\n\n&quot; +
                           'Please either move it out of the way (and update existing links to it), or file the Vfd by hand in another location (such as [[' + target + ' (2)]]).');
            }
          else
            document.editform.wpTextbox1.value += '{' + '{' + 'subst:afd2|pg=' + target + '|text=' + '}' + '}' +
  '-- ~' + '~' + '~' + '~\n' +
              '\n*\'\'\' \'\'\'\n*\'\'\' \'\'\'\n*\'\'\' \'\'\'\n';
        }
      else
        add_link2('javascript:vfd()', 'Afd');
    }
}

if (window.addEventListener)
  window.addEventListener('load', autovfd, false);
else if (window.attachEvent)
  window.attachEvent('onload', autovfd);

///////////////////////////////////////////////////////////////////
// AutoCopyvio - Created by bmicomp from modified autovfd
//////////////////////////////////////////////////////////////////
function add_link2(url, name)
{
  var na = document.createElement('a');
  na.setAttribute('href', url);
  na.appendChild(document.createTextNode(name));

  var li = document.createElement('li');
  li.appendChild(na);

  var tabs = document.getElementById('p-cactions').getElementsByTagName('ul')[0];
  tabs.appendChild(li);
}

function strip_namespace(target)
{
  var colon = target.indexOf(':');
  if (colon != -1)
    {
      var spaces = new Array('User', 'Wikipedia', 'Image', 'MediaWiki', 'Template', 'Help', 'Category');
      var ns = target.substring(0, colon);
      if (ns == '' || ns == 'Talk')
        return target.substring(colon + 1);
      else
        for (var i = 0; i &lt; spaces.length; ++i)
          {
            if (ns == spaces[i]
                || ns == spaces[i] + '_talk')
              return target.substring(colon + 1);
          }
    }

  return target;
}

function copyvio()
{
  document.editform.wpTextbox1.value = '{' + '{' + 'copyvio|url=}}';
  document.editform.wpSummary.value = 'copyvio';

  var target = document.editform.action;
  target = target.substring(target.indexOf('title=') + 6,
                            target.lastIndexOf('&amp;action=submit'));

  var months = new Array('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December');
  var date = new Date();
//  date = months[date.getUTCMonth()] + '_' + date.getUTCDate();
  var datestring = date.getUTCFullYear() + '_' + months[date.getUTCMonth()] + '_' + date.getUTCDate();

  var pagename = strip_namespace(target);

  window.open('/w/index.php?title=Wikipedia:Copyright_problems/' + datestring + '&amp;action=edit&amp;fakeaction=copyviolist&amp;faketarget=' + pagename,
              'status,toolbar,location,menubar,directories,resizeable,scrollbars');
}

function autocopyvio()
{
  if (document.title.indexOf('Editing ') == 0)
    {
      var action = '';
      var target = '';
      if (location.search)
        {
          var l = location.search.substring(1).split('&amp;');
          for (var i = 0; i &lt; l.length; ++i)
            {
              var eq = l[i].indexOf('=');
              var name = l[i].substring(0, eq);
              if (name == 'fakeaction')
                action = l[i].substring(eq + 1);
              else if (name == 'faketarget')
                target = unescape(l[i].substring(eq + 1)).replace(/_/g, ' ');
                
            }
        }

      if (action == 'copyviolist')
        {
//          var index = document.editform.wpTextbox1.value.lastIndexOf(&quot;\n==Footer==&quot;);
/*            if (index == -1) 
          {
            window.alert(&quot;Couldn't find footer\n\n&quot;);
          } 
          else
          { */
//            var firsthalf = document.editform.wpTextbox1.value.substr(0,index);
//            var secondhalf = document.editform.wpTextbox1.value.substr(index);
            document.editform.wpTextbox1.value += '*[[' + target + ']] &lt;span class=&quot;plainlinks&quot;&gt;([http://en.wikipedia.org/{{localurl:' + target + '|action=history}} history] &amp;middot; [http://en.wikipedia.org/{{localurl:' + target + '|diff=0}} last edit])&lt;/span&gt;' + ' from [' + '] ~' + '~~' + '~';
            document.editform.wpSummary.value = 'Copyvio ' + '[[' + target + ']]';
          }
//        }
      else
        add_link2('javascript:copyvio()', 'copyvio');
    }
}

if (window.addEventListener)
  window.addEventListener('load', autocopyvio, false);
else if (window.attachEvent)
  window.attachEvent('onload', autocopyvio);

/* &lt;/nowiki&gt; */
</pre><div class="printfooter">
Retrieved from "<a href="http://en.wikipedia.org../../../a/p/p/User%7EAppleboy_monobook.js_0873.html">http://en.wikipedia.org../../../a/p/p/User%7EAppleboy_monobook.js_0873.html</a>"</div>
	    	    <!-- end content -->
	    <div class="visualClear"></div>
	  </div>
	</div>
      </div>
      <div id="column-one">
	<div id="p-cactions" class="portlet">
	  <h5>Views</h5>
	  <ul>
	    <li id="ca-nstab-user"
	       class="selected"	       ><a href="../../../a/p/p/User%7EAppleboy_monobook.js_0873.html">User page</a></li><li id="ca-talk"
	       class="new"	       ><a href="../../../a/p/p/User_talk%7EAppleboy_monobook.js_ffd4.html">Discussion</a></li><li id="ca-current"
	       	       ><a href="http://en.wikipedia.org/wiki/User:Appleboy/monobook.js">Current revision</a></li>	  </ul>
	</div>
	<div class="portlet" id="p-logo">
	  <a style="background-image: url(../../../images/wiki-en.png);"
	    href="../../../index.html"
	    title="Main Page"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
	  <h5>Navigation</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-Main-page"><a href="../../../index.html">Main page</a></li>
	     	      <li id="n-Contents"><a href="../../../c/o/n/Wikipedia%7EContents_3181.html">Contents</a></li>
	     	      <li id="n-Featured-content"><a href="../../../f/e/a/Wikipedia%7EFeatured_content_24ba.html">Featured content</a></li>
	     	      <li id="n-currentevents"><a href="../../../c/u/r/Portal%7ECurrent_events_bb60.html">Current events</a></li>
	     	    </ul>
	  </div>
	</div>
		<div class='portlet' id='p-interaction'>
	  <h5>interaction</h5>
	  <div class='pBody'>
	    <ul>
	    	      <li id="n-About-Wikipedia"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html">About Wikipedia</a></li>
	     	      <li id="n-portal"><a href="../../../c/o/m/Wikipedia%7ECommunity_Portal_6a3c.html">Community portal</a></li>
	     	      <li id="n-contact"><a href="../../../c/o/n/Wikipedia%7EContact_us_afd6.html">Contact us</a></li>
	     	      <li id="n-sitesupport"><a href="http://wikimediafoundation.org/wiki/Fundraising">Make a donation</a></li>
	     	      <li id="n-help"><a href="../../../c/o/n/Help%7EContents_22de.html">Help</a></li>
	     	    </ul>
	  </div>
	</div>
		<div id="p-search" class="portlet">
	  <h5><label for="searchInput">Search</label></h5>
	  <div id="searchBody" class="pBody">
	    <form action="javascript:goToStatic(3)" id="searchform"><div>
	      <input id="searchInput" name="search" type="text"
	        accesskey="f" value="" />
	      <input type='submit' name="go" class="searchButton" id="searchGoButton"
	        value="Go" />
	    </div></form>
	  </div>
	</div>
	      </div><!-- end of the left (by default at least) column -->
      <div class="visualClear"></div>
      <div id="footer">
    <div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../../../skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>	<div id="f-copyrightico"><a href="http://wikimediafoundation.org/"><img src="../../../images/wikimedia-button.png" border="0" alt="Wikimedia Foundation"/></a></div>	<ul id="f-list">
	  	  	  <li id="f-credits">This page was last modified 17:29, 25 November 2005 by Wikipedia user <a href="../../../a/p/p/User%7EAppleboy_7cf8.html" title="User:Appleboy">Appleboy</a>. </li>	  <li id="f-copyright">All text is available under the terms of the <a class='internal' href="../../../t/e/x/Wikipedia%7EText_of_the_GNU_Free_Documentation_License_702a.html" title="Wikipedia:Text of the GNU Free Documentation License">GNU Free Documentation License</a>. (See <b><a class='internal' href="../../../c/o/p/Wikipedia%7ECopyrights_92c4.html" title="Wikipedia:Copyrights">Copyrights</a></b> for details.) <br /> Wikipedia&reg; is a registered trademark of the <a href="http://www.wikimediafoundation.org">Wikimedia Foundation, Inc</a>., a US-registered <a class='internal' href="../../../5/0/1/501%28c%29.html#501.28c.29.283.29" title="501(c)(3)">501(c)(3)</a> <a href="http://wikimediafoundation.org/wiki/Deductibility_of_donations">tax-deductible</a> <a class='internal' href="../../../n/o/n/Non-profit_organization.html" title="Non-profit organization">nonprofit</a> <a href="../../../c/h/a/Charitable_organization.html" title="Charitable organization">charity</a>.<br /></li>	  <li id="f-about"><a href="../../../a/b/o/Wikipedia%7EAbout_8d82.html" title="Wikipedia:About">About Wikipedia</a></li>	  <li id="f-disclaimer"><a href="../../../g/e/n/Wikipedia%7EGeneral_disclaimer_3e44.html" title="Wikipedia:General disclaimer">Disclaimers</a></li>	  	</ul>
      </div>
    </div>
  </body>
</html>
